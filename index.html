<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÛŒØ³ØªÙ… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù¾Ø±Ø³Ù†Ù„ - Firebase (Real-time)</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary: #1e40af;
            --primary-dark: #1e3a8a;
            --secondary: #0891b2;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --purple: #7c3aed;
            --dark: #1f2937;
            --light: #f3f4f6;
            --white: #ffffff;
            --border: #e5e7eb;
            --text: #374151;
            --text-light: #6b7280;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Vazirmatn', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* ===== LOGIN SCREEN ===== */
        .login-overlay {
            position: fixed; inset: 0;
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #0891b2 100%);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999;
        }
        .login-box {
            background: white;
            border-radius: 24px;
            padding: 50px 40px;
            width: 420px;
            max-width: 95vw;
            box-shadow: 0 30px 80px rgba(0,0,0,0.4);
            text-align: center;
            animation: slideUp 0.5s ease-out;
        }
        .login-logo { font-size: 56px; margin-bottom: 10px; }
        .login-title { font-size: 26px; font-weight: 900; color: var(--dark); margin-bottom: 6px; }
        .login-subtitle { font-size: 14px; color: var(--text-light); margin-bottom: 30px; }
        .login-form .form-group { margin-bottom: 20px; text-align: right; }
        .login-form label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--dark); font-size: 14px; }
        .login-form select, .login-form input {
            width: 100%; padding: 14px 16px;
            border: 2px solid var(--border); border-radius: 12px;
            font-family: 'Vazirmatn', sans-serif; font-size: 15px;
            transition: border-color 0.3s;
        }
        .login-form select:focus, .login-form input:focus {
            outline: none; border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30,64,175,0.1);
        }
        .login-btn {
            width: 100%; padding: 16px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white; border: none; border-radius: 12px;
            font-family: 'Vazirmatn', sans-serif; font-size: 17px; font-weight: 700;
            cursor: pointer; transition: all 0.3s;
            box-shadow: 0 6px 20px rgba(30,64,175,0.4);
        }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(30,64,175,0.5); }
        .login-error {
            background: #fee2e2; color: #dc2626; padding: 12px 16px;
            border-radius: 10px; font-size: 14px; font-weight: 600;
            margin-bottom: 20px; display: none;
        }

        /* ===== MAIN APP ===== */
        .app-container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white; padding: 25px 40px;
            border-radius: 20px; margin-bottom: 25px;
            box-shadow: 0 10px 40px rgba(30,64,175,0.3);
            display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;
        }
        .header-left h1 { font-size: 26px; font-weight: 900; margin-bottom: 4px; }
        .header-left p { font-size: 14px; opacity: 0.85; }
        .header-right { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .manager-badge {
            background: rgba(255,255,255,0.2); padding: 10px 18px;
            border-radius: 30px; font-size: 14px; font-weight: 700;
            display: flex; align-items: center; gap: 8px;
        }
        .status-badge {
            background: rgba(255,255,255,0.15); padding: 8px 15px;
            border-radius: 20px; font-size: 13px; font-weight: 600;
            display: flex; align-items: center; gap: 7px;
        }
        #status-dot { width: 9px; height: 9px; border-radius: 50%; background: #ef4444; }
        .logout-btn {
            background: rgba(255,255,255,0.2); color: white;
            border: 2px solid rgba(255,255,255,0.4);
            padding: 8px 16px; border-radius: 10px;
            font-family: 'Vazirmatn', sans-serif; font-size: 14px; font-weight: 600;
            cursor: pointer; transition: all 0.3s;
        }
        .logout-btn:hover { background: rgba(255,255,255,0.35); }

        /* ===== NAV ===== */
        .nav-tabs {
            display: flex; gap: 12px; margin-bottom: 25px;
            background: white; padding: 12px;
            border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            flex-wrap: wrap;
        }
        .nav-tab {
            flex: 1; min-width: 160px; padding: 13px 20px;
            background: var(--light); border: none; border-radius: 10px;
            font-family: 'Vazirmatn', sans-serif; font-size: 15px; font-weight: 600;
            color: var(--text); cursor: pointer; transition: all 0.3s;
        }
        .nav-tab:hover { background: var(--primary); color: white; transform: translateY(-2px); }
        .nav-tab.active { background: var(--primary); color: white; box-shadow: 0 5px 15px rgba(30,64,175,0.3); }
        .nav-tab.shared-tab { border: 2px solid #f59e0b; }
        .nav-tab.shared-tab.active { background: linear-gradient(135deg, #d97706 0%, #b45309 100%); border-color: transparent; }
        .nav-tab.shared-tab:hover:not(.active) { background: #fef3c7; color: #d97706; }

        /* ===== SECTIONS ===== */
        .section { display: none; animation: fadeIn 0.4s ease-out; }
        .section.active { display: block; }

        /* ===== CARDS ===== */
        .card {
            background: white; border-radius: 16px; padding: 28px;
            margin-bottom: 22px; box-shadow: 0 4px 20px rgba(0,0,0,0.06);
        }
        .card-title {
            font-size: 21px; font-weight: 700; color: var(--dark);
            margin-bottom: 20px; display: flex; align-items: center; gap: 10px;
        }

        /* ===== SHARED DASHBOARD ===== */
        .shared-dashboard-header {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: 16px; padding: 20px 25px;
            margin-bottom: 25px;
            display: flex; align-items: center; gap: 15px;
        }
        .shared-dashboard-header .icon { font-size: 36px; }
        .shared-dashboard-header h3 { font-size: 20px; font-weight: 900; color: #92400e; }
        .shared-dashboard-header p { font-size: 14px; color: #78350f; margin-top: 4px; }

        .summary-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            border-radius: 14px; padding: 22px;
            text-align: center; transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-3px); }
        .stat-card.blue { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border: 2px solid #93c5fd; }
        .stat-card.green { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border: 2px solid #6ee7b7; }
        .stat-card.orange { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #fcd34d; }
        .stat-card.purple { background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%); border: 2px solid #c4b5fd; }
        .stat-number { font-size: 38px; font-weight: 900; margin-bottom: 4px; }
        .stat-card.blue .stat-number { color: #1d4ed8; }
        .stat-card.green .stat-number { color: #059669; }
        .stat-card.orange .stat-number { color: #d97706; }
        .stat-card.purple .stat-number { color: #7c3aed; }
        .stat-label { font-size: 13px; font-weight: 600; color: var(--text-light); }

        /* All employees ranking table */
        .ranking-table {
            width: 100%; border-collapse: collapse; margin-top: 15px;
            border-radius: 12px; overflow: hidden;
        }
        .ranking-table thead tr { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); }
        .ranking-table th {
            color: white; padding: 14px 16px;
            text-align: right; font-weight: 700; font-size: 14px;
        }
        .ranking-table td { padding: 13px 16px; border-bottom: 1px solid var(--border); font-size: 14px; }
        .ranking-table tbody tr:hover { background: #f0f9ff; }
        .ranking-table tbody tr:last-child td { border-bottom: none; }
        .rank-1 td { background: linear-gradient(135deg, #fef9c3 0%, #fef08a 100%) !important; }
        .rank-2 td { background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%) !important; }
        .rank-3 td { background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%) !important; }

        /* Progress bar */
        .progress-bar-wrap { background: #e5e7eb; border-radius: 20px; height: 10px; min-width: 100px; }
        .progress-bar-fill { height: 100%; border-radius: 20px; transition: width 0.6s ease; }

        /* ===== FORM ELEMENTS ===== */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 18px; margin-bottom: 22px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-group label { font-weight: 600; color: var(--dark); font-size: 14px; }
        .form-group input, .form-group select {
            padding: 12px 15px; border: 2px solid var(--border);
            border-radius: 10px; font-family: 'Vazirmatn', sans-serif;
            font-size: 15px; transition: all 0.3s; background: var(--white);
        }
        .form-group input:focus, .form-group select:focus {
            outline: none; border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30,64,175,0.1);
        }

        /* ===== EVALUATION ===== */
        .department-badge {
            display: inline-block; padding: 8px 16px;
            border-radius: 20px; font-weight: 700; font-size: 14px; margin-bottom: 18px;
        }
        .dept-sales { background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; }
        .dept-operations { background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%); color: white; }
        .dept-hr { background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); color: white; }
        .dept-finance { background: linear-gradient(135deg, #d97706 0%, #b45309 100%); color: white; }
        .dept-it { background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; }
        .dept-production { background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%); color: white; }
        .evaluation-sections { display: grid; gap: 18px; }
        .eval-section {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 12px; padding: 20px; border: 2px solid #fbbf24;
        }
        .eval-section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .eval-section-title { font-weight: 700; font-size: 17px; color: var(--dark); }
        .eval-weight {
            background: var(--warning); color: white;
            padding: 5px 14px; border-radius: 20px; font-weight: 700; font-size: 13px;
        }
        .score-slider-container { display: flex; align-items: center; gap: 14px; margin-top: 8px; }
        .score-slider {
            flex: 1; height: 8px; -webkit-appearance: none; appearance: none;
            background: #e5e7eb; border-radius: 5px; outline: none;
        }
        .score-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 24px; height: 24px;
            background: var(--primary); cursor: pointer; border-radius: 50%;
            box-shadow: 0 2px 8px rgba(30,64,175,0.4); transition: all 0.3s;
        }
        .score-slider::-webkit-slider-thumb:hover { transform: scale(1.2); }
        .score-display {
            min-width: 55px; text-align: center; font-weight: 700;
            font-size: 20px; color: var(--primary);
            background: white; padding: 7px 12px; border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .weighted-score { font-size: 13px; color: var(--text-light); margin-top: 4px; }
        .total-score-card {
            background: linear-gradient(135deg, var(--success) 0%, #047857 100%);
            color: white; padding: 28px; border-radius: 16px;
            text-align: center; margin-top: 22px;
            box-shadow: 0 10px 30px rgba(5,150,105,0.3);
        }
        .total-score-label { font-size: 17px; font-weight: 600; opacity: 0.9; margin-bottom: 8px; }
        .total-score-value { font-size: 52px; font-weight: 900; margin-bottom: 8px; }
        .total-score-max { font-size: 15px; opacity: 0.8; }

        /* ===== BUTTONS ===== */
        .btn {
            padding: 13px 28px; border: none; border-radius: 10px;
            font-family: 'Vazirmatn', sans-serif; font-size: 15px; font-weight: 700;
            cursor: pointer; transition: all 0.3s;
            display: inline-flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #047857; transform: translateY(-2px); }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-secondary:hover { background: #0e7490; transform: translateY(-2px); }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-purple { background: var(--purple); color: white; }
        .btn-sm { padding: 8px 15px; font-size: 13px; }
        .btn-group { display: flex; gap: 14px; margin-top: 22px; flex-wrap: wrap; }

        /* ===== ALERTS ===== */
        .alert {
            padding: 14px 18px; border-radius: 10px;
            margin-bottom: 18px; font-weight: 600;
            display: flex; align-items: center; gap: 10px; font-size: 14px;
        }
        .alert-success { background: #d1fae5; color: var(--success); border: 2px solid var(--success); }
        .alert-info { background: #dbeafe; color: var(--primary); border: 2px solid var(--primary); }
        .alert-warning { background: #fef3c7; color: var(--warning); border: 2px solid var(--warning); }

        /* ===== EMPLOYEE CARDS ===== */
        .employee-list { display: grid; gap: 14px; }
        .employee-card {
            background: white; border: 2px solid var(--border);
            border-radius: 12px; padding: 18px; transition: all 0.3s;
        }
        .employee-card:hover { border-color: var(--primary); box-shadow: 0 4px 15px rgba(30,64,175,0.1); }
        .employee-header { display: flex; justify-content: space-between; align-items: center; }
        .employee-info h3 { font-size: 17px; font-weight: 700; color: var(--dark); margin-bottom: 4px; }
        .employee-info p { color: var(--text-light); font-size: 13px; }
        .employee-score-value { font-size: 30px; font-weight: 900; color: var(--primary); }
        .employee-score-label { font-size: 11px; color: var(--text-light); }

        /* ===== STAR EMPLOYEES ===== */
        .star-employees-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(270px, 1fr));
            gap: 22px; margin-top: 22px;
        }
        .star-employee-card {
            background: white; border: 3px solid var(--border);
            border-radius: 16px; padding: 24px; text-align: center;
            transition: all 0.3s; position: relative; overflow: hidden;
        }
        .star-employee-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .star-employee-card.rank-1 { border-color: #fbbf24; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); }
        .star-employee-card.rank-2 { border-color: #d1d5db; background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); }
        .star-employee-card.rank-3 { border-color: #f97316; background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%); }
        .star-rank-badge {
            position: absolute; top: 14px; right: 14px;
            width: 46px; height: 46px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 22px; font-weight: 900; color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .star-rank-badge.rank-1 { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); }
        .star-rank-badge.rank-2 { background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%); }
        .star-rank-badge.rank-3 { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
        .star-employee-photo {
            width: 110px; height: 110px; border-radius: 50%;
            margin: 0 auto 14px; border: 4px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            display: flex; align-items: center; justify-content: center;
            font-size: 44px; color: var(--text-light); background: var(--light);
        }
        .star-employee-photo img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .star-employee-name { font-size: 19px; font-weight: 700; color: var(--dark); margin-bottom: 6px; }
        .star-employee-dept { font-size: 13px; color: var(--text-light); margin-bottom: 14px; }
        .star-employee-score { background: white; padding: 13px; border-radius: 12px; margin-top: 14px; }
        .star-score-value { font-size: 30px; font-weight: 900; color: var(--primary); display: block; }
        .star-score-label { font-size: 12px; color: var(--text-light); }

        /* ===== DEPARTMENTS ===== */
        .departments-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 18px; margin-top: 18px; }
        .department-card {
            background: white; border: 2px solid var(--border);
            border-radius: 12px; padding: 20px; transition: all 0.3s; cursor: pointer;
        }
        .department-card:hover { border-color: var(--primary); box-shadow: 0 4px 15px rgba(30,64,175,0.1); transform: translateY(-3px); }
        .department-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
        .department-name { font-size: 19px; font-weight: 700; color: var(--dark); }
        .criteria-count { background: var(--light); padding: 5px 11px; border-radius: 15px; font-size: 12px; font-weight: 600; }
        .criteria-list { display: grid; gap: 13px; margin-top: 18px; }
        .criteria-item {
            background: white; border: 2px solid var(--border);
            border-radius: 12px; padding: 18px;
            display: grid; grid-template-columns: 1fr 140px 90px;
            gap: 13px; align-items: center;
        }
        .criteria-item:hover { border-color: var(--primary); }
        .criteria-name-input, .criteria-weight-input {
            padding: 9px 13px; border: 2px solid var(--border);
            border-radius: 8px; font-family: 'Vazirmatn', sans-serif;
            font-size: 14px; font-weight: 600;
        }
        .criteria-weight-input { text-align: center; }

        /* ===== HISTORY TABLE ===== */
        .history-table { width: 100%; border-collapse: collapse; margin-top: 18px; }
        .history-table th {
            background: var(--primary); color: white;
            padding: 13px 15px; text-align: right; font-weight: 700; font-size: 14px;
        }
        .history-table td { padding: 13px 15px; border-bottom: 1px solid var(--border); text-align: right; font-size: 14px; }
        .history-table tr:hover td { background: var(--light); }
        .badge { display: inline-block; padding: 5px 11px; border-radius: 15px; font-size: 12px; font-weight: 600; }
        .badge-high { background: #d1fae5; color: var(--success); }
        .badge-medium { background: #fef3c7; color: var(--warning); }
        .badge-low { background: #fee2e2; color: var(--danger); }

        /* ===== MODAL ===== */
        .modal {
            display: none; position: fixed; z-index: 1000;
            inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
        }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content {
            background: white; padding: 38px; border-radius: 20px;
            max-width: 800px; width: 92%; max-height: 82vh;
            overflow-y: auto; animation: slideUp 0.4s ease-out;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 22px; }
        .modal-title { font-size: 22px; font-weight: 900; color: var(--dark); }
        .modal-close {
            background: var(--danger); color: white; border: none;
            width: 33px; height: 33px; border-radius: 50%;
            cursor: pointer; font-size: 19px;
            display: flex; align-items: center; justify-content: center; transition: all 0.3s;
        }
        .modal-close:hover { transform: rotate(90deg); background: #b91c1c; }

        /* ===== MANAGE EMPLOYEES ===== */
        .employee-mgmt-card {
            background: white; border: 2px solid var(--border);
            border-radius: 12px; padding: 20px;
            display: flex; justify-content: space-between; align-items: center; gap: 15px;
        }
        .employee-mgmt-card:hover { border-color: var(--primary); }

        /* ===== EMPTY STATE ===== */
        .empty-state { text-align: center; padding: 55px 20px; color: var(--text-light); }
        .empty-state-icon { font-size: 60px; margin-bottom: 18px; opacity: 0.5; }
        .empty-state h3 { font-size: 19px; margin-bottom: 8px; color: var(--dark); }

        /* ===== ANIMATIONS ===== */
        @keyframes slideDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .nav-tabs { flex-direction: column; }
            .form-grid { grid-template-columns: 1fr; }
            .criteria-item { grid-template-columns: 1fr; }
            .header { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>

<!-- ======================== LOGIN SCREEN ======================== -->
<div class="login-overlay" id="login-overlay">
    <div class="login-box">
        <div class="login-logo">â­</div>
        <div class="login-title">Ø³ÛŒØ³ØªÙ… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù¾Ø±Ø³Ù†Ù„</div>
        <div class="login-subtitle">Ø´Ø±Ú©Øª Ø¨Ø§Ø²Ø±Ú¯Ø§Ù†ÛŒ ÙÙˆÙ„Ø§Ø¯</div>
        
        <div class="login-error" id="login-error">âŒ Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ù…Ø¯ÛŒØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯!</div>
        
        <div class="login-form">
            <div class="form-group">
                <label>ğŸ‘¤ Ù†Ø§Ù… Ù…Ø¯ÛŒØ± Ø§Ø±Ø²ÛŒØ§Ø¨</label>
                <select id="login-manager-select">
                    <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                    <option value="Ù…Ø¯ÛŒØ± Ø¹Ø§Ù…Ù„">Ù…Ø¯ÛŒØ± Ø¹Ø§Ù…Ù„</option>
                    <option value="Ù…Ø¯ÛŒØ± ÙØ±ÙˆØ´">Ù…Ø¯ÛŒØ± ÙØ±ÙˆØ´</option>
                    <option value="Ù…Ø¯ÛŒØ± Ø¹Ù…Ù„ÛŒØ§Øª">Ù…Ø¯ÛŒØ± Ø¹Ù…Ù„ÛŒØ§Øª</option>
                    <option value="Ù…Ø¯ÛŒØ± Ù…Ù†Ø§Ø¨Ø¹ Ø§Ù†Ø³Ø§Ù†ÛŒ">Ù…Ø¯ÛŒØ± Ù…Ù†Ø§Ø¨Ø¹ Ø§Ù†Ø³Ø§Ù†ÛŒ</option>
                    <option value="Ù…Ø¯ÛŒØ± Ù…Ø§Ù„ÛŒ">Ù…Ø¯ÛŒØ± Ù…Ø§Ù„ÛŒ</option>
                </select>
            </div>
            <button class="login-btn" onclick="doLogin()">ğŸ” ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…</button>
        </div>
    </div>
</div>

<!-- ======================== MAIN APP ======================== -->
<div class="app-container" id="main-app" style="display:none;">
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <h1>â­ Ø³ÛŒØ³ØªÙ… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù¾Ø±Ø³Ù†Ù„</h1>
            <p>Ø´Ø±Ú©Øª Ø¨Ø§Ø²Ø±Ú¯Ø§Ù†ÛŒ ÙÙˆÙ„Ø§Ø¯ â€” Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Real-time Ø¨Ø§ Firebase</p>
        </div>
        <div class="header-right">
            <div class="manager-badge">
                ğŸ‘¤ <span id="current-manager-display">â€”</span>
            </div>
            <div class="status-badge">
                <div id="status-dot"></div>
                <span id="status-text">Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...</span>
            </div>
            <button class="logout-btn" onclick="doLogout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

    <!-- Navigation -->
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('evaluation', this)">ğŸ“ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¬Ø¯ÛŒØ¯</button>
        <button class="nav-tab" onclick="switchTab('my-history', this)">ğŸ“‹ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ù†</button>
        <button class="nav-tab shared-tab" onclick="switchTab('shared-dashboard', this)">ğŸŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø´ØªØ±Ú©</button>
        <button class="nav-tab shared-tab" onclick="switchTab('star-employees', this)">â­ Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù† Ù†Ù…ÙˆÙ†Ù‡</button>
        <button class="nav-tab" onclick="switchTab('manage-employees', this)">ğŸ‘¤ Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù†</button>
        <button class="nav-tab" onclick="switchTab('departments', this)">ğŸ¢ Ø¨Ø®Ø´â€ŒÙ‡Ø§</button>
    </div>

    <!-- ===== EVALUATION SECTION ===== -->
    <div id="evaluation-section" class="section active">
        <div class="card">
            <h2 class="card-title">ğŸ¯ Ø«Ø¨Øª Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¬Ø¯ÛŒØ¯</h2>
            <div class="alert alert-info">â„¹ï¸ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡ Ø¨Ù‡â€ŒÙ†Ø§Ù… Ø´Ù…Ø§ (<strong id="eval-manager-label">â€”</strong>) Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ ÙÙ‚Ø· Ø´Ù…Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¢Ù† Ø±Ø§ Ø¨Ø¨ÛŒÙ†ÛŒØ¯.</div>
            <div class="form-grid">
                <div class="form-group">
                    <label>Ø¨Ø®Ø´ (Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†) *</label>
                    <select id="employee-department" onchange="handleDepartmentChange()">
                        <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ù†Ø§Ù… Ú©Ø§Ø±Ù…Ù†Ø¯ *</label>
                    <select id="employee-name">
                        <option value="">Ø§Ø¨ØªØ¯Ø§ Ø¨Ø®Ø´ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ØªØ§Ø±ÛŒØ® Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</label>
                    <input type="date" id="evaluation-date">
                </div>
            </div>
            <div id="department-badge-container"></div>
            <div class="evaluation-sections" id="evaluation-criteria"></div>
            <div class="total-score-card" style="display:none;" id="total-score-container">
                <div class="total-score-label">Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„ Ø§ÛŒÙ† Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</div>
                <div class="total-score-value" id="total-score">0</div>
                <div class="total-score-max">Ø§Ø² <span id="max-score">1000</span></div>
            </div>
            <div class="btn-group">
                <button class="btn btn-success" onclick="saveEvaluation()">âœ… Ø°Ø®ÛŒØ±Ù‡ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</button>
                <button class="btn btn-secondary" onclick="resetForm()">ğŸ”„ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù…</button>
            </div>
        </div>
    </div>

    <!-- ===== MY HISTORY SECTION ===== -->
    <div id="my-history-section" class="section">
        <div class="card">
            <h2 class="card-title">ğŸ“‹ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡ ØªÙˆØ³Ø· Ù…Ù†</h2>
            <div class="alert alert-info" id="my-history-info">ğŸ“Œ ÙÙ‚Ø· Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø´Ù…Ø§ Ø«Ø¨Øª Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
            <div class="btn-group" style="margin-bottom: 18px; margin-top: 0;">
                <button class="btn btn-warning" onclick="exportMyEvaluations()">ğŸ“¥ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ù†</button>
            </div>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>ØªØ§Ø±ÛŒØ®</th>
                        <th>Ù†Ø§Ù… Ú©Ø§Ø±Ù…Ù†Ø¯</th>
                        <th>Ø¨Ø®Ø´</th>
                        <th>Ø§Ù…ØªÛŒØ§Ø²</th>
                        <th>Ø±ØªØ¨Ù‡</th>
                        <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                    </tr>
                </thead>
                <tbody id="my-history-tbody"></tbody>
            </table>
        </div>
    </div>

    <!-- ===== SHARED DASHBOARD ===== -->
    <div id="shared-dashboard-section" class="section">
        <div class="shared-dashboard-header">
            <div class="icon">ğŸŒ</div>
            <div>
                <h3>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø´ØªØ±Ú© â€” Ù‚Ø§Ø¨Ù„ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ù…Ø¯ÛŒØ±Ø§Ù†</h3>
                <p>Ù…Ø¬Ù…ÙˆØ¹ Ú©Ù„ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª Ùˆ Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ ØªÙ…Ø§Ù… Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù† Ø§Ø² Ù‡Ù…Ù‡ Ø¨Ø®Ø´â€ŒÙ‡Ø§ØŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù‡Ù…Ù‡ Ù…Ø¯ÛŒØ±Ø§Ù†</p>
            </div>
        </div>

        <!-- Summary Stats -->
        <div class="summary-stats-grid" id="summary-stats"></div>

        <!-- Top Performers Card -->
        <div class="card">
            <h2 class="card-title">ğŸ† Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ú©Ù„ÛŒ Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù† (Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª Ù‡Ù…Ù‡ Ù…Ø¯ÛŒØ±Ø§Ù†)</h2>
            <div class="alert alert-warning">âš ï¸ Ø§ÛŒÙ† Ø¬Ø¯ÙˆÙ„ Ù…Ø¬Ù…ÙˆØ¹ ØªÙ…Ø§Ù… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡ ØªÙˆØ³Ø· Ù‡Ù…Ù‡ Ù…Ø¯ÛŒØ±Ø§Ù† Ø±Ø§ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.</div>
            <div style="overflow-x:auto;">
                <table class="ranking-table" id="global-ranking-table">
                    <thead>
                        <tr>
                            <th style="width:60px;">Ø±ØªØ¨Ù‡</th>
                            <th>Ù†Ø§Ù… Ú©Ø§Ø±Ù…Ù†Ø¯</th>
                            <th>Ø¨Ø®Ø´</th>
                            <th>ØªØ¹Ø¯Ø§Ø¯ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</th>
                            <th>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù…ØªÛŒØ§Ø²</th>
                            <th>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† %</th>
                            <th>Ù†Ù…ÙˆØ¯Ø§Ø±</th>
                        </tr>
                    </thead>
                    <tbody id="global-ranking-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- Charts -->
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap:22px; margin-top:10px;">
            <div class="card">
                <h3 style="margin-bottom:18px; font-size:17px;">ğŸ“ˆ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø§Ù…ØªÛŒØ§Ø² Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù†</h3>
                <canvas id="sharedEmployeesChart"></canvas>
            </div>
            <div class="card">
                <h3 style="margin-bottom:18px; font-size:17px;">ğŸ¢ ØªÙˆØ²ÛŒØ¹ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ Ø¯Ø± Ø¨Ø®Ø´â€ŒÙ‡Ø§</h3>
                <canvas id="sharedDepartmentsChart"></canvas>
            </div>
        </div>
    </div>

    <!-- ===== STAR EMPLOYEES ===== -->
    <div id="star-employees-section" class="section">
        <div class="card">
            <h2 class="card-title">â­ ØªØ§Ø¨Ù„Ùˆ Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù† Ù†Ù…ÙˆÙ†Ù‡ Ù…Ø§Ù‡</h2>
            <div class="alert alert-info">â„¹ï¸ Ø§ÛŒÙ† ØªØ§Ø¨Ù„Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ Ù‡Ù…Ù‡ Ù…Ø¯ÛŒØ±Ø§Ù† Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ù‚Ø§Ø¨Ù„ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø§Ø³Øª.</div>
            <div class="form-grid" style="margin-bottom:22px;">
                <div class="form-group">
                    <label>Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø§Ù‡</label>
                    <input type="month" id="star-month-selector" onchange="updateStarEmployees()">
                </div>
                <div class="form-group">
                    <label>ØªØ¹Ø¯Ø§Ø¯ Ù†Ù…Ø§ÛŒØ´</label>
                    <select id="star-count-selector" onchange="updateStarEmployees()">
                        <option value="3">3 Ù†ÙØ± Ø¨Ø±ØªØ±</option>
                        <option value="5">5 Ù†ÙØ± Ø¨Ø±ØªØ±</option>
                        <option value="10">10 Ù†ÙØ± Ø¨Ø±ØªØ±</option>
                    </select>
                </div>
            </div>
            <div class="star-employees-grid" id="star-employees-grid"></div>
        </div>
    </div>

    <!-- ===== MANAGE EMPLOYEES ===== -->
    <div id="manage-employees-section" class="section">
        <div class="card">
            <h2 class="card-title">ğŸ‘¤ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù†</h2>
            <div class="card" style="background: linear-gradient(135deg, #f0f9ff 0%, #dbeafe 100%); margin-bottom:22px;">
                <h3 style="font-size:17px; margin-bottom:14px;">â• Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ù…Ù†Ø¯ Ø¬Ø¯ÛŒØ¯</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ *</label>
                        <input type="text" id="new-emp-name" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù„ÛŒ Ø§Ø­Ù…Ø¯ÛŒ">
                    </div>
                    <div class="form-group">
                        <label>Ø¨Ø®Ø´ *</label>
                        <select id="new-emp-department"><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option></select>
                    </div>
                    <div class="form-group">
                        <label>Ø³Ù…Øª</label>
                        <input type="text" id="new-emp-position" placeholder="Ù…Ø«Ø§Ù„: Ú©Ø§Ø±Ø´Ù†Ø§Ø³ ÙØ±ÙˆØ´">
                    </div>
                    <div class="form-group">
                        <label>Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ</label>
                        <input type="text" id="new-emp-code" placeholder="Ù…Ø«Ø§Ù„: 1001">
                    </div>
                    <div class="form-group">
                        <label>Ø¹Ú©Ø³ (URL)</label>
                        <input type="text" id="new-emp-photo" placeholder="https://...">
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="addNewEmployee()">âœ… Ø§ÙØ²ÙˆØ¯Ù†</button>
                    <button class="btn btn-secondary" onclick="clearEmployeeForm()">ğŸ”„ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
                </div>
            </div>
            <div class="card">
                <h3 style="font-size:17px; margin-bottom:14px;">ğŸ“‹ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù†</h3>
                <div class="criteria-list" id="employees-management-list"></div>
            </div>
        </div>
    </div>

    <!-- ===== DEPARTMENTS SECTION ===== -->
    <div id="departments-section" class="section">
        <div class="card">
            <h2 class="card-title">ğŸ¢ Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø®Ø´â€ŒÙ‡Ø§ Ùˆ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§</h2>
            <div class="alert alert-warning">âš ï¸ Ù‡Ø± Ø¨Ø®Ø´ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù…Ø®ØµÙˆØµ Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø§Ø±Ø¯.</div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="showAddDepartmentModal()">â• Ø¨Ø®Ø´ Ø¬Ø¯ÛŒØ¯</button>
                <button class="btn btn-secondary" onclick="resetToDefaultDepartments()">ğŸ”„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶</button>
            </div>
            <div class="departments-grid" id="departments-grid"></div>
        </div>
    </div>
</div>

<!-- ===== MODALS ===== -->
<!-- Criteria Modal -->
<div id="criteria-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">ÙˆÛŒØ±Ø§ÛŒØ´ Ø¨Ø®Ø´</h2>
            <button class="modal-close" onclick="closeCriteriaModal()">Ã—</button>
        </div>
        <div class="form-grid" style="margin-bottom:20px;">
            <div class="form-group">
                <label>Ù†Ø§Ù… Ø¨Ø®Ø´</label>
                <input type="text" id="modal-department-name-input" class="criteria-name-input">
            </div>
            <div class="form-group">
                <label>Ø¢ÛŒÚ©ÙˆÙ†</label>
                <input type="text" id="modal-department-icon-input" class="criteria-name-input" maxlength="2">
            </div>
        </div>
        <div id="modal-department-badge"></div>
        <h3 style="font-size:17px; margin-bottom:13px;">ğŸ“‹ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</h3>
        <div class="criteria-list" id="modal-criteria-list"></div>
        <div class="btn-group">
            <button class="btn btn-success" onclick="saveDepartmentCriteria()">âœ… Ø°Ø®ÛŒØ±Ù‡</button>
            <button class="btn btn-primary" onclick="addNewCriteriaToModal()">â• Ù…Ø¹ÛŒØ§Ø± Ø¬Ø¯ÛŒØ¯</button>
            <button class="btn btn-danger" onclick="deleteDepartment()">ğŸ—‘ï¸ Ø­Ø°Ù Ø¨Ø®Ø´</button>
        </div>
    </div>
</div>

<!-- Add Department Modal -->
<div id="add-department-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">â• Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ø®Ø´ Ø¬Ø¯ÛŒØ¯</h2>
            <button class="modal-close" onclick="closeAddDepartmentModal()">Ã—</button>
        </div>
        <div class="form-group" style="margin-bottom:16px;">
            <label>Ù†Ø§Ù… Ø¨Ø®Ø´</label>
            <input type="text" id="new-department-name" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ÛŒ">
        </div>
        <div class="form-group" style="margin-bottom:20px;">
            <label>Ø¢ÛŒÚ©ÙˆÙ†</label>
            <input type="text" id="new-department-icon" placeholder="Ù…Ø«Ø§Ù„: ğŸ“¢" maxlength="2">
        </div>
        <div class="btn-group">
            <button class="btn btn-success" onclick="createNewDepartment()">âœ… Ø§ÛŒØ¬Ø§Ø¯</button>
        </div>
    </div>
</div>

<!-- Edit Employee Modal -->
<div id="edit-employee-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±Ù…Ù†Ø¯</h2>
            <button class="modal-close" onclick="closeEditEmployeeModal()">Ã—</button>
        </div>
        <div class="form-grid">
            <div class="form-group">
                <label>Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ *</label>
                <input type="text" id="edit-emp-name">
            </div>
            <div class="form-group">
                <label>Ø¨Ø®Ø´ *</label>
                <select id="edit-emp-department"><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option></select>
            </div>
            <div class="form-group">
                <label>Ø³Ù…Øª</label>
                <input type="text" id="edit-emp-position">
            </div>
            <div class="form-group">
                <label>Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ</label>
                <input type="text" id="edit-emp-code">
            </div>
            <div class="form-group" style="grid-column: 1 / -1;">
                <label>Ø¹Ú©Ø³ (URL)</label>
                <input type="text" id="edit-emp-photo">
            </div>
        </div>
        <div class="btn-group">
            <button class="btn btn-success" onclick="saveEditedEmployee()">âœ… Ø°Ø®ÛŒØ±Ù‡</button>
            <button class="btn btn-secondary" onclick="closeEditEmployeeModal()">âŒ Ø§Ù†ØµØ±Ø§Ù</button>
        </div>
    </div>
</div>

<script>
// ==========================================
// ğŸ”¥ FIREBASE CONFIGURATION
// ==========================================
const firebaseConfig = {
    apiKey: "AIzaSyDeKK6THwUcR2hoh-VUiwAX7p79NL6UPQQ",
    authDomain: "employee-evaluation-adva-9231e.firebaseapp.com",
    projectId: "employee-evaluation-adva-9231e",
    storageBucket: "employee-evaluation-adva-9231e.firebasestorage.app",
    messagingSenderId: "151913486905",
    appId: "1:151913486905:web:b6c183ae02c67fd4368be8",
    measurementId: "G-ZREV957FB8"
};

let database = null;
let isFirebaseConfigured = false;

try {
    if (firebaseConfig.apiKey !== "YOUR-API-KEY-HERE") {
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        isFirebaseConfigured = true;
        console.log('âœ… Firebase initialized!');
    }
} catch(e) {
    console.error('Firebase error:', e);
}

// ==========================================
// AUTH / SESSION
// ==========================================
let currentManager = null;

function doLogin() {
    const sel = document.getElementById('login-manager-select');
    const err = document.getElementById('login-error');
    if (!sel.value) {
        err.style.display = 'flex';
        return;
    }
    err.style.display = 'none';
    currentManager = sel.value;
    sessionStorage.setItem('currentManager', currentManager);

    document.getElementById('login-overlay').style.display = 'none';
    document.getElementById('main-app').style.display = 'block';

    document.getElementById('current-manager-display').textContent = currentManager;
    document.getElementById('eval-manager-label').textContent = currentManager;

    initApp();
}

function doLogout() {
    if (confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ø² Ø³ÛŒØ³ØªÙ… Ø®Ø§Ø±Ø¬ Ø´ÙˆÛŒØ¯ØŸ')) {
        currentManager = null;
        sessionStorage.removeItem('currentManager');
        document.getElementById('main-app').style.display = 'none';
        document.getElementById('login-overlay').style.display = 'flex';
        document.getElementById('login-manager-select').value = '';
    }
}

// Check if already logged in
window.addEventListener('DOMContentLoaded', function() {
    const saved = sessionStorage.getItem('currentManager');
    if (saved) {
        document.getElementById('login-manager-select').value = saved;
        doLogin();
    }
    // Set default evaluation date
    const dateInput = document.getElementById('evaluation-date');
    if (dateInput) dateInput.valueAsDate = new Date();

    // Set star month to current
    const monthSel = document.getElementById('star-month-selector');
    if (monthSel) {
        const now = new Date();
        monthSel.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    }
});

// ==========================================
// DATA
// ==========================================
const defaultDepartments = {
    'ÙØ±ÙˆØ´': {
        name:'ÙØ±ÙˆØ´', icon:'ğŸ’°', class:'dept-sales',
        criteria:[
            {id:1,name:'ØªØ­Ù‚Ù‚ Ø§Ù‡Ø¯Ø§Ù ÙØ±ÙˆØ´',weight:20},
            {id:2,name:'Ù…Ø°Ø§Ú©Ø±Ù‡ Ùˆ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù…Ø´ØªØ±ÛŒ',weight:15},
            {id:3,name:'Ø¬Ø°Ø¨ Ù…Ø´ØªØ±ÛŒØ§Ù† Ø¬Ø¯ÛŒØ¯',weight:15},
            {id:4,name:'Ø­ÙØ¸ Ùˆ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ù…Ø´ØªØ±ÛŒ',weight:12},
            {id:5,name:'Ú¯Ø²Ø§Ø±Ø´â€ŒØ¯Ù‡ÛŒ Ùˆ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ',weight:10},
            {id:6,name:'Ø¯Ø§Ù†Ø´ Ù…Ø­ØµÙˆÙ„',weight:10},
            {id:7,name:'Ú©Ø§Ø± ØªÛŒÙ…ÛŒ',weight:8},
            {id:8,name:'Ø±Ø¹Ø§ÛŒØª Ø§ØµÙˆÙ„ Ø§Ø®Ù„Ø§Ù‚ÛŒ',weight:10}
        ]
    },
    'Ø¹Ù…Ù„ÛŒØ§Øª': {
        name:'Ø¹Ù…Ù„ÛŒØ§Øª', icon:'âš™ï¸', class:'dept-operations',
        criteria:[
            {id:1,name:'Ú©ÛŒÙÛŒØª Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡',weight:18},
            {id:2,name:'Ø±Ø¹Ø§ÛŒØª Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§',weight:15},
            {id:3,name:'Ù…Ø¯ÛŒØ±ÛŒØª Ø²Ù…Ø§Ù† Ùˆ Ø³Ø±Ø¹Øª',weight:13},
            {id:4,name:'Ø¨Ù‡Ø±Ù‡â€ŒÙˆØ±ÛŒ Ùˆ Ú©Ø§Ø±Ø§ÛŒÛŒ',weight:15},
            {id:5,name:'Ø§ÛŒÙ…Ù†ÛŒ Ùˆ Ø¨Ù‡Ø¯Ø§Ø´Øª',weight:12},
            {id:6,name:'Ø­Ù„ Ù…Ø³Ø§Ø¦Ù„ ÙÙ†ÛŒ',weight:10},
            {id:7,name:'Ù‡Ù…Ú©Ø§Ø±ÛŒ Ø¨Ø§ ØªÛŒÙ…',weight:9},
            {id:8,name:'Ù¾ÛŒØ´Ú¯ÛŒØ±ÛŒ Ø§Ø² Ø§ØªÙ„Ø§Ù Ù…Ù†Ø§Ø¨Ø¹',weight:8}
        ]
    },
    'Ù…Ù†Ø§Ø¨Ø¹ Ø§Ù†Ø³Ø§Ù†ÛŒ': {
        name:'Ù…Ù†Ø§Ø¨Ø¹ Ø§Ù†Ø³Ø§Ù†ÛŒ', icon:'ğŸ‘¥', class:'dept-hr',
        criteria:[
            {id:1,name:'Ø¬Ø°Ø¨ Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¤Ø«Ø±',weight:15},
            {id:2,name:'Ù…Ø¯ÛŒØ±ÛŒØª Ø¹Ù…Ù„Ú©Ø±Ø¯ Ú©Ø§Ø±Ú©Ù†Ø§Ù†',weight:15},
            {id:3,name:'Ø¢Ù…ÙˆØ²Ø´ Ùˆ ØªÙˆØ³Ø¹Ù‡',weight:13},
            {id:4,name:'Ø§Ø±ØªØ¨Ø§Ø·Ø§Øª Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ',weight:12},
            {id:5,name:'Ø±Ø¹Ø§ÛŒØª Ù‚ÙˆØ§Ù†ÛŒÙ† Ú©Ø§Ø±',weight:12},
            {id:6,name:'Ø­Ù„ ØªØ¹Ø§Ø±Ø¶Ø§Øª',weight:11},
            {id:7,name:'Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ù†ÛŒØ±ÙˆÛŒ Ø§Ù†Ø³Ø§Ù†ÛŒ',weight:12},
            {id:8,name:'Ø±Ø¶Ø§ÛŒØª Ú©Ø§Ø±Ú©Ù†Ø§Ù†',weight:10}
        ]
    },
    'Ù…Ø§Ù„ÛŒ': {
        name:'Ù…Ø§Ù„ÛŒ', icon:'ğŸ’µ', class:'dept-finance',
        criteria:[
            {id:1,name:'Ø¯Ù‚Øª Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ù…Ø§Ù„ÛŒ',weight:20},
            {id:2,name:'Ú¯Ø²Ø§Ø±Ø´â€ŒØ¯Ù‡ÛŒ Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹',weight:15},
            {id:3,name:'Ø±Ø¹Ø§ÛŒØª Ø§ØµÙˆÙ„ Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ',weight:15},
            {id:4,name:'Ú©Ù†ØªØ±Ù„ Ùˆ Ø¨ÙˆØ¯Ø¬Ù‡â€ŒØ¨Ù†Ø¯ÛŒ',weight:12},
            {id:5,name:'ØªØ­Ù„ÛŒÙ„ Ù…Ø§Ù„ÛŒ',weight:12},
            {id:6,name:'Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ù‚Ø¯ÛŒÙ†Ú¯ÛŒ',weight:10},
            {id:7,name:'Ø±Ø¹Ø§ÛŒØª Ù‚ÙˆØ§Ù†ÛŒÙ† Ù…Ø§Ù„ÛŒØ§ØªÛŒ',weight:8},
            {id:8,name:'Ù…Ø­Ø±Ù…Ø§Ù†Ú¯ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª',weight:8}
        ]
    },
    'IT': {
        name:'IT', icon:'ğŸ’»', class:'dept-it',
        criteria:[
            {id:1,name:'Ø­Ù„ Ù…Ø³Ø§Ø¦Ù„ ÙÙ†ÛŒ',weight:18},
            {id:2,name:'Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§',weight:15},
            {id:3,name:'Ø§Ù…Ù†ÛŒØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª',weight:16},
            {id:4,name:'ØªÙˆØ³Ø¹Ù‡ Ùˆ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ',weight:13},
            {id:5,name:'Ù…Ø³ØªÙ†Ø¯Ø³Ø§Ø²ÛŒ',weight:10},
            {id:6,name:'Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†',weight:12},
            {id:7,name:'ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ ØªÚ©Ù†ÙˆÙ„ÙˆÚ˜ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯',weight:8},
            {id:8,name:'Ú©Ø§Ø± ØªÛŒÙ…ÛŒ Ø¯Ø± Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§',weight:8}
        ]
    },
    'ØªÙˆÙ„ÛŒØ¯': {
        name:'ØªÙˆÙ„ÛŒØ¯', icon:'ğŸ­', class:'dept-production',
        criteria:[
            {id:1,name:'Ú©ÛŒÙÛŒØª Ù…Ø­ØµÙˆÙ„ ØªÙˆÙ„ÛŒØ¯ÛŒ',weight:20},
            {id:2,name:'Ø±Ø¹Ø§ÛŒØª Ø¨Ø±Ù†Ø§Ù…Ù‡ ØªÙˆÙ„ÛŒØ¯',weight:15},
            {id:3,name:'Ø¨Ù‡Ø±Ù‡â€ŒÙˆØ±ÛŒ Ø®Ø· ØªÙˆÙ„ÛŒØ¯',weight:15},
            {id:4,name:'Ú©Ø§Ù‡Ø´ Ø¶Ø§ÛŒØ¹Ø§Øª',weight:12},
            {id:5,name:'Ø§ÛŒÙ…Ù†ÛŒ Ùˆ Ø¨Ù‡Ø¯Ø§Ø´Øª Ú©Ø§Ø±',weight:12},
            {id:6,name:'Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ ØªØ¬Ù‡ÛŒØ²Ø§Øª',weight:10},
            {id:7,name:'Ù‡Ù…Ú©Ø§Ø±ÛŒ Ø¨Ø§ ØªÛŒÙ… ØªÙˆÙ„ÛŒØ¯',weight:8},
            {id:8,name:'Ø¨Ù‡Ø¨ÙˆØ¯ Ù…Ø³ØªÙ…Ø± ÙØ±Ø¢ÛŒÙ†Ø¯',weight:8}
        ]
    }
};

let departments = {};
let evaluations = [];
let employees = [];
let currentDepartment = null;
let currentEditingDepartment = null;
let currentEditingEmployee = null;

// ==========================================
// INIT
// ==========================================
function initApp() {
    // Firebase status
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');

    if (isFirebaseConfigured) {
        statusDot.style.background = '#10b981';
        statusDot.style.animation = 'pulse 2s infinite';
        statusText.textContent = 'Ù…ØªØµÙ„ Ø¨Ù‡ Firebase';
        database.ref('.info/connected').on('value', snap => {
            statusDot.style.background = snap.val() ? '#10b981' : '#ef4444';
            statusText.textContent = snap.val() ? 'Ù…ØªØµÙ„ Ø¨Ù‡ Firebase' : 'Ù‚Ø·Ø¹ Ø´Ø¯Ù‡';
        });
    } else {
        statusDot.style.background = '#f59e0b';
        statusText.textContent = 'Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ†';
    }

    loadDepartments();
    loadEvaluations();
    loadEmployees();

    // Set eval date
    document.getElementById('evaluation-date').valueAsDate = new Date();
}

// ==========================================
// DEPARTMENTS
// ==========================================
function loadDepartments() {
    if (isFirebaseConfigured) {
        database.ref('departments').on('value', snap => {
            departments = snap.exists() ? snap.val() : JSON.parse(JSON.stringify(defaultDepartments));
            if (!snap.exists()) database.ref('departments').set(departments);
            populateDepartmentDropdown();
            populateNewEmployeeDepartment();
            updateDepartmentsView();
        });
    } else {
        departments = JSON.parse(localStorage.getItem('departments')) || JSON.parse(JSON.stringify(defaultDepartments));
        populateDepartmentDropdown();
        populateNewEmployeeDepartment();
        updateDepartmentsView();
    }
}

function populateDepartmentDropdown() {
    const sel = document.getElementById('employee-department');
    sel.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>';
    Object.keys(departments).forEach(k => {
        const d = departments[k];
        sel.insertAdjacentHTML('beforeend', `<option value="${k}">${d.icon} ${d.name}</option>`);
    });
}

function populateNewEmployeeDepartment() {
    ['new-emp-department', 'edit-emp-department'].forEach(id => {
        const sel = document.getElementById(id);
        if (!sel) return;
        const cur = sel.value;
        sel.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>';
        Object.keys(departments).forEach(k => {
            const d = departments[k];
            sel.insertAdjacentHTML('beforeend', `<option value="${k}"${k===cur?' selected':''}>${d.icon} ${d.name}</option>`);
        });
    });
}

// ==========================================
// EVALUATIONS â€” FIREBASE AWARE
// ==========================================
function loadEvaluations() {
    if (isFirebaseConfigured) {
        database.ref('evaluations').on('value', snap => {
            evaluations = snap.exists() ? Object.values(snap.val()) : [];
            onEvaluationsUpdated();
        });
    } else {
        evaluations = JSON.parse(localStorage.getItem('sharedEvaluations')) || [];
        onEvaluationsUpdated();
    }
}

function onEvaluationsUpdated() {
    // Refresh whichever view is active
    const activeSection = document.querySelector('.section.active');
    if (!activeSection) return;
    const id = activeSection.id;
    if (id === 'my-history-section') renderMyHistory();
    if (id === 'shared-dashboard-section') renderSharedDashboard();
    if (id === 'star-employees-section') updateStarEmployees();
}

// ==========================================
// EMPLOYEES
// ==========================================
function loadEmployees() {
    if (isFirebaseConfigured) {
        database.ref('employees').on('value', snap => {
            employees = snap.exists() ? Object.values(snap.val()) : [];
            updateEmployeesManagementList();
        });
    } else {
        employees = JSON.parse(localStorage.getItem('employees')) || [];
        updateEmployeesManagementList();
    }
}

function populateEmployeeDropdown(filterDept = null) {
    const sel = document.getElementById('employee-name');
    let list = filterDept ? employees.filter(e => e.department === filterDept) : employees;
    list = [...list].sort((a,b) => a.name.localeCompare(b.name,'fa'));
    sel.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>';
    list.forEach(emp => {
        sel.insertAdjacentHTML('beforeend', `<option value="${emp.name}">${emp.name}</option>`);
    });
    if (list.length === 0) {
        sel.innerHTML = '<option value="">Ú©Ø§Ø±Ù…Ù†Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</option>';
    }
}

// ==========================================
// EVALUATION FORM
// ==========================================
function handleDepartmentChange() {
    const deptKey = document.getElementById('employee-department').value;
    populateEmployeeDropdown(deptKey || null);
    loadDepartmentCriteria();
}

function loadDepartmentCriteria() {
    const deptKey = document.getElementById('employee-department').value;
    if (!deptKey) {
        document.getElementById('evaluation-criteria').innerHTML = '';
        document.getElementById('department-badge-container').innerHTML = '';
        document.getElementById('total-score-container').style.display = 'none';
        currentDepartment = null;
        return;
    }
    currentDepartment = departments[deptKey];
    document.getElementById('department-badge-container').innerHTML =
        `<div class="department-badge ${currentDepartment.class}">${currentDepartment.icon} Ø¨Ø®Ø´ ${currentDepartment.name}</div>`;

    const container = document.getElementById('evaluation-criteria');
    container.innerHTML = '';
    currentDepartment.criteria.forEach(c => {
        container.insertAdjacentHTML('beforeend', `
            <div class="eval-section">
                <div class="eval-section-header">
                    <div class="eval-section-title">${c.name}</div>
                    <div class="eval-weight">Ø¶Ø±ÛŒØ¨: ${c.weight}</div>
                </div>
                <div class="score-slider-container">
                    <input type="range" min="1" max="10" value="5" class="score-slider"
                        id="slider-${c.id}" oninput="updateScore(${c.id},${c.weight})">
                    <div class="score-display" id="display-${c.id}">5</div>
                </div>
                <div class="weighted-score" id="weighted-${c.id}">Ø§Ù…ØªÛŒØ§Ø² ÙˆØ²Ù†ÛŒ: ${5*c.weight}</div>
            </div>
        `);
    });
    document.getElementById('total-score-container').style.display = 'block';
    calculateTotalScore();
}

function updateScore(id, weight) {
    const val = parseInt(document.getElementById(`slider-${id}`).value);
    document.getElementById(`display-${id}`).textContent = val;
    document.getElementById(`weighted-${id}`).textContent = `Ø§Ù…ØªÛŒØ§Ø² ÙˆØ²Ù†ÛŒ: ${val*weight}`;
    calculateTotalScore();
}

function calculateTotalScore() {
    if (!currentDepartment) return;
    let total = 0, maxScore = 0;
    currentDepartment.criteria.forEach(c => {
        const sl = document.getElementById(`slider-${c.id}`);
        if (sl) total += parseInt(sl.value) * c.weight;
        maxScore += 10 * c.weight;
    });
    document.getElementById('total-score').textContent = total;
    document.getElementById('max-score').textContent = maxScore;
}

function saveEvaluation() {
    const employeeName = document.getElementById('employee-name').value;
    const deptKey = document.getElementById('employee-department').value;
    const date = document.getElementById('evaluation-date').value;

    if (!employeeName || !deptKey || !date) {
        alert('âš ï¸ Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯!');
        return;
    }
    if (!currentDepartment) {
        alert('âš ï¸ Ø§Ø¨ØªØ¯Ø§ Ø¨Ø®Ø´ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯!');
        return;
    }

    const scores = {};
    currentDepartment.criteria.forEach(c => {
        const sl = document.getElementById(`slider-${c.id}`);
        if (sl) scores[c.id] = parseInt(sl.value);
    });

    const evaluation = {
        id: Date.now(),
        managerName: currentManager,           // â† Ø°Ø®ÛŒØ±Ù‡ Ù†Ø§Ù… Ù…Ø¯ÛŒØ± ÙØ¹Ù„ÛŒ
        employeeName,
        department: deptKey,
        departmentName: currentDepartment.name,
        date,
        scores,
        totalScore: parseInt(document.getElementById('total-score').textContent),
        maxScore: parseInt(document.getElementById('max-score').textContent),
        timestamp: new Date().toISOString(),
        criteriaSnapshot: JSON.parse(JSON.stringify(currentDepartment.criteria))
    };

    if (isFirebaseConfigured) {
        database.ref('evaluations/' + evaluation.id).set(evaluation)
            .then(() => {
                alert('âœ… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!');
                resetForm();
            })
            .catch(e => alert('âŒ Ø®Ø·Ø§: ' + e.message));
    } else {
        evaluations.push(evaluation);
        localStorage.setItem('sharedEvaluations', JSON.stringify(evaluations));
        alert('âœ… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!');
        resetForm();
        onEvaluationsUpdated();
    }
}

function resetForm() {
    document.getElementById('employee-name').value = '';
    document.getElementById('employee-department').value = '';
    document.getElementById('evaluation-date').valueAsDate = new Date();
    document.getElementById('evaluation-criteria').innerHTML = '';
    document.getElementById('department-badge-container').innerHTML = '';
    document.getElementById('total-score-container').style.display = 'none';
    currentDepartment = null;
}

// ==========================================
// MY HISTORY â€” ÙÙ‚Ø· Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† Ù…Ø¯ÛŒØ±
// ==========================================
function renderMyHistory() {
    const tbody = document.getElementById('my-history-tbody');
    const myEvals = evaluations.filter(e => e.managerName === currentManager);

    document.getElementById('my-history-info').innerHTML =
        `ğŸ“Œ ÙÙ‚Ø· Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡ ØªÙˆØ³Ø· <strong>${currentManager}</strong> â€” ØªØ¹Ø¯Ø§Ø¯: <strong>${myEvals.length}</strong> Ù…ÙˆØ±Ø¯`;

    if (myEvals.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:40px;">
            <div class="empty-state-icon">ğŸ“­</div><p>Ø´Ù…Ø§ Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯</p>
        </td></tr>`;
        return;
    }

    const sorted = [...myEvals].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
    tbody.innerHTML = sorted.map(ev => {
        const pct = (ev.totalScore / ev.maxScore * 100).toFixed(0);
        const cls = pct >= 70 ? 'badge-high' : pct >= 50 ? 'badge-medium' : 'badge-low';
        const rank = pct >= 70 ? 'Ø¹Ø§Ù„ÛŒ' : pct >= 50 ? 'Ø®ÙˆØ¨' : 'Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ù‡Ø¨ÙˆØ¯';
        return `<tr>
            <td>${new Date(ev.date).toLocaleDateString('fa-IR')}</td>
            <td><strong>${ev.employeeName}</strong></td>
            <td>${ev.departmentName}</td>
            <td><strong>${ev.totalScore}</strong> / ${ev.maxScore}</td>
            <td><span class="badge ${cls}">${rank} (${pct}%)</span></td>
            <td>
                <button class="btn btn-danger btn-sm" onclick="deleteEvaluation(${ev.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            </td>
        </tr>`;
    }).join('');
}

function deleteEvaluation(evalId) {
    // Ù…Ø¯ÛŒØ± ÙÙ‚Ø· Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ¯Ø´ Ø±Ø§ Ø­Ø°Ù Ù…ÛŒâ€ŒÚ©Ù†Ø¯
    const ev = evaluations.find(e => e.id === evalId);
    if (!ev) return;
    if (ev.managerName !== currentManager) {
        alert('â›” Ø´Ù…Ø§ Ù…Ø¬Ø§Ø² Ø¨Ù‡ Ø­Ø°Ù Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ Ø³Ø§ÛŒØ± Ù…Ø¯ÛŒØ±Ø§Ù† Ù†ÛŒØ³ØªÛŒØ¯!');
        return;
    }
    if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return;

    if (isFirebaseConfigured) {
        database.ref('evaluations/' + evalId).remove()
            .then(() => alert('âœ… Ø­Ø°Ù Ø´Ø¯!'))
            .catch(e => alert('âŒ Ø®Ø·Ø§: ' + e.message));
    } else {
        evaluations = evaluations.filter(e => e.id !== evalId);
        localStorage.setItem('sharedEvaluations', JSON.stringify(evaluations));
        alert('âœ… Ø­Ø°Ù Ø´Ø¯!');
        onEvaluationsUpdated();
    }
}

function exportMyEvaluations() {
    const myEvals = evaluations.filter(e => e.managerName === currentManager);
    if (myEvals.length === 0) { alert('âš ï¸ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!'); return; }
    const data = JSON.stringify({ manager: currentManager, evaluations: myEvals, exportDate: new Date().toISOString() }, null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `backup-${currentManager}-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a); a.click();
    document.body.removeChild(a); URL.revokeObjectURL(url);
    alert('âœ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!');
}

// ==========================================
// SHARED DASHBOARD â€” Ù‡Ù…Ù‡ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§
// ==========================================
function renderSharedDashboard() {
    // --- Summary stats ---
    const totalEvals = evaluations.length;
    const uniqueEmployees = new Set(evaluations.map(e => e.employeeName)).size;
    const uniqueManagers = new Set(evaluations.map(e => e.managerName)).size;
    const avgScore = totalEvals > 0
        ? (evaluations.reduce((s, e) => s + (e.totalScore / e.maxScore * 100), 0) / totalEvals).toFixed(1)
        : 0;

    document.getElementById('summary-stats').innerHTML = `
        <div class="stat-card blue">
            <div class="stat-number">${totalEvals}</div>
            <div class="stat-label">Ú©Ù„ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§</div>
        </div>
        <div class="stat-card green">
            <div class="stat-number">${uniqueEmployees}</div>
            <div class="stat-label">Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù† Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒØ´Ø¯Ù‡</div>
        </div>
        <div class="stat-card orange">
            <div class="stat-number">${uniqueManagers}</div>
            <div class="stat-label">Ù…Ø¯ÛŒØ±Ø§Ù† Ø§Ø±Ø²ÛŒØ§Ø¨</div>
        </div>
        <div class="stat-card purple">
            <div class="stat-number">${avgScore}%</div>
            <div class="stat-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ú©Ù„ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª</div>
        </div>
    `;

    // --- Global ranking ---
    const empMap = {};
    evaluations.forEach(ev => {
        if (!empMap[ev.employeeName]) {
            empMap[ev.employeeName] = {
                name: ev.employeeName, dept: ev.departmentName,
                totalScore: 0, totalMax: 0, count: 0
            };
        }
        empMap[ev.employeeName].totalScore += ev.totalScore;
        empMap[ev.employeeName].totalMax += ev.maxScore;
        empMap[ev.employeeName].count += 1;
    });

    const ranked = Object.values(empMap)
        .map(e => ({ ...e, avgPct: e.totalMax > 0 ? (e.totalScore / e.totalMax * 100) : 0 }))
        .sort((a, b) => b.avgPct - a.avgPct);

    const tbody = document.getElementById('global-ranking-tbody');
    if (ranked.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-light);">Ù‡Ù†ÙˆØ² Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td></tr>`;
    } else {
        tbody.innerHTML = ranked.map((emp, i) => {
            const rank = i + 1;
            const pct = emp.avgPct.toFixed(1);
            const color = emp.avgPct >= 70 ? '#059669' : emp.avgPct >= 50 ? '#d97706' : '#dc2626';
            const medal = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : rank;
            return `<tr class="${rank <= 3 ? 'rank-'+rank : ''}">
                <td style="font-size:20px;text-align:center;">${medal}</td>
                <td><strong>${emp.name}</strong></td>
                <td>${emp.dept}</td>
                <td style="text-align:center;">${emp.count}</td>
                <td style="text-align:center;font-weight:700;">${emp.totalScore.toLocaleString()}</td>
                <td style="text-align:center;font-weight:800;color:${color};">${pct}%</td>
                <td>
                    <div class="progress-bar-wrap">
                        <div class="progress-bar-fill" style="width:${pct}%;background:${color};"></div>
                    </div>
                </td>
            </tr>`;
        }).join('');
    }

    // --- Charts ---
    // Employee chart
    const ctx1 = document.getElementById('sharedEmployeesChart');
    if (window._empChart) window._empChart.destroy();
    const top10 = ranked.slice(0, 10);
    window._empChart = new Chart(ctx1, {
        type: 'bar',
        data: {
            labels: top10.map(e => e.name),
            datasets: [{
                label: 'Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø² (%)',
                data: top10.map(e => e.avgPct.toFixed(1)),
                backgroundColor: top10.map((_, i) =>
                    i===0 ? 'rgba(251,191,36,0.85)' :
                    i===1 ? 'rgba(156,163,175,0.85)' :
                    i===2 ? 'rgba(249,115,22,0.85)' : 'rgba(30,64,175,0.75)'
                ),
                borderRadius: 6
            }]
        },
        options: { responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{min:0,max:100} } }
    });

    // Department chart
    const deptMap = {};
    evaluations.forEach(ev => {
        deptMap[ev.departmentName] = (deptMap[ev.departmentName] || 0) + 1;
    });
    const ctx2 = document.getElementById('sharedDepartmentsChart');
    if (window._deptChart) window._deptChart.destroy();
    window._deptChart = new Chart(ctx2, {
        type: 'pie',
        data: {
            labels: Object.keys(deptMap),
            datasets: [{
                data: Object.values(deptMap),
                backgroundColor: ['rgba(5,150,105,0.8)','rgba(8,145,178,0.8)','rgba(124,58,237,0.8)',
                    'rgba(217,119,6,0.8)','rgba(220,38,38,0.8)','rgba(30,64,175,0.8)','rgba(236,72,153,0.8)']
            }]
        },
        options:{ responsive:true }
    });
}

// ==========================================
// STAR EMPLOYEES
// ==========================================
function updateStarEmployees() {
    const container = document.getElementById('star-employees-grid');
    const selMonth = document.getElementById('star-month-selector').value;
    const topCount = parseInt(document.getElementById('star-count-selector').value);

    if (!selMonth) {
        container.innerHTML = '<p style="text-align:center;color:var(--text-light);">Ù„Ø·ÙØ§Ù‹ Ù…Ø§Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p>';
        return;
    }
    const [year, month] = selMonth.split('-');
    const monthEvals = evaluations.filter(ev => {
        const d = new Date(ev.date);
        return d.getFullYear() == year && (d.getMonth()+1) == parseInt(month);
    });

    if (monthEvals.length === 0) {
        container.innerHTML = `<div class="empty-state" style="grid-column:1/-1;">
            <div class="empty-state-icon">ğŸ“­</div>
            <h3>Ù‡ÛŒÚ† Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ù…Ø§Ù‡ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</h3>
        </div>`;
        return;
    }

    const empMap = {};
    monthEvals.forEach(ev => {
        if (!empMap[ev.employeeName]) empMap[ev.employeeName] = { name:ev.employeeName, dept:ev.departmentName, sum:0, count:0 };
        empMap[ev.employeeName].sum += (ev.totalScore / ev.maxScore * 100);
        empMap[ev.employeeName].count += 1;
    });

    const ranked = Object.values(empMap)
        .map(e => ({ ...e, avg: e.sum / e.count }))
        .sort((a,b) => b.avg - a.avg)
        .slice(0, topCount);

    container.innerHTML = ranked.map((emp, i) => {
        const rank = i + 1;
        const empData = employees.find(e => e.name === emp.name);
        const photo = empData && empData.photo ? empData.photo : null;
        return `
            <div class="star-employee-card rank-${rank<=3?rank:''}">
                <div class="star-rank-badge rank-${rank<=3?rank:''}">${rank}</div>
                <div class="star-employee-photo">
                    ${photo ? `<img src="${photo}" alt="${emp.name}" onerror="this.parentElement.innerHTML='ğŸ‘¤'">` : 'ğŸ‘¤'}
                </div>
                <div class="star-employee-name">${emp.name}</div>
                <div class="star-employee-dept">${emp.dept}</div>
                <div class="star-employee-score">
                    <span class="star-score-value">${emp.avg.toFixed(1)}%</span>
                    <span class="star-score-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø² (${emp.count} Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ)</span>
                </div>
            </div>
        `;
    }).join('');
}

// ==========================================
// TAB SWITCHING
// ==========================================
function switchTab(tab, el) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.getElementById(`${tab}-section`).classList.add('active');
    if (el) el.classList.add('active');

    if (tab === 'my-history') renderMyHistory();
    if (tab === 'shared-dashboard') renderSharedDashboard();
    if (tab === 'star-employees') updateStarEmployees();
    if (tab === 'manage-employees') updateEmployeesManagementList();
    if (tab === 'departments') updateDepartmentsView();
}

// ==========================================
// EMPLOYEES MANAGEMENT
// ==========================================
function addNewEmployee() {
    const name = document.getElementById('new-emp-name').value.trim();
    const dept = document.getElementById('new-emp-department').value;
    const pos  = document.getElementById('new-emp-position').value.trim();
    const code = document.getElementById('new-emp-code').value.trim();
    const photo= document.getElementById('new-emp-photo').value.trim();

    if (!name || !dept) { alert('âš ï¸ Ù†Ø§Ù… Ùˆ Ø¨Ø®Ø´ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª!'); return; }
    if (employees.some(e => e.name.toLowerCase() === name.toLowerCase())) {
        alert('âš ï¸ Ú©Ø§Ø±Ù…Ù†Ø¯ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ù†Ø§Ù… Ù‚Ø¨Ù„Ø§Ù‹ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯!'); return;
    }

    const emp = {
        id: Date.now(), name, department: dept,
        departmentName: departments[dept].name,
        position: pos, code, photo, createdAt: new Date().toISOString()
    };

    if (isFirebaseConfigured) {
        database.ref('employees/' + emp.id).set(emp)
            .then(() => { alert('âœ… Ú©Ø§Ø±Ù…Ù†Ø¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯!'); clearEmployeeForm(); })
            .catch(e => alert('âŒ Ø®Ø·Ø§: ' + e.message));
    } else {
        employees.push(emp);
        localStorage.setItem('employees', JSON.stringify(employees));
        alert('âœ… Ú©Ø§Ø±Ù…Ù†Ø¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯!');
        clearEmployeeForm();
        updateEmployeesManagementList();
    }
}

function clearEmployeeForm() {
    ['new-emp-name','new-emp-position','new-emp-code','new-emp-photo'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('new-emp-department').value = '';
}

function updateEmployeesManagementList() {
    const container = document.getElementById('employees-management-list');
    if (!container) return;

    if (employees.length === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ‘¤</div>
            <h3>Ù‡Ù†ÙˆØ² Ú©Ø§Ø±Ù…Ù†Ø¯ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡</h3></div>`;
        return;
    }

    const sorted = [...employees].sort((a,b) => a.name.localeCompare(b.name,'fa'));
    container.innerHTML = sorted.map(emp => {
        const dept = departments[emp.department];
        return `
            <div class="employee-mgmt-card">
                <div>
                    <div style="font-weight:700;font-size:15px;margin-bottom:4px;">${emp.name}</div>
                    <div style="font-size:13px;color:var(--text-light);">
                        ${dept ? dept.icon+' '+dept.name : emp.departmentName}
                        ${emp.position ? ' â€¢ '+emp.position : ''}
                        ${emp.code ? ' â€¢ Ú©Ø¯: '+emp.code : ''}
                    </div>
                </div>
                <div style="display:flex;gap:8px;">
                    <button class="btn btn-primary btn-sm" onclick="editEmployee(${emp.id})">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteEmployee(${emp.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                </div>
            </div>
        `;
    }).join('');
}

function editEmployee(empId) {
    const emp = employees.find(e => e.id === empId);
    if (!emp) return;
    currentEditingEmployee = empId;
    document.getElementById('edit-emp-name').value = emp.name;
    document.getElementById('edit-emp-position').value = emp.position || '';
    document.getElementById('edit-emp-code').value = emp.code || '';
    document.getElementById('edit-emp-photo').value = emp.photo || '';
    populateNewEmployeeDepartment();
    document.getElementById('edit-emp-department').value = emp.department;
    document.getElementById('edit-employee-modal').classList.add('active');
}

function closeEditEmployeeModal() {
    document.getElementById('edit-employee-modal').classList.remove('active');
    currentEditingEmployee = null;
}

function saveEditedEmployee() {
    if (!currentEditingEmployee) return;
    const emp = employees.find(e => e.id === currentEditingEmployee);
    if (!emp) return;

    const newName = document.getElementById('edit-emp-name').value.trim();
    const newDept = document.getElementById('edit-emp-department').value;
    if (!newName || !newDept) { alert('âš ï¸ Ù†Ø§Ù… Ùˆ Ø¨Ø®Ø´ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª!'); return; }

    if (newName !== emp.name && employees.some(e => e.id !== currentEditingEmployee && e.name.toLowerCase() === newName.toLowerCase())) {
        alert('âš ï¸ Ø§ÛŒÙ† Ù†Ø§Ù… Ù‚Ø¨Ù„Ø§Ù‹ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯!'); return;
    }

    emp.name = newName;
    emp.department = newDept;
    emp.departmentName = departments[newDept].name;
    emp.position = document.getElementById('edit-emp-position').value.trim();
    emp.code     = document.getElementById('edit-emp-code').value.trim();
    emp.photo    = document.getElementById('edit-emp-photo').value.trim();

    if (isFirebaseConfigured) {
        database.ref('employees/' + currentEditingEmployee).set(emp)
            .then(() => { alert('âœ… ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯!'); closeEditEmployeeModal(); })
            .catch(e => alert('âŒ Ø®Ø·Ø§: ' + e.message));
    } else {
        localStorage.setItem('employees', JSON.stringify(employees));
        alert('âœ… ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯!');
        closeEditEmployeeModal();
        updateEmployeesManagementList();
    }
}

function deleteEmployee(empId) {
    const emp = employees.find(e => e.id === empId);
    if (!emp) return;
    if (!confirm(`Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù "${emp.name}" Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ`)) return;

    if (isFirebaseConfigured) {
        database.ref('employees/' + empId).remove()
            .then(() => alert('âœ… Ø­Ø°Ù Ø´Ø¯!'))
            .catch(e => alert('âŒ Ø®Ø·Ø§: ' + e.message));
    } else {
        employees = employees.filter(e => e.id !== empId);
        localStorage.setItem('employees', JSON.stringify(employees));
        alert('âœ… Ø­Ø°Ù Ø´Ø¯!');
        updateEmployeesManagementList();
    }
}

// ==========================================
// DEPARTMENTS VIEW
// ==========================================
function updateDepartmentsView() {
    const container = document.getElementById('departments-grid');
    if (!container) return;
    container.innerHTML = '';
    Object.keys(departments).forEach(k => {
        const d = departments[k];
        container.insertAdjacentHTML('beforeend', `
            <div class="department-card" onclick="openCriteriaModal('${k}')">
                <div class="department-header">
                    <div class="department-badge ${d.class}">${d.icon} ${d.name}</div>
                    <div class="criteria-count">${d.criteria.length} Ù…Ø¹ÛŒØ§Ø±</div>
                </div>
                <p style="color:var(--text-light);margin-top:10px;font-size:13px;">Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§</p>
            </div>
        `);
    });
}

function openCriteriaModal(deptKey) {
    currentEditingDepartment = deptKey;
    const d = departments[deptKey];
    document.getElementById('modal-department-name-input').value = d.name;
    document.getElementById('modal-department-icon-input').value = d.icon;
    document.getElementById('modal-department-badge').innerHTML =
        `<div class="department-badge ${d.class}" style="margin-bottom:18px;">${d.icon} ${d.name}</div>`;

    const list = document.getElementById('modal-criteria-list');
    list.innerHTML = '';
    d.criteria.forEach(c => {
        list.insertAdjacentHTML('beforeend', `
            <div class="criteria-item">
                <input type="text" class="criteria-name-input" value="${c.name}" id="modal-criteria-name-${c.id}">
                <input type="number" class="criteria-weight-input" value="${c.weight}" id="modal-criteria-weight-${c.id}" min="1" max="30">
                <button class="btn btn-danger btn-sm" onclick="deleteModalCriteria(${c.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            </div>
        `);
    });
    document.getElementById('criteria-modal').classList.add('active');
}

function closeCriteriaModal() {
    document.getElementById('criteria-modal').classList.remove('active');
    currentEditingDepartment = null;
}

function saveDepartmentCriteria() {
    const oldKey = currentEditingDepartment;
    const d = departments[oldKey];
    const newName = document.getElementById('modal-department-name-input').value.trim();
    const newIcon = document.getElementById('modal-department-icon-input').value.trim();
    if (!newName || !newIcon) { alert('âš ï¸ Ù†Ø§Ù… Ùˆ Ø¢ÛŒÚ©ÙˆÙ† Ø§Ù„Ø²Ø§Ù…ÛŒ!'); return; }

    const criteria = [];
    d.criteria.forEach(c => {
        const nm = document.getElementById(`modal-criteria-name-${c.id}`);
        const wt = document.getElementById(`modal-criteria-weight-${c.id}`);
        if (nm && wt) criteria.push({ id:c.id, name:nm.value, weight:parseInt(wt.value) });
    });

    if (newName !== oldKey) {
        departments[newName] = { name:newName, icon:newIcon, class:d.class, criteria };
        delete departments[oldKey];
    } else {
        departments[oldKey] = { ...d, name:newName, icon:newIcon, criteria };
    }

    const save = () => {
        if (isFirebaseConfigured) {
            database.ref('departments').set(departments)
                .then(() => { alert('âœ… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!'); closeCriteriaModal(); updateDepartmentsView(); populateDepartmentDropdown(); populateNewEmployeeDepartment(); })
                .catch(e => alert('âŒ Ø®Ø·Ø§: ' + e.message));
        } else {
            localStorage.setItem('departments', JSON.stringify(departments));
            alert('âœ… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!');
            closeCriteriaModal(); updateDepartmentsView(); populateDepartmentDropdown(); populateNewEmployeeDepartment();
        }
    };
    save();
}

function addNewCriteriaToModal() {
    const d = departments[currentEditingDepartment];
    const newId = Math.max(...d.criteria.map(c => c.id), 0) + 1;
    d.criteria.push({ id:newId, name:'Ù…Ø¹ÛŒØ§Ø± Ø¬Ø¯ÛŒØ¯', weight:10 });
    openCriteriaModal(currentEditingDepartment);
}

function deleteModalCriteria(id) {
    if (!confirm('Ø­Ø°Ù Ø§ÛŒÙ† Ù…Ø¹ÛŒØ§Ø±ØŸ')) return;
    departments[currentEditingDepartment].criteria = departments[currentEditingDepartment].criteria.filter(c => c.id !== id);
    openCriteriaModal(currentEditingDepartment);
}

function deleteDepartment() {
    const name = departments[currentEditingDepartment].name;
    if (!confirm(`Ø­Ø°Ù Ø¨Ø®Ø´ "${name}"ØŸ`)) return;
    delete departments[currentEditingDepartment];

    if (isFirebaseConfigured) {
        database.ref('departments').set(departments)
            .then(() => { alert('âœ… Ø¨Ø®Ø´ Ø­Ø°Ù Ø´Ø¯!'); closeCriteriaModal(); populateDepartmentDropdown(); populateNewEmployeeDepartment(); updateDepartmentsView(); })
            .catch(e => alert('âŒ Ø®Ø·Ø§: ' + e.message));
    } else {
        localStorage.setItem('departments', JSON.stringify(departments));
        alert('âœ… Ø¨Ø®Ø´ Ø­Ø°Ù Ø´Ø¯!');
        closeCriteriaModal(); populateDepartmentDropdown(); populateNewEmployeeDepartment(); updateDepartmentsView();
    }
}

function showAddDepartmentModal() { document.getElementById('add-department-modal').classList.add('active'); }
function closeAddDepartmentModal() {
    document.getElementById('add-department-modal').classList.remove('active');
    document.getElementById('new-department-name').value = '';
    document.getElementById('new-department-icon').value = '';
}

function createNewDepartment() {
    const name = document.getElementById('new-department-name').value.trim();
    const icon = document.getElementById('new-department-icon').value.trim();
    if (!name || !icon) { alert('âš ï¸ Ù†Ø§Ù… Ùˆ Ø¢ÛŒÚ©ÙˆÙ† Ø§Ù„Ø²Ø§Ù…ÛŒ!'); return; }
    departments[name] = { name, icon, class:'dept-sales', criteria:[
        {id:1,name:'Ú©ÛŒÙÛŒØª Ú©Ø§Ø±',weight:15},
        {id:2,name:'Ø­Ø¶ÙˆØ± Ùˆ ØºÛŒØ§Ø¨',weight:10},
        {id:3,name:'Ú©Ø§Ø± ØªÛŒÙ…ÛŒ',weight:10}
    ]};
    if (isFirebaseConfigured) {
        database.ref('departments').set(departments)
            .then(() => { alert('âœ… Ø¨Ø®Ø´ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯!'); closeAddDepartmentModal(); populateDepartmentDropdown(); populateNewEmployeeDepartment(); updateDepartmentsView(); })
            .catch(e => alert('âŒ Ø®Ø·Ø§: ' + e.message));
    } else {
        localStorage.setItem('departments', JSON.stringify(departments));
        alert('âœ… Ø¨Ø®Ø´ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯!');
        closeAddDepartmentModal(); populateDepartmentDropdown(); populateNewEmployeeDepartment(); updateDepartmentsView();
    }
}

function resetToDefaultDepartments() {
    if (!confirm('Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ØŸ ØªÙ…Ø§Ù… Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯â€ŒØ´Ø¯Ù‡ Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.')) return;
    departments = JSON.parse(JSON.stringify(defaultDepartments));
    if (isFirebaseConfigured) {
        database.ref('departments').set(departments).then(() => {
            alert('âœ… Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!');
            populateDepartmentDropdown(); populateNewEmployeeDepartment(); updateDepartmentsView();
        });
    } else {
        localStorage.setItem('departments', JSON.stringify(departments));
        alert('âœ… Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!');
        populateDepartmentDropdown(); populateNewEmployeeDepartment(); updateDepartmentsView();
    }
}

// Close modals on outside click
['criteria-modal','add-department-modal','edit-employee-modal'].forEach(id => {
    document.getElementById(id).addEventListener('click', function(e) {
        if (e.target === this) this.classList.remove('active');
    });
});
</script>
</body>
</html>
