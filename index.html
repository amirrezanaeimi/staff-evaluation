<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÛŒØ³ØªÙ… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù¾Ø±Ø³Ù†Ù„ - Firebase (Real-time)</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDK v9 (Modular) -->
    <script type="module">
        // Firebase will be initialized here after configuration
        window.firebaseReady = false;
    </script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary: #1e40af;
            --primary-dark: #1e3a8a;
            --secondary: #0891b2;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --purple: #7c3aed;
            --dark: #1f2937;
            --light: #f3f4f6;
            --white: #ffffff;
            --border: #e5e7eb;
            --text: #374151;
            --text-light: #6b7280;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 30px 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(30, 64, 175, 0.3);
            animation: slideDown 0.6s ease-out;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 900;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            background: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            animation: slideDown 0.7s ease-out;
            flex-wrap: wrap;
        }

        .nav-tab {
            flex: 1;
            min-width: 180px;
            padding: 15px 25px;
            background: var(--light);
            border: none;
            border-radius: 10px;
            font-family: 'Vazirmatn', sans-serif;
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-tab:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 5px 15px rgba(30, 64, 175, 0.3);
        }

        /* Content Sections */
        .section {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .section.active {
            display: block;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }

        .card-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Form Elements */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-family: 'Vazirmatn', sans-serif;
            font-size: 15px;
            transition: all 0.3s ease;
            background: var(--white);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        /* Department Badge */
        .department-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .dept-sales {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
        }

        .dept-operations {
            background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
            color: white;
        }

        .dept-hr {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            color: white;
        }

        .dept-finance {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            color: white;
        }

        .dept-it {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
        }

        .dept-production {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            color: white;
        }

        /* Evaluation Sections */
        .evaluation-sections {
            display: grid;
            gap: 20px;
        }

        .eval-section {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #fbbf24;
        }

        .eval-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .eval-section-title {
            font-weight: 700;
            font-size: 18px;
            color: var(--dark);
        }

        .eval-weight {
            background: var(--warning);
            color: white;
            padding: 6px 15px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 14px;
        }

        .score-slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .score-slider {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: #e5e7eb;
            border-radius: 5px;
            outline: none;
        }

        .score-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: var(--primary);
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(30, 64, 175, 0.4);
            transition: all 0.3s ease;
        }

        .score-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            background: var(--primary-dark);
        }

        .score-display {
            min-width: 60px;
            text-align: center;
            font-weight: 700;
            font-size: 20px;
            color: var(--primary);
            background: white;
            padding: 8px 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .weighted-score {
            text-align: left;
            font-size: 14px;
            color: var(--text-light);
            margin-top: 5px;
        }

        /* Total Score Display */
        .total-score-card {
            background: linear-gradient(135deg, var(--success) 0%, #047857 100%);
            color: white;
            padding: 30px;
            border-radius: 16px;
            text-align: center;
            margin-top: 25px;
            box-shadow: 0 10px 30px rgba(5, 150, 105, 0.3);
        }

        .total-score-label {
            font-size: 18px;
            font-weight: 600;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .total-score-value {
            font-size: 56px;
            font-weight: 900;
            margin-bottom: 10px;
        }

        .total-score-max {
            font-size: 16px;
            opacity: 0.8;
        }

        /* Buttons */
        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 10px;
            font-family: 'Vazirmatn', sans-serif;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #047857;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: #0e7490;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-purple {
            background: var(--purple);
            color: white;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        /* Department Management */
        .departments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .department-card {
            background: white;
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .department-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 15px rgba(30, 64, 175, 0.1);
            transform: translateY(-3px);
        }

        .department-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .department-name {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
        }

        .criteria-count {
            background: var(--light);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
        }

        /* Criteria Management */
        .criteria-list {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .criteria-item {
            background: white;
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 150px 100px;
            gap: 15px;
            align-items: center;
            transition: all 0.3s ease;
        }

        .criteria-item:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 15px rgba(30, 64, 175, 0.1);
        }

        .criteria-name-input {
            padding: 10px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: 'Vazirmatn', sans-serif;
            font-size: 15px;
            font-weight: 600;
        }

        .criteria-weight-input {
            padding: 10px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: 'Vazirmatn', sans-serif;
            font-size: 15px;
            font-weight: 600;
            text-align: center;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.4s ease-out;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 900;
            color: var(--dark);
        }

        .modal-close {
            background: var(--danger);
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            transform: rotate(90deg);
            background: #b91c1c;
        }

        /* Alert Box */
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: #d1fae5;
            color: var(--success);
            border: 2px solid var(--success);
        }

        .alert-info {
            background: #dbeafe;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .alert-warning {
            background: #fef3c7;
            color: var(--warning);
            border: 2px solid var(--warning);
        }

        /* Employee List */
        .employee-list {
            display: grid;
            gap: 15px;
        }

        .employee-card {
            background: white;
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .employee-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 15px rgba(30, 64, 175, 0.1);
        }

        .employee-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .employee-info h3 {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .employee-info p {
            color: var(--text-light);
            font-size: 14px;
        }

        .employee-score {
            text-align: center;
        }

        .employee-score-value {
            font-size: 32px;
            font-weight: 900;
            color: var(--primary);
        }

        .employee-score-label {
            font-size: 12px;
            color: var(--text-light);
        }

        /* Charts */
        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }

        /* History Table */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .history-table th {
            background: var(--primary);
            color: white;
            padding: 15px;
            text-align: right;
            font-weight: 700;
        }

        .history-table td {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            text-align: right;
        }

        .history-table tr:hover {
            background: var(--light);
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 13px;
            font-weight: 600;
        }

        .badge-high {
            background: #d1fae5;
            color: var(--success);
        }

        .badge-medium {
            background: #fef3c7;
            color: var(--warning);
        }

        .badge-low {
            background: #fee2e2;
            color: var(--danger);
        }

        /* Animations */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
            color: var(--dark);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .departments-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 24px;
            }

            .criteria-item {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <div style="position: absolute; top: 30px; left: 40px; display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600;">
                <div id="status-dot" style="width: 10px; height: 10px; border-radius: 50%; background: #ef4444;"></div>
                <span id="status-text">LocalStorage (Ø¢ÙÙ„Ø§ÛŒÙ†)</span>
            </div>
            <h1>â­ Ø³ÛŒØ³ØªÙ… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù¾Ø±Ø³Ù†Ù„ (Real-time Ø¨Ø§ Firebase)</h1>
            <p>Ø´Ø±Ú©Øª Ø¨Ø§Ø²Ø±Ú¯Ø§Ù†ÛŒ ÙÙˆÙ„Ø§Ø¯ - Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨ÛŒÙ† ØªÙ…Ø§Ù… Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§</p>
        </div>

        <!-- Firebase Setup Banner -->
        <div id="firebase-banner" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #d97706; border-radius: 16px; padding: 25px; margin-bottom: 25px;">
            <h3 style="color: #d97706; font-size: 20px; margin-bottom: 15px;">ğŸ”¥ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Real-timeØŒ Firebase Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯!</h3>
            <p style="margin-bottom: 10px;"><strong>Ù…Ø±Ø§Ø­Ù„ Ø³Ø§Ø¯Ù‡:</strong></p>
            <ol style="margin: 15px 0 15px 25px; color: #1f2937; line-height: 1.8;">
                <li>ÙØ§ÛŒÙ„ <code style="background: rgba(0,0,0,0.1); padding: 2px 8px; border-radius: 4px;">FIREBASE_SETUP_GUIDE.md</code> Ø±Ø§ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯</li>
                <li>Ù…Ø±Ø§Ø­Ù„ Ø±Ø§ Ø¯Ù†Ø¨Ø§Ù„ Ú©Ù†ÛŒØ¯ (ÙÙ‚Ø· 10 Ø¯Ù‚ÛŒÙ‚Ù‡!)</li>
                <li>Ú©Ø¯ Firebase Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± Ø®Ø· <strong>650</strong> Ø§ÛŒÙ† ÙØ§ÛŒÙ„ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯</li>
                <li>ÙØ§ÛŒÙ„ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ùˆ Refresh Ú©Ù†ÛŒØ¯</li>
            </ol>
            <p style="margin-top: 15px; color: #059669; font-weight: 700;">
                âœ… ØªØ§ Ø²Ù…Ø§Ù† ØªÙ†Ø¸ÛŒÙ… FirebaseØŒ Ø³ÛŒØ³ØªÙ… Ø¨Ø§ LocalStorage Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ (ÙÙ‚Ø· Ø±ÙˆÛŒ Ù‡Ù…ÛŒÙ† Ú©Ø§Ù…Ù¾ÛŒÙˆØªØ±)
            </p>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('evaluation')">ğŸ“ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¬Ø¯ÛŒØ¯</button>
            <button class="nav-tab" onclick="switchTab('employees')">ğŸ‘¥ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù†</button>
            <button class="nav-tab" onclick="switchTab('reports')">ğŸ“Š Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</button>
            <button class="nav-tab" onclick="switchTab('history')">ğŸ“… ØªØ§Ø±ÛŒØ®Ú†Ù‡</button>
            <button class="nav-tab" onclick="switchTab('departments')">ğŸ¢ Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø®Ø´â€ŒÙ‡Ø§</button>
        </div>

        <!-- Evaluation Section -->
        <div id="evaluation-section" class="section active">
            <div class="card">
                <h2 class="card-title">ğŸ¯ Ø«Ø¨Øª Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¬Ø¯ÛŒØ¯</h2>
                
                <div class="alert alert-info">
                    â„¹ï¸ Ø§Ø¨ØªØ¯Ø§ Ø¨Ø®Ø´ Ú©Ø§Ø±Ù…Ù†Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ØªØ§ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ù…Ø®ØµÙˆØµ Ø¢Ù† Ø¨Ø®Ø´ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯.
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>Ù†Ø§Ù… Ù…Ø¯ÛŒØ± Ø§Ø±Ø²ÛŒØ§Ø¨ *</label>
                        <select id="manager-name" required>
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                            <option value="Ù…Ø¯ÛŒØ± Ø¹Ø§Ù…Ù„">Ù…Ø¯ÛŒØ± Ø¹Ø§Ù…Ù„</option>
                            <option value="Ù…Ø¯ÛŒØ± ÙØ±ÙˆØ´">Ù…Ø¯ÛŒØ± ÙØ±ÙˆØ´</option>
                            <option value="Ù…Ø¯ÛŒØ± Ø¹Ù…Ù„ÛŒØ§Øª">Ù…Ø¯ÛŒØ± Ø¹Ù…Ù„ÛŒØ§Øª</option>
                            <option value="Ù…Ø¯ÛŒØ± Ù…Ù†Ø§Ø¨Ø¹ Ø§Ù†Ø³Ø§Ù†ÛŒ">Ù…Ø¯ÛŒØ± Ù…Ù†Ø§Ø¨Ø¹ Ø§Ù†Ø³Ø§Ù†ÛŒ</option>
                            <option value="Ù…Ø¯ÛŒØ± Ù…Ø§Ù„ÛŒ">Ù…Ø¯ÛŒØ± Ù…Ø§Ù„ÛŒ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ù†Ø§Ù… Ú©Ø§Ø±Ù…Ù†Ø¯ *</label>
                        <select id="employee-name" required onchange="handleEmployeeSelection()">
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                            <option value="__ADD_NEW__">â• Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ù…Ù†Ø¯ Ø¬Ø¯ÛŒØ¯...</option>
                        </select>
                    </div>
                    <div class="form-group" id="new-employee-input-group" style="display: none;">
                        <label>Ù†Ø§Ù… Ú©Ø§Ø±Ù…Ù†Ø¯ Ø¬Ø¯ÛŒØ¯ *</label>
                        <input type="text" id="new-employee-name" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ">
                    </div>
                    <div class="form-group">
                        <label>Ø¨Ø®Ø´ (Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†) *</label>
                        <select id="employee-department" onchange="loadDepartmentCriteria()" required>
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ØªØ§Ø±ÛŒØ® Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</label>
                        <input type="date" id="evaluation-date">
                    </div>
                </div>

                <div id="department-badge-container"></div>

                <div class="evaluation-sections" id="evaluation-criteria"></div>

                <div class="total-score-card" style="display: none;" id="total-score-container">
                    <div class="total-score-label">Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„ Ø§ÛŒÙ† Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</div>
                    <div class="total-score-value" id="total-score">0</div>
                    <div class="total-score-max">Ø§Ø² <span id="max-score">1000</span></div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-success" onclick="saveEvaluation()">âœ… Ø°Ø®ÛŒØ±Ù‡ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</button>
                    <button class="btn btn-secondary" onclick="resetForm()">ğŸ”„ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù…</button>
                </div>
            </div>
        </div>

        <!-- Employees Section -->
        <div id="employees-section" class="section">
            <div class="card">
                <h2 class="card-title">ğŸ‘¥ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù† Ùˆ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª</h2>
                <div class="employee-list" id="employee-list"></div>
            </div>
        </div>

        <!-- Reports Section -->
        <div id="reports-section" class="section">
            <div class="card">
                <h2 class="card-title">ğŸ“Š Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ Ùˆ ØªØ­Ù„ÛŒÙ„ Ø¹Ù…Ù„Ú©Ø±Ø¯</h2>
                
                <div class="charts-grid">
                    <div class="chart-container">
                        <h3 style="margin-bottom: 20px;">ğŸ“ˆ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø§Ù…ØªÛŒØ§Ø² Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù†</h3>
                        <canvas id="employeesChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 style="margin-bottom: 20px;">ğŸ¢ ØªÙˆØ²ÛŒØ¹ Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù† Ø¯Ø± Ø¨Ø®Ø´â€ŒÙ‡Ø§</h3>
                        <canvas id="departmentsChart"></canvas>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="window.print()">ğŸ–¨ï¸ Ú†Ø§Ù¾ Ú¯Ø²Ø§Ø±Ø´</button>
                </div>
            </div>
        </div>

        <!-- History Section -->
        <div id="history-section" class="section">
            <div class="card">
                <h2 class="card-title">ğŸ“… ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªÙ…Ø§Ù… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§</h2>
                
                <div class="btn-group" style="margin-bottom: 20px;">
                    <button class="btn btn-danger" onclick="clearAllEvaluations()">ğŸ—‘ï¸ Ø­Ø°Ù ØªÙ…Ø§Ù… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§</button>
                    <button class="btn btn-warning" onclick="exportEvaluations()">ğŸ“¥ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ</button>
                </div>
                
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>ØªØ§Ø±ÛŒØ®</th>
                            <th>Ù†Ø§Ù… Ú©Ø§Ø±Ù…Ù†Ø¯</th>
                            <th>Ø¨Ø®Ø´</th>
                            <th>Ù…Ø¯ÛŒØ± Ø§Ø±Ø²ÛŒØ§Ø¨</th>
                            <th>Ø§Ù…ØªÛŒØ§Ø²</th>
                            <th>Ø±ØªØ¨Ù‡</th>
                            <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="history-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- Departments Section -->
        <div id="departments-section" class="section">
            <div class="card">
                <h2 class="card-title">ğŸ¢ Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø®Ø´â€ŒÙ‡Ø§ Ùˆ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</h2>
                
                <div class="alert alert-warning">
                    âš ï¸ Ù‡Ø± Ø¨Ø®Ø´ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù…Ø®ØµÙˆØµ Ø¨Ù‡ Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø§Ø±Ø¯. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ Ø±Ø§ ÙˆÛŒØ±Ø§ÛŒØ´ ÛŒØ§ Ø¨Ø®Ø´ Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="showAddDepartmentModal()">â• Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ø®Ø´ Ø¬Ø¯ÛŒØ¯</button>
                    <button class="btn btn-secondary" onclick="resetToDefaultDepartments()">ğŸ”„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶</button>
                </div>

                <div class="departments-grid" id="departments-grid"></div>
            </div>
        </div>
    </div>

    <!-- Modal for Department Criteria Management -->
    <div id="criteria-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ÙˆÛŒØ±Ø§ÛŒØ´ Ø¨Ø®Ø´</h2>
                <button class="modal-close" onclick="closeCriteriaModal()">Ã—</button>
            </div>
            
            <div style="margin-bottom: 25px;">
                <h3 style="font-size: 18px; margin-bottom: 15px; color: var(--dark);">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ø®Ø´</h3>
                <div class="form-grid" style="margin-bottom: 0;">
                    <div class="form-group">
                        <label>Ù†Ø§Ù… Ø¨Ø®Ø´</label>
                        <input type="text" id="modal-department-name-input" class="criteria-name-input" placeholder="Ù†Ø§Ù… Ø¨Ø®Ø´">
                    </div>
                    <div class="form-group">
                        <label>Ø¢ÛŒÚ©ÙˆÙ† (emoji)</label>
                        <input type="text" id="modal-department-icon-input" class="criteria-name-input" placeholder="Ù…Ø«Ø§Ù„: ğŸ’°" maxlength="2">
                    </div>
                </div>
            </div>

            <div id="modal-department-badge"></div>
            
            <h3 style="font-size: 18px; margin-bottom: 15px; color: var(--dark);">ğŸ“‹ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</h3>
            <div class="criteria-list" id="modal-criteria-list"></div>
            
            <div class="btn-group">
                <button class="btn btn-success" onclick="saveDepartmentCriteria()">âœ… Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
                <button class="btn btn-primary" onclick="addNewCriteriaToModal()">â• Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø¹ÛŒØ§Ø± Ø¬Ø¯ÛŒØ¯</button>
                <button class="btn btn-danger" onclick="deleteDepartment()">ğŸ—‘ï¸ Ø­Ø°Ù Ø¨Ø®Ø´</button>
            </div>
        </div>
    </div>

    <!-- Modal for Add Department -->
    <div id="add-department-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">â• Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ø®Ø´ Ø¬Ø¯ÛŒØ¯</h2>
                <button class="modal-close" onclick="closeAddDepartmentModal()">Ã—</button>
            </div>
            <div class="form-group">
                <label>Ù†Ø§Ù… Ø¨Ø®Ø´</label>
                <input type="text" id="new-department-name" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ÛŒ">
            </div>
            <div class="form-group">
                <label>Ø¢ÛŒÚ©ÙˆÙ† (emoji)</label>
                <input type="text" id="new-department-icon" placeholder="Ù…Ø«Ø§Ù„: ğŸ“¢" maxlength="2">
            </div>
            <div class="btn-group">
                <button class="btn btn-success" onclick="createNewDepartment()">âœ… Ø§ÛŒØ¬Ø§Ø¯ Ø¨Ø®Ø´</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // ğŸ”¥ FIREBASE CONFIGURATION
        // ==========================================
        // Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯ Ø¨Ø§ Ú©Ø¯ Firebase Ø®ÙˆØ¯ØªØ§Ù†:
        
        const firebaseConfig = {
            apiKey: "AIzaSyDeKK6THwUcR2hoh-VUiwAX7p79NL6UPQQ",
            authDomain: "employee-evaluation-adva-9231e.firebaseapp.com",
            projectId: "employee-evaluation-adva-9231e",
            storageBucket: "employee-evaluation-adva-9231e.firebasestorage.app",
            messagingSenderId: "151913486905",
            appId: "1:151913486905:web:b6c183ae02c67fd4368be8",
            measurementId: "G-ZREV957FB8"
        };

        // Initialize Firebase
        let database = null;
        let isFirebaseConfigured = false;

        try {
            if (firebaseConfig.apiKey !== "YOUR-API-KEY-HERE") {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                isFirebaseConfigured = true;
                
                // Hide banner
                document.getElementById('firebase-banner').style.display = 'none';
                
                // Update status
                const statusDot = document.getElementById('status-dot');
                const statusText = document.getElementById('status-text');
                
                statusDot.style.background = '#10b981';
                statusDot.style.animation = 'pulse 2s infinite';
                statusText.textContent = 'Ù…ØªØµÙ„ Ø¨Ù‡ Firebase';
                
                // Connection monitoring
                database.ref('.info/connected').on('value', (snap) => {
                    if (snap.val() === true) {
                        statusDot.style.background = '#10b981';
                        statusText.textContent = 'Ù…ØªØµÙ„ Ø¨Ù‡ Firebase';
                    } else {
                        statusDot.style.background = '#ef4444';
                        statusText.textContent = 'Ù‚Ø·Ø¹ Ø´Ø¯Ù‡';
                    }
                });
                
                console.log('âœ… Firebase initialized successfully!');
            } else {
                console.warn('âš ï¸ Firebase not configured - using LocalStorage');
            }
        } catch (error) {
            console.error('âŒ Firebase initialization error:', error);
            isFirebaseConfigured = false;
        }

        // ==========================================
        // DATA MANAGEMENT WITH FIREBASE
        // ==========================================

        // Load departments from Firebase or localStorage
        function loadDepartments() {
            if (isFirebaseConfigured) {
                database.ref('departments').once('value').then((snapshot) => {
                    if (snapshot.exists()) {
                        departments = snapshot.val();
                    } else {
                        departments = JSON.parse(JSON.stringify(defaultDepartments));
                        database.ref('departments').set(departments);
                    }
                    populateDepartmentDropdown();
                    updateDepartmentsView();
                });

                // Listen for real-time changes
                database.ref('departments').on('value', (snapshot) => {
                    if (snapshot.exists()) {
                        departments = snapshot.val();
                        populateDepartmentDropdown();
                        updateDepartmentsView();
                    }
                });
            } else {
                // Fallback to localStorage
                departments = JSON.parse(localStorage.getItem('departments')) || JSON.parse(JSON.stringify(defaultDepartments));
                populateDepartmentDropdown();
                updateDepartmentsView();
            }
        }

        // Load evaluations from Firebase or localStorage
        function loadEvaluations() {
            if (isFirebaseConfigured) {
                database.ref('evaluations').once('value').then((snapshot) => {
                    if (snapshot.exists()) {
                        evaluations = Object.values(snapshot.val());
                    } else {
                        evaluations = [];
                    }
                    populateEmployeeDropdown();
                    updateAllViews();
                });

                // Listen for real-time changes
                database.ref('evaluations').on('value', (snapshot) => {
                    if (snapshot.exists()) {
                        evaluations = Object.values(snapshot.val());
                    } else {
                        evaluations = [];
                    }
                    populateEmployeeDropdown();
                    updateAllViews();
                });
            } else {
                // Fallback to localStorage
                evaluations = JSON.parse(localStorage.getItem('sharedEvaluations')) || [];
                populateEmployeeDropdown();
                updateAllViews();
            }
        }

        // Override save functions to use Firebase
        const originalSaveEvaluation = saveEvaluation;
        saveEvaluation = function() {
            const managerName = document.getElementById('manager-name').value;
            const employeeName = document.getElementById('employee-name').value;
            const deptKey = document.getElementById('employee-department').value;
            const date = document.getElementById('evaluation-date').value;

            if (!managerName || !employeeName || !deptKey || !date) {
                alert('âš ï¸ Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯!');
                return;
            }

            const scores = {};
            currentDepartment.criteria.forEach(criteria => {
                const slider = document.getElementById(`slider-${criteria.id}`);
                if (slider) {
                    scores[criteria.id] = parseInt(slider.value);
                }
            });

            const evaluation = {
                id: Date.now(),
                managerName,
                employeeName,
                department: deptKey,
                departmentName: currentDepartment.name,
                date,
                scores,
                totalScore: parseInt(document.getElementById('total-score').textContent),
                maxScore: parseInt(document.getElementById('max-score').textContent),
                timestamp: new Date().toISOString(),
                criteriaSnapshot: JSON.parse(JSON.stringify(currentDepartment.criteria))
            };

            if (isFirebaseConfigured) {
                database.ref('evaluations/' + evaluation.id).set(evaluation)
                    .then(() => {
                        alert('âœ… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ Ùˆ Ø¨Ù‡ ØµÙˆØ±Øª Real-time Ø±ÙˆÛŒ Ù‡Ù…Ù‡ Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯!');
                        resetForm();
                    })
                    .catch((error) => {
                        alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡: ' + error.message);
                    });
            } else {
                evaluations.push(evaluation);
                localStorage.setItem('sharedEvaluations', JSON.stringify(evaluations));
                alert('âœ… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ (Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ† - LocalStorage)');
                resetForm();
                updateAllViews();
            }
        };

        // Override save departments
        const originalSaveDepartmentCriteria = saveDepartmentCriteria;
        saveDepartmentCriteria = function() {
            const oldKey = currentEditingDepartment;
            const dept = departments[oldKey];
            
            const newName = document.getElementById('modal-department-name-input').value.trim();
            const newIcon = document.getElementById('modal-department-icon-input').value.trim();
            
            if (!newName || !newIcon) {
                alert('âš ï¸ Ù†Ø§Ù… Ùˆ Ø¢ÛŒÚ©ÙˆÙ† Ø¨Ø®Ø´ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯!');
                return;
            }
            
            const updatedCriteria = [];
            dept.criteria.forEach(criteria => {
                const nameInput = document.getElementById(`modal-criteria-name-${criteria.id}`);
                const weightInput = document.getElementById(`modal-criteria-weight-${criteria.id}`);
                
                if (nameInput && weightInput) {
                    updatedCriteria.push({
                        id: criteria.id,
                        name: nameInput.value,
                        weight: parseInt(weightInput.value)
                    });
                }
            });
            
            const newKey = newName;
            
            if (newKey !== oldKey) {
                departments[newKey] = {
                    name: newName,
                    icon: newIcon,
                    class: dept.class,
                    criteria: updatedCriteria
                };
                delete departments[oldKey];
            } else {
                departments[oldKey].name = newName;
                departments[oldKey].icon = newIcon;
                departments[oldKey].criteria = updatedCriteria;
            }
            
            if (isFirebaseConfigured) {
                database.ref('departments').set(departments)
                    .then(() => {
                        alert('âœ… ØªØºÛŒÛŒØ±Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ Ùˆ Ø±ÙˆÛŒ Ù‡Ù…Ù‡ Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§ Ø§Ø¹Ù…Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯!');
                        closeCriteriaModal();
                        populateDepartmentDropdown();
                        updateDepartmentsView();
                    })
                    .catch((error) => {
                        alert('âŒ Ø®Ø·Ø§: ' + error.message);
                    });
            } else {
                localStorage.setItem('departments', JSON.stringify(departments));
                alert('âœ… ØªØºÛŒÛŒØ±Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ (Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ†)');
                closeCriteriaModal();
                populateDepartmentDropdown();
                updateDepartmentsView();
            }
        };

        // Override delete evaluation
        const originalDeleteEvaluation = deleteEvaluation;
        deleteEvaluation = function(evalId) {
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                if (isFirebaseConfigured) {
                    database.ref('evaluations/' + evalId).remove()
                        .then(() => {
                            alert('âœ… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø­Ø°Ù Ø´Ø¯!');
                        })
                        .catch((error) => {
                            alert('âŒ Ø®Ø·Ø§: ' + error.message);
                        });
                } else {
                    evaluations = evaluations.filter(e => e.id !== evalId);
                    localStorage.setItem('sharedEvaluations', JSON.stringify(evaluations));
                    alert('âœ… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø­Ø°Ù Ø´Ø¯!');
                    updateAllViews();
                }
            }
        };

        // Override clear all evaluations
        const originalClearAllEvaluations = clearAllEvaluations;
        clearAllEvaluations = function() {
            if (evaluations.length === 0) {
                alert('âš ï¸ Ù‡ÛŒÚ† Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!');
                return;
            }
            
            if (confirm(`âš ï¸ Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù ØªÙ…Ø§Ù… ${evaluations.length} Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ`)) {
                if (confirm('Ø¢ÛŒØ§ ÙˆØ§Ù‚Ø¹Ø§Ù‹ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª!')) {
                    if (isFirebaseConfigured) {
                        database.ref('evaluations').remove()
                            .then(() => {
                                alert('âœ… ØªÙ…Ø§Ù… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ Ø­Ø°Ù Ø´Ø¯Ù†Ø¯!');
                            })
                            .catch((error) => {
                                alert('âŒ Ø®Ø·Ø§: ' + error.message);
                            });
                    } else {
                        evaluations = [];
                        localStorage.setItem('sharedEvaluations', JSON.stringify(evaluations));
                        alert('âœ… ØªÙ…Ø§Ù… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ Ø­Ø°Ù Ø´Ø¯Ù†Ø¯!');
                        updateAllViews();
                    }
                }
            }
        };

        // ==========================================
        // DEFAULT DEPARTMENTS
        // ==========================================
        
        const defaultDepartments = {
            'ÙØ±ÙˆØ´': {
                name: 'ÙØ±ÙˆØ´',
                icon: 'ğŸ’°',
                class: 'dept-sales',
                criteria: [
                    { id: 1, name: 'ØªØ­Ù‚Ù‚ Ø§Ù‡Ø¯Ø§Ù ÙØ±ÙˆØ´', weight: 20 },
                    { id: 2, name: 'Ù…Ø°Ø§Ú©Ø±Ù‡ Ùˆ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù…Ø´ØªØ±ÛŒ', weight: 15 },
                    { id: 3, name: 'Ø¬Ø°Ø¨ Ù…Ø´ØªØ±ÛŒØ§Ù† Ø¬Ø¯ÛŒØ¯', weight: 15 },
                    { id: 4, name: 'Ø­ÙØ¸ Ùˆ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ù…Ø´ØªØ±ÛŒ', weight: 12 },
                    { id: 5, name: 'Ú¯Ø²Ø§Ø±Ø´â€ŒØ¯Ù‡ÛŒ Ùˆ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ', weight: 10 },
                    { id: 6, name: 'Ø¯Ø§Ù†Ø´ Ù…Ø­ØµÙˆÙ„', weight: 10 },
                    { id: 7, name: 'Ú©Ø§Ø± ØªÛŒÙ…ÛŒ', weight: 8 },
                    { id: 8, name: 'Ø±Ø¹Ø§ÛŒØª Ø§ØµÙˆÙ„ Ø§Ø®Ù„Ø§Ù‚ÛŒ', weight: 10 }
                ]
            },
            'Ø¹Ù…Ù„ÛŒØ§Øª': {
                name: 'Ø¹Ù…Ù„ÛŒØ§Øª',
                icon: 'âš™ï¸',
                class: 'dept-operations',
                criteria: [
                    { id: 1, name: 'Ú©ÛŒÙÛŒØª Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡', weight: 18 },
                    { id: 2, name: 'Ø±Ø¹Ø§ÛŒØª Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§', weight: 15 },
                    { id: 3, name: 'Ù…Ø¯ÛŒØ±ÛŒØª Ø²Ù…Ø§Ù† Ùˆ Ø³Ø±Ø¹Øª', weight: 13 },
                    { id: 4, name: 'Ø¨Ù‡Ø±Ù‡â€ŒÙˆØ±ÛŒ Ùˆ Ú©Ø§Ø±Ø§ÛŒÛŒ', weight: 15 },
                    { id: 5, name: 'Ø§ÛŒÙ…Ù†ÛŒ Ùˆ Ø¨Ù‡Ø¯Ø§Ø´Øª', weight: 12 },
                    { id: 6, name: 'Ø­Ù„ Ù…Ø³Ø§Ø¦Ù„ ÙÙ†ÛŒ', weight: 10 },
                    { id: 7, name: 'Ù‡Ù…Ú©Ø§Ø±ÛŒ Ø¨Ø§ ØªÛŒÙ…', weight: 9 },
                    { id: 8, name: 'Ù¾ÛŒØ´Ú¯ÛŒØ±ÛŒ Ø§Ø² Ø§ØªÙ„Ø§Ù Ù…Ù†Ø§Ø¨Ø¹', weight: 8 }
                ]
            },
            'Ù…Ù†Ø§Ø¨Ø¹ Ø§Ù†Ø³Ø§Ù†ÛŒ': {
                name: 'Ù…Ù†Ø§Ø¨Ø¹ Ø§Ù†Ø³Ø§Ù†ÛŒ',
                icon: 'ğŸ‘¥',
                class: 'dept-hr',
                criteria: [
                    { id: 1, name: 'Ø¬Ø°Ø¨ Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¤Ø«Ø±', weight: 15 },
                    { id: 2, name: 'Ù…Ø¯ÛŒØ±ÛŒØª Ø¹Ù…Ù„Ú©Ø±Ø¯ Ú©Ø§Ø±Ú©Ù†Ø§Ù†', weight: 15 },
                    { id: 3, name: 'Ø¢Ù…ÙˆØ²Ø´ Ùˆ ØªÙˆØ³Ø¹Ù‡', weight: 13 },
                    { id: 4, name: 'Ø§Ø±ØªØ¨Ø§Ø·Ø§Øª Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ', weight: 12 },
                    { id: 5, name: 'Ø±Ø¹Ø§ÛŒØª Ù‚ÙˆØ§Ù†ÛŒÙ† Ú©Ø§Ø±', weight: 12 },
                    { id: 6, name: 'Ø­Ù„ ØªØ¹Ø§Ø±Ø¶Ø§Øª', weight: 11 },
                    { id: 7, name: 'Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ù†ÛŒØ±ÙˆÛŒ Ø§Ù†Ø³Ø§Ù†ÛŒ', weight: 12 },
                    { id: 8, name: 'Ø±Ø¶Ø§ÛŒØª Ú©Ø§Ø±Ú©Ù†Ø§Ù†', weight: 10 }
                ]
            },
            'Ù…Ø§Ù„ÛŒ': {
                name: 'Ù…Ø§Ù„ÛŒ',
                icon: 'ğŸ’µ',
                class: 'dept-finance',
                criteria: [
                    { id: 1, name: 'Ø¯Ù‚Øª Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ù…Ø§Ù„ÛŒ', weight: 20 },
                    { id: 2, name: 'Ú¯Ø²Ø§Ø±Ø´â€ŒØ¯Ù‡ÛŒ Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹', weight: 15 },
                    { id: 3, name: 'Ø±Ø¹Ø§ÛŒØª Ø§ØµÙˆÙ„ Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ', weight: 15 },
                    { id: 4, name: 'Ú©Ù†ØªØ±Ù„ Ùˆ Ø¨ÙˆØ¯Ø¬Ù‡â€ŒØ¨Ù†Ø¯ÛŒ', weight: 12 },
                    { id: 5, name: 'ØªØ­Ù„ÛŒÙ„ Ù…Ø§Ù„ÛŒ', weight: 12 },
                    { id: 6, name: 'Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ù‚Ø¯ÛŒÙ†Ú¯ÛŒ', weight: 10 },
                    { id: 7, name: 'Ø±Ø¹Ø§ÛŒØª Ù‚ÙˆØ§Ù†ÛŒÙ† Ù…Ø§Ù„ÛŒØ§ØªÛŒ', weight: 8 },
                    { id: 8, name: 'Ù…Ø­Ø±Ù…Ø§Ù†Ú¯ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª', weight: 8 }
                ]
            },
            'IT': {
                name: 'IT',
                icon: 'ğŸ’»',
                class: 'dept-it',
                criteria: [
                    { id: 1, name: 'Ø­Ù„ Ù…Ø³Ø§Ø¦Ù„ ÙÙ†ÛŒ', weight: 18 },
                    { id: 2, name: 'Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§', weight: 15 },
                    { id: 3, name: 'Ø§Ù…Ù†ÛŒØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª', weight: 16 },
                    { id: 4, name: 'ØªÙˆØ³Ø¹Ù‡ Ùˆ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ', weight: 13 },
                    { id: 5, name: 'Ù…Ø³ØªÙ†Ø¯Ø³Ø§Ø²ÛŒ', weight: 10 },
                    { id: 6, name: 'Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†', weight: 12 },
                    { id: 7, name: 'ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ ØªÚ©Ù†ÙˆÙ„ÙˆÚ˜ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯', weight: 8 },
                    { id: 8, name: 'Ú©Ø§Ø± ØªÛŒÙ…ÛŒ Ø¯Ø± Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§', weight: 8 }
                ]
            },
            'ØªÙˆÙ„ÛŒØ¯': {
                name: 'ØªÙˆÙ„ÛŒØ¯',
                icon: 'ğŸ­',
                class: 'dept-production',
                criteria: [
                    { id: 1, name: 'Ú©ÛŒÙÛŒØª Ù…Ø­ØµÙˆÙ„ ØªÙˆÙ„ÛŒØ¯ÛŒ', weight: 20 },
                    { id: 2, name: 'Ø±Ø¹Ø§ÛŒØª Ø¨Ø±Ù†Ø§Ù…Ù‡ ØªÙˆÙ„ÛŒØ¯', weight: 15 },
                    { id: 3, name: 'Ø¨Ù‡Ø±Ù‡â€ŒÙˆØ±ÛŒ Ø®Ø· ØªÙˆÙ„ÛŒØ¯', weight: 15 },
                    { id: 4, name: 'Ú©Ø§Ù‡Ø´ Ø¶Ø§ÛŒØ¹Ø§Øª', weight: 12 },
                    { id: 5, name: 'Ø§ÛŒÙ…Ù†ÛŒ Ùˆ Ø¨Ù‡Ø¯Ø§Ø´Øª Ú©Ø§Ø±', weight: 12 },
                    { id: 6, name: 'Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ ØªØ¬Ù‡ÛŒØ²Ø§Øª', weight: 10 },
                    { id: 7, name: 'Ù‡Ù…Ú©Ø§Ø±ÛŒ Ø¨Ø§ ØªÛŒÙ… ØªÙˆÙ„ÛŒØ¯', weight: 8 },
                    { id: 8, name: 'Ø¨Ù‡Ø¨ÙˆØ¯ Ù…Ø³ØªÙ…Ø± ÙØ±Ø¢ÛŒÙ†Ø¯', weight: 8 }
                ]
            }
        };

        // Load or initialize departments
        let departments = JSON.parse(localStorage.getItem('departments')) || JSON.parse(JSON.stringify(defaultDepartments));
        
        // Load evaluations
        let evaluations = JSON.parse(localStorage.getItem('sharedEvaluations')) || [];

        // Current department being evaluated
        let currentDepartment = null;
        let currentEditingDepartment = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDepartments(); // Load from Firebase or localStorage
            loadEvaluations(); // Load from Firebase or localStorage
            populateEmployeeDropdown(); // Populate employee list
            document.getElementById('evaluation-date').valueAsDate = new Date();
        });

        // Populate employee dropdown from existing evaluations
        function populateEmployeeDropdown() {
            const select = document.getElementById('employee-name');
            
            // Keep the default options
            const defaultOptions = `
                <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                <option value="__ADD_NEW__">â• Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ù…Ù†Ø¯ Ø¬Ø¯ÛŒØ¯...</option>
            `;
            
            // Get unique employee names from evaluations
            const employeeNames = new Set();
            evaluations.forEach(eval => {
                if (eval.employeeName) {
                    employeeNames.add(eval.employeeName);
                }
            });
            
            // Sort alphabetically
            const sortedNames = Array.from(employeeNames).sort();
            
            // Build options HTML
            let optionsHTML = defaultOptions;
            sortedNames.forEach(name => {
                optionsHTML += `<option value="${name}">${name}</option>`;
            });
            
            select.innerHTML = optionsHTML;
        }

        // Handle employee selection
        function handleEmployeeSelection() {
            const select = document.getElementById('employee-name');
            const newEmployeeGroup = document.getElementById('new-employee-input-group');
            const newEmployeeInput = document.getElementById('new-employee-name');
            
            if (select.value === '__ADD_NEW__') {
                // Show new employee input
                newEmployeeGroup.style.display = 'block';
                newEmployeeInput.required = true;
                newEmployeeInput.focus();
            } else {
                // Hide new employee input
                newEmployeeGroup.style.display = 'none';
                newEmployeeInput.required = false;
                newEmployeeInput.value = '';
            }
        }

        // Populate department dropdown
        function populateDepartmentDropdown() {
            const select = document.getElementById('employee-department');
            select.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>';
            
            Object.keys(departments).forEach(deptKey => {
                const dept = departments[deptKey];
                const option = document.createElement('option');
                option.value = deptKey;
                option.textContent = `${dept.icon} ${dept.name}`;
                select.appendChild(option);
            });
        }

        // Load department criteria when department is selected
        function loadDepartmentCriteria() {
            const deptKey = document.getElementById('employee-department').value;
            
            if (!deptKey) {
                document.getElementById('evaluation-criteria').innerHTML = '';
                document.getElementById('department-badge-container').innerHTML = '';
                document.getElementById('total-score-container').style.display = 'none';
                return;
            }

            currentDepartment = departments[deptKey];
            
            // Show department badge
            const badgeContainer = document.getElementById('department-badge-container');
            badgeContainer.innerHTML = `
                <div class="department-badge ${currentDepartment.class}">
                    ${currentDepartment.icon} Ø¨Ø®Ø´ ${currentDepartment.name}
                </div>
            `;

            // Load criteria
            const container = document.getElementById('evaluation-criteria');
            container.innerHTML = '';

            currentDepartment.criteria.forEach(criteria => {
                const section = document.createElement('div');
                section.className = 'eval-section';
                section.innerHTML = `
                    <div class="eval-section-header">
                        <div class="eval-section-title">${criteria.name}</div>
                        <div class="eval-weight">Ø¶Ø±ÛŒØ¨: ${criteria.weight}</div>
                    </div>
                    <div class="score-slider-container">
                        <input type="range" min="1" max="10" value="5" class="score-slider" 
                               id="slider-${criteria.id}" 
                               onchange="updateScore(${criteria.id}, ${criteria.weight})">
                        <div class="score-display" id="display-${criteria.id}">5</div>
                    </div>
                    <div class="weighted-score" id="weighted-${criteria.id}">
                        Ø§Ù…ØªÛŒØ§Ø² ÙˆØ²Ù†ÛŒ: ${5 * criteria.weight}
                    </div>
                `;
                container.appendChild(section);
            });

            document.getElementById('total-score-container').style.display = 'block';
            calculateTotalScore();
        }

        // Update individual score
        function updateScore(criteriaId, weight) {
            const slider = document.getElementById(`slider-${criteriaId}`);
            const display = document.getElementById(`display-${criteriaId}`);
            const weighted = document.getElementById(`weighted-${criteriaId}`);
            
            const value = parseInt(slider.value);
            display.textContent = value;
            weighted.textContent = `Ø§Ù…ØªÛŒØ§Ø² ÙˆØ²Ù†ÛŒ: ${value * weight}`;
            
            calculateTotalScore();
        }

        // Calculate total score
        function calculateTotalScore() {
            if (!currentDepartment) return;

            let total = 0;
            let maxScore = 0;
            
            currentDepartment.criteria.forEach(criteria => {
                const slider = document.getElementById(`slider-${criteria.id}`);
                if (slider) {
                    total += parseInt(slider.value) * criteria.weight;
                }
                maxScore += 10 * criteria.weight;
            });
            
            document.getElementById('total-score').textContent = total;
            document.getElementById('max-score').textContent = maxScore;
        }

        // Save evaluation
        function saveEvaluation() {
            const managerName = document.getElementById('manager-name').value;
            let employeeName = document.getElementById('employee-name').value;
            const deptKey = document.getElementById('employee-department').value;
            const date = document.getElementById('evaluation-date').value;

            // Check if adding new employee
            if (employeeName === '__ADD_NEW__') {
                const newEmployeeName = document.getElementById('new-employee-name').value.trim();
                if (!newEmployeeName) {
                    alert('âš ï¸ Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ú©Ø§Ø±Ù…Ù†Ø¯ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯!');
                    document.getElementById('new-employee-name').focus();
                    return;
                }
                employeeName = newEmployeeName;
            }

            if (!managerName || !employeeName || !deptKey || !date) {
                alert('âš ï¸ Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯!');
                return;
            }

            const scores = {};
            currentDepartment.criteria.forEach(criteria => {
                const slider = document.getElementById(`slider-${criteria.id}`);
                if (slider) {
                    scores[criteria.id] = parseInt(slider.value);
                }
            });

            const evaluation = {
                id: Date.now(),
                managerName,
                employeeName,
                department: deptKey,
                departmentName: currentDepartment.name,
                date,
                scores,
                totalScore: parseInt(document.getElementById('total-score').textContent),
                maxScore: parseInt(document.getElementById('max-score').textContent),
                timestamp: new Date().toISOString(),
                criteriaSnapshot: JSON.parse(JSON.stringify(currentDepartment.criteria))
            };

            evaluations.push(evaluation);
            localStorage.setItem('sharedEvaluations', JSON.stringify(evaluations));
            
            alert('âœ… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!');
            resetForm();
            populateEmployeeDropdown(); // Refresh employee list
            updateAllViews();
        }

        // Reset form
        function resetForm() {
            document.getElementById('manager-name').value = '';
            document.getElementById('employee-name').value = '';
            document.getElementById('employee-department').value = '';
            document.getElementById('evaluation-date').valueAsDate = new Date();
            document.getElementById('evaluation-criteria').innerHTML = '';
            document.getElementById('department-badge-container').innerHTML = '';
            document.getElementById('total-score-container').style.display = 'none';
            document.getElementById('new-employee-input-group').style.display = 'none';
            document.getElementById('new-employee-name').value = '';
            currentDepartment = null;
        }

        // Switch tabs
        function switchTab(tab) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(`${tab}-section`).classList.add('active');
            event.target.classList.add('active');
            
            if (tab === 'employees') updateEmployeesList();
            if (tab === 'reports') updateReports();
            if (tab === 'history') updateHistory();
            if (tab === 'departments') updateDepartmentsView();
        }

        // Update employees list
        function updateEmployeesList() {
            const container = document.getElementById('employee-list');
            
            const employeeData = {};
            evaluations.forEach(eval => {
                if (!employeeData[eval.employeeName]) {
                    employeeData[eval.employeeName] = {
                        name: eval.employeeName,
                        department: eval.departmentName,
                        totalScore: 0,
                        evaluationCount: 0,
                        evaluationIds: []
                    };
                }
                employeeData[eval.employeeName].totalScore += eval.totalScore;
                employeeData[eval.employeeName].evaluationCount += 1;
                employeeData[eval.employeeName].evaluationIds.push(eval.id);
            });

            if (Object.keys(employeeData).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“­</div>
                        <h3>Ù‡Ù†ÙˆØ² Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</h3>
                    </div>
                `;
                return;
            }

            const employees = Object.values(employeeData).sort((a, b) => b.totalScore - a.totalScore);
            
            container.innerHTML = employees.map(emp => `
                <div class="employee-card">
                    <div class="employee-header">
                        <div class="employee-info">
                            <h3>${emp.name}</h3>
                            <p>Ø¨Ø®Ø´ ${emp.department} â€¢ ${emp.evaluationCount} Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</p>
                        </div>
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <div class="employee-score">
                                <div class="employee-score-value">${emp.totalScore}</div>
                                <div class="employee-score-label">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª</div>
                            </div>
                            <button class="btn btn-danger btn-sm" onclick='deleteEmployeeEvaluations("${emp.name}")' style="padding: 8px 16px;">
                                ğŸ—‘ï¸ Ø­Ø°Ù
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Delete all evaluations for an employee
        function deleteEmployeeEvaluations(employeeName) {
            const employeeEvals = evaluations.filter(e => e.employeeName === employeeName);
            
            if (confirm(`Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù ØªÙ…Ø§Ù… ${employeeEvals.length} Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¨Ø±Ø§ÛŒ "${employeeName}" Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ`)) {
                evaluations = evaluations.filter(e => e.employeeName !== employeeName);
                localStorage.setItem('sharedEvaluations', JSON.stringify(evaluations));
                alert('âœ… ØªÙ…Ø§Ù… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ù…Ù†Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯Ù†Ø¯!');
                updateAllViews();
            }
        }

        // Update reports
        function updateReports() {
            // Employee comparison chart
            const employeeScores = {};
            evaluations.forEach(eval => {
                if (!employeeScores[eval.employeeName]) {
                    employeeScores[eval.employeeName] = 0;
                }
                employeeScores[eval.employeeName] += eval.totalScore;
            });

            const ctx1 = document.getElementById('employeesChart');
            if (window.employeeChart) window.employeeChart.destroy();
            window.employeeChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: Object.keys(employeeScores),
                    datasets: [{
                        label: 'Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª',
                        data: Object.values(employeeScores),
                        backgroundColor: 'rgba(30, 64, 175, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } }
                }
            });

            // Department distribution chart
            const deptCounts = {};
            evaluations.forEach(eval => {
                deptCounts[eval.departmentName] = (deptCounts[eval.departmentName] || 0) + 1;
            });

            const ctx2 = document.getElementById('departmentsChart');
            if (window.departmentsChart) window.departmentsChart.destroy();
            window.departmentsChart = new Chart(ctx2, {
                type: 'pie',
                data: {
                    labels: Object.keys(deptCounts),
                    datasets: [{
                        data: Object.values(deptCounts),
                        backgroundColor: [
                            'rgba(5, 150, 105, 0.8)',
                            'rgba(8, 145, 178, 0.8)',
                            'rgba(124, 58, 237, 0.8)',
                            'rgba(217, 119, 6, 0.8)',
                            'rgba(220, 38, 38, 0.8)',
                            'rgba(30, 64, 175, 0.8)'
                        ]
                    }]
                },
                options: { responsive: true }
            });
        }

        // Update history
        function updateHistory() {
            const tbody = document.getElementById('history-tbody');
            
            if (evaluations.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            <div class="empty-state-icon">ğŸ“­</div>
                            <p>Ù‡Ù†ÙˆØ² Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>
                        </td>
                    </tr>
                `;
                return;
            }

            const sorted = [...evaluations].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            tbody.innerHTML = sorted.map(eval => {
                const percentage = (eval.totalScore / eval.maxScore * 100).toFixed(0);
                const badge = percentage >= 70 ? 'badge-high' : percentage >= 50 ? 'badge-medium' : 'badge-low';
                const rank = percentage >= 70 ? 'Ø¹Ø§Ù„ÛŒ' : percentage >= 50 ? 'Ø®ÙˆØ¨' : 'Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ù‡Ø¨ÙˆØ¯';
                
                return `
                    <tr>
                        <td>${new Date(eval.date).toLocaleDateString('fa-IR')}</td>
                        <td><strong>${eval.employeeName}</strong></td>
                        <td>${eval.departmentName}</td>
                        <td>${eval.managerName}</td>
                        <td><strong>${eval.totalScore}</strong> / ${eval.maxScore}</td>
                        <td><span class="badge ${badge}">${rank} (${percentage}%)</span></td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteEvaluation(${eval.id})" style="padding: 6px 12px;">
                                ğŸ—‘ï¸ Ø­Ø°Ù
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Delete evaluation
        function deleteEvaluation(evalId) {
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                evaluations = evaluations.filter(e => e.id !== evalId);
                localStorage.setItem('sharedEvaluations', JSON.stringify(evaluations));
                alert('âœ… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯!');
                updateAllViews();
            }
        }

        // Clear all evaluations
        function clearAllEvaluations() {
            if (evaluations.length === 0) {
                alert('âš ï¸ Ù‡ÛŒÚ† Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!');
                return;
            }
            
            const confirmMsg = `âš ï¸ Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù ØªÙ…Ø§Ù… ${evaluations.length} Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ\n\nØ§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª!\n\nğŸ’¡ ØªÙˆØµÛŒÙ‡: Ù‚Ø¨Ù„ Ø§Ø² Ø­Ø°ÙØŒ ÛŒÚ© Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¨Ú¯ÛŒØ±ÛŒØ¯.`;
            
            if (confirm(confirmMsg)) {
                if (confirm('Ø¢ÛŒØ§ ÙˆØ§Ù‚Ø¹Ø§Ù‹ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª!')) {
                    evaluations = [];
                    localStorage.setItem('sharedEvaluations', JSON.stringify(evaluations));
                    alert('âœ… ØªÙ…Ø§Ù… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯Ù†Ø¯!');
                    updateAllViews();
                }
            }
        }

        // Export evaluations as JSON
        function exportEvaluations() {
            if (evaluations.length === 0) {
                alert('âš ï¸ Ù‡ÛŒÚ† Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!');
                return;
            }
            
            const dataStr = JSON.stringify({
                evaluations: evaluations,
                departments: departments,
                exportDate: new Date().toISOString(),
                version: '1.0'
            }, null, 2);
            
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `backup-evaluations-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('âœ… ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯!');
        }

        // Update departments view
        function updateDepartmentsView() {
            const container = document.getElementById('departments-grid');
            container.innerHTML = '';

            Object.keys(departments).forEach(deptKey => {
                const dept = departments[deptKey];
                const card = document.createElement('div');
                card.className = 'department-card';
                card.onclick = () => openCriteriaModal(deptKey);
                
                card.innerHTML = `
                    <div class="department-header">
                        <div class="department-badge ${dept.class}">
                            ${dept.icon} ${dept.name}
                        </div>
                        <div class="criteria-count">${dept.criteria.length} Ù…Ø¹ÛŒØ§Ø±</div>
                    </div>
                    <p style="color: var(--text-light); margin-top: 10px;">
                        Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§
                    </p>
                `;
                
                container.appendChild(card);
            });
        }

        // Open criteria modal
        function openCriteriaModal(deptKey) {
            currentEditingDepartment = deptKey;
            const dept = departments[deptKey];
            
            // Load department name and icon for editing
            document.getElementById('modal-department-name-input').value = dept.name;
            document.getElementById('modal-department-icon-input').value = dept.icon;
            
            // Show current department badge
            document.getElementById('modal-department-badge').innerHTML = `
                <div class="department-badge ${dept.class}" style="margin-bottom: 20px;">
                    ${dept.icon} ${dept.name}
                </div>
            `;
            
            const container = document.getElementById('modal-criteria-list');
            container.innerHTML = '';
            
            dept.criteria.forEach(criteria => {
                const item = document.createElement('div');
                item.className = 'criteria-item';
                item.innerHTML = `
                    <input type="text" class="criteria-name-input" 
                           value="${criteria.name}" 
                           id="modal-criteria-name-${criteria.id}">
                    <input type="number" class="criteria-weight-input" 
                           value="${criteria.weight}" 
                           id="modal-criteria-weight-${criteria.id}"
                           min="1" max="30">
                    <button class="btn btn-danger btn-sm" onclick="deleteModalCriteria(${criteria.id})">
                        ğŸ—‘ï¸ Ø­Ø°Ù
                    </button>
                `;
                container.appendChild(item);
            });
            
            document.getElementById('criteria-modal').classList.add('active');
        }

        // Close criteria modal
        function closeCriteriaModal() {
            document.getElementById('criteria-modal').classList.remove('active');
            currentEditingDepartment = null;
        }

        // Save department criteria
        function saveDepartmentCriteria() {
            const oldKey = currentEditingDepartment;
            const dept = departments[oldKey];
            
            // Get new name and icon
            const newName = document.getElementById('modal-department-name-input').value.trim();
            const newIcon = document.getElementById('modal-department-icon-input').value.trim();
            
            if (!newName || !newIcon) {
                alert('âš ï¸ Ù†Ø§Ù… Ùˆ Ø¢ÛŒÚ©ÙˆÙ† Ø¨Ø®Ø´ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯!');
                return;
            }
            
            // Update criteria
            const updatedCriteria = [];
            dept.criteria.forEach(criteria => {
                const nameInput = document.getElementById(`modal-criteria-name-${criteria.id}`);
                const weightInput = document.getElementById(`modal-criteria-weight-${criteria.id}`);
                
                if (nameInput && weightInput) {
                    updatedCriteria.push({
                        id: criteria.id,
                        name: nameInput.value,
                        weight: parseInt(weightInput.value)
                    });
                }
            });
            
            // If name changed, create new key
            const newKey = newName;
            
            if (newKey !== oldKey) {
                // Create new department with new name
                departments[newKey] = {
                    name: newName,
                    icon: newIcon,
                    class: dept.class,
                    criteria: updatedCriteria
                };
                
                // Delete old department
                delete departments[oldKey];
                
                // Update evaluations with old department key to new key
                evaluations = evaluations.map(eval => {
                    if (eval.department === oldKey) {
                        eval.department = newKey;
                        eval.departmentName = newName;
                    }
                    return eval;
                });
                localStorage.setItem('sharedEvaluations', JSON.stringify(evaluations));
            } else {
                // Just update existing department
                departments[oldKey].name = newName;
                departments[oldKey].icon = newIcon;
                departments[oldKey].criteria = updatedCriteria;
                
                // Update department name in all evaluations
                evaluations = evaluations.map(eval => {
                    if (eval.department === oldKey) {
                        eval.departmentName = newName;
                    }
                    return eval;
                });
                localStorage.setItem('sharedEvaluations', JSON.stringify(evaluations));
            }
            
            localStorage.setItem('departments', JSON.stringify(departments));
            
            alert('âœ… ØªØºÛŒÛŒØ±Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!');
            closeCriteriaModal();
            populateDepartmentDropdown();
            updateDepartmentsView();
            updateAllViews();
        }

        // Add new criteria to modal
        function addNewCriteriaToModal() {
            const dept = departments[currentEditingDepartment];
            const newId = Math.max(...dept.criteria.map(c => c.id), 0) + 1;
            
            dept.criteria.push({
                id: newId,
                name: 'Ù…Ø¹ÛŒØ§Ø± Ø¬Ø¯ÛŒØ¯',
                weight: 10
            });
            
            openCriteriaModal(currentEditingDepartment);
        }

        // Delete modal criteria
        function deleteModalCriteria(id) {
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù…Ø¹ÛŒØ§Ø± Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                const dept = departments[currentEditingDepartment];
                dept.criteria = dept.criteria.filter(c => c.id !== id);
                openCriteriaModal(currentEditingDepartment);
            }
        }

        // Delete department
        function deleteDepartment() {
            const deptName = departments[currentEditingDepartment].name;
            
            // Check if there are evaluations for this department
            const hasEvaluations = evaluations.some(e => e.department === currentEditingDepartment);
            
            let confirmMsg = `Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø¨Ø®Ø´ "${deptName}" Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ`;
            if (hasEvaluations) {
                confirmMsg += '\n\nâš ï¸ ØªÙˆØ¬Ù‡: Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª. Ø¨Ø§ Ø­Ø°Ù Ø¨Ø®Ø´ØŒ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ Ø­ÙØ¸ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ Ø§Ù…Ø§ Ø¨Ø®Ø´ Ø§Ø² Ù„ÛŒØ³Øª Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯.';
            }
            
            if (confirm(confirmMsg)) {
                delete departments[currentEditingDepartment];
                localStorage.setItem('departments', JSON.stringify(departments));
                
                alert('âœ… Ø¨Ø®Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯!');
                closeCriteriaModal();
                populateDepartmentDropdown();
                updateDepartmentsView();
            }
        }

        // Show add department modal
        function showAddDepartmentModal() {
            document.getElementById('add-department-modal').classList.add('active');
        }

        // Close add department modal
        function closeAddDepartmentModal() {
            document.getElementById('add-department-modal').classList.remove('active');
            document.getElementById('new-department-name').value = '';
            document.getElementById('new-department-icon').value = '';
        }

        // Create new department
        function createNewDepartment() {
            const name = document.getElementById('new-department-name').value;
            const icon = document.getElementById('new-department-icon').value;
            
            if (!name || !icon) {
                alert('âš ï¸ Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ùˆ Ø¢ÛŒÚ©ÙˆÙ† Ø¨Ø®Ø´ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯!');
                return;
            }
            
            const key = name;
            departments[key] = {
                name: name,
                icon: icon,
                class: 'dept-sales',
                criteria: [
                    { id: 1, name: 'Ú©ÛŒÙÛŒØª Ú©Ø§Ø±', weight: 15 },
                    { id: 2, name: 'Ø­Ø¶ÙˆØ± Ùˆ ØºÛŒØ§Ø¨', weight: 10 },
                    { id: 3, name: 'Ú©Ø§Ø± ØªÛŒÙ…ÛŒ', weight: 10 }
                ]
            };
            
            localStorage.setItem('departments', JSON.stringify(departments));
            alert('âœ… Ø¨Ø®Ø´ Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯!');
            
            closeAddDepartmentModal();
            populateDepartmentDropdown();
            updateDepartmentsView();
        }

        // Reset to default departments
        function resetToDefaultDepartments() {
            if (confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ØªÙ…Ø§Ù… Ø¨Ø®Ø´â€ŒÙ‡Ø§ Ø¨Ù‡ Ø­Ø§Ù„Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ù†Ø¯ØŸ (Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‚Ø¨Ù„ÛŒ Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯)')) {
                departments = JSON.parse(JSON.stringify(defaultDepartments));
                localStorage.setItem('departments', JSON.stringify(departments));
                alert('âœ… Ø¨Ø®Ø´â€ŒÙ‡Ø§ Ø¨Ù‡ Ø­Ø§Ù„Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ø§Ø²Ú¯Ø´ØªÙ†Ø¯!');
                populateDepartmentDropdown();
                updateDepartmentsView();
            }
        }

        // Update all views
        function updateAllViews() {
            updateEmployeesList();
            updateReports();
            updateHistory();
            updateDepartmentsView();
        }

        // Close modals on outside click
        document.getElementById('criteria-modal').addEventListener('click', function(e) {
            if (e.target === this) closeCriteriaModal();
        });
        
        document.getElementById('add-department-modal').addEventListener('click', function(e) {
            if (e.target === this) closeAddDepartmentModal();
        });
    </script>
</body>
</html>
