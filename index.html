<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù¾Ù„ØªÙØ±Ù… Ù…Ø¯ÛŒØ±ÛŒØª â€” Ø´Ø±Ú©Øª Ø¨Ø§Ø²Ø±Ú¯Ø§Ù†ÛŒ ÙÙˆÙ„Ø§Ø¯</title>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
<style>
:root {
  --primary: #1e40af; --primary-dark: #1e3a8a; --secondary: #0891b2;
  --success: #059669; --warning: #d97706; --danger: #dc2626;
  --purple: #7c3aed; --dark: #1f2937; --light: #f3f4f6;
  --white: #ffffff; --border: #e5e7eb; --text: #374151; --text-light: #6b7280;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Vazirmatn',sans-serif; background:linear-gradient(135deg,#f0f9ff,#e0f2fe); color:var(--text); line-height:1.6; min-height:100vh; padding-top:64px; }

/* MASTER NAV */
.master-nav { position:fixed; top:0; left:0; right:0; z-index:500; background:linear-gradient(135deg,var(--primary-dark),var(--primary)); box-shadow:0 4px 24px rgba(30,64,175,.35); padding:0 32px; display:flex; align-items:stretch; height:64px; gap:0; }
.master-logo { display:flex; align-items:center; gap:12px; padding-left:28px; border-left:1px solid rgba(255,255,255,.15); margin-left:8px; }
.master-logo-icon { font-size:26px; }
.master-logo-text { font-size:16px; font-weight:900; color:white; }
.master-logo-sub { font-size:11px; color:rgba(255,255,255,.65); margin-top:1px; }
.master-module-btn { display:flex; align-items:center; gap:10px; padding:0 24px; border:none; background:transparent; color:rgba(255,255,255,.75); font-family:'Vazirmatn',sans-serif; font-size:15px; font-weight:600; cursor:pointer; transition:all .25s; border-bottom:3px solid transparent; margin-bottom:-3px; }
.master-module-btn:hover { color:white; background:rgba(255,255,255,.08); }
.master-module-btn.active { color:white; border-bottom-color:white; background:rgba(255,255,255,.12); }
.master-module-btn .m-icon { font-size:20px; }
.master-module-btn .m-badge { background:rgba(255,255,255,.2); font-size:10px; padding:2px 7px; border-radius:10px; font-weight:700; }
.master-module-btn.active .m-badge { background:rgba(255,255,255,.35); }
.master-spacer { flex:1; }
.master-meta { display:flex; align-items:center; gap:10px; padding-right:12px; }
.master-user-badge { display:flex; align-items:center; gap:7px; background:rgba(255,255,255,.15); padding:6px 14px; border-radius:20px; font-size:13px; font-weight:600; color:white; }
.master-clock { background:rgba(255,255,255,.1); padding:6px 14px; border-radius:20px; font-size:12px; color:rgba(255,255,255,.8); }
.master-logout { background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.3); color:white; padding:6px 14px; border-radius:8px; font-family:'Vazirmatn',sans-serif; font-size:13px; font-weight:600; cursor:pointer; transition:all .25s; }
.master-logout:hover { background:rgba(255,255,255,.28); }
.master-nav.login-mode .master-module-btn { opacity:.4; pointer-events:none; }

/* MODULE PANELS */
.module-panel { display:none; }
.module-panel.active { display:block; }

/* LOGIN */
.login-overlay { position:fixed; inset:0; background:linear-gradient(135deg,#1e3a8a,#1e40af,#0891b2); display:flex; align-items:center; justify-content:center; z-index:9999; }
.login-box { background:white; border-radius:24px; padding:50px 40px; width:420px; max-width:95vw; box-shadow:0 30px 80px rgba(0,0,0,.4); text-align:center; animation:slideUp .5s ease-out; }
.login-logo { font-size:56px; margin-bottom:10px; }
.login-title { font-size:26px; font-weight:900; color:var(--dark); margin-bottom:6px; }
.login-subtitle { font-size:14px; color:var(--text-light); margin-bottom:30px; }
.login-form .form-group { margin-bottom:20px; text-align:right; }
.login-form label { display:block; font-weight:600; margin-bottom:8px; color:var(--dark); font-size:14px; }
.login-form select, .login-form input { width:100%; padding:14px 16px; border:2px solid var(--border); border-radius:12px; font-family:'Vazirmatn',sans-serif; font-size:15px; transition:border-color .3s; }
.login-form select:focus, .login-form input:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(30,64,175,.1); }
.login-btn { width:100%; padding:16px; background:linear-gradient(135deg,var(--primary),var(--primary-dark)); color:white; border:none; border-radius:12px; font-family:'Vazirmatn',sans-serif; font-size:17px; font-weight:700; cursor:pointer; transition:all .3s; box-shadow:0 6px 20px rgba(30,64,175,.4); }
.login-btn:hover { transform:translateY(-2px); box-shadow:0 10px 30px rgba(30,64,175,.5); }
.login-error { background:#fee2e2; color:#dc2626; padding:12px 16px; border-radius:10px; font-size:14px; font-weight:600; margin-bottom:20px; display:none; }

/* MAIN APP */
.app-container { max-width:1600px; margin:0 auto; padding:20px; }
.header { background:linear-gradient(135deg,var(--primary),var(--primary-dark)); color:white; padding:25px 40px; border-radius:20px; margin-bottom:25px; box-shadow:0 10px 40px rgba(30,64,175,.3); display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:15px; }
.header-left h1 { font-size:26px; font-weight:900; margin-bottom:4px; }
.header-left p { font-size:14px; opacity:.85; }
.header-right { display:flex; align-items:center; gap:15px; flex-wrap:wrap; }
.manager-badge { background:rgba(255,255,255,.2); padding:10px 18px; border-radius:30px; font-size:14px; font-weight:700; display:flex; align-items:center; gap:8px; }
.status-badge { background:rgba(255,255,255,.15); padding:8px 15px; border-radius:20px; font-size:13px; font-weight:600; display:flex; align-items:center; gap:7px; }
#status-dot { width:9px; height:9px; border-radius:50%; background:#ef4444; }
.logout-btn { background:rgba(255,255,255,.2); color:white; border:2px solid rgba(255,255,255,.4); padding:8px 16px; border-radius:10px; font-family:'Vazirmatn',sans-serif; font-size:14px; font-weight:600; cursor:pointer; transition:all .3s; }
.logout-btn:hover { background:rgba(255,255,255,.35); }

/* NAV TABS */
.nav-tabs { display:flex; gap:12px; margin-bottom:25px; background:white; padding:12px; border-radius:15px; box-shadow:0 4px 20px rgba(0,0,0,.05); flex-wrap:wrap; }
.nav-tab { flex:1; min-width:160px; padding:13px 20px; background:var(--light); border:none; border-radius:10px; font-family:'Vazirmatn',sans-serif; font-size:15px; font-weight:600; color:var(--text); cursor:pointer; transition:all .3s; }
.nav-tab:hover { background:var(--primary); color:white; transform:translateY(-2px); }
.nav-tab.active { background:var(--primary); color:white; box-shadow:0 5px 15px rgba(30,64,175,.3); }
.nav-tab.shared-tab { border:2px solid #f59e0b; }
.nav-tab.shared-tab.active { background:linear-gradient(135deg,#d97706,#b45309); border-color:transparent; }
.nav-tab.shared-tab:hover:not(.active) { background:#fef3c7; color:#d97706; }

/* SECTIONS */
.section { display:none; animation:fadeIn .4s ease-out; }
.section.active { display:block; }

/* CARDS */
.card { background:white; border-radius:16px; padding:28px; margin-bottom:22px; box-shadow:0 4px 20px rgba(0,0,0,.06); }
.card-title { font-size:21px; font-weight:700; color:var(--dark); margin-bottom:20px; display:flex; align-items:center; gap:10px; }

/* SHARED DASHBOARD */
.shared-dashboard-header { background:linear-gradient(135deg,#fef3c7,#fde68a); border:2px solid #f59e0b; border-radius:16px; padding:20px 25px; margin-bottom:25px; display:flex; align-items:center; gap:15px; }
.shared-dashboard-header .icon { font-size:36px; }
.shared-dashboard-header h3 { font-size:20px; font-weight:900; color:#92400e; }
.shared-dashboard-header p { font-size:14px; color:#78350f; margin-top:4px; }
.summary-stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-bottom:30px; }
.stat-card-eval { border-radius:14px; padding:22px; text-align:center; transition:transform .2s; }
.stat-card-eval:hover { transform:translateY(-3px); }
.stat-card-eval.blue { background:linear-gradient(135deg,#dbeafe,#bfdbfe); border:2px solid #93c5fd; }
.stat-card-eval.green { background:linear-gradient(135deg,#d1fae5,#a7f3d0); border:2px solid #6ee7b7; }
.stat-card-eval.orange { background:linear-gradient(135deg,#fef3c7,#fde68a); border:2px solid #fcd34d; }
.stat-card-eval.purple { background:linear-gradient(135deg,#ede9fe,#ddd6fe); border:2px solid #c4b5fd; }
.stat-number { font-size:38px; font-weight:900; margin-bottom:4px; }
.stat-card-eval.blue .stat-number { color:#1d4ed8; }
.stat-card-eval.green .stat-number { color:#059669; }
.stat-card-eval.orange .stat-number { color:#d97706; }
.stat-card-eval.purple .stat-number { color:#7c3aed; }
.stat-label { font-size:13px; font-weight:600; color:var(--text-light); }

/* RANKING TABLE */
.ranking-table { width:100%; border-collapse:collapse; margin-top:15px; border-radius:12px; overflow:hidden; }
.ranking-table thead tr { background:linear-gradient(135deg,var(--primary),var(--primary-dark)); }
.ranking-table th { color:white; padding:14px 16px; text-align:right; font-weight:700; font-size:14px; }
.ranking-table td { padding:13px 16px; border-bottom:1px solid var(--border); font-size:14px; }
.ranking-table tbody tr:hover { background:#f0f9ff; }
.ranking-table tbody tr:last-child td { border-bottom:none; }
.rank-1 td { background:linear-gradient(135deg,#fef9c3,#fef08a) !important; }
.rank-2 td { background:linear-gradient(135deg,#f3f4f6,#e5e7eb) !important; }
.rank-3 td { background:linear-gradient(135deg,#fed7aa,#fdba74) !important; }
.progress-bar-wrap { background:#e5e7eb; border-radius:20px; height:10px; min-width:100px; }
.progress-bar-fill { height:100%; border-radius:20px; transition:width .6s ease; }

/* FORMS */
.form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:18px; margin-bottom:22px; }
.form-group { display:flex; flex-direction:column; gap:8px; }
.form-group label { font-weight:600; color:var(--dark); font-size:14px; }
.form-group input, .form-group select { padding:12px 15px; border:2px solid var(--border); border-radius:10px; font-family:'Vazirmatn',sans-serif; font-size:15px; transition:all .3s; background:var(--white); }
.form-group input:focus, .form-group select:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(30,64,175,.1); }

/* EVAL */
.department-badge { display:inline-block; padding:8px 16px; border-radius:20px; font-weight:700; font-size:14px; margin-bottom:18px; }
.dept-sales { background:linear-gradient(135deg,#059669,#047857); color:white; }
.dept-operations { background:linear-gradient(135deg,#0891b2,#0e7490); color:white; }
.dept-hr { background:linear-gradient(135deg,#7c3aed,#6d28d9); color:white; }
.dept-finance { background:linear-gradient(135deg,#d97706,#b45309); color:white; }
.dept-it { background:linear-gradient(135deg,#dc2626,#b91c1c); color:white; }
.dept-production { background:linear-gradient(135deg,#1e40af,#1e3a8a); color:white; }
.evaluation-sections { display:grid; gap:18px; }
.eval-section { background:linear-gradient(135deg,#fef3c7,#fde68a); border-radius:12px; padding:20px; border:2px solid #fbbf24; }
.eval-section-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
.eval-section-title { font-weight:700; font-size:17px; color:var(--dark); }
.eval-weight { background:var(--warning); color:white; padding:5px 14px; border-radius:20px; font-weight:700; font-size:13px; }
.score-slider-container { display:flex; align-items:center; gap:14px; margin-top:8px; }
.score-slider { flex:1; height:8px; -webkit-appearance:none; appearance:none; background:#e5e7eb; border-radius:5px; outline:none; }
.score-slider::-webkit-slider-thumb { -webkit-appearance:none; width:24px; height:24px; background:var(--primary); cursor:pointer; border-radius:50%; box-shadow:0 2px 8px rgba(30,64,175,.4); transition:all .3s; }
.score-slider::-webkit-slider-thumb:hover { transform:scale(1.2); }
.score-display { min-width:55px; text-align:center; font-weight:700; font-size:20px; color:var(--primary); background:white; padding:7px 12px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.1); }
.weighted-score { font-size:13px; color:var(--text-light); margin-top:4px; }
.total-score-card { background:linear-gradient(135deg,var(--success),#047857); color:white; padding:28px; border-radius:16px; text-align:center; margin-top:22px; box-shadow:0 10px 30px rgba(5,150,105,.3); }
.total-score-label { font-size:17px; font-weight:600; opacity:.9; margin-bottom:8px; }
.total-score-value { font-size:52px; font-weight:900; margin-bottom:8px; }
.total-score-max { font-size:15px; opacity:.8; }

/* BUTTONS */
.btn { padding:13px 28px; border:none; border-radius:10px; font-family:'Vazirmatn',sans-serif; font-size:15px; font-weight:700; cursor:pointer; transition:all .3s; display:inline-flex; align-items:center; gap:8px; box-shadow:0 4px 15px rgba(0,0,0,.1); }
.btn-primary { background:var(--primary); color:white; }
.btn-primary:hover { background:var(--primary-dark); transform:translateY(-2px); }
.btn-success { background:var(--success); color:white; }
.btn-success:hover { background:#047857; transform:translateY(-2px); }
.btn-secondary { background:var(--secondary); color:white; }
.btn-secondary:hover { background:#0e7490; transform:translateY(-2px); }
.btn-warning { background:var(--warning); color:white; }
.btn-danger { background:var(--danger); color:white; }
.btn-danger:hover { background:#b91c1c; }
.btn-purple { background:var(--purple); color:white; }
.btn-ghost { background:var(--light); color:var(--text); border:2px solid var(--border); }
.btn-ghost:hover { background:var(--border); }
.btn-accent { background:linear-gradient(135deg,var(--primary),var(--secondary)); color:white; }
.btn-accent:hover { transform:translateY(-2px); box-shadow:0 8px 20px rgba(30,64,175,.3); }
.btn-sm { padding:8px 15px; font-size:13px; }
.btn-group { display:flex; gap:14px; margin-top:22px; flex-wrap:wrap; }

/* ALERTS */
.alert { padding:14px 18px; border-radius:10px; margin-bottom:18px; font-weight:600; display:flex; align-items:center; gap:10px; font-size:14px; }
.alert-success { background:#d1fae5; color:var(--success); border:2px solid var(--success); }
.alert-info { background:#dbeafe; color:var(--primary); border:2px solid var(--primary); }
.alert-warning { background:#fef3c7; color:var(--warning); border:2px solid var(--warning); }

/* EMPLOYEES */
.employee-list { display:grid; gap:14px; }
.employee-card { background:white; border:2px solid var(--border); border-radius:12px; padding:18px; transition:all .3s; }
.employee-card:hover { border-color:var(--primary); box-shadow:0 4px 15px rgba(30,64,175,.1); }
.employee-header { display:flex; justify-content:space-between; align-items:center; }
.employee-info h3 { font-size:17px; font-weight:700; color:var(--dark); margin-bottom:4px; }
.employee-info p { color:var(--text-light); font-size:13px; }
.employee-score-value { font-size:30px; font-weight:900; color:var(--primary); }
.employee-score-label { font-size:11px; color:var(--text-light); }

/* STAR EMPLOYEES */
.star-employees-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(270px,1fr)); gap:22px; margin-top:22px; }
.star-employee-card { background:white; border:3px solid var(--border); border-radius:16px; padding:24px; text-align:center; transition:all .3s; position:relative; overflow:hidden; }
.star-employee-card:hover { transform:translateY(-5px); box-shadow:0 10px 30px rgba(0,0,0,.15); }
.star-employee-card.rank-1 { border-color:#fbbf24; background:linear-gradient(135deg,#fef3c7,#fde68a); }
.star-employee-card.rank-2 { border-color:#d1d5db; background:linear-gradient(135deg,#f3f4f6,#e5e7eb); }
.star-employee-card.rank-3 { border-color:#f97316; background:linear-gradient(135deg,#fed7aa,#fdba74); }
.star-rank-badge { position:absolute; top:14px; right:14px; width:46px; height:46px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:22px; font-weight:900; color:white; box-shadow:0 4px 10px rgba(0,0,0,.2); }
.star-rank-badge.rank-1 { background:linear-gradient(135deg,#fbbf24,#f59e0b); }
.star-rank-badge.rank-2 { background:linear-gradient(135deg,#9ca3af,#6b7280); }
.star-rank-badge.rank-3 { background:linear-gradient(135deg,#f97316,#ea580c); }
.star-employee-photo { width:110px; height:110px; border-radius:50%; margin:0 auto 14px; border:4px solid white; box-shadow:0 4px 15px rgba(0,0,0,.15); display:flex; align-items:center; justify-content:center; font-size:44px; color:var(--text-light); background:var(--light); }
.star-employee-photo img { width:100%; height:100%; border-radius:50%; object-fit:cover; }
.star-employee-name { font-size:19px; font-weight:700; color:var(--dark); margin-bottom:6px; }
.star-employee-dept { font-size:13px; color:var(--text-light); margin-bottom:14px; }
.star-employee-score { background:white; padding:13px; border-radius:12px; margin-top:14px; }
.star-score-value { font-size:30px; font-weight:900; color:var(--primary); display:block; }
.star-score-label { font-size:12px; color:var(--text-light); }

/* DEPARTMENTS */
.departments-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:18px; margin-top:18px; }
.department-card { background:white; border:2px solid var(--border); border-radius:12px; padding:20px; transition:all .3s; cursor:pointer; }
.department-card:hover { border-color:var(--primary); box-shadow:0 4px 15px rgba(30,64,175,.1); transform:translateY(-3px); }
.department-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:14px; }
.department-name { font-size:19px; font-weight:700; color:var(--dark); }
.criteria-count { background:var(--light); padding:5px 11px; border-radius:15px; font-size:12px; font-weight:600; }
.criteria-list { display:grid; gap:13px; margin-top:18px; }
.criteria-item { background:white; border:2px solid var(--border); border-radius:12px; padding:18px; display:grid; grid-template-columns:1fr 140px 90px; gap:13px; align-items:center; }
.criteria-item:hover { border-color:var(--primary); }
.criteria-name-input, .criteria-weight-input { padding:9px 13px; border:2px solid var(--border); border-radius:8px; font-family:'Vazirmatn',sans-serif; font-size:14px; font-weight:600; }
.criteria-weight-input { text-align:center; }

/* HISTORY TABLE */
.history-table { width:100%; border-collapse:collapse; margin-top:18px; }
.history-table th { background:var(--primary); color:white; padding:13px 15px; text-align:right; font-weight:700; font-size:14px; }
.history-table td { padding:13px 15px; border-bottom:1px solid var(--border); text-align:right; font-size:14px; }
.history-table tr:hover td { background:var(--light); }
.badge { display:inline-block; padding:5px 11px; border-radius:15px; font-size:12px; font-weight:600; }
.badge-high { background:#d1fae5; color:var(--success); }
.badge-medium { background:#fef3c7; color:var(--warning); }
.badge-low { background:#fee2e2; color:var(--danger); }

/* EVAL MODALS */
.eval-modal { display:none; position:fixed; z-index:1000; inset:0; background:rgba(0,0,0,.6); backdrop-filter:blur(5px); }
.eval-modal.active { display:flex; align-items:center; justify-content:center; }
.eval-modal-content { background:white; padding:38px; border-radius:20px; max-width:800px; width:92%; max-height:82vh; overflow-y:auto; animation:slideUp .4s ease-out; }
.modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:22px; }
.modal-title { font-size:22px; font-weight:900; color:var(--dark); }
.modal-close { background:var(--danger); color:white; border:none; width:33px; height:33px; border-radius:50%; cursor:pointer; font-size:19px; display:flex; align-items:center; justify-content:center; transition:all .3s; }
.modal-close:hover { transform:rotate(90deg); background:#b91c1c; }

/* SUPPLY MODALS */
.supply-modal { display:none; position:fixed; z-index:2000; inset:0; background:rgba(0,0,0,.6); backdrop-filter:blur(5px); align-items:center; justify-content:center; }
.supply-modal.active { display:flex; }
.supply-modal-box { background:white; padding:36px; border-radius:20px; max-width:640px; width:92%; max-height:85vh; overflow-y:auto; animation:slideUp .4s ease-out; }

/* EMPLOYEE MGMT */
.employee-mgmt-card { background:white; border:2px solid var(--border); border-radius:12px; padding:20px; display:flex; justify-content:space-between; align-items:center; gap:15px; }
.employee-mgmt-card:hover { border-color:var(--primary); }
.empty-state { text-align:center; padding:55px 20px; color:var(--text-light); }
.empty-state-icon { font-size:60px; margin-bottom:18px; opacity:.5; }
.empty-state h3 { font-size:19px; margin-bottom:8px; color:var(--dark); }

/* SUPPLY MODULE */
.live-badge { display:flex; align-items:center; gap:7px; background:rgba(255,255,255,.15); padding:8px 15px; border-radius:20px; font-size:13px; font-weight:600; color:white; }
.live-dot { width:8px; height:8px; border-radius:50%; background:#4ade80; animation:pulse 2s infinite; }
.clock-badge { background:rgba(255,255,255,.15); padding:8px 15px; border-radius:20px; font-size:13px; color:white; opacity:.9; }

.stat-strip { display:grid; grid-template-columns:repeat(auto-fit,minmax(185px,1fr)); gap:18px; margin-bottom:25px; }
.stat-card { background:white; border-radius:16px; padding:22px 24px; box-shadow:0 4px 20px rgba(0,0,0,.06); transition:all .3s; position:relative; overflow:hidden; border-right:4px solid transparent; }
.stat-card.blue { border-right-color:var(--primary); }
.stat-card.teal { border-right-color:var(--secondary); }
.stat-card.green { border-right-color:var(--success); }
.stat-card.orange { border-right-color:var(--warning); }
.stat-card:hover { transform:translateY(-3px); box-shadow:0 8px 30px rgba(0,0,0,.1); }
.stat-val { font-size:34px; font-weight:900; margin-bottom:4px; }
.stat-card.blue .stat-val { color:var(--primary); }
.stat-card.teal .stat-val { color:var(--secondary); }
.stat-card.green .stat-val { color:var(--success); }
.stat-card.orange .stat-val { color:var(--warning); }
.stat-icon { position:absolute; left:18px; top:50%; transform:translateY(-50%); font-size:34px; opacity:.1; }

#supply-nav { display:flex; gap:12px; flex-wrap:wrap; background:white; padding:12px; border-radius:15px; box-shadow:0 4px 20px rgba(0,0,0,.05); margin-bottom:25px; }
.supply-nav-btn { flex:1; min-width:160px; padding:13px 20px; border:none; border-radius:10px; font-family:'Vazirmatn',sans-serif; font-size:15px; font-weight:600; cursor:pointer; transition:all .3s; color:var(--text); background:var(--light); display:flex; align-items:center; justify-content:center; gap:8px; }
.supply-nav-btn:hover { background:var(--primary); color:white; transform:translateY(-2px); }
.supply-nav-btn.active { background:var(--primary); color:white; box-shadow:0 5px 15px rgba(30,64,175,.3); }
.nav-count { background:rgba(0,0,0,.15); padding:2px 8px; border-radius:10px; font-size:11px; }

.supply-section { display:none; animation:fadeIn .4s ease-out; }
.supply-section.active { display:block; }

.toolbar { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:20px; align-items:center; }
.search-wrap { flex:1; min-width:220px; position:relative; }
.search-wrap .icon { position:absolute; right:14px; top:50%; transform:translateY(-50%); color:var(--text-light); font-size:15px; }
.search-input { width:100%; padding:11px 42px 11px 15px; background:white; border:2px solid var(--border); border-radius:10px; font-family:'Vazirmatn',sans-serif; font-size:14px; color:var(--text); transition:all .3s; }
.search-input:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(30,64,175,.1); }
.filter-select { padding:11px 15px; background:white; border:2px solid var(--border); border-radius:10px; font-family:'Vazirmatn',sans-serif; font-size:14px; color:var(--text); cursor:pointer; min-width:150px; transition:all .3s; }
.filter-select:focus { outline:none; border-color:var(--primary); }

.form-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(210px,1fr)); gap:16px; margin-bottom:18px; }
.form-label { font-size:13px; font-weight:600; color:var(--dark); margin-bottom:6px; display:block; }
.form-input, .form-select { width:100%; padding:11px 14px; background:white; border:2px solid var(--border); border-radius:10px; font-family:'Vazirmatn',sans-serif; font-size:14px; color:var(--text); transition:all .3s; }
.form-input:focus, .form-select:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(30,64,175,.1); }
.form-add-section { background:linear-gradient(135deg,#eff6ff,#dbeafe); border:2px solid #bfdbfe; border-radius:14px; padding:24px; margin-bottom:20px; }

.table-wrap { overflow-x:auto; border-radius:10px; border:1px solid var(--border); }
.data-table { width:100%; border-collapse:collapse; }
.data-table thead tr { background:var(--primary); }
.data-table th { padding:13px 16px; text-align:right; font-size:13px; font-weight:700; color:white; white-space:nowrap; }
.data-table td { padding:13px 16px; text-align:right; border-bottom:1px solid var(--border); font-size:14px; vertical-align:middle; color:var(--text); }
.data-table tbody tr { transition:background .2s; }
.data-table tbody tr:hover { background:#f0f9ff; }
.data-table tbody tr:last-child td { border-bottom:none; }
.data-table .actions { display:flex; gap:6px; justify-content:flex-end; }

.chip { display:inline-flex; align-items:center; gap:5px; padding:4px 12px; border-radius:20px; font-size:12px; font-weight:600; }
.chip-blue { background:#dbeafe; color:var(--primary); }
.chip-teal,.chip-cyan { background:#cffafe; color:var(--secondary); }
.chip-green { background:#d1fae5; color:var(--success); }
.chip-orange,.chip-amber { background:#fef3c7; color:var(--warning); }
.chip-red { background:#fee2e2; color:var(--danger); }
.chip-gray { background:var(--light); color:var(--text-light); border:1px solid var(--border); }

.price-cell { font-weight:700; font-size:15px; color:var(--primary); direction:ltr; text-align:left; }
.price-unit { font-size:11px; color:var(--text-light); font-weight:400; }
.update-badge { display:flex; flex-direction:column; font-size:11px; color:var(--text-light); white-space:nowrap; }
.update-badge .date { color:var(--dark); font-size:12px; font-weight:600; }
.change-up { color:var(--success); font-size:12px; font-weight:700; }
.change-down { color:var(--danger); font-size:12px; font-weight:700; }
.change-flat { color:var(--text-light); font-size:12px; }

.grid-cards { display:grid; grid-template-columns:repeat(auto-fill,minmax(270px,1fr)); gap:18px; margin-top:16px; }
.item-card { background:white; border:2px solid var(--border); border-radius:16px; padding:22px; transition:all .3s; }
.item-card:hover { border-color:var(--primary); box-shadow:0 8px 30px rgba(30,64,175,.1); transform:translateY(-3px); }
.item-card-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:14px; }
.item-card-icon { width:46px; height:46px; border-radius:12px; background:linear-gradient(135deg,#dbeafe,#bfdbfe); display:flex; align-items:center; justify-content:center; font-size:22px; }
.item-card-name { font-size:17px; font-weight:700; color:var(--dark); margin-bottom:5px; }
.item-card-meta { font-size:13px; color:var(--text-light); }
.item-card-actions { display:flex; gap:8px; margin-top:16px; padding-top:16px; border-top:1px solid var(--border); }

.chart-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(400px,1fr)); gap:20px; }
.chart-card { background:white; border-radius:16px; padding:24px; box-shadow:0 4px 20px rgba(0,0,0,.06); }
.chart-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; flex-wrap:wrap; gap:10px; }
.chart-title { font-size:16px; font-weight:700; color:var(--dark); }
.chart-subtitle { font-size:12px; color:var(--text-light); margin-top:3px; }
.period-tabs { display:flex; gap:6px; }
.period-tab { padding:6px 14px; border-radius:8px; font-size:13px; font-weight:600; cursor:pointer; transition:all .2s; border:2px solid var(--border); color:var(--text-light); background:white; font-family:'Vazirmatn',sans-serif; }
.period-tab.active { background:var(--primary); color:white; border-color:var(--primary); }
.period-tab:hover:not(.active) { border-color:var(--primary); color:var(--primary); }

.empty { text-align:center; padding:40px 20px; color:var(--text-light); }
.empty-icon { font-size:48px; margin-bottom:12px; opacity:.4; }
.empty-text { font-size:16px; font-weight:600; color:var(--dark); margin-bottom:6px; }
.empty-sub { font-size:13px; }

.card-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; flex-wrap:wrap; gap:10px; }

/* TOAST */
.s-toast { position:fixed; bottom:28px; left:50%; transform:translateX(-50%) translateY(80px); background:var(--dark); border-radius:30px; padding:12px 26px; font-size:14px; font-weight:600; color:white; box-shadow:0 8px 30px rgba(0,0,0,.3); z-index:9999; transition:transform .4s cubic-bezier(.175,.885,.32,1.275); display:flex; align-items:center; gap:10px; }
.s-toast.show { transform:translateX(-50%) translateY(0); }

/* ANIMATIONS */
@keyframes slideDown { from { opacity:0; transform:translateY(-30px); } to { opacity:1; transform:translateY(0); } }
@keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
@keyframes slideUp { from { opacity:0; transform:translateY(30px); } to { opacity:1; transform:translateY(0); } }
@keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:.5; } }

@media(max-width:768px) {
  .master-nav { padding:0 12px; height:56px; }
  body { padding-top:56px; }
  .master-logo-sub,.master-meta { display:none; }
  .master-module-btn { padding:0 14px; font-size:13px; }
  .master-logo-text { font-size:14px; }
  .nav-tabs,.form-grid { flex-direction:column; }
  .criteria-item { grid-template-columns:1fr; }
  .header { flex-direction:column; align-items:flex-start; }
  .chart-grid { grid-template-columns:1fr; }
}

/* SALES DASHBOARD */
.product-checkbox-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:12px; }
.product-checkbox-item { display:flex; align-items:center; gap:10px; padding:12px 16px; background:white; border:2px solid var(--border); border-radius:10px; cursor:pointer; transition:all .3s; user-select:none; }
.product-checkbox-item:hover { border-color:var(--primary); background:#f0f9ff; transform:translateY(-2px); box-shadow:0 4px 12px rgba(30,64,175,.1); }
.product-checkbox-item.selected { border-color:var(--primary); background:linear-gradient(135deg,#dbeafe,#eff6ff); }
.product-checkbox-item input[type="checkbox"] { width:20px; height:20px; cursor:pointer; accent-color:var(--primary); }
.product-checkbox-label { flex:1; display:flex; align-items:center; gap:8px; font-weight:600; font-size:14px; color:var(--dark); cursor:pointer; }
.product-checkbox-item.selected .product-checkbox-label { color:var(--primary); }
.product-icon { font-size:22px; }
.product-price-count { background:var(--light); padding:4px 10px; border-radius:12px; font-size:11px; font-weight:700; color:var(--text-light); }
.product-checkbox-item.selected .product-price-count { background:var(--primary); color:white; }

.sales-price-table-wrapper { margin-bottom:22px; animation:slideDown .4s ease-out; }
.sales-table-header { background:linear-gradient(135deg,var(--primary),var(--primary-dark)); color:white; padding:16px 20px; border-radius:12px 12px 0 0; display:flex; align-items:center; justify-content:space-between; }
.sales-table-title { display:flex; align-items:center; gap:10px; font-size:17px; font-weight:700; }
.sales-table-meta { display:flex; align-items:center; gap:10px; font-size:13px; opacity:.9; }
.sales-table-content { border:2px solid var(--primary); border-top:none; border-radius:0 0 12px 12px; overflow:hidden; }

.product-category-section { margin-bottom:20px; border:2px solid var(--border); border-radius:12px; overflow:hidden; background:white; }
.category-header { background:linear-gradient(135deg,#f3f4f6,#e5e7eb); padding:12px 16px; display:flex; align-items:center; justify-content:space-between; border-bottom:2px solid var(--border); cursor:pointer; transition:all .3s; }
.category-header:hover { background:linear-gradient(135deg,#e5e7eb,#d1d5db); }
.category-header-left { display:flex; align-items:center; gap:10px; }
.category-icon { font-size:24px; }
.category-name { font-size:15px; font-weight:700; color:var(--dark); }
.category-count { background:white; padding:4px 10px; border-radius:12px; font-size:11px; font-weight:700; color:var(--text-light); }
.category-toggle { font-size:20px; color:var(--text-light); transition:transform .3s; }
.category-header.collapsed .category-toggle { transform:rotate(-90deg); }
.category-products { padding:14px; display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:10px; }
.category-products.collapsed { display:none; }

/* â”€â”€ BACKUP / IMPORT PANEL â”€â”€ */
.io-panel { background:linear-gradient(135deg,#f0fdf4,#dcfce7); border:2px solid #86efac; border-radius:14px; padding:18px 22px; margin-bottom:20px; }
.io-panel.blue { background:linear-gradient(135deg,#eff6ff,#dbeafe); border-color:#93c5fd; }
.io-title { font-size:14px; font-weight:700; color:#166534; margin-bottom:12px; display:flex; align-items:center; gap:7px; }
.io-panel.blue .io-title { color:#1e40af; }
.io-btn-row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
.io-label { display:inline-flex; align-items:center; gap:7px; padding:9px 18px; border-radius:9px; font-family:'Vazirmatn',sans-serif; font-size:14px; font-weight:700; cursor:pointer; transition:all .25s; border:none; }
.io-label.green { background:#059669; color:white; }
.io-label.green:hover { background:#047857; transform:translateY(-1px); }
.io-label.blue { background:#1e40af; color:white; }
.io-label.blue:hover { background:#1e3a8a; transform:translateY(-1px); }
.io-label.orange { background:#d97706; color:white; }
.io-label.orange:hover { background:#b45309; transform:translateY(-1px); }
input[type=file].hidden-file { display:none; }

/* â•â•â• LOADING MODULE CSS â•â•â• */
.loading-tabs{display:flex;gap:10px;background:white;padding:10px;border-radius:14px;box-shadow:0 4px 20px rgba(0,0,0,.06);margin-bottom:20px;flex-wrap:wrap;}
.loading-tab{flex:1;min-width:120px;padding:10px 16px;background:#f3f4f6;border:none;border-radius:9px;font-family:'Vazirmatn',sans-serif;font-size:14px;font-weight:700;color:#374151;cursor:pointer;transition:all .25s;}
.loading-tab:hover{background:#e5e7eb;}
.loading-tab.active{color:white;box-shadow:0 4px 14px rgba(30,64,175,.3);}
.loading-tab.blue.active{background:linear-gradient(135deg,#1e40af,#1e3a8a);}
.loading-tab.orange.active{background:linear-gradient(135deg,#d97706,#b45309);}
.loading-tab.green.active{background:linear-gradient(135deg,#059669,#047857);}
.loading-tab.gray.active{background:linear-gradient(135deg,#475569,#334155);}
.loading-section{display:none;}
.loading-section.active{display:block;animation:fadeIn .3s ease-out;}
.ltable-wrap{overflow-x:auto;border-radius:12px;border:1px solid #e5e7eb;margin-top:14px;}
.ltable{width:100%;border-collapse:collapse;font-size:13px;}
.ltable thead tr{background:linear-gradient(135deg,#1e40af,#1e3a8a);}
.ltable.orange thead tr{background:linear-gradient(135deg,#d97706,#b45309);}
.ltable.green thead tr{background:linear-gradient(135deg,#059669,#047857);}
.ltable.gray thead tr{background:linear-gradient(135deg,#475569,#334155);}
.ltable th{color:white;padding:11px 10px;text-align:right;font-weight:700;white-space:nowrap;font-size:12px;}
.ltable td{padding:7px 8px;border-bottom:1px solid #f1f5f9;vertical-align:middle;}
.ltable tbody tr:hover{background:#f8fafc;}
.ltable tbody tr:last-child td{border-bottom:none;}
.ltable td input[type=text],.ltable td input[type=number],.ltable td select{width:100%;padding:5px 7px;border:1.5px solid #e5e7eb;border-radius:6px;font-family:'Vazirmatn',sans-serif;font-size:12px;background:white;transition:border-color .2s;min-width:60px;}
.ltable td input[type=text]:focus,.ltable td input[type=number]:focus,.ltable td select:focus{outline:none;border-color:#1e40af;background:#eff6ff;}
.ltable td input[type=checkbox]{width:17px;height:17px;cursor:pointer;accent-color:#1e40af;}
.ltable td .del-btn{background:#fee2e2;color:#dc2626;border:none;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:12px;font-weight:700;transition:all .2s;}
.ltable td .del-btn:hover{background:#dc2626;color:white;}
.ltable td .arch-btn{background:#e0e7ff;color:#1e40af;border:none;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:12px;font-weight:700;transition:all .2s;}
.ltable td .arch-btn:hover{background:#1e40af;color:white;}
.lcard-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px;}
.lcard-title{font-size:18px;font-weight:900;color:#1f2937;display:flex;align-items:center;gap:8px;}
.lcard-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
.loaded-badge{display:inline-flex;align-items:center;gap:5px;background:#d1fae5;color:#065f46;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:700;}
.table-count{font-size:12px;color:#6b7280;font-weight:600;}

/* â”€â”€ DRIVER MODAL â”€â”€ */
.driver-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:10000;display:flex;align-items:center;justify-content:center;animation:fadeIn .2s;}
.driver-modal{background:white;border-radius:20px;padding:32px;width:460px;max-width:95vw;box-shadow:0 25px 60px rgba(0,0,0,.3);animation:slideDown .3s ease-out;}
.driver-modal h3{font-size:20px;font-weight:900;color:#1f2937;margin-bottom:6px;}
.driver-modal p{font-size:13px;color:#6b7280;margin-bottom:24px;}
.driver-modal .dm-field{margin-bottom:16px;}
.driver-modal .dm-label{font-size:13px;font-weight:700;color:#374151;margin-bottom:6px;display:block;}
.driver-modal .dm-input{width:100%;padding:11px 14px;border:2px solid #e5e7eb;border-radius:10px;font-family:'Vazirmatn',sans-serif;font-size:14px;transition:.2s;}
.driver-modal .dm-input:focus{outline:none;border-color:#1e40af;box-shadow:0 0 0 3px rgba(30,64,175,.1);}
.driver-modal .dm-row{display:flex;gap:10px;margin-top:22px;}
.driver-modal .dm-confirm{flex:1;background:linear-gradient(135deg,#059669,#047857);color:white;border:none;border-radius:10px;padding:12px;font-family:'Vazirmatn',sans-serif;font-size:15px;font-weight:700;cursor:pointer;}
.driver-modal .dm-cancel{background:#f3f4f6;color:#374151;border:none;border-radius:10px;padding:12px 20px;font-family:'Vazirmatn',sans-serif;font-size:14px;font-weight:700;cursor:pointer;}
.driver-modal .dm-confirm:hover{background:linear-gradient(135deg,#047857,#065f46);}
.driver-modal .dm-cancel:hover{background:#e5e7eb;}

/* â”€â”€ TABLE: pending row highlight â”€â”€ */
.ltable tbody tr.row-pending{background:#fefce8;}
.ltable tbody tr.row-pending:hover{background:#fef9c3;}
.ltable tbody tr.row-loaded-check{background:#f0fdf4;}

/* â”€â”€ TABLE: contract date column â”€â”€ */
.ltable th.col-date,.ltable td.col-date{min-width:110px;}

/* â”€â”€ purchase table header â”€â”€ */
.ltable.purchase thead tr{background:linear-gradient(135deg,#1e40af,#1e3a8a);}
.ltable.sale thead tr{background:linear-gradient(135deg,#d97706,#b45309);}
</style>
</head>
<body>

<!-- MASTER NAV -->
<nav class="master-nav" id="master-nav">
  <div class="master-logo">
    <div class="master-logo-icon">ğŸ—ï¸</div>
    <div>
      <div class="master-logo-text">ÙÙˆÙ„Ø§Ø¯ Ù¾Ù„ØªÙØ±Ù…</div>
      <div class="master-logo-sub">Ø´Ø±Ú©Øª Ø¨Ø§Ø²Ø±Ú¯Ø§Ù†ÛŒ ÙÙˆÙ„Ø§Ø¯</div>
    </div>
  </div>
  <button class="master-module-btn" id="btn-eval" onclick="switchModule('eval')">
    <span class="m-icon">â­</span> Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù¾Ø±Ø³Ù†Ù„ <span class="m-badge">HR</span>
  </button>
  <button class="master-module-btn" id="btn-supply" onclick="switchModule('supply')">
    <span class="m-icon">âš™ï¸</span> Ù…Ø¯ÛŒØ±ÛŒØª ØªØ§Ù…ÛŒÙ† <span class="m-badge">SCM</span>
  </button>
  <button class="master-module-btn" id="btn-loading" onclick="switchModule('loading')">
    <span class="m-icon">ğŸš›</span> Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ <span class="m-badge">LGS</span>
  </button>
  <div class="master-spacer"></div>
  <div class="master-meta" id="master-meta-bar">
    <div class="master-user-badge" id="master-user-badge" style="display:none;">
      ğŸ‘¤ <span id="master-user-name">â€”</span>
    </div>
    <div class="master-clock" id="master-clock">â€”</div>
    <button class="master-logout" style="background:rgba(255,165,0,.3);border-color:rgba(255,165,0,.5);" onclick="exportFullBackup()">ğŸ’¾ Ø¨Ú©Ø§Ù¾ Ú©Ø§Ù…Ù„</button>
    <label class="master-logout" style="background:rgba(0,200,100,.2);border-color:rgba(0,200,100,.4);cursor:pointer;">
      ğŸ“‚ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ
      <input type="file" class="hidden-file" accept=".json" onchange="importFullBackup(event)">
    </label>
    <button class="master-logout" id="master-logout-btn" onclick="masterLogout()" style="display:none;">ğŸšª Ø®Ø±ÙˆØ¬</button>
  </div>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODULE: EVAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="module-panel" id="eval-module">

  <div class="login-overlay" id="login-overlay">
    <div class="login-box">
      <div class="login-logo">â­</div>
      <div class="login-title">Ø³ÛŒØ³ØªÙ… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù¾Ø±Ø³Ù†Ù„</div>
      <div class="login-subtitle">Ø´Ø±Ú©Øª Ø¨Ø§Ø²Ø±Ú¯Ø§Ù†ÛŒ ÙÙˆÙ„Ø§Ø¯</div>
      <div class="login-error" id="login-error">âŒ Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ù…Ø¯ÛŒØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯!</div>
      <div class="login-form">
        <div class="form-group">
          <label>ğŸ‘¤ Ù†Ø§Ù… Ù…Ø¯ÛŒØ± Ø§Ø±Ø²ÛŒØ§Ø¨</label>
          <select id="login-manager-select">
            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
            <option value="Ù…Ø¯ÛŒØ± Ø¹Ø§Ù…Ù„">Ù…Ø¯ÛŒØ± Ø¹Ø§Ù…Ù„</option>
            <option value="Ù…Ø¯ÛŒØ± ÙØ±ÙˆØ´">Ù…Ø¯ÛŒØ± ÙØ±ÙˆØ´</option>
            <option value="Ù…Ø¯ÛŒØ± Ø¹Ù…Ù„ÛŒØ§Øª">Ù…Ø¯ÛŒØ± Ø¹Ù…Ù„ÛŒØ§Øª</option>
            <option value="Ù…Ø¯ÛŒØ± Ù…Ù†Ø§Ø¨Ø¹ Ø§Ù†Ø³Ø§Ù†ÛŒ">Ù…Ø¯ÛŒØ± Ù…Ù†Ø§Ø¨Ø¹ Ø§Ù†Ø³Ø§Ù†ÛŒ</option>
            <option value="Ù…Ø¯ÛŒØ± Ù…Ø§Ù„ÛŒ">Ù…Ø¯ÛŒØ± Ù…Ø§Ù„ÛŒ</option>
          </select>
        </div>
        <button class="login-btn" onclick="doLogin()">ğŸ” ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…</button>
      </div>
    </div>
  </div>

  <div class="app-container" id="main-app" style="display:none;">
    <div class="header">
      <div class="header-left">
        <h1>â­ Ø³ÛŒØ³ØªÙ… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù¾Ø±Ø³Ù†Ù„</h1>
        <p>Ø´Ø±Ú©Øª Ø¨Ø§Ø²Ø±Ú¯Ø§Ù†ÛŒ ÙÙˆÙ„Ø§Ø¯ â€” Real-time Ø¨Ø§ Firebase Cloud</p>
      </div>
      <div class="header-right">
        <div class="manager-badge">ğŸ‘¤ <span id="current-manager-display">â€”</span></div>
        <div class="status-badge"><div id="status-dot"></div><span id="status-text">Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...</span></div>
        <button class="logout-btn" onclick="doLogout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>

    <div class="nav-tabs">
      <button class="nav-tab active" onclick="switchTab('evaluation',this)">ğŸ“ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¬Ø¯ÛŒØ¯</button>
      <button class="nav-tab" onclick="switchTab('my-history',this)">ğŸ“‹ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ù†</button>
      <button class="nav-tab shared-tab" onclick="switchTab('shared-dashboard',this)">ğŸŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø´ØªØ±Ú©</button>
      <button class="nav-tab shared-tab" onclick="switchTab('star-employees',this)">â­ Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù† Ù†Ù…ÙˆÙ†Ù‡</button>
      <button class="nav-tab" onclick="switchTab('manage-employees',this)">ğŸ‘¤ Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù†</button>
      <button class="nav-tab" onclick="switchTab('departments',this)">ğŸ¢ Ø¨Ø®Ø´â€ŒÙ‡Ø§</button>
    </div>

    <div id="evaluation-section" class="section active">
      <div class="card">
        <h2 class="card-title">ğŸ¯ Ø«Ø¨Øª Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¬Ø¯ÛŒØ¯</h2>
        <div class="alert alert-info">â„¹ï¸ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡ Ø¨Ù‡â€ŒÙ†Ø§Ù… Ø´Ù…Ø§ (<strong id="eval-manager-label">â€”</strong>) Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
        <div class="form-grid">
          <div class="form-group">
            <label>Ø¨Ø®Ø´ (Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†) *</label>
            <select id="employee-department" onchange="handleDepartmentChange()">
              <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
            </select>
          </div>
          <div class="form-group">
            <label>Ù†Ø§Ù… Ú©Ø§Ø±Ù…Ù†Ø¯ *</label>
            <select id="employee-name"><option value="">Ø§Ø¨ØªØ¯Ø§ Ø¨Ø®Ø´ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option></select>
          </div>
          <div class="form-group">
            <label>ØªØ§Ø±ÛŒØ® Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</label>
            <input type="date" id="evaluation-date">
          </div>
        </div>
        <div id="department-badge-container"></div>
        <div class="evaluation-sections" id="evaluation-criteria"></div>
        <div class="total-score-card" style="display:none;" id="total-score-container">
          <div class="total-score-label">Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„ Ø§ÛŒÙ† Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</div>
          <div class="total-score-value" id="total-score">0</div>
          <div class="total-score-max">Ø§Ø² <span id="max-score">1000</span></div>
        </div>
        <div class="btn-group">
          <button class="btn btn-success" onclick="saveEvaluation()">âœ… Ø°Ø®ÛŒØ±Ù‡ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</button>
          <button class="btn btn-secondary" onclick="resetForm()">ğŸ”„ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù…</button>
        </div>
      </div>
    </div>

    <div id="my-history-section" class="section">
      <div class="card">
        <h2 class="card-title">ğŸ“‹ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡ ØªÙˆØ³Ø· Ù…Ù†</h2>
        <div class="alert alert-info" id="my-history-info">ğŸ“Œ ÙÙ‚Ø· Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
        <div class="io-panel">
          <div class="io-title">ğŸ’¾ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ Ùˆ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ â€” Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ù†</div>
          <div class="io-btn-row">
            <button class="btn btn-warning" onclick="exportMyEvaluations()">ğŸ“¥ Ø®Ø±ÙˆØ¬ÛŒ JSON</button>
            <button class="btn btn-success" onclick="exportMyEvaluationsExcel()">ğŸ“Š Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„</button>
            <label class="io-label green">
              ğŸ“‚ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø² JSON
              <input type="file" class="hidden-file" accept=".json" onchange="importMyEvaluations(event)">
            </label>
          </div>
        </div>
        <table class="history-table">
          <thead><tr><th>ØªØ§Ø±ÛŒØ®</th><th>Ù†Ø§Ù… Ú©Ø§Ø±Ù…Ù†Ø¯</th><th>Ø¨Ø®Ø´</th><th>Ø§Ù…ØªÛŒØ§Ø²</th><th>Ø±ØªØ¨Ù‡</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead>
          <tbody id="my-history-tbody"></tbody>
        </table>
      </div>
    </div>

    <div id="shared-dashboard-section" class="section">
      <div class="shared-dashboard-header">
        <div class="icon">ğŸŒ</div>
        <div>
          <h3>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø´ØªØ±Ú© â€” Ù‚Ø§Ø¨Ù„ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ù…Ø¯ÛŒØ±Ø§Ù†</h3>
          <p>Ù…Ø¬Ù…ÙˆØ¹ Ú©Ù„ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª Ùˆ Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ ØªÙ…Ø§Ù… Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù† Ø§Ø² Ù‡Ù…Ù‡ Ø¨Ø®Ø´â€ŒÙ‡Ø§</p>
        </div>
      </div>
      <div class="summary-stats-grid" id="summary-stats"></div>
      <div class="card">
        <div class="card-header">
          <h2 class="card-title" style="margin-bottom:0;">ğŸ† Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ú©Ù„ÛŒ Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù†</h2>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn btn-warning btn-sm" onclick="exportAllEvaluationsJSON()">ğŸ“¥ JSON Ú©Ø§Ù…Ù„</button>
            <button class="btn btn-success btn-sm" onclick="exportAllEvaluationsExcel()">ğŸ“Š Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„</button>
            <button class="btn btn-primary btn-sm" onclick="exportRankingExcel()">ğŸ† Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ø§Ú©Ø³Ù„</button>
            <label class="io-label orange" style="padding:6px 14px;font-size:13px;">
              ğŸ“‚ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ JSON
              <input type="file" class="hidden-file" accept=".json" onchange="importAllEvaluations(event)">
            </label>
          </div>
        </div>
        <div class="alert alert-warning">âš ï¸ Ø§ÛŒÙ† Ø¬Ø¯ÙˆÙ„ Ù…Ø¬Ù…ÙˆØ¹ ØªÙ…Ø§Ù… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ Ù‡Ù…Ù‡ Ù…Ø¯ÛŒØ±Ø§Ù† Ø±Ø§ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.</div>
        <div style="overflow-x:auto;">
          <table class="ranking-table" id="global-ranking-table">
            <thead><tr><th style="width:60px;">Ø±ØªØ¨Ù‡</th><th>Ù†Ø§Ù… Ú©Ø§Ø±Ù…Ù†Ø¯</th><th>Ø¨Ø®Ø´</th><th>ØªØ¹Ø¯Ø§Ø¯ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</th><th>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù…ØªÛŒØ§Ø²</th><th>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† %</th><th>Ù†Ù…ÙˆØ¯Ø§Ø±</th></tr></thead>
            <tbody id="global-ranking-tbody"></tbody>
          </table>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:22px;margin-top:10px;">
        <div class="card"><h3 style="margin-bottom:18px;font-size:17px;">ğŸ“ˆ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø§Ù…ØªÛŒØ§Ø² Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù†</h3><canvas id="sharedEmployeesChart"></canvas></div>
        <div class="card"><h3 style="margin-bottom:18px;font-size:17px;">ğŸ¢ ØªÙˆØ²ÛŒØ¹ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ Ø¯Ø± Ø¨Ø®Ø´â€ŒÙ‡Ø§</h3><canvas id="sharedDepartmentsChart"></canvas></div>
      </div>
    </div>

    <div id="star-employees-section" class="section">
      <div class="card">
        <h2 class="card-title">â­ ØªØ§Ø¨Ù„Ùˆ Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù† Ù†Ù…ÙˆÙ†Ù‡ Ù…Ø§Ù‡</h2>
        <div class="alert alert-info">â„¹ï¸ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ Ù‡Ù…Ù‡ Ù…Ø¯ÛŒØ±Ø§Ù† Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
        <div class="form-grid" style="margin-bottom:22px;">
          <div class="form-group">
            <label>Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø§Ù‡</label>
            <input type="month" id="star-month-selector" onchange="updateStarEmployees()">
          </div>
          <div class="form-group">
            <label>ØªØ¹Ø¯Ø§Ø¯ Ù†Ù…Ø§ÛŒØ´</label>
            <select id="star-count-selector" onchange="updateStarEmployees()">
              <option value="3">3 Ù†ÙØ± Ø¨Ø±ØªØ±</option>
              <option value="5">5 Ù†ÙØ± Ø¨Ø±ØªØ±</option>
              <option value="10">10 Ù†ÙØ± Ø¨Ø±ØªØ±</option>
            </select>
          </div>
        </div>
        <div class="star-employees-grid" id="star-employees-grid"></div>
      </div>
    </div>

    <div id="manage-employees-section" class="section">
      <div class="card">
        <h2 class="card-title">ğŸ‘¤ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù†</h2>
        <div class="io-panel blue">
          <div class="io-title">ğŸ’¾ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ Ùˆ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ â€” Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù†</div>
          <div class="io-btn-row">
            <button class="btn btn-warning" onclick="exportEmployeesJSON()">ğŸ“¥ Ø®Ø±ÙˆØ¬ÛŒ JSON</button>
            <label class="io-label blue">
              ğŸ“‚ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø² JSON
              <input type="file" class="hidden-file" accept=".json" onchange="importEmployeesJSON(event)">
            </label>
          </div>
        </div>
        <div class="card" style="background:linear-gradient(135deg,#f0f9ff,#dbeafe);margin-bottom:22px;">
          <h3 style="font-size:17px;margin-bottom:14px;">â• Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ù…Ù†Ø¯ Ø¬Ø¯ÛŒØ¯</h3>
          <div class="form-grid">
            <div class="form-group"><label>Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ *</label><input type="text" id="new-emp-name" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù„ÛŒ Ø§Ø­Ù…Ø¯ÛŒ"></div>
            <div class="form-group"><label>Ø¨Ø®Ø´ *</label><select id="new-emp-department"><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option></select></div>
            <div class="form-group"><label>Ø³Ù…Øª</label><input type="text" id="new-emp-position" placeholder="Ù…Ø«Ø§Ù„: Ú©Ø§Ø±Ø´Ù†Ø§Ø³ ÙØ±ÙˆØ´"></div>
            <div class="form-group"><label>Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ</label><input type="text" id="new-emp-code" placeholder="Ù…Ø«Ø§Ù„: 1001"></div>
            <div class="form-group"><label>Ø¹Ú©Ø³ (URL)</label><input type="text" id="new-emp-photo" placeholder="https://..."></div>
          </div>
          <div class="btn-group">
            <button class="btn btn-success" onclick="addNewEmployee()">âœ… Ø§ÙØ²ÙˆØ¯Ù†</button>
            <button class="btn btn-secondary" onclick="clearEmployeeForm()">ğŸ”„ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
          </div>
        </div>
        <div class="card">
          <h3 style="font-size:17px;margin-bottom:14px;">ğŸ“‹ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù†</h3>
          <div class="criteria-list" id="employees-management-list"></div>
        </div>
      </div>
    </div>

    <div id="departments-section" class="section">
      <div class="card">
        <h2 class="card-title">ğŸ¢ Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø®Ø´â€ŒÙ‡Ø§ Ùˆ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§</h2>
        <div class="io-panel blue">
          <div class="io-title">ğŸ’¾ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ Ùˆ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ â€” Ø¨Ø®Ø´â€ŒÙ‡Ø§ Ùˆ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§</div>
          <div class="io-btn-row">
            <button class="btn btn-warning" onclick="exportDepartmentsJSON()">ğŸ“¥ Ø®Ø±ÙˆØ¬ÛŒ JSON</button>
            <label class="io-label blue">
              ğŸ“‚ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø² JSON
              <input type="file" class="hidden-file" accept=".json" onchange="importDepartmentsJSON(event)">
            </label>
          </div>
        </div>
        <div class="alert alert-warning">âš ï¸ Ù‡Ø± Ø¨Ø®Ø´ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù…Ø®ØµÙˆØµ Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø§Ø±Ø¯.</div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="showAddDepartmentModal()">â• Ø¨Ø®Ø´ Ø¬Ø¯ÛŒØ¯</button>
          <button class="btn btn-secondary" onclick="resetToDefaultDepartments()">ğŸ”„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶</button>
        </div>
        <div class="departments-grid" id="departments-grid"></div>
      </div>
    </div>
  </div>

  <!-- EVAL MODALS -->
  <div id="criteria-modal" class="eval-modal">
    <div class="eval-modal-content">
      <div class="modal-header">
        <h2 class="modal-title">ÙˆÛŒØ±Ø§ÛŒØ´ Ø¨Ø®Ø´</h2>
        <button class="modal-close" onclick="closeCriteriaModal()">Ã—</button>
      </div>
      <div class="form-grid" style="margin-bottom:20px;">
        <div class="form-group"><label>Ù†Ø§Ù… Ø¨Ø®Ø´</label><input type="text" id="modal-department-name-input" class="criteria-name-input"></div>
        <div class="form-group"><label>Ø¢ÛŒÚ©ÙˆÙ†</label><input type="text" id="modal-department-icon-input" class="criteria-name-input" maxlength="2"></div>
      </div>
      <div id="modal-department-badge"></div>
      <h3 style="font-size:17px;margin-bottom:13px;">ğŸ“‹ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</h3>
      <div class="criteria-list" id="modal-criteria-list"></div>
      <div class="btn-group">
        <button class="btn btn-success" onclick="saveDepartmentCriteria()">âœ… Ø°Ø®ÛŒØ±Ù‡</button>
        <button class="btn btn-primary" onclick="addNewCriteriaToModal()">â• Ù…Ø¹ÛŒØ§Ø± Ø¬Ø¯ÛŒØ¯</button>
        <button class="btn btn-danger" onclick="deleteDepartment()">ğŸ—‘ï¸ Ø­Ø°Ù Ø¨Ø®Ø´</button>
      </div>
    </div>
  </div>

  <div id="add-department-modal" class="eval-modal">
    <div class="eval-modal-content">
      <div class="modal-header">
        <h2 class="modal-title">â• Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ø®Ø´ Ø¬Ø¯ÛŒØ¯</h2>
        <button class="modal-close" onclick="closeAddDepartmentModal()">Ã—</button>
      </div>
      <div class="form-group" style="margin-bottom:16px;"><label>Ù†Ø§Ù… Ø¨Ø®Ø´</label><input type="text" id="new-department-name" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ÛŒ"></div>
      <div class="form-group" style="margin-bottom:20px;"><label>Ø¢ÛŒÚ©ÙˆÙ†</label><input type="text" id="new-department-icon" placeholder="Ù…Ø«Ø§Ù„: ğŸ“¢" maxlength="2"></div>
      <div class="btn-group"><button class="btn btn-success" onclick="createNewDepartment()">âœ… Ø§ÛŒØ¬Ø§Ø¯</button></div>
    </div>
  </div>

  <div id="edit-employee-modal" class="eval-modal">
    <div class="eval-modal-content">
      <div class="modal-header">
        <h2 class="modal-title">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±Ù…Ù†Ø¯</h2>
        <button class="modal-close" onclick="closeEditEmployeeModal()">Ã—</button>
      </div>
      <div class="form-grid">
        <div class="form-group"><label>Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ *</label><input type="text" id="edit-emp-name"></div>
        <div class="form-group"><label>Ø¨Ø®Ø´ *</label><select id="edit-emp-department"><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option></select></div>
        <div class="form-group"><label>Ø³Ù…Øª</label><input type="text" id="edit-emp-position"></div>
        <div class="form-group"><label>Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ</label><input type="text" id="edit-emp-code"></div>
        <div class="form-group" style="grid-column:1/-1;"><label>Ø¹Ú©Ø³ (URL)</label><input type="text" id="edit-emp-photo"></div>
      </div>
      <div class="btn-group">
        <button class="btn btn-success" onclick="saveEditedEmployee()">âœ… Ø°Ø®ÛŒØ±Ù‡</button>
        <button class="btn btn-secondary" onclick="closeEditEmployeeModal()">âŒ Ø§Ù†ØµØ±Ø§Ù</button>
      </div>
    </div>
  </div>
</div><!-- /eval-module -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODULE: SUPPLY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="module-panel" id="supply-module">
<div id="supply-app" style="max-width:1600px;margin:0 auto;padding:20px;">

  <div class="header">
    <div class="header-left">
      <h1>âš™ï¸ Ø¨Ø®Ø´ ØªØ§Ù…ÛŒÙ† â€” Ø´Ø±Ú©Øª Ø¨Ø§Ø²Ø±Ú¯Ø§Ù†ÛŒ ÙÙˆÙ„Ø§Ø¯</h1>
      <p>Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø­ØµÙˆÙ„Ø§ØªØŒ Ú©Ø§Ø±Ø®Ø§Ù†Ø¬Ø§Øª Ùˆ Ù‚ÛŒÙ…Øªâ€ŒÚ¯Ø°Ø§Ø±ÛŒ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ</p>
    </div>
    <div class="header-right">
      <div class="live-badge"><div class="live-dot" id="supply-status-dot"></div><span id="supply-status-text">Firebase</span></div>
      <div class="clock-badge" id="supply-clock">â€”</div>
    </div>
  </div>

  <div class="stat-strip">
    <div class="stat-card blue"><div class="stat-icon">ğŸ“¦</div><div class="stat-val" id="stat-products">0</div><div class="stat-label">Ù…Ø­ØµÙˆÙ„Ø§Øª Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡</div></div>
    <div class="stat-card teal"><div class="stat-icon">ğŸ­</div><div class="stat-val" id="stat-factories">0</div><div class="stat-label">Ú©Ø§Ø±Ø®Ø§Ù†Ø¬Ø§Øª ÙØ¹Ø§Ù„</div></div>
    <div class="stat-card green"><div class="stat-icon">ğŸ’°</div><div class="stat-val" id="stat-prices">0</div><div class="stat-label">Ø±Ú©ÙˆØ±Ø¯ Ù‚ÛŒÙ…Øª</div></div>
    <div class="stat-card orange"><div class="stat-icon">ğŸ•</div><div class="stat-val" id="stat-today">0</div><div class="stat-label">Ø¢Ù¾Ø¯ÛŒØª Ø§Ù…Ø±ÙˆØ²</div></div>
  </div>

  <div id="supply-nav">
    <button class="supply-nav-btn" onclick="supplyTab('sales-dashboard',this)">ğŸ¯ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ÙØ±ÙˆØ´</button>
    <button class="supply-nav-btn active" onclick="supplyTab('prices',this)">ğŸ’° Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ <span class="nav-count" id="nc-prices">0</span></button>
    <button class="supply-nav-btn" onclick="supplyTab('products',this)">ğŸ“¦ Ù…Ø­ØµÙˆÙ„Ø§Øª <span class="nav-count" id="nc-products">0</span></button>
    <button class="supply-nav-btn" onclick="supplyTab('factories',this)">ğŸ­ Ú©Ø§Ø±Ø®Ø§Ù†Ø¬Ø§Øª <span class="nav-count" id="nc-factories">0</span></button>
    <button class="supply-nav-btn" onclick="supplyTab('analytics',this)">ğŸ“Š ØªØ­Ù„ÛŒÙ„ Ù‡ÙØªÚ¯ÛŒ</button>
  </div>

  <!-- â•â•â• SALES DASHBOARD â€” FIX: Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¯Ø± Ù†Ø³Ø®Ù‡ Ø§ØµÙ„ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´Øª â•â•â• -->
  <div id="supply-sales-dashboard-section" class="supply-section">
    <div class="card">
      <div class="card-header">
        <div class="card-title">ğŸ¯ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ÙØ±ÙˆØ´ â€” Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø­ØµÙˆÙ„Ø§Øª</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
          <span id="sales-total-products" style="font-size:13px;color:var(--text-light);">0 Ù…Ø­ØµÙˆÙ„</span>
          <button class="btn btn-ghost btn-sm" onclick="selectAllProducts()">âœ… Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ù…Ù‡</button>
          <button class="btn btn-ghost btn-sm" onclick="deselectAllProducts()">âŒ Ù„ØºÙˆ Ù‡Ù…Ù‡</button>
          <button class="btn btn-primary btn-sm" onclick="refreshSalesDashboard()">ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
        </div>
      </div>
      <div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;">
        <div class="search-wrap" style="flex:1;min-width:200px;">
          <span class="icon">ğŸ”</span>
          <input class="search-input" id="sales-product-search" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ù…Ø­ØµÙˆÙ„..." oninput="filterSalesProducts()">
        </div>
        <select class="filter-select" id="sales-category-filter" onchange="filterSalesProducts()">
          <option value="">Ù‡Ù…Ù‡ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§</option>
        </select>
      </div>
      <div id="sales-product-categories"></div>
      <div id="sales-product-empty" class="empty" style="display:none;">
        <div class="empty-icon">ğŸ“¦</div>
        <div class="empty-text">Ù…Ø­ØµÙˆÙ„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>
      </div>
    </div>

    <div id="sales-selected-info" style="display:none;background:linear-gradient(135deg,#dbeafe,#eff6ff);border:2px solid #93c5fd;border-radius:12px;padding:14px 20px;margin-bottom:20px;align-items:center;gap:12px;flex-wrap:wrap;">
      <span style="font-weight:700;color:var(--primary);">ğŸ“Š <span id="sales-selected-count">0</span> Ù…Ø­ØµÙˆÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡</span>
      <span style="color:var(--text-light);font-size:13px;">Ø¬Ø¯Ø§ÙˆÙ„ Ù‚ÛŒÙ…Øª Ø¯Ø± Ø²ÛŒØ± Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯</span>
    </div>

    <div id="sales-price-tables"></div>

    <div id="sales-empty-state" class="empty" style="padding:60px 20px;">
      <div class="empty-icon">ğŸ¯</div>
      <div class="empty-text">Ù…Ø­ØµÙˆÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>
      <div class="empty-sub">Ø§Ø² Ù„ÛŒØ³Øª Ø¨Ø§Ù„Ø§ Ù…Ø­ØµÙˆÙ„Ø§Øª Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ØªØ§ Ø¬Ø¯Ø§ÙˆÙ„ Ù‚ÛŒÙ…Øª Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆÙ†Ø¯</div>
    </div>
  </div>

  <!-- PRICES -->
  <div id="supply-prices-section" class="supply-section active">
    <div class="card">
      <div class="card-header">
        <div class="card-title">â• Ø«Ø¨Øª / Ø¢Ù¾Ø¯ÛŒØª Ù‚ÛŒÙ…Øª Ø¬Ø¯ÛŒØ¯</div>
        <button class="btn btn-ghost btn-sm" onclick="toggleAddForm()"><span id="toggle-icon">â–²</span> Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† ÙØ±Ù…</button>
      </div>
      <div id="add-form-wrap">
        <div class="form-add-section">
          <div class="form-row">
            <div><div class="form-label">Ù†ÙˆØ¹ Ø¨Ø§Ø± *</div><select class="form-select" id="p-product"><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø­ØµÙˆÙ„...</option></select></div>
            <div><div class="form-label">Ø³Ø§ÛŒØ² *</div><input class="form-input" id="p-size" placeholder="Ù…Ø«Ø§Ù„: Û±Û´"></div>
            <div><div class="form-label">Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ *</div><select class="form-select" id="p-factory"><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø®Ø§Ù†Ù‡...</option></select></div>
            <div><div class="form-label">Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù† / Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…) *</div><input class="form-input" id="p-price" type="number" placeholder="Ù…Ø«Ø§Ù„: 45000"></div>
            <div><div class="form-label">ØªÙˆØ¶ÛŒØ­Ø§Øª</div><input class="form-input" id="p-note" placeholder="Ø§Ø®ØªÛŒØ§Ø±ÛŒ..."></div>
          </div>
          <div class="btn-group">
            <button class="btn btn-accent" onclick="addPrice()">âœ… Ø«Ø¨Øª Ù‚ÛŒÙ…Øª</button>
            <button class="btn btn-ghost" onclick="clearPriceForm()">ğŸ”„ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
          </div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <div class="card-title">ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§</div>
        <div style="font-size:12px;color:var(--text-light);">Ø¢Ù¾Ø¯ÛŒØª Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø§ ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª</div>
      </div>
      <div class="toolbar">
        <div class="search-wrap">
          <span class="icon">ğŸ”</span>
          <input class="search-input" id="price-search" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù…Ø­ØµÙˆÙ„ØŒ Ø³Ø§ÛŒØ²ØŒ Ú©Ø§Ø±Ø®Ø§Ù†Ù‡..." oninput="renderPriceTable()">
        </div>
        <select class="filter-select" id="filter-product" onchange="renderPriceTable()"><option value="">Ù‡Ù…Ù‡ Ù…Ø­ØµÙˆÙ„Ø§Øª</option></select>
        <select class="filter-select" id="filter-factory" onchange="renderPriceTable()"><option value="">Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø®Ø§Ù†Ø¬Ø§Øª</option></select>
        <button class="btn btn-ghost btn-sm" onclick="exportCSV()">ğŸ“¥ Ø®Ø±ÙˆØ¬ÛŒ CSV</button>
        <button class="btn btn-warning btn-sm" onclick="exportPricesJSON()">ğŸ“¥ JSON</button>
        <label class="io-label orange" style="padding:8px 14px;font-size:13px;">
          ğŸ“‚ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ JSON
          <input type="file" class="hidden-file" accept=".json" onchange="importPricesJSON(event)">
        </label>
      </div>
      <div class="table-wrap">
        <table class="data-table">
          <thead><tr><th>Ù†ÙˆØ¹ Ø¨Ø§Ø±</th><th>Ø³Ø§ÛŒØ²</th><th>Ú©Ø§Ø±Ø®Ø§Ù†Ù‡</th><th>Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†/Ú©ÛŒÙ„Ùˆ)</th><th>ØªØºÛŒÛŒØ±</th><th>Ø¢Ø®Ø±ÛŒÙ† Ø¢Ù¾Ø¯ÛŒØª</th><th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead>
          <tbody id="price-tbody"></tbody>
        </table>
      </div>
      <div id="price-empty" class="empty" style="display:none;">
        <div class="empty-icon">ğŸ’°</div><div class="empty-text">Ù‡Ù†ÙˆØ² Ù‚ÛŒÙ…ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>
        <div class="empty-sub">Ø§Ø² ÙØ±Ù… Ø¨Ø§Ù„Ø§ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
      </div>
    </div>
  </div>

  <!-- PRODUCTS -->
  <div id="supply-products-section" class="supply-section">
    <div class="card">
      <div class="card-header">
        <div class="card-title">ğŸ“¦ Ù„ÛŒØ³Øª Ù…Ø­ØµÙˆÙ„Ø§Øª</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
          <button class="btn btn-warning btn-sm" onclick="exportProductsJSON()">ğŸ“¥ JSON</button>
          <label class="io-label green" style="padding:8px 14px;font-size:13px;">
            ğŸ“‚ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ
            <input type="file" class="hidden-file" accept=".json" onchange="importProductsJSON(event)">
          </label>
          <button class="btn btn-accent" onclick="openProductModal()">â• Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØµÙˆÙ„</button>
        </div>
      </div>
      <div class="grid-cards" id="products-grid">
        <div class="empty"><div class="empty-icon">ğŸ“¦</div><div class="empty-text">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div></div>
      </div>
    </div>
  </div>

  <!-- FACTORIES -->
  <div id="supply-factories-section" class="supply-section">
    <div class="card">
      <div class="card-header">
        <div class="card-title">ğŸ­ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø®Ø§Ù†Ø¬Ø§Øª</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
          <button class="btn btn-warning btn-sm" onclick="exportFactoriesJSON()">ğŸ“¥ JSON</button>
          <label class="io-label green" style="padding:8px 14px;font-size:13px;">
            ğŸ“‚ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ
            <input type="file" class="hidden-file" accept=".json" onchange="importFactoriesJSON(event)">
          </label>
          <button class="btn btn-accent" onclick="openFactoryModal()">â• Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø®Ø§Ù†Ù‡</button>
        </div>
      </div>
      <div class="grid-cards" id="factories-grid">
        <div class="empty"><div class="empty-icon">ğŸ­</div><div class="empty-text">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div></div>
      </div>
    </div>
  </div>

  <!-- ANALYTICS -->
  <div id="supply-analytics-section" class="supply-section">
    <div class="card" style="padding:16px 22px;">
      <div style="display:flex;align-items:center;gap:14px;flex-wrap:wrap;">
        <div class="card-title" style="margin-bottom:0;font-size:15px;">ğŸ” ÙÛŒÙ„ØªØ± Ù†Ù…ÙˆØ¯Ø§Ø±</div>
        <select class="filter-select" id="chart-product-filter" onchange="renderAnalytics()"><option value="">Ù‡Ù…Ù‡ Ù…Ø­ØµÙˆÙ„Ø§Øª</option></select>
        <select class="filter-select" id="chart-factory-filter" onchange="renderAnalytics()"><option value="">Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø®Ø§Ù†Ø¬Ø§Øª</option></select>
        <div class="period-tabs">
          <button class="period-tab active" onclick="setPeriod(7,this)">Û· Ø±ÙˆØ²</button>
          <button class="period-tab" onclick="setPeriod(14,this)">Û±Û´ Ø±ÙˆØ²</button>
          <button class="period-tab" onclick="setPeriod(30,this)">Û³Û° Ø±ÙˆØ²</button>
        </div>
      </div>
    </div>
    <div class="chart-grid">
      <div class="chart-card" style="grid-column:1/-1;">
        <div class="chart-header"><div><div class="chart-title">ğŸ“ˆ Ø±ÙˆÙ†Ø¯ Ù‚ÛŒÙ…Øª Ù‡ÙØªÚ¯ÛŒ</div><div class="chart-subtitle" id="chart-range-label">Û· Ø±ÙˆØ² Ú¯Ø°Ø´ØªÙ‡</div></div></div>
        <canvas id="trendChart" height="90"></canvas>
      </div>
      <div class="chart-card">
        <div class="chart-header"><div><div class="chart-title">ğŸ¥§ ØªÙˆØ²ÛŒØ¹ Ø«Ø¨Øª Ù‚ÛŒÙ…Øª Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ù…Ø­ØµÙˆÙ„</div><div class="chart-subtitle">Ø¯Ø±ØµØ¯ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§</div></div></div>
        <canvas id="productPieChart" height="200"></canvas>
      </div>
      <div class="chart-card">
        <div class="chart-header"><div><div class="chart-title">ğŸ­ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù‚ÛŒÙ…Øª Ú©Ø§Ø±Ø®Ø§Ù†Ø¬Ø§Øª</div><div class="chart-subtitle">ØªÙˆÙ…Ø§Ù† / Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…</div></div></div>
        <canvas id="factoryBarChart" height="200"></canvas>
      </div>
      <div class="chart-card">
        <div class="chart-header"><div><div class="chart-title">ğŸ“… ÙØ±Ø§ÙˆØ§Ù†ÛŒ Ø¢Ù¾Ø¯ÛŒØª Ø±ÙˆØ²Ø§Ù†Ù‡</div><div class="chart-subtitle">ØªØ¹Ø¯Ø§Ø¯ Ø¢Ù¾Ø¯ÛŒØª Ø¯Ø± Ù‡Ø± Ø±ÙˆØ²</div></div></div>
        <canvas id="updateFreqChart" height="200"></canvas>
      </div>
      <div class="chart-card">
        <div class="chart-header"><div><div class="chart-title">ğŸ“Š Ø­Ø¯Ø§Ù‚Ù„ / Ø­Ø¯Ø§Ú©Ø«Ø± Ù‚ÛŒÙ…Øª</div><div class="chart-subtitle">Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ù…Ø­ØµÙˆÙ„</div></div></div>
        <div id="minmax-table-wrap"></div>
      </div>
    </div>
  </div>

</div><!-- /supply-app -->

<!-- SUPPLY MODALS -->
<div class="supply-modal" id="s-product-modal">
  <div class="supply-modal-box">
    <div class="modal-header">
      <div class="modal-title" id="product-modal-title">ğŸ“¦ Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØµÙˆÙ„</div>
      <button class="modal-close" onclick="closeSupplyModal('s-product-modal')">Ã—</button>
    </div>
    <div class="form-group" style="margin-bottom:16px;"><div class="form-label">Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„ *</div><input class="form-input" id="prod-name" placeholder="Ù…Ø«Ø§Ù„: Ù†Ø¨Ø´ÛŒØŒ Ù…ÛŒÙ„Ú¯Ø±Ø¯..."></div>
    <div class="form-group" style="margin-bottom:16px;"><div class="form-label">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ *</div><select class="form-select" id="prod-category"><option value="Ù…ÛŒÙ„Ú¯Ø±Ø¯">Ù…ÛŒÙ„Ú¯Ø±Ø¯</option><option value="ØªÛŒØ±Ø¢Ù‡Ù†">ØªÛŒØ±Ø¢Ù‡Ù†</option><option value="ÙˆØ±Ù‚">ÙˆØ±Ù‚</option><option value="Ù†Ø¨Ø´ÛŒ">Ù†Ø¨Ø´ÛŒ</option><option value="Ù„ÙˆÙ„Ù‡">Ù„ÙˆÙ„Ù‡</option><option value="Ù†Ø§ÙˆØ¯Ø§Ù†ÛŒ">Ù†Ø§ÙˆØ¯Ø§Ù†ÛŒ</option><option value="Ù¾Ø±ÙˆÙÛŒÙ„">Ù¾Ø±ÙˆÙÛŒÙ„</option><option value="Ù…ÙØªÙˆÙ„">Ù…ÙØªÙˆÙ„</option><option value="Ø³Ø§ÛŒØ±">Ø³Ø§ÛŒØ±</option></select></div>
    <div class="form-group" style="margin-bottom:16px;"><div class="form-label">Ø¢ÛŒÚ©ÙˆÙ†</div><input class="form-input" id="prod-icon" placeholder="ğŸ”©" maxlength="2"></div>
    <div class="form-group" style="margin-bottom:16px;"><div class="form-label">ÙˆØ§Ø­Ø¯ Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ</div><select class="form-select" id="prod-unit"><option value="Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…">Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…</option><option value="ØªÙ†">ØªÙ†</option><option value="Ø´Ø§Ø®Ù‡">Ø´Ø§Ø®Ù‡</option><option value="Ù…ØªØ±">Ù…ØªØ±</option></select></div>
    <div class="form-group" style="margin-bottom:22px;"><div class="form-label">ØªÙˆØ¶ÛŒØ­Ø§Øª</div><input class="form-input" id="prod-desc" placeholder="Ø§Ø®ØªÛŒØ§Ø±ÛŒ..."></div>
    <div class="btn-group">
      <button class="btn btn-accent" onclick="saveProduct()">âœ… Ø°Ø®ÛŒØ±Ù‡</button>
      <button class="btn btn-ghost" onclick="closeSupplyModal('s-product-modal')">Ø§Ù†ØµØ±Ø§Ù</button>
    </div>
  </div>
</div>

<div class="supply-modal" id="s-factory-modal">
  <div class="supply-modal-box">
    <div class="modal-header">
      <div class="modal-title" id="factory-modal-title">ğŸ­ Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø®Ø§Ù†Ù‡</div>
      <button class="modal-close" onclick="closeSupplyModal('s-factory-modal')">Ã—</button>
    </div>
    <div class="form-row">
      <div><div class="form-label">Ù†Ø§Ù… Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ *</div><input class="form-input" id="fac-name" placeholder="Ù…Ø«Ø§Ù„: Ø°ÙˆØ¨â€ŒØ¢Ù‡Ù† Ø§ØµÙÙ‡Ø§Ù†"></div>
      <div><div class="form-label">Ø´Ù‡Ø±</div><input class="form-input" id="fac-city" placeholder="Ù…Ø«Ø§Ù„: Ø§ØµÙÙ‡Ø§Ù†"></div>
    </div>
    <div class="form-group" style="margin-bottom:16px;"><div class="form-label">Ù…Ø­ØµÙˆÙ„Ø§Øª ØªÙˆÙ„ÛŒØ¯ÛŒ</div><input class="form-input" id="fac-products" placeholder="Ù…Ø«Ø§Ù„: Ù…ÛŒÙ„Ú¯Ø±Ø¯ØŒ ØªÛŒØ±Ø¢Ù‡Ù†"></div>
    <div class="form-row">
      <div><div class="form-label">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³</div><input class="form-input" id="fac-tel" placeholder="0311-..."></div>
      <div><div class="form-label">ÙˆØ¶Ø¹ÛŒØª</div><select class="form-select" id="fac-status"><option value="ÙØ¹Ø§Ù„">ÙØ¹Ø§Ù„</option><option value="ØºÛŒØ±ÙØ¹Ø§Ù„">ØºÛŒØ±ÙØ¹Ø§Ù„</option><option value="Ø¯Ø± Ø­Ø§Ù„ Ù…Ø°Ø§Ú©Ø±Ù‡">Ø¯Ø± Ø­Ø§Ù„ Ù…Ø°Ø§Ú©Ø±Ù‡</option></select></div>
    </div>
    <div class="form-group" style="margin:14px 0 22px;"><div class="form-label">ØªÙˆØ¶ÛŒØ­Ø§Øª</div><input class="form-input" id="fac-note" placeholder="Ø§Ø®ØªÛŒØ§Ø±ÛŒ..."></div>
    <div class="btn-group">
      <button class="btn btn-accent" onclick="saveFactory()">âœ… Ø°Ø®ÛŒØ±Ù‡</button>
      <button class="btn btn-ghost" onclick="closeSupplyModal('s-factory-modal')">Ø§Ù†ØµØ±Ø§Ù</button>
    </div>
  </div>
</div>

<div class="supply-modal" id="s-edit-price-modal">
  <div class="supply-modal-box">
    <div class="modal-header">
      <div class="modal-title">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ù‚ÛŒÙ…Øª</div>
      <button class="modal-close" onclick="closeSupplyModal('s-edit-price-modal')">Ã—</button>
    </div>
    <div class="form-row">
      <div><div class="form-label">Ù†ÙˆØ¹ Ø¨Ø§Ø± *</div><select class="form-select" id="ep-product"></select></div>
      <div><div class="form-label">Ø³Ø§ÛŒØ² *</div><input class="form-input" id="ep-size"></div>
    </div>
    <div class="form-row">
      <div><div class="form-label">Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ *</div><select class="form-select" id="ep-factory"></select></div>
      <div><div class="form-label">Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù† / Ú©ÛŒÙ„Ùˆ) *</div><input class="form-input" id="ep-price" type="number"></div>
    </div>
    <div class="form-group" style="margin-bottom:22px;"><div class="form-label">ØªÙˆØ¶ÛŒØ­Ø§Øª</div><input class="form-input" id="ep-note"></div>
    <div class="btn-group">
      <button class="btn btn-accent" onclick="saveEditedPrice()">âœ… Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
      <button class="btn btn-ghost" onclick="closeSupplyModal('s-edit-price-modal')">Ø§Ù†ØµØ±Ø§Ù</button>
    </div>
  </div>
</div>

</div><!-- /supply-module -->

<!-- TOAST -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODULE: LOADING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="module-panel" id="loading-module">
<div style="max-width:1600px;margin:0 auto;padding:20px;">

  <div class="header" style="margin-bottom:22px;">
    <div class="header-left">
      <h1>ğŸš› Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ</h1>
      <p>Ø­ÙˆØ§Ù„Ù‡â€ŒÙ‡Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ùˆ ÙØ±ÙˆØ´ â€” Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø´Ø¯Ù‡ â€” Ø¢Ø±Ø´ÛŒÙˆ</p>
    </div>
    <div class="header-right">
      <div class="live-badge"><div class="live-dot"></div>Real-time</div>
      <div class="master-clock" style="background:rgba(255,255,255,.15);padding:7px 14px;border-radius:20px;font-size:13px;color:white;" id="loading-clock">â€”</div>
    </div>
  </div>

  <div class="loading-tabs">
    <button class="loading-tab blue active" onclick="lTab('purchase',this)">ğŸ“¥ Ø­ÙˆØ§Ù„Ù‡ Ø®Ø±ÛŒØ¯ Ù…ÙˆØ§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡</button>
    <button class="loading-tab orange" onclick="lTab('sale',this)">ğŸ“¤ Ø­ÙˆØ§Ù„Ù‡ ÙØ±ÙˆØ´ Ù…ÙˆØ§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡</button>
    <button class="loading-tab green" onclick="lTab('loaded',this)">âœ… Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø´Ø¯Ù‡â€ŒÙ‡Ø§</button>
    <button class="loading-tab gray" onclick="lTab('archive',this)">ğŸ—„ï¸ Ø¢Ø±Ø´ÛŒÙˆ</button>
  </div>

  <!-- â”€â”€ TAB: PURCHASE â”€â”€ -->
  <div id="loading-purchase" class="loading-section active">
    <div class="card">
      <div class="lcard-header">
        <div class="lcard-title">ğŸ“¥ Ø­ÙˆØ§Ù„Ù‡ Ø®Ø±ÛŒØ¯ Ù…ÙˆØ§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡</div>
        <div class="lcard-actions">
          <span class="table-count" id="purchase-count">0 Ø±Ø¯ÛŒÙ</span>
          <button class="btn btn-primary btn-sm" onclick="lAddRow('purchase')">â• Ø±Ø¯ÛŒÙ Ø¬Ø¯ÛŒØ¯</button>
          <button class="btn btn-warning btn-sm" onclick="lExportExcel('purchase')">ğŸ“Š Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„</button>
          <button class="btn btn-warning btn-sm" onclick="lExportJSON('purchase')">ğŸ“¥ JSON</button>
          <label class="io-label green" style="padding:7px 12px;font-size:12px;">ğŸ“‚ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ<input type="file" class="hidden-file" accept=".json" onchange="lImportJSON(event,'purchase')"></label>
        </div>
      </div>
      <div class="ltable-wrap">
        <table class="ltable purchase">
          <thead>
            <tr>
              <th style="width:36px;">#</th>
              <th>Ø´Ù…Ø§Ø±Ù‡ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</th>
              <th>ÙØ±ÙˆØ´Ù†Ø¯Ù‡</th>
              <th>Ù…Ø­Ù„ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ</th>
              <th>Ù†ÙˆØ¹ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</th>
              <th>Ø´Ø±Ø­</th>
              <th>Ù†Ø­ÙˆÙ‡ ØªØ­ÙˆÛŒÙ„</th>
              <th>Ù†Ø­ÙˆÙ‡ ØªØ³ÙˆÛŒÙ‡</th>
              <th>Ù…Ù‚Ø¯Ø§Ø± KG</th>
              <th>Ù…Ø¨Ù„Øº ÙˆØ§Ø­Ø¯ Ø¨Ø§ Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ø±Ø²Ø´</th>
              <th class="col-date">ØªØ§Ø±ÛŒØ®</th>
              <th style="width:50px;">Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø´Ø¯</th>
              <th style="width:40px;">Ø­Ø°Ù</th>
            </tr>
          </thead>
          <tbody id="purchase-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- â”€â”€ TAB: SALE â”€â”€ -->
  <div id="loading-sale" class="loading-section">
    <div class="card">
      <div class="lcard-header">
        <div class="lcard-title">ğŸ“¤ Ø­ÙˆØ§Ù„Ù‡ ÙØ±ÙˆØ´ Ù…ÙˆØ§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡</div>
        <div class="lcard-actions">
          <span class="table-count" id="sale-count">0 Ø±Ø¯ÛŒÙ</span>
          <button class="btn btn-accent btn-sm" onclick="lAddRow('sale')">â• Ø±Ø¯ÛŒÙ Ø¬Ø¯ÛŒØ¯</button>
          <button class="btn btn-warning btn-sm" onclick="lExportExcel('sale')">ğŸ“Š Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„</button>
          <button class="btn btn-warning btn-sm" onclick="lExportJSON('sale')">ğŸ“¥ JSON</button>
          <label class="io-label green" style="padding:7px 12px;font-size:12px;">ğŸ“‚ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ<input type="file" class="hidden-file" accept=".json" onchange="lImportJSON(event,'sale')"></label>
        </div>
      </div>
      <div class="ltable-wrap">
        <table class="ltable orange">
          <thead>
            <tr>
              <th style="width:36px;">#</th>
              <th>Ø´Ù…Ø§Ø±Ù‡ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</th>
              <th>ÙØ±ÙˆØ´Ù†Ø¯Ù‡</th>
              <th>Ù…Ø­Ù„ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ</th>
              <th>Ù†ÙˆØ¹ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</th>
              <th>Ø´Ø±Ø­</th>
              <th>Ù†Ø­ÙˆÙ‡ ØªØ­ÙˆÛŒÙ„</th>
              <th>Ù†Ø­ÙˆÙ‡ ØªØ³ÙˆÛŒÙ‡</th>
              <th>Ù…Ù‚Ø¯Ø§Ø± KG</th>
              <th>Ù…Ø¨Ù„Øº ÙˆØ§Ø­Ø¯ Ø¨Ø§ Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ø±Ø²Ø´</th>
              <th class="col-date">ØªØ§Ø±ÛŒØ®</th>
              <th style="width:50px;">Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø´Ø¯</th>
              <th style="width:40px;">Ø­Ø°Ù</th>
            </tr>
          </thead>
          <tbody id="sale-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- â”€â”€ TAB: LOADED â”€â”€ -->
  <div id="loading-loaded" class="loading-section">
    <div class="card">
      <div class="lcard-header">
        <div class="lcard-title">âœ… Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø´Ø¯Ù‡â€ŒÙ‡Ø§</div>
        <div class="lcard-actions">
          <span class="table-count" id="loaded-count">0 Ø±Ø¯ÛŒÙ</span>
          <button class="btn btn-warning btn-sm" onclick="lExportExcel('loaded')">ğŸ“Š Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„</button>
          <button class="btn btn-warning btn-sm" onclick="lExportJSON('loaded')">ğŸ“¥ JSON</button>
        </div>
      </div>
      <div class="ltable-wrap">
        <table class="ltable green">
          <thead>
            <tr>
              <th style="width:36px;">#</th>
              <th>Ù†ÙˆØ¹</th>
              <th>Ø´Ù…Ø§Ø±Ù‡ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</th>
              <th>ÙØ±ÙˆØ´Ù†Ø¯Ù‡</th>
              <th>Ù…Ø­Ù„ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ</th>
              <th>Ø´Ø±Ø­</th>
              <th>Ù…Ù‚Ø¯Ø§Ø± KG</th>
              <th>Ù…Ø¨Ù„Øº ÙˆØ§Ø­Ø¯</th>
              <th>Ù†Ø§Ù… Ø±Ø§Ù†Ù†Ø¯Ù‡</th>
              <th>Ø´Ù…Ø§Ø±Ù‡ / Ù…Ø´Ø®ØµØ§Øª Ø±Ø§Ù†Ù†Ø¯Ù‡</th>
              <th>ØªØ§Ø±ÛŒØ® Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ</th>
              <th style="width:60px;">Ø¢Ø±Ø´ÛŒÙˆ</th>
            </tr>
          </thead>
          <tbody id="loaded-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- â”€â”€ TAB: ARCHIVE â”€â”€ -->
  <div id="loading-archive" class="loading-section">
    <div class="card">
      <div class="lcard-header">
        <div class="lcard-title">ğŸ—„ï¸ Ø¢Ø±Ø´ÛŒÙˆ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒâ€ŒÙ‡Ø§</div>
        <div class="lcard-actions">
          <span class="table-count" id="archive-count">0 Ø±Ø¯ÛŒÙ</span>
          <button class="btn btn-warning btn-sm" onclick="lExportExcel('archive')">ğŸ“Š Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„</button>
          <button class="btn btn-warning btn-sm" onclick="lExportJSON('archive')">ğŸ“¥ JSON</button>
        </div>
      </div>
      <div class="ltable-wrap">
        <table class="ltable gray">
          <thead>
            <tr>
              <th style="width:36px;">#</th>
              <th>Ù†ÙˆØ¹</th>
              <th>Ø´Ù…Ø§Ø±Ù‡ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</th>
              <th>ÙØ±ÙˆØ´Ù†Ø¯Ù‡</th>
              <th>Ù…Ø­Ù„ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ</th>
              <th>Ø´Ø±Ø­</th>
              <th>Ù…Ù‚Ø¯Ø§Ø± KG</th>
              <th>Ù…Ø¨Ù„Øº ÙˆØ§Ø­Ø¯</th>
              <th>Ù†Ø§Ù… Ø±Ø§Ù†Ù†Ø¯Ù‡</th>
              <th>Ø´Ù…Ø§Ø±Ù‡ / Ù…Ø´Ø®ØµØ§Øª Ø±Ø§Ù†Ù†Ø¯Ù‡</th>
              <th>ØªØ§Ø±ÛŒØ® Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ</th>
              <th>ØªØ§Ø±ÛŒØ® Ø¢Ø±Ø´ÛŒÙˆ</th>
            </tr>
          </thead>
          <tbody id="archive-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- â”€â”€ DRIVER MODAL â”€â”€ -->
<div id="driver-modal" style="display:none;">
  <div class="driver-modal-overlay" onclick="driverModalCancel()">
    <div class="driver-modal" onclick="event.stopPropagation()">
      <h3>ğŸš› Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø§Ù†Ù†Ø¯Ù‡</h3>
      <p id="driver-modal-subtitle">Ù‚Ø¨Ù„ Ø§Ø² Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø´Ø¯Ù‡â€ŒÙ‡Ø§ØŒ Ù…Ø´Ø®ØµØ§Øª Ø±Ø§Ù†Ù†Ø¯Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</p>
      <div class="dm-field">
        <label class="dm-label">ğŸ‘¤ Ù†Ø§Ù… Ø±Ø§Ù†Ù†Ø¯Ù‡</label>
        <input class="dm-input" id="dm-driver-name" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ">
      </div>
      <div class="dm-field">
        <label class="dm-label">ğŸ“‹ Ø´Ù…Ø§Ø±Ù‡ / Ù…Ø´Ø®ØµØ§Øª Ø±Ø§Ù†Ù†Ø¯Ù‡</label>
        <input class="dm-input" id="dm-driver-info" type="text" placeholder="Ù…Ø«Ø§Ù„: Ù¾Ù„Ø§Ú© 123 Ø§ÛŒØ±Ø§Ù† 45 â€” Ú©Ø§Ù…ÛŒÙˆÙ†">
      </div>
      <div class="dm-field">
        <label class="dm-label">ğŸ“… ØªØ§Ø±ÛŒØ® Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ</label>
        <input class="dm-input" id="dm-loaded-at" type="text" placeholder="Ù…Ø«Ø§Ù„: Û±Û´Û°Û´/Û±Û±/Û²Û¸">
      </div>
      <div class="dm-row">
        <button class="dm-confirm" onclick="driverModalConfirm()">âœ… ØªØ£ÛŒÛŒØ¯ Ùˆ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø´Ø¯Ù‡â€ŒÙ‡Ø§</button>
        <button class="dm-cancel" onclick="driverModalCancel()">Ø§Ù†ØµØ±Ø§Ù</button>
      </div>
    </div>
  </div>
</div>

</div><!-- /loading-module -->

<div class="s-toast" id="s-toast"></div>

<!-- MASTER SCRIPT -->
<script>
let activeModule = null;

function switchModule(mod) {
  document.querySelectorAll('.module-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.master-module-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(mod+'-module').classList.add('active');
  document.getElementById('btn-'+mod).classList.add('active');
  activeModule = mod;
  sessionStorage.setItem('activeModule', mod);
  if (mod === 'supply' && !window._supplyInited) {
    window._supplyInited = true;
    supplyInit();
  }
}

function masterClock() {
  const now = new Date();
  const str = now.toLocaleDateString('fa-IR') + '  ' + now.toLocaleTimeString('fa-IR');
  document.getElementById('master-clock').textContent = str;
  const sc = document.getElementById('supply-clock');
  if (sc) sc.textContent = str;
}
setInterval(masterClock, 1000);
masterClock();

function masterLogout() { if (typeof doLogout === 'function') doLogout(); }

function syncMasterNav() {
  const mgr = sessionStorage.getItem('currentManager');
  const ub = document.getElementById('master-user-badge');
  const lb = document.getElementById('master-logout-btn');
  const nav = document.getElementById('master-nav');
  if (mgr) {
    document.getElementById('master-user-name').textContent = mgr;
    ub.style.display = 'flex';
    lb.style.display = 'block';
    nav.classList.remove('login-mode');
  } else {
    ub.style.display = 'none';
    lb.style.display = 'none';
    nav.classList.add('login-mode');
  }
}
setInterval(syncMasterNav, 500);
syncMasterNav();

function masterInit() {
  const saved = sessionStorage.getItem('activeModule');
  const mgr = sessionStorage.getItem('currentManager');
  switchModule((mgr && saved) ? saved : 'eval');
  syncMasterNav();
}
</script>

<!-- EVAL SCRIPT -->
<script>
const firebaseConfig = {
  apiKey:"AIzaSyDeKK6THwUcR2hoh-VUiwAX7p79NL6UPQQ",
  authDomain:"employee-evaluation-adva-9231e.firebaseapp.com",
  projectId:"employee-evaluation-adva-9231e",
  storageBucket:"employee-evaluation-adva-9231e.firebasestorage.app",
  messagingSenderId:"151913486905",
  appId:"1:151913486905:web:b6c183ae02c67fd4368be8"
};

let database = null;
let isFirebaseConfigured = false;
try {
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  else firebase.app();
  database = firebase.database();
  isFirebaseConfigured = true;
} catch(e) { console.error('Firebase eval error:', e); }

let currentManager = null;

function doLogin() {
  const sel = document.getElementById('login-manager-select');
  const err = document.getElementById('login-error');
  if (!sel.value) { err.style.display='flex'; return; }
  err.style.display = 'none';
  currentManager = sel.value;
  sessionStorage.setItem('currentManager', currentManager);
  document.getElementById('login-overlay').style.display = 'none';
  document.getElementById('main-app').style.display = 'block';
  document.getElementById('current-manager-display').textContent = currentManager;
  document.getElementById('eval-manager-label').textContent = currentManager;
  sInitApp();
}

function doLogout() {
  if (!confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ø² Ø³ÛŒØ³ØªÙ… Ø®Ø§Ø±Ø¬ Ø´ÙˆÛŒØ¯ØŸ')) return;
  currentManager = null;
  sessionStorage.removeItem('currentManager');
  document.getElementById('main-app').style.display = 'none';
  document.getElementById('login-overlay').style.display = 'flex';
  document.getElementById('login-manager-select').value = '';
}

window.addEventListener('DOMContentLoaded', function() {
  const saved = sessionStorage.getItem('currentManager');
  if (saved) { document.getElementById('login-manager-select').value = saved; doLogin(); }
  const dateInput = document.getElementById('evaluation-date');
  if (dateInput) dateInput.valueAsDate = new Date();
  const monthSel = document.getElementById('star-month-selector');
  if (monthSel) {
    const now = new Date();
    monthSel.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  }
  masterInit();
});

const defaultDepartments = {
  'ÙØ±ÙˆØ´':{name:'ÙØ±ÙˆØ´',icon:'ğŸ’°',class:'dept-sales',criteria:[{id:1,name:'ØªØ­Ù‚Ù‚ Ø§Ù‡Ø¯Ø§Ù ÙØ±ÙˆØ´',weight:20},{id:2,name:'Ù…Ø°Ø§Ú©Ø±Ù‡ Ùˆ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù…Ø´ØªØ±ÛŒ',weight:15},{id:3,name:'Ø¬Ø°Ø¨ Ù…Ø´ØªØ±ÛŒØ§Ù† Ø¬Ø¯ÛŒØ¯',weight:15},{id:4,name:'Ø­ÙØ¸ Ùˆ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ù…Ø´ØªØ±ÛŒ',weight:12},{id:5,name:'Ú¯Ø²Ø§Ø±Ø´â€ŒØ¯Ù‡ÛŒ Ùˆ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ',weight:10},{id:6,name:'Ø¯Ø§Ù†Ø´ Ù…Ø­ØµÙˆÙ„',weight:10},{id:7,name:'Ú©Ø§Ø± ØªÛŒÙ…ÛŒ',weight:8},{id:8,name:'Ø±Ø¹Ø§ÛŒØª Ø§ØµÙˆÙ„ Ø§Ø®Ù„Ø§Ù‚ÛŒ',weight:10}]},
  'Ø¹Ù…Ù„ÛŒØ§Øª':{name:'Ø¹Ù…Ù„ÛŒØ§Øª',icon:'âš™ï¸',class:'dept-operations',criteria:[{id:1,name:'Ú©ÛŒÙÛŒØª Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡',weight:18},{id:2,name:'Ø±Ø¹Ø§ÛŒØª Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§',weight:15},{id:3,name:'Ù…Ø¯ÛŒØ±ÛŒØª Ø²Ù…Ø§Ù† Ùˆ Ø³Ø±Ø¹Øª',weight:13},{id:4,name:'Ø¨Ù‡Ø±Ù‡â€ŒÙˆØ±ÛŒ Ùˆ Ú©Ø§Ø±Ø§ÛŒÛŒ',weight:15},{id:5,name:'Ø§ÛŒÙ…Ù†ÛŒ Ùˆ Ø¨Ù‡Ø¯Ø§Ø´Øª',weight:12},{id:6,name:'Ø­Ù„ Ù…Ø³Ø§Ø¦Ù„ ÙÙ†ÛŒ',weight:10},{id:7,name:'Ù‡Ù…Ú©Ø§Ø±ÛŒ Ø¨Ø§ ØªÛŒÙ…',weight:9},{id:8,name:'Ù¾ÛŒØ´Ú¯ÛŒØ±ÛŒ Ø§Ø² Ø§ØªÙ„Ø§Ù Ù…Ù†Ø§Ø¨Ø¹',weight:8}]},
  'Ù…Ù†Ø§Ø¨Ø¹ Ø§Ù†Ø³Ø§Ù†ÛŒ':{name:'Ù…Ù†Ø§Ø¨Ø¹ Ø§Ù†Ø³Ø§Ù†ÛŒ',icon:'ğŸ‘¥',class:'dept-hr',criteria:[{id:1,name:'Ø¬Ø°Ø¨ Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¤Ø«Ø±',weight:15},{id:2,name:'Ù…Ø¯ÛŒØ±ÛŒØª Ø¹Ù…Ù„Ú©Ø±Ø¯ Ú©Ø§Ø±Ú©Ù†Ø§Ù†',weight:15},{id:3,name:'Ø¢Ù…ÙˆØ²Ø´ Ùˆ ØªÙˆØ³Ø¹Ù‡',weight:13},{id:4,name:'Ø§Ø±ØªØ¨Ø§Ø·Ø§Øª Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ',weight:12},{id:5,name:'Ø±Ø¹Ø§ÛŒØª Ù‚ÙˆØ§Ù†ÛŒÙ† Ú©Ø§Ø±',weight:12},{id:6,name:'Ø­Ù„ ØªØ¹Ø§Ø±Ø¶Ø§Øª',weight:11},{id:7,name:'Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ù†ÛŒØ±ÙˆÛŒ Ø§Ù†Ø³Ø§Ù†ÛŒ',weight:12},{id:8,name:'Ø±Ø¶Ø§ÛŒØª Ú©Ø§Ø±Ú©Ù†Ø§Ù†',weight:10}]},
  'Ù…Ø§Ù„ÛŒ':{name:'Ù…Ø§Ù„ÛŒ',icon:'ğŸ’µ',class:'dept-finance',criteria:[{id:1,name:'Ø¯Ù‚Øª Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ù…Ø§Ù„ÛŒ',weight:20},{id:2,name:'Ú¯Ø²Ø§Ø±Ø´â€ŒØ¯Ù‡ÛŒ Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹',weight:15},{id:3,name:'Ø±Ø¹Ø§ÛŒØª Ø§ØµÙˆÙ„ Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ',weight:15},{id:4,name:'Ú©Ù†ØªØ±Ù„ Ùˆ Ø¨ÙˆØ¯Ø¬Ù‡â€ŒØ¨Ù†Ø¯ÛŒ',weight:12},{id:5,name:'ØªØ­Ù„ÛŒÙ„ Ù…Ø§Ù„ÛŒ',weight:12},{id:6,name:'Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ù‚Ø¯ÛŒÙ†Ú¯ÛŒ',weight:10},{id:7,name:'Ø±Ø¹Ø§ÛŒØª Ù‚ÙˆØ§Ù†ÛŒÙ† Ù…Ø§Ù„ÛŒØ§ØªÛŒ',weight:8},{id:8,name:'Ù…Ø­Ø±Ù…Ø§Ù†Ú¯ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª',weight:8}]},
  'IT':{name:'IT',icon:'ğŸ’»',class:'dept-it',criteria:[{id:1,name:'Ø­Ù„ Ù…Ø³Ø§Ø¦Ù„ ÙÙ†ÛŒ',weight:18},{id:2,name:'Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§',weight:15},{id:3,name:'Ø§Ù…Ù†ÛŒØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª',weight:16},{id:4,name:'ØªÙˆØ³Ø¹Ù‡ Ùˆ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ',weight:13},{id:5,name:'Ù…Ø³ØªÙ†Ø¯Ø³Ø§Ø²ÛŒ',weight:10},{id:6,name:'Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†',weight:12},{id:7,name:'ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ ØªÚ©Ù†ÙˆÙ„ÙˆÚ˜ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯',weight:8},{id:8,name:'Ú©Ø§Ø± ØªÛŒÙ…ÛŒ Ø¯Ø± Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§',weight:8}]},
  'ØªÙˆÙ„ÛŒØ¯':{name:'ØªÙˆÙ„ÛŒØ¯',icon:'ğŸ­',class:'dept-production',criteria:[{id:1,name:'Ú©ÛŒÙÛŒØª Ù…Ø­ØµÙˆÙ„ ØªÙˆÙ„ÛŒØ¯ÛŒ',weight:20},{id:2,name:'Ø±Ø¹Ø§ÛŒØª Ø¨Ø±Ù†Ø§Ù…Ù‡ ØªÙˆÙ„ÛŒØ¯',weight:15},{id:3,name:'Ø¨Ù‡Ø±Ù‡â€ŒÙˆØ±ÛŒ Ø®Ø· ØªÙˆÙ„ÛŒØ¯',weight:15},{id:4,name:'Ú©Ø§Ù‡Ø´ Ø¶Ø§ÛŒØ¹Ø§Øª',weight:12},{id:5,name:'Ø§ÛŒÙ…Ù†ÛŒ Ùˆ Ø¨Ù‡Ø¯Ø§Ø´Øª Ú©Ø§Ø±',weight:12},{id:6,name:'Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ ØªØ¬Ù‡ÛŒØ²Ø§Øª',weight:10},{id:7,name:'Ù‡Ù…Ú©Ø§Ø±ÛŒ Ø¨Ø§ ØªÛŒÙ… ØªÙˆÙ„ÛŒØ¯',weight:8},{id:8,name:'Ø¨Ù‡Ø¨ÙˆØ¯ Ù…Ø³ØªÙ…Ø± ÙØ±Ø¢ÛŒÙ†Ø¯',weight:8}]}
};

let departments={}, evaluations=[], employees=[], currentDepartment=null, currentEditingDepartment=null, currentEditingEmployee=null;

function sInitApp() {
  const statusDot = document.getElementById('status-dot');
  const statusText = document.getElementById('status-text');
  if (isFirebaseConfigured) {
    statusDot.style.background='#10b981';
    statusDot.style.animation='pulse 2s infinite';
    statusText.textContent='Ù…ØªØµÙ„ Ø¨Ù‡ Firebase';
    database.ref('.info/connected').on('value',snap=>{
      statusDot.style.background = snap.val()?'#10b981':'#ef4444';
      statusText.textContent = snap.val()?'Ù…ØªØµÙ„ Ø¨Ù‡ Firebase':'Ù‚Ø·Ø¹ Ø´Ø¯Ù‡';
    });
  } else {
    statusDot.style.background='#f59e0b';
    statusText.textContent='Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ†';
  }
  loadDepartments(); loadEvaluations(); loadEmployees();
  document.getElementById('evaluation-date').valueAsDate = new Date();
}

function loadDepartments() {
  if (isFirebaseConfigured) {
    database.ref('departments').on('value',snap=>{
      departments = snap.exists() ? snap.val() : JSON.parse(JSON.stringify(defaultDepartments));
      if (!snap.exists()) database.ref('departments').set(departments);
      populateDepartmentDropdown(); populateNewEmployeeDepartment(); updateDepartmentsView();
    });
  } else {
    departments = JSON.parse(localStorage.getItem('departments'))||JSON.parse(JSON.stringify(defaultDepartments));
    populateDepartmentDropdown(); populateNewEmployeeDepartment(); updateDepartmentsView();
  }
}

function populateDepartmentDropdown() {
  const sel = document.getElementById('employee-department');
  sel.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>';
  Object.keys(departments).forEach(k=>{
    const d=departments[k];
    sel.insertAdjacentHTML('beforeend',`<option value="${k}">${d.icon} ${d.name}</option>`);
  });
}

function populateNewEmployeeDepartment() {
  ['new-emp-department','edit-emp-department'].forEach(id=>{
    const sel=document.getElementById(id);
    if (!sel) return;
    const cur=sel.value;
    sel.innerHTML='<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>';
    Object.keys(departments).forEach(k=>{
      const d=departments[k];
      sel.insertAdjacentHTML('beforeend',`<option value="${k}"${k===cur?' selected':''}>${d.icon} ${d.name}</option>`);
    });
  });
}

function loadEvaluations() {
  if (isFirebaseConfigured) {
    database.ref('evaluations').on('value',snap=>{
      evaluations = snap.exists()?Object.values(snap.val()):[];
      onEvaluationsUpdated();
    });
  } else {
    evaluations = JSON.parse(localStorage.getItem('sharedEvaluations'))||[];
    onEvaluationsUpdated();
  }
}

function onEvaluationsUpdated() {
  const activeSection = document.querySelector('#eval-module .section.active');
  if (!activeSection) return;
  const id = activeSection.id;
  if (id==='my-history-section') renderMyHistory();
  if (id==='shared-dashboard-section') renderSharedDashboard();
  if (id==='star-employees-section') updateStarEmployees();
}

function loadEmployees() {
  if (isFirebaseConfigured) {
    database.ref('employees').on('value',snap=>{
      employees = snap.exists()?Object.values(snap.val()):[];
      updateEmployeesManagementList();
    });
  } else {
    employees = JSON.parse(localStorage.getItem('employees'))||[];
    updateEmployeesManagementList();
  }
}

function populateEmployeeDropdown(filterDept=null) {
  const sel=document.getElementById('employee-name');
  let list = filterDept?employees.filter(e=>e.department===filterDept):employees;
  list = [...list].sort((a,b)=>a.name.localeCompare(b.name,'fa'));
  sel.innerHTML='<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>';
  list.forEach(emp=>sel.insertAdjacentHTML('beforeend',`<option value="${emp.name}">${emp.name}</option>`));
  if (list.length===0) sel.innerHTML='<option value="">Ú©Ø§Ø±Ù…Ù†Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</option>';
}

function handleDepartmentChange() {
  const deptKey=document.getElementById('employee-department').value;
  populateEmployeeDropdown(deptKey||null);
  loadDepartmentCriteria();
}

function loadDepartmentCriteria() {
  const deptKey=document.getElementById('employee-department').value;
  if (!deptKey){
    document.getElementById('evaluation-criteria').innerHTML='';
    document.getElementById('department-badge-container').innerHTML='';
    document.getElementById('total-score-container').style.display='none';
    currentDepartment=null; return;
  }
  currentDepartment=departments[deptKey];
  document.getElementById('department-badge-container').innerHTML=
    `<div class="department-badge ${currentDepartment.class}">${currentDepartment.icon} Ø¨Ø®Ø´ ${currentDepartment.name}</div>`;
  const container=document.getElementById('evaluation-criteria');
  container.innerHTML='';
  currentDepartment.criteria.forEach(c=>{
    container.insertAdjacentHTML('beforeend',`
      <div class="eval-section">
        <div class="eval-section-header">
          <div class="eval-section-title">${c.name}</div>
          <div class="eval-weight">Ø¶Ø±ÛŒØ¨: ${c.weight}</div>
        </div>
        <div class="score-slider-container">
          <input type="range" min="1" max="10" value="5" class="score-slider" id="slider-${c.id}" oninput="updateScore(${c.id},${c.weight})">
          <div class="score-display" id="display-${c.id}">5</div>
        </div>
        <div class="weighted-score" id="weighted-${c.id}">Ø§Ù…ØªÛŒØ§Ø² ÙˆØ²Ù†ÛŒ: ${5*c.weight}</div>
      </div>`);
  });
  document.getElementById('total-score-container').style.display='block';
  calculateTotalScore();
}

function updateScore(id,weight){
  const val=parseInt(document.getElementById(`slider-${id}`).value);
  document.getElementById(`display-${id}`).textContent=val;
  document.getElementById(`weighted-${id}`).textContent=`Ø§Ù…ØªÛŒØ§Ø² ÙˆØ²Ù†ÛŒ: ${val*weight}`;
  calculateTotalScore();
}

function calculateTotalScore(){
  if (!currentDepartment) return;
  let total=0,maxScore=0;
  currentDepartment.criteria.forEach(c=>{
    const sl=document.getElementById(`slider-${c.id}`);
    if (sl) total+=parseInt(sl.value)*c.weight;
    maxScore+=10*c.weight;
  });
  document.getElementById('total-score').textContent=total;
  document.getElementById('max-score').textContent=maxScore;
}

function saveEvaluation(){
  const employeeName=document.getElementById('employee-name').value;
  const deptKey=document.getElementById('employee-department').value;
  const date=document.getElementById('evaluation-date').value;
  if (!employeeName||!deptKey||!date){alert('âš ï¸ Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯!');return;}
  if (!currentDepartment){alert('âš ï¸ Ø§Ø¨ØªØ¯Ø§ Ø¨Ø®Ø´ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯!');return;}
  const scores={};
  currentDepartment.criteria.forEach(c=>{
    const sl=document.getElementById(`slider-${c.id}`);
    if (sl) scores[c.id]=parseInt(sl.value);
  });
  const evaluation={
    id:Date.now(),managerName:currentManager,employeeName,department:deptKey,
    departmentName:currentDepartment.name,date,scores,
    totalScore:parseInt(document.getElementById('total-score').textContent),
    maxScore:parseInt(document.getElementById('max-score').textContent),
    timestamp:new Date().toISOString(),
    criteriaSnapshot:JSON.parse(JSON.stringify(currentDepartment.criteria))
  };
  if (isFirebaseConfigured){
    database.ref('evaluations/'+evaluation.id).set(evaluation)
      .then(()=>{alert('âœ… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!');resetForm();})
      .catch(e=>alert('âŒ Ø®Ø·Ø§: '+e.message));
  } else {
    evaluations.push(evaluation);
    localStorage.setItem('sharedEvaluations',JSON.stringify(evaluations));
    alert('âœ… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!');resetForm();onEvaluationsUpdated();
  }
}

function resetForm(){
  document.getElementById('employee-name').value='';
  document.getElementById('employee-department').value='';
  document.getElementById('evaluation-date').valueAsDate=new Date();
  document.getElementById('evaluation-criteria').innerHTML='';
  document.getElementById('department-badge-container').innerHTML='';
  document.getElementById('total-score-container').style.display='none';
  currentDepartment=null;
}

function renderMyHistory(){
  const tbody=document.getElementById('my-history-tbody');
  const myEvals=evaluations.filter(e=>e.managerName===currentManager);
  document.getElementById('my-history-info').innerHTML=
    `ğŸ“Œ ÙÙ‚Ø· Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡ ØªÙˆØ³Ø· <strong>${currentManager}</strong> â€” ØªØ¹Ø¯Ø§Ø¯: <strong>${myEvals.length}</strong> Ù…ÙˆØ±Ø¯`;
  if (myEvals.length===0){
    tbody.innerHTML=`<tr><td colspan="6" style="text-align:center;padding:40px;"><div class="empty-state-icon">ğŸ“­</div><p>Ø´Ù…Ø§ Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯</p></td></tr>`;
    return;
  }
  const sorted=[...myEvals].sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));
  tbody.innerHTML=sorted.map(ev=>{
    const pct=(ev.totalScore/ev.maxScore*100).toFixed(0);
    const cls=pct>=70?'badge-high':pct>=50?'badge-medium':'badge-low';
    const rank=pct>=70?'Ø¹Ø§Ù„ÛŒ':pct>=50?'Ø®ÙˆØ¨':'Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ù‡Ø¨ÙˆØ¯';
    return `<tr>
      <td>${new Date(ev.date).toLocaleDateString('fa-IR')}</td>
      <td><strong>${ev.employeeName}</strong></td>
      <td>${ev.departmentName}</td>
      <td><strong>${ev.totalScore}</strong> / ${ev.maxScore}</td>
      <td><span class="badge ${cls}">${rank} (${pct}%)</span></td>
      <td><button class="btn btn-danger btn-sm" onclick="deleteEvaluation(${ev.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button></td>
    </tr>`;
  }).join('');
}

function deleteEvaluation(evalId){
  const ev=evaluations.find(e=>e.id===evalId);
  if (!ev) return;
  if (ev.managerName!==currentManager){alert('â›” Ø´Ù…Ø§ Ù…Ø¬Ø§Ø² Ø¨Ù‡ Ø­Ø°Ù Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ Ø³Ø§ÛŒØ± Ù…Ø¯ÛŒØ±Ø§Ù† Ù†ÛŒØ³ØªÛŒØ¯!');return;}
  if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return;
  if (isFirebaseConfigured){
    database.ref('evaluations/'+evalId).remove().then(()=>alert('âœ… Ø­Ø°Ù Ø´Ø¯!')).catch(e=>alert('âŒ Ø®Ø·Ø§: '+e.message));
  } else {
    evaluations=evaluations.filter(e=>e.id!==evalId);
    localStorage.setItem('sharedEvaluations',JSON.stringify(evaluations));
    alert('âœ… Ø­Ø°Ù Ø´Ø¯!');onEvaluationsUpdated();
  }
}

function exportMyEvaluations(){
  const myEvals=evaluations.filter(e=>e.managerName===currentManager);
  if (myEvals.length===0){alert('âš ï¸ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!');return;}
  const data=JSON.stringify({manager:currentManager,evaluations:myEvals,exportDate:new Date().toISOString()},null,2);
  const blob=new Blob([data],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download=`backup-${currentManager}-${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
  alert('âœ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!');
}

function renderSharedDashboard(){
  const totalEvals=evaluations.length;
  const uniqueEmployees=new Set(evaluations.map(e=>e.employeeName)).size;
  const uniqueManagers=new Set(evaluations.map(e=>e.managerName)).size;
  const avgScore=totalEvals>0?(evaluations.reduce((s,e)=>s+(e.totalScore/e.maxScore*100),0)/totalEvals).toFixed(1):0;
  document.getElementById('summary-stats').innerHTML=`
    <div class="stat-card-eval blue"><div class="stat-number">${totalEvals}</div><div class="stat-label">Ú©Ù„ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§</div></div>
    <div class="stat-card-eval green"><div class="stat-number">${uniqueEmployees}</div><div class="stat-label">Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù† Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒØ´Ø¯Ù‡</div></div>
    <div class="stat-card-eval orange"><div class="stat-number">${uniqueManagers}</div><div class="stat-label">Ù…Ø¯ÛŒØ±Ø§Ù† Ø§Ø±Ø²ÛŒØ§Ø¨</div></div>
    <div class="stat-card-eval purple"><div class="stat-number">${avgScore}%</div><div class="stat-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ú©Ù„ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª</div></div>`;
  const empMap={};
  evaluations.forEach(ev=>{
    if (!empMap[ev.employeeName]) empMap[ev.employeeName]={name:ev.employeeName,dept:ev.departmentName,totalScore:0,totalMax:0,count:0};
    empMap[ev.employeeName].totalScore+=ev.totalScore;
    empMap[ev.employeeName].totalMax+=ev.maxScore;
    empMap[ev.employeeName].count+=1;
  });
  const ranked=Object.values(empMap).map(e=>({...e,avgPct:e.totalMax>0?(e.totalScore/e.totalMax*100):0})).sort((a,b)=>b.avgPct-a.avgPct);
  const tbody=document.getElementById('global-ranking-tbody');
  if (ranked.length===0){
    tbody.innerHTML=`<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-light);">Ù‡Ù†ÙˆØ² Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td></tr>`;
  } else {
    tbody.innerHTML=ranked.map((emp,i)=>{
      const rank=i+1;const pct=emp.avgPct.toFixed(1);
      const color=emp.avgPct>=70?'#059669':emp.avgPct>=50?'#d97706':'#dc2626';
      const medal=rank===1?'ğŸ¥‡':rank===2?'ğŸ¥ˆ':rank===3?'ğŸ¥‰':rank;
      return `<tr class="${rank<=3?'rank-'+rank:''}">
        <td style="font-size:20px;text-align:center;">${medal}</td>
        <td><strong>${emp.name}</strong></td><td>${emp.dept}</td>
        <td style="text-align:center;">${emp.count}</td>
        <td style="text-align:center;font-weight:700;">${emp.totalScore.toLocaleString()}</td>
        <td style="text-align:center;font-weight:800;color:${color};">${pct}%</td>
        <td><div class="progress-bar-wrap"><div class="progress-bar-fill" style="width:${pct}%;background:${color};"></div></div></td>
      </tr>`;
    }).join('');
  }
  const ctx1=document.getElementById('sharedEmployeesChart');
  if (window._empChart) window._empChart.destroy();
  const top10=ranked.slice(0,10);
  window._empChart=new Chart(ctx1,{type:'bar',data:{labels:top10.map(e=>e.name),datasets:[{label:'Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø² (%)',data:top10.map(e=>e.avgPct.toFixed(1)),backgroundColor:top10.map((_,i)=>i===0?'rgba(251,191,36,.85)':i===1?'rgba(156,163,175,.85)':i===2?'rgba(249,115,22,.85)':'rgba(30,64,175,.75)'),borderRadius:6}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{min:0,max:100}}}});
  const deptMap={};
  evaluations.forEach(ev=>{deptMap[ev.departmentName]=(deptMap[ev.departmentName]||0)+1;});
  const ctx2=document.getElementById('sharedDepartmentsChart');
  if (window._deptChart) window._deptChart.destroy();
  window._deptChart=new Chart(ctx2,{type:'pie',data:{labels:Object.keys(deptMap),datasets:[{data:Object.values(deptMap),backgroundColor:['rgba(5,150,105,.8)','rgba(8,145,178,.8)','rgba(124,58,237,.8)','rgba(217,119,6,.8)','rgba(220,38,38,.8)','rgba(30,64,175,.8)']}]},options:{responsive:true}});
}

function updateStarEmployees(){
  const container=document.getElementById('star-employees-grid');
  const selMonth=document.getElementById('star-month-selector').value;
  const topCount=parseInt(document.getElementById('star-count-selector').value);
  if (!selMonth){container.innerHTML='<p style="text-align:center;color:var(--text-light);">Ù„Ø·ÙØ§Ù‹ Ù…Ø§Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p>';return;}
  const [year,month]=selMonth.split('-');
  const monthEvals=evaluations.filter(ev=>{const d=new Date(ev.date);return d.getFullYear()==year&&(d.getMonth()+1)==parseInt(month);});
  if (monthEvals.length===0){
    container.innerHTML=`<div class="empty-state" style="grid-column:1/-1;"><div class="empty-state-icon">ğŸ“­</div><h3>Ù‡ÛŒÚ† Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ù…Ø§Ù‡ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</h3></div>`;
    return;
  }
  const empMap={};
  monthEvals.forEach(ev=>{
    if (!empMap[ev.employeeName]) empMap[ev.employeeName]={name:ev.employeeName,dept:ev.departmentName,sum:0,count:0};
    empMap[ev.employeeName].sum+=(ev.totalScore/ev.maxScore*100);
    empMap[ev.employeeName].count+=1;
  });
  const ranked=Object.values(empMap).map(e=>({...e,avg:e.sum/e.count})).sort((a,b)=>b.avg-a.avg).slice(0,topCount);
  container.innerHTML=ranked.map((emp,i)=>{
    const rank=i+1;
    const empData=employees.find(e=>e.name===emp.name);
    const photo=empData&&empData.photo?empData.photo:null;
    return `<div class="star-employee-card rank-${rank<=3?rank:''}">
      <div class="star-rank-badge rank-${rank<=3?rank:''}">${rank}</div>
      <div class="star-employee-photo">${photo?`<img src="${photo}" alt="${emp.name}" onerror="this.parentElement.innerHTML='ğŸ‘¤'">`:' ğŸ‘¤'}</div>
      <div class="star-employee-name">${emp.name}</div>
      <div class="star-employee-dept">${emp.dept}</div>
      <div class="star-employee-score"><span class="star-score-value">${emp.avg.toFixed(1)}%</span><span class="star-score-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø² (${emp.count} Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ)</span></div>
    </div>`;
  }).join('');
}

function switchTab(tab,el){
  document.querySelectorAll('#eval-module .section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById(`${tab}-section`).classList.add('active');
  if (el) el.classList.add('active');
  if (tab==='my-history') renderMyHistory();
  if (tab==='shared-dashboard') renderSharedDashboard();
  if (tab==='star-employees') updateStarEmployees();
  if (tab==='manage-employees') updateEmployeesManagementList();
  if (tab==='departments') updateDepartmentsView();
}

function addNewEmployee(){
  const name=document.getElementById('new-emp-name').value.trim();
  const dept=document.getElementById('new-emp-department').value;
  const pos=document.getElementById('new-emp-position').value.trim();
  const code=document.getElementById('new-emp-code').value.trim();
  const photo=document.getElementById('new-emp-photo').value.trim();
  if (!name||!dept){alert('âš ï¸ Ù†Ø§Ù… Ùˆ Ø¨Ø®Ø´ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª!');return;}
  if (employees.some(e=>e.name.toLowerCase()===name.toLowerCase())){alert('âš ï¸ Ú©Ø§Ø±Ù…Ù†Ø¯ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ù†Ø§Ù… Ù‚Ø¨Ù„Ø§Ù‹ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯!');return;}
  const emp={id:Date.now(),name,department:dept,departmentName:departments[dept].name,position:pos,code,photo,createdAt:new Date().toISOString()};
  if (isFirebaseConfigured){
    database.ref('employees/'+emp.id).set(emp).then(()=>{alert('âœ… Ú©Ø§Ø±Ù…Ù†Ø¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯!');clearEmployeeForm();}).catch(e=>alert('âŒ Ø®Ø·Ø§: '+e.message));
  } else {
    employees.push(emp);localStorage.setItem('employees',JSON.stringify(employees));alert('âœ… Ú©Ø§Ø±Ù…Ù†Ø¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯!');clearEmployeeForm();updateEmployeesManagementList();
  }
}

function clearEmployeeForm(){
  ['new-emp-name','new-emp-position','new-emp-code','new-emp-photo'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('new-emp-department').value='';
}

function updateEmployeesManagementList(){
  const container=document.getElementById('employees-management-list');
  if (!container) return;
  if (employees.length===0){
    container.innerHTML=`<div class="empty-state"><div class="empty-state-icon">ğŸ‘¤</div><h3>Ù‡Ù†ÙˆØ² Ú©Ø§Ø±Ù…Ù†Ø¯ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡</h3></div>`;return;
  }
  const sorted=[...employees].sort((a,b)=>a.name.localeCompare(b.name,'fa'));
  container.innerHTML=sorted.map(emp=>{
    const dept=departments[emp.department];
    return `<div class="employee-mgmt-card">
      <div>
        <div style="font-weight:700;font-size:15px;margin-bottom:4px;">${emp.name}</div>
        <div style="font-size:13px;color:var(--text-light);">${dept?dept.icon+' '+dept.name:emp.departmentName}${emp.position?' â€¢ '+emp.position:''}${emp.code?' â€¢ Ú©Ø¯: '+emp.code:''}</div>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-primary btn-sm" onclick="editEmployee(${emp.id})">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</button>
        <button class="btn btn-danger btn-sm" onclick="deleteEmployee(${emp.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      </div>
    </div>`;
  }).join('');
}

function editEmployee(empId){
  const emp=employees.find(e=>e.id===empId);if (!emp) return;
  currentEditingEmployee=empId;
  document.getElementById('edit-emp-name').value=emp.name;
  document.getElementById('edit-emp-position').value=emp.position||'';
  document.getElementById('edit-emp-code').value=emp.code||'';
  document.getElementById('edit-emp-photo').value=emp.photo||'';
  populateNewEmployeeDepartment();
  document.getElementById('edit-emp-department').value=emp.department;
  document.getElementById('edit-employee-modal').classList.add('active');
}

function closeEditEmployeeModal(){document.getElementById('edit-employee-modal').classList.remove('active');currentEditingEmployee=null;}

function saveEditedEmployee(){
  if (!currentEditingEmployee) return;
  const emp=employees.find(e=>e.id===currentEditingEmployee);if (!emp) return;
  const newName=document.getElementById('edit-emp-name').value.trim();
  const newDept=document.getElementById('edit-emp-department').value;
  if (!newName||!newDept){alert('âš ï¸ Ù†Ø§Ù… Ùˆ Ø¨Ø®Ø´ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª!');return;}
  if (newName!==emp.name&&employees.some(e=>e.id!==currentEditingEmployee&&e.name.toLowerCase()===newName.toLowerCase())){alert('âš ï¸ Ø§ÛŒÙ† Ù†Ø§Ù… Ù‚Ø¨Ù„Ø§Ù‹ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯!');return;}
  emp.name=newName;emp.department=newDept;emp.departmentName=departments[newDept].name;
  emp.position=document.getElementById('edit-emp-position').value.trim();
  emp.code=document.getElementById('edit-emp-code').value.trim();
  emp.photo=document.getElementById('edit-emp-photo').value.trim();
  if (isFirebaseConfigured){
    database.ref('employees/'+currentEditingEmployee).set(emp).then(()=>{alert('âœ… ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯!');closeEditEmployeeModal();}).catch(e=>alert('âŒ Ø®Ø·Ø§: '+e.message));
  } else {
    localStorage.setItem('employees',JSON.stringify(employees));alert('âœ… ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯!');closeEditEmployeeModal();updateEmployeesManagementList();
  }
}

function deleteEmployee(empId){
  const emp=employees.find(e=>e.id===empId);if (!emp) return;
  if (!confirm(`Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù "${emp.name}" Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ`)) return;
  if (isFirebaseConfigured){
    database.ref('employees/'+empId).remove().then(()=>alert('âœ… Ø­Ø°Ù Ø´Ø¯!')).catch(e=>alert('âŒ Ø®Ø·Ø§: '+e.message));
  } else {
    employees=employees.filter(e=>e.id!==empId);localStorage.setItem('employees',JSON.stringify(employees));alert('âœ… Ø­Ø°Ù Ø´Ø¯!');updateEmployeesManagementList();
  }
}

function updateDepartmentsView(){
  const container=document.getElementById('departments-grid');if (!container) return;
  container.innerHTML='';
  Object.keys(departments).forEach(k=>{
    const d=departments[k];
    container.insertAdjacentHTML('beforeend',`
      <div class="department-card" onclick="openCriteriaModal('${k}')">
        <div class="department-header">
          <div class="department-badge ${d.class}">${d.icon} ${d.name}</div>
          <div class="criteria-count">${d.criteria.length} Ù…Ø¹ÛŒØ§Ø±</div>
        </div>
        <p style="color:var(--text-light);margin-top:10px;font-size:13px;">Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§</p>
      </div>`);
  });
}

function openCriteriaModal(deptKey){
  currentEditingDepartment=deptKey;const d=departments[deptKey];
  document.getElementById('modal-department-name-input').value=d.name;
  document.getElementById('modal-department-icon-input').value=d.icon;
  document.getElementById('modal-department-badge').innerHTML=`<div class="department-badge ${d.class}" style="margin-bottom:18px;">${d.icon} ${d.name}</div>`;
  const list=document.getElementById('modal-criteria-list');list.innerHTML='';
  d.criteria.forEach(c=>{
    list.insertAdjacentHTML('beforeend',`
      <div class="criteria-item">
        <input type="text" class="criteria-name-input" value="${c.name}" id="modal-criteria-name-${c.id}">
        <input type="number" class="criteria-weight-input" value="${c.weight}" id="modal-criteria-weight-${c.id}" min="1" max="30">
        <button class="btn btn-danger btn-sm" onclick="deleteModalCriteria(${c.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      </div>`);
  });
  document.getElementById('criteria-modal').classList.add('active');
}

function closeCriteriaModal(){document.getElementById('criteria-modal').classList.remove('active');currentEditingDepartment=null;}

function saveDepartmentCriteria(){
  const oldKey=currentEditingDepartment;const d=departments[oldKey];
  const newName=document.getElementById('modal-department-name-input').value.trim();
  const newIcon=document.getElementById('modal-department-icon-input').value.trim();
  if (!newName||!newIcon){alert('âš ï¸ Ù†Ø§Ù… Ùˆ Ø¢ÛŒÚ©ÙˆÙ† Ø§Ù„Ø²Ø§Ù…ÛŒ!');return;}
  const criteria=[];
  d.criteria.forEach(c=>{
    const nm=document.getElementById(`modal-criteria-name-${c.id}`);
    const wt=document.getElementById(`modal-criteria-weight-${c.id}`);
    if (nm&&wt) criteria.push({id:c.id,name:nm.value,weight:parseInt(wt.value)});
  });
  if (newName!==oldKey){departments[newName]={name:newName,icon:newIcon,class:d.class,criteria};delete departments[oldKey];}
  else departments[oldKey]={...d,name:newName,icon:newIcon,criteria};
  const save=()=>{
    if (isFirebaseConfigured){
      database.ref('departments').set(departments).then(()=>{alert('âœ… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!');closeCriteriaModal();updateDepartmentsView();populateDepartmentDropdown();populateNewEmployeeDepartment();}).catch(e=>alert('âŒ Ø®Ø·Ø§: '+e.message));
    } else {
      localStorage.setItem('departments',JSON.stringify(departments));alert('âœ… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!');closeCriteriaModal();updateDepartmentsView();populateDepartmentDropdown();populateNewEmployeeDepartment();
    }
  };save();
}

function addNewCriteriaToModal(){
  const d=departments[currentEditingDepartment];
  const newId=Math.max(...d.criteria.map(c=>c.id),0)+1;
  d.criteria.push({id:newId,name:'Ù…Ø¹ÛŒØ§Ø± Ø¬Ø¯ÛŒØ¯',weight:10});
  openCriteriaModal(currentEditingDepartment);
}

function deleteModalCriteria(id){
  if (!confirm('Ø­Ø°Ù Ø§ÛŒÙ† Ù…Ø¹ÛŒØ§Ø±ØŸ')) return;
  departments[currentEditingDepartment].criteria=departments[currentEditingDepartment].criteria.filter(c=>c.id!==id);
  openCriteriaModal(currentEditingDepartment);
}

function deleteDepartment(){
  const name=departments[currentEditingDepartment].name;
  if (!confirm(`Ø­Ø°Ù Ø¨Ø®Ø´ "${name}"ØŸ`)) return;
  delete departments[currentEditingDepartment];
  if (isFirebaseConfigured){
    database.ref('departments').set(departments).then(()=>{alert('âœ… Ø¨Ø®Ø´ Ø­Ø°Ù Ø´Ø¯!');closeCriteriaModal();populateDepartmentDropdown();populateNewEmployeeDepartment();updateDepartmentsView();}).catch(e=>alert('âŒ Ø®Ø·Ø§: '+e.message));
  } else {
    localStorage.setItem('departments',JSON.stringify(departments));alert('âœ… Ø¨Ø®Ø´ Ø­Ø°Ù Ø´Ø¯!');closeCriteriaModal();populateDepartmentDropdown();populateNewEmployeeDepartment();updateDepartmentsView();
  }
}

function showAddDepartmentModal(){document.getElementById('add-department-modal').classList.add('active');}
function closeAddDepartmentModal(){document.getElementById('add-department-modal').classList.remove('active');document.getElementById('new-department-name').value='';document.getElementById('new-department-icon').value='';}

function createNewDepartment(){
  const name=document.getElementById('new-department-name').value.trim();
  const icon=document.getElementById('new-department-icon').value.trim();
  if (!name||!icon){alert('âš ï¸ Ù†Ø§Ù… Ùˆ Ø¢ÛŒÚ©ÙˆÙ† Ø§Ù„Ø²Ø§Ù…ÛŒ!');return;}
  departments[name]={name,icon,class:'dept-sales',criteria:[{id:1,name:'Ú©ÛŒÙÛŒØª Ú©Ø§Ø±',weight:15},{id:2,name:'Ø­Ø¶ÙˆØ± Ùˆ ØºÛŒØ§Ø¨',weight:10},{id:3,name:'Ú©Ø§Ø± ØªÛŒÙ…ÛŒ',weight:10}]};
  if (isFirebaseConfigured){
    database.ref('departments').set(departments).then(()=>{alert('âœ… Ø¨Ø®Ø´ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯!');closeAddDepartmentModal();populateDepartmentDropdown();populateNewEmployeeDepartment();updateDepartmentsView();}).catch(e=>alert('âŒ Ø®Ø·Ø§: '+e.message));
  } else {
    localStorage.setItem('departments',JSON.stringify(departments));alert('âœ… Ø¨Ø®Ø´ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯!');closeAddDepartmentModal();populateDepartmentDropdown();populateNewEmployeeDepartment();updateDepartmentsView();
  }
}

function resetToDefaultDepartments(){
  if (!confirm('Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ØŸ')) return;
  departments=JSON.parse(JSON.stringify(defaultDepartments));
  if (isFirebaseConfigured){
    database.ref('departments').set(departments).then(()=>{alert('âœ… Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶!');populateDepartmentDropdown();populateNewEmployeeDepartment();updateDepartmentsView();});
  } else {
    localStorage.setItem('departments',JSON.stringify(departments));alert('âœ… Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶!');populateDepartmentDropdown();populateNewEmployeeDepartment();updateDepartmentsView();
  }
}

['criteria-modal','add-department-modal','edit-employee-modal'].forEach(id=>{
  const el=document.getElementById(id);
  if (el) el.addEventListener('click',function(e){if(e.target===this)this.classList.remove('active');});
});


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JSON IMPORT / EXPORT FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Helpers â”€â”€
function jsonDownload(data, filename) {
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(a.href);
}

function readJSONFile(event, callback) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      callback(data);
    } catch(err) {
      alert('âŒ ÙØ§ÛŒÙ„ JSON Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª! ' + err.message);
    }
    event.target.value = ''; // reset so same file can be re-imported
  };
  reader.readAsText(file, 'utf-8');
}

function showImportToast(msg) {
  const t = document.getElementById('s-toast');
  if (t) { t.innerHTML = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3500); }
  else alert(msg);
}

// â”€â”€ EVALUATIONS: export all as JSON â”€â”€
function exportAllEvaluationsJSON() {
  if (evaluations.length === 0) { showImportToast('âš ï¸ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!'); return; }
  jsonDownload({
    type: 'all-evaluations',
    exportDate: new Date().toISOString(),
    count: evaluations.length,
    evaluations: evaluations
  }, `Ù‡Ù…Ù‡-Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§-${new Date().toISOString().split('T')[0]}.json`);
}

// â”€â”€ EVALUATIONS: import (my evaluations) â”€â”€
function importMyEvaluations(event) {
  readJSONFile(event, data => {
    let imported = [];
    // Support: {evaluations:[...]}, {manager:...,evaluations:[...]}, or plain array
    if (Array.isArray(data)) imported = data;
    else if (Array.isArray(data.evaluations)) imported = data.evaluations;
    else { alert('âŒ ÙØ±Ù…Øª ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯'); return; }

    if (!confirm(`Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ${imported.length} Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´ÙˆØ¯ØŸ Ù…ÙˆØ§Ø±Ø¯ ØªÚ©Ø±Ø§Ø±ÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.`)) return;

    // Merge: override by id
    const existingIds = new Set(evaluations.map(e => e.id));
    let added = 0, updated = 0;
    imported.forEach(ev => {
      if (existingIds.has(ev.id)) {
        const idx = evaluations.findIndex(e => e.id === ev.id);
        evaluations[idx] = ev; updated++;
      } else {
        evaluations.push(ev); added++;
      }
    });

    // Write to Firebase
    if (isFirebaseConfigured) {
      const obj = {};
      evaluations.forEach(ev => { obj[ev.id] = ev; });
      database.ref('evaluations').set(obj)
        .then(() => showImportToast(`âœ… ${added} Ø§Ø¶Ø§ÙÙ‡ØŒ ${updated} Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯`))
        .catch(e => alert('âŒ Ø®Ø·Ø§: ' + e.message));
    } else {
      localStorage.setItem('sharedEvaluations', JSON.stringify(evaluations));
      showImportToast(`âœ… ${added} Ø§Ø¶Ø§ÙÙ‡ØŒ ${updated} Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯`);
    }
    onEvaluationsUpdated();
  });
}

// â”€â”€ EVALUATIONS: import all â”€â”€
function importAllEvaluations(event) {
  importMyEvaluations(event); // same logic
}

// â”€â”€ EMPLOYEES: export â”€â”€
function exportEmployeesJSON() {
  jsonDownload({
    type: 'employees',
    exportDate: new Date().toISOString(),
    count: employees.length,
    employees: employees
  }, `Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù†-${new Date().toISOString().split('T')[0]}.json`);
}

// â”€â”€ EMPLOYEES: import â”€â”€
function importEmployeesJSON(event) {
  readJSONFile(event, data => {
    let imported = [];
    if (Array.isArray(data)) imported = data;
    else if (Array.isArray(data.employees)) imported = data.employees;
    else { alert('âŒ ÙØ±Ù…Øª ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯'); return; }

    if (!confirm(`Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ${imported.length} Ú©Ø§Ø±Ù…Ù†Ø¯ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´ÙˆØ¯ØŸ`)) return;

    const existingIds = new Set(employees.map(e => e.id));
    let added = 0, updated = 0;
    imported.forEach(emp => {
      if (existingIds.has(emp.id)) {
        const idx = employees.findIndex(e => e.id === emp.id);
        employees[idx] = emp; updated++;
      } else {
        employees.push(emp); added++;
      }
    });

    if (isFirebaseConfigured) {
      const obj = {};
      employees.forEach(emp => { obj[emp.id] = emp; });
      database.ref('employees').set(obj)
        .then(() => showImportToast(`âœ… ${added} Ø§Ø¶Ø§ÙÙ‡ØŒ ${updated} Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯`))
        .catch(e => alert('âŒ Ø®Ø·Ø§: ' + e.message));
    } else {
      localStorage.setItem('employees', JSON.stringify(employees));
      showImportToast(`âœ… ${added} Ø§Ø¶Ø§ÙÙ‡ØŒ ${updated} Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯`);
    }
    updateEmployeesManagementList();
  });
}

// â”€â”€ DEPARTMENTS: export â”€â”€
function exportDepartmentsJSON() {
  jsonDownload({
    type: 'departments',
    exportDate: new Date().toISOString(),
    departments: departments
  }, `Ø¨Ø®Ø´â€ŒÙ‡Ø§-${new Date().toISOString().split('T')[0]}.json`);
}

// â”€â”€ DEPARTMENTS: import â”€â”€
function importDepartmentsJSON(event) {
  readJSONFile(event, data => {
    let imported = null;
    if (data && typeof data === 'object' && !Array.isArray(data)) {
      // could be {departments: {...}} or directly the departments object
      if (data.departments && typeof data.departments === 'object') imported = data.departments;
      else if (data.type === 'departments') imported = data.departments;
      else imported = data;
    }
    if (!imported) { alert('âŒ ÙØ±Ù…Øª ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯'); return; }

    const count = Object.keys(imported).length;
    if (!confirm(`Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ${count} Ø¨Ø®Ø´ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´ÙˆØ¯ØŸ Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§ Ù‡Ù…ÛŒÙ† Ù†Ø§Ù… Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.`)) return;

    // Merge departments
    Object.assign(departments, imported);

    if (isFirebaseConfigured) {
      database.ref('departments').set(departments)
        .then(() => {
          showImportToast(`âœ… ${count} Ø¨Ø®Ø´ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯`);
          populateDepartmentDropdown(); populateNewEmployeeDepartment(); updateDepartmentsView();
        })
        .catch(e => alert('âŒ Ø®Ø·Ø§: ' + e.message));
    } else {
      localStorage.setItem('departments', JSON.stringify(departments));
      showImportToast(`âœ… ${count} Ø¨Ø®Ø´ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯`);
      populateDepartmentDropdown(); populateNewEmployeeDepartment(); updateDepartmentsView();
    }
  });
}

// â”€â”€ FULL BACKUP: export everything â”€â”€
function exportFullBackup() {
  // Get supply data from localStorage (always synced there)
  let _sp=[], _sf=[], _spr=[];
  try { _sp=JSON.parse(localStorage.getItem('supply_products')||'[]'); } catch(e){}
  try { _sf=JSON.parse(localStorage.getItem('supply_factories')||'[]'); } catch(e){}
  try { _spr=JSON.parse(localStorage.getItem('supply_prices')||'[]'); } catch(e){}
  const backup = {
    type: 'full-backup',
    version: '2.0',
    exportDate: new Date().toISOString(),
    eval: {
      departments: departments,
      employees: employees,
      evaluations: evaluations
    },
    supply: {
      products: _sp,
      factories: _sf,
      prices: _spr
    }
  };
  jsonDownload(backup, `ÙÙˆÙ„Ø§Ø¯-Ù¾Ù„ØªÙØ±Ù…-Ø¨Ú©Ø§Ù¾-Ú©Ø§Ù…Ù„-${new Date().toISOString().split('T')[0]}.json`);
  showImportToast('âœ… Ø¨Ú©Ø§Ù¾ Ú©Ø§Ù…Ù„ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯');
}

// â”€â”€ FULL BACKUP: import everything â”€â”€
function importFullBackup(event) {
  readJSONFile(event, async data => {
    if (data.type !== 'full-backup') {
      alert('âŒ Ø§ÛŒÙ† ÙØ§ÛŒÙ„ ÛŒÚ© Ø¨Ú©Ø§Ù¾ Ú©Ø§Ù…Ù„ Ù†ÛŒØ³Øª. Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨Ø®Ø´ Ø®Ø§Øµ Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ Ù‡Ø± ØµÙØ­Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.');
      return;
    }
    if (!confirm('âš ï¸ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¨Ú©Ø§Ù¾ Ú©Ø§Ù…Ù„! ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ¹Ù„ÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯. Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒØ¯ØŸ')) return;

    const writes = [];
    try {
      // Eval data
      if (data.eval) {
        if (data.eval.departments) {
          departments = data.eval.departments;
          writes.push(isFirebaseConfigured ? database.ref('departments').set(departments) : Promise.resolve());
          if (!isFirebaseConfigured) localStorage.setItem('departments', JSON.stringify(departments));
        }
        if (data.eval.employees) {
          employees = Array.isArray(data.eval.employees) ? data.eval.employees : Object.values(data.eval.employees);
          const empObj = {};
          employees.forEach(e => { empObj[e.id] = e; });
          writes.push(isFirebaseConfigured ? database.ref('employees').set(empObj) : Promise.resolve());
          if (!isFirebaseConfigured) localStorage.setItem('employees', JSON.stringify(employees));
        }
        if (data.eval.evaluations) {
          evaluations = Array.isArray(data.eval.evaluations) ? data.eval.evaluations : Object.values(data.eval.evaluations);
          const evalObj = {};
          evaluations.forEach(ev => { evalObj[ev.id] = ev; });
          writes.push(isFirebaseConfigured ? database.ref('evaluations').set(evalObj) : Promise.resolve());
          if (!isFirebaseConfigured) localStorage.setItem('sharedEvaluations', JSON.stringify(evaluations));
        }
      }
      // Supply data - stored in pendingSupplyRestore, applied when supply module inits
      if (data.supply) {
        window._pendingSupplyRestore = data.supply;
      }

      await Promise.all(writes);
      // Refresh UI
      populateDepartmentDropdown(); populateNewEmployeeDepartment(); updateDepartmentsView();
      updateEmployeesManagementList(); onEvaluationsUpdated();
      if (window.sRefreshAll) window.sRefreshAll();

      showImportToast('âœ… Ø¨Ú©Ø§Ù¾ Ú©Ø§Ù…Ù„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯');
    } catch(e) {
      alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ: ' + e.message);
    }
  });
}

// EXCEL EXPORT FUNCTIONS
function persianDate(isoStr) {
  try { return new Date(isoStr).toLocaleDateString('fa-IR'); } catch { return isoStr||''; }
}
function scoreBadge(pct) {
  if (pct >= 70) return 'Ø¹Ø§Ù„ÛŒ';
  if (pct >= 50) return 'Ø®ÙˆØ¨';
  return 'Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ù‡Ø¨ÙˆØ¯';
}
function styleHeader(ws, range, bgColor) {
  if (!ws['!ref']) return;
  const R = XLSX.utils.decode_range(range);
  for (let C = R.s.c; C <= R.e.c; C++) {
    const cellAddr = XLSX.utils.encode_cell({r: R.s.r, c: C});
    if (!ws[cellAddr]) continue;
    ws[cellAddr].s = {
      font: { bold: true, color: { rgb: 'FFFFFF' }, name: 'Arial', sz: 11 },
      fill: { fgColor: { rgb: bgColor }, patternType: 'solid' },
      alignment: { horizontal: 'center', vertical: 'center', wrapText: true },
      border: { top:{style:'thin',color:{rgb:'CCCCCC'}}, bottom:{style:'thin',color:{rgb:'CCCCCC'}}, left:{style:'thin',color:{rgb:'CCCCCC'}}, right:{style:'thin',color:{rgb:'CCCCCC'}} }
    };
  }
}
function styleDataRows(ws, startRow, endRow, colCount, altColor) {
  for (let R = startRow; R <= endRow; R++) {
    const isAlt = (R - startRow) % 2 === 1;
    for (let C = 0; C < colCount; C++) {
      const cellAddr = XLSX.utils.encode_cell({r: R, c: C});
      if (!ws[cellAddr]) ws[cellAddr] = { t: 's', v: '' };
      ws[cellAddr].s = {
        font: { name: 'Arial', sz: 10 },
        fill: isAlt ? { fgColor: { rgb: altColor }, patternType: 'solid' } : { patternType: 'none' },
        alignment: { horizontal: 'center', vertical: 'center' },
        border: { bottom:{style:'thin',color:{rgb:'E0E0E0'}}, left:{style:'thin',color:{rgb:'E0E0E0'}}, right:{style:'thin',color:{rgb:'E0E0E0'}} }
      };
    }
  }
}

function exportMyEvaluationsExcel() {
  const myEvals = evaluations.filter(e => e.managerName === currentManager);
  if (myEvals.length === 0) { alert('âš ï¸ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!'); return; }
  const wb = XLSX.utils.book_new();
  const sorted = [...myEvals].sort((a,b) => new Date(b.timestamp)-new Date(a.timestamp));
  const headers1 = ['Ø±Ø¯ÛŒÙ','ØªØ§Ø±ÛŒØ® Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ','Ù†Ø§Ù… Ú©Ø§Ø±Ù…Ù†Ø¯','Ø¨Ø®Ø´','Ø§Ù…ØªÛŒØ§Ø² Ú©Ø³Ø¨ Ø´Ø¯Ù‡','Ø­Ø¯Ø§Ú©Ø«Ø± Ø§Ù…ØªÛŒØ§Ø²','Ø¯Ø±ØµØ¯','Ø±ØªØ¨Ù‡','ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª'];
  const rows1 = sorted.map((ev, i) => {
    const pct = Math.round(ev.totalScore / ev.maxScore * 100);
    return [i+1, persianDate(ev.date), ev.employeeName, ev.departmentName, ev.totalScore, ev.maxScore, pct+'%', scoreBadge(pct), persianDate(ev.timestamp)];
  });
  const avgPct = Math.round(myEvals.reduce((s,e) => s + (e.totalScore/e.maxScore*100), 0) / myEvals.length);
  rows1.push([]);
  rows1.push(['', 'Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ú©Ù„', '', '', '', '', avgPct+'%', scoreBadge(avgPct), '']);
  const ws1 = XLSX.utils.aoa_to_sheet([headers1, ...rows1]);
  ws1['!cols'] = [{wch:6},{wch:14},{wch:22},{wch:18},{wch:16},{wch:16},{wch:10},{wch:16},{wch:14}];
  styleHeader(ws1, 'A1:I1', '1E40AF');
  styleDataRows(ws1, 1, rows1.length, 9, 'EFF6FF');
  XLSX.utils.book_append_sheet(wb, ws1, 'Ù„ÛŒØ³Øª Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§');
  const headers2 = ['Ù†Ø§Ù… Ú©Ø§Ø±Ù…Ù†Ø¯','Ø¨Ø®Ø´','ØªØ§Ø±ÛŒØ®','Ù…Ø¹ÛŒØ§Ø±','Ø¶Ø±ÛŒØ¨','Ø§Ù…ØªÛŒØ§Ø² (Û±-Û±Û°)','Ø§Ù…ØªÛŒØ§Ø² ÙˆØ²Ù†ÛŒ'];
  const rows2 = [];
  sorted.forEach(ev => {
    if (ev.criteriaSnapshot && ev.scores) {
      ev.criteriaSnapshot.forEach(c => {
        const sc = ev.scores[c.id] || 0;
        rows2.push([ev.employeeName, ev.departmentName, persianDate(ev.date), c.name, c.weight, sc, sc * c.weight]);
      });
    }
  });
  if (rows2.length > 0) {
    const ws2 = XLSX.utils.aoa_to_sheet([headers2, ...rows2]);
    ws2['!cols'] = [{wch:22},{wch:18},{wch:14},{wch:30},{wch:10},{wch:14},{wch:14}];
    styleHeader(ws2, 'A1:G1', '059669');
    styleDataRows(ws2, 1, rows2.length, 7, 'F0FDF4');
    XLSX.utils.book_append_sheet(wb, ws2, 'Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§');
  }
  XLSX.writeFile(wb, `Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ-${currentManager}-${new Date().toISOString().split('T')[0]}.xlsx`);
  alert('âœ… ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯!');
}

function exportAllEvaluationsExcel() {
  if (evaluations.length === 0) { alert('âš ï¸ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!'); return; }
  const wb = XLSX.utils.book_new();
  const sorted = [...evaluations].sort((a,b) => new Date(b.timestamp)-new Date(a.timestamp));
  const headers1 = ['Ø±Ø¯ÛŒÙ','ØªØ§Ø±ÛŒØ® Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ','Ù†Ø§Ù… Ú©Ø§Ø±Ù…Ù†Ø¯','Ø¨Ø®Ø´','Ù…Ø¯ÛŒØ± Ø§Ø±Ø²ÛŒØ§Ø¨','Ø§Ù…ØªÛŒØ§Ø²','Ø­Ø¯Ø§Ú©Ø«Ø±','Ø¯Ø±ØµØ¯','Ø±ØªØ¨Ù‡'];
  const rows1 = sorted.map((ev, i) => {
    const pct = Math.round(ev.totalScore / ev.maxScore * 100);
    return [i+1, persianDate(ev.date), ev.employeeName, ev.departmentName, ev.managerName||'â€”', ev.totalScore, ev.maxScore, pct+'%', scoreBadge(pct)];
  });
  const ws1 = XLSX.utils.aoa_to_sheet([headers1, ...rows1]);
  ws1['!cols'] = [{wch:6},{wch:14},{wch:22},{wch:18},{wch:18},{wch:12},{wch:12},{wch:10},{wch:16}];
  styleHeader(ws1, 'A1:I1', '1E40AF');
  styleDataRows(ws1, 1, rows1.length, 9, 'EFF6FF');
  XLSX.utils.book_append_sheet(wb, ws1, 'Ù‡Ù…Ù‡ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§');
  const mgrMap = {};
  evaluations.forEach(ev => {
    const m = ev.managerName || 'â€”';
    if (!mgrMap[m]) mgrMap[m] = { count: 0, sumPct: 0, employees: new Set() };
    mgrMap[m].count++; mgrMap[m].sumPct += (ev.totalScore / ev.maxScore * 100); mgrMap[m].employees.add(ev.employeeName);
  });
  const ws2 = XLSX.utils.aoa_to_sheet([['Ù†Ø§Ù… Ù…Ø¯ÛŒØ±','ØªØ¹Ø¯Ø§Ø¯ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ','ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù†','Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø²'], ...Object.entries(mgrMap).map(([n,d])=>[n,d.count,d.employees.size,Math.round(d.sumPct/d.count)+'%'])]);
  ws2['!cols'] = [{wch:22},{wch:16},{wch:18},{wch:16}];
  styleHeader(ws2, 'A1:D1', '7C3AED');
  XLSX.utils.book_append_sheet(wb, ws2, 'Ø®Ù„Ø§ØµÙ‡ Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ù…Ø¯ÛŒØ±');
  XLSX.writeFile(wb, `Ù‡Ù…Ù‡-Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§-${new Date().toISOString().split('T')[0]}.xlsx`);
  alert('âœ… ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯!');
}

function exportRankingExcel() {
  if (evaluations.length === 0) { alert('âš ï¸ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!'); return; }
  const empMap = {};
  evaluations.forEach(ev => {
    if (!empMap[ev.employeeName]) empMap[ev.employeeName] = { name: ev.employeeName, dept: ev.departmentName, totalScore: 0, totalMax: 0, count: 0 };
    empMap[ev.employeeName].totalScore += ev.totalScore;
    empMap[ev.employeeName].totalMax  += ev.maxScore;
    empMap[ev.employeeName].count++;
  });
  const ranked = Object.values(empMap).map(e => ({...e, avgPct: e.totalMax > 0 ? Math.round(e.totalScore / e.totalMax * 100) : 0})).sort((a,b) => b.avgPct - a.avgPct);
  const wb = XLSX.utils.book_new();
  const headers = ['Ø±ØªØ¨Ù‡','Ù…Ø¯Ø§Ù„','Ù†Ø§Ù… Ú©Ø§Ø±Ù…Ù†Ø¯','Ø¨Ø®Ø´','ØªØ¹Ø¯Ø§Ø¯ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ','Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù…ØªÛŒØ§Ø²','Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¯Ø±ØµØ¯','ÙˆØ¶Ø¹ÛŒØª'];
  const rows = ranked.map((emp, i) => {
    const rank = i + 1;
    return [rank, rank===1?'ğŸ¥‡':rank===2?'ğŸ¥ˆ':rank===3?'ğŸ¥‰':'', emp.name, emp.dept, emp.count, emp.totalScore, emp.avgPct+'%', scoreBadge(emp.avgPct)];
  });
  const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
  ws['!cols'] = [{wch:8},{wch:8},{wch:22},{wch:18},{wch:14},{wch:14},{wch:14},{wch:16}];
  styleHeader(ws, 'A1:H1', 'D97706');
  XLSX.utils.book_append_sheet(wb, ws, 'Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù†');
  XLSX.writeFile(wb, `Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ-Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù†-${new Date().toISOString().split('T')[0]}.xlsx`);
  alert('âœ… ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯!');
}
</script>

<!-- SUPPLY SCRIPT -->
<script>
let sDb = null;
let sFbOk = false;
// Use same Firebase app initialized in eval section
try {
  sDb = firebase.database();
  sFbOk = true;
  console.log('âœ… Supply module: Firebase connected');
} catch(e) { 
  console.warn('Supply Firebase error:', e);
  sFbOk = false;
}

let sProducts=[], sFactories=[], sPrices=[];
let sChartPeriod=7;
let sEditProductId=null, sEditFactoryId=null, sEditPriceId=null;
let sAddFormVisible=true;
let selectedProducts = new Set();

function supplyInit() {
  if (!sFbOk) {
    // Offline fallback
    sProducts  = sLoadLS('products');
    sFactories = sLoadLS('factories');
    sPrices    = sLoadLS('prices');
    sRefreshAll();
    if (sProducts.length===0) sSeedProducts();
    if (sFactories.length===0) sSeedFactories();
    return;
  }
  // Firebase listeners - single source of truth
  sListenFB('products',  d=>{sProducts=d;  localStorage.setItem('supply_products',JSON.stringify(d));   sRefreshAll();});
  sListenFB('factories', d=>{sFactories=d; localStorage.setItem('supply_factories',JSON.stringify(d)); sRefreshAll();});
  sListenFB('prices',    d=>{sPrices=d;    localStorage.setItem('supply_prices',JSON.stringify(d));       sRefreshAll();});
  // Apply full backup restore if pending
  if (window._pendingSupplyRestore) {
    const r = window._pendingSupplyRestore;
    delete window._pendingSupplyRestore;
    if (r.products) { sProducts = r.products; sPersist('products', sProducts); }
    if (r.factories) { sFactories = r.factories; sPersist('factories', sFactories); }
    if (r.prices) { sProducts = r.prices; sPersist('prices', sPrices); }
    sRefreshAll();
    showImportToast && showImportToast('âœ… Ø¨Ú©Ø§Ù¾ Ú©Ø§Ù…Ù„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯');
    return;
  }
  // Seed only if Firebase is empty (first run)
  sDb.ref('supply/products').once('value').then(snap => {
    if (!snap.exists() || Object.keys(snap.val()||{}).length === 0) sSeedProducts();
  });
  sDb.ref('supply/factories').once('value').then(snap => {
    if (!snap.exists() || Object.keys(snap.val()||{}).length === 0) sSeedFactories();
  });
}

function sPersist(key,data){
  if (sFbOk) {
    sDb.ref('supply/'+key).set(data).catch(e => {
      console.error('Firebase write error:', e);
      localStorage.setItem('supply_'+key,JSON.stringify(data));
    });
  } else {
    localStorage.setItem('supply_'+key,JSON.stringify(data));
  }
}
function sLoadLS(key){try{return JSON.parse(localStorage.getItem('supply_'+key))||[];}catch{return[];}}
function sListenFB(key,cb){
  if (!sFbOk) return;
  sDb.ref('supply/'+key).on('value', snap => {
    if (!snap.exists()) { cb([]); return; }
    const val = snap.val();
    // Firebase stores arrays as objects with numeric keys
    if (Array.isArray(val)) cb(val.filter(Boolean));
    else cb(Object.values(val).filter(Boolean));
  });
}

function sSeedProducts(){
  sProducts=[
    {id:1,name:'Ù†Ø¨Ø´ÛŒ',category:'Ù†Ø¨Ø´ÛŒ',icon:'ğŸ“',unit:'Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…',desc:'Ù†Ø¨Ø´ÛŒ Ø³Ø§Ø®ØªÙ…Ø§Ù†ÛŒ Ùˆ ØµÙ†Ø¹ØªÛŒ'},
    {id:2,name:'Ù…ÛŒÙ„Ú¯Ø±Ø¯ A3',category:'Ù…ÛŒÙ„Ú¯Ø±Ø¯',icon:'ğŸ”©',unit:'Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…',desc:'Ù…ÛŒÙ„Ú¯Ø±Ø¯ Ø¢Ø¬Ø¯Ø§Ø± A3'},
    {id:3,name:'Ù…ÛŒÙ„Ú¯Ø±Ø¯ A2',category:'Ù…ÛŒÙ„Ú¯Ø±Ø¯',icon:'ğŸ”©',unit:'Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…',desc:'Ù…ÛŒÙ„Ú¯Ø±Ø¯ Ø³Ø§Ø¯Ù‡ A2'},
    {id:4,name:'Ù†Ø§ÙˆØ¯Ø§Ù†ÛŒ',category:'Ù†Ø§ÙˆØ¯Ø§Ù†ÛŒ',icon:'ğŸ“',unit:'Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…',desc:'Ù†Ø§ÙˆØ¯Ø§Ù†ÛŒ Ø³Ø¨Ú© Ùˆ Ø³Ù†Ú¯ÛŒÙ†'},
    {id:5,name:'ØªÛŒØ±Ø¢Ù‡Ù† IPE',category:'ØªÛŒØ±Ø¢Ù‡Ù†',icon:'ğŸ—ï¸',unit:'Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…',desc:'ØªÛŒØ±Ø¢Ù‡Ù† IPE'},
    {id:6,name:'ØªÛŒØ±Ø¢Ù‡Ù† INP',category:'ØªÛŒØ±Ø¢Ù‡Ù†',icon:'ğŸ—ï¸',unit:'Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…',desc:'ØªÛŒØ±Ø¢Ù‡Ù† INP'},
    {id:7,name:'ÙˆØ±Ù‚ Ø³ÛŒØ§Ù‡',category:'ÙˆØ±Ù‚',icon:'ğŸ”²',unit:'Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…',desc:'ÙˆØ±Ù‚ Ø³ÛŒØ§Ù‡ ST37'},
    {id:8,name:'ÙˆØ±Ù‚ Ú¯Ø§Ù„ÙˆØ§Ù†ÛŒØ²Ù‡',category:'ÙˆØ±Ù‚',icon:'ğŸ”²',unit:'Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…',desc:'ÙˆØ±Ù‚ Ú¯Ø§Ù„ÙˆØ§Ù†ÛŒØ²Ù‡'},
    {id:9,name:'Ù„ÙˆÙ„Ù‡ Ú¯Ø§Ø²',category:'Ù„ÙˆÙ„Ù‡',icon:'â­•',unit:'Ù…ØªØ±',desc:'Ù„ÙˆÙ„Ù‡ Ú¯Ø§Ø² Ø¨Ø±ÙˆØ¯Ø§Ø±'},
    {id:10,name:'Ù„ÙˆÙ„Ù‡ Ø¢Ø¨',category:'Ù„ÙˆÙ„Ù‡',icon:'â­•',unit:'Ù…ØªØ±',desc:'Ù„ÙˆÙ„Ù‡ Ø¢Ø¨ Ùˆ ÙØ§Ø¶Ù„Ø§Ø¨'},
    {id:11,name:'Ù¾Ø±ÙˆÙÛŒÙ„ Ù…Ø±Ø¨Ø¹',category:'Ù¾Ø±ÙˆÙÛŒÙ„',icon:'ğŸ“¦',unit:'Ù…ØªØ±',desc:'Ù¾Ø±ÙˆÙÛŒÙ„ Ù…Ø±Ø¨Ø¹'},
    {id:12,name:'Ù…ÙØªÙˆÙ„',category:'Ù…ÙØªÙˆÙ„',icon:'ğŸ§µ',unit:'Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…',desc:'Ù…ÙØªÙˆÙ„ Ø³ÛŒØ§Ù‡'}
  ];
  sPersist('products',sProducts);
}

function sSeedFactories(){
  sFactories=[
    {id:1,name:'Ø°ÙˆØ¨â€ŒØ¢Ù‡Ù† Ø§ØµÙÙ‡Ø§Ù†',city:'Ø§ØµÙÙ‡Ø§Ù†',products:'Ù…ÛŒÙ„Ú¯Ø±Ø¯ØŒ ØªÛŒØ±Ø¢Ù‡Ù†',tel:'0311-XXXXXXX',status:'ÙØ¹Ø§Ù„',note:'Ø¨Ø²Ø±Ú¯â€ŒØªØ±ÛŒÙ† ØªÙˆÙ„ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡'},
    {id:2,name:'ÙÙˆÙ„Ø§Ø¯ Ù…Ø¨Ø§Ø±Ú©Ù‡',city:'Ù…Ø¨Ø§Ø±Ú©Ù‡',products:'ÙˆØ±Ù‚ØŒ Ù…ÛŒÙ„Ú¯Ø±Ø¯',tel:'0312-XXXXXXX',status:'ÙØ¹Ø§Ù„',note:''},
    {id:3,name:'Ù†ÙˆØ±Ø¯ Ù„Ø±Ø³ØªØ§Ù†',city:'Ø®Ø±Ù…â€ŒØ¢Ø¨Ø§Ø¯',products:'Ù†Ø¨Ø´ÛŒØŒ Ù†Ø§ÙˆØ¯Ø§Ù†ÛŒ',tel:'0661-XXXXXXX',status:'ÙØ¹Ø§Ù„',note:''},
    {id:4,name:'Ø´Ø§Ù‡ÛŒÙ† Ø¨Ù†Ø§Ø¨',city:'Ø¨Ù†Ø§Ø¨',products:'Ù…ÛŒÙ„Ú¯Ø±Ø¯',tel:'0412-XXXXXXX',status:'ÙØ¹Ø§Ù„',note:''},
    {id:5,name:'Ø¢Ø±ÛŒØ§ Ø°ÙˆØ¨',city:'ØªÙ‡Ø±Ø§Ù†',products:'Ù„ÙˆÙ„Ù‡ØŒ Ù†Ø¨Ø´ÛŒ',tel:'021-XXXXXXX',status:'Ø¯Ø± Ø­Ø§Ù„ Ù…Ø°Ø§Ú©Ø±Ù‡',note:''}
  ];
  sPersist('factories',sFactories);
}

function sRefreshAll(){
  // Update connection status indicator
  const dot = document.getElementById('supply-status-dot');
  const txt = document.getElementById('supply-status-text');
  if (dot && txt) {
    if (sFbOk) { dot.style.background='#4ade80'; txt.textContent='Firebase'; }
    else { dot.style.background='#f87171'; txt.textContent='Ø¢ÙÙ„Ø§ÛŒÙ†'; }
  }
  sUpdateStats(); sUpdateDropdowns();
  sRenderProductsGrid(); sRenderFactoriesGrid(); sRenderPriceTable();
  const salesSection = document.getElementById('supply-sales-dashboard-section');
  if (salesSection && salesSection.classList.contains('active')) {
    renderProductCheckboxes();
    renderSalesPriceTables();
  }
}

function sUpdateStats(){
  document.getElementById('stat-products').textContent  = sProducts.length;
  document.getElementById('stat-factories').textContent = sFactories.length;
  document.getElementById('stat-prices').textContent    = sPrices.length;
  document.getElementById('nc-products').textContent    = sProducts.length;
  document.getElementById('nc-factories').textContent   = sFactories.length;
  document.getElementById('nc-prices').textContent      = sPrices.length;
  const today=new Date().toDateString();
  document.getElementById('stat-today').textContent = sPrices.filter(p=>new Date(p.updatedAt).toDateString()===today).length;
}

function sUpdateDropdowns(){
  ['p-product','filter-product','ep-product','chart-product-filter'].forEach(id=>{
    const el=document.getElementById(id); if (!el) return;
    const cur=el.value; const isF=id.includes('filter')||id.includes('chart');
    el.innerHTML=isF?'<option value="">Ù‡Ù…Ù‡ Ù…Ø­ØµÙˆÙ„Ø§Øª</option>':'<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø­ØµÙˆÙ„...</option>';
    sProducts.forEach(p=>el.insertAdjacentHTML('beforeend',`<option value="${p.name}"${p.name===cur?' selected':''}>${p.icon||'ğŸ“¦'} ${p.name}</option>`));
  });
  ['p-factory','filter-factory','ep-factory','chart-factory-filter'].forEach(id=>{
    const el=document.getElementById(id); if (!el) return;
    const cur=el.value; const isF=id.includes('filter')||id.includes('chart');
    el.innerHTML=isF?'<option value="">Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø®Ø§Ù†Ø¬Ø§Øª</option>':'<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø®Ø§Ù†Ù‡...</option>';
    sFactories.forEach(f=>el.insertAdjacentHTML('beforeend',`<option value="${f.name}"${f.name===cur?' selected':''}>${f.name}</option>`));
  });
}

function openProductModal(id=null){
  sEditProductId=id;
  if (id){
    const p=sProducts.find(x=>x.id===id);
    document.getElementById('product-modal-title').textContent='âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø­ØµÙˆÙ„';
    document.getElementById('prod-name').value=p.name;
    document.getElementById('prod-category').value=p.category||'Ø³Ø§ÛŒØ±';
    document.getElementById('prod-icon').value=p.icon||'';
    document.getElementById('prod-unit').value=p.unit||'Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…';
    document.getElementById('prod-desc').value=p.desc||'';
  } else {
    document.getElementById('product-modal-title').textContent='ğŸ“¦ Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØµÙˆÙ„ Ø¬Ø¯ÛŒØ¯';
    ['prod-name','prod-icon','prod-desc'].forEach(f=>document.getElementById(f).value='');
    document.getElementById('prod-unit').value='Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…';
  }
  document.getElementById('s-product-modal').classList.add('active');
}

function saveProduct(){
  const name=document.getElementById('prod-name').value.trim();
  if (!name){sShowToast('Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª!','âš ï¸');return;}
  if (sEditProductId){
    const p=sProducts.find(x=>x.id===sEditProductId);
    p.name=name; p.icon=document.getElementById('prod-icon').value;
    p.unit=document.getElementById('prod-unit').value;
    p.desc=document.getElementById('prod-desc').value;
    p.category=document.getElementById('prod-category').value;
  } else {
    sProducts.push({id:Date.now(),name,category:document.getElementById('prod-category').value,icon:document.getElementById('prod-icon').value||'ğŸ“¦',unit:document.getElementById('prod-unit').value,desc:document.getElementById('prod-desc').value});
  }
  sPersist('products',sProducts);
  closeSupplyModal('s-product-modal');
  sRenderProductsGrid(); sUpdateDropdowns(); sUpdateStats();
  sShowToast(sEditProductId?'Ù…Ø­ØµÙˆÙ„ ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯':'Ù…Ø­ØµÙˆÙ„ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
  sEditProductId=null;
}

function deleteProduct(id){
  if (!confirm('Ø­Ø°Ù Ø§ÛŒÙ† Ù…Ø­ØµÙˆÙ„ØŸ')) return;
  sProducts=sProducts.filter(p=>p.id!==id);
  sPersist('products',sProducts);
  sRenderProductsGrid(); sUpdateDropdowns(); sUpdateStats();
  sShowToast('Ù…Ø­ØµÙˆÙ„ Ø­Ø°Ù Ø´Ø¯','ğŸ—‘ï¸');
}

function sRenderProductsGrid(){
  const g=document.getElementById('products-grid');
  if (sProducts.length===0){
    g.innerHTML=`<div class="empty"><div class="empty-icon">ğŸ“¦</div><div class="empty-text">Ù‡Ù†ÙˆØ² Ù…Ø­ØµÙˆÙ„ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡</div></div>`;return;
  }
  g.innerHTML=sProducts.map(p=>{
    const cnt=sPrices.filter(x=>x.product===p.name).length;
    return `<div class="item-card">
      <div class="item-card-header"><div class="item-card-icon">${p.icon||'ğŸ“¦'}</div><div class="chip chip-amber">${cnt} Ù‚ÛŒÙ…Øª</div></div>
      <div class="item-card-name">${p.name}</div>
      <div class="item-card-meta">${p.unit} ${p.desc?'Â· '+p.desc:''}</div>
      <div class="item-card-actions">
        <button class="btn btn-ghost btn-sm" onclick="openProductModal(${p.id})">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</button>
        <button class="btn btn-danger btn-sm" onclick="deleteProduct(${p.id})">ğŸ—‘ï¸</button>
      </div>
    </div>`;
  }).join('');
}

function openFactoryModal(id=null){
  sEditFactoryId=id;
  if (id){
    const f=sFactories.find(x=>x.id===id);
    document.getElementById('factory-modal-title').textContent='âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±Ø®Ø§Ù†Ù‡';
    document.getElementById('fac-name').value=f.name;
    document.getElementById('fac-city').value=f.city||'';
    document.getElementById('fac-products').value=f.products||'';
    document.getElementById('fac-tel').value=f.tel||'';
    document.getElementById('fac-status').value=f.status||'ÙØ¹Ø§Ù„';
    document.getElementById('fac-note').value=f.note||'';
  } else {
    document.getElementById('factory-modal-title').textContent='ğŸ­ Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø®Ø§Ù†Ù‡';
    ['fac-name','fac-city','fac-products','fac-tel','fac-note'].forEach(f=>document.getElementById(f).value='');
    document.getElementById('fac-status').value='ÙØ¹Ø§Ù„';
  }
  document.getElementById('s-factory-modal').classList.add('active');
}

function saveFactory(){
  const name=document.getElementById('fac-name').value.trim();
  if (!name){sShowToast('Ù†Ø§Ù… Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª!','âš ï¸');return;}
  const obj={name,city:document.getElementById('fac-city').value,products:document.getElementById('fac-products').value,tel:document.getElementById('fac-tel').value,status:document.getElementById('fac-status').value,note:document.getElementById('fac-note').value};
  if (sEditFactoryId){const i=sFactories.findIndex(x=>x.id===sEditFactoryId);sFactories[i]={...sFactories[i],...obj};}
  else sFactories.push({id:Date.now(),...obj});
  sPersist('factories',sFactories);
  closeSupplyModal('s-factory-modal');
  sRenderFactoriesGrid(); sUpdateDropdowns(); sUpdateStats();
  sShowToast(sEditFactoryId?'Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯':'Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
  sEditFactoryId=null;
}

function deleteFactory(id){
  if (!confirm('Ø­Ø°Ù Ø§ÛŒÙ† Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ØŸ')) return;
  sFactories=sFactories.filter(f=>f.id!==id);
  sPersist('factories',sFactories);
  sRenderFactoriesGrid(); sUpdateDropdowns(); sUpdateStats();
  sShowToast('Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ Ø­Ø°Ù Ø´Ø¯','ğŸ—‘ï¸');
}

const sStatusChip=s=>s==='ÙØ¹Ø§Ù„'?'chip-green':s==='ØºÛŒØ±ÙØ¹Ø§Ù„'?'chip-red':'chip-amber';

function sRenderFactoriesGrid(){
  const g=document.getElementById('factories-grid');
  if (sFactories.length===0){
    g.innerHTML=`<div class="empty"><div class="empty-icon">ğŸ­</div><div class="empty-text">Ù‡Ù†ÙˆØ² Ú©Ø§Ø±Ø®Ø§Ù†Ù‡â€ŒØ§ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡</div></div>`;return;
  }
  g.innerHTML=sFactories.map(f=>{
    const cnt=sPrices.filter(p=>p.factory===f.name).length;
    return `<div class="item-card">
      <div class="item-card-header"><div class="item-card-icon">ğŸ­</div><div class="chip ${sStatusChip(f.status)}">${f.status}</div></div>
      <div class="item-card-name">${f.name}</div>
      <div class="item-card-meta" style="margin-bottom:8px;">${f.city?'ğŸ“ '+f.city+' &nbsp;':''} ${cnt} Ø±Ú©ÙˆØ±Ø¯ Ù‚ÛŒÙ…Øª</div>
      ${f.products?`<div style="font-size:12px;color:var(--text-light);margin-bottom:4px;">ğŸ”© ${f.products}</div>`:''}
      ${f.tel?`<div style="font-size:12px;color:var(--text-light);">ğŸ“ ${f.tel}</div>`:''}
      <div class="item-card-actions">
        <button class="btn btn-ghost btn-sm" onclick="openFactoryModal(${f.id})">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</button>
        <button class="btn btn-danger btn-sm" onclick="deleteFactory(${f.id})">ğŸ—‘ï¸</button>
      </div>
    </div>`;
  }).join('');
}

function addPrice(){
  const product=document.getElementById('p-product').value;
  const size=document.getElementById('p-size').value.trim();
  const factory=document.getElementById('p-factory').value;
  const price=parseFloat(document.getElementById('p-price').value);
  const note=document.getElementById('p-note').value.trim();
  if (!product||!size||!factory||isNaN(price)){sShowToast('Ù„Ø·ÙØ§Ù‹ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø³ØªØ§Ø±Ù‡â€ŒØ¯Ø§Ø± Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯','âš ï¸');return;}
  const existing=sPrices.find(p=>p.product===product&&p.size===size&&p.factory===factory);
  if (existing){
    existing.prevPrice=existing.price;existing.price=price;existing.note=note;
    existing.updatedAt=new Date().toISOString();
    sShowToast(`Ù‚ÛŒÙ…Øª ${product} ${size} Ø¢Ù¾Ø¯ÛŒØª Ø´Ø¯`,'ğŸ”„');
  } else {
    sPrices.push({id:Date.now(),product,size,factory,price,prevPrice:null,note,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()});
    sShowToast(`Ù‚ÛŒÙ…Øª ${product} ${size} Ø«Ø¨Øª Ø´Ø¯`);
  }
  sPersist('prices',sPrices);
  clearPriceForm(); sRenderPriceTable(); sUpdateStats(); sUpdateDropdowns();
}

function clearPriceForm(){
  ['p-product','p-factory'].forEach(id=>document.getElementById(id).value='');
  ['p-size','p-price','p-note'].forEach(id=>document.getElementById(id).value='');
}

function sRenderPriceTable(){
  const search=document.getElementById('price-search')?.value.toLowerCase()||'';
  const fprod=document.getElementById('filter-product')?.value||'';
  const ffact=document.getElementById('filter-factory')?.value||'';
  const tbody=document.getElementById('price-tbody');
  const empty=document.getElementById('price-empty');
  let rows=[...sPrices].sort((a,b)=>new Date(b.updatedAt)-new Date(a.updatedAt));
  if (fprod) rows=rows.filter(r=>r.product===fprod);
  if (ffact) rows=rows.filter(r=>r.factory===ffact);
  if (search) rows=rows.filter(r=>r.product.toLowerCase().includes(search)||r.size.toLowerCase().includes(search)||r.factory.toLowerCase().includes(search)||(r.note||'').toLowerCase().includes(search));
  if (rows.length===0){tbody.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  tbody.innerHTML=rows.map(r=>{
    const d=new Date(r.updatedAt);
    const dateStr=d.toLocaleDateString('fa-IR');
    const timeStr=d.toLocaleTimeString('fa-IR',{hour:'2-digit',minute:'2-digit'});
    let changeTxt='<span class="change-flat">â€”</span>';
    if (r.prevPrice!==null&&r.prevPrice!==undefined){
      const diff=r.price-r.prevPrice;const pct=((diff/r.prevPrice)*100).toFixed(1);
      if (diff>0) changeTxt=`<span class="change-up">â–² ${pct}%</span>`;
      else if (diff<0) changeTxt=`<span class="change-down">â–¼ ${Math.abs(pct)}%</span>`;
      else changeTxt='<span class="change-flat">Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±</span>';
    }
    const prod=sProducts.find(p=>p.name===r.product);
    return `<tr>
      <td><span class="chip chip-cyan">${prod?.icon||'ğŸ“¦'} ${r.product}</span></td>
      <td><strong>${r.size}</strong></td><td>${r.factory}</td>
      <td><div class="price-cell">${Number(r.price).toLocaleString('fa-IR')}</div><div class="price-unit">ØªÙˆÙ…Ø§Ù† / Ú©ÛŒÙ„Ùˆ</div></td>
      <td>${changeTxt}</td>
      <td><div class="update-badge"><span class="date">${dateStr}</span><span>${timeStr}</span></div></td>
      <td style="max-width:140px;font-size:12px;color:var(--text-light);">${r.note||'â€”'}</td>
      <td><div class="actions"><button class="btn btn-ghost btn-sm" onclick="openEditPrice(${r.id})">âœï¸</button><button class="btn btn-danger btn-sm" onclick="deletePrice(${r.id})">ğŸ—‘ï¸</button></div></td>
    </tr>`;
  }).join('');
}

function renderPriceTable(){sRenderPriceTable();}

function openEditPrice(id){
  sEditPriceId=id;const p=sPrices.find(x=>x.id===id);
  sUpdateDropdowns();
  setTimeout(()=>{
    document.getElementById('ep-product').value=p.product;
    document.getElementById('ep-factory').value=p.factory;
    document.getElementById('ep-size').value=p.size;
    document.getElementById('ep-price').value=p.price;
    document.getElementById('ep-note').value=p.note||'';
  },50);
  document.getElementById('s-edit-price-modal').classList.add('active');
}

function saveEditedPrice(){
  const p=sPrices.find(x=>x.id===sEditPriceId);
  p.prevPrice=p.price;p.product=document.getElementById('ep-product').value;
  p.size=document.getElementById('ep-size').value;p.factory=document.getElementById('ep-factory').value;
  p.price=parseFloat(document.getElementById('ep-price').value);p.note=document.getElementById('ep-note').value;
  p.updatedAt=new Date().toISOString();
  sPersist('prices',sPrices);closeSupplyModal('s-edit-price-modal');sRenderPriceTable();sUpdateStats();
  sShowToast('Ù‚ÛŒÙ…Øª ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯','ğŸ”„');
}

function deletePrice(id){
  if (!confirm('Ø­Ø°Ù Ø§ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯ Ù‚ÛŒÙ…ØªØŸ')) return;
  sPrices=sPrices.filter(p=>p.id!==id);
  sPersist('prices',sPrices);sRenderPriceTable();sUpdateStats();
  sShowToast('Ø±Ú©ÙˆØ±Ø¯ Ø­Ø°Ù Ø´Ø¯','ğŸ—‘ï¸');
}

function exportCSV(){
  if (sPrices.length===0){sShowToast('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ Ù†ÛŒØ³Øª','âš ï¸');return;}
  const header=['Ù†ÙˆØ¹ Ø¨Ø§Ø±','Ø³Ø§ÛŒØ²','Ú©Ø§Ø±Ø®Ø§Ù†Ù‡','Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†/Ú©ÛŒÙ„Ùˆ)','ØªØ§Ø±ÛŒØ® Ø¢Ù¾Ø¯ÛŒØª','ØªÙˆØ¶ÛŒØ­Ø§Øª'];
  const rows=sPrices.map(r=>[r.product,r.size,r.factory,r.price,new Date(r.updatedAt).toLocaleString('fa-IR'),r.note||'']);
  const csv=[header,...rows].map(r=>r.join(',')).join('\n');
  const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`supply-prices-${Date.now()}.csv`;a.click();
  sShowToast('ÙØ§ÛŒÙ„ CSV Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯','ğŸ“¥');
}

function toggleAddForm(){
  sAddFormVisible=!sAddFormVisible;
  document.getElementById('add-form-wrap').style.display=sAddFormVisible?'':'none';
  document.getElementById('toggle-icon').textContent=sAddFormVisible?'â–²':'â–¼';
  const btn=document.querySelector('[onclick="toggleAddForm()"]');
  if (btn) btn.innerHTML=sAddFormVisible?'<span id="toggle-icon">â–²</span> Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† ÙØ±Ù…':'<span id="toggle-icon">â–¼</span> Ù†Ù…Ø§ÛŒØ´ ÙØ±Ù… Ø«Ø¨Øª';
}

function supplyTab(tab,el){
  document.querySelectorAll('.supply-section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.supply-nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('supply-'+tab+'-section').classList.add('active');
  el.classList.add('active');
  if (tab==='analytics'){sUpdateDropdowns();setTimeout(renderAnalytics,100);}
  if (tab==='sales-dashboard'){renderProductCheckboxes();renderSalesPriceTables();}
}

function closeSupplyModal(id){
  document.getElementById(id).classList.remove('active');
}

['s-product-modal','s-factory-modal','s-edit-price-modal'].forEach(id=>{
  const el=document.getElementById(id);
  if (el) el.addEventListener('click',function(e){if(e.target===this)this.classList.remove('active');});
});

// â•â•â• SALES DASHBOARD FUNCTIONS â•â•â•
function getCategoryIcon(category) {
  const icons = {'Ù…ÛŒÙ„Ú¯Ø±Ø¯':'ğŸ”©','ØªÛŒØ±Ø¢Ù‡Ù†':'ğŸ—ï¸','ÙˆØ±Ù‚':'ğŸ“„','Ù†Ø¨Ø´ÛŒ':'ğŸ“','Ù„ÙˆÙ„Ù‡':'ğŸš°','Ù†Ø§ÙˆØ¯Ø§Ù†ÛŒ':'ğŸŒŠ','Ù¾Ø±ÙˆÙÛŒÙ„':'ğŸ“','Ù…ÙØªÙˆÙ„':'ğŸ§µ','Ø³Ø§ÛŒØ±':'ğŸ“¦'};
  return icons[category] || 'ğŸ“¦';
}

function updateCategoryFilter() {
  const select = document.getElementById('sales-category-filter');
  if (!select) return;
  const categories = new Set();
  sProducts.forEach(p => categories.add(p.category || 'Ø³Ø§ÛŒØ±'));
  const currentValue = select.value;
  select.innerHTML = '<option value="">Ù‡Ù…Ù‡ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§</option>' +
    [...categories].sort().map(cat => `<option value="${cat}" ${cat === currentValue ? 'selected' : ''}>${cat}</option>`).join('');
}

function renderProductCheckboxes() {
  const container = document.getElementById('sales-product-categories');
  const emptyDiv = document.getElementById('sales-product-empty');
  const totalBadge = document.getElementById('sales-total-products');
  const searchTerm = document.getElementById('sales-product-search')?.value.toLowerCase() || '';
  const categoryFilter = document.getElementById('sales-category-filter')?.value || '';
  if (!container) return;
  let filtered = [...sProducts];
  if (searchTerm) filtered = filtered.filter(p => p.name.toLowerCase().includes(searchTerm) || (p.desc||'').toLowerCase().includes(searchTerm) || (p.category||'Ø³Ø§ÛŒØ±').toLowerCase().includes(searchTerm));
  if (categoryFilter) filtered = filtered.filter(p => (p.category||'Ø³Ø§ÛŒØ±') === categoryFilter);
  if (filtered.length === 0) {
    container.style.display = 'none'; emptyDiv.style.display = 'block';
    totalBadge.textContent = '0 Ù…Ø­ØµÙˆÙ„'; return;
  }
  container.style.display = 'block'; emptyDiv.style.display = 'none';
  totalBadge.textContent = `${filtered.length} Ù…Ø­ØµÙˆÙ„`;
  const categories = {};
  filtered.forEach(product => {
    const cat = product.category || 'Ø³Ø§ÛŒØ±';
    if (!categories[cat]) categories[cat] = [];
    categories[cat].push(product);
  });
  container.innerHTML = Object.entries(categories).map(([catName, products]) => {
    const catIcon = getCategoryIcon(catName);
    const productsHtml = products.map(product => {
      const priceCount = sPrices.filter(p => p.product === product.name).length;
      const isChecked = selectedProducts.has(product.name);
      const safe = product.name.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
      return `<div class="product-checkbox-item ${isChecked ? 'selected' : ''}" onclick="toggleProduct('${safe}')">
        <input type="checkbox" ${isChecked ? 'checked' : ''} onclick="event.stopPropagation(); toggleProduct('${safe}')">
        <label class="product-checkbox-label">
          <span class="product-icon">${product.icon||'ğŸ“¦'}</span>
          <span style="flex:1;">${product.name}</span>
          <span class="product-price-count">${priceCount} Ù‚ÛŒÙ…Øª</span>
        </label>
      </div>`;
    }).join('');
    return `<div class="product-category-section">
      <div class="category-header" onclick="toggleCategory(this)">
        <div class="category-header-left">
          <span class="category-icon">${catIcon}</span>
          <span class="category-name">${catName}</span>
          <span class="category-count">${products.length} Ù…Ø­ØµÙˆÙ„</span>
        </div>
        <span class="category-toggle">â–¼</span>
      </div>
      <div class="category-products">${productsHtml}</div>
    </div>`;
  }).join('');
  updateCategoryFilter();
}

function toggleCategory(header) {
  header.classList.toggle('collapsed');
  header.nextElementSibling.classList.toggle('collapsed');
}

function toggleProduct(productName) {
  if (selectedProducts.has(productName)) selectedProducts.delete(productName);
  else selectedProducts.add(productName);
  renderProductCheckboxes();
  renderSalesPriceTables();
}

function selectAllProducts() {
  const searchTerm = document.getElementById('sales-product-search')?.value.toLowerCase() || '';
  const categoryFilter = document.getElementById('sales-category-filter')?.value || '';
  let products = [...sProducts];
  if (searchTerm) products = products.filter(p => p.name.toLowerCase().includes(searchTerm));
  if (categoryFilter) products = products.filter(p => (p.category||'Ø³Ø§ÛŒØ±') === categoryFilter);
  products.forEach(p => selectedProducts.add(p.name));
  renderProductCheckboxes(); renderSalesPriceTables();
}

function deselectAllProducts() {
  selectedProducts.clear();
  renderProductCheckboxes(); renderSalesPriceTables();
}

function filterSalesProducts() { renderProductCheckboxes(); }

function refreshSalesDashboard() {
  renderProductCheckboxes(); renderSalesPriceTables();
  sShowToast('Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ÙØ±ÙˆØ´ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯','ğŸ”„');
}

function renderSalesPriceTables() {
  const container = document.getElementById('sales-price-tables');
  const emptyState = document.getElementById('sales-empty-state');
  const selectedInfo = document.getElementById('sales-selected-info');
  const selectedCount = document.getElementById('sales-selected-count');
  if (!container) return;
  if (selectedProducts.size === 0) {
    container.innerHTML = ''; emptyState.style.display = 'block'; selectedInfo.style.display = 'none'; return;
  }
  emptyState.style.display = 'none'; selectedInfo.style.display = 'flex';
  selectedCount.textContent = selectedProducts.size;
  const tables = [];
  selectedProducts.forEach(productName => {
    const product = sProducts.find(p => p.name === productName);
    if (!product) return;
    const productPrices = sPrices.filter(p => p.product === productName);
    if (productPrices.length === 0) {
      tables.push(`<div class="card sales-price-table-wrapper">
        <div class="sales-table-header">
          <div class="sales-table-title"><span>${product.icon||'ğŸ“¦'}</span><span>${product.name}</span></div>
          <div class="sales-table-meta"><span class="chip chip-gray">Û° Ù‚ÛŒÙ…Øª</span></div>
        </div>
        <div class="sales-table-content"><div class="empty" style="padding:40px;"><div class="empty-text">Ù‡Ù†ÙˆØ² Ù‚ÛŒÙ…ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</div></div></div>
      </div>`);
      return;
    }
    const priceMap = {};
    productPrices.forEach(p => {
      const key = `${p.size}-${p.factory}`;
      if (!priceMap[key] || new Date(p.updatedAt) > new Date(priceMap[key].updatedAt)) priceMap[key] = p;
    });
    const latestPrices = Object.values(priceMap).sort((a,b) => new Date(b.updatedAt)-new Date(a.updatedAt));
    const avgPrice = Math.round(latestPrices.reduce((s,p) => s+p.price, 0) / latestPrices.length);
    const minPrice = Math.min(...latestPrices.map(p => p.price));
    const maxPrice = Math.max(...latestPrices.map(p => p.price));
    const rows = latestPrices.map(p => {
      const d = new Date(p.updatedAt);
      const dateStr = d.toLocaleDateString('fa-IR');
      const timeStr = d.toLocaleTimeString('fa-IR',{hour:'2-digit',minute:'2-digit'});
      let changeTxt = '<span class="change-flat">â€”</span>';
      if (p.prevPrice !== null && p.prevPrice !== undefined) {
        const diff = p.price - p.prevPrice;
        const pct = ((diff/p.prevPrice)*100).toFixed(1);
        if (diff > 0) changeTxt = `<span class="change-up">â–² ${pct}%</span>`;
        else if (diff < 0) changeTxt = `<span class="change-down">â–¼ ${Math.abs(pct)}%</span>`;
        else changeTxt = '<span class="change-flat">Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±</span>';
      }
      let priceStyle = '';
      if (latestPrices.length > 1) {
        if (p.price === minPrice) priceStyle = 'color:#059669;font-weight:900;';
        else if (p.price === maxPrice) priceStyle = 'color:#dc2626;font-weight:900;';
      }
      return `<tr>
        <td><strong>${p.size}</strong></td>
        <td>${p.factory}</td>
        <td><div class="price-cell" style="${priceStyle}">${Number(p.price).toLocaleString('fa-IR')}${p.price===minPrice&&latestPrices.length>1?' ğŸŸ¢':''}${p.price===maxPrice&&latestPrices.length>1?' ğŸ”´':''}</div><div class="price-unit">ØªÙˆÙ…Ø§Ù† / Ú©ÛŒÙ„Ùˆ</div></td>
        <td>${changeTxt}</td>
        <td><div class="update-badge"><span class="date">${dateStr}</span><span>${timeStr}</span></div></td>
        <td style="max-width:140px;font-size:12px;color:var(--text-light);">${p.note||'â€”'}</td>
      </tr>`;
    }).join('');
    tables.push(`<div class="card sales-price-table-wrapper">
      <div class="sales-table-header">
        <div class="sales-table-title"><span>${product.icon||'ğŸ“¦'}</span><span>${product.name}</span></div>
        <div class="sales-table-meta"><span class="chip chip-green">${latestPrices.length} Ù‚ÛŒÙ…Øª</span><span>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†: ${avgPrice.toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†</span></div>
      </div>
      <div class="sales-table-content">
        <div class="table-wrap">
          <table class="data-table">
            <thead><tr><th>Ø³Ø§ÛŒØ²</th><th>Ú©Ø§Ø±Ø®Ø§Ù†Ù‡</th><th>Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†/Ú©ÛŒÙ„Ùˆ)</th><th>ØªØºÛŒÛŒØ±</th><th>Ø¢Ø®Ø±ÛŒÙ† Ø¢Ù¾Ø¯ÛŒØª</th><th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      </div>
    </div>`);
  });
  container.innerHTML = tables.join('');
}

// â•â•â• ANALYTICS â•â•â•
function setPeriod(days,el){
  sChartPeriod=days;
  document.querySelectorAll('.period-tab').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  const labels={7:'Û· Ø±ÙˆØ² Ú¯Ø°Ø´ØªÙ‡',14:'Û±Û´ Ø±ÙˆØ² Ú¯Ø°Ø´ØªÙ‡',30:'Û³Û° Ø±ÙˆØ² Ú¯Ø°Ø´ØªÙ‡'};
  document.getElementById('chart-range-label').textContent=labels[days]||'';
  renderAnalytics();
}

let _trendChart,_pieChart,_barChart,_freqChart;

function renderAnalytics(){
  const filterProd=document.getElementById('chart-product-filter')?.value||'';
  const filterFact=document.getElementById('chart-factory-filter')?.value||'';
  let data=[...sPrices];
  if (filterProd) data=data.filter(p=>p.product===filterProd);
  if (filterFact) data=data.filter(p=>p.factory===filterFact);
  const days=sChartPeriod;
  const trendDates=[];const today=new Date();today.setHours(0,0,0,0);
  for (let i=days-1;i>=0;i--){const d=new Date(today);d.setDate(today.getDate()-i);trendDates.push(d);}
  const prods=[...new Set(data.map(p=>p.product))].slice(0,5);
  const palette=['#1e40af','#0891b2','#059669','#7c3aed','#d97706'];
  const trendDatasets=prods.map((prod,i)=>({
    label:prod,
    data:trendDates.map(d=>{const recs=data.filter(p=>p.product===prod&&new Date(p.updatedAt).toDateString()===d.toDateString());return recs.length?Math.round(recs.reduce((s,r)=>s+r.price,0)/recs.length):null;}),
    borderColor:palette[i%palette.length],backgroundColor:'transparent',tension:.4,pointRadius:4,pointBackgroundColor:palette[i%palette.length],spanGaps:true,borderWidth:2
  }));
  const trendLabels=trendDates.map(d=>d.toLocaleDateString('fa-IR',{month:'short',day:'numeric'}));
  const tCtx=document.getElementById('trendChart');
  if (_trendChart) _trendChart.destroy();
  _trendChart=new Chart(tCtx,{type:'line',data:{labels:trendLabels,datasets:trendDatasets.length?trendDatasets:[{label:'Ø¨Ø¯ÙˆÙ† Ø¯Ø§Ø¯Ù‡',data:[],borderColor:'#475569'}]},options:{responsive:true,plugins:{legend:{labels:{color:'#6b7280',font:{family:'Vazirmatn',size:12}}},tooltip:{callbacks:{label:ctx=>`${ctx.dataset.label}: ${Number(ctx.raw||0).toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†`}}},scales:{x:{ticks:{color:'#6b7280'},grid:{color:'#e5e7eb'}},y:{ticks:{color:'#6b7280',callback:v=>Number(v).toLocaleString('fa-IR')},grid:{color:'#e5e7eb'}}}}});
  const prodCounts={};data.forEach(p=>{prodCounts[p.product]=(prodCounts[p.product]||0)+1;});
  const pCtx=document.getElementById('productPieChart');
  if (_pieChart) _pieChart.destroy();
  _pieChart=new Chart(pCtx,{type:'doughnut',data:{labels:Object.keys(prodCounts),datasets:[{data:Object.values(prodCounts),backgroundColor:['#1e40af','#0891b2','#059669','#7c3aed','#d97706','#dc2626','#0e7490'],borderColor:'#ffffff',borderWidth:3}]},options:{responsive:true,cutout:'65%',plugins:{legend:{position:'bottom',labels:{color:'#6b7280',font:{family:'Vazirmatn',size:12},padding:14}},tooltip:{callbacks:{label:ctx=>`${ctx.label}: ${ctx.raw} Ø±Ú©ÙˆØ±Ø¯`}}}}});
  const factAvg={};data.forEach(p=>{if (!factAvg[p.factory]) factAvg[p.factory]={sum:0,cnt:0};factAvg[p.factory].sum+=p.price;factAvg[p.factory].cnt+=1;});
  const facLabels=Object.keys(factAvg);const facVals=facLabels.map(k=>Math.round(factAvg[k].sum/factAvg[k].cnt));
  const bCtx=document.getElementById('factoryBarChart');
  if (_barChart) _barChart.destroy();
  _barChart=new Chart(bCtx,{type:'bar',data:{labels:facLabels,datasets:[{label:'Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†)',data:facVals,backgroundColor:'rgba(30,64,175,.75)',borderColor:'#1e40af',borderWidth:1,borderRadius:6}]},options:{responsive:true,indexAxis:'y',plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>`${Number(ctx.raw).toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†`}}},scales:{x:{ticks:{color:'#6b7280',callback:v=>Number(v).toLocaleString('fa-IR')},grid:{color:'#e5e7eb'}},y:{ticks:{color:'#6b7280'},grid:{color:'#e5e7eb'}}}}});
  const freqMap={};trendDates.forEach(d=>{freqMap[d.toDateString()]=0;});data.forEach(p=>{const ds=new Date(p.updatedAt).toDateString();if (freqMap[ds]!==undefined) freqMap[ds]++;});
  const fCtx=document.getElementById('updateFreqChart');
  if (_freqChart) _freqChart.destroy();
  _freqChart=new Chart(fCtx,{type:'bar',data:{labels:trendLabels,datasets:[{label:'Ø¢Ù¾Ø¯ÛŒØª',data:Object.values(freqMap),backgroundColor:'rgba(8,145,178,.7)',borderColor:'#0891b2',borderWidth:1,borderRadius:4}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#6b7280'},grid:{color:'#e5e7eb'}},y:{ticks:{color:'#6b7280',stepSize:1},grid:{color:'#e5e7eb'}}}}});
  const mmWrap=document.getElementById('minmax-table-wrap');
  if (data.length===0){mmWrap.innerHTML='<div class="empty"><div class="empty-icon">ğŸ“Š</div><div class="empty-text">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</div></div>';return;}
  const mmMap={};data.forEach(p=>{if (!mmMap[p.product]) mmMap[p.product]={min:Infinity,max:-Infinity,cnt:0};mmMap[p.product].min=Math.min(mmMap[p.product].min,p.price);mmMap[p.product].max=Math.max(mmMap[p.product].max,p.price);mmMap[p.product].cnt++;});
  mmWrap.innerHTML=`<table class="data-table"><thead><tr><th>Ù…Ø­ØµÙˆÙ„</th><th>Ø­Ø¯Ø§Ù‚Ù„</th><th>Ø­Ø¯Ø§Ú©Ø«Ø±</th><th>Ø±Ú©ÙˆØ±Ø¯</th></tr></thead><tbody>${Object.entries(mmMap).map(([prod,v])=>`<tr><td>${prod}</td><td style="color:var(--success);font-weight:700;">${Number(v.min).toLocaleString('fa-IR')}</td><td style="color:var(--danger);font-weight:700;">${Number(v.max).toLocaleString('fa-IR')}</td><td><span class="chip chip-gray">${v.cnt}</span></td></tr>`).join('')}</tbody></table>`;
}

function sShowToast(msg,icon='âœ…'){
  const t=document.getElementById('s-toast');
  t.innerHTML=`<span>${icon}</span> ${msg}`;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),3200);
}

// â”€â”€ SUPPLY: Products export/import â”€â”€
function exportProductsJSON() {
  jsonDownload({ type:'supply-products', exportDate:new Date().toISOString(), count:sProducts.length, products:sProducts },
    `Ù…Ø­ØµÙˆÙ„Ø§Øª-ØªØ§Ù…ÛŒÙ†-${new Date().toISOString().split('T')[0]}.json`);
}
function importProductsJSON(event) {
  readJSONFile(event, data => {
    let imported = [];
    if (Array.isArray(data)) imported = data;
    else if (Array.isArray(data.products)) imported = data.products;
    else { alert('âŒ ÙØ±Ù…Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯'); return; }
    if (!confirm(`Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ${imported.length} Ù…Ø­ØµÙˆÙ„ØŸ`)) return;
    const existIds = new Set(sProducts.map(p=>p.id));
    let added=0, updated=0;
    imported.forEach(p => {
      if (existIds.has(p.id)) { const i=sProducts.findIndex(x=>x.id===p.id); sProducts[i]=p; updated++; }
      else { sProducts.push(p); added++; }
    });
    sPersist('products', sProducts);
    sRenderProductsGrid(); sUpdateDropdowns(); sUpdateStats();
    showImportToast(`âœ… ${added} Ø§Ø¶Ø§ÙÙ‡ØŒ ${updated} Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ â€” Ù…Ø­ØµÙˆÙ„Ø§Øª`);
  });
}

// â”€â”€ SUPPLY: Factories export/import â”€â”€
function exportFactoriesJSON() {
  jsonDownload({ type:'supply-factories', exportDate:new Date().toISOString(), count:sFactories.length, factories:sFactories },
    `Ú©Ø§Ø±Ø®Ø§Ù†Ø¬Ø§Øª-${new Date().toISOString().split('T')[0]}.json`);
}
function importFactoriesJSON(event) {
  readJSONFile(event, data => {
    let imported = [];
    if (Array.isArray(data)) imported = data;
    else if (Array.isArray(data.factories)) imported = data.factories;
    else { alert('âŒ ÙØ±Ù…Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯'); return; }
    if (!confirm(`Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ${imported.length} Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ØŸ`)) return;
    const existIds = new Set(sFactories.map(f=>f.id));
    let added=0, updated=0;
    imported.forEach(f => {
      if (existIds.has(f.id)) { const i=sFactories.findIndex(x=>x.id===f.id); sFactories[i]=f; updated++; }
      else { sFactories.push(f); added++; }
    });
    sPersist('factories', sFactories);
    sRenderFactoriesGrid(); sUpdateDropdowns(); sUpdateStats();
    showImportToast(`âœ… ${added} Ø§Ø¶Ø§ÙÙ‡ØŒ ${updated} Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ â€” Ú©Ø§Ø±Ø®Ø§Ù†Ø¬Ø§Øª`);
  });
}

// â”€â”€ SUPPLY: Prices export/import â”€â”€
function exportPricesJSON() {
  jsonDownload({ type:'supply-prices', exportDate:new Date().toISOString(), count:sPrices.length, prices:sPrices },
    `Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§-${new Date().toISOString().split('T')[0]}.json`);
}
function importPricesJSON(event) {
  readJSONFile(event, data => {
    let imported = [];
    if (Array.isArray(data)) imported = data;
    else if (Array.isArray(data.prices)) imported = data.prices;
    // Support old data.json format: {supply:{prices:[...]}}
    else if (data.supply && Array.isArray(data.supply.prices)) imported = data.supply.prices;
    else { alert('âŒ ÙØ±Ù…Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯'); return; }
    if (!confirm(`Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ${imported.length} Ø±Ú©ÙˆØ±Ø¯ Ù‚ÛŒÙ…ØªØŸ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.`)) return;
    const existIds = new Set(sPrices.map(p=>p.id));
    let added=0, updated=0;
    imported.forEach(p => {
      if (existIds.has(p.id)) { const i=sPrices.findIndex(x=>x.id===p.id); sPrices[i]=p; updated++; }
      else { sPrices.push(p); added++; }
    });
    sPersist('prices', sPrices);
    sRenderPriceTable(); sUpdateStats(); sUpdateDropdowns();
    showImportToast(`âœ… ${added} Ø§Ø¶Ø§ÙÙ‡ØŒ ${updated} Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ â€” Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§`);
  });
}

</script>




<!-- LOADING SCRIPT -->
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOADING MODULE â€” Ø­ÙˆØ§Ù„Ù‡ Ø®Ø±ÛŒØ¯ / ÙØ±ÙˆØ´ / Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ / Ø¢Ø±Ø´ÛŒÙˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lDb = null, lFbOk = false;
try { lDb = firebase.database(); lFbOk = true; } catch(e) {}

let lData = { purchase: [], sale: [], loaded: [], archive: [] };

const CONTRACT_TYPES  = ['Ø¬Ø§Ø±ÛŒ','ÙØ±Ø§','Ø¯Ù„Ø§Ø±ÛŒ','ØªÙ‡Ø§ØªØ±'];
const DELIVERIES      = ['Ø¯Ø±Ø¨ Ú©Ø§Ø±Ø®Ø§Ù†Ù‡','Ø¯Ø±Ø¨ Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ Ù…Ø´ØªØ±ÛŒ','Ù…Ø±Ø²','Ù…Ø§Ù‡ÛŒØ±ÙˆØ¯','ÙˆØ²Ù† Ùˆ Ù¾ÙˆÙ„'];
const SETTLEMENTS     = ['ØªÙ‡Ø§ØªØ±','ØªØ³ÙˆÛŒÙ‡','LC','ÙˆØ²Ù† Ùˆ Ù¾ÙˆÙ„','50Ø¯Ø±ØµØ¯ Ø§Ø±Ø¨ÛŒÙ„'];

// â”€â”€ Firebase / localStorage â”€â”€
function lInit() {
  const keys = ['purchase','sale','loaded','archive'];
  if (lFbOk) {
    keys.forEach(key => {
      lDb.ref('loading/' + key).on('value', snap => {
        lData[key] = snap.exists() ? Object.values(snap.val()).filter(Boolean) : [];
        lRender(key);
        lUpdateCount(key);
      });
    });
  } else {
    keys.forEach(key => {
      try { lData[key] = JSON.parse(localStorage.getItem('loading_' + key) || '[]'); } catch(e) { lData[key] = []; }
      lRender(key);
      lUpdateCount(key);
    });
  }
}

function lSave(key) {
  if (lFbOk) {
    const obj = {};
    lData[key].forEach(r => { obj[r.id] = r; });
    lDb.ref('loading/' + key).set(obj).catch(console.error);
  } else {
    localStorage.setItem('loading_' + key, JSON.stringify(lData[key]));
  }
}

// â”€â”€ Row factory â”€â”€
function lNewRow(type) {
  return {
    id: Date.now().toString(36) + Math.random().toString(36).slice(2),
    type, contractNo:'', seller:'', location:'',
    contractType:'Ø¬Ø§Ø±ÛŒ', description:'', delivery:'Ø¯Ø±Ø¨ Ú©Ø§Ø±Ø®Ø§Ù†Ù‡',
    settlement:'ØªØ³ÙˆÛŒÙ‡', qty:'', unitPrice:'', contractDate:'',
    loaded: false, driverName:'', driverInfo:'',
    loadedAt:'', archivedAt:'', createdAt: new Date().toISOString()
  };
}

function lAddRow(type) {
  const row = lNewRow(type);
  lData[type].push(row);
  lSave(type);
  lRender(type);
  lUpdateCount(type);
  // scroll to bottom of table
  setTimeout(() => {
    const el = document.getElementById(type + '-tbody');
    if (el) el.lastElementChild && el.lastElementChild.scrollIntoView({behavior:'smooth', block:'nearest'});
  }, 100);
}

function lDeleteRow(type, id) {
  if (!confirm('Ø­Ø°Ù Ø§ÛŒÙ† Ø±Ø¯ÛŒÙØŸ')) return;
  lData[type] = lData[type].filter(r => r.id !== id);
  lSave(type);
  lRender(type);
  lUpdateCount(type);
}

function lUpdateField(type, id, field, value) {
  const row = lData[type].find(r => String(r.id) === String(id));
  if (!row) return;
  row[field] = value;
  lSave(type);
}

// â”€â”€ Driver modal state â”€â”€
let _driverPending = null;

function lMarkLoaded(type, id, checked) {
  const row = lData[type].find(r => String(r.id) === String(id));
  if (!row) return;
  if (!checked) return; // only move on check, not uncheck

  // Show driver modal instead of prompt
  _driverPending = { type, id: String(row.id) };
  document.getElementById('dm-driver-name').value = row.driverName || '';
  document.getElementById('dm-driver-info').value = row.driverInfo || '';
  document.getElementById('dm-loaded-at').value = row.loadedAt || new Date().toLocaleDateString('fa-IR');
  document.getElementById('driver-modal-subtitle').textContent =
    (type === 'purchase' ? 'ğŸ“¥ Ø­ÙˆØ§Ù„Ù‡ Ø®Ø±ÛŒØ¯' : 'ğŸ“¤ Ø­ÙˆØ§Ù„Ù‡ ÙØ±ÙˆØ´') + ' â€” ' + (row.contractNo || 'Ø¨Ø¯ÙˆÙ† Ø´Ù…Ø§Ø±Ù‡') + ' â€” ' + (row.seller || '');
  document.getElementById('driver-modal').style.display = 'block';
  setTimeout(() => document.getElementById('dm-driver-name').focus(), 100);
}

function driverModalConfirm() {
  if (!_driverPending) return;
  const { type, id } = _driverPending;
  const row = lData[type].find(r => String(r.id) === String(id));
  if (!row) { driverModalCancel(); return; }

  const driverName = document.getElementById('dm-driver-name').value.trim();
  const driverInfo = document.getElementById('dm-driver-info').value.trim();
  const loadedAt   = document.getElementById('dm-loaded-at').value.trim() || new Date().toLocaleDateString('fa-IR');

  const moved = { ...row, loaded: true, driverName, driverInfo, loadedAt };
  lData.loaded.push(moved);
  lData[type] = lData[type].filter(r => r.id !== row.id);
  lSave(type);
  lSave('loaded');
  lRender(type);
  lRender('loaded');
  lUpdateCount(type);
  lUpdateCount('loaded');
  driverModalCancel();
  sShowToast('âœ… Ù…Ù†ØªÙ‚Ù„ Ø¨Ù‡ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø´Ø¯Ù‡â€ŒÙ‡Ø§', 'ğŸš›');
}

function driverModalCancel() {
  document.getElementById('driver-modal').style.display = 'none';
  _driverPending = null;
  // Uncheck the checkbox visually if cancelled
  document.querySelectorAll('.ltable td input[type=checkbox]:checked').forEach(cb => {
    // Only uncheck if in purchase/sale table (not loaded)
    const tbody = cb.closest('tbody');
    if (tbody && (tbody.id === 'purchase-tbody' || tbody.id === 'sale-tbody')) {
      const rowEl = cb.closest('tr');
      if (rowEl && rowEl.classList.contains('row-pending')) cb.checked = false;
    }
  });
}

function lArchiveRow(id) {
  const row = lData.loaded.find(r => String(r.id) === String(id));
  if (!row || !confirm('Ø¢Ø±Ø´ÛŒÙˆ Ø§ÛŒÙ† Ø±Ø¯ÛŒÙØŸ')) return;
  const archived = { ...row, archivedAt: new Date().toLocaleDateString('fa-IR') };
  lData.archive.push(archived);
  lData.loaded = lData.loaded.filter(r => r.id !== row.id);
  lSave('loaded');
  lSave('archive');
  lRender('loaded');
  lRender('archive');
  lUpdateCount('loaded');
  lUpdateCount('archive');
  sShowToast('âœ… Ø¢Ø±Ø´ÛŒÙˆ Ø´Ø¯', 'ğŸ—„ï¸');
}

function lUpdateCount(key) {
  const el = document.getElementById(key + '-count');
  if (el) el.textContent = lData[key].length + ' Ø±Ø¯ÛŒÙ';
}

// â”€â”€ Safe HTML helpers â”€â”€
function esc(v) {
  return String(v || '').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function cellInput(type, row, field, placeholder, extraStyle) {
  const id = String(row.id).replace(/\./g,'_');
  return `<input type="text" 
    value="${esc(row[field])}" 
    placeholder="${esc(placeholder)}" 
    style="${extraStyle||''}" 
    onchange="lUpdateField('${type}','${row.id}','${field}',this.value)">`;
}

function numInput(type, row, field, placeholder) {
  const id = String(row.id).replace(/\./g,'_');
  return `<input type="text" inputmode="numeric"
    value="${esc(row[field])}"
    placeholder="${esc(placeholder)}"
    style="min-width:80px;text-align:left;direction:ltr;"
    onchange="lUpdateField('${type}','${row.id}','${field}',this.value)">`;
}

function selectInput(type, row, field, options) {
  const opts = options.map(o => `<option value="${esc(o)}"${row[field]===o?' selected':''}>${esc(o)}</option>`).join('');
  return `<select onchange="lUpdateField('${type}','${row.id}','${field}',this.value)">${opts}</select>`;
}

function typeBadge(type) {
  return type === 'purchase'
    ? '<span style="background:#dbeafe;color:#1e40af;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:700;">Ø®Ø±ÛŒØ¯</span>'
    : '<span style="background:#fef3c7;color:#d97706;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:700;">ÙØ±ÙˆØ´</span>';
}

// â”€â”€ Render â”€â”€
function lRender(key) {
  if (key === 'purchase' || key === 'sale') {
    const tbody = document.getElementById(key + '-tbody');
    if (!tbody) return;
    const rows = lData[key];
    if (!rows.length) {
      tbody.innerHTML = `<tr><td colspan="12" style="text-align:center;padding:30px;color:#9ca3af;">Ø±Ø¯ÛŒÙÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ â€” Ø§Ø² Ø¯Ú©Ù…Ù‡ â• Ø±Ø¯ÛŒÙ Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯</td></tr>`;
      return;
    }
    tbody.innerHTML = rows.map((row, i) => `<tr class="${row.loaded ? 'row-loaded-check' : 'row-pending'}">
      <td style="text-align:center;color:#9ca3af;font-size:11px;">${i+1}</td>
      <td>${cellInput(key, row, 'contractNo', 'Ø´Ù…Ø§Ø±Ù‡ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯', 'min-width:110px;')}</td>
      <td>${cellInput(key, row, 'seller', 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡', 'min-width:110px;')}</td>
      <td>${cellInput(key, row, 'location', 'Ù…Ø­Ù„ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ', 'min-width:100px;')}</td>
      <td>${selectInput(key, row, 'contractType', CONTRACT_TYPES)}</td>
      <td>${cellInput(key, row, 'description', 'Ø´Ø±Ø­', 'min-width:80px;')}</td>
      <td>${selectInput(key, row, 'delivery', DELIVERIES)}</td>
      <td>${selectInput(key, row, 'settlement', SETTLEMENTS)}</td>
      <td>${numInput(key, row, 'qty', 'Ù…Ù‚Ø¯Ø§Ø± KG')}</td>
      <td>${numInput(key, row, 'unitPrice', 'Ù…Ø¨Ù„Øº ÙˆØ§Ø­Ø¯')}</td>
      <td class="col-date">${cellInput(key, row, 'contractDate', 'ØªØ§Ø±ÛŒØ®', '')}</td>
      <td style="text-align:center;">
        <input type="checkbox" ${row.loaded?'checked':''} 
          style="width:18px;height:18px;cursor:pointer;"
          onchange="lMarkLoaded('${key}','${row.id}',this.checked)">
      </td>
      <td><button class="del-btn" onclick="lDeleteRow('${key}','${row.id}')">ğŸ—‘ï¸</button></td>
    </tr>`).join('');
  }

  if (key === 'loaded') {
    const tbody = document.getElementById('loaded-tbody');
    if (!tbody) return;
    const rows = lData.loaded;
    if (!rows.length) {
      tbody.innerHTML = `<tr><td colspan="12" style="text-align:center;padding:30px;color:#9ca3af;">Ù‡ÛŒÚ† Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒâ€ŒØ§ÛŒ Ù‡Ù†ÙˆØ² Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</td></tr>`;
      return;
    }
    tbody.innerHTML = rows.map((row, i) => `<tr>
      <td style="text-align:center;color:#9ca3af;font-size:11px;">${i+1}</td>
      <td>${typeBadge(row.type)}</td>
      <td>${cellInput('loaded', row, 'contractNo', 'Ø´Ù…Ø§Ø±Ù‡ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯','min-width:100px;')}</td>
      <td>${cellInput('loaded', row, 'seller', 'ÙØ±ÙˆØ´Ù†Ø¯Ù‡','min-width:100px;')}</td>
      <td>${cellInput('loaded', row, 'location', 'Ù…Ø­Ù„ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ','min-width:100px;')}</td>
      <td>${cellInput('loaded', row, 'description', 'Ø´Ø±Ø­','min-width:80px;')}</td>
      <td>${numInput('loaded', row, 'qty', 'Ù…Ù‚Ø¯Ø§Ø±')}</td>
      <td>${numInput('loaded', row, 'unitPrice', 'Ù…Ø¨Ù„Øº')}</td>
      <td>${cellInput('loaded', row, 'driverName', 'Ù†Ø§Ù… Ø±Ø§Ù†Ù†Ø¯Ù‡','min-width:100px;')}</td>
      <td>${cellInput('loaded', row, 'driverInfo', 'Ø´Ù…Ø§Ø±Ù‡ / Ù…Ø´Ø®ØµØ§Øª','min-width:120px;')}</td>
      <td>${cellInput('loaded', row, 'loadedAt', 'ØªØ§Ø±ÛŒØ®','min-width:90px;')}</td>
      <td><button class="arch-btn" onclick="lArchiveRow('${row.id}')">ğŸ—„ï¸ Ø¢Ø±Ø´ÛŒÙˆ</button></td>
    </tr>`).join('');
  }

  if (key === 'archive') {
    const tbody = document.getElementById('archive-tbody');
    if (!tbody) return;
    const rows = lData.archive;
    if (!rows.length) {
      tbody.innerHTML = `<tr><td colspan="12" style="text-align:center;padding:30px;color:#9ca3af;">Ø¢Ø±Ø´ÛŒÙˆÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</td></tr>`;
      return;
    }
    tbody.innerHTML = rows.map((row, i) => `<tr>
      <td style="text-align:center;color:#9ca3af;font-size:11px;">${i+1}</td>
      <td>${typeBadge(row.type)}</td>
      <td>${esc(row.contractNo)||'â€”'}</td>
      <td>${esc(row.seller)||'â€”'}</td>
      <td>${esc(row.location)||'â€”'}</td>
      <td>${esc(row.description)||'â€”'}</td>
      <td style="direction:ltr;text-align:left;">${esc(row.qty)||'â€”'}</td>
      <td style="direction:ltr;text-align:left;">${esc(row.unitPrice)||'â€”'}</td>
      <td>${esc(row.driverName)||'â€”'}</td>
      <td>${esc(row.driverInfo)||'â€”'}</td>
      <td>${esc(row.loadedAt)||'â€”'}</td>
      <td>${esc(row.archivedAt)||'â€”'}</td>
    </tr>`).join('');
  }
}

function lTab(key, el) {
  document.querySelectorAll('.loading-section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.loading-tab').forEach(b => b.classList.remove('active'));
  document.getElementById('loading-' + key).classList.add('active');
  el.classList.add('active');
}

// â”€â”€ Excel Export â”€â”€
function lExportExcel(key) {
  const data = lData[key];
  if (!data.length) { sShowToast('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', 'âš ï¸'); return; }
  const wb = XLSX.utils.book_new();
  const sheetNames = { purchase:'Ø­ÙˆØ§Ù„Ù‡ Ø®Ø±ÛŒØ¯', sale:'Ø­ÙˆØ§Ù„Ù‡ ÙØ±ÙˆØ´', loaded:'Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø´Ø¯Ù‡', archive:'Ø¢Ø±Ø´ÛŒÙˆ' };
  const fileNames  = { purchase:'Ø­ÙˆØ§Ù„Ù‡-Ø®Ø±ÛŒØ¯', sale:'Ø­ÙˆØ§Ù„Ù‡-ÙØ±ÙˆØ´', loaded:'Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ-Ø´Ø¯Ù‡', archive:'Ø¢Ø±Ø´ÛŒÙˆ' };

  let headers, rows;
  if (key === 'purchase' || key === 'sale') {
    headers = ['#','Ø´Ù…Ø§Ø±Ù‡ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯','ÙØ±ÙˆØ´Ù†Ø¯Ù‡','Ù…Ø­Ù„ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ','Ù†ÙˆØ¹ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯','Ø´Ø±Ø­','Ù†Ø­ÙˆÙ‡ ØªØ­ÙˆÛŒÙ„','Ù†Ø­ÙˆÙ‡ ØªØ³ÙˆÛŒÙ‡','Ù…Ù‚Ø¯Ø§Ø± KG','Ù…Ø¨Ù„Øº ÙˆØ§Ø­Ø¯','ØªØ§Ø±ÛŒØ®','ÙˆØ¶Ø¹ÛŒØª'];
    rows = data.map((r,i) => [i+1, r.contractNo, r.seller, r.location, r.contractType, r.description, r.delivery, r.settlement, r.qty, r.unitPrice, r.contractDate||'', r.loaded?'Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø´Ø¯':'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±']);
  } else if (key === 'loaded') {
    headers = ['#','Ù†ÙˆØ¹','Ø´Ù…Ø§Ø±Ù‡ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯','ÙØ±ÙˆØ´Ù†Ø¯Ù‡','Ù…Ø­Ù„ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ','Ø´Ø±Ø­','Ù…Ù‚Ø¯Ø§Ø± KG','Ù…Ø¨Ù„Øº ÙˆØ§Ø­Ø¯','Ù†Ø§Ù… Ø±Ø§Ù†Ù†Ø¯Ù‡','Ø´Ù…Ø§Ø±Ù‡/Ù…Ø´Ø®ØµØ§Øª Ø±Ø§Ù†Ù†Ø¯Ù‡','ØªØ§Ø±ÛŒØ® Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ'];
    rows = data.map((r,i) => [i+1, r.type==='purchase'?'Ø®Ø±ÛŒØ¯':'ÙØ±ÙˆØ´', r.contractNo, r.seller, r.location, r.description, r.qty, r.unitPrice, r.driverName, r.driverInfo, r.loadedAt]);
  } else {
    headers = ['#','Ù†ÙˆØ¹','Ø´Ù…Ø§Ø±Ù‡ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯','ÙØ±ÙˆØ´Ù†Ø¯Ù‡','Ù…Ø­Ù„ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ','Ø´Ø±Ø­','Ù…Ù‚Ø¯Ø§Ø± KG','Ù…Ø¨Ù„Øº ÙˆØ§Ø­Ø¯','Ù†Ø§Ù… Ø±Ø§Ù†Ù†Ø¯Ù‡','Ø´Ù…Ø§Ø±Ù‡/Ù…Ø´Ø®ØµØ§Øª','ØªØ§Ø±ÛŒØ® Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ','ØªØ§Ø±ÛŒØ® Ø¢Ø±Ø´ÛŒÙˆ'];
    rows = data.map((r,i) => [i+1, r.type==='purchase'?'Ø®Ø±ÛŒØ¯':'ÙØ±ÙˆØ´', r.contractNo, r.seller, r.location, r.description, r.qty, r.unitPrice, r.driverName, r.driverInfo, r.loadedAt, r.archivedAt]);
  }

  // Style header row
  const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
  ws['!cols'] = headers.map((_,i) => ({ wch: i===0 ? 5 : 18 }));
  const range = XLSX.utils.decode_range(ws['!ref']);
  for (let C = range.s.c; C <= range.e.c; C++) {
    const cell = XLSX.utils.encode_cell({r:0, c:C});
    if (!ws[cell]) continue;
    ws[cell].s = {
      font: {bold:true, color:{rgb:'FFFFFF'}, name:'Arial', sz:11},
      fill: {fgColor:{rgb: key==='purchase'?'1E40AF': key==='sale'?'D97706': key==='loaded'?'059669':'6B7280'}, patternType:'solid'},
      alignment: {horizontal:'center', vertical:'center'}
    };
  }
  XLSX.utils.book_append_sheet(wb, ws, sheetNames[key]);
  XLSX.writeFile(wb, fileNames[key] + '-' + new Date().toISOString().split('T')[0] + '.xlsx');
  sShowToast('âœ… Ø§Ú©Ø³Ù„ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯', 'ğŸ“Š');
}

// â”€â”€ JSON Export â”€â”€
function lExportJSON(key) {
  if (!lData[key].length) { sShowToast('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', 'âš ï¸'); return; }
  jsonDownload({ type:'loading-'+key, exportDate:new Date().toISOString(), count:lData[key].length, data:lData[key] },
    'loading-' + key + '-' + new Date().toISOString().split('T')[0] + '.json');
  sShowToast('âœ… JSON Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯', 'ğŸ“¥');
}

// â”€â”€ JSON Import â”€â”€
function lImportJSON(event, key) {
  readJSONFile(event, imported => {
    let rows = [];
    if (Array.isArray(imported)) rows = imported;
    else if (Array.isArray(imported.data)) rows = imported.data;
    else { alert('âŒ ÙØ±Ù…Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯'); return; }
    if (!confirm('Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ' + rows.length + ' Ø±Ø¯ÛŒÙØŸ')) return;
    const existIds = new Set(lData[key].map(r => r.id));
    let added = 0, updated = 0;
    rows.forEach(r => {
      if (existIds.has(r.id)) { const i = lData[key].findIndex(x => x.id === r.id); lData[key][i] = r; updated++; }
      else { lData[key].push(r); added++; }
    });
    lSave(key);
    lRender(key);
    lUpdateCount(key);
    sShowToast('âœ… ' + added + ' Ø§Ø¶Ø§ÙÙ‡ØŒ ' + updated + ' Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ', 'ğŸ“‚');
  });
}

// â”€â”€ Init when module activates â”€â”€
const _origSwitchModule = switchModule;
window.switchModule = function(mod) {
  _origSwitchModule(mod);
  if (mod === 'loading' && !window._loadingInited) {
    window._loadingInited = true;
    lInit();
  }
};
</script>


</body>
</html>
