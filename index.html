<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ŸæŸÑÿ™ŸÅÿ±ŸÖ ŸÖÿØ€åÿ±€åÿ™ ‚Äî ÿ¥ÿ±⁄©ÿ™ ÿ®ÿßÿ≤ÿ±⁄ØÿßŸÜ€å ŸÅŸàŸÑÿßÿØ</title>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
<style>
:root {
  --primary: #1e40af; --primary-dark: #1e3a8a; --secondary: #0891b2;
  --success: #059669; --warning: #d97706; --danger: #dc2626;
  --purple: #7c3aed; --dark: #1f2937; --light: #f3f4f6;
  --white: #ffffff; --border: #e5e7eb; --text: #374151; --text-light: #6b7280;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Vazirmatn',sans-serif; background:linear-gradient(135deg,#f0f9ff,#e0f2fe); color:var(--text); line-height:1.6; min-height:100vh; padding-top:64px; }

/* MASTER NAV */
.master-nav { position:fixed; top:0; left:0; right:0; z-index:500; background:linear-gradient(135deg,var(--primary-dark),var(--primary)); box-shadow:0 4px 24px rgba(30,64,175,.35); padding:0 32px; display:flex; align-items:stretch; height:64px; gap:0; }
.master-logo { display:flex; align-items:center; gap:12px; padding-left:28px; border-left:1px solid rgba(255,255,255,.15); margin-left:8px; }
.master-logo-icon { font-size:26px; }
.master-logo-text { font-size:16px; font-weight:900; color:white; }
.master-logo-sub { font-size:11px; color:rgba(255,255,255,.65); margin-top:1px; }
.master-module-btn { display:flex; align-items:center; gap:10px; padding:0 24px; border:none; background:transparent; color:rgba(255,255,255,.75); font-family:'Vazirmatn',sans-serif; font-size:15px; font-weight:600; cursor:pointer; transition:all .25s; border-bottom:3px solid transparent; margin-bottom:-3px; }
.master-module-btn:hover { color:white; background:rgba(255,255,255,.08); }
.master-module-btn.active { color:white; border-bottom-color:white; background:rgba(255,255,255,.12); }
.master-module-btn .m-icon { font-size:20px; }
.master-module-btn .m-badge { background:rgba(255,255,255,.2); font-size:10px; padding:2px 7px; border-radius:10px; font-weight:700; }
.master-module-btn.active .m-badge { background:rgba(255,255,255,.35); }
.master-spacer { flex:1; }
.master-meta { display:flex; align-items:center; gap:10px; padding-right:12px; }
.master-user-badge { display:flex; align-items:center; gap:7px; background:rgba(255,255,255,.15); padding:6px 14px; border-radius:20px; font-size:13px; font-weight:600; color:white; }
.master-clock { background:rgba(255,255,255,.1); padding:6px 14px; border-radius:20px; font-size:12px; color:rgba(255,255,255,.8); }
.master-logout { background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.3); color:white; padding:6px 14px; border-radius:8px; font-family:'Vazirmatn',sans-serif; font-size:13px; font-weight:600; cursor:pointer; transition:all .25s; }
.master-logout:hover { background:rgba(255,255,255,.28); }
.master-nav.login-mode .master-module-btn { opacity:.4; pointer-events:none; }

/* MODULE PANELS */
.module-panel { display:none; }
.module-panel.active { display:block; }

/* LOGIN */
.login-overlay { position:fixed; inset:0; background:linear-gradient(135deg,#1e3a8a,#1e40af,#0891b2); display:flex; align-items:center; justify-content:center; z-index:9999; }
.login-box { background:white; border-radius:24px; padding:50px 40px; width:420px; max-width:95vw; box-shadow:0 30px 80px rgba(0,0,0,.4); text-align:center; animation:slideUp .5s ease-out; }
.login-logo { font-size:56px; margin-bottom:10px; }
.login-title { font-size:26px; font-weight:900; color:var(--dark); margin-bottom:6px; }
.login-subtitle { font-size:14px; color:var(--text-light); margin-bottom:30px; }
.login-form .form-group { margin-bottom:20px; text-align:right; }
.login-form label { display:block; font-weight:600; margin-bottom:8px; color:var(--dark); font-size:14px; }
.login-form select, .login-form input { width:100%; padding:14px 16px; border:2px solid var(--border); border-radius:12px; font-family:'Vazirmatn',sans-serif; font-size:15px; transition:border-color .3s; }
.login-form select:focus, .login-form input:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(30,64,175,.1); }
.login-btn { width:100%; padding:16px; background:linear-gradient(135deg,var(--primary),var(--primary-dark)); color:white; border:none; border-radius:12px; font-family:'Vazirmatn',sans-serif; font-size:17px; font-weight:700; cursor:pointer; transition:all .3s; box-shadow:0 6px 20px rgba(30,64,175,.4); }
.login-btn:hover { transform:translateY(-2px); box-shadow:0 10px 30px rgba(30,64,175,.5); }
.login-error { background:#fee2e2; color:#dc2626; padding:12px 16px; border-radius:10px; font-size:14px; font-weight:600; margin-bottom:20px; display:none; }

/* MAIN APP */
.app-container { max-width:1600px; margin:0 auto; padding:20px; }
.header { background:linear-gradient(135deg,var(--primary),var(--primary-dark)); color:white; padding:25px 40px; border-radius:20px; margin-bottom:25px; box-shadow:0 10px 40px rgba(30,64,175,.3); display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:15px; }
.header-left h1 { font-size:26px; font-weight:900; margin-bottom:4px; }
.header-left p { font-size:14px; opacity:.85; }
.header-right { display:flex; align-items:center; gap:15px; flex-wrap:wrap; }
.manager-badge { background:rgba(255,255,255,.2); padding:10px 18px; border-radius:30px; font-size:14px; font-weight:700; display:flex; align-items:center; gap:8px; }
.status-badge { background:rgba(255,255,255,.15); padding:8px 15px; border-radius:20px; font-size:13px; font-weight:600; display:flex; align-items:center; gap:7px; }
#status-dot { width:9px; height:9px; border-radius:50%; background:#ef4444; }
.logout-btn { background:rgba(255,255,255,.2); color:white; border:2px solid rgba(255,255,255,.4); padding:8px 16px; border-radius:10px; font-family:'Vazirmatn',sans-serif; font-size:14px; font-weight:600; cursor:pointer; transition:all .3s; }
.logout-btn:hover { background:rgba(255,255,255,.35); }

/* NAV TABS */
.nav-tabs { display:flex; gap:12px; margin-bottom:25px; background:white; padding:12px; border-radius:15px; box-shadow:0 4px 20px rgba(0,0,0,.05); flex-wrap:wrap; }
.nav-tab { flex:1; min-width:160px; padding:13px 20px; background:var(--light); border:none; border-radius:10px; font-family:'Vazirmatn',sans-serif; font-size:15px; font-weight:600; color:var(--text); cursor:pointer; transition:all .3s; }
.nav-tab:hover { background:var(--primary); color:white; transform:translateY(-2px); }
.nav-tab.active { background:var(--primary); color:white; box-shadow:0 5px 15px rgba(30,64,175,.3); }
.nav-tab.shared-tab { border:2px solid #f59e0b; }
.nav-tab.shared-tab.active { background:linear-gradient(135deg,#d97706,#b45309); border-color:transparent; }
.nav-tab.shared-tab:hover:not(.active) { background:#fef3c7; color:#d97706; }

/* SECTIONS */
.section { display:none; animation:fadeIn .4s ease-out; }
.section.active { display:block; }

/* CARDS */
.card { background:white; border-radius:16px; padding:28px; margin-bottom:22px; box-shadow:0 4px 20px rgba(0,0,0,.06); }
.card-title { font-size:21px; font-weight:700; color:var(--dark); margin-bottom:20px; display:flex; align-items:center; gap:10px; }

/* SHARED DASHBOARD */
.shared-dashboard-header { background:linear-gradient(135deg,#fef3c7,#fde68a); border:2px solid #f59e0b; border-radius:16px; padding:20px 25px; margin-bottom:25px; display:flex; align-items:center; gap:15px; }
.shared-dashboard-header .icon { font-size:36px; }
.shared-dashboard-header h3 { font-size:20px; font-weight:900; color:#92400e; }
.shared-dashboard-header p { font-size:14px; color:#78350f; margin-top:4px; }
.summary-stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-bottom:30px; }
.stat-card-eval { border-radius:14px; padding:22px; text-align:center; transition:transform .2s; }
.stat-card-eval:hover { transform:translateY(-3px); }
.stat-card-eval.blue { background:linear-gradient(135deg,#dbeafe,#bfdbfe); border:2px solid #93c5fd; }
.stat-card-eval.green { background:linear-gradient(135deg,#d1fae5,#a7f3d0); border:2px solid #6ee7b7; }
.stat-card-eval.orange { background:linear-gradient(135deg,#fef3c7,#fde68a); border:2px solid #fcd34d; }
.stat-card-eval.purple { background:linear-gradient(135deg,#ede9fe,#ddd6fe); border:2px solid #c4b5fd; }
.stat-number { font-size:38px; font-weight:900; margin-bottom:4px; }
.stat-card-eval.blue .stat-number { color:#1d4ed8; }
.stat-card-eval.green .stat-number { color:#059669; }
.stat-card-eval.orange .stat-number { color:#d97706; }
.stat-card-eval.purple .stat-number { color:#7c3aed; }
.stat-label { font-size:13px; font-weight:600; color:var(--text-light); }

/* RANKING TABLE */
.ranking-table { width:100%; border-collapse:collapse; margin-top:15px; border-radius:12px; overflow:hidden; }
.ranking-table thead tr { background:linear-gradient(135deg,var(--primary),var(--primary-dark)); }
.ranking-table th { color:white; padding:14px 16px; text-align:right; font-weight:700; font-size:14px; }
.ranking-table td { padding:13px 16px; border-bottom:1px solid var(--border); font-size:14px; }
.ranking-table tbody tr:hover { background:#f0f9ff; }
.ranking-table tbody tr:last-child td { border-bottom:none; }
.rank-1 td { background:linear-gradient(135deg,#fef9c3,#fef08a) !important; }
.rank-2 td { background:linear-gradient(135deg,#f3f4f6,#e5e7eb) !important; }
.rank-3 td { background:linear-gradient(135deg,#fed7aa,#fdba74) !important; }
.progress-bar-wrap { background:#e5e7eb; border-radius:20px; height:10px; min-width:100px; }
.progress-bar-fill { height:100%; border-radius:20px; transition:width .6s ease; }

/* FORMS */
.form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:18px; margin-bottom:22px; }
.form-group { display:flex; flex-direction:column; gap:8px; }
.form-group label { font-weight:600; color:var(--dark); font-size:14px; }
.form-group input, .form-group select { padding:12px 15px; border:2px solid var(--border); border-radius:10px; font-family:'Vazirmatn',sans-serif; font-size:15px; transition:all .3s; background:var(--white); }
.form-group input:focus, .form-group select:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(30,64,175,.1); }

/* EVAL */
.department-badge { display:inline-block; padding:8px 16px; border-radius:20px; font-weight:700; font-size:14px; margin-bottom:18px; }
.dept-sales { background:linear-gradient(135deg,#059669,#047857); color:white; }
.dept-operations { background:linear-gradient(135deg,#0891b2,#0e7490); color:white; }
.dept-hr { background:linear-gradient(135deg,#7c3aed,#6d28d9); color:white; }
.dept-finance { background:linear-gradient(135deg,#d97706,#b45309); color:white; }
.dept-it { background:linear-gradient(135deg,#dc2626,#b91c1c); color:white; }
.dept-production { background:linear-gradient(135deg,#1e40af,#1e3a8a); color:white; }
.evaluation-sections { display:grid; gap:18px; }
.eval-section { background:linear-gradient(135deg,#fef3c7,#fde68a); border-radius:12px; padding:20px; border:2px solid #fbbf24; }
.eval-section-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
.eval-section-title { font-weight:700; font-size:17px; color:var(--dark); }
.eval-weight { background:var(--warning); color:white; padding:5px 14px; border-radius:20px; font-weight:700; font-size:13px; }
.score-slider-container { display:flex; align-items:center; gap:14px; margin-top:8px; }
.score-slider { flex:1; height:8px; -webkit-appearance:none; appearance:none; background:#e5e7eb; border-radius:5px; outline:none; }
.score-slider::-webkit-slider-thumb { -webkit-appearance:none; width:24px; height:24px; background:var(--primary); cursor:pointer; border-radius:50%; box-shadow:0 2px 8px rgba(30,64,175,.4); transition:all .3s; }
.score-slider::-webkit-slider-thumb:hover { transform:scale(1.2); }
.score-display { min-width:55px; text-align:center; font-weight:700; font-size:20px; color:var(--primary); background:white; padding:7px 12px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.1); }
.weighted-score { font-size:13px; color:var(--text-light); margin-top:4px; }
.total-score-card { background:linear-gradient(135deg,var(--success),#047857); color:white; padding:28px; border-radius:16px; text-align:center; margin-top:22px; box-shadow:0 10px 30px rgba(5,150,105,.3); }
.total-score-label { font-size:17px; font-weight:600; opacity:.9; margin-bottom:8px; }
.total-score-value { font-size:52px; font-weight:900; margin-bottom:8px; }
.total-score-max { font-size:15px; opacity:.8; }

/* BUTTONS */
.btn { padding:13px 28px; border:none; border-radius:10px; font-family:'Vazirmatn',sans-serif; font-size:15px; font-weight:700; cursor:pointer; transition:all .3s; display:inline-flex; align-items:center; gap:8px; box-shadow:0 4px 15px rgba(0,0,0,.1); }
.btn-primary { background:var(--primary); color:white; }
.btn-primary:hover { background:var(--primary-dark); transform:translateY(-2px); }
.btn-success { background:var(--success); color:white; }
.btn-success:hover { background:#047857; transform:translateY(-2px); }
.btn-secondary { background:var(--secondary); color:white; }
.btn-secondary:hover { background:#0e7490; transform:translateY(-2px); }
.btn-warning { background:var(--warning); color:white; }
.btn-danger { background:var(--danger); color:white; }
.btn-danger:hover { background:#b91c1c; }
.btn-purple { background:var(--purple); color:white; }
.btn-ghost { background:var(--light); color:var(--text); border:2px solid var(--border); }
.btn-ghost:hover { background:var(--border); }
.btn-accent { background:linear-gradient(135deg,var(--primary),var(--secondary)); color:white; }
.btn-accent:hover { transform:translateY(-2px); box-shadow:0 8px 20px rgba(30,64,175,.3); }
.btn-sm { padding:8px 15px; font-size:13px; }
.btn-group { display:flex; gap:14px; margin-top:22px; flex-wrap:wrap; }

/* ALERTS */
.alert { padding:14px 18px; border-radius:10px; margin-bottom:18px; font-weight:600; display:flex; align-items:center; gap:10px; font-size:14px; }
.alert-success { background:#d1fae5; color:var(--success); border:2px solid var(--success); }
.alert-info { background:#dbeafe; color:var(--primary); border:2px solid var(--primary); }
.alert-warning { background:#fef3c7; color:var(--warning); border:2px solid var(--warning); }

/* EMPLOYEES */
.employee-list { display:grid; gap:14px; }
.employee-card { background:white; border:2px solid var(--border); border-radius:12px; padding:18px; transition:all .3s; }
.employee-card:hover { border-color:var(--primary); box-shadow:0 4px 15px rgba(30,64,175,.1); }
.employee-header { display:flex; justify-content:space-between; align-items:center; }
.employee-info h3 { font-size:17px; font-weight:700; color:var(--dark); margin-bottom:4px; }
.employee-info p { color:var(--text-light); font-size:13px; }
.employee-score-value { font-size:30px; font-weight:900; color:var(--primary); }
.employee-score-label { font-size:11px; color:var(--text-light); }

/* STAR EMPLOYEES */
.star-employees-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(270px,1fr)); gap:22px; margin-top:22px; }
.star-employee-card { background:white; border:3px solid var(--border); border-radius:16px; padding:24px; text-align:center; transition:all .3s; position:relative; overflow:hidden; }
.star-employee-card:hover { transform:translateY(-5px); box-shadow:0 10px 30px rgba(0,0,0,.15); }
.star-employee-card.rank-1 { border-color:#fbbf24; background:linear-gradient(135deg,#fef3c7,#fde68a); }
.star-employee-card.rank-2 { border-color:#d1d5db; background:linear-gradient(135deg,#f3f4f6,#e5e7eb); }
.star-employee-card.rank-3 { border-color:#f97316; background:linear-gradient(135deg,#fed7aa,#fdba74); }
.star-rank-badge { position:absolute; top:14px; right:14px; width:46px; height:46px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:22px; font-weight:900; color:white; box-shadow:0 4px 10px rgba(0,0,0,.2); }
.star-rank-badge.rank-1 { background:linear-gradient(135deg,#fbbf24,#f59e0b); }
.star-rank-badge.rank-2 { background:linear-gradient(135deg,#9ca3af,#6b7280); }
.star-rank-badge.rank-3 { background:linear-gradient(135deg,#f97316,#ea580c); }
.star-employee-photo { width:110px; height:110px; border-radius:50%; margin:0 auto 14px; border:4px solid white; box-shadow:0 4px 15px rgba(0,0,0,.15); display:flex; align-items:center; justify-content:center; font-size:44px; color:var(--text-light); background:var(--light); }
.star-employee-photo img { width:100%; height:100%; border-radius:50%; object-fit:cover; }
.star-employee-name { font-size:19px; font-weight:700; color:var(--dark); margin-bottom:6px; }
.star-employee-dept { font-size:13px; color:var(--text-light); margin-bottom:14px; }
.star-employee-score { background:white; padding:13px; border-radius:12px; margin-top:14px; }
.star-score-value { font-size:30px; font-weight:900; color:var(--primary); display:block; }
.star-score-label { font-size:12px; color:var(--text-light); }

/* DEPARTMENTS */
.departments-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:18px; margin-top:18px; }
.department-card { background:white; border:2px solid var(--border); border-radius:12px; padding:20px; transition:all .3s; cursor:pointer; }
.department-card:hover { border-color:var(--primary); box-shadow:0 4px 15px rgba(30,64,175,.1); transform:translateY(-3px); }
.department-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:14px; }
.department-name { font-size:19px; font-weight:700; color:var(--dark); }
.criteria-count { background:var(--light); padding:5px 11px; border-radius:15px; font-size:12px; font-weight:600; }
.criteria-list { display:grid; gap:13px; margin-top:18px; }
.criteria-item { background:white; border:2px solid var(--border); border-radius:12px; padding:18px; display:grid; grid-template-columns:1fr 140px 90px; gap:13px; align-items:center; }
.criteria-item:hover { border-color:var(--primary); }
.criteria-name-input, .criteria-weight-input { padding:9px 13px; border:2px solid var(--border); border-radius:8px; font-family:'Vazirmatn',sans-serif; font-size:14px; font-weight:600; }
.criteria-weight-input { text-align:center; }

/* HISTORY TABLE */
.history-table { width:100%; border-collapse:collapse; margin-top:18px; }
.history-table th { background:var(--primary); color:white; padding:13px 15px; text-align:right; font-weight:700; font-size:14px; }
.history-table td { padding:13px 15px; border-bottom:1px solid var(--border); text-align:right; font-size:14px; }
.history-table tr:hover td { background:var(--light); }
.badge { display:inline-block; padding:5px 11px; border-radius:15px; font-size:12px; font-weight:600; }
.badge-high { background:#d1fae5; color:var(--success); }
.badge-medium { background:#fef3c7; color:var(--warning); }
.badge-low { background:#fee2e2; color:var(--danger); }

/* EVAL MODALS */
.eval-modal { display:none; position:fixed; z-index:1000; inset:0; background:rgba(0,0,0,.6); backdrop-filter:blur(5px); }
.eval-modal.active { display:flex; align-items:center; justify-content:center; }
.eval-modal-content { background:white; padding:38px; border-radius:20px; max-width:800px; width:92%; max-height:82vh; overflow-y:auto; animation:slideUp .4s ease-out; }
.modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:22px; }
.modal-title { font-size:22px; font-weight:900; color:var(--dark); }
.modal-close { background:var(--danger); color:white; border:none; width:33px; height:33px; border-radius:50%; cursor:pointer; font-size:19px; display:flex; align-items:center; justify-content:center; transition:all .3s; }
.modal-close:hover { transform:rotate(90deg); background:#b91c1c; }

/* SUPPLY MODALS */
.supply-modal { display:none; position:fixed; z-index:2000; inset:0; background:rgba(0,0,0,.6); backdrop-filter:blur(5px); align-items:center; justify-content:center; }
.supply-modal.active { display:flex; }
.supply-modal-box { background:white; padding:36px; border-radius:20px; max-width:640px; width:92%; max-height:85vh; overflow-y:auto; animation:slideUp .4s ease-out; }

/* EMPLOYEE MGMT */
.employee-mgmt-card { background:white; border:2px solid var(--border); border-radius:12px; padding:20px; display:flex; justify-content:space-between; align-items:center; gap:15px; }
.employee-mgmt-card:hover { border-color:var(--primary); }
.empty-state { text-align:center; padding:55px 20px; color:var(--text-light); }
.empty-state-icon { font-size:60px; margin-bottom:18px; opacity:.5; }
.empty-state h3 { font-size:19px; margin-bottom:8px; color:var(--dark); }

/* SUPPLY MODULE */
.live-badge { display:flex; align-items:center; gap:7px; background:rgba(255,255,255,.15); padding:8px 15px; border-radius:20px; font-size:13px; font-weight:600; color:white; }
.live-dot { width:8px; height:8px; border-radius:50%; background:#4ade80; animation:pulse 2s infinite; }
.clock-badge { background:rgba(255,255,255,.15); padding:8px 15px; border-radius:20px; font-size:13px; color:white; opacity:.9; }

.stat-strip { display:grid; grid-template-columns:repeat(auto-fit,minmax(185px,1fr)); gap:18px; margin-bottom:25px; }
.stat-card { background:white; border-radius:16px; padding:22px 24px; box-shadow:0 4px 20px rgba(0,0,0,.06); transition:all .3s; position:relative; overflow:hidden; border-right:4px solid transparent; }
.stat-card.blue { border-right-color:var(--primary); }
.stat-card.teal { border-right-color:var(--secondary); }
.stat-card.green { border-right-color:var(--success); }
.stat-card.orange { border-right-color:var(--warning); }
.stat-card:hover { transform:translateY(-3px); box-shadow:0 8px 30px rgba(0,0,0,.1); }
.stat-val { font-size:34px; font-weight:900; margin-bottom:4px; }
.stat-card.blue .stat-val { color:var(--primary); }
.stat-card.teal .stat-val { color:var(--secondary); }
.stat-card.green .stat-val { color:var(--success); }
.stat-card.orange .stat-val { color:var(--warning); }
.stat-icon { position:absolute; left:18px; top:50%; transform:translateY(-50%); font-size:34px; opacity:.1; }

#supply-nav { display:flex; gap:12px; flex-wrap:wrap; background:white; padding:12px; border-radius:15px; box-shadow:0 4px 20px rgba(0,0,0,.05); margin-bottom:25px; }
.supply-nav-btn { flex:1; min-width:160px; padding:13px 20px; border:none; border-radius:10px; font-family:'Vazirmatn',sans-serif; font-size:15px; font-weight:600; cursor:pointer; transition:all .3s; color:var(--text); background:var(--light); display:flex; align-items:center; justify-content:center; gap:8px; }
.supply-nav-btn:hover { background:var(--primary); color:white; transform:translateY(-2px); }
.supply-nav-btn.active { background:var(--primary); color:white; box-shadow:0 5px 15px rgba(30,64,175,.3); }
.nav-count { background:rgba(0,0,0,.15); padding:2px 8px; border-radius:10px; font-size:11px; }

.supply-section { display:none; animation:fadeIn .4s ease-out; }
.supply-section.active { display:block; }

.toolbar { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:20px; align-items:center; }
.search-wrap { flex:1; min-width:220px; position:relative; }
.search-wrap .icon { position:absolute; right:14px; top:50%; transform:translateY(-50%); color:var(--text-light); font-size:15px; }
.search-input { width:100%; padding:11px 42px 11px 15px; background:white; border:2px solid var(--border); border-radius:10px; font-family:'Vazirmatn',sans-serif; font-size:14px; color:var(--text); transition:all .3s; }
.search-input:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(30,64,175,.1); }
.filter-select { padding:11px 15px; background:white; border:2px solid var(--border); border-radius:10px; font-family:'Vazirmatn',sans-serif; font-size:14px; color:var(--text); cursor:pointer; min-width:150px; transition:all .3s; }
.filter-select:focus { outline:none; border-color:var(--primary); }

.form-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(210px,1fr)); gap:16px; margin-bottom:18px; }
.form-label { font-size:13px; font-weight:600; color:var(--dark); margin-bottom:6px; display:block; }
.form-input, .form-select { width:100%; padding:11px 14px; background:white; border:2px solid var(--border); border-radius:10px; font-family:'Vazirmatn',sans-serif; font-size:14px; color:var(--text); transition:all .3s; }
.form-input:focus, .form-select:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(30,64,175,.1); }
.form-add-section { background:linear-gradient(135deg,#eff6ff,#dbeafe); border:2px solid #bfdbfe; border-radius:14px; padding:24px; margin-bottom:20px; }

.table-wrap { overflow-x:auto; border-radius:10px; border:1px solid var(--border); }
.data-table { width:100%; border-collapse:collapse; }
.data-table thead tr { background:var(--primary); }
.data-table th { padding:13px 16px; text-align:right; font-size:13px; font-weight:700; color:white; white-space:nowrap; }
.data-table td { padding:13px 16px; text-align:right; border-bottom:1px solid var(--border); font-size:14px; vertical-align:middle; color:var(--text); }
.data-table tbody tr { transition:background .2s; }
.data-table tbody tr:hover { background:#f0f9ff; }
.data-table tbody tr:last-child td { border-bottom:none; }
.data-table .actions { display:flex; gap:6px; justify-content:flex-end; }

.chip { display:inline-flex; align-items:center; gap:5px; padding:4px 12px; border-radius:20px; font-size:12px; font-weight:600; }
.chip-blue { background:#dbeafe; color:var(--primary); }
.chip-teal,.chip-cyan { background:#cffafe; color:var(--secondary); }
.chip-green { background:#d1fae5; color:var(--success); }
.chip-orange,.chip-amber { background:#fef3c7; color:var(--warning); }
.chip-red { background:#fee2e2; color:var(--danger); }
.chip-gray { background:var(--light); color:var(--text-light); border:1px solid var(--border); }

.price-cell { font-weight:700; font-size:15px; color:var(--primary); direction:ltr; text-align:left; }
.price-unit { font-size:11px; color:var(--text-light); font-weight:400; }
.update-badge { display:flex; flex-direction:column; font-size:11px; color:var(--text-light); white-space:nowrap; }
.update-badge .date { color:var(--dark); font-size:12px; font-weight:600; }
.change-up { color:var(--success); font-size:12px; font-weight:700; }
.change-down { color:var(--danger); font-size:12px; font-weight:700; }
.change-flat { color:var(--text-light); font-size:12px; }

.grid-cards { display:grid; grid-template-columns:repeat(auto-fill,minmax(270px,1fr)); gap:18px; margin-top:16px; }
.item-card { background:white; border:2px solid var(--border); border-radius:16px; padding:22px; transition:all .3s; }
.item-card:hover { border-color:var(--primary); box-shadow:0 8px 30px rgba(30,64,175,.1); transform:translateY(-3px); }
.item-card-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:14px; }
.item-card-icon { width:46px; height:46px; border-radius:12px; background:linear-gradient(135deg,#dbeafe,#bfdbfe); display:flex; align-items:center; justify-content:center; font-size:22px; }
.item-card-name { font-size:17px; font-weight:700; color:var(--dark); margin-bottom:5px; }
.item-card-meta { font-size:13px; color:var(--text-light); }
.item-card-actions { display:flex; gap:8px; margin-top:16px; padding-top:16px; border-top:1px solid var(--border); }

.chart-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(400px,1fr)); gap:20px; }
.chart-card { background:white; border-radius:16px; padding:24px; box-shadow:0 4px 20px rgba(0,0,0,.06); }
.chart-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; flex-wrap:wrap; gap:10px; }
.chart-title { font-size:16px; font-weight:700; color:var(--dark); }
.chart-subtitle { font-size:12px; color:var(--text-light); margin-top:3px; }
.period-tabs { display:flex; gap:6px; }
.period-tab { padding:6px 14px; border-radius:8px; font-size:13px; font-weight:600; cursor:pointer; transition:all .2s; border:2px solid var(--border); color:var(--text-light); background:white; font-family:'Vazirmatn',sans-serif; }
.period-tab.active { background:var(--primary); color:white; border-color:var(--primary); }
.period-tab:hover:not(.active) { border-color:var(--primary); color:var(--primary); }

.empty { text-align:center; padding:40px 20px; color:var(--text-light); }
.empty-icon { font-size:48px; margin-bottom:12px; opacity:.4; }
.empty-text { font-size:16px; font-weight:600; color:var(--dark); margin-bottom:6px; }
.empty-sub { font-size:13px; }

.card-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; flex-wrap:wrap; gap:10px; }

/* TOAST */
.s-toast { position:fixed; bottom:28px; left:50%; transform:translateX(-50%) translateY(80px); background:var(--dark); border-radius:30px; padding:12px 26px; font-size:14px; font-weight:600; color:white; box-shadow:0 8px 30px rgba(0,0,0,.3); z-index:9999; transition:transform .4s cubic-bezier(.175,.885,.32,1.275); display:flex; align-items:center; gap:10px; }
.s-toast.show { transform:translateX(-50%) translateY(0); }

/* ANIMATIONS */
@keyframes slideDown { from { opacity:0; transform:translateY(-30px); } to { opacity:1; transform:translateY(0); } }
@keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
@keyframes slideUp { from { opacity:0; transform:translateY(30px); } to { opacity:1; transform:translateY(0); } }
@keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:.5; } }

@media(max-width:768px) {
  .master-nav { padding:0 12px; height:56px; }
  body { padding-top:56px; }
  .master-logo-sub,.master-meta { display:none; }
  .master-module-btn { padding:0 14px; font-size:13px; }
  .master-logo-text { font-size:14px; }
  .nav-tabs,.form-grid { flex-direction:column; }
  .criteria-item { grid-template-columns:1fr; }
  .header { flex-direction:column; align-items:flex-start; }
  .chart-grid { grid-template-columns:1fr; }
}

/* SALES DASHBOARD */
.product-checkbox-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:12px; }
.product-checkbox-item { display:flex; align-items:center; gap:10px; padding:12px 16px; background:white; border:2px solid var(--border); border-radius:10px; cursor:pointer; transition:all .3s; user-select:none; }
.product-checkbox-item:hover { border-color:var(--primary); background:#f0f9ff; transform:translateY(-2px); box-shadow:0 4px 12px rgba(30,64,175,.1); }
.product-checkbox-item.selected { border-color:var(--primary); background:linear-gradient(135deg,#dbeafe,#eff6ff); }
.product-checkbox-item input[type="checkbox"] { width:20px; height:20px; cursor:pointer; accent-color:var(--primary); }
.product-checkbox-label { flex:1; display:flex; align-items:center; gap:8px; font-weight:600; font-size:14px; color:var(--dark); cursor:pointer; }
.product-checkbox-item.selected .product-checkbox-label { color:var(--primary); }
.product-icon { font-size:22px; }
.product-price-count { background:var(--light); padding:4px 10px; border-radius:12px; font-size:11px; font-weight:700; color:var(--text-light); }
.product-checkbox-item.selected .product-price-count { background:var(--primary); color:white; }

.sales-price-table-wrapper { margin-bottom:22px; animation:slideDown .4s ease-out; }
.sales-table-header { background:linear-gradient(135deg,var(--primary),var(--primary-dark)); color:white; padding:16px 20px; border-radius:12px 12px 0 0; display:flex; align-items:center; justify-content:space-between; }
.sales-table-title { display:flex; align-items:center; gap:10px; font-size:17px; font-weight:700; }
.sales-table-meta { display:flex; align-items:center; gap:10px; font-size:13px; opacity:.9; }
.sales-table-content { border:2px solid var(--primary); border-top:none; border-radius:0 0 12px 12px; overflow:hidden; }

.product-category-section { margin-bottom:20px; border:2px solid var(--border); border-radius:12px; overflow:hidden; background:white; }
.category-header { background:linear-gradient(135deg,#f3f4f6,#e5e7eb); padding:12px 16px; display:flex; align-items:center; justify-content:space-between; border-bottom:2px solid var(--border); cursor:pointer; transition:all .3s; }
.category-header:hover { background:linear-gradient(135deg,#e5e7eb,#d1d5db); }
.category-header-left { display:flex; align-items:center; gap:10px; }
.category-icon { font-size:24px; }
.category-name { font-size:15px; font-weight:700; color:var(--dark); }
.category-count { background:white; padding:4px 10px; border-radius:12px; font-size:11px; font-weight:700; color:var(--text-light); }
.category-toggle { font-size:20px; color:var(--text-light); transition:transform .3s; }
.category-header.collapsed .category-toggle { transform:rotate(-90deg); }
.category-products { padding:14px; display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:10px; }
.category-products.collapsed { display:none; }

/* ‚îÄ‚îÄ BACKUP / IMPORT PANEL ‚îÄ‚îÄ */
.io-panel { background:linear-gradient(135deg,#f0fdf4,#dcfce7); border:2px solid #86efac; border-radius:14px; padding:18px 22px; margin-bottom:20px; }
.io-panel.blue { background:linear-gradient(135deg,#eff6ff,#dbeafe); border-color:#93c5fd; }
.io-title { font-size:14px; font-weight:700; color:#166534; margin-bottom:12px; display:flex; align-items:center; gap:7px; }
.io-panel.blue .io-title { color:#1e40af; }
.io-btn-row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
.io-label { display:inline-flex; align-items:center; gap:7px; padding:9px 18px; border-radius:9px; font-family:'Vazirmatn',sans-serif; font-size:14px; font-weight:700; cursor:pointer; transition:all .25s; border:none; }
.io-label.green { background:#059669; color:white; }
.io-label.green:hover { background:#047857; transform:translateY(-1px); }
.io-label.blue { background:#1e40af; color:white; }
.io-label.blue:hover { background:#1e3a8a; transform:translateY(-1px); }
.io-label.orange { background:#d97706; color:white; }
.io-label.orange:hover { background:#b45309; transform:translateY(-1px); }
input[type=file].hidden-file { display:none; }

/* ‚ïê‚ïê‚ïê LOADING MODULE CSS ‚ïê‚ïê‚ïê */
.loading-tabs{display:flex;gap:10px;background:white;padding:10px;border-radius:14px;box-shadow:0 4px 20px rgba(0,0,0,.06);margin-bottom:20px;flex-wrap:wrap;}
.loading-tab{flex:1;min-width:120px;padding:10px 16px;background:#f3f4f6;border:none;border-radius:9px;font-family:'Vazirmatn',sans-serif;font-size:14px;font-weight:700;color:#374151;cursor:pointer;transition:all .25s;}
.loading-tab:hover{background:#e5e7eb;}
.loading-tab.active{color:white;box-shadow:0 4px 14px rgba(30,64,175,.3);}
.loading-tab.blue.active{background:linear-gradient(135deg,#1e40af,#1e3a8a);}
.loading-tab.orange.active{background:linear-gradient(135deg,#d97706,#b45309);}
.loading-tab.green.active{background:linear-gradient(135deg,#059669,#047857);}
.loading-tab.gray.active{background:linear-gradient(135deg,#475569,#334155);}
.loading-section{display:none;}
.loading-section.active{display:block;animation:fadeIn .3s ease-out;}
.ltable-wrap{overflow-x:auto;border-radius:12px;border:1px solid #e5e7eb;margin-top:14px;}
.ltable{width:100%;border-collapse:collapse;font-size:13px;}
.ltable thead tr{background:linear-gradient(135deg,#1e40af,#1e3a8a);}
.ltable.orange thead tr{background:linear-gradient(135deg,#d97706,#b45309);}
.ltable.green thead tr{background:linear-gradient(135deg,#059669,#047857);}
.ltable.gray thead tr{background:linear-gradient(135deg,#475569,#334155);}
.ltable th{color:white;padding:11px 10px;text-align:right;font-weight:700;white-space:nowrap;font-size:12px;}
.ltable td{padding:7px 8px;border-bottom:1px solid #f1f5f9;vertical-align:middle;}
.ltable tbody tr:hover{background:#f8fafc;}
.ltable tbody tr:last-child td{border-bottom:none;}
.ltable td input[type=text],.ltable td input[type=number],.ltable td select{width:100%;padding:5px 7px;border:1.5px solid #e5e7eb;border-radius:6px;font-family:'Vazirmatn',sans-serif;font-size:12px;background:white;transition:border-color .2s;min-width:60px;}
.ltable td input[type=text]:focus,.ltable td input[type=number]:focus,.ltable td select:focus{outline:none;border-color:#1e40af;background:#eff6ff;}
.ltable td input[type=checkbox]{width:17px;height:17px;cursor:pointer;accent-color:#1e40af;}
.ltable td .del-btn{background:#fee2e2;color:#dc2626;border:none;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:12px;font-weight:700;transition:all .2s;}
.ltable td .del-btn:hover{background:#dc2626;color:white;}
.ltable td .arch-btn{background:#e0e7ff;color:#1e40af;border:none;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:12px;font-weight:700;transition:all .2s;}
.ltable td .arch-btn:hover{background:#1e40af;color:white;}
.lcard-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px;}
.lcard-title{font-size:18px;font-weight:900;color:#1f2937;display:flex;align-items:center;gap:8px;}
.lcard-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
.loaded-badge{display:inline-flex;align-items:center;gap:5px;background:#d1fae5;color:#065f46;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:700;}
.table-count{font-size:12px;color:#6b7280;font-weight:600;}

/* ‚îÄ‚îÄ DRIVER MODAL ‚îÄ‚îÄ */
.driver-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:10000;display:flex;align-items:center;justify-content:center;animation:fadeIn .2s;}
.driver-modal{background:white;border-radius:20px;padding:32px;width:860px;max-width:95vw;box-shadow:0 25px 60px rgba(0,0,0,.3);animation:slideDown .3s ease-out;}
.driver-modal h3{font-size:20px;font-weight:900;color:#1f2937;margin-bottom:6px;}
.driver-modal p{font-size:13px;color:#6b7280;margin-bottom:24px;}
.driver-modal .dm-field{margin-bottom:16px;}
.driver-modal .dm-label{font-size:13px;font-weight:700;color:#374151;margin-bottom:6px;display:block;}
.driver-modal .dm-input{width:100%;padding:11px 14px;border:2px solid #e5e7eb;border-radius:10px;font-family:'Vazirmatn',sans-serif;font-size:14px;transition:.2s;}
.driver-modal .dm-input:focus{outline:none;border-color:#1e40af;box-shadow:0 0 0 3px rgba(30,64,175,.1);}
.driver-modal .dm-row{display:flex;gap:10px;margin-top:22px;}
.driver-modal .dm-confirm{flex:1;background:linear-gradient(135deg,#059669,#047857);color:white;border:none;border-radius:10px;padding:12px;font-family:'Vazirmatn',sans-serif;font-size:15px;font-weight:700;cursor:pointer;}
.driver-modal .dm-cancel{background:#f3f4f6;color:#374151;border:none;border-radius:10px;padding:12px 20px;font-family:'Vazirmatn',sans-serif;font-size:14px;font-weight:700;cursor:pointer;}
.driver-modal .dm-confirm:hover{background:linear-gradient(135deg,#047857,#065f46);}
.driver-modal .dm-cancel:hover{background:#e5e7eb;}

/* ‚îÄ‚îÄ TABLE: pending row highlight ‚îÄ‚îÄ */
.ltable tbody tr.row-pending{background:#fefce8;}
.ltable tbody tr.row-pending:hover{background:#fef9c3;}
.ltable tbody tr.row-loaded-check{background:#f0fdf4;}

/* ‚îÄ‚îÄ TABLE: contract date column ‚îÄ‚îÄ */
.ltable th.col-date,.ltable td.col-date{min-width:110px;}

/* ‚îÄ‚îÄ purchase table header ‚îÄ‚îÄ */
.ltable.purchase thead tr{background:linear-gradient(135deg,#1e40af,#1e3a8a);}
.ltable.sale thead tr{background:linear-gradient(135deg,#d97706,#b45309);}

/* ‚ïê‚ïê STATUS BADGE ‚ïê‚ïê */
.status-chip{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:700;white-space:nowrap;}
.status-pending{background:#fef9c3;color:#854d0e;}
.status-loaded{background:#d1fae5;color:#065f46;}
.status-waiting-settle{background:#dbeafe;color:#1e40af;}
.status-announced{background:#e0e7ff;color:#4338ca;}
.status-waiting-scale{background:#fce7f3;color:#9d174d;}
.status-transit{background:#ecfdf5;color:#047857;}

/* ‚ïê‚ïê WAREHOUSE ‚ïê‚ïê */
.wh-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;margin-top:16px;}
.wh-card{background:white;border:2px solid #e5e7eb;border-radius:16px;padding:20px;transition:all .3s;}
.wh-card:hover{border-color:#1e40af;box-shadow:0 8px 25px rgba(30,64,175,.1);}
.wh-card-name{font-size:18px;font-weight:800;color:#1f2937;margin-bottom:6px;}
.wh-card-qty{font-size:28px;font-weight:900;color:#1e40af;direction:ltr;}
.wh-card-unit{font-size:13px;color:#6b7280;font-weight:600;}
.wh-card-commitment{font-size:13px;color:#dc2626;font-weight:700;margin-top:6px;}
.wh-progress{height:8px;background:#e5e7eb;border-radius:4px;margin-top:10px;overflow:hidden;}
.wh-progress-bar{height:100%;background:linear-gradient(90deg,#1e40af,#0891b2);border-radius:4px;transition:width .5s;}

/* ‚ïê‚ïê OVERVIEW MATRIX ‚ïê‚ïê */
.matrix-table{width:100%;border-collapse:collapse;font-size:13px;}
.matrix-table th{background:linear-gradient(135deg,#1e40af,#1e3a8a);color:white;padding:10px 14px;text-align:center;font-weight:700;white-space:nowrap;}
.matrix-table th:first-child{text-align:right;}
.matrix-table td{padding:10px 14px;border-bottom:1px solid #f1f5f9;text-align:center;}
.matrix-table td:first-child{text-align:right;font-weight:700;color:#1f2937;}
.matrix-table tbody tr:hover{background:#f0f9ff;}
.matrix-table tbody tr:last-child td{border-bottom:none;font-weight:800;background:#f8fafc;}
.matrix-buy{color:#059669;font-weight:700;}
.matrix-sell{color:#d97706;font-weight:700;}
.matrix-diff-pos{color:#059669;font-size:11px;}
.matrix-diff-neg{color:#dc2626;font-size:11px;}

/* ‚ïê‚ïê FREIGHT TABLE ‚ïê‚ïê */
.freight-table{width:100%;border-collapse:collapse;}
.freight-table th{background:linear-gradient(135deg,#059669,#047857);color:white;padding:10px 12px;text-align:right;font-weight:700;}
.freight-table td{padding:8px 10px;border-bottom:1px solid #f1f5f9;vertical-align:middle;}
.freight-table tbody tr:hover{background:#f0fdf4;}
.freight-table td input,.freight-table td select{width:100%;padding:5px 7px;border:1.5px solid #d1fae5;border-radius:6px;font-family:'Vazirmatn',sans-serif;font-size:13px;}
.freight-table td input:focus,.freight-table td select:focus{outline:none;border-color:#059669;}

/* ‚ïê‚ïê REMAINING QTY ‚ïê‚ïê */
.qty-remaining{font-size:11px;color:#6b7280;margin-top:2px;}
.qty-danger{color:#dc2626;}
.qty-ok{color:#059669;}

/* ‚ïê‚ïê STATUS SELECT ‚ïê‚ïê */
.status-select{padding:4px 8px;border:1.5px solid #e5e7eb;border-radius:8px;font-family:'Vazirmatn',sans-serif;font-size:12px;cursor:pointer;}

/* ‚ïê‚ïê OVERVIEW PANEL IN NAV ‚ïê‚ïê */
.nav-overview-btn{display:flex;align-items:center;gap:8px;padding:6px 16px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25);border-radius:20px;color:white;font-family:'Vazirmatn',sans-serif;font-size:12px;font-weight:700;cursor:pointer;transition:all .2s;white-space:nowrap;}
.nav-overview-btn:hover{background:rgba(255,255,255,.22);}
.nav-overview-panel{position:absolute;top:calc(100% + 8px);right:12px;width:700px;max-width:96vw;background:white;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);z-index:9999;display:none;animation:slideDown .25s ease-out;overflow:hidden;}
.nav-overview-panel.open{display:block;}
.nav-ov-header{background:linear-gradient(135deg,#1e40af,#0891b2);padding:14px 20px;display:flex;justify-content:space-between;align-items:center;}
.nav-ov-header-title{color:white;font-weight:900;font-size:15px;}
.nav-ov-close{background:rgba(255,255,255,.2);border:none;color:white;border-radius:8px;padding:4px 10px;cursor:pointer;font-family:'Vazirmatn',sans-serif;font-size:13px;}
.nav-ov-body{padding:16px;max-height:60vh;overflow-y:auto;}
.nav-matrix{width:100%;border-collapse:collapse;font-size:13px;}
.nav-matrix th{background:#f1f5f9;color:#374151;padding:8px 12px;text-align:center;font-weight:700;font-size:12px;border-bottom:2px solid #e5e7eb;}
.nav-matrix th:first-child{text-align:right;}
.nav-matrix td{padding:8px 12px;border-bottom:1px solid #f1f5f9;text-align:center;font-size:13px;}
.nav-matrix td:first-child{text-align:right;font-weight:700;color:#1f2937;}
.nav-matrix tbody tr:hover{background:#f0f9ff;}
.nav-matrix tfoot td{background:#f8fafc;font-weight:800;border-top:2px solid #e5e7eb;}
.nav-matrix tfoot td:first-child{text-align:right;}
.nav-ov-buy{color:#059669;font-weight:700;}
.nav-ov-sell{color:#d97706;font-weight:700;}
.nav-ov-diff-pos{color:#059669;}
.nav-ov-diff-neg{color:#dc2626;}
.nav-ov-empty{text-align:center;padding:28px;color:#9ca3af;font-size:14px;}
</style>
</head>
<body>

<!-- MASTER NAV -->
<nav class="master-nav" id="master-nav">
  <div class="master-logo">
    <div class="master-logo-icon">üèóÔ∏è</div>
    <div>
      <div class="master-logo-text">ŸÅŸàŸÑÿßÿØ ŸæŸÑÿ™ŸÅÿ±ŸÖ</div>
      <div class="master-logo-sub">ÿ¥ÿ±⁄©ÿ™ ÿ®ÿßÿ≤ÿ±⁄ØÿßŸÜ€å ŸÅŸàŸÑÿßÿØ</div>
    </div>
  </div>
  <button class="master-module-btn" id="btn-eval" onclick="switchModule('eval')">
    <span class="m-icon">‚≠ê</span> ÿßÿ±ÿ≤€åÿßÿ®€å Ÿæÿ±ÿ≥ŸÜŸÑ <span class="m-badge">HR</span>
  </button>
  <button class="master-module-btn" id="btn-supply" onclick="switchModule('supply')">
    <span class="m-icon">‚öôÔ∏è</span> ŸÖÿØ€åÿ±€åÿ™ ÿ™ÿßŸÖ€åŸÜ <span class="m-badge">SCM</span>
  </button>
  <button class="master-module-btn" id="btn-loading" onclick="switchModule('loading')">
    <span class="m-icon">üöõ</span> ÿ®ÿßÿ±⁄Ø€åÿ±€å <span class="m-badge">LGS</span>
  </button>
  <button class="master-module-btn" id="btn-warehouse" onclick="switchModule('warehouse')">
    <span class="m-icon">üè≠</span> ÿßŸÜÿ®ÿßÿ± <span class="m-badge">WH</span>
  </button>
  <button class="master-module-btn" id="btn-overview" onclick="switchModule('overview')">
    <span class="m-icon">üìä</span> ŸÜŸÖÿß€å ⁄©ŸÑ€å <span class="m-badge">OV</span>
  </button>
  <button class="master-module-btn" id="btn-freight" onclick="switchModule('freight')">
    <span class="m-icon">üó∫Ô∏è</span> ⁄©ÿ±ÿß€åŸá ÿ≠ŸÖŸÑ <span class="m-badge">FR</span>
  </button>
  <div class="master-spacer"></div>

  <!-- ‚îÄ‚îÄ OVERVIEW QUICK PANEL ‚îÄ‚îÄ -->
  <div style="position:relative;">
    <button class="nav-overview-btn" onclick="navOvToggle()" id="nav-ov-btn">
      üìä ŸÜŸÖÿß€å ⁄©ŸÑ€å
      <span id="nav-ov-badge" style="background:rgba(255,255,255,.25);padding:1px 7px;border-radius:10px;font-size:11px;">‚Äî</span>
    </button>
    <div class="nav-overview-panel" id="nav-ov-panel">
      <div class="nav-ov-header">
        <span class="nav-ov-header-title">üìä ŸÜŸÖÿß€å ⁄©ŸÑ€å ‚Äî ŸÖÿßÿ™ÿ±€åÿ≥ ŸÇÿ±ÿßÿ±ÿØÿßÿØŸáÿß</span>
        <div style="display:flex;gap:8px;align-items:center;">
          <button onclick="navOvExcel()" style="background:rgba(255,255,255,.2);border:none;color:white;border-radius:8px;padding:4px 12px;cursor:pointer;font-family:'Vazirmatn',sans-serif;font-size:12px;">üìä ÿß⁄©ÿ≥ŸÑ</button>
          <button class="nav-ov-close" onclick="navOvToggle()">‚úï ÿ®ÿ≥ÿ™ŸÜ</button>
        </div>
      </div>
      <div class="nav-ov-body">
        <table class="nav-matrix">
          <thead id="nav-ov-thead"></thead>
          <tbody id="nav-ov-tbody"></tbody>
          <tfoot id="nav-ov-tfoot"></tfoot>
        </table>
      </div>
    </div>
  </div>

  <div class="master-meta" id="master-meta-bar">
    <div class="master-user-badge" id="master-user-badge" style="display:none;">
      üë§ <span id="master-user-name">‚Äî</span>
    </div>
    <div class="master-clock" id="master-clock">‚Äî</div>
    <button class="master-logout" style="background:rgba(255,165,0,.3);border-color:rgba(255,165,0,.5);" onclick="exportFullBackup()">üíæ ÿ®⁄©ÿßŸæ ⁄©ÿßŸÖŸÑ</button>
    <label class="master-logout" style="background:rgba(0,200,100,.2);border-color:rgba(0,200,100,.4);cursor:pointer;">
      üìÇ ÿ®ÿßÿ≤€åÿßÿ®€å
      <input type="file" class="hidden-file" accept=".json" onchange="importFullBackup(event)">
    </label>
    <button class="master-logout" id="master-logout-btn" onclick="masterLogout()" style="display:none;">üö™ ÿÆÿ±Ÿàÿ¨</button>
  </div>
</nav>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODULE: EVAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="module-panel" id="eval-module">

  <div class="login-overlay" id="login-overlay">
    <div class="login-box">
      <div class="login-logo">‚≠ê</div>
      <div class="login-title">ÿ≥€åÿ≥ÿ™ŸÖ ÿßÿ±ÿ≤€åÿßÿ®€å Ÿæÿ±ÿ≥ŸÜŸÑ</div>
      <div class="login-subtitle">ÿ¥ÿ±⁄©ÿ™ ÿ®ÿßÿ≤ÿ±⁄ØÿßŸÜ€å ŸÅŸàŸÑÿßÿØ</div>
      <div class="login-error" id="login-error">‚ùå ŸÑÿ∑ŸÅÿßŸã ŸÜÿßŸÖ ŸÖÿØ€åÿ± ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ!</div>
      <div class="login-form">
        <div class="form-group">
          <label>üë§ ŸÜÿßŸÖ ŸÖÿØ€åÿ± ÿßÿ±ÿ≤€åÿßÿ®</label>
          <select id="login-manager-select">
            <option value="">ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ...</option>
            <option value="ŸÖÿØ€åÿ± ÿπÿßŸÖŸÑ">ŸÖÿØ€åÿ± ÿπÿßŸÖŸÑ</option>
            <option value="ŸÖÿØ€åÿ± ŸÅÿ±Ÿàÿ¥">ŸÖÿØ€åÿ± ŸÅÿ±Ÿàÿ¥</option>
            <option value="ŸÖÿØ€åÿ± ÿπŸÖŸÑ€åÿßÿ™">ŸÖÿØ€åÿ± ÿπŸÖŸÑ€åÿßÿ™</option>
            <option value="ŸÖÿØ€åÿ± ŸÖŸÜÿßÿ®ÿπ ÿßŸÜÿ≥ÿßŸÜ€å">ŸÖÿØ€åÿ± ŸÖŸÜÿßÿ®ÿπ ÿßŸÜÿ≥ÿßŸÜ€å</option>
            <option value="ŸÖÿØ€åÿ± ŸÖÿßŸÑ€å">ŸÖÿØ€åÿ± ŸÖÿßŸÑ€å</option>
          </select>
        </div>
        <button class="login-btn" onclick="doLogin()">üîê Ÿàÿ±ŸàÿØ ÿ®Ÿá ÿ≥€åÿ≥ÿ™ŸÖ</button>
      </div>
    </div>
  </div>

  <div class="app-container" id="main-app" style="display:none;">
    <div class="header">
      <div class="header-left">
        <h1>‚≠ê ÿ≥€åÿ≥ÿ™ŸÖ ÿßÿ±ÿ≤€åÿßÿ®€å ÿπŸÖŸÑ⁄©ÿ±ÿØ Ÿæÿ±ÿ≥ŸÜŸÑ</h1>
        <p>ÿ¥ÿ±⁄©ÿ™ ÿ®ÿßÿ≤ÿ±⁄ØÿßŸÜ€å ŸÅŸàŸÑÿßÿØ ‚Äî Real-time ÿ®ÿß Firebase Cloud</p>
      </div>
      <div class="header-right">
        <div class="manager-badge">üë§ <span id="current-manager-display">‚Äî</span></div>
        <div class="status-badge"><div id="status-dot"></div><span id="status-text">ÿØÿ± ÿ≠ÿßŸÑ ÿßÿ™ÿµÿßŸÑ...</span></div>
        <button class="logout-btn" onclick="doLogout()">üö™ ÿÆÿ±Ÿàÿ¨</button>
      </div>
    </div>

    <div class="nav-tabs">
      <button class="nav-tab active" onclick="switchTab('evaluation',this)">üìù ÿßÿ±ÿ≤€åÿßÿ®€å ÿ¨ÿØ€åÿØ</button>
      <button class="nav-tab" onclick="switchTab('my-history',this)">üìã ÿßÿ±ÿ≤€åÿßÿ®€å‚ÄåŸáÿß€å ŸÖŸÜ</button>
      <button class="nav-tab shared-tab" onclick="switchTab('shared-dashboard',this)">üåê ÿØÿßÿ¥ÿ®Ÿàÿ±ÿØ ŸÖÿ¥ÿ™ÿ±⁄©</button>
      <button class="nav-tab shared-tab" onclick="switchTab('star-employees',this)">‚≠ê ⁄©ÿßÿ±ŸÖŸÜÿØÿßŸÜ ŸÜŸÖŸàŸÜŸá</button>
      <button class="nav-tab" onclick="switchTab('manage-employees',this)">üë§ ⁄©ÿßÿ±ŸÖŸÜÿØÿßŸÜ</button>
      <button class="nav-tab" onclick="switchTab('departments',this)">üè¢ ÿ®ÿÆÿ¥‚ÄåŸáÿß</button>
    </div>

    <div id="evaluation-section" class="section active">
      <div class="card">
        <h2 class="card-title">üéØ ÿ´ÿ®ÿ™ ÿßÿ±ÿ≤€åÿßÿ®€å ÿ¨ÿØ€åÿØ</h2>
        <div class="alert alert-info">‚ÑπÔ∏è ÿßÿ±ÿ≤€åÿßÿ®€å ÿ´ÿ®ÿ™‚Äåÿ¥ÿØŸá ÿ®Ÿá‚ÄåŸÜÿßŸÖ ÿ¥ŸÖÿß (<strong id="eval-manager-label">‚Äî</strong>) ÿ∞ÿÆ€åÿ±Ÿá ŸÖ€å‚Äåÿ¥ŸàÿØ.</div>
        <div class="form-grid">
          <div class="form-group">
            <label>ÿ®ÿÆÿ¥ (ÿØŸæÿßÿ±ÿ™ŸÖÿßŸÜ) *</label>
            <select id="employee-department" onchange="handleDepartmentChange()">
              <option value="">ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ...</option>
            </select>
          </div>
          <div class="form-group">
            <label>ŸÜÿßŸÖ ⁄©ÿßÿ±ŸÖŸÜÿØ *</label>
            <select id="employee-name"><option value="">ÿßÿ®ÿ™ÿØÿß ÿ®ÿÆÿ¥ ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ</option></select>
          </div>
          <div class="form-group">
            <label>ÿ™ÿßÿ±€åÿÆ ÿßÿ±ÿ≤€åÿßÿ®€å</label>
            <input type="date" id="evaluation-date">
          </div>
        </div>
        <div id="department-badge-container"></div>
        <div class="evaluation-sections" id="evaluation-criteria"></div>
        <div class="total-score-card" style="display:none;" id="total-score-container">
          <div class="total-score-label">ÿßŸÖÿ™€åÿßÿ≤ ⁄©ŸÑ ÿß€åŸÜ ÿßÿ±ÿ≤€åÿßÿ®€å</div>
          <div class="total-score-value" id="total-score">0</div>
          <div class="total-score-max">ÿßÿ≤ <span id="max-score">1000</span></div>
        </div>
        <div class="btn-group">
          <button class="btn btn-success" onclick="saveEvaluation()">‚úÖ ÿ∞ÿÆ€åÿ±Ÿá ÿßÿ±ÿ≤€åÿßÿ®€å</button>
          <button class="btn btn-secondary" onclick="resetForm()">üîÑ Ÿæÿß⁄© ⁄©ÿ±ÿØŸÜ ŸÅÿ±ŸÖ</button>
        </div>
      </div>
    </div>

    <div id="my-history-section" class="section">
      <div class="card">
        <h2 class="card-title">üìã ÿßÿ±ÿ≤€åÿßÿ®€å‚ÄåŸáÿß€å ÿ´ÿ®ÿ™‚Äåÿ¥ÿØŸá ÿ™Ÿàÿ≥ÿ∑ ŸÖŸÜ</h2>
        <div class="alert alert-info" id="my-history-info">üìå ŸÅŸÇÿ∑ ÿßÿ±ÿ≤€åÿßÿ®€å‚ÄåŸáÿß€å ÿ¥ŸÖÿß ŸÜŸÖÿß€åÿ¥ ÿØÿßÿØŸá ŸÖ€å‚Äåÿ¥ŸàÿØ.</div>
        <div class="io-panel">
          <div class="io-title">üíæ Ÿæÿ¥ÿ™€åÿ®ÿßŸÜ‚Äå⁄Ø€åÿ±€å Ÿà ÿ®ÿßÿ≤€åÿßÿ®€å ‚Äî ÿßÿ±ÿ≤€åÿßÿ®€å‚ÄåŸáÿß€å ŸÖŸÜ</div>
          <div class="io-btn-row">
            <button class="btn btn-warning" onclick="exportMyEvaluations()">üì• ÿÆÿ±Ÿàÿ¨€å JSON</button>
            <button class="btn btn-success" onclick="exportMyEvaluationsExcel()">üìä ÿÆÿ±Ÿàÿ¨€å ÿß⁄©ÿ≥ŸÑ</button>
            <label class="io-label green">
              üìÇ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿßÿ≤ JSON
              <input type="file" class="hidden-file" accept=".json" onchange="importMyEvaluations(event)">
            </label>
          </div>
        </div>
        <table class="history-table">
          <thead><tr><th>ÿ™ÿßÿ±€åÿÆ</th><th>ŸÜÿßŸÖ ⁄©ÿßÿ±ŸÖŸÜÿØ</th><th>ÿ®ÿÆÿ¥</th><th>ÿßŸÖÿ™€åÿßÿ≤</th><th>ÿ±ÿ™ÿ®Ÿá</th><th>ÿπŸÖŸÑ€åÿßÿ™</th></tr></thead>
          <tbody id="my-history-tbody"></tbody>
        </table>
      </div>
    </div>

    <div id="shared-dashboard-section" class="section">
      <div class="shared-dashboard-header">
        <div class="icon">üåê</div>
        <div>
          <h3>ÿØÿßÿ¥ÿ®Ÿàÿ±ÿØ ŸÖÿ¥ÿ™ÿ±⁄© ‚Äî ŸÇÿßÿ®ŸÑ ŸÖÿ¥ÿßŸáÿØŸá ÿ®ÿ±ÿß€å ŸáŸÖŸá ŸÖÿØ€åÿ±ÿßŸÜ</h3>
          <p>ŸÖÿ¨ŸÖŸàÿπ ⁄©ŸÑ ÿßŸÖÿ™€åÿßÿ≤ÿßÿ™ Ÿà ÿ±ÿ™ÿ®Ÿá‚Äåÿ®ŸÜÿØ€å ÿ™ŸÖÿßŸÖ ⁄©ÿßÿ±ŸÖŸÜÿØÿßŸÜ ÿßÿ≤ ŸáŸÖŸá ÿ®ÿÆÿ¥‚ÄåŸáÿß</p>
        </div>
      </div>
      <div class="summary-stats-grid" id="summary-stats"></div>
      <div class="card">
        <div class="card-header">
          <h2 class="card-title" style="margin-bottom:0;">üèÜ ÿ±ÿ™ÿ®Ÿá‚Äåÿ®ŸÜÿØ€å ⁄©ŸÑ€å ⁄©ÿßÿ±ŸÖŸÜÿØÿßŸÜ</h2>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn btn-warning btn-sm" onclick="exportAllEvaluationsJSON()">üì• JSON ⁄©ÿßŸÖŸÑ</button>
            <button class="btn btn-success btn-sm" onclick="exportAllEvaluationsExcel()">üìä ÿÆÿ±Ÿàÿ¨€å ÿß⁄©ÿ≥ŸÑ</button>
            <button class="btn btn-primary btn-sm" onclick="exportRankingExcel()">üèÜ ÿ±ÿ™ÿ®Ÿá‚Äåÿ®ŸÜÿØ€å ÿß⁄©ÿ≥ŸÑ</button>
            <label class="io-label orange" style="padding:6px 14px;font-size:13px;">
              üìÇ ÿ®ÿßÿ≤€åÿßÿ®€å JSON
              <input type="file" class="hidden-file" accept=".json" onchange="importAllEvaluations(event)">
            </label>
          </div>
        </div>
        <div class="alert alert-warning">‚ö†Ô∏è ÿß€åŸÜ ÿ¨ÿØŸàŸÑ ŸÖÿ¨ŸÖŸàÿπ ÿ™ŸÖÿßŸÖ ÿßÿ±ÿ≤€åÿßÿ®€å‚ÄåŸáÿß€å ŸáŸÖŸá ŸÖÿØ€åÿ±ÿßŸÜ ÿ±ÿß ŸÜÿ¥ÿßŸÜ ŸÖ€å‚ÄåÿØŸáÿØ.</div>
        <div style="overflow-x:auto;">
          <table class="ranking-table" id="global-ranking-table">
            <thead><tr><th style="width:60px;">ÿ±ÿ™ÿ®Ÿá</th><th>ŸÜÿßŸÖ ⁄©ÿßÿ±ŸÖŸÜÿØ</th><th>ÿ®ÿÆÿ¥</th><th>ÿ™ÿπÿØÿßÿØ ÿßÿ±ÿ≤€åÿßÿ®€å</th><th>ŸÖÿ¨ŸÖŸàÿπ ÿßŸÖÿ™€åÿßÿ≤</th><th>ŸÖ€åÿßŸÜ⁄Ø€åŸÜ %</th><th>ŸÜŸÖŸàÿØÿßÿ±</th></tr></thead>
            <tbody id="global-ranking-tbody"></tbody>
          </table>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:22px;margin-top:10px;">
        <div class="card"><h3 style="margin-bottom:18px;font-size:17px;">üìà ŸÖŸÇÿß€åÿ≥Ÿá ÿßŸÖÿ™€åÿßÿ≤ ⁄©ÿßÿ±ŸÖŸÜÿØÿßŸÜ</h3><canvas id="sharedEmployeesChart"></canvas></div>
        <div class="card"><h3 style="margin-bottom:18px;font-size:17px;">üè¢ ÿ™Ÿàÿ≤€åÿπ ÿßÿ±ÿ≤€åÿßÿ®€å‚ÄåŸáÿß ÿØÿ± ÿ®ÿÆÿ¥‚ÄåŸáÿß</h3><canvas id="sharedDepartmentsChart"></canvas></div>
      </div>
    </div>

    <div id="star-employees-section" class="section">
      <div class="card">
        <h2 class="card-title">‚≠ê ÿ™ÿßÿ®ŸÑŸà ⁄©ÿßÿ±ŸÖŸÜÿØÿßŸÜ ŸÜŸÖŸàŸÜŸá ŸÖÿßŸá</h2>
        <div class="alert alert-info">‚ÑπÔ∏è ÿ®ÿ± ÿßÿ≥ÿßÿ≥ ÿßÿ±ÿ≤€åÿßÿ®€å‚ÄåŸáÿß€å ŸáŸÖŸá ŸÖÿØ€åÿ±ÿßŸÜ ŸÖÿ≠ÿßÿ≥ÿ®Ÿá ŸÖ€å‚Äåÿ¥ŸàÿØ.</div>
        <div class="form-grid" style="margin-bottom:22px;">
          <div class="form-group">
            <label>ÿßŸÜÿ™ÿÆÿßÿ® ŸÖÿßŸá</label>
            <input type="month" id="star-month-selector" onchange="updateStarEmployees()">
          </div>
          <div class="form-group">
            <label>ÿ™ÿπÿØÿßÿØ ŸÜŸÖÿß€åÿ¥</label>
            <select id="star-count-selector" onchange="updateStarEmployees()">
              <option value="3">3 ŸÜŸÅÿ± ÿ®ÿ±ÿ™ÿ±</option>
              <option value="5">5 ŸÜŸÅÿ± ÿ®ÿ±ÿ™ÿ±</option>
              <option value="10">10 ŸÜŸÅÿ± ÿ®ÿ±ÿ™ÿ±</option>
            </select>
          </div>
        </div>
        <div class="star-employees-grid" id="star-employees-grid"></div>
      </div>
    </div>

    <div id="manage-employees-section" class="section">
      <div class="card">
        <h2 class="card-title">üë§ ŸÖÿØ€åÿ±€åÿ™ ⁄©ÿßÿ±ŸÖŸÜÿØÿßŸÜ</h2>
        <div class="io-panel blue">
          <div class="io-title">üíæ Ÿæÿ¥ÿ™€åÿ®ÿßŸÜ‚Äå⁄Ø€åÿ±€å Ÿà ÿ®ÿßÿ≤€åÿßÿ®€å ‚Äî ⁄©ÿßÿ±ŸÖŸÜÿØÿßŸÜ</div>
          <div class="io-btn-row">
            <button class="btn btn-warning" onclick="exportEmployeesJSON()">üì• ÿÆÿ±Ÿàÿ¨€å JSON</button>
            <label class="io-label blue">
              üìÇ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿßÿ≤ JSON
              <input type="file" class="hidden-file" accept=".json" onchange="importEmployeesJSON(event)">
            </label>
          </div>
        </div>
        <div class="card" style="background:linear-gradient(135deg,#f0f9ff,#dbeafe);margin-bottom:22px;">
          <h3 style="font-size:17px;margin-bottom:14px;">‚ûï ÿßŸÅÿ≤ŸàÿØŸÜ ⁄©ÿßÿ±ŸÖŸÜÿØ ÿ¨ÿØ€åÿØ</h3>
          <div class="form-grid">
            <div class="form-group"><label>ŸÜÿßŸÖ Ÿà ŸÜÿßŸÖ ÿÆÿßŸÜŸàÿßÿØ⁄Ø€å *</label><input type="text" id="new-emp-name" placeholder="ŸÖÿ´ÿßŸÑ: ÿπŸÑ€å ÿßÿ≠ŸÖÿØ€å"></div>
            <div class="form-group"><label>ÿ®ÿÆÿ¥ *</label><select id="new-emp-department"><option value="">ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ...</option></select></div>
            <div class="form-group"><label>ÿ≥ŸÖÿ™</label><input type="text" id="new-emp-position" placeholder="ŸÖÿ´ÿßŸÑ: ⁄©ÿßÿ±ÿ¥ŸÜÿßÿ≥ ŸÅÿ±Ÿàÿ¥"></div>
            <div class="form-group"><label>⁄©ÿØ Ÿæÿ±ÿ≥ŸÜŸÑ€å</label><input type="text" id="new-emp-code" placeholder="ŸÖÿ´ÿßŸÑ: 1001"></div>
            <div class="form-group"><label>ÿπ⁄©ÿ≥ (URL)</label><input type="text" id="new-emp-photo" placeholder="https://..."></div>
          </div>
          <div class="btn-group">
            <button class="btn btn-success" onclick="addNewEmployee()">‚úÖ ÿßŸÅÿ≤ŸàÿØŸÜ</button>
            <button class="btn btn-secondary" onclick="clearEmployeeForm()">üîÑ Ÿæÿß⁄© ⁄©ÿ±ÿØŸÜ</button>
          </div>
        </div>
        <div class="card">
          <h3 style="font-size:17px;margin-bottom:14px;">üìã ŸÑ€åÿ≥ÿ™ ⁄©ÿßÿ±ŸÖŸÜÿØÿßŸÜ</h3>
          <div class="criteria-list" id="employees-management-list"></div>
        </div>
      </div>
    </div>

    <div id="departments-section" class="section">
      <div class="card">
        <h2 class="card-title">üè¢ ŸÖÿØ€åÿ±€åÿ™ ÿ®ÿÆÿ¥‚ÄåŸáÿß Ÿà ŸÖÿπ€åÿßÿ±Ÿáÿß</h2>
        <div class="io-panel blue">
          <div class="io-title">üíæ Ÿæÿ¥ÿ™€åÿ®ÿßŸÜ‚Äå⁄Ø€åÿ±€å Ÿà ÿ®ÿßÿ≤€åÿßÿ®€å ‚Äî ÿ®ÿÆÿ¥‚ÄåŸáÿß Ÿà ŸÖÿπ€åÿßÿ±Ÿáÿß</div>
          <div class="io-btn-row">
            <button class="btn btn-warning" onclick="exportDepartmentsJSON()">üì• ÿÆÿ±Ÿàÿ¨€å JSON</button>
            <label class="io-label blue">
              üìÇ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿßÿ≤ JSON
              <input type="file" class="hidden-file" accept=".json" onchange="importDepartmentsJSON(event)">
            </label>
          </div>
        </div>
        <div class="alert alert-warning">‚ö†Ô∏è Ÿáÿ± ÿ®ÿÆÿ¥ ŸÖÿπ€åÿßÿ±Ÿáÿß€å ÿßÿ±ÿ≤€åÿßÿ®€å ŸÖÿÆÿµŸàÿµ ÿÆŸàÿØ ÿ±ÿß ÿØÿßÿ±ÿØ.</div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="showAddDepartmentModal()">‚ûï ÿ®ÿÆÿ¥ ÿ¨ÿØ€åÿØ</button>
          <button class="btn btn-secondary" onclick="resetToDefaultDepartments()">üîÑ ÿ®ÿßÿ≤⁄Øÿ¥ÿ™ ÿ®Ÿá Ÿæ€åÿ¥‚ÄåŸÅÿ±ÿ∂</button>
        </div>
        <div class="departments-grid" id="departments-grid"></div>
      </div>
    </div>
  </div>

  <!-- EVAL MODALS -->
  <div id="criteria-modal" class="eval-modal">
    <div class="eval-modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Ÿà€åÿ±ÿß€åÿ¥ ÿ®ÿÆÿ¥</h2>
        <button class="modal-close" onclick="closeCriteriaModal()">√ó</button>
      </div>
      <div class="form-grid" style="margin-bottom:20px;">
        <div class="form-group"><label>ŸÜÿßŸÖ ÿ®ÿÆÿ¥</label><input type="text" id="modal-department-name-input" class="criteria-name-input"></div>
        <div class="form-group"><label>ÿ¢€å⁄©ŸàŸÜ</label><input type="text" id="modal-department-icon-input" class="criteria-name-input" maxlength="2"></div>
      </div>
      <div id="modal-department-badge"></div>
      <h3 style="font-size:17px;margin-bottom:13px;">üìã ŸÖÿπ€åÿßÿ±Ÿáÿß€å ÿßÿ±ÿ≤€åÿßÿ®€å</h3>
      <div class="criteria-list" id="modal-criteria-list"></div>
      <div class="btn-group">
        <button class="btn btn-success" onclick="saveDepartmentCriteria()">‚úÖ ÿ∞ÿÆ€åÿ±Ÿá</button>
        <button class="btn btn-primary" onclick="addNewCriteriaToModal()">‚ûï ŸÖÿπ€åÿßÿ± ÿ¨ÿØ€åÿØ</button>
        <button class="btn btn-danger" onclick="deleteDepartment()">üóëÔ∏è ÿ≠ÿ∞ŸÅ ÿ®ÿÆÿ¥</button>
      </div>
    </div>
  </div>

  <div id="add-department-modal" class="eval-modal">
    <div class="eval-modal-content">
      <div class="modal-header">
        <h2 class="modal-title">‚ûï ÿßŸÅÿ≤ŸàÿØŸÜ ÿ®ÿÆÿ¥ ÿ¨ÿØ€åÿØ</h2>
        <button class="modal-close" onclick="closeAddDepartmentModal()">√ó</button>
      </div>
      <div class="form-group" style="margin-bottom:16px;"><label>ŸÜÿßŸÖ ÿ®ÿÆÿ¥</label><input type="text" id="new-department-name" placeholder="ŸÖÿ´ÿßŸÑ: ÿ®ÿßÿ≤ÿßÿ±€åÿßÿ®€å"></div>
      <div class="form-group" style="margin-bottom:20px;"><label>ÿ¢€å⁄©ŸàŸÜ</label><input type="text" id="new-department-icon" placeholder="ŸÖÿ´ÿßŸÑ: üì¢" maxlength="2"></div>
      <div class="btn-group"><button class="btn btn-success" onclick="createNewDepartment()">‚úÖ ÿß€åÿ¨ÿßÿØ</button></div>
    </div>
  </div>

  <div id="edit-employee-modal" class="eval-modal">
    <div class="eval-modal-content">
      <div class="modal-header">
        <h2 class="modal-title">‚úèÔ∏è Ÿà€åÿ±ÿß€åÿ¥ ⁄©ÿßÿ±ŸÖŸÜÿØ</h2>
        <button class="modal-close" onclick="closeEditEmployeeModal()">√ó</button>
      </div>
      <div class="form-grid">
        <div class="form-group"><label>ŸÜÿßŸÖ Ÿà ŸÜÿßŸÖ ÿÆÿßŸÜŸàÿßÿØ⁄Ø€å *</label><input type="text" id="edit-emp-name"></div>
        <div class="form-group"><label>ÿ®ÿÆÿ¥ *</label><select id="edit-emp-department"><option value="">ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ...</option></select></div>
        <div class="form-group"><label>ÿ≥ŸÖÿ™</label><input type="text" id="edit-emp-position"></div>
        <div class="form-group"><label>⁄©ÿØ Ÿæÿ±ÿ≥ŸÜŸÑ€å</label><input type="text" id="edit-emp-code"></div>
        <div class="form-group" style="grid-column:1/-1;"><label>ÿπ⁄©ÿ≥ (URL)</label><input type="text" id="edit-emp-photo"></div>
      </div>
      <div class="btn-group">
        <button class="btn btn-success" onclick="saveEditedEmployee()">‚úÖ ÿ∞ÿÆ€åÿ±Ÿá</button>
        <button class="btn btn-secondary" onclick="closeEditEmployeeModal()">‚ùå ÿßŸÜÿµÿ±ÿßŸÅ</button>
      </div>
    </div>
  </div>
</div><!-- /eval-module -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODULE: SUPPLY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="module-panel" id="supply-module">
<div id="supply-app" style="max-width:1600px;margin:0 auto;padding:20px;">

  <div class="header">
    <div class="header-left">
      <h1>‚öôÔ∏è ÿ®ÿÆÿ¥ ÿ™ÿßŸÖ€åŸÜ ‚Äî ÿ¥ÿ±⁄©ÿ™ ÿ®ÿßÿ≤ÿ±⁄ØÿßŸÜ€å ŸÅŸàŸÑÿßÿØ</h1>
      <p>ŸÖÿØ€åÿ±€åÿ™ ŸÖÿ≠ÿµŸàŸÑÿßÿ™ÿå ⁄©ÿßÿ±ÿÆÿßŸÜÿ¨ÿßÿ™ Ÿà ŸÇ€åŸÖÿ™‚Äå⁄Øÿ∞ÿßÿ±€å ŸÑÿ≠ÿ∏Ÿá‚Äåÿß€å</p>
    </div>
    <div class="header-right">
      <div class="live-badge"><div class="live-dot" id="supply-status-dot"></div><span id="supply-status-text">Firebase</span></div>
      <div class="clock-badge" id="supply-clock">‚Äî</div>
    </div>
  </div>

  <div class="stat-strip">
    <div class="stat-card blue"><div class="stat-icon">üì¶</div><div class="stat-val" id="stat-products">0</div><div class="stat-label">ŸÖÿ≠ÿµŸàŸÑÿßÿ™ ÿ´ÿ®ÿ™‚Äåÿ¥ÿØŸá</div></div>
    <div class="stat-card teal"><div class="stat-icon">üè≠</div><div class="stat-val" id="stat-factories">0</div><div class="stat-label">⁄©ÿßÿ±ÿÆÿßŸÜÿ¨ÿßÿ™ ŸÅÿπÿßŸÑ</div></div>
    <div class="stat-card green"><div class="stat-icon">üí∞</div><div class="stat-val" id="stat-prices">0</div><div class="stat-label">ÿ±⁄©Ÿàÿ±ÿØ ŸÇ€åŸÖÿ™</div></div>
    <div class="stat-card orange"><div class="stat-icon">üïê</div><div class="stat-val" id="stat-today">0</div><div class="stat-label">ÿ¢ŸæÿØ€åÿ™ ÿßŸÖÿ±Ÿàÿ≤</div></div>
  </div>

  <div id="supply-nav">
    <button class="supply-nav-btn" onclick="supplyTab('sales-dashboard',this)">üéØ ÿØÿßÿ¥ÿ®Ÿàÿ±ÿØ ŸÅÿ±Ÿàÿ¥</button>
    <button class="supply-nav-btn active" onclick="supplyTab('prices',this)">üí∞ ŸÇ€åŸÖÿ™‚ÄåŸáÿß <span class="nav-count" id="nc-prices">0</span></button>
    <button class="supply-nav-btn" onclick="supplyTab('products',this)">üì¶ ŸÖÿ≠ÿµŸàŸÑÿßÿ™ <span class="nav-count" id="nc-products">0</span></button>
    <button class="supply-nav-btn" onclick="supplyTab('factories',this)">üè≠ ⁄©ÿßÿ±ÿÆÿßŸÜÿ¨ÿßÿ™ <span class="nav-count" id="nc-factories">0</span></button>
    <button class="supply-nav-btn" onclick="supplyTab('analytics',this)">üìä ÿ™ÿ≠ŸÑ€åŸÑ ŸáŸÅÿ™⁄Ø€å</button>
  </div>

  <!-- ‚ïê‚ïê‚ïê SALES DASHBOARD ‚Äî FIX: ÿß€åŸÜ ÿ®ÿÆÿ¥ ÿØÿ± ŸÜÿ≥ÿÆŸá ÿßÿµŸÑ€å Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ¥ÿ™ ‚ïê‚ïê‚ïê -->
  <div id="supply-sales-dashboard-section" class="supply-section">
    <div class="card">
      <div class="card-header">
        <div class="card-title">üéØ ÿØÿßÿ¥ÿ®Ÿàÿ±ÿØ ŸÅÿ±Ÿàÿ¥ ‚Äî ÿßŸÜÿ™ÿÆÿßÿ® ŸÖÿ≠ÿµŸàŸÑÿßÿ™</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
          <span id="sales-total-products" style="font-size:13px;color:var(--text-light);">0 ŸÖÿ≠ÿµŸàŸÑ</span>
          <button class="btn btn-ghost btn-sm" onclick="selectAllProducts()">‚úÖ ÿßŸÜÿ™ÿÆÿßÿ® ŸáŸÖŸá</button>
          <button class="btn btn-ghost btn-sm" onclick="deselectAllProducts()">‚ùå ŸÑÿ∫Ÿà ŸáŸÖŸá</button>
          <button class="btn btn-primary btn-sm" onclick="refreshSalesDashboard()">üîÑ ÿ®ÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å</button>
        </div>
      </div>
      <div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;">
        <div class="search-wrap" style="flex:1;min-width:200px;">
          <span class="icon">üîç</span>
          <input class="search-input" id="sales-product-search" placeholder="ÿ¨ÿ≥ÿ™ÿ¨Ÿà ŸÖÿ≠ÿµŸàŸÑ..." oninput="filterSalesProducts()">
        </div>
        <select class="filter-select" id="sales-category-filter" onchange="filterSalesProducts()">
          <option value="">ŸáŸÖŸá ÿØÿ≥ÿ™Ÿá‚ÄåŸáÿß</option>
        </select>
      </div>
      <div id="sales-product-categories"></div>
      <div id="sales-product-empty" class="empty" style="display:none;">
        <div class="empty-icon">üì¶</div>
        <div class="empty-text">ŸÖÿ≠ÿµŸàŸÑ€å €åÿßŸÅÿ™ ŸÜÿ¥ÿØ</div>
      </div>
    </div>

    <div id="sales-selected-info" style="display:none;background:linear-gradient(135deg,#dbeafe,#eff6ff);border:2px solid #93c5fd;border-radius:12px;padding:14px 20px;margin-bottom:20px;align-items:center;gap:12px;flex-wrap:wrap;">
      <span style="font-weight:700;color:var(--primary);">üìä <span id="sales-selected-count">0</span> ŸÖÿ≠ÿµŸàŸÑ ÿßŸÜÿ™ÿÆÿßÿ® ÿ¥ÿØŸá</span>
      <span style="color:var(--text-light);font-size:13px;">ÿ¨ÿØÿßŸàŸÑ ŸÇ€åŸÖÿ™ ÿØÿ± ÿ≤€åÿ± ŸÜŸÖÿß€åÿ¥ ÿØÿßÿØŸá ŸÖ€å‚Äåÿ¥ŸàÿØ</span>
    </div>

    <div id="sales-price-tables"></div>

    <div id="sales-empty-state" class="empty" style="padding:60px 20px;">
      <div class="empty-icon">üéØ</div>
      <div class="empty-text">ŸÖÿ≠ÿµŸàŸÑ€å ÿßŸÜÿ™ÿÆÿßÿ® ŸÜÿ¥ÿØŸá ÿßÿ≥ÿ™</div>
      <div class="empty-sub">ÿßÿ≤ ŸÑ€åÿ≥ÿ™ ÿ®ÿßŸÑÿß ŸÖÿ≠ÿµŸàŸÑÿßÿ™ ŸÖŸàÿ±ÿØ ŸÜÿ∏ÿ± ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ ÿ™ÿß ÿ¨ÿØÿßŸàŸÑ ŸÇ€åŸÖÿ™ ŸÜŸÖÿß€åÿ¥ ÿØÿßÿØŸá ÿ¥ŸàŸÜÿØ</div>
    </div>
  </div>

  <!-- PRICES -->
  <div id="supply-prices-section" class="supply-section active">
    <div class="card">
      <div class="card-header">
        <div class="card-title">‚ûï ÿ´ÿ®ÿ™ / ÿ¢ŸæÿØ€åÿ™ ŸÇ€åŸÖÿ™ ÿ¨ÿØ€åÿØ</div>
        <button class="btn btn-ghost btn-sm" onclick="toggleAddForm()"><span id="toggle-icon">‚ñ≤</span> ŸÖÿÆŸÅ€å ⁄©ÿ±ÿØŸÜ ŸÅÿ±ŸÖ</button>
      </div>
      <div id="add-form-wrap">
        <div class="form-add-section">
          <div class="form-row">
            <div><div class="form-label">ŸÜŸàÿπ ÿ®ÿßÿ± *</div><select class="form-select" id="p-product"><option value="">ÿßŸÜÿ™ÿÆÿßÿ® ŸÖÿ≠ÿµŸàŸÑ...</option></select></div>
            <div><div class="form-label">ÿ≥ÿß€åÿ≤ *</div><input class="form-input" id="p-size" placeholder="ŸÖÿ´ÿßŸÑ: €±€¥"></div>
            <div><div class="form-label">⁄©ÿßÿ±ÿÆÿßŸÜŸá *</div><select class="form-select" id="p-factory"><option value="">ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ÿßÿ±ÿÆÿßŸÜŸá...</option></select></div>
            <div><div class="form-label">ŸÇ€åŸÖÿ™ (ÿ™ŸàŸÖÿßŸÜ / ⁄©€åŸÑŸà⁄Øÿ±ŸÖ) *</div><input class="form-input" id="p-price" type="number" placeholder="ŸÖÿ´ÿßŸÑ: 45000"></div>
            <div><div class="form-label">ÿ™Ÿàÿ∂€åÿ≠ÿßÿ™</div><input class="form-input" id="p-note" placeholder="ÿßÿÆÿ™€åÿßÿ±€å..."></div>
          </div>
          <div class="btn-group">
            <button class="btn btn-accent" onclick="addPrice()">‚úÖ ÿ´ÿ®ÿ™ ŸÇ€åŸÖÿ™</button>
            <button class="btn btn-ghost" onclick="clearPriceForm()">üîÑ Ÿæÿß⁄© ⁄©ÿ±ÿØŸÜ</button>
          </div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <div class="card-title">üìã ÿ¨ÿØŸàŸÑ ŸÇ€åŸÖÿ™‚ÄåŸáÿß</div>
        <div style="font-size:12px;color:var(--text-light);">ÿ¢ŸæÿØ€åÿ™ ÿÆŸàÿØ⁄©ÿßÿ± ÿ®ÿß ÿ™ÿßÿ±€åÿÆ Ÿà ÿ≥ÿßÿπÿ™</div>
      </div>
      <div class="toolbar">
        <div class="search-wrap">
          <span class="icon">üîç</span>
          <input class="search-input" id="price-search" placeholder="ÿ¨ÿ≥ÿ™ÿ¨Ÿà ÿØÿ± ŸÖÿ≠ÿµŸàŸÑÿå ÿ≥ÿß€åÿ≤ÿå ⁄©ÿßÿ±ÿÆÿßŸÜŸá..." oninput="renderPriceTable()">
        </div>
        <select class="filter-select" id="filter-product" onchange="renderPriceTable()"><option value="">ŸáŸÖŸá ŸÖÿ≠ÿµŸàŸÑÿßÿ™</option></select>
        <select class="filter-select" id="filter-factory" onchange="renderPriceTable()"><option value="">ŸáŸÖŸá ⁄©ÿßÿ±ÿÆÿßŸÜÿ¨ÿßÿ™</option></select>
        <button class="btn btn-ghost btn-sm" onclick="exportCSV()">üì• ÿÆÿ±Ÿàÿ¨€å CSV</button>
        <button class="btn btn-warning btn-sm" onclick="exportPricesJSON()">üì• JSON</button>
        <label class="io-label orange" style="padding:8px 14px;font-size:13px;">
          üìÇ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å JSON
          <input type="file" class="hidden-file" accept=".json" onchange="importPricesJSON(event)">
        </label>
      </div>
      <div class="table-wrap">
        <table class="data-table">
          <thead><tr><th>ŸÜŸàÿπ ÿ®ÿßÿ±</th><th>ÿ≥ÿß€åÿ≤</th><th>⁄©ÿßÿ±ÿÆÿßŸÜŸá</th><th>ŸÇ€åŸÖÿ™ (ÿ™ŸàŸÖÿßŸÜ/⁄©€åŸÑŸà)</th><th>ÿ™ÿ∫€å€åÿ±</th><th>ÿ¢ÿÆÿ±€åŸÜ ÿ¢ŸæÿØ€åÿ™</th><th>ÿ™Ÿàÿ∂€åÿ≠ÿßÿ™</th><th>ÿπŸÖŸÑ€åÿßÿ™</th></tr></thead>
          <tbody id="price-tbody"></tbody>
        </table>
      </div>
      <div id="price-empty" class="empty" style="display:none;">
        <div class="empty-icon">üí∞</div><div class="empty-text">ŸáŸÜŸàÿ≤ ŸÇ€åŸÖÿ™€å ÿ´ÿ®ÿ™ ŸÜÿ¥ÿØŸá ÿßÿ≥ÿ™</div>
        <div class="empty-sub">ÿßÿ≤ ŸÅÿ±ŸÖ ÿ®ÿßŸÑÿß ŸÇ€åŸÖÿ™‚ÄåŸáÿß€å ÿ¨ÿØ€åÿØ ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ</div>
      </div>
    </div>
  </div>

  <!-- PRODUCTS -->
  <div id="supply-products-section" class="supply-section">
    <div class="card">
      <div class="card-header">
        <div class="card-title">üì¶ ŸÑ€åÿ≥ÿ™ ŸÖÿ≠ÿµŸàŸÑÿßÿ™</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
          <button class="btn btn-warning btn-sm" onclick="exportProductsJSON()">üì• JSON</button>
          <label class="io-label green" style="padding:8px 14px;font-size:13px;">
            üìÇ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å
            <input type="file" class="hidden-file" accept=".json" onchange="importProductsJSON(event)">
          </label>
          <button class="btn btn-accent" onclick="openProductModal()">‚ûï ÿßŸÅÿ≤ŸàÿØŸÜ ŸÖÿ≠ÿµŸàŸÑ</button>
        </div>
      </div>
      <div class="grid-cards" id="products-grid">
        <div class="empty"><div class="empty-icon">üì¶</div><div class="empty-text">ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å...</div></div>
      </div>
    </div>
  </div>

  <!-- FACTORIES -->
  <div id="supply-factories-section" class="supply-section">
    <div class="card">
      <div class="card-header">
        <div class="card-title">üè≠ ŸÑ€åÿ≥ÿ™ ⁄©ÿßÿ±ÿÆÿßŸÜÿ¨ÿßÿ™</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
          <button class="btn btn-warning btn-sm" onclick="exportFactoriesJSON()">üì• JSON</button>
          <label class="io-label green" style="padding:8px 14px;font-size:13px;">
            üìÇ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å
            <input type="file" class="hidden-file" accept=".json" onchange="importFactoriesJSON(event)">
          </label>
          <button class="btn btn-accent" onclick="openFactoryModal()">‚ûï ÿßŸÅÿ≤ŸàÿØŸÜ ⁄©ÿßÿ±ÿÆÿßŸÜŸá</button>
        </div>
      </div>
      <div class="grid-cards" id="factories-grid">
        <div class="empty"><div class="empty-icon">üè≠</div><div class="empty-text">ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å...</div></div>
      </div>
    </div>
  </div>

  <!-- ANALYTICS -->
  <div id="supply-analytics-section" class="supply-section">
    <div class="card" style="padding:16px 22px;">
      <div style="display:flex;align-items:center;gap:14px;flex-wrap:wrap;">
        <div class="card-title" style="margin-bottom:0;font-size:15px;">üîé ŸÅ€åŸÑÿ™ÿ± ŸÜŸÖŸàÿØÿßÿ±</div>
        <select class="filter-select" id="chart-product-filter" onchange="renderAnalytics()"><option value="">ŸáŸÖŸá ŸÖÿ≠ÿµŸàŸÑÿßÿ™</option></select>
        <select class="filter-select" id="chart-factory-filter" onchange="renderAnalytics()"><option value="">ŸáŸÖŸá ⁄©ÿßÿ±ÿÆÿßŸÜÿ¨ÿßÿ™</option></select>
        <div class="period-tabs">
          <button class="period-tab active" onclick="setPeriod(7,this)">€∑ ÿ±Ÿàÿ≤</button>
          <button class="period-tab" onclick="setPeriod(14,this)">€±€¥ ÿ±Ÿàÿ≤</button>
          <button class="period-tab" onclick="setPeriod(30,this)">€≥€∞ ÿ±Ÿàÿ≤</button>
        </div>
      </div>
    </div>
    <div class="chart-grid">
      <div class="chart-card" style="grid-column:1/-1;">
        <div class="chart-header"><div><div class="chart-title">üìà ÿ±ŸàŸÜÿØ ŸÇ€åŸÖÿ™ ŸáŸÅÿ™⁄Ø€å</div><div class="chart-subtitle" id="chart-range-label">€∑ ÿ±Ÿàÿ≤ ⁄Øÿ∞ÿ¥ÿ™Ÿá</div></div></div>
        <canvas id="trendChart" height="90"></canvas>
      </div>
      <div class="chart-card">
        <div class="chart-header"><div><div class="chart-title">ü•ß ÿ™Ÿàÿ≤€åÿπ ÿ´ÿ®ÿ™ ŸÇ€åŸÖÿ™ ÿ®Ÿá ÿ™ŸÅ⁄©€å⁄© ŸÖÿ≠ÿµŸàŸÑ</div><div class="chart-subtitle">ÿØÿ±ÿµÿØ ÿ±⁄©Ÿàÿ±ÿØŸáÿß</div></div></div>
        <canvas id="productPieChart" height="200"></canvas>
      </div>
      <div class="chart-card">
        <div class="chart-header"><div><div class="chart-title">üè≠ ŸÖŸÇÿß€åÿ≥Ÿá ŸÖ€åÿßŸÜ⁄Ø€åŸÜ ŸÇ€åŸÖÿ™ ⁄©ÿßÿ±ÿÆÿßŸÜÿ¨ÿßÿ™</div><div class="chart-subtitle">ÿ™ŸàŸÖÿßŸÜ / ⁄©€åŸÑŸà⁄Øÿ±ŸÖ</div></div></div>
        <canvas id="factoryBarChart" height="200"></canvas>
      </div>
      <div class="chart-card">
        <div class="chart-header"><div><div class="chart-title">üìÖ ŸÅÿ±ÿßŸàÿßŸÜ€å ÿ¢ŸæÿØ€åÿ™ ÿ±Ÿàÿ≤ÿßŸÜŸá</div><div class="chart-subtitle">ÿ™ÿπÿØÿßÿØ ÿ¢ŸæÿØ€åÿ™ ÿØÿ± Ÿáÿ± ÿ±Ÿàÿ≤</div></div></div>
        <canvas id="updateFreqChart" height="200"></canvas>
      </div>
      <div class="chart-card">
        <div class="chart-header"><div><div class="chart-title">üìä ÿ≠ÿØÿßŸÇŸÑ / ÿ≠ÿØÿß⁄©ÿ´ÿ± ŸÇ€åŸÖÿ™</div><div class="chart-subtitle">ÿ®Ÿá ÿ™ŸÅ⁄©€å⁄© ŸÖÿ≠ÿµŸàŸÑ</div></div></div>
        <div id="minmax-table-wrap"></div>
      </div>
    </div>
  </div>

</div><!-- /supply-app -->

<!-- SUPPLY MODALS -->
<div class="supply-modal" id="s-product-modal">
  <div class="supply-modal-box">
    <div class="modal-header">
      <div class="modal-title" id="product-modal-title">üì¶ ÿßŸÅÿ≤ŸàÿØŸÜ ŸÖÿ≠ÿµŸàŸÑ</div>
      <button class="modal-close" onclick="closeSupplyModal('s-product-modal')">√ó</button>
    </div>
    <div class="form-group" style="margin-bottom:16px;"><div class="form-label">ŸÜÿßŸÖ ŸÖÿ≠ÿµŸàŸÑ *</div><input class="form-input" id="prod-name" placeholder="ŸÖÿ´ÿßŸÑ: ŸÜÿ®ÿ¥€åÿå ŸÖ€åŸÑ⁄Øÿ±ÿØ..."></div>
    <div class="form-group" style="margin-bottom:16px;"><div class="form-label">ÿØÿ≥ÿ™Ÿá‚Äåÿ®ŸÜÿØ€å *</div><select class="form-select" id="prod-category"><option value="ŸÖ€åŸÑ⁄Øÿ±ÿØ">ŸÖ€åŸÑ⁄Øÿ±ÿØ</option><option value="ÿ™€åÿ±ÿ¢ŸáŸÜ">ÿ™€åÿ±ÿ¢ŸáŸÜ</option><option value="Ÿàÿ±ŸÇ">Ÿàÿ±ŸÇ</option><option value="ŸÜÿ®ÿ¥€å">ŸÜÿ®ÿ¥€å</option><option value="ŸÑŸàŸÑŸá">ŸÑŸàŸÑŸá</option><option value="ŸÜÿßŸàÿØÿßŸÜ€å">ŸÜÿßŸàÿØÿßŸÜ€å</option><option value="Ÿæÿ±ŸàŸÅ€åŸÑ">Ÿæÿ±ŸàŸÅ€åŸÑ</option><option value="ŸÖŸÅÿ™ŸàŸÑ">ŸÖŸÅÿ™ŸàŸÑ</option><option value="ÿ≥ÿß€åÿ±">ÿ≥ÿß€åÿ±</option></select></div>
    <div class="form-group" style="margin-bottom:16px;"><div class="form-label">ÿ¢€å⁄©ŸàŸÜ</div><input class="form-input" id="prod-icon" placeholder="üî©" maxlength="2"></div>
    <div class="form-group" style="margin-bottom:16px;"><div class="form-label">Ÿàÿßÿ≠ÿØ ÿßŸÜÿØÿßÿ≤Ÿá‚Äå⁄Ø€åÿ±€å</div><select class="form-select" id="prod-unit"><option value="⁄©€åŸÑŸà⁄Øÿ±ŸÖ">⁄©€åŸÑŸà⁄Øÿ±ŸÖ</option><option value="ÿ™ŸÜ">ÿ™ŸÜ</option><option value="ÿ¥ÿßÿÆŸá">ÿ¥ÿßÿÆŸá</option><option value="ŸÖÿ™ÿ±">ŸÖÿ™ÿ±</option></select></div>
    <div class="form-group" style="margin-bottom:22px;"><div class="form-label">ÿ™Ÿàÿ∂€åÿ≠ÿßÿ™</div><input class="form-input" id="prod-desc" placeholder="ÿßÿÆÿ™€åÿßÿ±€å..."></div>
    <div class="btn-group">
      <button class="btn btn-accent" onclick="saveProduct()">‚úÖ ÿ∞ÿÆ€åÿ±Ÿá</button>
      <button class="btn btn-ghost" onclick="closeSupplyModal('s-product-modal')">ÿßŸÜÿµÿ±ÿßŸÅ</button>
    </div>
  </div>
</div>

<div class="supply-modal" id="s-factory-modal">
  <div class="supply-modal-box">
    <div class="modal-header">
      <div class="modal-title" id="factory-modal-title">üè≠ ÿßŸÅÿ≤ŸàÿØŸÜ ⁄©ÿßÿ±ÿÆÿßŸÜŸá</div>
      <button class="modal-close" onclick="closeSupplyModal('s-factory-modal')">√ó</button>
    </div>
    <div class="form-row">
      <div><div class="form-label">ŸÜÿßŸÖ ⁄©ÿßÿ±ÿÆÿßŸÜŸá *</div><input class="form-input" id="fac-name" placeholder="ŸÖÿ´ÿßŸÑ: ÿ∞Ÿàÿ®‚Äåÿ¢ŸáŸÜ ÿßÿµŸÅŸáÿßŸÜ"></div>
      <div><div class="form-label">ÿ¥Ÿáÿ±</div><input class="form-input" id="fac-city" placeholder="ŸÖÿ´ÿßŸÑ: ÿßÿµŸÅŸáÿßŸÜ"></div>
    </div>
    <div class="form-group" style="margin-bottom:16px;"><div class="form-label">ŸÖÿ≠ÿµŸàŸÑÿßÿ™ ÿ™ŸàŸÑ€åÿØ€å</div><input class="form-input" id="fac-products" placeholder="ŸÖÿ´ÿßŸÑ: ŸÖ€åŸÑ⁄Øÿ±ÿØÿå ÿ™€åÿ±ÿ¢ŸáŸÜ"></div>
    <div class="form-row">
      <div><div class="form-label">ÿ¥ŸÖÿßÿ±Ÿá ÿ™ŸÖÿßÿ≥</div><input class="form-input" id="fac-tel" placeholder="0311-..."></div>
      <div><div class="form-label">Ÿàÿ∂ÿπ€åÿ™</div><select class="form-select" id="fac-status"><option value="ŸÅÿπÿßŸÑ">ŸÅÿπÿßŸÑ</option><option value="ÿ∫€åÿ±ŸÅÿπÿßŸÑ">ÿ∫€åÿ±ŸÅÿπÿßŸÑ</option><option value="ÿØÿ± ÿ≠ÿßŸÑ ŸÖÿ∞ÿß⁄©ÿ±Ÿá">ÿØÿ± ÿ≠ÿßŸÑ ŸÖÿ∞ÿß⁄©ÿ±Ÿá</option></select></div>
    </div>
    <div class="form-group" style="margin:14px 0 22px;"><div class="form-label">ÿ™Ÿàÿ∂€åÿ≠ÿßÿ™</div><input class="form-input" id="fac-note" placeholder="ÿßÿÆÿ™€åÿßÿ±€å..."></div>
    <div class="btn-group">
      <button class="btn btn-accent" onclick="saveFactory()">‚úÖ ÿ∞ÿÆ€åÿ±Ÿá</button>
      <button class="btn btn-ghost" onclick="closeSupplyModal('s-factory-modal')">ÿßŸÜÿµÿ±ÿßŸÅ</button>
    </div>
  </div>
</div>

<div class="supply-modal" id="s-edit-price-modal">
  <div class="supply-modal-box">
    <div class="modal-header">
      <div class="modal-title">‚úèÔ∏è Ÿà€åÿ±ÿß€åÿ¥ ŸÇ€åŸÖÿ™</div>
      <button class="modal-close" onclick="closeSupplyModal('s-edit-price-modal')">√ó</button>
    </div>
    <div class="form-row">
      <div><div class="form-label">ŸÜŸàÿπ ÿ®ÿßÿ± *</div><select class="form-select" id="ep-product"></select></div>
      <div><div class="form-label">ÿ≥ÿß€åÿ≤ *</div><input class="form-input" id="ep-size"></div>
    </div>
    <div class="form-row">
      <div><div class="form-label">⁄©ÿßÿ±ÿÆÿßŸÜŸá *</div><select class="form-select" id="ep-factory"></select></div>
      <div><div class="form-label">ŸÇ€åŸÖÿ™ (ÿ™ŸàŸÖÿßŸÜ / ⁄©€åŸÑŸà) *</div><input class="form-input" id="ep-price" type="number"></div>
    </div>
    <div class="form-group" style="margin-bottom:22px;"><div class="form-label">ÿ™Ÿàÿ∂€åÿ≠ÿßÿ™</div><input class="form-input" id="ep-note"></div>
    <div class="btn-group">
      <button class="btn btn-accent" onclick="saveEditedPrice()">‚úÖ ÿ∞ÿÆ€åÿ±Ÿá ÿ™ÿ∫€å€åÿ±ÿßÿ™</button>
      <button class="btn btn-ghost" onclick="closeSupplyModal('s-edit-price-modal')">ÿßŸÜÿµÿ±ÿßŸÅ</button>
    </div>
  </div>
</div>

</div><!-- /supply-module -->

<!-- TOAST -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODULE: LOADING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="module-panel" id="loading-module">
<div style="max-width:1600px;margin:0 auto;padding:20px;">

  <div class="header" style="margin-bottom:22px;">
    <div class="header-left">
      <h1>üöõ ŸÖÿØ€åÿ±€åÿ™ ÿ®ÿßÿ±⁄Ø€åÿ±€å</h1>
      <p>ÿ≠ŸàÿßŸÑŸá‚ÄåŸáÿß€å ÿÆÿ±€åÿØ Ÿà ŸÅÿ±Ÿàÿ¥ ‚Äî ÿ®ÿßÿ±⁄Ø€åÿ±€å ÿ¥ÿØŸá ‚Äî ÿ¢ÿ±ÿ¥€åŸà</p>
    </div>
    <div class="header-right">
      <div class="live-badge"><div class="live-dot"></div>Real-time</div>
      <div class="master-clock" style="background:rgba(255,255,255,.15);padding:7px 14px;border-radius:20px;font-size:13px;color:white;" id="loading-clock">‚Äî</div>
    </div>
  </div>

  <div class="loading-tabs">
    <button class="loading-tab blue active" onclick="lTab('purchase',this)">üì• ÿ´ÿ®ÿ™ ŸÇÿ±ÿßÿ±ÿØÿßÿØ ÿÆÿ±€åÿØ</button>
    <button class="loading-tab orange" onclick="lTab('sale',this)">üì§ ÿ´ÿ®ÿ™ ŸÇÿ±ÿßÿ±ÿØÿßÿØ ŸÅÿ±Ÿàÿ¥</button>
    <button class="loading-tab green" onclick="lTab('loaded',this)">‚úÖ ÿ®ÿßÿ±⁄Ø€åÿ±€å ÿ¥ÿØŸá‚ÄåŸáÿß</button>
    <button class="loading-tab gray" onclick="lTab('archive',this)">üóÑÔ∏è ÿ¢ÿ±ÿ¥€åŸà</button>
  </div>

  <!-- ‚îÄ‚îÄ TAB: PURCHASE ‚îÄ‚îÄ -->
  <div id="loading-purchase" class="loading-section active">
    <div class="card">
      <div class="lcard-header">
        <div class="lcard-title">üì• ÿ´ÿ®ÿ™ ŸÇÿ±ÿßÿ±ÿØÿßÿØ ÿÆÿ±€åÿØ ŸÖŸàÿßÿØ ÿßŸàŸÑ€åŸá</div>
        <div class="lcard-actions">
          <span class="table-count" id="purchase-count">0 ÿ±ÿØ€åŸÅ</span>
          <button class="btn btn-primary btn-sm" onclick="lAddRow('purchase')">‚ûï ÿ±ÿØ€åŸÅ ÿ¨ÿØ€åÿØ</button>
          <button class="btn btn-warning btn-sm" onclick="lExportExcel('purchase')">üìä ÿÆÿ±Ÿàÿ¨€å ÿß⁄©ÿ≥ŸÑ</button>
          <button class="btn btn-warning btn-sm" onclick="lExportJSON('purchase')">üì• JSON</button>
          <label class="io-label green" style="padding:7px 12px;font-size:12px;">üìÇ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å<input type="file" class="hidden-file" accept=".json" onchange="lImportJSON(event,'purchase')"></label>
        </div>
      </div>
      <div class="ltable-wrap">
        <table class="ltable purchase">
          <thead>
            <tr>
              <th style="width:30px;">#</th>
              <th>ÿ¥ŸÖÿßÿ±Ÿá ŸÇÿ±ÿßÿ±ÿØÿßÿØ</th>
              <th>ŸÅÿ±Ÿàÿ¥ŸÜÿØŸá</th>
              <th>ŸÖÿ≠ŸÑ ÿ®ÿßÿ±⁄Ø€åÿ±€å</th>
              <th>ŸÜŸàÿπ ŸÇÿ±ÿßÿ±ÿØÿßÿØ</th>
              <th>ÿ¥ÿ±ÿ≠ (ŸÖÿ≠ÿµŸàŸÑ)</th>
              <th>ŸÜÿ≠ŸàŸá ÿ™ÿ≠Ÿà€åŸÑ</th>
              <th>ŸÜÿ≠ŸàŸá ÿ™ÿ≥Ÿà€åŸá</th>
              <th>ŸÖÿßŸÜÿØŸá ŸÇÿ±ÿßÿ±ÿØÿßÿØ (ÿ™ŸÜ)</th>
              <th>ÿ™ÿπŸáÿØ ÿÆÿ±€åÿØ</th>
              <th>ŸÖÿ®ŸÑÿ∫ Ÿàÿßÿ≠ÿØ</th>
              <th>ÿ™ÿßÿ±€åÿÆ</th>
              <th>Ÿàÿ∂ÿπ€åÿ™</th>
              <th style="width:50px;">ÿ®ÿßÿ±⁄Ø€åÿ±€å</th>
              <th style="width:36px;">ÿ≠ÿ∞ŸÅ</th>
            </tr>
          </thead>
          <tbody id="purchase-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ TAB: SALE ‚îÄ‚îÄ -->
  <div id="loading-sale" class="loading-section">
    <div class="card">
      <div class="lcard-header">
        <div class="lcard-title">üì§ ÿ´ÿ®ÿ™ ŸÇÿ±ÿßÿ±ÿØÿßÿØ ŸÅÿ±Ÿàÿ¥ ŸÖŸàÿßÿØ ÿßŸàŸÑ€åŸá</div>
        <div class="lcard-actions">
          <span class="table-count" id="sale-count">0 ÿ±ÿØ€åŸÅ</span>
          <button class="btn btn-accent btn-sm" onclick="lAddRow('sale')">‚ûï ÿ±ÿØ€åŸÅ ÿ¨ÿØ€åÿØ</button>
          <button class="btn btn-warning btn-sm" onclick="lExportExcel('sale')">üìä ÿÆÿ±Ÿàÿ¨€å ÿß⁄©ÿ≥ŸÑ</button>
          <button class="btn btn-warning btn-sm" onclick="lExportJSON('sale')">üì• JSON</button>
          <label class="io-label green" style="padding:7px 12px;font-size:12px;">üìÇ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å<input type="file" class="hidden-file" accept=".json" onchange="lImportJSON(event,'sale')"></label>
        </div>
      </div>
      <div class="ltable-wrap">
        <table class="ltable orange">
          <thead>
            <tr>
              <th style="width:30px;">#</th>
              <th>ÿ¥ŸÖÿßÿ±Ÿá ŸÇÿ±ÿßÿ±ÿØÿßÿØ</th>
              <th>ÿÆÿ±€åÿØÿßÿ±</th>
              <th>ŸÖÿ≠ŸÑ ÿ®ÿßÿ±⁄Ø€åÿ±€å</th>
              <th>ŸÜŸàÿπ ŸÇÿ±ÿßÿ±ÿØÿßÿØ</th>
              <th>ÿ¥ÿ±ÿ≠ (ŸÖÿ≠ÿµŸàŸÑ)</th>
              <th>ŸÜÿ≠ŸàŸá ÿ™ÿ≠Ÿà€åŸÑ</th>
              <th>ŸÜÿ≠ŸàŸá ÿ™ÿ≥Ÿà€åŸá</th>
              <th>ŸÖÿßŸÜÿØŸá ŸÇÿ±ÿßÿ±ÿØÿßÿØ (ÿ™ŸÜ)</th>
              <th>ŸÖÿ®ŸÑÿ∫ Ÿàÿßÿ≠ÿØ</th>
              <th>ÿ™ÿßÿ±€åÿÆ</th>
              <th>Ÿàÿ∂ÿπ€åÿ™</th>
              <th style="width:50px;">ÿ®ÿßÿ±⁄Ø€åÿ±€å</th>
              <th style="width:36px;">ÿ≠ÿ∞ŸÅ</th>
            </tr>
          </thead>
          <tbody id="sale-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ TAB: LOADED ‚îÄ‚îÄ -->
  <div id="loading-loaded" class="loading-section">
    <div class="card">
      <div class="lcard-header">
        <div class="lcard-title">‚úÖ ÿ®ÿßÿ±⁄Ø€åÿ±€å ÿ¥ÿØŸá‚ÄåŸáÿß</div>
        <div class="lcard-actions">
          <span class="table-count" id="loaded-count">0 ÿ±ÿØ€åŸÅ</span>
          <button class="btn btn-warning btn-sm" onclick="lExportExcel('loaded')">üìä ÿÆÿ±Ÿàÿ¨€å ÿß⁄©ÿ≥ŸÑ</button>
          <button class="btn btn-warning btn-sm" onclick="lExportJSON('loaded')">üì• JSON</button>
        </div>
      </div>
      <div class="ltable-wrap">
        <table class="ltable green">
          <thead>
            <tr>
              <th style="width:30px;">#</th>
              <th>ŸÜŸàÿπ</th>
              <th>ÿ¥ŸÖÿßÿ±Ÿá ŸÇÿ±ÿßÿ±ÿØÿßÿØ</th>
              <th>ŸÅÿ±Ÿàÿ¥ŸÜÿØŸá/ÿÆÿ±€åÿØÿßÿ±</th>
              <th>ŸÖÿ≠ŸÑ ÿ®ÿßÿ±⁄Ø€åÿ±€å</th>
              <th>ÿ¥ÿ±ÿ≠</th>
              <th>ŸÖŸÇÿØÿßÿ± ÿ®ÿßÿ±⁄Ø€åÿ±€å (kg)</th>
              <th>ŸÖÿ®ŸÑÿ∫ Ÿàÿßÿ≠ÿØ</th>
              <th>ŸÜÿßŸÖ ÿ±ÿßŸÜŸÜÿØŸá</th>
              <th>ÿ¥ŸÖÿßÿ±Ÿá / ŸÖÿ¥ÿÆÿµÿßÿ™</th>
              <th>ÿ¥ŸÖÿßÿ±Ÿá ÿ®ÿßÿ±ŸÜÿßŸÖŸá</th>
              <th>ÿ¥Ÿáÿ± ŸÖÿ®ÿØÿß</th>
              <th>ÿ¥Ÿáÿ± ŸÖŸÇÿµÿØ</th>
              <th>ŸÖÿ≥ÿßŸÅÿ™ (km)</th>
              <th>⁄©ÿ±ÿß€åŸá ÿßÿ≥ÿ™ÿπŸÑÿßŸÖ€å</th>
              <th>⁄©ÿ±ÿß€åŸá ŸàÿßŸÇÿπ€å</th>
              <th>ÿ®ÿßÿ≥⁄©ŸàŸÑ</th>
              <th>Ÿàÿ∂ÿπ€åÿ™</th>
              <th>ÿ™ÿßÿ±€åÿÆ ÿ®ÿßÿ±⁄Ø€åÿ±€å</th>
              <th style="width:60px;">ÿ¢ÿ±ÿ¥€åŸà</th>
              <th style="width:36px;">ÿ≠ÿ∞ŸÅ</th>
            </tr>
          </thead>
          <tbody id="loaded-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ TAB: ARCHIVE ‚îÄ‚îÄ -->
  <div id="loading-archive" class="loading-section">
    <div class="card">
      <div class="lcard-header">
        <div class="lcard-title">üóÑÔ∏è ÿ¢ÿ±ÿ¥€åŸà ÿ®ÿßÿ±⁄Ø€åÿ±€å‚ÄåŸáÿß</div>
        <div class="lcard-actions">
          <span class="table-count" id="archive-count">0 ÿ±ÿØ€åŸÅ</span>
          <button class="btn btn-warning btn-sm" onclick="lExportExcel('archive')">üìä ÿÆÿ±Ÿàÿ¨€å ÿß⁄©ÿ≥ŸÑ</button>
          <button class="btn btn-warning btn-sm" onclick="lExportJSON('archive')">üì• JSON</button>
        </div>
      </div>
      <div class="ltable-wrap">
        <table class="ltable gray">
          <thead>
            <tr>
              <th style="width:30px;">#</th>
              <th>ŸÜŸàÿπ</th>
              <th>ÿ¥ŸÖÿßÿ±Ÿá ŸÇÿ±ÿßÿ±ÿØÿßÿØ</th>
              <th>ŸÅÿ±Ÿàÿ¥ŸÜÿØŸá/ÿÆÿ±€åÿØÿßÿ±</th>
              <th>ŸÖÿ≠ŸÑ ÿ®ÿßÿ±⁄Ø€åÿ±€å</th>
              <th>ÿ¥ÿ±ÿ≠</th>
              <th>ŸÖŸÇÿØÿßÿ± (kg)</th>
              <th>ŸÖÿ®ŸÑÿ∫ Ÿàÿßÿ≠ÿØ</th>
              <th>ŸÜÿßŸÖ ÿ±ÿßŸÜŸÜÿØŸá</th>
              <th>ÿ¥ŸÖÿßÿ±Ÿá ÿ®ÿßÿ±ŸÜÿßŸÖŸá</th>
              <th>ŸÖÿ®ÿØÿß ‚Üí ŸÖŸÇÿµÿØ</th>
              <th>⁄©ÿ±ÿß€åŸá ŸàÿßŸÇÿπ€å</th>
              <th>Ÿàÿ∂ÿπ€åÿ™</th>
              <th>ÿ™ÿßÿ±€åÿÆ ÿ®ÿßÿ±⁄Ø€åÿ±€å</th>
              <th>ÿ™ÿßÿ±€åÿÆ ÿ¢ÿ±ÿ¥€åŸà</th>
              <th style="width:36px;">ÿ≠ÿ∞ŸÅ</th>
            </tr>
          </thead>
          <tbody id="archive-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- ‚îÄ‚îÄ DRIVER MODAL ‚îÄ‚îÄ -->
<div id="driver-modal" style="display:none;">
  <div class="driver-modal-overlay" onclick="driverModalCancel()">
    <div class="driver-modal" onclick="event.stopPropagation()">
      <h3>üöõ ÿßÿ∑ŸÑÿßÿπÿßÿ™ ÿ®ÿßÿ±⁄Ø€åÿ±€å</h3>
      <p id="driver-modal-subtitle">ŸÖÿ¥ÿÆÿµÿßÿ™ ÿ±ÿßŸÜŸÜÿØŸá Ÿà ÿ®ÿßÿ± ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ</p>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="dm-field">
          <label class="dm-label">üë§ ŸÜÿßŸÖ ÿ±ÿßŸÜŸÜÿØŸá</label>
          <input class="dm-input" id="dm-driver-name" type="text" placeholder="ÿπŸÑ€å ŸÖÿ≠ŸÖÿØ€å">
        </div>
        <div class="dm-field">
          <label class="dm-label">üìã ÿ¥ŸÖÿßÿ±Ÿá / ŸÖÿ¥ÿÆÿµÿßÿ™ ÿ±ÿßŸÜŸÜÿØŸá</label>
          <input class="dm-input" id="dm-driver-info" type="text" placeholder="ŸæŸÑÿß⁄© ‚Äî ŸÜŸàÿπ ÿÆŸàÿØÿ±Ÿà">
        </div>
        <div class="dm-field">
          <label class="dm-label">üìÑ ÿ¥ŸÖÿßÿ±Ÿá ÿ®ÿßÿ±ŸÜÿßŸÖŸá</label>
          <input class="dm-input" id="dm-waybill" type="text" placeholder="ÿ¥ŸÖÿßÿ±Ÿá ÿ®ÿßÿ±ŸÜÿßŸÖŸá">
        </div>
        <div class="dm-field">
          <label class="dm-label">‚öñÔ∏è ŸÖŸÇÿØÿßÿ± ÿ®ÿßÿ±⁄Ø€åÿ±€å (kg)</label>
          <input class="dm-input" id="dm-load-qty" type="text" inputmode="numeric" placeholder="ŸÖŸÇÿØÿßÿ± ÿ®Ÿá ⁄©€åŸÑŸà⁄Øÿ±ŸÖ" style="direction:ltr;">
        </div>
        <div class="dm-field">
          <label class="dm-label">üèôÔ∏è ÿ¥Ÿáÿ± ŸÖÿ®ÿØÿß</label>
          <input class="dm-input" id="dm-from-city" type="text" placeholder="ŸÖÿ®ÿØÿß" oninput="dmAutoFreight()">
        </div>
        <div class="dm-field">
          <label class="dm-label">üèôÔ∏è ÿ¥Ÿáÿ± ŸÖŸÇÿµÿØ</label>
          <input class="dm-input" id="dm-to-city" type="text" placeholder="ŸÖŸÇÿµÿØ" oninput="dmAutoFreight()">
        </div>
        <div class="dm-field">
          <label class="dm-label">üìè ŸÖÿ≥ÿßŸÅÿ™ (km)</label>
          <input class="dm-input" id="dm-distance" type="text" inputmode="numeric" placeholder="ŸÖÿ≥ÿßŸÅÿ™" style="direction:ltr;">
        </div>
        <div class="dm-field">
          <label class="dm-label">üí∞ ⁄©ÿ±ÿß€åŸá ÿßÿ≥ÿ™ÿπŸÑÿßŸÖ€å (ÿ™ŸàŸÖÿßŸÜ/ÿ™ŸÜ)</label>
          <input class="dm-input" id="dm-freight-quoted" type="text" readonly style="background:#f9fafb;direction:ltr;" placeholder="ÿÆŸàÿØ⁄©ÿßÿ± ÿßÿ≤ ÿ¨ÿØŸàŸÑ ⁄©ÿ±ÿß€åŸá">
        </div>
        <div class="dm-field">
          <label class="dm-label">üíµ ⁄©ÿ±ÿß€åŸá ŸàÿßŸÇÿπ€å (ÿ™ŸàŸÖÿßŸÜ/ÿ™ŸÜ)</label>
          <input class="dm-input" id="dm-freight-actual" type="text" inputmode="numeric" placeholder="⁄©ÿ±ÿß€åŸá ŸàÿßŸÇÿπ€å" style="direction:ltr;">
        </div>
        <div class="dm-field">
          <label class="dm-label">‚öñÔ∏è ÿ®ÿßÿ≥⁄©ŸàŸÑ</label>
          <input class="dm-input" id="dm-scale" type="text" placeholder="Ÿàÿ≤ŸÜ ÿ®ÿßÿ≥⁄©ŸàŸÑ">
        </div>
        <div class="dm-field">
          <label class="dm-label">üìÖ ÿ™ÿßÿ±€åÿÆ ÿ®ÿßÿ±⁄Ø€åÿ±€å</label>
          <input class="dm-input" id="dm-loaded-at" type="text" placeholder="€±€¥€∞€¥/€±€±/€≤€∏">
        </div>
        <div class="dm-field">
          <label class="dm-label">üîñ Ÿàÿ∂ÿπ€åÿ™</label>
          <select class="dm-input" id="dm-status">
            <option value="ÿØÿ± ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ™ÿ≥Ÿà€åŸá">ÿØÿ± ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ™ÿ≥Ÿà€åŸá</option>
            <option value="ÿßÿπŸÑÿßŸÖ ÿ®ÿßÿ±">ÿßÿπŸÑÿßŸÖ ÿ®ÿßÿ±</option>
            <option value="ÿØÿ± ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ®ÿßÿ≥⁄©ŸàŸÑ">ÿØÿ± ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ®ÿßÿ≥⁄©ŸàŸÑ</option>
            <option value="ÿØÿ± ŸÖÿ≥€åÿ±">ÿØÿ± ŸÖÿ≥€åÿ±</option>
            <option value="ÿ™ÿ≠Ÿà€åŸÑ ÿØÿßÿØŸá ÿ¥ÿØŸá">ÿ™ÿ≠Ÿà€åŸÑ ÿØÿßÿØŸá ÿ¥ÿØŸá</option>
          </select>
        </div>
      </div>
      <div class="dm-row" style="margin-top:18px;">
        <button class="dm-confirm" onclick="driverModalConfirm()">‚úÖ ÿ™ÿ£€å€åÿØ Ÿà ÿßŸÜÿ™ŸÇÿßŸÑ ÿ®Ÿá ÿ®ÿßÿ±⁄Ø€åÿ±€å ÿ¥ÿØŸá‚ÄåŸáÿß</button>
        <button class="dm-cancel" onclick="driverModalCancel()">ÿßŸÜÿµÿ±ÿßŸÅ</button>
      </div>
    </div>
  </div>
</div>

</div><!-- /loading-module -->

<div class="s-toast" id="s-toast"></div>

<!-- MASTER SCRIPT -->
<script>
let activeModule = null;

function switchModule(mod) {
  document.querySelectorAll('.module-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.master-module-btn').forEach(b => b.classList.remove('active'));
  const panel = document.getElementById(mod+'-module');
  const btn   = document.getElementById('btn-'+mod);
  if (panel) panel.classList.add('active');
  if (btn)   btn.classList.add('active');
  activeModule = mod;
  sessionStorage.setItem('activeModule', mod);
  if (mod === 'supply' && !window._supplyInited) { window._supplyInited = true; supplyInit(); }
  if (mod === 'warehouse' && !window._whInited)   { window._whInited = true; whInit(); }
  if (mod === 'freight'   && !window._frInited)   { window._frInited = true; frInit(); }
  if (mod === 'overview') { ovRefresh(); }
}

function masterClock() {
  const now = new Date();
  const str = now.toLocaleDateString('fa-IR') + '  ' + now.toLocaleTimeString('fa-IR');
  document.getElementById('master-clock').textContent = str;
  const sc = document.getElementById('supply-clock');
  if (sc) sc.textContent = str;
}
setInterval(masterClock, 1000);
masterClock();

function masterLogout() { if (typeof doLogout === 'function') doLogout(); }

function syncMasterNav() {
  const mgr = sessionStorage.getItem('currentManager');
  const ub = document.getElementById('master-user-badge');
  const lb = document.getElementById('master-logout-btn');
  const nav = document.getElementById('master-nav');
  if (mgr) {
    document.getElementById('master-user-name').textContent = mgr;
    ub.style.display = 'flex';
    lb.style.display = 'block';
    nav.classList.remove('login-mode');
  } else {
    ub.style.display = 'none';
    lb.style.display = 'none';
    nav.classList.add('login-mode');
  }
}
setInterval(syncMasterNav, 500);
syncMasterNav();

function masterInit() {
  const saved = sessionStorage.getItem('activeModule');
  const mgr = sessionStorage.getItem('currentManager');
  switchModule((mgr && saved) ? saved : 'eval');
  syncMasterNav();
}
</script>

<!-- EVAL SCRIPT -->
<script>
const firebaseConfig = {
  apiKey:"AIzaSyDeKK6THwUcR2hoh-VUiwAX7p79NL6UPQQ",
  authDomain:"employee-evaluation-adva-9231e.firebaseapp.com",
  projectId:"employee-evaluation-adva-9231e",
  storageBucket:"employee-evaluation-adva-9231e.firebasestorage.app",
  messagingSenderId:"151913486905",
  appId:"1:151913486905:web:b6c183ae02c67fd4368be8"
};

let database = null;
let isFirebaseConfigured = false;
try {
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  else firebase.app();
  database = firebase.database();
  isFirebaseConfigured = true;
} catch(e) { console.error('Firebase eval error:', e); }

let currentManager = null;

function doLogin() {
  const sel = document.getElementById('login-manager-select');
  const err = document.getElementById('login-error');
  if (!sel.value) { err.style.display='flex'; return; }
  err.style.display = 'none';
  currentManager = sel.value;
  sessionStorage.setItem('currentManager', currentManager);
  document.getElementById('login-overlay').style.display = 'none';
  document.getElementById('main-app').style.display = 'block';
  document.getElementById('current-manager-display').textContent = currentManager;
  document.getElementById('eval-manager-label').textContent = currentManager;
  sInitApp();
}

function doLogout() {
  if (!confirm('ÿ¢€åÿß ŸÖ€å‚ÄåÿÆŸàÿßŸá€åÿØ ÿßÿ≤ ÿ≥€åÿ≥ÿ™ŸÖ ÿÆÿßÿ±ÿ¨ ÿ¥Ÿà€åÿØÿü')) return;
  currentManager = null;
  sessionStorage.removeItem('currentManager');
  document.getElementById('main-app').style.display = 'none';
  document.getElementById('login-overlay').style.display = 'flex';
  document.getElementById('login-manager-select').value = '';
}

window.addEventListener('DOMContentLoaded', function() {
  const saved = sessionStorage.getItem('currentManager');
  if (saved) { document.getElementById('login-manager-select').value = saved; doLogin(); }
  const dateInput = document.getElementById('evaluation-date');
  if (dateInput) dateInput.valueAsDate = new Date();
  const monthSel = document.getElementById('star-month-selector');
  if (monthSel) {
    const now = new Date();
    monthSel.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  }
  masterInit();
});

const defaultDepartments = {
  'ŸÅÿ±Ÿàÿ¥':{name:'ŸÅÿ±Ÿàÿ¥',icon:'üí∞',class:'dept-sales',criteria:[{id:1,name:'ÿ™ÿ≠ŸÇŸÇ ÿßŸáÿØÿßŸÅ ŸÅÿ±Ÿàÿ¥',weight:20},{id:2,name:'ŸÖÿ∞ÿß⁄©ÿ±Ÿá Ÿà ÿßÿ±ÿ™ÿ®ÿßÿ∑ ÿ®ÿß ŸÖÿ¥ÿ™ÿ±€å',weight:15},{id:3,name:'ÿ¨ÿ∞ÿ® ŸÖÿ¥ÿ™ÿ±€åÿßŸÜ ÿ¨ÿØ€åÿØ',weight:15},{id:4,name:'ÿ≠ŸÅÿ∏ Ÿà ŸÜ⁄ØŸáÿØÿßÿ±€å ŸÖÿ¥ÿ™ÿ±€å',weight:12},{id:5,name:'⁄Øÿ≤ÿßÿ±ÿ¥‚ÄåÿØŸá€å Ÿà Ÿæ€å⁄Ø€åÿ±€å',weight:10},{id:6,name:'ÿØÿßŸÜÿ¥ ŸÖÿ≠ÿµŸàŸÑ',weight:10},{id:7,name:'⁄©ÿßÿ± ÿ™€åŸÖ€å',weight:8},{id:8,name:'ÿ±ÿπÿß€åÿ™ ÿßÿµŸàŸÑ ÿßÿÆŸÑÿßŸÇ€å',weight:10}]},
  'ÿπŸÖŸÑ€åÿßÿ™':{name:'ÿπŸÖŸÑ€åÿßÿ™',icon:'‚öôÔ∏è',class:'dept-operations',criteria:[{id:1,name:'⁄©€åŸÅ€åÿ™ ÿπŸÖŸÑ€åÿßÿ™ ÿßŸÜÿ¨ÿßŸÖ ÿ¥ÿØŸá',weight:18},{id:2,name:'ÿ±ÿπÿß€åÿ™ ÿßÿ≥ÿ™ÿßŸÜÿØÿßÿ±ÿØŸáÿß',weight:15},{id:3,name:'ŸÖÿØ€åÿ±€åÿ™ ÿ≤ŸÖÿßŸÜ Ÿà ÿ≥ÿ±ÿπÿ™',weight:13},{id:4,name:'ÿ®Ÿáÿ±Ÿá‚ÄåŸàÿ±€å Ÿà ⁄©ÿßÿ±ÿß€å€å',weight:15},{id:5,name:'ÿß€åŸÖŸÜ€å Ÿà ÿ®ŸáÿØÿßÿ¥ÿ™',weight:12},{id:6,name:'ÿ≠ŸÑ ŸÖÿ≥ÿßÿ¶ŸÑ ŸÅŸÜ€å',weight:10},{id:7,name:'ŸáŸÖ⁄©ÿßÿ±€å ÿ®ÿß ÿ™€åŸÖ',weight:9},{id:8,name:'Ÿæ€åÿ¥⁄Ø€åÿ±€å ÿßÿ≤ ÿßÿ™ŸÑÿßŸÅ ŸÖŸÜÿßÿ®ÿπ',weight:8}]},
  'ŸÖŸÜÿßÿ®ÿπ ÿßŸÜÿ≥ÿßŸÜ€å':{name:'ŸÖŸÜÿßÿ®ÿπ ÿßŸÜÿ≥ÿßŸÜ€å',icon:'üë•',class:'dept-hr',criteria:[{id:1,name:'ÿ¨ÿ∞ÿ® Ÿà ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÖÿ§ÿ´ÿ±',weight:15},{id:2,name:'ŸÖÿØ€åÿ±€åÿ™ ÿπŸÖŸÑ⁄©ÿ±ÿØ ⁄©ÿßÿ±⁄©ŸÜÿßŸÜ',weight:15},{id:3,name:'ÿ¢ŸÖŸàÿ≤ÿ¥ Ÿà ÿ™Ÿàÿ≥ÿπŸá',weight:13},{id:4,name:'ÿßÿ±ÿ™ÿ®ÿßÿ∑ÿßÿ™ ÿ≥ÿßÿ≤ŸÖÿßŸÜ€å',weight:12},{id:5,name:'ÿ±ÿπÿß€åÿ™ ŸÇŸàÿßŸÜ€åŸÜ ⁄©ÿßÿ±',weight:12},{id:6,name:'ÿ≠ŸÑ ÿ™ÿπÿßÿ±ÿ∂ÿßÿ™',weight:11},{id:7,name:'ÿ®ÿ±ŸÜÿßŸÖŸá‚Äåÿ±€åÿ≤€å ŸÜ€åÿ±Ÿà€å ÿßŸÜÿ≥ÿßŸÜ€å',weight:12},{id:8,name:'ÿ±ÿ∂ÿß€åÿ™ ⁄©ÿßÿ±⁄©ŸÜÿßŸÜ',weight:10}]},
  'ŸÖÿßŸÑ€å':{name:'ŸÖÿßŸÑ€å',icon:'üíµ',class:'dept-finance',criteria:[{id:1,name:'ÿØŸÇÿ™ ÿØÿ± ŸÖÿ≠ÿßÿ≥ÿ®ÿßÿ™ ŸÖÿßŸÑ€å',weight:20},{id:2,name:'⁄Øÿ≤ÿßÿ±ÿ¥‚ÄåÿØŸá€å ÿ®Ÿá ŸÖŸàŸÇÿπ',weight:15},{id:3,name:'ÿ±ÿπÿß€åÿ™ ÿßÿµŸàŸÑ ÿ≠ÿ≥ÿßÿ®ÿØÿßÿ±€å',weight:15},{id:4,name:'⁄©ŸÜÿ™ÿ±ŸÑ Ÿà ÿ®ŸàÿØÿ¨Ÿá‚Äåÿ®ŸÜÿØ€å',weight:12},{id:5,name:'ÿ™ÿ≠ŸÑ€åŸÑ ŸÖÿßŸÑ€å',weight:12},{id:6,name:'ŸÖÿØ€åÿ±€åÿ™ ŸÜŸÇÿØ€åŸÜ⁄Ø€å',weight:10},{id:7,name:'ÿ±ÿπÿß€åÿ™ ŸÇŸàÿßŸÜ€åŸÜ ŸÖÿßŸÑ€åÿßÿ™€å',weight:8},{id:8,name:'ŸÖÿ≠ÿ±ŸÖÿßŸÜ⁄Ø€å ÿßÿ∑ŸÑÿßÿπÿßÿ™',weight:8}]},
  'IT':{name:'IT',icon:'üíª',class:'dept-it',criteria:[{id:1,name:'ÿ≠ŸÑ ŸÖÿ≥ÿßÿ¶ŸÑ ŸÅŸÜ€å',weight:18},{id:2,name:'Ÿæÿ¥ÿ™€åÿ®ÿßŸÜ€å ÿ≥€åÿ≥ÿ™ŸÖ‚ÄåŸáÿß',weight:15},{id:3,name:'ÿßŸÖŸÜ€åÿ™ ÿßÿ∑ŸÑÿßÿπÿßÿ™',weight:16},{id:4,name:'ÿ™Ÿàÿ≥ÿπŸá Ÿà ÿ®Ÿá‚Äåÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å',weight:13},{id:5,name:'ŸÖÿ≥ÿ™ŸÜÿØÿ≥ÿßÿ≤€å',weight:10},{id:6,name:'Ÿæÿßÿ≥ÿÆ⁄ØŸà€å€å ÿ®Ÿá ⁄©ÿßÿ±ÿ®ÿ±ÿßŸÜ',weight:12},{id:7,name:'€åÿßÿØ⁄Ø€åÿ±€å ÿ™⁄©ŸÜŸàŸÑŸà⁄ò€å‚ÄåŸáÿß€å ÿ¨ÿØ€åÿØ',weight:8},{id:8,name:'⁄©ÿßÿ± ÿ™€åŸÖ€å ÿØÿ± Ÿæÿ±Ÿà⁄òŸá‚ÄåŸáÿß',weight:8}]},
  'ÿ™ŸàŸÑ€åÿØ':{name:'ÿ™ŸàŸÑ€åÿØ',icon:'üè≠',class:'dept-production',criteria:[{id:1,name:'⁄©€åŸÅ€åÿ™ ŸÖÿ≠ÿµŸàŸÑ ÿ™ŸàŸÑ€åÿØ€å',weight:20},{id:2,name:'ÿ±ÿπÿß€åÿ™ ÿ®ÿ±ŸÜÿßŸÖŸá ÿ™ŸàŸÑ€åÿØ',weight:15},{id:3,name:'ÿ®Ÿáÿ±Ÿá‚ÄåŸàÿ±€å ÿÆÿ∑ ÿ™ŸàŸÑ€åÿØ',weight:15},{id:4,name:'⁄©ÿßŸáÿ¥ ÿ∂ÿß€åÿπÿßÿ™',weight:12},{id:5,name:'ÿß€åŸÖŸÜ€å Ÿà ÿ®ŸáÿØÿßÿ¥ÿ™ ⁄©ÿßÿ±',weight:12},{id:6,name:'ŸÜ⁄ØŸáÿØÿßÿ±€å ÿ™ÿ¨Ÿá€åÿ≤ÿßÿ™',weight:10},{id:7,name:'ŸáŸÖ⁄©ÿßÿ±€å ÿ®ÿß ÿ™€åŸÖ ÿ™ŸàŸÑ€åÿØ',weight:8},{id:8,name:'ÿ®Ÿáÿ®ŸàÿØ ŸÖÿ≥ÿ™ŸÖÿ± ŸÅÿ±ÿ¢€åŸÜÿØ',weight:8}]}
};

let departments={}, evaluations=[], employees=[], currentDepartment=null, currentEditingDepartment=null, currentEditingEmployee=null;

function sInitApp() {
  const statusDot = document.getElementById('status-dot');
  const statusText = document.getElementById('status-text');
  if (isFirebaseConfigured) {
    statusDot.style.background='#10b981';
    statusDot.style.animation='pulse 2s infinite';
    statusText.textContent='ŸÖÿ™ÿµŸÑ ÿ®Ÿá Firebase';
    database.ref('.info/connected').on('value',snap=>{
      statusDot.style.background = snap.val()?'#10b981':'#ef4444';
      statusText.textContent = snap.val()?'ŸÖÿ™ÿµŸÑ ÿ®Ÿá Firebase':'ŸÇÿ∑ÿπ ÿ¥ÿØŸá';
    });
  } else {
    statusDot.style.background='#f59e0b';
    statusText.textContent='ÿ≠ÿßŸÑÿ™ ÿ¢ŸÅŸÑÿß€åŸÜ';
  }
  loadDepartments(); loadEvaluations(); loadEmployees();
  document.getElementById('evaluation-date').valueAsDate = new Date();
}

function loadDepartments() {
  if (isFirebaseConfigured) {
    database.ref('departments').on('value',snap=>{
      departments = snap.exists() ? snap.val() : JSON.parse(JSON.stringify(defaultDepartments));
      if (!snap.exists()) database.ref('departments').set(departments);
      populateDepartmentDropdown(); populateNewEmployeeDepartment(); updateDepartmentsView();
    });
  } else {
    departments = JSON.parse(localStorage.getItem('departments'))||JSON.parse(JSON.stringify(defaultDepartments));
    populateDepartmentDropdown(); populateNewEmployeeDepartment(); updateDepartmentsView();
  }
}

function populateDepartmentDropdown() {
  const sel = document.getElementById('employee-department');
  sel.innerHTML = '<option value="">ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ...</option>';
  Object.keys(departments).forEach(k=>{
    const d=departments[k];
    sel.insertAdjacentHTML('beforeend',`<option value="${k}">${d.icon} ${d.name}</option>`);
  });
}

function populateNewEmployeeDepartment() {
  ['new-emp-department','edit-emp-department'].forEach(id=>{
    const sel=document.getElementById(id);
    if (!sel) return;
    const cur=sel.value;
    sel.innerHTML='<option value="">ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ...</option>';
    Object.keys(departments).forEach(k=>{
      const d=departments[k];
      sel.insertAdjacentHTML('beforeend',`<option value="${k}"${k===cur?' selected':''}>${d.icon} ${d.name}</option>`);
    });
  });
}

function loadEvaluations() {
  if (isFirebaseConfigured) {
    database.ref('evaluations').on('value',snap=>{
      evaluations = snap.exists()?Object.values(snap.val()):[];
      onEvaluationsUpdated();
    });
  } else {
    evaluations = JSON.parse(localStorage.getItem('sharedEvaluations'))||[];
    onEvaluationsUpdated();
  }
}

function onEvaluationsUpdated() {
  const activeSection = document.querySelector('#eval-module .section.active');
  if (!activeSection) return;
  const id = activeSection.id;
  if (id==='my-history-section') renderMyHistory();
  if (id==='shared-dashboard-section') renderSharedDashboard();
  if (id==='star-employees-section') updateStarEmployees();
}

function loadEmployees() {
  if (isFirebaseConfigured) {
    database.ref('employees').on('value',snap=>{
      employees = snap.exists()?Object.values(snap.val()):[];
      updateEmployeesManagementList();
    });
  } else {
    employees = JSON.parse(localStorage.getItem('employees'))||[];
    updateEmployeesManagementList();
  }
}

function populateEmployeeDropdown(filterDept=null) {
  const sel=document.getElementById('employee-name');
  let list = filterDept?employees.filter(e=>e.department===filterDept):employees;
  list = [...list].sort((a,b)=>a.name.localeCompare(b.name,'fa'));
  sel.innerHTML='<option value="">ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ...</option>';
  list.forEach(emp=>sel.insertAdjacentHTML('beforeend',`<option value="${emp.name}">${emp.name}</option>`));
  if (list.length===0) sel.innerHTML='<option value="">⁄©ÿßÿ±ŸÖŸÜÿØ€å ÿ®ÿ±ÿß€å ÿß€åŸÜ ÿ®ÿÆÿ¥ ÿ´ÿ®ÿ™ ŸÜÿ¥ÿØŸá</option>';
}

function handleDepartmentChange() {
  const deptKey=document.getElementById('employee-department').value;
  populateEmployeeDropdown(deptKey||null);
  loadDepartmentCriteria();
}

function loadDepartmentCriteria() {
  const deptKey=document.getElementById('employee-department').value;
  if (!deptKey){
    document.getElementById('evaluation-criteria').innerHTML='';
    document.getElementById('department-badge-container').innerHTML='';
    document.getElementById('total-score-container').style.display='none';
    currentDepartment=null; return;
  }
  currentDepartment=departments[deptKey];
  document.getElementById('department-badge-container').innerHTML=
    `<div class="department-badge ${currentDepartment.class}">${currentDepartment.icon} ÿ®ÿÆÿ¥ ${currentDepartment.name}</div>`;
  const container=document.getElementById('evaluation-criteria');
  container.innerHTML='';
  currentDepartment.criteria.forEach(c=>{
    container.insertAdjacentHTML('beforeend',`
      <div class="eval-section">
        <div class="eval-section-header">
          <div class="eval-section-title">${c.name}</div>
          <div class="eval-weight">ÿ∂ÿ±€åÿ®: ${c.weight}</div>
        </div>
        <div class="score-slider-container">
          <input type="range" min="1" max="10" value="5" class="score-slider" id="slider-${c.id}" oninput="updateScore(${c.id},${c.weight})">
          <div class="score-display" id="display-${c.id}">5</div>
        </div>
        <div class="weighted-score" id="weighted-${c.id}">ÿßŸÖÿ™€åÿßÿ≤ Ÿàÿ≤ŸÜ€å: ${5*c.weight}</div>
      </div>`);
  });
  document.getElementById('total-score-container').style.display='block';
  calculateTotalScore();
}

function updateScore(id,weight){
  const val=parseInt(document.getElementById(`slider-${id}`).value);
  document.getElementById(`display-${id}`).textContent=val;
  document.getElementById(`weighted-${id}`).textContent=`ÿßŸÖÿ™€åÿßÿ≤ Ÿàÿ≤ŸÜ€å: ${val*weight}`;
  calculateTotalScore();
}

function calculateTotalScore(){
  if (!currentDepartment) return;
  let total=0,maxScore=0;
  currentDepartment.criteria.forEach(c=>{
    const sl=document.getElementById(`slider-${c.id}`);
    if (sl) total+=parseInt(sl.value)*c.weight;
    maxScore+=10*c.weight;
  });
  document.getElementById('total-score').textContent=total;
  document.getElementById('max-score').textContent=maxScore;
}

function saveEvaluation(){
  const employeeName=document.getElementById('employee-name').value;
  const deptKey=document.getElementById('employee-department').value;
  const date=document.getElementById('evaluation-date').value;
  if (!employeeName||!deptKey||!date){alert('‚ö†Ô∏è ŸÑÿ∑ŸÅÿßŸã ÿ™ŸÖÿßŸÖ ŸÅ€åŸÑÿØŸáÿß€å ÿ∂ÿ±Ÿàÿ±€å ÿ±ÿß Ÿæÿ± ⁄©ŸÜ€åÿØ!');return;}
  if (!currentDepartment){alert('‚ö†Ô∏è ÿßÿ®ÿ™ÿØÿß ÿ®ÿÆÿ¥ ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ!');return;}
  const scores={};
  currentDepartment.criteria.forEach(c=>{
    const sl=document.getElementById(`slider-${c.id}`);
    if (sl) scores[c.id]=parseInt(sl.value);
  });
  const evaluation={
    id:Date.now(),managerName:currentManager,employeeName,department:deptKey,
    departmentName:currentDepartment.name,date,scores,
    totalScore:parseInt(document.getElementById('total-score').textContent),
    maxScore:parseInt(document.getElementById('max-score').textContent),
    timestamp:new Date().toISOString(),
    criteriaSnapshot:JSON.parse(JSON.stringify(currentDepartment.criteria))
  };
  if (isFirebaseConfigured){
    database.ref('evaluations/'+evaluation.id).set(evaluation)
      .then(()=>{alert('‚úÖ ÿßÿ±ÿ≤€åÿßÿ®€å ÿ®ÿß ŸÖŸàŸÅŸÇ€åÿ™ ÿ∞ÿÆ€åÿ±Ÿá ÿ¥ÿØ!');resetForm();})
      .catch(e=>alert('‚ùå ÿÆÿ∑ÿß: '+e.message));
  } else {
    evaluations.push(evaluation);
    localStorage.setItem('sharedEvaluations',JSON.stringify(evaluations));
    alert('‚úÖ ÿßÿ±ÿ≤€åÿßÿ®€å ÿ∞ÿÆ€åÿ±Ÿá ÿ¥ÿØ!');resetForm();onEvaluationsUpdated();
  }
}

function resetForm(){
  document.getElementById('employee-name').value='';
  document.getElementById('employee-department').value='';
  document.getElementById('evaluation-date').valueAsDate=new Date();
  document.getElementById('evaluation-criteria').innerHTML='';
  document.getElementById('department-badge-container').innerHTML='';
  document.getElementById('total-score-container').style.display='none';
  currentDepartment=null;
}

function renderMyHistory(){
  const tbody=document.getElementById('my-history-tbody');
  const myEvals=evaluations.filter(e=>e.managerName===currentManager);
  document.getElementById('my-history-info').innerHTML=
    `üìå ŸÅŸÇÿ∑ ÿßÿ±ÿ≤€åÿßÿ®€å‚ÄåŸáÿß€å ÿ´ÿ®ÿ™‚Äåÿ¥ÿØŸá ÿ™Ÿàÿ≥ÿ∑ <strong>${currentManager}</strong> ‚Äî ÿ™ÿπÿØÿßÿØ: <strong>${myEvals.length}</strong> ŸÖŸàÿ±ÿØ`;
  if (myEvals.length===0){
    tbody.innerHTML=`<tr><td colspan="6" style="text-align:center;padding:40px;"><div class="empty-state-icon">üì≠</div><p>ÿ¥ŸÖÿß ŸáŸÜŸàÿ≤ Ÿá€å⁄Ü ÿßÿ±ÿ≤€åÿßÿ®€å ÿ´ÿ®ÿ™ ŸÜ⁄©ÿ±ÿØŸá‚Äåÿß€åÿØ</p></td></tr>`;
    return;
  }
  const sorted=[...myEvals].sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));
  tbody.innerHTML=sorted.map(ev=>{
    const pct=(ev.totalScore/ev.maxScore*100).toFixed(0);
    const cls=pct>=70?'badge-high':pct>=50?'badge-medium':'badge-low';
    const rank=pct>=70?'ÿπÿßŸÑ€å':pct>=50?'ÿÆŸàÿ®':'ŸÜ€åÿßÿ≤ ÿ®Ÿá ÿ®Ÿáÿ®ŸàÿØ';
    return `<tr>
      <td>${new Date(ev.date).toLocaleDateString('fa-IR')}</td>
      <td><strong>${ev.employeeName}</strong></td>
      <td>${ev.departmentName}</td>
      <td><strong>${ev.totalScore}</strong> / ${ev.maxScore}</td>
      <td><span class="badge ${cls}">${rank} (${pct}%)</span></td>
      <td><button class="btn btn-danger btn-sm" onclick="deleteEvaluation(${ev.id})">üóëÔ∏è ÿ≠ÿ∞ŸÅ</button></td>
    </tr>`;
  }).join('');
}

function deleteEvaluation(evalId){
  const ev=evaluations.find(e=>e.id===evalId);
  if (!ev) return;
  if (ev.managerName!==currentManager){alert('‚õî ÿ¥ŸÖÿß ŸÖÿ¨ÿßÿ≤ ÿ®Ÿá ÿ≠ÿ∞ŸÅ ÿßÿ±ÿ≤€åÿßÿ®€å‚ÄåŸáÿß€å ÿ≥ÿß€åÿ± ŸÖÿØ€åÿ±ÿßŸÜ ŸÜ€åÿ≥ÿ™€åÿØ!');return;}
  if (!confirm('ÿ¢€åÿß ÿßÿ≤ ÿ≠ÿ∞ŸÅ ÿß€åŸÜ ÿßÿ±ÿ≤€åÿßÿ®€å ŸÖÿ∑ŸÖÿ¶ŸÜ Ÿáÿ≥ÿ™€åÿØÿü')) return;
  if (isFirebaseConfigured){
    database.ref('evaluations/'+evalId).remove().then(()=>alert('‚úÖ ÿ≠ÿ∞ŸÅ ÿ¥ÿØ!')).catch(e=>alert('‚ùå ÿÆÿ∑ÿß: '+e.message));
  } else {
    evaluations=evaluations.filter(e=>e.id!==evalId);
    localStorage.setItem('sharedEvaluations',JSON.stringify(evaluations));
    alert('‚úÖ ÿ≠ÿ∞ŸÅ ÿ¥ÿØ!');onEvaluationsUpdated();
  }
}

function exportMyEvaluations(){
  const myEvals=evaluations.filter(e=>e.managerName===currentManager);
  if (myEvals.length===0){alert('‚ö†Ô∏è ÿßÿ±ÿ≤€åÿßÿ®€å‚Äåÿß€å ÿ®ÿ±ÿß€å Ÿæÿ¥ÿ™€åÿ®ÿßŸÜ‚Äå⁄Ø€åÿ±€å Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ±ÿØ!');return;}
  const data=JSON.stringify({manager:currentManager,evaluations:myEvals,exportDate:new Date().toISOString()},null,2);
  const blob=new Blob([data],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download=`backup-${currentManager}-${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
  alert('‚úÖ Ÿæÿ¥ÿ™€åÿ®ÿßŸÜ‚Äå⁄Ø€åÿ±€å ÿßŸÜÿ¨ÿßŸÖ ÿ¥ÿØ!');
}

function renderSharedDashboard(){
  const totalEvals=evaluations.length;
  const uniqueEmployees=new Set(evaluations.map(e=>e.employeeName)).size;
  const uniqueManagers=new Set(evaluations.map(e=>e.managerName)).size;
  const avgScore=totalEvals>0?(evaluations.reduce((s,e)=>s+(e.totalScore/e.maxScore*100),0)/totalEvals).toFixed(1):0;
  document.getElementById('summary-stats').innerHTML=`
    <div class="stat-card-eval blue"><div class="stat-number">${totalEvals}</div><div class="stat-label">⁄©ŸÑ ÿßÿ±ÿ≤€åÿßÿ®€å‚ÄåŸáÿß</div></div>
    <div class="stat-card-eval green"><div class="stat-number">${uniqueEmployees}</div><div class="stat-label">⁄©ÿßÿ±ŸÖŸÜÿØÿßŸÜ ÿßÿ±ÿ≤€åÿßÿ®€å‚Äåÿ¥ÿØŸá</div></div>
    <div class="stat-card-eval orange"><div class="stat-number">${uniqueManagers}</div><div class="stat-label">ŸÖÿØ€åÿ±ÿßŸÜ ÿßÿ±ÿ≤€åÿßÿ®</div></div>
    <div class="stat-card-eval purple"><div class="stat-number">${avgScore}%</div><div class="stat-label">ŸÖ€åÿßŸÜ⁄Ø€åŸÜ ⁄©ŸÑ ÿßŸÖÿ™€åÿßÿ≤ÿßÿ™</div></div>`;
  const empMap={};
  evaluations.forEach(ev=>{
    if (!empMap[ev.employeeName]) empMap[ev.employeeName]={name:ev.employeeName,dept:ev.departmentName,totalScore:0,totalMax:0,count:0};
    empMap[ev.employeeName].totalScore+=ev.totalScore;
    empMap[ev.employeeName].totalMax+=ev.maxScore;
    empMap[ev.employeeName].count+=1;
  });
  const ranked=Object.values(empMap).map(e=>({...e,avgPct:e.totalMax>0?(e.totalScore/e.totalMax*100):0})).sort((a,b)=>b.avgPct-a.avgPct);
  const tbody=document.getElementById('global-ranking-tbody');
  if (ranked.length===0){
    tbody.innerHTML=`<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-light);">ŸáŸÜŸàÿ≤ ÿßÿ±ÿ≤€åÿßÿ®€å ÿ´ÿ®ÿ™ ŸÜÿ¥ÿØŸá ÿßÿ≥ÿ™</td></tr>`;
  } else {
    tbody.innerHTML=ranked.map((emp,i)=>{
      const rank=i+1;const pct=emp.avgPct.toFixed(1);
      const color=emp.avgPct>=70?'#059669':emp.avgPct>=50?'#d97706':'#dc2626';
      const medal=rank===1?'ü•á':rank===2?'ü•à':rank===3?'ü•â':rank;
      return `<tr class="${rank<=3?'rank-'+rank:''}">
        <td style="font-size:20px;text-align:center;">${medal}</td>
        <td><strong>${emp.name}</strong></td><td>${emp.dept}</td>
        <td style="text-align:center;">${emp.count}</td>
        <td style="text-align:center;font-weight:700;">${emp.totalScore.toLocaleString()}</td>
        <td style="text-align:center;font-weight:800;color:${color};">${pct}%</td>
        <td><div class="progress-bar-wrap"><div class="progress-bar-fill" style="width:${pct}%;background:${color};"></div></div></td>
      </tr>`;
    }).join('');
  }
  const ctx1=document.getElementById('sharedEmployeesChart');
  if (window._empChart) window._empChart.destroy();
  const top10=ranked.slice(0,10);
  window._empChart=new Chart(ctx1,{type:'bar',data:{labels:top10.map(e=>e.name),datasets:[{label:'ŸÖ€åÿßŸÜ⁄Ø€åŸÜ ÿßŸÖÿ™€åÿßÿ≤ (%)',data:top10.map(e=>e.avgPct.toFixed(1)),backgroundColor:top10.map((_,i)=>i===0?'rgba(251,191,36,.85)':i===1?'rgba(156,163,175,.85)':i===2?'rgba(249,115,22,.85)':'rgba(30,64,175,.75)'),borderRadius:6}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{min:0,max:100}}}});
  const deptMap={};
  evaluations.forEach(ev=>{deptMap[ev.departmentName]=(deptMap[ev.departmentName]||0)+1;});
  const ctx2=document.getElementById('sharedDepartmentsChart');
  if (window._deptChart) window._deptChart.destroy();
  window._deptChart=new Chart(ctx2,{type:'pie',data:{labels:Object.keys(deptMap),datasets:[{data:Object.values(deptMap),backgroundColor:['rgba(5,150,105,.8)','rgba(8,145,178,.8)','rgba(124,58,237,.8)','rgba(217,119,6,.8)','rgba(220,38,38,.8)','rgba(30,64,175,.8)']}]},options:{responsive:true}});
}

function updateStarEmployees(){
  const container=document.getElementById('star-employees-grid');
  const selMonth=document.getElementById('star-month-selector').value;
  const topCount=parseInt(document.getElementById('star-count-selector').value);
  if (!selMonth){container.innerHTML='<p style="text-align:center;color:var(--text-light);">ŸÑÿ∑ŸÅÿßŸã ŸÖÿßŸá ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ.</p>';return;}
  const [year,month]=selMonth.split('-');
  const monthEvals=evaluations.filter(ev=>{const d=new Date(ev.date);return d.getFullYear()==year&&(d.getMonth()+1)==parseInt(month);});
  if (monthEvals.length===0){
    container.innerHTML=`<div class="empty-state" style="grid-column:1/-1;"><div class="empty-state-icon">üì≠</div><h3>Ÿá€å⁄Ü ÿßÿ±ÿ≤€åÿßÿ®€å ÿØÿ± ÿß€åŸÜ ŸÖÿßŸá ÿ´ÿ®ÿ™ ŸÜÿ¥ÿØŸá ÿßÿ≥ÿ™</h3></div>`;
    return;
  }
  const empMap={};
  monthEvals.forEach(ev=>{
    if (!empMap[ev.employeeName]) empMap[ev.employeeName]={name:ev.employeeName,dept:ev.departmentName,sum:0,count:0};
    empMap[ev.employeeName].sum+=(ev.totalScore/ev.maxScore*100);
    empMap[ev.employeeName].count+=1;
  });
  const ranked=Object.values(empMap).map(e=>({...e,avg:e.sum/e.count})).sort((a,b)=>b.avg-a.avg).slice(0,topCount);
  container.innerHTML=ranked.map((emp,i)=>{
    const rank=i+1;
    const empData=employees.find(e=>e.name===emp.name);
    const photo=empData&&empData.photo?empData.photo:null;
    return `<div class="star-employee-card rank-${rank<=3?rank:''}">
      <div class="star-rank-badge rank-${rank<=3?rank:''}">${rank}</div>
      <div class="star-employee-photo">${photo?`<img src="${photo}" alt="${emp.name}" onerror="this.parentElement.innerHTML='üë§'">`:' üë§'}</div>
      <div class="star-employee-name">${emp.name}</div>
      <div class="star-employee-dept">${emp.dept}</div>
      <div class="star-employee-score"><span class="star-score-value">${emp.avg.toFixed(1)}%</span><span class="star-score-label">ŸÖ€åÿßŸÜ⁄Ø€åŸÜ ÿßŸÖÿ™€åÿßÿ≤ (${emp.count} ÿßÿ±ÿ≤€åÿßÿ®€å)</span></div>
    </div>`;
  }).join('');
}

function switchTab(tab,el){
  document.querySelectorAll('#eval-module .section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById(`${tab}-section`).classList.add('active');
  if (el) el.classList.add('active');
  if (tab==='my-history') renderMyHistory();
  if (tab==='shared-dashboard') renderSharedDashboard();
  if (tab==='star-employees') updateStarEmployees();
  if (tab==='manage-employees') updateEmployeesManagementList();
  if (tab==='departments') updateDepartmentsView();
}

function addNewEmployee(){
  const name=document.getElementById('new-emp-name').value.trim();
  const dept=document.getElementById('new-emp-department').value;
  const pos=document.getElementById('new-emp-position').value.trim();
  const code=document.getElementById('new-emp-code').value.trim();
  const photo=document.getElementById('new-emp-photo').value.trim();
  if (!name||!dept){alert('‚ö†Ô∏è ŸÜÿßŸÖ Ÿà ÿ®ÿÆÿ¥ ÿßŸÑÿ≤ÿßŸÖ€å ÿßÿ≥ÿ™!');return;}
  if (employees.some(e=>e.name.toLowerCase()===name.toLowerCase())){alert('‚ö†Ô∏è ⁄©ÿßÿ±ŸÖŸÜÿØ€å ÿ®ÿß ÿß€åŸÜ ŸÜÿßŸÖ ŸÇÿ®ŸÑÿßŸã Ÿàÿ¨ŸàÿØ ÿØÿßÿ±ÿØ!');return;}
  const emp={id:Date.now(),name,department:dept,departmentName:departments[dept].name,position:pos,code,photo,createdAt:new Date().toISOString()};
  if (isFirebaseConfigured){
    database.ref('employees/'+emp.id).set(emp).then(()=>{alert('‚úÖ ⁄©ÿßÿ±ŸÖŸÜÿØ ÿßÿ∂ÿßŸÅŸá ÿ¥ÿØ!');clearEmployeeForm();}).catch(e=>alert('‚ùå ÿÆÿ∑ÿß: '+e.message));
  } else {
    employees.push(emp);localStorage.setItem('employees',JSON.stringify(employees));alert('‚úÖ ⁄©ÿßÿ±ŸÖŸÜÿØ ÿßÿ∂ÿßŸÅŸá ÿ¥ÿØ!');clearEmployeeForm();updateEmployeesManagementList();
  }
}

function clearEmployeeForm(){
  ['new-emp-name','new-emp-position','new-emp-code','new-emp-photo'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('new-emp-department').value='';
}

function updateEmployeesManagementList(){
  const container=document.getElementById('employees-management-list');
  if (!container) return;
  if (employees.length===0){
    container.innerHTML=`<div class="empty-state"><div class="empty-state-icon">üë§</div><h3>ŸáŸÜŸàÿ≤ ⁄©ÿßÿ±ŸÖŸÜÿØ€å ÿßÿ∂ÿßŸÅŸá ŸÜÿ¥ÿØŸá</h3></div>`;return;
  }
  const sorted=[...employees].sort((a,b)=>a.name.localeCompare(b.name,'fa'));
  container.innerHTML=sorted.map(emp=>{
    const dept=departments[emp.department];
    return `<div class="employee-mgmt-card">
      <div>
        <div style="font-weight:700;font-size:15px;margin-bottom:4px;">${emp.name}</div>
        <div style="font-size:13px;color:var(--text-light);">${dept?dept.icon+' '+dept.name:emp.departmentName}${emp.position?' ‚Ä¢ '+emp.position:''}${emp.code?' ‚Ä¢ ⁄©ÿØ: '+emp.code:''}</div>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-primary btn-sm" onclick="editEmployee(${emp.id})">‚úèÔ∏è Ÿà€åÿ±ÿß€åÿ¥</button>
        <button class="btn btn-danger btn-sm" onclick="deleteEmployee(${emp.id})">üóëÔ∏è ÿ≠ÿ∞ŸÅ</button>
      </div>
    </div>`;
  }).join('');
}

function editEmployee(empId){
  const emp=employees.find(e=>e.id===empId);if (!emp) return;
  currentEditingEmployee=empId;
  document.getElementById('edit-emp-name').value=emp.name;
  document.getElementById('edit-emp-position').value=emp.position||'';
  document.getElementById('edit-emp-code').value=emp.code||'';
  document.getElementById('edit-emp-photo').value=emp.photo||'';
  populateNewEmployeeDepartment();
  document.getElementById('edit-emp-department').value=emp.department;
  document.getElementById('edit-employee-modal').classList.add('active');
}

function closeEditEmployeeModal(){document.getElementById('edit-employee-modal').classList.remove('active');currentEditingEmployee=null;}

function saveEditedEmployee(){
  if (!currentEditingEmployee) return;
  const emp=employees.find(e=>e.id===currentEditingEmployee);if (!emp) return;
  const newName=document.getElementById('edit-emp-name').value.trim();
  const newDept=document.getElementById('edit-emp-department').value;
  if (!newName||!newDept){alert('‚ö†Ô∏è ŸÜÿßŸÖ Ÿà ÿ®ÿÆÿ¥ ÿßŸÑÿ≤ÿßŸÖ€å ÿßÿ≥ÿ™!');return;}
  if (newName!==emp.name&&employees.some(e=>e.id!==currentEditingEmployee&&e.name.toLowerCase()===newName.toLowerCase())){alert('‚ö†Ô∏è ÿß€åŸÜ ŸÜÿßŸÖ ŸÇÿ®ŸÑÿßŸã Ÿàÿ¨ŸàÿØ ÿØÿßÿ±ÿØ!');return;}
  emp.name=newName;emp.department=newDept;emp.departmentName=departments[newDept].name;
  emp.position=document.getElementById('edit-emp-position').value.trim();
  emp.code=document.getElementById('edit-emp-code').value.trim();
  emp.photo=document.getElementById('edit-emp-photo').value.trim();
  if (isFirebaseConfigured){
    database.ref('employees/'+currentEditingEmployee).set(emp).then(()=>{alert('‚úÖ Ÿà€åÿ±ÿß€åÿ¥ ÿ¥ÿØ!');closeEditEmployeeModal();}).catch(e=>alert('‚ùå ÿÆÿ∑ÿß: '+e.message));
  } else {
    localStorage.setItem('employees',JSON.stringify(employees));alert('‚úÖ Ÿà€åÿ±ÿß€åÿ¥ ÿ¥ÿØ!');closeEditEmployeeModal();updateEmployeesManagementList();
  }
}

function deleteEmployee(empId){
  const emp=employees.find(e=>e.id===empId);if (!emp) return;
  if (!confirm(`ÿ¢€åÿß ÿßÿ≤ ÿ≠ÿ∞ŸÅ "${emp.name}" ŸÖÿ∑ŸÖÿ¶ŸÜ Ÿáÿ≥ÿ™€åÿØÿü`)) return;
  if (isFirebaseConfigured){
    database.ref('employees/'+empId).remove().then(()=>alert('‚úÖ ÿ≠ÿ∞ŸÅ ÿ¥ÿØ!')).catch(e=>alert('‚ùå ÿÆÿ∑ÿß: '+e.message));
  } else {
    employees=employees.filter(e=>e.id!==empId);localStorage.setItem('employees',JSON.stringify(employees));alert('‚úÖ ÿ≠ÿ∞ŸÅ ÿ¥ÿØ!');updateEmployeesManagementList();
  }
}

function updateDepartmentsView(){
  const container=document.getElementById('departments-grid');if (!container) return;
  container.innerHTML='';
  Object.keys(departments).forEach(k=>{
    const d=departments[k];
    container.insertAdjacentHTML('beforeend',`
      <div class="department-card" onclick="openCriteriaModal('${k}')">
        <div class="department-header">
          <div class="department-badge ${d.class}">${d.icon} ${d.name}</div>
          <div class="criteria-count">${d.criteria.length} ŸÖÿπ€åÿßÿ±</div>
        </div>
        <p style="color:var(--text-light);margin-top:10px;font-size:13px;">⁄©ŸÑ€å⁄© ÿ®ÿ±ÿß€å Ÿà€åÿ±ÿß€åÿ¥ ŸÖÿπ€åÿßÿ±Ÿáÿß</p>
      </div>`);
  });
}

function openCriteriaModal(deptKey){
  currentEditingDepartment=deptKey;const d=departments[deptKey];
  document.getElementById('modal-department-name-input').value=d.name;
  document.getElementById('modal-department-icon-input').value=d.icon;
  document.getElementById('modal-department-badge').innerHTML=`<div class="department-badge ${d.class}" style="margin-bottom:18px;">${d.icon} ${d.name}</div>`;
  const list=document.getElementById('modal-criteria-list');list.innerHTML='';
  d.criteria.forEach(c=>{
    list.insertAdjacentHTML('beforeend',`
      <div class="criteria-item">
        <input type="text" class="criteria-name-input" value="${c.name}" id="modal-criteria-name-${c.id}">
        <input type="number" class="criteria-weight-input" value="${c.weight}" id="modal-criteria-weight-${c.id}" min="1" max="30">
        <button class="btn btn-danger btn-sm" onclick="deleteModalCriteria(${c.id})">üóëÔ∏è ÿ≠ÿ∞ŸÅ</button>
      </div>`);
  });
  document.getElementById('criteria-modal').classList.add('active');
}

function closeCriteriaModal(){document.getElementById('criteria-modal').classList.remove('active');currentEditingDepartment=null;}

function saveDepartmentCriteria(){
  const oldKey=currentEditingDepartment;const d=departments[oldKey];
  const newName=document.getElementById('modal-department-name-input').value.trim();
  const newIcon=document.getElementById('modal-department-icon-input').value.trim();
  if (!newName||!newIcon){alert('‚ö†Ô∏è ŸÜÿßŸÖ Ÿà ÿ¢€å⁄©ŸàŸÜ ÿßŸÑÿ≤ÿßŸÖ€å!');return;}
  const criteria=[];
  d.criteria.forEach(c=>{
    const nm=document.getElementById(`modal-criteria-name-${c.id}`);
    const wt=document.getElementById(`modal-criteria-weight-${c.id}`);
    if (nm&&wt) criteria.push({id:c.id,name:nm.value,weight:parseInt(wt.value)});
  });
  if (newName!==oldKey){departments[newName]={name:newName,icon:newIcon,class:d.class,criteria};delete departments[oldKey];}
  else departments[oldKey]={...d,name:newName,icon:newIcon,criteria};
  const save=()=>{
    if (isFirebaseConfigured){
      database.ref('departments').set(departments).then(()=>{alert('‚úÖ ÿ∞ÿÆ€åÿ±Ÿá ÿ¥ÿØ!');closeCriteriaModal();updateDepartmentsView();populateDepartmentDropdown();populateNewEmployeeDepartment();}).catch(e=>alert('‚ùå ÿÆÿ∑ÿß: '+e.message));
    } else {
      localStorage.setItem('departments',JSON.stringify(departments));alert('‚úÖ ÿ∞ÿÆ€åÿ±Ÿá ÿ¥ÿØ!');closeCriteriaModal();updateDepartmentsView();populateDepartmentDropdown();populateNewEmployeeDepartment();
    }
  };save();
}

function addNewCriteriaToModal(){
  const d=departments[currentEditingDepartment];
  const newId=Math.max(...d.criteria.map(c=>c.id),0)+1;
  d.criteria.push({id:newId,name:'ŸÖÿπ€åÿßÿ± ÿ¨ÿØ€åÿØ',weight:10});
  openCriteriaModal(currentEditingDepartment);
}

function deleteModalCriteria(id){
  if (!confirm('ÿ≠ÿ∞ŸÅ ÿß€åŸÜ ŸÖÿπ€åÿßÿ±ÿü')) return;
  departments[currentEditingDepartment].criteria=departments[currentEditingDepartment].criteria.filter(c=>c.id!==id);
  openCriteriaModal(currentEditingDepartment);
}

function deleteDepartment(){
  const name=departments[currentEditingDepartment].name;
  if (!confirm(`ÿ≠ÿ∞ŸÅ ÿ®ÿÆÿ¥ "${name}"ÿü`)) return;
  delete departments[currentEditingDepartment];
  if (isFirebaseConfigured){
    database.ref('departments').set(departments).then(()=>{alert('‚úÖ ÿ®ÿÆÿ¥ ÿ≠ÿ∞ŸÅ ÿ¥ÿØ!');closeCriteriaModal();populateDepartmentDropdown();populateNewEmployeeDepartment();updateDepartmentsView();}).catch(e=>alert('‚ùå ÿÆÿ∑ÿß: '+e.message));
  } else {
    localStorage.setItem('departments',JSON.stringify(departments));alert('‚úÖ ÿ®ÿÆÿ¥ ÿ≠ÿ∞ŸÅ ÿ¥ÿØ!');closeCriteriaModal();populateDepartmentDropdown();populateNewEmployeeDepartment();updateDepartmentsView();
  }
}

function showAddDepartmentModal(){document.getElementById('add-department-modal').classList.add('active');}
function closeAddDepartmentModal(){document.getElementById('add-department-modal').classList.remove('active');document.getElementById('new-department-name').value='';document.getElementById('new-department-icon').value='';}

function createNewDepartment(){
  const name=document.getElementById('new-department-name').value.trim();
  const icon=document.getElementById('new-department-icon').value.trim();
  if (!name||!icon){alert('‚ö†Ô∏è ŸÜÿßŸÖ Ÿà ÿ¢€å⁄©ŸàŸÜ ÿßŸÑÿ≤ÿßŸÖ€å!');return;}
  departments[name]={name,icon,class:'dept-sales',criteria:[{id:1,name:'⁄©€åŸÅ€åÿ™ ⁄©ÿßÿ±',weight:15},{id:2,name:'ÿ≠ÿ∂Ÿàÿ± Ÿà ÿ∫€åÿßÿ®',weight:10},{id:3,name:'⁄©ÿßÿ± ÿ™€åŸÖ€å',weight:10}]};
  if (isFirebaseConfigured){
    database.ref('departments').set(departments).then(()=>{alert('‚úÖ ÿ®ÿÆÿ¥ ÿß€åÿ¨ÿßÿØ ÿ¥ÿØ!');closeAddDepartmentModal();populateDepartmentDropdown();populateNewEmployeeDepartment();updateDepartmentsView();}).catch(e=>alert('‚ùå ÿÆÿ∑ÿß: '+e.message));
  } else {
    localStorage.setItem('departments',JSON.stringify(departments));alert('‚úÖ ÿ®ÿÆÿ¥ ÿß€åÿ¨ÿßÿØ ÿ¥ÿØ!');closeAddDepartmentModal();populateDepartmentDropdown();populateNewEmployeeDepartment();updateDepartmentsView();
  }
}

function resetToDefaultDepartments(){
  if (!confirm('ÿ®ÿßÿ≤⁄Øÿ¥ÿ™ ÿ®Ÿá Ÿæ€åÿ¥‚ÄåŸÅÿ±ÿ∂ÿü')) return;
  departments=JSON.parse(JSON.stringify(defaultDepartments));
  if (isFirebaseConfigured){
    database.ref('departments').set(departments).then(()=>{alert('‚úÖ ÿ®ÿßÿ≤⁄Øÿ¥ÿ™ ÿ®Ÿá Ÿæ€åÿ¥‚ÄåŸÅÿ±ÿ∂!');populateDepartmentDropdown();populateNewEmployeeDepartment();updateDepartmentsView();});
  } else {
    localStorage.setItem('departments',JSON.stringify(departments));alert('‚úÖ ÿ®ÿßÿ≤⁄Øÿ¥ÿ™ ÿ®Ÿá Ÿæ€åÿ¥‚ÄåŸÅÿ±ÿ∂!');populateDepartmentDropdown();populateNewEmployeeDepartment();updateDepartmentsView();
  }
}

['criteria-modal','add-department-modal','edit-employee-modal'].forEach(id=>{
  const el=document.getElementById(id);
  if (el) el.addEventListener('click',function(e){if(e.target===this)this.classList.remove('active');});
});


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// JSON IMPORT / EXPORT FUNCTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
function jsonDownload(data, filename) {
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(a.href);
}

function readJSONFile(event, callback) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      callback(data);
    } catch(err) {
      alert('‚ùå ŸÅÿß€åŸÑ JSON ŸÜÿßŸÖÿπÿ™ÿ®ÿ± ÿßÿ≥ÿ™! ' + err.message);
    }
    event.target.value = ''; // reset so same file can be re-imported
  };
  reader.readAsText(file, 'utf-8');
}

function showImportToast(msg) {
  const t = document.getElementById('s-toast');
  if (t) { t.innerHTML = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3500); }
  else alert(msg);
}

// ‚îÄ‚îÄ EVALUATIONS: export all as JSON ‚îÄ‚îÄ
function exportAllEvaluationsJSON() {
  if (evaluations.length === 0) { showImportToast('‚ö†Ô∏è ÿßÿ±ÿ≤€åÿßÿ®€å‚Äåÿß€å Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ±ÿØ!'); return; }
  jsonDownload({
    type: 'all-evaluations',
    exportDate: new Date().toISOString(),
    count: evaluations.length,
    evaluations: evaluations
  }, `ŸáŸÖŸá-ÿßÿ±ÿ≤€åÿßÿ®€å‚ÄåŸáÿß-${new Date().toISOString().split('T')[0]}.json`);
}

// ‚îÄ‚îÄ EVALUATIONS: import (my evaluations) ‚îÄ‚îÄ
function importMyEvaluations(event) {
  readJSONFile(event, data => {
    let imported = [];
    // Support: {evaluations:[...]}, {manager:...,evaluations:[...]}, or plain array
    if (Array.isArray(data)) imported = data;
    else if (Array.isArray(data.evaluations)) imported = data.evaluations;
    else { alert('‚ùå ŸÅÿ±ŸÖÿ™ ŸÅÿß€åŸÑ Ÿæÿ¥ÿ™€åÿ®ÿßŸÜ€å ŸÜŸÖ€å‚Äåÿ¥ŸàÿØ'); return; }

    if (!confirm(`ÿ¢€åÿß ŸÖ€å‚ÄåÿÆŸàÿßŸá€åÿØ ${imported.length} ÿßÿ±ÿ≤€åÿßÿ®€å ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿ¥ŸàÿØÿü ŸÖŸàÿßÿ±ÿØ ÿ™⁄©ÿ±ÿßÿ±€å ÿ¨ÿß€å⁄Øÿ≤€åŸÜ ŸÖ€å‚Äåÿ¥ŸàŸÜÿØ.`)) return;

    // Merge: override by id
    const existingIds = new Set(evaluations.map(e => e.id));
    let added = 0, updated = 0;
    imported.forEach(ev => {
      if (existingIds.has(ev.id)) {
        const idx = evaluations.findIndex(e => e.id === ev.id);
        evaluations[idx] = ev; updated++;
      } else {
        evaluations.push(ev); added++;
      }
    });

    // Write to Firebase
    if (isFirebaseConfigured) {
      const obj = {};
      evaluations.forEach(ev => { obj[ev.id] = ev; });
      database.ref('evaluations').set(obj)
        .then(() => showImportToast(`‚úÖ ${added} ÿßÿ∂ÿßŸÅŸáÿå ${updated} ÿ®ÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å ÿ¥ÿØ`))
        .catch(e => alert('‚ùå ÿÆÿ∑ÿß: ' + e.message));
    } else {
      localStorage.setItem('sharedEvaluations', JSON.stringify(evaluations));
      showImportToast(`‚úÖ ${added} ÿßÿ∂ÿßŸÅŸáÿå ${updated} ÿ®ÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å ÿ¥ÿØ`);
    }
    onEvaluationsUpdated();
  });
}

// ‚îÄ‚îÄ EVALUATIONS: import all ‚îÄ‚îÄ
function importAllEvaluations(event) {
  importMyEvaluations(event); // same logic
}

// ‚îÄ‚îÄ EMPLOYEES: export ‚îÄ‚îÄ
function exportEmployeesJSON() {
  jsonDownload({
    type: 'employees',
    exportDate: new Date().toISOString(),
    count: employees.length,
    employees: employees
  }, `⁄©ÿßÿ±ŸÖŸÜÿØÿßŸÜ-${new Date().toISOString().split('T')[0]}.json`);
}

// ‚îÄ‚îÄ EMPLOYEES: import ‚îÄ‚îÄ
function importEmployeesJSON(event) {
  readJSONFile(event, data => {
    let imported = [];
    if (Array.isArray(data)) imported = data;
    else if (Array.isArray(data.employees)) imported = data.employees;
    else { alert('‚ùå ŸÅÿ±ŸÖÿ™ ŸÅÿß€åŸÑ Ÿæÿ¥ÿ™€åÿ®ÿßŸÜ€å ŸÜŸÖ€å‚Äåÿ¥ŸàÿØ'); return; }

    if (!confirm(`ÿ¢€åÿß ŸÖ€å‚ÄåÿÆŸàÿßŸá€åÿØ ${imported.length} ⁄©ÿßÿ±ŸÖŸÜÿØ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿ¥ŸàÿØÿü`)) return;

    const existingIds = new Set(employees.map(e => e.id));
    let added = 0, updated = 0;
    imported.forEach(emp => {
      if (existingIds.has(emp.id)) {
        const idx = employees.findIndex(e => e.id === emp.id);
        employees[idx] = emp; updated++;
      } else {
        employees.push(emp); added++;
      }
    });

    if (isFirebaseConfigured) {
      const obj = {};
      employees.forEach(emp => { obj[emp.id] = emp; });
      database.ref('employees').set(obj)
        .then(() => showImportToast(`‚úÖ ${added} ÿßÿ∂ÿßŸÅŸáÿå ${updated} ÿ®ÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å ÿ¥ÿØ`))
        .catch(e => alert('‚ùå ÿÆÿ∑ÿß: ' + e.message));
    } else {
      localStorage.setItem('employees', JSON.stringify(employees));
      showImportToast(`‚úÖ ${added} ÿßÿ∂ÿßŸÅŸáÿå ${updated} ÿ®ÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å ÿ¥ÿØ`);
    }
    updateEmployeesManagementList();
  });
}

// ‚îÄ‚îÄ DEPARTMENTS: export ‚îÄ‚îÄ
function exportDepartmentsJSON() {
  jsonDownload({
    type: 'departments',
    exportDate: new Date().toISOString(),
    departments: departments
  }, `ÿ®ÿÆÿ¥‚ÄåŸáÿß-${new Date().toISOString().split('T')[0]}.json`);
}

// ‚îÄ‚îÄ DEPARTMENTS: import ‚îÄ‚îÄ
function importDepartmentsJSON(event) {
  readJSONFile(event, data => {
    let imported = null;
    if (data && typeof data === 'object' && !Array.isArray(data)) {
      // could be {departments: {...}} or directly the departments object
      if (data.departments && typeof data.departments === 'object') imported = data.departments;
      else if (data.type === 'departments') imported = data.departments;
      else imported = data;
    }
    if (!imported) { alert('‚ùå ŸÅÿ±ŸÖÿ™ ŸÅÿß€åŸÑ Ÿæÿ¥ÿ™€åÿ®ÿßŸÜ€å ŸÜŸÖ€å‚Äåÿ¥ŸàÿØ'); return; }

    const count = Object.keys(imported).length;
    if (!confirm(`ÿ¢€åÿß ŸÖ€å‚ÄåÿÆŸàÿßŸá€åÿØ ${count} ÿ®ÿÆÿ¥ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿ¥ŸàÿØÿü ÿ®ÿÆÿ¥‚ÄåŸáÿß€å ŸÖŸàÿ¨ŸàÿØ ÿ®ÿß ŸáŸÖ€åŸÜ ŸÜÿßŸÖ ÿ¨ÿß€å⁄Øÿ≤€åŸÜ ŸÖ€å‚Äåÿ¥ŸàŸÜÿØ.`)) return;

    // Merge departments
    Object.assign(departments, imported);

    if (isFirebaseConfigured) {
      database.ref('departments').set(departments)
        .then(() => {
          showImportToast(`‚úÖ ${count} ÿ®ÿÆÿ¥ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿ¥ÿØ`);
          populateDepartmentDropdown(); populateNewEmployeeDepartment(); updateDepartmentsView();
        })
        .catch(e => alert('‚ùå ÿÆÿ∑ÿß: ' + e.message));
    } else {
      localStorage.setItem('departments', JSON.stringify(departments));
      showImportToast(`‚úÖ ${count} ÿ®ÿÆÿ¥ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿ¥ÿØ`);
      populateDepartmentDropdown(); populateNewEmployeeDepartment(); updateDepartmentsView();
    }
  });
}

// ‚îÄ‚îÄ FULL BACKUP: export everything ‚îÄ‚îÄ
function exportFullBackup() {
  // Get supply data from localStorage (always synced there)
  let _sp=[], _sf=[], _spr=[];
  try { _sp=JSON.parse(localStorage.getItem('supply_products')||'[]'); } catch(e){}
  try { _sf=JSON.parse(localStorage.getItem('supply_factories')||'[]'); } catch(e){}
  try { _spr=JSON.parse(localStorage.getItem('supply_prices')||'[]'); } catch(e){}
  const backup = {
    type: 'full-backup',
    version: '2.0',
    exportDate: new Date().toISOString(),
    eval: {
      departments: departments,
      employees: employees,
      evaluations: evaluations
    },
    supply: {
      products: _sp,
      factories: _sf,
      prices: _spr
    }
  };
  jsonDownload(backup, `ŸÅŸàŸÑÿßÿØ-ŸæŸÑÿ™ŸÅÿ±ŸÖ-ÿ®⁄©ÿßŸæ-⁄©ÿßŸÖŸÑ-${new Date().toISOString().split('T')[0]}.json`);
  showImportToast('‚úÖ ÿ®⁄©ÿßŸæ ⁄©ÿßŸÖŸÑ ÿØÿßŸÜŸÑŸàÿØ ÿ¥ÿØ');
}

// ‚îÄ‚îÄ FULL BACKUP: import everything ‚îÄ‚îÄ
function importFullBackup(event) {
  readJSONFile(event, async data => {
    if (data.type !== 'full-backup') {
      alert('‚ùå ÿß€åŸÜ ŸÅÿß€åŸÑ €å⁄© ÿ®⁄©ÿßŸæ ⁄©ÿßŸÖŸÑ ŸÜ€åÿ≥ÿ™. ÿ®ÿ±ÿß€å ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿ®ÿÆÿ¥ ÿÆÿßÿµ ÿßÿ≤ ÿØ⁄©ŸÖŸá‚ÄåŸáÿß€å ÿØÿßÿÆŸÑ Ÿáÿ± ÿµŸÅÿ≠Ÿá ÿßÿ≥ÿ™ŸÅÿßÿØŸá ⁄©ŸÜ€åÿØ.');
      return;
    }
    if (!confirm('‚ö†Ô∏è ÿ®ÿßÿ≤€åÿßÿ®€å ÿ®⁄©ÿßŸæ ⁄©ÿßŸÖŸÑ! ÿ™ŸÖÿßŸÖ ÿØÿßÿØŸá‚ÄåŸáÿß€å ŸÅÿπŸÑ€å ÿ¨ÿß€å⁄Øÿ≤€åŸÜ ŸÖ€å‚Äåÿ¥ŸàŸÜÿØ. ÿßÿØÿßŸÖŸá ŸÖ€å‚ÄåÿØŸá€åÿØÿü')) return;

    const writes = [];
    try {
      // Eval data
      if (data.eval) {
        if (data.eval.departments) {
          departments = data.eval.departments;
          writes.push(isFirebaseConfigured ? database.ref('departments').set(departments) : Promise.resolve());
          if (!isFirebaseConfigured) localStorage.setItem('departments', JSON.stringify(departments));
        }
        if (data.eval.employees) {
          employees = Array.isArray(data.eval.employees) ? data.eval.employees : Object.values(data.eval.employees);
          const empObj = {};
          employees.forEach(e => { empObj[e.id] = e; });
          writes.push(isFirebaseConfigured ? database.ref('employees').set(empObj) : Promise.resolve());
          if (!isFirebaseConfigured) localStorage.setItem('employees', JSON.stringify(employees));
        }
        if (data.eval.evaluations) {
          evaluations = Array.isArray(data.eval.evaluations) ? data.eval.evaluations : Object.values(data.eval.evaluations);
          const evalObj = {};
          evaluations.forEach(ev => { evalObj[ev.id] = ev; });
          writes.push(isFirebaseConfigured ? database.ref('evaluations').set(evalObj) : Promise.resolve());
          if (!isFirebaseConfigured) localStorage.setItem('sharedEvaluations', JSON.stringify(evaluations));
        }
      }
      // Supply data - stored in pendingSupplyRestore, applied when supply module inits
      if (data.supply) {
        window._pendingSupplyRestore = data.supply;
      }

      await Promise.all(writes);
      // Refresh UI
      populateDepartmentDropdown(); populateNewEmployeeDepartment(); updateDepartmentsView();
      updateEmployeesManagementList(); onEvaluationsUpdated();
      if (window.sRefreshAll) window.sRefreshAll();

      showImportToast('‚úÖ ÿ®⁄©ÿßŸæ ⁄©ÿßŸÖŸÑ ÿ®ÿß ŸÖŸàŸÅŸÇ€åÿ™ ÿ®ÿßÿ≤€åÿßÿ®€å ÿ¥ÿØ');
    } catch(e) {
      alert('‚ùå ÿÆÿ∑ÿß ÿØÿ± ÿ®ÿßÿ≤€åÿßÿ®€å: ' + e.message);
    }
  });
}

// EXCEL EXPORT FUNCTIONS
function persianDate(isoStr) {
  try { return new Date(isoStr).toLocaleDateString('fa-IR'); } catch { return isoStr||''; }
}
function scoreBadge(pct) {
  if (pct >= 70) return 'ÿπÿßŸÑ€å';
  if (pct >= 50) return 'ÿÆŸàÿ®';
  return 'ŸÜ€åÿßÿ≤ ÿ®Ÿá ÿ®Ÿáÿ®ŸàÿØ';
}
function styleHeader(ws, range, bgColor) {
  if (!ws['!ref']) return;
  const R = XLSX.utils.decode_range(range);
  for (let C = R.s.c; C <= R.e.c; C++) {
    const cellAddr = XLSX.utils.encode_cell({r: R.s.r, c: C});
    if (!ws[cellAddr]) continue;
    ws[cellAddr].s = {
      font: { bold: true, color: { rgb: 'FFFFFF' }, name: 'Arial', sz: 11 },
      fill: { fgColor: { rgb: bgColor }, patternType: 'solid' },
      alignment: { horizontal: 'center', vertical: 'center', wrapText: true },
      border: { top:{style:'thin',color:{rgb:'CCCCCC'}}, bottom:{style:'thin',color:{rgb:'CCCCCC'}}, left:{style:'thin',color:{rgb:'CCCCCC'}}, right:{style:'thin',color:{rgb:'CCCCCC'}} }
    };
  }
}
function styleDataRows(ws, startRow, endRow, colCount, altColor) {
  for (let R = startRow; R <= endRow; R++) {
    const isAlt = (R - startRow) % 2 === 1;
    for (let C = 0; C < colCount; C++) {
      const cellAddr = XLSX.utils.encode_cell({r: R, c: C});
      if (!ws[cellAddr]) ws[cellAddr] = { t: 's', v: '' };
      ws[cellAddr].s = {
        font: { name: 'Arial', sz: 10 },
        fill: isAlt ? { fgColor: { rgb: altColor }, patternType: 'solid' } : { patternType: 'none' },
        alignment: { horizontal: 'center', vertical: 'center' },
        border: { bottom:{style:'thin',color:{rgb:'E0E0E0'}}, left:{style:'thin',color:{rgb:'E0E0E0'}}, right:{style:'thin',color:{rgb:'E0E0E0'}} }
      };
    }
  }
}

function exportMyEvaluationsExcel() {
  const myEvals = evaluations.filter(e => e.managerName === currentManager);
  if (myEvals.length === 0) { alert('‚ö†Ô∏è ÿßÿ±ÿ≤€åÿßÿ®€å‚Äåÿß€å ÿ®ÿ±ÿß€å ÿÆÿ±Ÿàÿ¨€å Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ±ÿØ!'); return; }
  const wb = XLSX.utils.book_new();
  const sorted = [...myEvals].sort((a,b) => new Date(b.timestamp)-new Date(a.timestamp));
  const headers1 = ['ÿ±ÿØ€åŸÅ','ÿ™ÿßÿ±€åÿÆ ÿßÿ±ÿ≤€åÿßÿ®€å','ŸÜÿßŸÖ ⁄©ÿßÿ±ŸÖŸÜÿØ','ÿ®ÿÆÿ¥','ÿßŸÖÿ™€åÿßÿ≤ ⁄©ÿ≥ÿ® ÿ¥ÿØŸá','ÿ≠ÿØÿß⁄©ÿ´ÿ± ÿßŸÖÿ™€åÿßÿ≤','ÿØÿ±ÿµÿØ','ÿ±ÿ™ÿ®Ÿá','ÿ™ÿßÿ±€åÿÆ ÿ´ÿ®ÿ™'];
  const rows1 = sorted.map((ev, i) => {
    const pct = Math.round(ev.totalScore / ev.maxScore * 100);
    return [i+1, persianDate(ev.date), ev.employeeName, ev.departmentName, ev.totalScore, ev.maxScore, pct+'%', scoreBadge(pct), persianDate(ev.timestamp)];
  });
  const avgPct = Math.round(myEvals.reduce((s,e) => s + (e.totalScore/e.maxScore*100), 0) / myEvals.length);
  rows1.push([]);
  rows1.push(['', 'ŸÖ€åÿßŸÜ⁄Ø€åŸÜ ⁄©ŸÑ', '', '', '', '', avgPct+'%', scoreBadge(avgPct), '']);
  const ws1 = XLSX.utils.aoa_to_sheet([headers1, ...rows1]);
  ws1['!cols'] = [{wch:6},{wch:14},{wch:22},{wch:18},{wch:16},{wch:16},{wch:10},{wch:16},{wch:14}];
  styleHeader(ws1, 'A1:I1', '1E40AF');
  styleDataRows(ws1, 1, rows1.length, 9, 'EFF6FF');
  XLSX.utils.book_append_sheet(wb, ws1, 'ŸÑ€åÿ≥ÿ™ ÿßÿ±ÿ≤€åÿßÿ®€å‚ÄåŸáÿß');
  const headers2 = ['ŸÜÿßŸÖ ⁄©ÿßÿ±ŸÖŸÜÿØ','ÿ®ÿÆÿ¥','ÿ™ÿßÿ±€åÿÆ','ŸÖÿπ€åÿßÿ±','ÿ∂ÿ±€åÿ®','ÿßŸÖÿ™€åÿßÿ≤ (€±-€±€∞)','ÿßŸÖÿ™€åÿßÿ≤ Ÿàÿ≤ŸÜ€å'];
  const rows2 = [];
  sorted.forEach(ev => {
    if (ev.criteriaSnapshot && ev.scores) {
      ev.criteriaSnapshot.forEach(c => {
        const sc = ev.scores[c.id] || 0;
        rows2.push([ev.employeeName, ev.departmentName, persianDate(ev.date), c.name, c.weight, sc, sc * c.weight]);
      });
    }
  });
  if (rows2.length > 0) {
    const ws2 = XLSX.utils.aoa_to_sheet([headers2, ...rows2]);
    ws2['!cols'] = [{wch:22},{wch:18},{wch:14},{wch:30},{wch:10},{wch:14},{wch:14}];
    styleHeader(ws2, 'A1:G1', '059669');
    styleDataRows(ws2, 1, rows2.length, 7, 'F0FDF4');
    XLSX.utils.book_append_sheet(wb, ws2, 'ÿ¨ÿ≤ÿ¶€åÿßÿ™ ŸÖÿπ€åÿßÿ±Ÿáÿß');
  }
  XLSX.writeFile(wb, `ÿßÿ±ÿ≤€åÿßÿ®€å-${currentManager}-${new Date().toISOString().split('T')[0]}.xlsx`);
  alert('‚úÖ ŸÅÿß€åŸÑ ÿß⁄©ÿ≥ŸÑ ÿØÿßŸÜŸÑŸàÿØ ÿ¥ÿØ!');
}

function exportAllEvaluationsExcel() {
  if (evaluations.length === 0) { alert('‚ö†Ô∏è ÿßÿ±ÿ≤€åÿßÿ®€å‚Äåÿß€å Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ±ÿØ!'); return; }
  const wb = XLSX.utils.book_new();
  const sorted = [...evaluations].sort((a,b) => new Date(b.timestamp)-new Date(a.timestamp));
  const headers1 = ['ÿ±ÿØ€åŸÅ','ÿ™ÿßÿ±€åÿÆ ÿßÿ±ÿ≤€åÿßÿ®€å','ŸÜÿßŸÖ ⁄©ÿßÿ±ŸÖŸÜÿØ','ÿ®ÿÆÿ¥','ŸÖÿØ€åÿ± ÿßÿ±ÿ≤€åÿßÿ®','ÿßŸÖÿ™€åÿßÿ≤','ÿ≠ÿØÿß⁄©ÿ´ÿ±','ÿØÿ±ÿµÿØ','ÿ±ÿ™ÿ®Ÿá'];
  const rows1 = sorted.map((ev, i) => {
    const pct = Math.round(ev.totalScore / ev.maxScore * 100);
    return [i+1, persianDate(ev.date), ev.employeeName, ev.departmentName, ev.managerName||'‚Äî', ev.totalScore, ev.maxScore, pct+'%', scoreBadge(pct)];
  });
  const ws1 = XLSX.utils.aoa_to_sheet([headers1, ...rows1]);
  ws1['!cols'] = [{wch:6},{wch:14},{wch:22},{wch:18},{wch:18},{wch:12},{wch:12},{wch:10},{wch:16}];
  styleHeader(ws1, 'A1:I1', '1E40AF');
  styleDataRows(ws1, 1, rows1.length, 9, 'EFF6FF');
  XLSX.utils.book_append_sheet(wb, ws1, 'ŸáŸÖŸá ÿßÿ±ÿ≤€åÿßÿ®€å‚ÄåŸáÿß');
  const mgrMap = {};
  evaluations.forEach(ev => {
    const m = ev.managerName || '‚Äî';
    if (!mgrMap[m]) mgrMap[m] = { count: 0, sumPct: 0, employees: new Set() };
    mgrMap[m].count++; mgrMap[m].sumPct += (ev.totalScore / ev.maxScore * 100); mgrMap[m].employees.add(ev.employeeName);
  });
  const ws2 = XLSX.utils.aoa_to_sheet([['ŸÜÿßŸÖ ŸÖÿØ€åÿ±','ÿ™ÿπÿØÿßÿØ ÿßÿ±ÿ≤€åÿßÿ®€å','ÿ™ÿπÿØÿßÿØ ⁄©ÿßÿ±ŸÖŸÜÿØÿßŸÜ','ŸÖ€åÿßŸÜ⁄Ø€åŸÜ ÿßŸÖÿ™€åÿßÿ≤'], ...Object.entries(mgrMap).map(([n,d])=>[n,d.count,d.employees.size,Math.round(d.sumPct/d.count)+'%'])]);
  ws2['!cols'] = [{wch:22},{wch:16},{wch:18},{wch:16}];
  styleHeader(ws2, 'A1:D1', '7C3AED');
  XLSX.utils.book_append_sheet(wb, ws2, 'ÿÆŸÑÿßÿµŸá ÿ®Ÿá ÿ™ŸÅ⁄©€å⁄© ŸÖÿØ€åÿ±');
  XLSX.writeFile(wb, `ŸáŸÖŸá-ÿßÿ±ÿ≤€åÿßÿ®€å‚ÄåŸáÿß-${new Date().toISOString().split('T')[0]}.xlsx`);
  alert('‚úÖ ŸÅÿß€åŸÑ ÿß⁄©ÿ≥ŸÑ ÿØÿßŸÜŸÑŸàÿØ ÿ¥ÿØ!');
}

function exportRankingExcel() {
  if (evaluations.length === 0) { alert('‚ö†Ô∏è ÿßÿ±ÿ≤€åÿßÿ®€å‚Äåÿß€å Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ±ÿØ!'); return; }
  const empMap = {};
  evaluations.forEach(ev => {
    if (!empMap[ev.employeeName]) empMap[ev.employeeName] = { name: ev.employeeName, dept: ev.departmentName, totalScore: 0, totalMax: 0, count: 0 };
    empMap[ev.employeeName].totalScore += ev.totalScore;
    empMap[ev.employeeName].totalMax  += ev.maxScore;
    empMap[ev.employeeName].count++;
  });
  const ranked = Object.values(empMap).map(e => ({...e, avgPct: e.totalMax > 0 ? Math.round(e.totalScore / e.totalMax * 100) : 0})).sort((a,b) => b.avgPct - a.avgPct);
  const wb = XLSX.utils.book_new();
  const headers = ['ÿ±ÿ™ÿ®Ÿá','ŸÖÿØÿßŸÑ','ŸÜÿßŸÖ ⁄©ÿßÿ±ŸÖŸÜÿØ','ÿ®ÿÆÿ¥','ÿ™ÿπÿØÿßÿØ ÿßÿ±ÿ≤€åÿßÿ®€å','ŸÖÿ¨ŸÖŸàÿπ ÿßŸÖÿ™€åÿßÿ≤','ŸÖ€åÿßŸÜ⁄Ø€åŸÜ ÿØÿ±ÿµÿØ','Ÿàÿ∂ÿπ€åÿ™'];
  const rows = ranked.map((emp, i) => {
    const rank = i + 1;
    return [rank, rank===1?'ü•á':rank===2?'ü•à':rank===3?'ü•â':'', emp.name, emp.dept, emp.count, emp.totalScore, emp.avgPct+'%', scoreBadge(emp.avgPct)];
  });
  const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
  ws['!cols'] = [{wch:8},{wch:8},{wch:22},{wch:18},{wch:14},{wch:14},{wch:14},{wch:16}];
  styleHeader(ws, 'A1:H1', 'D97706');
  XLSX.utils.book_append_sheet(wb, ws, 'ÿ±ÿ™ÿ®Ÿá‚Äåÿ®ŸÜÿØ€å ⁄©ÿßÿ±ŸÖŸÜÿØÿßŸÜ');
  XLSX.writeFile(wb, `ÿ±ÿ™ÿ®Ÿá‚Äåÿ®ŸÜÿØ€å-⁄©ÿßÿ±ŸÖŸÜÿØÿßŸÜ-${new Date().toISOString().split('T')[0]}.xlsx`);
  alert('‚úÖ ŸÅÿß€åŸÑ ÿß⁄©ÿ≥ŸÑ ÿ±ÿ™ÿ®Ÿá‚Äåÿ®ŸÜÿØ€å ÿØÿßŸÜŸÑŸàÿØ ÿ¥ÿØ!');
}
</script>

<!-- SUPPLY SCRIPT -->
<script>
let sDb = null;
let sFbOk = false;
// Use same Firebase app initialized in eval section
try {
  sDb = firebase.database();
  sFbOk = true;
  console.log('‚úÖ Supply module: Firebase connected');
} catch(e) { 
  console.warn('Supply Firebase error:', e);
  sFbOk = false;
}

let sProducts=[], sFactories=[], sPrices=[];
let sChartPeriod=7;
let sEditProductId=null, sEditFactoryId=null, sEditPriceId=null;
let sAddFormVisible=true;
let selectedProducts = new Set();

function supplyInit() {
  if (!sFbOk) {
    // Offline fallback
    sProducts  = sLoadLS('products');
    sFactories = sLoadLS('factories');
    sPrices    = sLoadLS('prices');
    sRefreshAll();
    if (sProducts.length===0) sSeedProducts();
    if (sFactories.length===0) sSeedFactories();
    return;
  }
  // Firebase listeners - single source of truth
  sListenFB('products',  d=>{sProducts=d;  localStorage.setItem('supply_products',JSON.stringify(d));   sRefreshAll();});
  sListenFB('factories', d=>{sFactories=d; localStorage.setItem('supply_factories',JSON.stringify(d)); sRefreshAll();});
  sListenFB('prices',    d=>{sPrices=d;    localStorage.setItem('supply_prices',JSON.stringify(d));       sRefreshAll();});
  // Apply full backup restore if pending
  if (window._pendingSupplyRestore) {
    const r = window._pendingSupplyRestore;
    delete window._pendingSupplyRestore;
    if (r.products) { sProducts = r.products; sPersist('products', sProducts); }
    if (r.factories) { sFactories = r.factories; sPersist('factories', sFactories); }
    if (r.prices) { sProducts = r.prices; sPersist('prices', sPrices); }
    sRefreshAll();
    showImportToast && showImportToast('‚úÖ ÿ®⁄©ÿßŸæ ⁄©ÿßŸÖŸÑ ÿ®ÿß ŸÖŸàŸÅŸÇ€åÿ™ ÿ®ÿßÿ≤€åÿßÿ®€å ÿ¥ÿØ');
    return;
  }
  // Seed only if Firebase is empty (first run)
  sDb.ref('supply/products').once('value').then(snap => {
    if (!snap.exists() || Object.keys(snap.val()||{}).length === 0) sSeedProducts();
  });
  sDb.ref('supply/factories').once('value').then(snap => {
    if (!snap.exists() || Object.keys(snap.val()||{}).length === 0) sSeedFactories();
  });
}

function sPersist(key,data){
  if (sFbOk) {
    sDb.ref('supply/'+key).set(data).catch(e => {
      console.error('Firebase write error:', e);
      localStorage.setItem('supply_'+key,JSON.stringify(data));
    });
  } else {
    localStorage.setItem('supply_'+key,JSON.stringify(data));
  }
}
function sLoadLS(key){try{return JSON.parse(localStorage.getItem('supply_'+key))||[];}catch{return[];}}
function sListenFB(key,cb){
  if (!sFbOk) return;
  sDb.ref('supply/'+key).on('value', snap => {
    if (!snap.exists()) { cb([]); return; }
    const val = snap.val();
    // Firebase stores arrays as objects with numeric keys
    if (Array.isArray(val)) cb(val.filter(Boolean));
    else cb(Object.values(val).filter(Boolean));
  });
}

function sSeedProducts(){
  sProducts=[
    {id:1,name:'ŸÜÿ®ÿ¥€å',category:'ŸÜÿ®ÿ¥€å',icon:'üìê',unit:'⁄©€åŸÑŸà⁄Øÿ±ŸÖ',desc:'ŸÜÿ®ÿ¥€å ÿ≥ÿßÿÆÿ™ŸÖÿßŸÜ€å Ÿà ÿµŸÜÿπÿ™€å'},
    {id:2,name:'ŸÖ€åŸÑ⁄Øÿ±ÿØ A3',category:'ŸÖ€åŸÑ⁄Øÿ±ÿØ',icon:'üî©',unit:'⁄©€åŸÑŸà⁄Øÿ±ŸÖ',desc:'ŸÖ€åŸÑ⁄Øÿ±ÿØ ÿ¢ÿ¨ÿØÿßÿ± A3'},
    {id:3,name:'ŸÖ€åŸÑ⁄Øÿ±ÿØ A2',category:'ŸÖ€åŸÑ⁄Øÿ±ÿØ',icon:'üî©',unit:'⁄©€åŸÑŸà⁄Øÿ±ŸÖ',desc:'ŸÖ€åŸÑ⁄Øÿ±ÿØ ÿ≥ÿßÿØŸá A2'},
    {id:4,name:'ŸÜÿßŸàÿØÿßŸÜ€å',category:'ŸÜÿßŸàÿØÿßŸÜ€å',icon:'üìè',unit:'⁄©€åŸÑŸà⁄Øÿ±ŸÖ',desc:'ŸÜÿßŸàÿØÿßŸÜ€å ÿ≥ÿ®⁄© Ÿà ÿ≥ŸÜ⁄Ø€åŸÜ'},
    {id:5,name:'ÿ™€åÿ±ÿ¢ŸáŸÜ IPE',category:'ÿ™€åÿ±ÿ¢ŸáŸÜ',icon:'üèóÔ∏è',unit:'⁄©€åŸÑŸà⁄Øÿ±ŸÖ',desc:'ÿ™€åÿ±ÿ¢ŸáŸÜ IPE'},
    {id:6,name:'ÿ™€åÿ±ÿ¢ŸáŸÜ INP',category:'ÿ™€åÿ±ÿ¢ŸáŸÜ',icon:'üèóÔ∏è',unit:'⁄©€åŸÑŸà⁄Øÿ±ŸÖ',desc:'ÿ™€åÿ±ÿ¢ŸáŸÜ INP'},
    {id:7,name:'Ÿàÿ±ŸÇ ÿ≥€åÿßŸá',category:'Ÿàÿ±ŸÇ',icon:'üî≤',unit:'⁄©€åŸÑŸà⁄Øÿ±ŸÖ',desc:'Ÿàÿ±ŸÇ ÿ≥€åÿßŸá ST37'},
    {id:8,name:'Ÿàÿ±ŸÇ ⁄ØÿßŸÑŸàÿßŸÜ€åÿ≤Ÿá',category:'Ÿàÿ±ŸÇ',icon:'üî≤',unit:'⁄©€åŸÑŸà⁄Øÿ±ŸÖ',desc:'Ÿàÿ±ŸÇ ⁄ØÿßŸÑŸàÿßŸÜ€åÿ≤Ÿá'},
    {id:9,name:'ŸÑŸàŸÑŸá ⁄Øÿßÿ≤',category:'ŸÑŸàŸÑŸá',icon:'‚≠ï',unit:'ŸÖÿ™ÿ±',desc:'ŸÑŸàŸÑŸá ⁄Øÿßÿ≤ ÿ®ÿ±ŸàÿØÿßÿ±'},
    {id:10,name:'ŸÑŸàŸÑŸá ÿ¢ÿ®',category:'ŸÑŸàŸÑŸá',icon:'‚≠ï',unit:'ŸÖÿ™ÿ±',desc:'ŸÑŸàŸÑŸá ÿ¢ÿ® Ÿà ŸÅÿßÿ∂ŸÑÿßÿ®'},
    {id:11,name:'Ÿæÿ±ŸàŸÅ€åŸÑ ŸÖÿ±ÿ®ÿπ',category:'Ÿæÿ±ŸàŸÅ€åŸÑ',icon:'üì¶',unit:'ŸÖÿ™ÿ±',desc:'Ÿæÿ±ŸàŸÅ€åŸÑ ŸÖÿ±ÿ®ÿπ'},
    {id:12,name:'ŸÖŸÅÿ™ŸàŸÑ',category:'ŸÖŸÅÿ™ŸàŸÑ',icon:'üßµ',unit:'⁄©€åŸÑŸà⁄Øÿ±ŸÖ',desc:'ŸÖŸÅÿ™ŸàŸÑ ÿ≥€åÿßŸá'}
  ];
  sPersist('products',sProducts);
}

function sSeedFactories(){
  sFactories=[
    {id:1,name:'ÿ∞Ÿàÿ®‚Äåÿ¢ŸáŸÜ ÿßÿµŸÅŸáÿßŸÜ',city:'ÿßÿµŸÅŸáÿßŸÜ',products:'ŸÖ€åŸÑ⁄Øÿ±ÿØÿå ÿ™€åÿ±ÿ¢ŸáŸÜ',tel:'0311-XXXXXXX',status:'ŸÅÿπÿßŸÑ',note:'ÿ®ÿ≤ÿ±⁄Ø‚Äåÿ™ÿ±€åŸÜ ÿ™ŸàŸÑ€åÿØ⁄©ŸÜŸÜÿØŸá'},
    {id:2,name:'ŸÅŸàŸÑÿßÿØ ŸÖÿ®ÿßÿ±⁄©Ÿá',city:'ŸÖÿ®ÿßÿ±⁄©Ÿá',products:'Ÿàÿ±ŸÇÿå ŸÖ€åŸÑ⁄Øÿ±ÿØ',tel:'0312-XXXXXXX',status:'ŸÅÿπÿßŸÑ',note:''},
    {id:3,name:'ŸÜŸàÿ±ÿØ ŸÑÿ±ÿ≥ÿ™ÿßŸÜ',city:'ÿÆÿ±ŸÖ‚Äåÿ¢ÿ®ÿßÿØ',products:'ŸÜÿ®ÿ¥€åÿå ŸÜÿßŸàÿØÿßŸÜ€å',tel:'0661-XXXXXXX',status:'ŸÅÿπÿßŸÑ',note:''},
    {id:4,name:'ÿ¥ÿßŸá€åŸÜ ÿ®ŸÜÿßÿ®',city:'ÿ®ŸÜÿßÿ®',products:'ŸÖ€åŸÑ⁄Øÿ±ÿØ',tel:'0412-XXXXXXX',status:'ŸÅÿπÿßŸÑ',note:''},
    {id:5,name:'ÿ¢ÿ±€åÿß ÿ∞Ÿàÿ®',city:'ÿ™Ÿáÿ±ÿßŸÜ',products:'ŸÑŸàŸÑŸáÿå ŸÜÿ®ÿ¥€å',tel:'021-XXXXXXX',status:'ÿØÿ± ÿ≠ÿßŸÑ ŸÖÿ∞ÿß⁄©ÿ±Ÿá',note:''}
  ];
  sPersist('factories',sFactories);
}

function sRefreshAll(){
  // Update connection status indicator
  const dot = document.getElementById('supply-status-dot');
  const txt = document.getElementById('supply-status-text');
  if (dot && txt) {
    if (sFbOk) { dot.style.background='#4ade80'; txt.textContent='Firebase'; }
    else { dot.style.background='#f87171'; txt.textContent='ÿ¢ŸÅŸÑÿß€åŸÜ'; }
  }
  sUpdateStats(); sUpdateDropdowns();
  sRenderProductsGrid(); sRenderFactoriesGrid(); sRenderPriceTable();
  const salesSection = document.getElementById('supply-sales-dashboard-section');
  if (salesSection && salesSection.classList.contains('active')) {
    renderProductCheckboxes();
    renderSalesPriceTables();
  }
}

function sUpdateStats(){
  document.getElementById('stat-products').textContent  = sProducts.length;
  document.getElementById('stat-factories').textContent = sFactories.length;
  document.getElementById('stat-prices').textContent    = sPrices.length;
  document.getElementById('nc-products').textContent    = sProducts.length;
  document.getElementById('nc-factories').textContent   = sFactories.length;
  document.getElementById('nc-prices').textContent      = sPrices.length;
  const today=new Date().toDateString();
  document.getElementById('stat-today').textContent = sPrices.filter(p=>new Date(p.updatedAt).toDateString()===today).length;
}

function sUpdateDropdowns(){
  ['p-product','filter-product','ep-product','chart-product-filter'].forEach(id=>{
    const el=document.getElementById(id); if (!el) return;
    const cur=el.value; const isF=id.includes('filter')||id.includes('chart');
    el.innerHTML=isF?'<option value="">ŸáŸÖŸá ŸÖÿ≠ÿµŸàŸÑÿßÿ™</option>':'<option value="">ÿßŸÜÿ™ÿÆÿßÿ® ŸÖÿ≠ÿµŸàŸÑ...</option>';
    sProducts.forEach(p=>el.insertAdjacentHTML('beforeend',`<option value="${p.name}"${p.name===cur?' selected':''}>${p.icon||'üì¶'} ${p.name}</option>`));
  });
  ['p-factory','filter-factory','ep-factory','chart-factory-filter'].forEach(id=>{
    const el=document.getElementById(id); if (!el) return;
    const cur=el.value; const isF=id.includes('filter')||id.includes('chart');
    el.innerHTML=isF?'<option value="">ŸáŸÖŸá ⁄©ÿßÿ±ÿÆÿßŸÜÿ¨ÿßÿ™</option>':'<option value="">ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ÿßÿ±ÿÆÿßŸÜŸá...</option>';
    sFactories.forEach(f=>el.insertAdjacentHTML('beforeend',`<option value="${f.name}"${f.name===cur?' selected':''}>${f.name}</option>`));
  });
}

function openProductModal(id=null){
  sEditProductId=id;
  if (id){
    const p=sProducts.find(x=>x.id===id);
    document.getElementById('product-modal-title').textContent='‚úèÔ∏è Ÿà€åÿ±ÿß€åÿ¥ ŸÖÿ≠ÿµŸàŸÑ';
    document.getElementById('prod-name').value=p.name;
    document.getElementById('prod-category').value=p.category||'ÿ≥ÿß€åÿ±';
    document.getElementById('prod-icon').value=p.icon||'';
    document.getElementById('prod-unit').value=p.unit||'⁄©€åŸÑŸà⁄Øÿ±ŸÖ';
    document.getElementById('prod-desc').value=p.desc||'';
  } else {
    document.getElementById('product-modal-title').textContent='üì¶ ÿßŸÅÿ≤ŸàÿØŸÜ ŸÖÿ≠ÿµŸàŸÑ ÿ¨ÿØ€åÿØ';
    ['prod-name','prod-icon','prod-desc'].forEach(f=>document.getElementById(f).value='');
    document.getElementById('prod-unit').value='⁄©€åŸÑŸà⁄Øÿ±ŸÖ';
  }
  document.getElementById('s-product-modal').classList.add('active');
}

function saveProduct(){
  const name=document.getElementById('prod-name').value.trim();
  if (!name){sShowToast('ŸÜÿßŸÖ ŸÖÿ≠ÿµŸàŸÑ ÿßŸÑÿ≤ÿßŸÖ€å ÿßÿ≥ÿ™!','‚ö†Ô∏è');return;}
  if (sEditProductId){
    const p=sProducts.find(x=>x.id===sEditProductId);
    p.name=name; p.icon=document.getElementById('prod-icon').value;
    p.unit=document.getElementById('prod-unit').value;
    p.desc=document.getElementById('prod-desc').value;
    p.category=document.getElementById('prod-category').value;
  } else {
    sProducts.push({id:Date.now(),name,category:document.getElementById('prod-category').value,icon:document.getElementById('prod-icon').value||'üì¶',unit:document.getElementById('prod-unit').value,desc:document.getElementById('prod-desc').value});
  }
  sPersist('products',sProducts);
  closeSupplyModal('s-product-modal');
  sRenderProductsGrid(); sUpdateDropdowns(); sUpdateStats();
  sShowToast(sEditProductId?'ŸÖÿ≠ÿµŸàŸÑ Ÿà€åÿ±ÿß€åÿ¥ ÿ¥ÿØ':'ŸÖÿ≠ÿµŸàŸÑ ÿßÿ∂ÿßŸÅŸá ÿ¥ÿØ');
  sEditProductId=null;
}

function deleteProduct(id){
  if (!confirm('ÿ≠ÿ∞ŸÅ ÿß€åŸÜ ŸÖÿ≠ÿµŸàŸÑÿü')) return;
  sProducts=sProducts.filter(p=>p.id!==id);
  sPersist('products',sProducts);
  sRenderProductsGrid(); sUpdateDropdowns(); sUpdateStats();
  sShowToast('ŸÖÿ≠ÿµŸàŸÑ ÿ≠ÿ∞ŸÅ ÿ¥ÿØ','üóëÔ∏è');
}

function sRenderProductsGrid(){
  const g=document.getElementById('products-grid');
  if (sProducts.length===0){
    g.innerHTML=`<div class="empty"><div class="empty-icon">üì¶</div><div class="empty-text">ŸáŸÜŸàÿ≤ ŸÖÿ≠ÿµŸàŸÑ€å ÿßÿ∂ÿßŸÅŸá ŸÜÿ¥ÿØŸá</div></div>`;return;
  }
  g.innerHTML=sProducts.map(p=>{
    const cnt=sPrices.filter(x=>x.product===p.name).length;
    return `<div class="item-card">
      <div class="item-card-header"><div class="item-card-icon">${p.icon||'üì¶'}</div><div class="chip chip-amber">${cnt} ŸÇ€åŸÖÿ™</div></div>
      <div class="item-card-name">${p.name}</div>
      <div class="item-card-meta">${p.unit} ${p.desc?'¬∑ '+p.desc:''}</div>
      <div class="item-card-actions">
        <button class="btn btn-ghost btn-sm" onclick="openProductModal(${p.id})">‚úèÔ∏è Ÿà€åÿ±ÿß€åÿ¥</button>
        <button class="btn btn-danger btn-sm" onclick="deleteProduct(${p.id})">üóëÔ∏è</button>
      </div>
    </div>`;
  }).join('');
}

function openFactoryModal(id=null){
  sEditFactoryId=id;
  if (id){
    const f=sFactories.find(x=>x.id===id);
    document.getElementById('factory-modal-title').textContent='‚úèÔ∏è Ÿà€åÿ±ÿß€åÿ¥ ⁄©ÿßÿ±ÿÆÿßŸÜŸá';
    document.getElementById('fac-name').value=f.name;
    document.getElementById('fac-city').value=f.city||'';
    document.getElementById('fac-products').value=f.products||'';
    document.getElementById('fac-tel').value=f.tel||'';
    document.getElementById('fac-status').value=f.status||'ŸÅÿπÿßŸÑ';
    document.getElementById('fac-note').value=f.note||'';
  } else {
    document.getElementById('factory-modal-title').textContent='üè≠ ÿßŸÅÿ≤ŸàÿØŸÜ ⁄©ÿßÿ±ÿÆÿßŸÜŸá';
    ['fac-name','fac-city','fac-products','fac-tel','fac-note'].forEach(f=>document.getElementById(f).value='');
    document.getElementById('fac-status').value='ŸÅÿπÿßŸÑ';
  }
  document.getElementById('s-factory-modal').classList.add('active');
}

function saveFactory(){
  const name=document.getElementById('fac-name').value.trim();
  if (!name){sShowToast('ŸÜÿßŸÖ ⁄©ÿßÿ±ÿÆÿßŸÜŸá ÿßŸÑÿ≤ÿßŸÖ€å ÿßÿ≥ÿ™!','‚ö†Ô∏è');return;}
  const obj={name,city:document.getElementById('fac-city').value,products:document.getElementById('fac-products').value,tel:document.getElementById('fac-tel').value,status:document.getElementById('fac-status').value,note:document.getElementById('fac-note').value};
  if (sEditFactoryId){const i=sFactories.findIndex(x=>x.id===sEditFactoryId);sFactories[i]={...sFactories[i],...obj};}
  else sFactories.push({id:Date.now(),...obj});
  sPersist('factories',sFactories);
  closeSupplyModal('s-factory-modal');
  sRenderFactoriesGrid(); sUpdateDropdowns(); sUpdateStats();
  sShowToast(sEditFactoryId?'⁄©ÿßÿ±ÿÆÿßŸÜŸá Ÿà€åÿ±ÿß€åÿ¥ ÿ¥ÿØ':'⁄©ÿßÿ±ÿÆÿßŸÜŸá ÿßÿ∂ÿßŸÅŸá ÿ¥ÿØ');
  sEditFactoryId=null;
}

function deleteFactory(id){
  if (!confirm('ÿ≠ÿ∞ŸÅ ÿß€åŸÜ ⁄©ÿßÿ±ÿÆÿßŸÜŸáÿü')) return;
  sFactories=sFactories.filter(f=>f.id!==id);
  sPersist('factories',sFactories);
  sRenderFactoriesGrid(); sUpdateDropdowns(); sUpdateStats();
  sShowToast('⁄©ÿßÿ±ÿÆÿßŸÜŸá ÿ≠ÿ∞ŸÅ ÿ¥ÿØ','üóëÔ∏è');
}

const sStatusChip=s=>s==='ŸÅÿπÿßŸÑ'?'chip-green':s==='ÿ∫€åÿ±ŸÅÿπÿßŸÑ'?'chip-red':'chip-amber';

function sRenderFactoriesGrid(){
  const g=document.getElementById('factories-grid');
  if (sFactories.length===0){
    g.innerHTML=`<div class="empty"><div class="empty-icon">üè≠</div><div class="empty-text">ŸáŸÜŸàÿ≤ ⁄©ÿßÿ±ÿÆÿßŸÜŸá‚Äåÿß€å ÿßÿ∂ÿßŸÅŸá ŸÜÿ¥ÿØŸá</div></div>`;return;
  }
  g.innerHTML=sFactories.map(f=>{
    const cnt=sPrices.filter(p=>p.factory===f.name).length;
    return `<div class="item-card">
      <div class="item-card-header"><div class="item-card-icon">üè≠</div><div class="chip ${sStatusChip(f.status)}">${f.status}</div></div>
      <div class="item-card-name">${f.name}</div>
      <div class="item-card-meta" style="margin-bottom:8px;">${f.city?'üìç '+f.city+' &nbsp;':''} ${cnt} ÿ±⁄©Ÿàÿ±ÿØ ŸÇ€åŸÖÿ™</div>
      ${f.products?`<div style="font-size:12px;color:var(--text-light);margin-bottom:4px;">üî© ${f.products}</div>`:''}
      ${f.tel?`<div style="font-size:12px;color:var(--text-light);">üìû ${f.tel}</div>`:''}
      <div class="item-card-actions">
        <button class="btn btn-ghost btn-sm" onclick="openFactoryModal(${f.id})">‚úèÔ∏è Ÿà€åÿ±ÿß€åÿ¥</button>
        <button class="btn btn-danger btn-sm" onclick="deleteFactory(${f.id})">üóëÔ∏è</button>
      </div>
    </div>`;
  }).join('');
}

function addPrice(){
  const product=document.getElementById('p-product').value;
  const size=document.getElementById('p-size').value.trim();
  const factory=document.getElementById('p-factory').value;
  const price=parseFloat(document.getElementById('p-price').value);
  const note=document.getElementById('p-note').value.trim();
  if (!product||!size||!factory||isNaN(price)){sShowToast('ŸÑÿ∑ŸÅÿßŸã ŸÅ€åŸÑÿØŸáÿß€å ÿ≥ÿ™ÿßÿ±Ÿá‚ÄåÿØÿßÿ± ÿ±ÿß Ÿæÿ± ⁄©ŸÜ€åÿØ','‚ö†Ô∏è');return;}
  const existing=sPrices.find(p=>p.product===product&&p.size===size&&p.factory===factory);
  if (existing){
    existing.prevPrice=existing.price;existing.price=price;existing.note=note;
    existing.updatedAt=new Date().toISOString();
    sShowToast(`ŸÇ€åŸÖÿ™ ${product} ${size} ÿ¢ŸæÿØ€åÿ™ ÿ¥ÿØ`,'üîÑ');
  } else {
    sPrices.push({id:Date.now(),product,size,factory,price,prevPrice:null,note,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()});
    sShowToast(`ŸÇ€åŸÖÿ™ ${product} ${size} ÿ´ÿ®ÿ™ ÿ¥ÿØ`);
  }
  sPersist('prices',sPrices);
  clearPriceForm(); sRenderPriceTable(); sUpdateStats(); sUpdateDropdowns();
}

function clearPriceForm(){
  ['p-product','p-factory'].forEach(id=>document.getElementById(id).value='');
  ['p-size','p-price','p-note'].forEach(id=>document.getElementById(id).value='');
}

function sRenderPriceTable(){
  const search=document.getElementById('price-search')?.value.toLowerCase()||'';
  const fprod=document.getElementById('filter-product')?.value||'';
  const ffact=document.getElementById('filter-factory')?.value||'';
  const tbody=document.getElementById('price-tbody');
  const empty=document.getElementById('price-empty');
  let rows=[...sPrices].sort((a,b)=>new Date(b.updatedAt)-new Date(a.updatedAt));
  if (fprod) rows=rows.filter(r=>r.product===fprod);
  if (ffact) rows=rows.filter(r=>r.factory===ffact);
  if (search) rows=rows.filter(r=>r.product.toLowerCase().includes(search)||r.size.toLowerCase().includes(search)||r.factory.toLowerCase().includes(search)||(r.note||'').toLowerCase().includes(search));
  if (rows.length===0){tbody.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  tbody.innerHTML=rows.map(r=>{
    const d=new Date(r.updatedAt);
    const dateStr=d.toLocaleDateString('fa-IR');
    const timeStr=d.toLocaleTimeString('fa-IR',{hour:'2-digit',minute:'2-digit'});
    let changeTxt='<span class="change-flat">‚Äî</span>';
    if (r.prevPrice!==null&&r.prevPrice!==undefined){
      const diff=r.price-r.prevPrice;const pct=((diff/r.prevPrice)*100).toFixed(1);
      if (diff>0) changeTxt=`<span class="change-up">‚ñ≤ ${pct}%</span>`;
      else if (diff<0) changeTxt=`<span class="change-down">‚ñº ${Math.abs(pct)}%</span>`;
      else changeTxt='<span class="change-flat">ÿ®ÿØŸàŸÜ ÿ™ÿ∫€å€åÿ±</span>';
    }
    const prod=sProducts.find(p=>p.name===r.product);
    return `<tr>
      <td><span class="chip chip-cyan">${prod?.icon||'üì¶'} ${r.product}</span></td>
      <td><strong>${r.size}</strong></td><td>${r.factory}</td>
      <td><div class="price-cell">${Number(r.price).toLocaleString('fa-IR')}</div><div class="price-unit">ÿ™ŸàŸÖÿßŸÜ / ⁄©€åŸÑŸà</div></td>
      <td>${changeTxt}</td>
      <td><div class="update-badge"><span class="date">${dateStr}</span><span>${timeStr}</span></div></td>
      <td style="max-width:140px;font-size:12px;color:var(--text-light);">${r.note||'‚Äî'}</td>
      <td><div class="actions"><button class="btn btn-ghost btn-sm" onclick="openEditPrice(${r.id})">‚úèÔ∏è</button><button class="btn btn-danger btn-sm" onclick="deletePrice(${r.id})">üóëÔ∏è</button></div></td>
    </tr>`;
  }).join('');
}

function renderPriceTable(){sRenderPriceTable();}

function openEditPrice(id){
  sEditPriceId=id;const p=sPrices.find(x=>x.id===id);
  sUpdateDropdowns();
  setTimeout(()=>{
    document.getElementById('ep-product').value=p.product;
    document.getElementById('ep-factory').value=p.factory;
    document.getElementById('ep-size').value=p.size;
    document.getElementById('ep-price').value=p.price;
    document.getElementById('ep-note').value=p.note||'';
  },50);
  document.getElementById('s-edit-price-modal').classList.add('active');
}

function saveEditedPrice(){
  const p=sPrices.find(x=>x.id===sEditPriceId);
  p.prevPrice=p.price;p.product=document.getElementById('ep-product').value;
  p.size=document.getElementById('ep-size').value;p.factory=document.getElementById('ep-factory').value;
  p.price=parseFloat(document.getElementById('ep-price').value);p.note=document.getElementById('ep-note').value;
  p.updatedAt=new Date().toISOString();
  sPersist('prices',sPrices);closeSupplyModal('s-edit-price-modal');sRenderPriceTable();sUpdateStats();
  sShowToast('ŸÇ€åŸÖÿ™ Ÿà€åÿ±ÿß€åÿ¥ ÿ¥ÿØ','üîÑ');
}

function deletePrice(id){
  if (!confirm('ÿ≠ÿ∞ŸÅ ÿß€åŸÜ ÿ±⁄©Ÿàÿ±ÿØ ŸÇ€åŸÖÿ™ÿü')) return;
  sPrices=sPrices.filter(p=>p.id!==id);
  sPersist('prices',sPrices);sRenderPriceTable();sUpdateStats();
  sShowToast('ÿ±⁄©Ÿàÿ±ÿØ ÿ≠ÿ∞ŸÅ ÿ¥ÿØ','üóëÔ∏è');
}

function exportCSV(){
  if (sPrices.length===0){sShowToast('ÿØÿßÿØŸá‚Äåÿß€å ÿ®ÿ±ÿß€å ÿÆÿ±Ÿàÿ¨€å ŸÜ€åÿ≥ÿ™','‚ö†Ô∏è');return;}
  const header=['ŸÜŸàÿπ ÿ®ÿßÿ±','ÿ≥ÿß€åÿ≤','⁄©ÿßÿ±ÿÆÿßŸÜŸá','ŸÇ€åŸÖÿ™ (ÿ™ŸàŸÖÿßŸÜ/⁄©€åŸÑŸà)','ÿ™ÿßÿ±€åÿÆ ÿ¢ŸæÿØ€åÿ™','ÿ™Ÿàÿ∂€åÿ≠ÿßÿ™'];
  const rows=sPrices.map(r=>[r.product,r.size,r.factory,r.price,new Date(r.updatedAt).toLocaleString('fa-IR'),r.note||'']);
  const csv=[header,...rows].map(r=>r.join(',')).join('\n');
  const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`supply-prices-${Date.now()}.csv`;a.click();
  sShowToast('ŸÅÿß€åŸÑ CSV ÿØÿßŸÜŸÑŸàÿØ ÿ¥ÿØ','üì•');
}

function toggleAddForm(){
  sAddFormVisible=!sAddFormVisible;
  document.getElementById('add-form-wrap').style.display=sAddFormVisible?'':'none';
  document.getElementById('toggle-icon').textContent=sAddFormVisible?'‚ñ≤':'‚ñº';
  const btn=document.querySelector('[onclick="toggleAddForm()"]');
  if (btn) btn.innerHTML=sAddFormVisible?'<span id="toggle-icon">‚ñ≤</span> ŸÖÿÆŸÅ€å ⁄©ÿ±ÿØŸÜ ŸÅÿ±ŸÖ':'<span id="toggle-icon">‚ñº</span> ŸÜŸÖÿß€åÿ¥ ŸÅÿ±ŸÖ ÿ´ÿ®ÿ™';
}

function supplyTab(tab,el){
  document.querySelectorAll('.supply-section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.supply-nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('supply-'+tab+'-section').classList.add('active');
  el.classList.add('active');
  if (tab==='analytics'){sUpdateDropdowns();setTimeout(renderAnalytics,100);}
  if (tab==='sales-dashboard'){renderProductCheckboxes();renderSalesPriceTables();}
}

function closeSupplyModal(id){
  document.getElementById(id).classList.remove('active');
}

['s-product-modal','s-factory-modal','s-edit-price-modal'].forEach(id=>{
  const el=document.getElementById(id);
  if (el) el.addEventListener('click',function(e){if(e.target===this)this.classList.remove('active');});
});

// ‚ïê‚ïê‚ïê SALES DASHBOARD FUNCTIONS ‚ïê‚ïê‚ïê
function getCategoryIcon(category) {
  const icons = {'ŸÖ€åŸÑ⁄Øÿ±ÿØ':'üî©','ÿ™€åÿ±ÿ¢ŸáŸÜ':'üèóÔ∏è','Ÿàÿ±ŸÇ':'üìÑ','ŸÜÿ®ÿ¥€å':'üìê','ŸÑŸàŸÑŸá':'üö∞','ŸÜÿßŸàÿØÿßŸÜ€å':'üåä','Ÿæÿ±ŸàŸÅ€åŸÑ':'üìè','ŸÖŸÅÿ™ŸàŸÑ':'üßµ','ÿ≥ÿß€åÿ±':'üì¶'};
  return icons[category] || 'üì¶';
}

function updateCategoryFilter() {
  const select = document.getElementById('sales-category-filter');
  if (!select) return;
  const categories = new Set();
  sProducts.forEach(p => categories.add(p.category || 'ÿ≥ÿß€åÿ±'));
  const currentValue = select.value;
  select.innerHTML = '<option value="">ŸáŸÖŸá ÿØÿ≥ÿ™Ÿá‚ÄåŸáÿß</option>' +
    [...categories].sort().map(cat => `<option value="${cat}" ${cat === currentValue ? 'selected' : ''}>${cat}</option>`).join('');
}

function renderProductCheckboxes() {
  const container = document.getElementById('sales-product-categories');
  const emptyDiv = document.getElementById('sales-product-empty');
  const totalBadge = document.getElementById('sales-total-products');
  const searchTerm = document.getElementById('sales-product-search')?.value.toLowerCase() || '';
  const categoryFilter = document.getElementById('sales-category-filter')?.value || '';
  if (!container) return;
  let filtered = [...sProducts];
  if (searchTerm) filtered = filtered.filter(p => p.name.toLowerCase().includes(searchTerm) || (p.desc||'').toLowerCase().includes(searchTerm) || (p.category||'ÿ≥ÿß€åÿ±').toLowerCase().includes(searchTerm));
  if (categoryFilter) filtered = filtered.filter(p => (p.category||'ÿ≥ÿß€åÿ±') === categoryFilter);
  if (filtered.length === 0) {
    container.style.display = 'none'; emptyDiv.style.display = 'block';
    totalBadge.textContent = '0 ŸÖÿ≠ÿµŸàŸÑ'; return;
  }
  container.style.display = 'block'; emptyDiv.style.display = 'none';
  totalBadge.textContent = `${filtered.length} ŸÖÿ≠ÿµŸàŸÑ`;
  const categories = {};
  filtered.forEach(product => {
    const cat = product.category || 'ÿ≥ÿß€åÿ±';
    if (!categories[cat]) categories[cat] = [];
    categories[cat].push(product);
  });
  container.innerHTML = Object.entries(categories).map(([catName, products]) => {
    const catIcon = getCategoryIcon(catName);
    const productsHtml = products.map(product => {
      const priceCount = sPrices.filter(p => p.product === product.name).length;
      const isChecked = selectedProducts.has(product.name);
      const safe = product.name.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
      return `<div class="product-checkbox-item ${isChecked ? 'selected' : ''}" onclick="toggleProduct('${safe}')">
        <input type="checkbox" ${isChecked ? 'checked' : ''} onclick="event.stopPropagation(); toggleProduct('${safe}')">
        <label class="product-checkbox-label">
          <span class="product-icon">${product.icon||'üì¶'}</span>
          <span style="flex:1;">${product.name}</span>
          <span class="product-price-count">${priceCount} ŸÇ€åŸÖÿ™</span>
        </label>
      </div>`;
    }).join('');
    return `<div class="product-category-section">
      <div class="category-header" onclick="toggleCategory(this)">
        <div class="category-header-left">
          <span class="category-icon">${catIcon}</span>
          <span class="category-name">${catName}</span>
          <span class="category-count">${products.length} ŸÖÿ≠ÿµŸàŸÑ</span>
        </div>
        <span class="category-toggle">‚ñº</span>
      </div>
      <div class="category-products">${productsHtml}</div>
    </div>`;
  }).join('');
  updateCategoryFilter();
}

function toggleCategory(header) {
  header.classList.toggle('collapsed');
  header.nextElementSibling.classList.toggle('collapsed');
}

function toggleProduct(productName) {
  if (selectedProducts.has(productName)) selectedProducts.delete(productName);
  else selectedProducts.add(productName);
  renderProductCheckboxes();
  renderSalesPriceTables();
}

function selectAllProducts() {
  const searchTerm = document.getElementById('sales-product-search')?.value.toLowerCase() || '';
  const categoryFilter = document.getElementById('sales-category-filter')?.value || '';
  let products = [...sProducts];
  if (searchTerm) products = products.filter(p => p.name.toLowerCase().includes(searchTerm));
  if (categoryFilter) products = products.filter(p => (p.category||'ÿ≥ÿß€åÿ±') === categoryFilter);
  products.forEach(p => selectedProducts.add(p.name));
  renderProductCheckboxes(); renderSalesPriceTables();
}

function deselectAllProducts() {
  selectedProducts.clear();
  renderProductCheckboxes(); renderSalesPriceTables();
}

function filterSalesProducts() { renderProductCheckboxes(); }

function refreshSalesDashboard() {
  renderProductCheckboxes(); renderSalesPriceTables();
  sShowToast('ÿØÿßÿ¥ÿ®Ÿàÿ±ÿØ ŸÅÿ±Ÿàÿ¥ ÿ®ÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å ÿ¥ÿØ','üîÑ');
}

function renderSalesPriceTables() {
  const container = document.getElementById('sales-price-tables');
  const emptyState = document.getElementById('sales-empty-state');
  const selectedInfo = document.getElementById('sales-selected-info');
  const selectedCount = document.getElementById('sales-selected-count');
  if (!container) return;
  if (selectedProducts.size === 0) {
    container.innerHTML = ''; emptyState.style.display = 'block'; selectedInfo.style.display = 'none'; return;
  }
  emptyState.style.display = 'none'; selectedInfo.style.display = 'flex';
  selectedCount.textContent = selectedProducts.size;
  const tables = [];
  selectedProducts.forEach(productName => {
    const product = sProducts.find(p => p.name === productName);
    if (!product) return;
    const productPrices = sPrices.filter(p => p.product === productName);
    if (productPrices.length === 0) {
      tables.push(`<div class="card sales-price-table-wrapper">
        <div class="sales-table-header">
          <div class="sales-table-title"><span>${product.icon||'üì¶'}</span><span>${product.name}</span></div>
          <div class="sales-table-meta"><span class="chip chip-gray">€∞ ŸÇ€åŸÖÿ™</span></div>
        </div>
        <div class="sales-table-content"><div class="empty" style="padding:40px;"><div class="empty-text">ŸáŸÜŸàÿ≤ ŸÇ€åŸÖÿ™€å ÿ´ÿ®ÿ™ ŸÜÿ¥ÿØŸá</div></div></div>
      </div>`);
      return;
    }
    const priceMap = {};
    productPrices.forEach(p => {
      const key = `${p.size}-${p.factory}`;
      if (!priceMap[key] || new Date(p.updatedAt) > new Date(priceMap[key].updatedAt)) priceMap[key] = p;
    });
    const latestPrices = Object.values(priceMap).sort((a,b) => new Date(b.updatedAt)-new Date(a.updatedAt));
    const avgPrice = Math.round(latestPrices.reduce((s,p) => s+p.price, 0) / latestPrices.length);
    const minPrice = Math.min(...latestPrices.map(p => p.price));
    const maxPrice = Math.max(...latestPrices.map(p => p.price));
    const rows = latestPrices.map(p => {
      const d = new Date(p.updatedAt);
      const dateStr = d.toLocaleDateString('fa-IR');
      const timeStr = d.toLocaleTimeString('fa-IR',{hour:'2-digit',minute:'2-digit'});
      let changeTxt = '<span class="change-flat">‚Äî</span>';
      if (p.prevPrice !== null && p.prevPrice !== undefined) {
        const diff = p.price - p.prevPrice;
        const pct = ((diff/p.prevPrice)*100).toFixed(1);
        if (diff > 0) changeTxt = `<span class="change-up">‚ñ≤ ${pct}%</span>`;
        else if (diff < 0) changeTxt = `<span class="change-down">‚ñº ${Math.abs(pct)}%</span>`;
        else changeTxt = '<span class="change-flat">ÿ®ÿØŸàŸÜ ÿ™ÿ∫€å€åÿ±</span>';
      }
      let priceStyle = '';
      if (latestPrices.length > 1) {
        if (p.price === minPrice) priceStyle = 'color:#059669;font-weight:900;';
        else if (p.price === maxPrice) priceStyle = 'color:#dc2626;font-weight:900;';
      }
      return `<tr>
        <td><strong>${p.size}</strong></td>
        <td>${p.factory}</td>
        <td><div class="price-cell" style="${priceStyle}">${Number(p.price).toLocaleString('fa-IR')}${p.price===minPrice&&latestPrices.length>1?' üü¢':''}${p.price===maxPrice&&latestPrices.length>1?' üî¥':''}</div><div class="price-unit">ÿ™ŸàŸÖÿßŸÜ / ⁄©€åŸÑŸà</div></td>
        <td>${changeTxt}</td>
        <td><div class="update-badge"><span class="date">${dateStr}</span><span>${timeStr}</span></div></td>
        <td style="max-width:140px;font-size:12px;color:var(--text-light);">${p.note||'‚Äî'}</td>
      </tr>`;
    }).join('');
    tables.push(`<div class="card sales-price-table-wrapper">
      <div class="sales-table-header">
        <div class="sales-table-title"><span>${product.icon||'üì¶'}</span><span>${product.name}</span></div>
        <div class="sales-table-meta"><span class="chip chip-green">${latestPrices.length} ŸÇ€åŸÖÿ™</span><span>ŸÖ€åÿßŸÜ⁄Ø€åŸÜ: ${avgPrice.toLocaleString('fa-IR')} ÿ™ŸàŸÖÿßŸÜ</span></div>
      </div>
      <div class="sales-table-content">
        <div class="table-wrap">
          <table class="data-table">
            <thead><tr><th>ÿ≥ÿß€åÿ≤</th><th>⁄©ÿßÿ±ÿÆÿßŸÜŸá</th><th>ŸÇ€åŸÖÿ™ (ÿ™ŸàŸÖÿßŸÜ/⁄©€åŸÑŸà)</th><th>ÿ™ÿ∫€å€åÿ±</th><th>ÿ¢ÿÆÿ±€åŸÜ ÿ¢ŸæÿØ€åÿ™</th><th>ÿ™Ÿàÿ∂€åÿ≠ÿßÿ™</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      </div>
    </div>`);
  });
  container.innerHTML = tables.join('');
}

// ‚ïê‚ïê‚ïê ANALYTICS ‚ïê‚ïê‚ïê
function setPeriod(days,el){
  sChartPeriod=days;
  document.querySelectorAll('.period-tab').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  const labels={7:'€∑ ÿ±Ÿàÿ≤ ⁄Øÿ∞ÿ¥ÿ™Ÿá',14:'€±€¥ ÿ±Ÿàÿ≤ ⁄Øÿ∞ÿ¥ÿ™Ÿá',30:'€≥€∞ ÿ±Ÿàÿ≤ ⁄Øÿ∞ÿ¥ÿ™Ÿá'};
  document.getElementById('chart-range-label').textContent=labels[days]||'';
  renderAnalytics();
}

let _trendChart,_pieChart,_barChart,_freqChart;

function renderAnalytics(){
  const filterProd=document.getElementById('chart-product-filter')?.value||'';
  const filterFact=document.getElementById('chart-factory-filter')?.value||'';
  let data=[...sPrices];
  if (filterProd) data=data.filter(p=>p.product===filterProd);
  if (filterFact) data=data.filter(p=>p.factory===filterFact);
  const days=sChartPeriod;
  const trendDates=[];const today=new Date();today.setHours(0,0,0,0);
  for (let i=days-1;i>=0;i--){const d=new Date(today);d.setDate(today.getDate()-i);trendDates.push(d);}
  const prods=[...new Set(data.map(p=>p.product))].slice(0,5);
  const palette=['#1e40af','#0891b2','#059669','#7c3aed','#d97706'];
  const trendDatasets=prods.map((prod,i)=>({
    label:prod,
    data:trendDates.map(d=>{const recs=data.filter(p=>p.product===prod&&new Date(p.updatedAt).toDateString()===d.toDateString());return recs.length?Math.round(recs.reduce((s,r)=>s+r.price,0)/recs.length):null;}),
    borderColor:palette[i%palette.length],backgroundColor:'transparent',tension:.4,pointRadius:4,pointBackgroundColor:palette[i%palette.length],spanGaps:true,borderWidth:2
  }));
  const trendLabels=trendDates.map(d=>d.toLocaleDateString('fa-IR',{month:'short',day:'numeric'}));
  const tCtx=document.getElementById('trendChart');
  if (_trendChart) _trendChart.destroy();
  _trendChart=new Chart(tCtx,{type:'line',data:{labels:trendLabels,datasets:trendDatasets.length?trendDatasets:[{label:'ÿ®ÿØŸàŸÜ ÿØÿßÿØŸá',data:[],borderColor:'#475569'}]},options:{responsive:true,plugins:{legend:{labels:{color:'#6b7280',font:{family:'Vazirmatn',size:12}}},tooltip:{callbacks:{label:ctx=>`${ctx.dataset.label}: ${Number(ctx.raw||0).toLocaleString('fa-IR')} ÿ™ŸàŸÖÿßŸÜ`}}},scales:{x:{ticks:{color:'#6b7280'},grid:{color:'#e5e7eb'}},y:{ticks:{color:'#6b7280',callback:v=>Number(v).toLocaleString('fa-IR')},grid:{color:'#e5e7eb'}}}}});
  const prodCounts={};data.forEach(p=>{prodCounts[p.product]=(prodCounts[p.product]||0)+1;});
  const pCtx=document.getElementById('productPieChart');
  if (_pieChart) _pieChart.destroy();
  _pieChart=new Chart(pCtx,{type:'doughnut',data:{labels:Object.keys(prodCounts),datasets:[{data:Object.values(prodCounts),backgroundColor:['#1e40af','#0891b2','#059669','#7c3aed','#d97706','#dc2626','#0e7490'],borderColor:'#ffffff',borderWidth:3}]},options:{responsive:true,cutout:'65%',plugins:{legend:{position:'bottom',labels:{color:'#6b7280',font:{family:'Vazirmatn',size:12},padding:14}},tooltip:{callbacks:{label:ctx=>`${ctx.label}: ${ctx.raw} ÿ±⁄©Ÿàÿ±ÿØ`}}}}});
  const factAvg={};data.forEach(p=>{if (!factAvg[p.factory]) factAvg[p.factory]={sum:0,cnt:0};factAvg[p.factory].sum+=p.price;factAvg[p.factory].cnt+=1;});
  const facLabels=Object.keys(factAvg);const facVals=facLabels.map(k=>Math.round(factAvg[k].sum/factAvg[k].cnt));
  const bCtx=document.getElementById('factoryBarChart');
  if (_barChart) _barChart.destroy();
  _barChart=new Chart(bCtx,{type:'bar',data:{labels:facLabels,datasets:[{label:'ŸÖ€åÿßŸÜ⁄Ø€åŸÜ ŸÇ€åŸÖÿ™ (ÿ™ŸàŸÖÿßŸÜ)',data:facVals,backgroundColor:'rgba(30,64,175,.75)',borderColor:'#1e40af',borderWidth:1,borderRadius:6}]},options:{responsive:true,indexAxis:'y',plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>`${Number(ctx.raw).toLocaleString('fa-IR')} ÿ™ŸàŸÖÿßŸÜ`}}},scales:{x:{ticks:{color:'#6b7280',callback:v=>Number(v).toLocaleString('fa-IR')},grid:{color:'#e5e7eb'}},y:{ticks:{color:'#6b7280'},grid:{color:'#e5e7eb'}}}}});
  const freqMap={};trendDates.forEach(d=>{freqMap[d.toDateString()]=0;});data.forEach(p=>{const ds=new Date(p.updatedAt).toDateString();if (freqMap[ds]!==undefined) freqMap[ds]++;});
  const fCtx=document.getElementById('updateFreqChart');
  if (_freqChart) _freqChart.destroy();
  _freqChart=new Chart(fCtx,{type:'bar',data:{labels:trendLabels,datasets:[{label:'ÿ¢ŸæÿØ€åÿ™',data:Object.values(freqMap),backgroundColor:'rgba(8,145,178,.7)',borderColor:'#0891b2',borderWidth:1,borderRadius:4}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#6b7280'},grid:{color:'#e5e7eb'}},y:{ticks:{color:'#6b7280',stepSize:1},grid:{color:'#e5e7eb'}}}}});
  const mmWrap=document.getElementById('minmax-table-wrap');
  if (data.length===0){mmWrap.innerHTML='<div class="empty"><div class="empty-icon">üìä</div><div class="empty-text">ÿØÿßÿØŸá‚Äåÿß€å ŸÖŸàÿ¨ŸàÿØ ŸÜ€åÿ≥ÿ™</div></div>';return;}
  const mmMap={};data.forEach(p=>{if (!mmMap[p.product]) mmMap[p.product]={min:Infinity,max:-Infinity,cnt:0};mmMap[p.product].min=Math.min(mmMap[p.product].min,p.price);mmMap[p.product].max=Math.max(mmMap[p.product].max,p.price);mmMap[p.product].cnt++;});
  mmWrap.innerHTML=`<table class="data-table"><thead><tr><th>ŸÖÿ≠ÿµŸàŸÑ</th><th>ÿ≠ÿØÿßŸÇŸÑ</th><th>ÿ≠ÿØÿß⁄©ÿ´ÿ±</th><th>ÿ±⁄©Ÿàÿ±ÿØ</th></tr></thead><tbody>${Object.entries(mmMap).map(([prod,v])=>`<tr><td>${prod}</td><td style="color:var(--success);font-weight:700;">${Number(v.min).toLocaleString('fa-IR')}</td><td style="color:var(--danger);font-weight:700;">${Number(v.max).toLocaleString('fa-IR')}</td><td><span class="chip chip-gray">${v.cnt}</span></td></tr>`).join('')}</tbody></table>`;
}

function sShowToast(msg,icon='‚úÖ'){
  const t=document.getElementById('s-toast');
  t.innerHTML=`<span>${icon}</span> ${msg}`;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),3200);
}

// ‚îÄ‚îÄ SUPPLY: Products export/import ‚îÄ‚îÄ
function exportProductsJSON() {
  jsonDownload({ type:'supply-products', exportDate:new Date().toISOString(), count:sProducts.length, products:sProducts },
    `ŸÖÿ≠ÿµŸàŸÑÿßÿ™-ÿ™ÿßŸÖ€åŸÜ-${new Date().toISOString().split('T')[0]}.json`);
}
function importProductsJSON(event) {
  readJSONFile(event, data => {
    let imported = [];
    if (Array.isArray(data)) imported = data;
    else if (Array.isArray(data.products)) imported = data.products;
    else { alert('‚ùå ŸÅÿ±ŸÖÿ™ Ÿæÿ¥ÿ™€åÿ®ÿßŸÜ€å ŸÜŸÖ€å‚Äåÿ¥ŸàÿØ'); return; }
    if (!confirm(`ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ${imported.length} ŸÖÿ≠ÿµŸàŸÑÿü`)) return;
    const existIds = new Set(sProducts.map(p=>p.id));
    let added=0, updated=0;
    imported.forEach(p => {
      if (existIds.has(p.id)) { const i=sProducts.findIndex(x=>x.id===p.id); sProducts[i]=p; updated++; }
      else { sProducts.push(p); added++; }
    });
    sPersist('products', sProducts);
    sRenderProductsGrid(); sUpdateDropdowns(); sUpdateStats();
    showImportToast(`‚úÖ ${added} ÿßÿ∂ÿßŸÅŸáÿå ${updated} ÿ®ÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å ‚Äî ŸÖÿ≠ÿµŸàŸÑÿßÿ™`);
  });
}

// ‚îÄ‚îÄ SUPPLY: Factories export/import ‚îÄ‚îÄ
function exportFactoriesJSON() {
  jsonDownload({ type:'supply-factories', exportDate:new Date().toISOString(), count:sFactories.length, factories:sFactories },
    `⁄©ÿßÿ±ÿÆÿßŸÜÿ¨ÿßÿ™-${new Date().toISOString().split('T')[0]}.json`);
}
function importFactoriesJSON(event) {
  readJSONFile(event, data => {
    let imported = [];
    if (Array.isArray(data)) imported = data;
    else if (Array.isArray(data.factories)) imported = data.factories;
    else { alert('‚ùå ŸÅÿ±ŸÖÿ™ Ÿæÿ¥ÿ™€åÿ®ÿßŸÜ€å ŸÜŸÖ€å‚Äåÿ¥ŸàÿØ'); return; }
    if (!confirm(`ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ${imported.length} ⁄©ÿßÿ±ÿÆÿßŸÜŸáÿü`)) return;
    const existIds = new Set(sFactories.map(f=>f.id));
    let added=0, updated=0;
    imported.forEach(f => {
      if (existIds.has(f.id)) { const i=sFactories.findIndex(x=>x.id===f.id); sFactories[i]=f; updated++; }
      else { sFactories.push(f); added++; }
    });
    sPersist('factories', sFactories);
    sRenderFactoriesGrid(); sUpdateDropdowns(); sUpdateStats();
    showImportToast(`‚úÖ ${added} ÿßÿ∂ÿßŸÅŸáÿå ${updated} ÿ®ÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å ‚Äî ⁄©ÿßÿ±ÿÆÿßŸÜÿ¨ÿßÿ™`);
  });
}

// ‚îÄ‚îÄ SUPPLY: Prices export/import ‚îÄ‚îÄ
function exportPricesJSON() {
  jsonDownload({ type:'supply-prices', exportDate:new Date().toISOString(), count:sPrices.length, prices:sPrices },
    `ŸÇ€åŸÖÿ™‚ÄåŸáÿß-${new Date().toISOString().split('T')[0]}.json`);
}
function importPricesJSON(event) {
  readJSONFile(event, data => {
    let imported = [];
    if (Array.isArray(data)) imported = data;
    else if (Array.isArray(data.prices)) imported = data.prices;
    // Support old data.json format: {supply:{prices:[...]}}
    else if (data.supply && Array.isArray(data.supply.prices)) imported = data.supply.prices;
    else { alert('‚ùå ŸÅÿ±ŸÖÿ™ Ÿæÿ¥ÿ™€åÿ®ÿßŸÜ€å ŸÜŸÖ€å‚Äåÿ¥ŸàÿØ'); return; }
    if (!confirm(`ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ${imported.length} ÿ±⁄©Ÿàÿ±ÿØ ŸÇ€åŸÖÿ™ÿü ÿ±⁄©Ÿàÿ±ÿØŸáÿß€å ÿ™⁄©ÿ±ÿßÿ±€å ÿ¨ÿß€å⁄Øÿ≤€åŸÜ ŸÖ€å‚Äåÿ¥ŸàŸÜÿØ.`)) return;
    const existIds = new Set(sPrices.map(p=>p.id));
    let added=0, updated=0;
    imported.forEach(p => {
      if (existIds.has(p.id)) { const i=sPrices.findIndex(x=>x.id===p.id); sPrices[i]=p; updated++; }
      else { sPrices.push(p); added++; }
    });
    sPersist('prices', sPrices);
    sRenderPriceTable(); sUpdateStats(); sUpdateDropdowns();
    showImportToast(`‚úÖ ${added} ÿßÿ∂ÿßŸÅŸáÿå ${updated} ÿ®ÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å ‚Äî ŸÇ€åŸÖÿ™‚ÄåŸáÿß`);
  });
}

</script>




<!-- LOADING SCRIPT -->
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOADING MODULE ‚Äî ÿ≠ŸàÿßŸÑŸá ÿÆÿ±€åÿØ / ŸÅÿ±Ÿàÿ¥ / ÿ®ÿßÿ±⁄Ø€åÿ±€å / ÿ¢ÿ±ÿ¥€åŸà
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let lDb = null, lFbOk = false;
try { lDb = firebase.database(); lFbOk = true; } catch(e) {}

let lData = { purchase: [], sale: [], loaded: [], archive: [] };

const CONTRACT_TYPES  = ['ÿ¨ÿßÿ±€å','ŸÅÿ±ÿß','ÿØŸÑÿßÿ±€å','ÿ™Ÿáÿßÿ™ÿ±'];
const DELIVERIES      = ['ÿØÿ±ÿ® ⁄©ÿßÿ±ÿÆÿßŸÜŸá','ÿØÿ±ÿ® ⁄©ÿßÿ±ÿÆÿßŸÜŸá ŸÖÿ¥ÿ™ÿ±€å','ŸÖÿ±ÿ≤','ŸÖÿßŸá€åÿ±ŸàÿØ','Ÿàÿ≤ŸÜ Ÿà ŸæŸàŸÑ'];
const SETTLEMENTS     = ['ÿ™Ÿáÿßÿ™ÿ±','ÿ™ÿ≥Ÿà€åŸá','LC','Ÿàÿ≤ŸÜ Ÿà ŸæŸàŸÑ','50ÿØÿ±ÿµÿØ ÿßÿ±ÿ®€åŸÑ'];

// ‚îÄ‚îÄ Firebase / localStorage ‚îÄ‚îÄ
function lInit() {
  const keys = ['purchase','sale','loaded','archive'];
  if (lFbOk) {
    keys.forEach(key => {
      lDb.ref('loading/' + key).on('value', snap => {
        lData[key] = snap.exists() ? Object.values(snap.val()).filter(Boolean) : [];
        lRender(key);
        lUpdateCount(key);
        if (activeModule === 'overview') setTimeout(ovRefresh, 100);
      });
    });
  } else {
    keys.forEach(key => {
      try { lData[key] = JSON.parse(localStorage.getItem('loading_' + key) || '[]'); } catch(e) { lData[key] = []; }
      lRender(key);
      lUpdateCount(key);
    });
  }
}

function lSave(key) {
  if (lFbOk) {
    const obj = {};
    lData[key].forEach(r => { obj[r.id] = r; });
    lDb.ref('loading/' + key).set(obj).catch(console.error);
  } else {
    localStorage.setItem('loading_' + key, JSON.stringify(lData[key]));
  }
  // Refresh nav overview badge
  setTimeout(()=>{ if(typeof navOvRefresh==='function') navOvRefresh(); }, 200);
}

// ‚îÄ‚îÄ Row factory ‚îÄ‚îÄ
function lNewRow(type) {
  return {
    id: Date.now().toString(36) + Math.random().toString(36).slice(2),
    type, contractNo:'', seller:'', location:'',
    contractType:'ÿ¨ÿßÿ±€å', description:'', delivery:'ÿØÿ±ÿ® ⁄©ÿßÿ±ÿÆÿßŸÜŸá',
    settlement:'ÿ™ÿ≥Ÿà€åŸá', qty:'', unitPrice:'', contractDate:'',
    status:'ÿØÿ± ÿßŸÜÿ™ÿ∏ÿßÿ±', commitment:'',
    loaded: false, driverName:'', driverInfo:'', waybill:'',
    loadQty:'', fromCity:'', toCity:'', distance:'',
    freightQuoted:'', freightActual:'', scale:'',
    loadedAt:'', archivedAt:'', createdAt: new Date().toISOString()
  };
}

function lAddRow(type) {
  const row = lNewRow(type);
  lData[type].push(row);
  lSave(type);
  lRender(type);
  lUpdateCount(type);
  // scroll to bottom of table
  setTimeout(() => {
    const el = document.getElementById(type + '-tbody');
    if (el) el.lastElementChild && el.lastElementChild.scrollIntoView({behavior:'smooth', block:'nearest'});
  }, 100);
}

function lDeleteRow(type, id) {
  if (!confirm('ÿ≠ÿ∞ŸÅ ÿß€åŸÜ ÿ±ÿØ€åŸÅÿü')) return;
  lData[type] = lData[type].filter(r => r.id !== id);
  lSave(type);
  lRender(type);
  lUpdateCount(type);
}

function lUpdateField(type, id, field, value) {
  const row = lData[type].find(r => String(r.id) === String(id));
  if (!row) return;
  row[field] = value;
  lSave(type);
}

// ‚îÄ‚îÄ Driver modal state ‚îÄ‚îÄ
let _driverPending = null;

function lMarkLoaded(type, id, checked) {
  const row = lData[type].find(r => String(r.id) === String(id));
  if (!row) return;
  if (!checked) return; // only move on check, not uncheck

  // Show driver modal instead of prompt
  _driverPending = { type, id: String(row.id) };
  document.getElementById('dm-driver-name').value = row.driverName || '';
  document.getElementById('dm-driver-info').value = row.driverInfo || '';
  document.getElementById('dm-loaded-at').value = row.loadedAt || new Date().toLocaleDateString('fa-IR');
  document.getElementById('driver-modal-subtitle').textContent =
    (type === 'purchase' ? 'üì• ÿ≠ŸàÿßŸÑŸá ÿÆÿ±€åÿØ' : 'üì§ ÿ≠ŸàÿßŸÑŸá ŸÅÿ±Ÿàÿ¥') + ' ‚Äî ' + (row.contractNo || 'ÿ®ÿØŸàŸÜ ÿ¥ŸÖÿßÿ±Ÿá') + ' ‚Äî ' + (row.seller || '');
  document.getElementById('driver-modal').style.display = 'block';
  setTimeout(() => document.getElementById('dm-driver-name').focus(), 100);
}

function driverModalConfirm() {
  if (!_driverPending) return;
  const { type, id } = _driverPending;
  const row = lData[type].find(r => String(r.id) === String(id));
  if (!row) { driverModalCancel(); return; }

  const driverName    = document.getElementById('dm-driver-name').value.trim();
  const driverInfo    = document.getElementById('dm-driver-info').value.trim();
  const waybill       = document.getElementById('dm-waybill').value.trim();
  const loadQtyKg     = parseFloat(document.getElementById('dm-load-qty').value) || 0;
  const fromCity      = document.getElementById('dm-from-city').value.trim();
  const toCity        = document.getElementById('dm-to-city').value.trim();
  const distance      = document.getElementById('dm-distance').value.trim();
  const freightQuoted = document.getElementById('dm-freight-quoted').value.trim();
  const freightActual = document.getElementById('dm-freight-actual').value.trim();
  const scale         = document.getElementById('dm-scale').value.trim();
  const dmStatus      = document.getElementById('dm-status').value;
  const loadedAt      = document.getElementById('dm-loaded-at').value.trim() || new Date().toLocaleDateString('fa-IR');

  // Subtract loadQtyKg (kg) from contract qty (tons)
  const loadQtyTon = loadQtyKg / 1000;
  const currentQty = parseFloat(row.qty) || 0;
  const newQty = Math.max(0, currentQty - loadQtyTon);

  const moved = { ...row, loaded: true, driverName, driverInfo, waybill,
    loadQty: loadQtyKg, fromCity, toCity, distance,
    freightQuoted, freightActual, scale, status: dmStatus, loadedAt };

  // Update remaining qty in original contract
  if (newQty <= 0) {
    // Fully loaded - remove from contracts
    lData[type] = lData[type].filter(r => r.id !== row.id);
  } else {
    // Partial - update qty
    const idx = lData[type].findIndex(r => r.id === row.id);
    if (idx >= 0) { lData[type][idx].qty = newQty.toFixed(3); lData[type][idx].loaded = false; }
  }
  lData.loaded.push(moved);
  lData[type] = lData[type].filter(r => r.id !== row.id);
  lSave(type);
  lSave('loaded');
  lRender(type);
  lRender('loaded');
  lUpdateCount(type);
  lUpdateCount('loaded');
  driverModalCancel();
  sShowToast('‚úÖ ŸÖŸÜÿ™ŸÇŸÑ ÿ®Ÿá ÿ®ÿßÿ±⁄Ø€åÿ±€å ÿ¥ÿØŸá‚ÄåŸáÿß', 'üöõ');
}

function driverModalCancel() {
  document.getElementById('driver-modal').style.display = 'none';
  _driverPending = null;
  // Uncheck the checkbox visually if cancelled
  document.querySelectorAll('.ltable td input[type=checkbox]:checked').forEach(cb => {
    // Only uncheck if in purchase/sale table (not loaded)
    const tbody = cb.closest('tbody');
    if (tbody && (tbody.id === 'purchase-tbody' || tbody.id === 'sale-tbody')) {
      const rowEl = cb.closest('tr');
      if (rowEl && rowEl.classList.contains('row-pending')) cb.checked = false;
    }
  });
}

function lArchiveRow(id) {
  const row = lData.loaded.find(r => String(r.id) === String(id));
  if (!row || !confirm('ÿ¢ÿ±ÿ¥€åŸà ÿß€åŸÜ ÿ±ÿØ€åŸÅÿü')) return;
  const archived = { ...row, archivedAt: new Date().toLocaleDateString('fa-IR') };
  lData.archive.push(archived);
  lData.loaded = lData.loaded.filter(r => r.id !== row.id);
  lSave('loaded');
  lSave('archive');
  lRender('loaded');
  lRender('archive');
  lUpdateCount('loaded');
  lUpdateCount('archive');
  sShowToast('‚úÖ ÿ¢ÿ±ÿ¥€åŸà ÿ¥ÿØ', 'üóÑÔ∏è');
}

function lUpdateCount(key) {
  const el = document.getElementById(key + '-count');
  if (el) el.textContent = lData[key].length + ' ÿ±ÿØ€åŸÅ';
}

// ‚îÄ‚îÄ Safe HTML helpers ‚îÄ‚îÄ
function esc(v) {
  return String(v || '').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function cellInput(type, row, field, placeholder, extraStyle) {
  const id = String(row.id).replace(/\./g,'_');
  return `<input type="text" 
    value="${esc(row[field])}" 
    placeholder="${esc(placeholder)}" 
    style="${extraStyle||''}" 
    onchange="lUpdateField('${type}','${row.id}','${field}',this.value)">`;
}

function numInput(type, row, field, placeholder) {
  const id = String(row.id).replace(/\./g,'_');
  return `<input type="text" inputmode="numeric"
    value="${esc(row[field])}"
    placeholder="${esc(placeholder)}"
    style="min-width:80px;text-align:left;direction:ltr;"
    onchange="lUpdateField('${type}','${row.id}','${field}',this.value)">`;
}

function selectInput(type, row, field, options) {
  const opts = options.map(o => `<option value="${esc(o)}"${row[field]===o?' selected':''}>${esc(o)}</option>`).join('');
  return `<select onchange="lUpdateField('${type}','${row.id}','${field}',this.value)">${opts}</select>`;
}

function typeBadge(type) {
  return type === 'purchase'
    ? '<span style="background:#dbeafe;color:#1e40af;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:700;">ÿÆÿ±€åÿØ</span>'
    : '<span style="background:#fef3c7;color:#d97706;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:700;">ŸÅÿ±Ÿàÿ¥</span>';
}

// ‚îÄ‚îÄ Render ‚îÄ‚îÄ
function lRender(key) {
  if (key === 'purchase' || key === 'sale') {
    const tbody = document.getElementById(key + '-tbody');
    if (!tbody) return;
    const rows = lData[key];
    if (!rows.length) {
      tbody.innerHTML = `<tr><td colspan="12" style="text-align:center;padding:30px;color:#9ca3af;">ÿ±ÿØ€åŸÅ€å Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ±ÿØ ‚Äî ÿßÿ≤ ÿØ⁄©ŸÖŸá ‚ûï ÿ±ÿØ€åŸÅ ÿ¨ÿØ€åÿØ ÿßÿ∂ÿßŸÅŸá ⁄©ŸÜ€åÿØ</td></tr>`;
      return;
    }
    const statusOpts = ['ÿØÿ± ÿßŸÜÿ™ÿ∏ÿßÿ±','ÿØÿ± ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ™ÿ≥Ÿà€åŸá','ÿßÿπŸÑÿßŸÖ ÿ®ÿßÿ±','ÿØÿ± ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ®ÿßÿ≥⁄©ŸàŸÑ','ÿØÿ± ŸÖÿ≥€åÿ±','ÿ™ÿ≠Ÿà€åŸÑ ÿØÿßÿØŸá ÿ¥ÿØŸá','ÿ®ÿßÿ±⁄Ø€åÿ±€å ÿ¥ÿØŸá'];
    tbody.innerHTML = rows.map((row, i) => {
      const qtyNum = parseFloat(row.qty)||0;
      const qtyClass = qtyNum <= 0 ? 'qty-danger' : qtyNum < 50 ? 'qty-danger' : 'qty-ok';
      const commitCell = key==='purchase' ? `<td>${numInput(key, row, 'commitment', 'ÿ™ÿπŸáÿØ')}</td>` : '';
      return `<tr class="${row.loaded ? 'row-loaded-check' : 'row-pending'}">
      <td style="text-align:center;color:#9ca3af;font-size:11px;">${i+1}</td>
      <td>${cellInput(key, row, 'contractNo', 'ÿ¥ŸÖÿßÿ±Ÿá ŸÇÿ±ÿßÿ±ÿØÿßÿØ', 'min-width:100px;')}</td>
      <td>${cellInput(key, row, 'seller', key==='purchase'?'ŸÅÿ±Ÿàÿ¥ŸÜÿØŸá':'ÿÆÿ±€åÿØÿßÿ±', 'min-width:100px;')}</td>
      <td>${cellInput(key, row, 'location', 'ŸÖÿ≠ŸÑ ÿ®ÿßÿ±⁄Ø€åÿ±€å', 'min-width:90px;')}</td>
      <td>${selectInput(key, row, 'contractType', CONTRACT_TYPES)}</td>
      <td>${cellInput(key, row, 'description', 'ÿ¥ÿ±ÿ≠/ŸÖÿ≠ÿµŸàŸÑ', 'min-width:90px;')}</td>
      <td>${selectInput(key, row, 'delivery', DELIVERIES)}</td>
      <td>${selectInput(key, row, 'settlement', SETTLEMENTS)}</td>
      <td><div>${numInput(key, row, 'qty', 'ŸÖÿßŸÜÿØŸá (ÿ™ŸÜ)')}</div><div class="qty-remaining ${qtyClass}">${qtyNum.toFixed(2)} ÿ™ŸÜ</div></td>
      ${commitCell}
      <td>${numInput(key, row, 'unitPrice', 'ŸÖÿ®ŸÑÿ∫')}</td>
      <td>${cellInput(key, row, 'contractDate', 'ÿ™ÿßÿ±€åÿÆ', 'min-width:100px;')}</td>
      <td>${selectInput(key, row, 'status', statusOpts)}</td>
      <td style="text-align:center;">
        <input type="checkbox" ${row.loaded?'checked':''}
          style="width:18px;height:18px;cursor:pointer;"
          onchange="lMarkLoaded('${key}','${row.id}',this.checked)">
      </td>
      <td><button class="del-btn" onclick="lDeleteRow('${key}','${row.id}')">üóëÔ∏è</button></td>
    </tr>`;}).join('');
  }

  if (key === 'loaded') {
    const tbody = document.getElementById('loaded-tbody');
    if (!tbody) return;
    const rows = lData.loaded;
    if (!rows.length) {
      tbody.innerHTML = `<tr><td colspan="12" style="text-align:center;padding:30px;color:#9ca3af;">Ÿá€å⁄Ü ÿ®ÿßÿ±⁄Ø€åÿ±€å‚Äåÿß€å ŸáŸÜŸàÿ≤ ÿ´ÿ®ÿ™ ŸÜÿ¥ÿØŸá</td></tr>`;
      return;
    }
    const lStatusOpts = ['ÿØÿ± ÿßŸÜÿ™ÿ∏ÿßÿ±','ÿØÿ± ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ™ÿ≥Ÿà€åŸá','ÿßÿπŸÑÿßŸÖ ÿ®ÿßÿ±','ÿØÿ± ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ®ÿßÿ≥⁄©ŸàŸÑ','ÿØÿ± ŸÖÿ≥€åÿ±','ÿ™ÿ≠Ÿà€åŸÑ ÿØÿßÿØŸá ÿ¥ÿØŸá','ÿ®ÿßÿ±⁄Ø€åÿ±€å ÿ¥ÿØŸá'];
    tbody.innerHTML = rows.map((row, i) => `<tr>
      <td style="text-align:center;color:#9ca3af;font-size:11px;">${i+1}</td>
      <td>${typeBadge(row.type)}</td>
      <td>${cellInput('loaded', row, 'contractNo', 'ÿ¥ŸÖÿßÿ±Ÿá','min-width:90px;')}</td>
      <td>${cellInput('loaded', row, 'seller', 'ŸÅÿ±Ÿàÿ¥ŸÜÿØŸá/ÿÆÿ±€åÿØÿßÿ±','min-width:90px;')}</td>
      <td>${cellInput('loaded', row, 'location', 'ŸÖÿ≠ŸÑ','min-width:80px;')}</td>
      <td>${cellInput('loaded', row, 'description', 'ÿ¥ÿ±ÿ≠','min-width:80px;')}</td>
      <td>${numInput('loaded', row, 'loadQty', 'ŸÖŸÇÿØÿßÿ± kg')}</td>
      <td>${numInput('loaded', row, 'unitPrice', 'ŸÖÿ®ŸÑÿ∫')}</td>
      <td>${cellInput('loaded', row, 'driverName', 'ÿ±ÿßŸÜŸÜÿØŸá','min-width:90px;')}</td>
      <td>${cellInput('loaded', row, 'driverInfo', 'ŸÖÿ¥ÿÆÿµÿßÿ™','min-width:90px;')}</td>
      <td>${cellInput('loaded', row, 'waybill', 'ÿ®ÿßÿ±ŸÜÿßŸÖŸá','min-width:80px;')}</td>
      <td>${cellInput('loaded', row, 'fromCity', 'ŸÖÿ®ÿØÿß','min-width:70px;')}</td>
      <td>${cellInput('loaded', row, 'toCity', 'ŸÖŸÇÿµÿØ','min-width:70px;')}</td>
      <td>${numInput('loaded', row, 'distance', 'km')}</td>
      <td><input type="text" value="${esc(row.freightQuoted||'')}" readonly style="min-width:80px;background:#f9fafb;direction:ltr;padding:5px 7px;border:1.5px solid #e5e7eb;border-radius:6px;"></td>
      <td>${numInput('loaded', row, 'freightActual', '⁄©ÿ±ÿß€åŸá')}</td>
      <td>${cellInput('loaded', row, 'scale', 'ÿ®ÿßÿ≥⁄©ŸàŸÑ','min-width:70px;')}</td>
      <td>${selectInput('loaded', row, 'status', lStatusOpts)}</td>
      <td>${cellInput('loaded', row, 'loadedAt', 'ÿ™ÿßÿ±€åÿÆ','min-width:90px;')}</td>
      <td><button class="arch-btn" onclick="lArchiveRow('${row.id}')">üóÑÔ∏è</button></td>
      <td><button class="del-btn" onclick="lDeleteRow('loaded','${row.id}')">üóëÔ∏è</button></td>
    </tr>`).join('');
  }

  if (key === 'archive') {
    const tbody = document.getElementById('archive-tbody');
    if (!tbody) return;
    const rows = lData.archive;
    if (!rows.length) {
      tbody.innerHTML = `<tr><td colspan="12" style="text-align:center;padding:30px;color:#9ca3af;">ÿ¢ÿ±ÿ¥€åŸà€å Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ±ÿØ</td></tr>`;
      return;
    }
    tbody.innerHTML = rows.map((row, i) => `<tr>
      <td style="text-align:center;color:#9ca3af;font-size:11px;">${i+1}</td>
      <td>${typeBadge(row.type)}</td>
      <td>${esc(row.contractNo)||'‚Äî'}</td>
      <td>${esc(row.seller)||'‚Äî'}</td>
      <td>${esc(row.location)||'‚Äî'}</td>
      <td>${esc(row.description)||'‚Äî'}</td>
      <td style="direction:ltr;">${esc(row.loadQty||row.qty)||'‚Äî'} kg</td>
      <td style="direction:ltr;">${esc(row.unitPrice)||'‚Äî'}</td>
      <td>${esc(row.driverName)||'‚Äî'}</td>
      <td>${esc(row.waybill)||'‚Äî'}</td>
      <td>${esc(row.fromCity||'')}${row.fromCity&&row.toCity?' ‚Üí ':''}${esc(row.toCity||'')||'‚Äî'}</td>
      <td style="direction:ltr;">${esc(row.freightActual)||'‚Äî'}</td>
      <td>${esc(row.status)||'‚Äî'}</td>
      <td>${esc(row.loadedAt)||'‚Äî'}</td>
      <td>${esc(row.archivedAt)||'‚Äî'}</td>
      <td><button class="del-btn" onclick="lDeleteRow('archive','${row.id}')">üóëÔ∏è</button></td>
    </tr>`).join('');
  }
}

function lTab(key, el) {
  document.querySelectorAll('.loading-section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.loading-tab').forEach(b => b.classList.remove('active'));
  document.getElementById('loading-' + key).classList.add('active');
  el.classList.add('active');
}

// ‚îÄ‚îÄ Excel Export ‚îÄ‚îÄ
function lExportExcel(key) {
  const data = lData[key];
  if (!data.length) { sShowToast('ÿØÿßÿØŸá‚Äåÿß€å Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ±ÿØ', '‚ö†Ô∏è'); return; }
  const wb = XLSX.utils.book_new();
  const sheetNames = { purchase:'ÿ≠ŸàÿßŸÑŸá ÿÆÿ±€åÿØ', sale:'ÿ≠ŸàÿßŸÑŸá ŸÅÿ±Ÿàÿ¥', loaded:'ÿ®ÿßÿ±⁄Ø€åÿ±€å ÿ¥ÿØŸá', archive:'ÿ¢ÿ±ÿ¥€åŸà' };
  const fileNames  = { purchase:'ÿ≠ŸàÿßŸÑŸá-ÿÆÿ±€åÿØ', sale:'ÿ≠ŸàÿßŸÑŸá-ŸÅÿ±Ÿàÿ¥', loaded:'ÿ®ÿßÿ±⁄Ø€åÿ±€å-ÿ¥ÿØŸá', archive:'ÿ¢ÿ±ÿ¥€åŸà' };

  let headers, rows;
  if (key === 'purchase' || key === 'sale') {
    headers = ['#','ÿ¥ŸÖÿßÿ±Ÿá ŸÇÿ±ÿßÿ±ÿØÿßÿØ','ŸÅÿ±Ÿàÿ¥ŸÜÿØŸá','ŸÖÿ≠ŸÑ ÿ®ÿßÿ±⁄Ø€åÿ±€å','ŸÜŸàÿπ ŸÇÿ±ÿßÿ±ÿØÿßÿØ','ÿ¥ÿ±ÿ≠','ŸÜÿ≠ŸàŸá ÿ™ÿ≠Ÿà€åŸÑ','ŸÜÿ≠ŸàŸá ÿ™ÿ≥Ÿà€åŸá','ŸÖŸÇÿØÿßÿ± KG','ŸÖÿ®ŸÑÿ∫ Ÿàÿßÿ≠ÿØ','ÿ™ÿßÿ±€åÿÆ','Ÿàÿ∂ÿπ€åÿ™'];
    rows = data.map((r,i) => [i+1, r.contractNo, r.seller, r.location, r.contractType, r.description, r.delivery, r.settlement, r.qty, r.unitPrice, r.contractDate||'', r.loaded?'ÿ®ÿßÿ±⁄Ø€åÿ±€å ÿ¥ÿØ':'ÿØÿ± ÿßŸÜÿ™ÿ∏ÿßÿ±']);
  } else if (key === 'loaded') {
    headers = ['#','ŸÜŸàÿπ','ÿ¥ŸÖÿßÿ±Ÿá ŸÇÿ±ÿßÿ±ÿØÿßÿØ','ŸÅÿ±Ÿàÿ¥ŸÜÿØŸá/ÿÆÿ±€åÿØÿßÿ±','ŸÖÿ≠ŸÑ ÿ®ÿßÿ±⁄Ø€åÿ±€å','ÿ¥ÿ±ÿ≠','ŸÖŸÇÿØÿßÿ± ÿ®ÿßÿ±⁄Ø€åÿ±€å (kg)','ŸÖÿ®ŸÑÿ∫','ÿ±ÿßŸÜŸÜÿØŸá','ÿ¥ŸÖÿßÿ±Ÿá ÿ®ÿßÿ±ŸÜÿßŸÖŸá','ŸÖÿ®ÿØÿß','ŸÖŸÇÿµÿØ','ŸÖÿ≥ÿßŸÅÿ™','⁄©ÿ±ÿß€åŸá ÿßÿ≥ÿ™ÿπŸÑÿßŸÖ€å','⁄©ÿ±ÿß€åŸá ŸàÿßŸÇÿπ€å','ÿ®ÿßÿ≥⁄©ŸàŸÑ','Ÿàÿ∂ÿπ€åÿ™','ÿ™ÿßÿ±€åÿÆ'];
    rows = data.map((r,i) => [i+1, r.type==='purchase'?'ÿÆÿ±€åÿØ':'ŸÅÿ±Ÿàÿ¥', r.contractNo, r.seller, r.location, r.description, r.loadQty||r.qty, r.unitPrice, r.driverName, r.waybill, r.fromCity, r.toCity, r.distance, r.freightQuoted, r.freightActual, r.scale, r.status, r.loadedAt]);
  } else {
    headers = ['#','ŸÜŸàÿπ','ÿ¥ŸÖÿßÿ±Ÿá ŸÇÿ±ÿßÿ±ÿØÿßÿØ','ŸÅÿ±Ÿàÿ¥ŸÜÿØŸá','ŸÖÿ≠ŸÑ ÿ®ÿßÿ±⁄Ø€åÿ±€å','ÿ¥ÿ±ÿ≠','ŸÖŸÇÿØÿßÿ± KG','ŸÖÿ®ŸÑÿ∫ Ÿàÿßÿ≠ÿØ','ŸÜÿßŸÖ ÿ±ÿßŸÜŸÜÿØŸá','ÿ¥ŸÖÿßÿ±Ÿá/ŸÖÿ¥ÿÆÿµÿßÿ™','ÿ™ÿßÿ±€åÿÆ ÿ®ÿßÿ±⁄Ø€åÿ±€å','ÿ™ÿßÿ±€åÿÆ ÿ¢ÿ±ÿ¥€åŸà'];
    rows = data.map((r,i) => [i+1, r.type==='purchase'?'ÿÆÿ±€åÿØ':'ŸÅÿ±Ÿàÿ¥', r.contractNo, r.seller, r.location, r.description, r.qty, r.unitPrice, r.driverName, r.driverInfo, r.loadedAt, r.archivedAt]);
  }

  // Style header row
  const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
  ws['!cols'] = headers.map((_,i) => ({ wch: i===0 ? 5 : 18 }));
  const range = XLSX.utils.decode_range(ws['!ref']);
  for (let C = range.s.c; C <= range.e.c; C++) {
    const cell = XLSX.utils.encode_cell({r:0, c:C});
    if (!ws[cell]) continue;
    ws[cell].s = {
      font: {bold:true, color:{rgb:'FFFFFF'}, name:'Arial', sz:11},
      fill: {fgColor:{rgb: key==='purchase'?'1E40AF': key==='sale'?'D97706': key==='loaded'?'059669':'6B7280'}, patternType:'solid'},
      alignment: {horizontal:'center', vertical:'center'}
    };
  }
  XLSX.utils.book_append_sheet(wb, ws, sheetNames[key]);
  XLSX.writeFile(wb, fileNames[key] + '-' + new Date().toISOString().split('T')[0] + '.xlsx');
  sShowToast('‚úÖ ÿß⁄©ÿ≥ŸÑ ÿØÿßŸÜŸÑŸàÿØ ÿ¥ÿØ', 'üìä');
}

// ‚îÄ‚îÄ JSON Export ‚îÄ‚îÄ
function lExportJSON(key) {
  if (!lData[key].length) { sShowToast('ÿØÿßÿØŸá‚Äåÿß€å Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ±ÿØ', '‚ö†Ô∏è'); return; }
  jsonDownload({ type:'loading-'+key, exportDate:new Date().toISOString(), count:lData[key].length, data:lData[key] },
    'loading-' + key + '-' + new Date().toISOString().split('T')[0] + '.json');
  sShowToast('‚úÖ JSON ÿØÿßŸÜŸÑŸàÿØ ÿ¥ÿØ', 'üì•');
}

// ‚îÄ‚îÄ JSON Import ‚îÄ‚îÄ
function lImportJSON(event, key) {
  readJSONFile(event, imported => {
    let rows = [];
    if (Array.isArray(imported)) rows = imported;
    else if (Array.isArray(imported.data)) rows = imported.data;
    else { alert('‚ùå ŸÅÿ±ŸÖÿ™ Ÿæÿ¥ÿ™€åÿ®ÿßŸÜ€å ŸÜŸÖ€å‚Äåÿ¥ŸàÿØ'); return; }
    if (!confirm('ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ' + rows.length + ' ÿ±ÿØ€åŸÅÿü')) return;
    const existIds = new Set(lData[key].map(r => r.id));
    let added = 0, updated = 0;
    rows.forEach(r => {
      if (existIds.has(r.id)) { const i = lData[key].findIndex(x => x.id === r.id); lData[key][i] = r; updated++; }
      else { lData[key].push(r); added++; }
    });
    lSave(key);
    lRender(key);
    lUpdateCount(key);
    sShowToast('‚úÖ ' + added + ' ÿßÿ∂ÿßŸÅŸáÿå ' + updated + ' ÿ®ÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å', 'üìÇ');
  });
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WAREHOUSE MODULE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let whDb = null, whFbOk = false;
try { whDb = firebase.database(); whFbOk = true; } catch(e) {}
let whProducts = []; // [{id, name, qty (tons), commitment}]

function whInit() {
  if (whFbOk) {
    whDb.ref('warehouse').on('value', snap => {
      whProducts = snap.exists() ? Object.values(snap.val()).filter(Boolean) : [];
      whRenderGrid();
    });
  } else {
    try { whProducts = JSON.parse(localStorage.getItem('wh_products')||'[]'); } catch(e){ whProducts=[]; }
    whRenderGrid();
  }
}

function whSave() {
  if (whFbOk) {
    const obj = {};
    whProducts.forEach(p => { obj[p.id] = p; });
    whDb.ref('warehouse').set(obj).catch(console.error);
  } else {
    localStorage.setItem('wh_products', JSON.stringify(whProducts));
  }
}

function whAddProduct() {
  const name = document.getElementById('wh-new-name').value.trim();
  const qty  = parseFloat(document.getElementById('wh-new-qty').value) || 0;
  if (!name) { sShowToast('ŸÜÿßŸÖ ŸÖÿ≠ÿµŸàŸÑ ÿßŸÑÿ≤ÿßŸÖ€å ÿßÿ≥ÿ™', '‚ö†Ô∏è'); return; }
  const existing = whProducts.find(p => p.name === name);
  if (existing) {
    existing.qty = (parseFloat(existing.qty)||0) + qty;
    whSave(); whRenderGrid();
    sShowToast('‚úÖ ŸÖŸàÿ¨ŸàÿØ€å ÿ®ÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å ÿ¥ÿØ', 'üì¶');
  } else {
    whProducts.push({ id: Date.now().toString(36)+Math.random().toString(36).slice(2), name, qty, commitment:0 });
    whSave(); whRenderGrid();
    sShowToast('‚úÖ ŸÖÿ≠ÿµŸàŸÑ ÿßÿ∂ÿßŸÅŸá ÿ¥ÿØ', 'üì¶');
  }
  document.getElementById('wh-new-name').value = '';
  document.getElementById('wh-new-qty').value = '';
}

function whAddFromContract(productName, qtyTon) {
  // Called when a purchase contract is saved
  const existing = whProducts.find(p => p.name === productName);
  if (existing) {
    existing.qty = (parseFloat(existing.qty)||0) + parseFloat(qtyTon||0);
    whSave();
  } else {
    whProducts.push({ id: Date.now().toString(36)+Math.random().toString(36).slice(2), name:productName, qty:parseFloat(qtyTon||0), commitment:0 });
    whSave();
  }
}

function whCheckSaleCommitment(productName, qtyTon) {
  // Returns true if warehouse has enough, false + marks commitment if not
  const existing = whProducts.find(p => p.name === productName);
  const available = existing ? (parseFloat(existing.qty)||0) : 0;
  return available >= parseFloat(qtyTon||0);
}

function whRenderGrid() {
  const grid = document.getElementById('wh-grid');
  if (!grid) return;
  if (!whProducts.length) {
    grid.innerHTML = '<div class="empty"><div class="empty-icon">üì¶</div><div class="empty-text">ÿßŸÜÿ®ÿßÿ±€å ÿ´ÿ®ÿ™ ŸÜÿ¥ÿØŸá</div></div>';
    return;
  }
  grid.innerHTML = whProducts.map(p => {
    const qty = parseFloat(p.qty)||0;
    const commitment = parseFloat(p.commitment)||0;
    const available = qty - commitment;
    const pct = qty > 0 ? Math.min(100, (available/qty)*100) : 0;
    const avClass = available < 0 ? 'qty-danger' : available < 10 ? 'qty-danger' : 'qty-ok';
    return `<div class="wh-card">
      <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px;">
        <div class="wh-card-name">üì¶ ${esc(p.name)}</div>
        <button class="del-btn" style="font-size:12px;" onclick="whDeleteProduct('${p.id}')">üóëÔ∏è</button>
      </div>
      <div class="wh-card-qty">${qty.toFixed(2)}<span class="wh-card-unit"> ÿ™ŸÜ ŸÖŸàÿ¨ŸàÿØ€å ⁄©ŸÑ</span></div>
      ${commitment > 0 ? `<div class="wh-card-commitment">‚ö†Ô∏è ${commitment.toFixed(2)} ÿ™ŸÜ ÿ™ÿπŸáÿØ ÿÆÿ±€åÿØ</div>` : ''}
      <div class="wh-progress"><div class="wh-progress-bar" style="width:${pct}%"></div></div>
      <div class="${avClass}" style="font-size:13px;margin-top:6px;font-weight:700;">${available.toFixed(2)} ÿ™ŸÜ ŸÇÿßÿ®ŸÑ ÿ™ÿ≠Ÿà€åŸÑ</div>
      <div style="margin-top:10px;display:flex;gap:8px;">
        <input type="text" inputmode="numeric" placeholder="ÿßŸÅÿ≤ŸàÿØŸÜ (ÿ™ŸÜ)" style="flex:1;padding:6px 8px;border:1.5px solid #e5e7eb;border-radius:7px;font-family:'Vazirmatn',sans-serif;font-size:12px;direction:ltr;" id="wh-add-${p.id}">
        <button class="btn btn-success" style="padding:6px 12px;font-size:12px;" onclick="whAdjust('${p.id}',1)">+</button>
        <button class="btn btn-warning" style="padding:6px 12px;font-size:12px;" onclick="whAdjust('${p.id}',-1)">‚àí</button>
      </div>
    </div>`;
  }).join('');
}

function whAdjust(id, sign) {
  const p = whProducts.find(x => x.id === id);
  if (!p) return;
  const val = parseFloat(document.getElementById('wh-add-'+id).value) || 0;
  p.qty = Math.max(0, (parseFloat(p.qty)||0) + sign*val);
  whSave(); whRenderGrid();
}

function whDeleteProduct(id) {
  if (!confirm('ÿ≠ÿ∞ŸÅ ÿß€åŸÜ ŸÖÿ≠ÿµŸàŸÑ ÿßÿ≤ ÿßŸÜÿ®ÿßÿ±ÿü')) return;
  whProducts = whProducts.filter(p => p.id !== id);
  whSave(); whRenderGrid();
}

function whExportExcel() {
  if (!whProducts.length) { sShowToast('ÿßŸÜÿ®ÿßÿ±€å ÿ´ÿ®ÿ™ ŸÜÿ¥ÿØŸá', '‚ö†Ô∏è'); return; }
  const wb = XLSX.utils.book_new();
  const headers = ['ŸÜÿßŸÖ ŸÖÿ≠ÿµŸàŸÑ','ŸÖŸàÿ¨ŸàÿØ€å ⁄©ŸÑ (ÿ™ŸÜ)','ÿ™ÿπŸáÿØ ÿÆÿ±€åÿØ (ÿ™ŸÜ)','ŸÇÿßÿ®ŸÑ ÿ™ÿ≠Ÿà€åŸÑ (ÿ™ŸÜ)'];
  const rows = whProducts.map(p => {
    const qty = parseFloat(p.qty)||0;
    const com = parseFloat(p.commitment)||0;
    return [p.name, qty.toFixed(2), com.toFixed(2), (qty-com).toFixed(2)];
  });
  const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
  ws['!cols'] = [25,18,18,18].map(w=>({wch:w}));
  XLSX.utils.book_append_sheet(wb, ws, 'ÿßŸÜÿ®ÿßÿ±');
  XLSX.writeFile(wb, 'ÿßŸÜÿ®ÿßÿ±-'+new Date().toISOString().split('T')[0]+'.xlsx');
  sShowToast('‚úÖ ÿß⁄©ÿ≥ŸÑ ÿØÿßŸÜŸÑŸàÿØ ÿ¥ÿØ', 'üìä');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FREIGHT MODULE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let frDb = null, frFbOk = false;
try { frDb = firebase.database(); frFbOk = true; } catch(e) {}
let frRates = []; // [{id, from, to, distance, rate}]

function frInit() {
  if (frFbOk) {
    frDb.ref('freight').on('value', snap => {
      frRates = snap.exists() ? Object.values(snap.val()).filter(Boolean) : [];
      frRender();
    });
  } else {
    try { frRates = JSON.parse(localStorage.getItem('fr_rates')||'[]'); } catch(e){ frRates=[]; }
    frRender();
  }
}

function frSave() {
  if (frFbOk) {
    const obj = {};
    frRates.forEach(r => { obj[r.id] = r; });
    frDb.ref('freight').set(obj).catch(console.error);
  } else {
    localStorage.setItem('fr_rates', JSON.stringify(frRates));
  }
}

function frAdd() {
  const from = document.getElementById('fr-from').value.trim();
  const to   = document.getElementById('fr-to').value.trim();
  const dist = document.getElementById('fr-dist').value.trim();
  const rate = document.getElementById('fr-rate').value.trim();
  if (!from || !to || !rate) { sShowToast('ŸÖÿ®ÿØÿßÿå ŸÖŸÇÿµÿØ Ÿà ŸÜÿ±ÿÆ ÿßŸÑÿ≤ÿßŸÖ€å ÿßÿ≥ÿ™', '‚ö†Ô∏è'); return; }
  frRates.push({ id: Date.now().toString(36)+Math.random().toString(36).slice(2), from, to, distance:dist, rate });
  frSave(); frRender();
  document.getElementById('fr-from').value='';
  document.getElementById('fr-to').value='';
  document.getElementById('fr-dist').value='';
  document.getElementById('fr-rate').value='';
  sShowToast('‚úÖ ŸÜÿ±ÿÆ ÿ´ÿ®ÿ™ ÿ¥ÿØ', 'üó∫Ô∏è');
}

function frDelete(id) {
  if (!confirm('ÿ≠ÿ∞ŸÅ ÿß€åŸÜ ŸÜÿ±ÿÆÿü')) return;
  frRates = frRates.filter(r => r.id !== id);
  frSave(); frRender();
}

function frGetRate(from, to) {
  const r = frRates.find(x =>
    (x.from===from && x.to===to) || (x.from===to && x.to===from));
  return r ? r.rate : '';
}

function frGetDist(from, to) {
  const r = frRates.find(x =>
    (x.from===from && x.to===to) || (x.from===to && x.to===from));
  return r ? r.distance : '';
}

function frRender() {
  const tbody = document.getElementById('freight-tbody');
  if (!tbody) return;
  if (!frRates.length) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:30px;color:#9ca3af;">ŸÜÿ±ÿÆ€å ÿ´ÿ®ÿ™ ŸÜÿ¥ÿØŸá</td></tr>';
    return;
  }
  tbody.innerHTML = frRates.map((r, i) => `<tr>
    <td style="text-align:center;color:#9ca3af;">${i+1}</td>
    <td>${esc(r.from)}</td>
    <td>${esc(r.to)}</td>
    <td style="direction:ltr;">${esc(r.distance)||'‚Äî'}</td>
    <td style="direction:ltr;font-weight:700;color:#059669;">${Number(r.rate||0).toLocaleString()}</td>
    <td><button class="del-btn" onclick="frDelete('${r.id}')">üóëÔ∏è</button></td>
  </tr>`).join('');
}

function frExportExcel() {
  if (!frRates.length) { sShowToast('ÿØÿßÿØŸá‚Äåÿß€å Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ±ÿØ', '‚ö†Ô∏è'); return; }
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet([
    ['ŸÖÿ®ÿØÿß','ŸÖŸÇÿµÿØ','ŸÖÿ≥ÿßŸÅÿ™ (km)','ŸÜÿ±ÿÆ ⁄©ÿ±ÿß€åŸá (ÿ™ŸàŸÖÿßŸÜ/ÿ™ŸÜ)'],
    ...frRates.map(r => [r.from, r.to, r.distance, r.rate])
  ]);
  XLSX.utils.book_append_sheet(wb, ws, '⁄©ÿ±ÿß€åŸá ÿ≠ŸÖŸÑ');
  XLSX.writeFile(wb, '⁄©ÿ±ÿß€åŸá-ÿ≠ŸÖŸÑ-'+new Date().toISOString().split('T')[0]+'.xlsx');
}

// Auto-fill freight in driver modal
function dmAutoFreight() {
  const from = document.getElementById('dm-from-city').value.trim();
  const to   = document.getElementById('dm-to-city').value.trim();
  if (from && to) {
    const rate = frGetRate(from, to);
    const dist = frGetDist(from, to);
    document.getElementById('dm-freight-quoted').value = rate;
    if (dist) document.getElementById('dm-distance').value = dist;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OVERVIEW MODULE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function ovRefresh() {
  const head = document.getElementById('overview-matrix-head');
  const body = document.getElementById('overview-matrix-body');
  if (!head || !body) return;

  // Collect all sellers/buyers from contracts
  const allParties = new Set();
  [...lData.purchase, ...lData.sale].forEach(r => {
    if (r.seller) allParties.add(r.seller.trim());
  });
  // Also from loaded
  lData.loaded.forEach(r => { if (r.seller) allParties.add(r.seller.trim()); });

  const parties = [...allParties].sort();
  if (!parties.length) {
    head.innerHTML = '<tr><th>ŸÜÿßŸÖ ⁄©ÿßÿ±ÿÆÿßŸÜŸá/ÿ∑ÿ±ŸÅ ŸÇÿ±ÿßÿ±ÿØÿßÿØ</th><th>ÿÆÿ±€åÿØ (ÿ™ŸÜ)</th><th>ŸÅÿ±Ÿàÿ¥ (ÿ™ŸÜ)</th><th>ÿ®ÿßÿ±⁄Ø€åÿ±€å ÿ¥ÿØŸá (ÿ™ŸÜ)</th></tr>';
    body.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:30px;color:#9ca3af;">ŸÇÿ±ÿßÿ±ÿØÿßÿØ€å ÿ´ÿ®ÿ™ ŸÜÿ¥ÿØŸá</td></tr>';
    return;
  }

  head.innerHTML = `<tr>
    <th style="text-align:right;">ŸÜÿßŸÖ ⁄©ÿßÿ±ÿÆÿßŸÜŸá / ÿ∑ÿ±ŸÅ ŸÇÿ±ÿßÿ±ÿØÿßÿØ</th>
    <th>ÿÆÿ±€åÿØ (ÿ™ŸÜ)</th>
    <th>ŸÅÿ±Ÿàÿ¥ (ÿ™ŸÜ)</th>
    <th>ÿ®ÿßÿ±⁄Ø€åÿ±€å ÿ¥ÿØŸá (kg)</th>
    <th>ÿÆÿßŸÑÿµ (ÿ™ŸÜ)</th>
  </tr>`;

  let totalBuy=0, totalSell=0, totalLoaded=0;

  body.innerHTML = parties.map(party => {
    const buyQty  = lData.purchase.filter(r=>r.seller===party).reduce((s,r)=>s+(parseFloat(r.qty)||0),0);
    const sellQty = lData.sale.filter(r=>r.seller===party).reduce((s,r)=>s+(parseFloat(r.qty)||0),0);
    const loadedQty = lData.loaded.filter(r=>r.seller===party).reduce((s,r)=>s+(parseFloat(r.loadQty||r.qty)||0),0);
    const net = buyQty - sellQty;
    totalBuy+=buyQty; totalSell+=sellQty; totalLoaded+=loadedQty;
    const netClass = net >= 0 ? 'matrix-diff-pos' : 'matrix-diff-neg';
    return `<tr>
      <td>${esc(party)}</td>
      <td class="matrix-buy">${buyQty.toFixed(2)}</td>
      <td class="matrix-sell">${sellQty.toFixed(2)}</td>
      <td style="direction:ltr;">${loadedQty.toLocaleString()}</td>
      <td class="${netClass}" style="font-weight:700;">${net>=0?'+':''}${net.toFixed(2)}</td>
    </tr>`;
  }).join('') + `<tr style="background:#f8fafc;border-top:2px solid #e5e7eb;">
    <td><strong>ÿ¨ŸÖÿπ ⁄©ŸÑ</strong></td>
    <td class="matrix-buy"><strong>${totalBuy.toFixed(2)}</strong></td>
    <td class="matrix-sell"><strong>${totalSell.toFixed(2)}</strong></td>
    <td style="direction:ltr;"><strong>${totalLoaded.toLocaleString()}</strong></td>
    <td><strong>${(totalBuy-totalSell)>=0?'+':''}${(totalBuy-totalSell).toFixed(2)}</strong></td>
  </tr>`;
}

function ovExportExcel() {
  const head = document.getElementById('overview-matrix-head');
  const body = document.getElementById('overview-matrix-body');
  if (!body || !lData) return;
  const allParties = new Set();
  [...lData.purchase,...lData.sale,lData.loaded].flat().forEach(r=>{ if(r&&r.seller) allParties.add(r.seller.trim()); });
  const parties = [...allParties].sort();
  const wb = XLSX.utils.book_new();
  const rows = [['ŸÜÿßŸÖ ÿ∑ÿ±ŸÅ ŸÇÿ±ÿßÿ±ÿØÿßÿØ','ÿÆÿ±€åÿØ (ÿ™ŸÜ)','ŸÅÿ±Ÿàÿ¥ (ÿ™ŸÜ)','ÿ®ÿßÿ±⁄Ø€åÿ±€å ÿ¥ÿØŸá (kg)','ÿÆÿßŸÑÿµ (ÿ™ŸÜ)']];
  let tb=0,ts=0,tl=0;
  parties.forEach(p => {
    const b = lData.purchase.filter(r=>r.seller===p).reduce((s,r)=>s+(parseFloat(r.qty)||0),0);
    const s = lData.sale.filter(r=>r.seller===p).reduce((s,r)=>s+(parseFloat(r.qty)||0),0);
    const l = lData.loaded.filter(r=>r.seller===p).reduce((s,r)=>s+(parseFloat(r.loadQty||r.qty)||0),0);
    rows.push([p, b.toFixed(2), s.toFixed(2), l, (b-s).toFixed(2)]);
    tb+=b; ts+=s; tl+=l;
  });
  rows.push(['ÿ¨ŸÖÿπ ⁄©ŸÑ', tb.toFixed(2), ts.toFixed(2), tl, (tb-ts).toFixed(2)]);
  const ws = XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, 'ŸÜŸÖÿß€å ⁄©ŸÑ€å');
  XLSX.writeFile(wb, 'ŸÜŸÖÿß€å-⁄©ŸÑ€å-'+new Date().toISOString().split('T')[0]+'.xlsx');
  sShowToast('‚úÖ ÿß⁄©ÿ≥ŸÑ ÿØÿßŸÜŸÑŸàÿØ ÿ¥ÿØ', 'üìä');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Hook into lAddRow: auto-add to warehouse when purchase contract saved
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const _origLUpdateField = lUpdateField;
window.lUpdateField = function(type, id, field, value) {
  _origLUpdateField(type, id, field, value);
  // When description or qty changes on a purchase row, we don't auto-add
  // We add to warehouse when the row is first created and both fields are filled
  // (handled manually via purchase form - user can also use warehouse module directly)
};

// When a new purchase row gets description+qty filled ‚Üí add to warehouse
// We watch via a debounce on lUpdateField for purchase rows
let _whPendingTimeout = null;
const _origLUF2 = window.lUpdateField;
window.lUpdateField = function(type, id, field, value) {
  _origLUF2(type, id, field, value);
  if (type === 'purchase' && (field === 'description' || field === 'qty')) {
    clearTimeout(_whPendingTimeout);
    _whPendingTimeout = setTimeout(() => {
      const row = lData.purchase.find(r => r.id === id);
      if (row && row.description && parseFloat(row.qty) > 0 && !row._whAdded) {
        row._whAdded = true;
        whAddFromContract(row.description, parseFloat(row.qty));
      }
    }, 2000);
  }
};

// ‚îÄ‚îÄ Init when module activates ‚îÄ‚îÄ
const _origSwitchModule = switchModule;
window.switchModule = function(mod) {
  _origSwitchModule(mod);
  if (mod === 'loading' && !window._loadingInited) {
    window._loadingInited = true;
    lInit();
  }
};
</script>



<!-- ‚ïê‚ïê WAREHOUSE MODULE ‚ïê‚ïê -->
<div class="module-panel" id="warehouse-module">
<div style="max-width:1400px;margin:0 auto;padding:20px;">
  <div class="header" style="margin-bottom:22px;">
    <div class="header-left"><h1>üè≠ ŸÖÿØ€åÿ±€åÿ™ ÿßŸÜÿ®ÿßÿ±</h1><p>ŸÖŸàÿ¨ŸàÿØ€å ŸÖÿ≠ÿµŸàŸÑÿßÿ™ ‚Äî ÿ™ÿπŸáÿØÿßÿ™ ÿÆÿ±€åÿØ</p></div>
  </div>
  <div class="card" style="margin-bottom:20px;">
    <div class="lcard-header">
      <div class="lcard-title">‚ûï ÿßŸÅÿ≤ŸàÿØŸÜ / Ÿà€åÿ±ÿß€åÿ¥ ŸÖÿ≠ÿµŸàŸÑ ÿßŸÜÿ®ÿßÿ±</div>
    </div>
    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;">
      <div style="flex:1;min-width:180px;">
        <label style="font-size:13px;font-weight:700;color:#374151;display:block;margin-bottom:5px;">ŸÜÿßŸÖ ŸÖÿ≠ÿµŸàŸÑ</label>
        <input id="wh-new-name" class="form-input" type="text" placeholder="ŸÖÿ´ÿßŸÑ: ÿ¥ŸÖÿ¥ €±€≤€µ">
      </div>
      <div style="width:160px;">
        <label style="font-size:13px;font-weight:700;color:#374151;display:block;margin-bottom:5px;">ŸÖŸàÿ¨ŸàÿØ€å ÿßŸàŸÑ€åŸá (ÿ™ŸÜ)</label>
        <input id="wh-new-qty" class="form-input" type="text" inputmode="numeric" placeholder="€∞" style="direction:ltr;">
      </div>
      <button class="btn btn-success" onclick="whAddProduct()">‚úÖ ÿ´ÿ®ÿ™</button>
    </div>
  </div>
  <div class="card">
    <div class="lcard-header">
      <div class="lcard-title">üì¶ ŸÖŸàÿ¨ŸàÿØ€å ÿßŸÜÿ®ÿßÿ±</div>
      <div class="lcard-actions">
        <button class="btn btn-warning btn-sm" onclick="whExportExcel()">üìä ÿÆÿ±Ÿàÿ¨€å ÿß⁄©ÿ≥ŸÑ</button>
      </div>
    </div>
    <div class="wh-grid" id="wh-grid"></div>
  </div>
</div>
</div><!-- /warehouse-module -->

<!-- ‚ïê‚ïê OVERVIEW MODULE ‚ïê‚ïê -->
<div class="module-panel" id="overview-module">
<div style="max-width:1400px;margin:0 auto;padding:20px;">
  <div class="header" style="margin-bottom:22px;">
    <div class="header-left"><h1>üìä ŸÜŸÖÿß€å ⁄©ŸÑ€å</h1><p>ŸÖÿßÿ™ÿ±€åÿ≥ ÿÆÿ±€åÿØ Ÿà ŸÅÿ±Ÿàÿ¥ ÿ®Ÿá ÿ™ŸÅ⁄©€å⁄© ⁄©ÿßÿ±ÿÆÿßŸÜŸá/ÿÆÿ±€åÿØÿßÿ±</p></div>
    <div class="header-right">
      <button class="btn btn-warning" onclick="ovExportExcel()">üìä ÿÆÿ±Ÿàÿ¨€å ÿß⁄©ÿ≥ŸÑ</button>
      <button class="btn btn-primary" onclick="ovRefresh()">üîÑ ÿ®Ÿá‚Äåÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å</button>
    </div>
  </div>
  <div class="card" id="overview-matrix-card">
    <div class="lcard-title" style="margin-bottom:18px;">üìã ŸÖÿßÿ™ÿ±€åÿ≥ ŸÇÿ±ÿßÿ±ÿØÿßÿØŸáÿß</div>
    <div style="overflow-x:auto;">
      <table class="matrix-table" id="overview-matrix-table">
        <thead id="overview-matrix-head"></thead>
        <tbody id="overview-matrix-body"></tbody>
      </table>
    </div>
  </div>
</div>
</div><!-- /overview-module -->

<!-- ‚ïê‚ïê FREIGHT MODULE ‚ïê‚ïê -->
<div class="module-panel" id="freight-module">
<div style="max-width:1200px;margin:0 auto;padding:20px;">
  <div class="header" style="margin-bottom:22px;">
    <div class="header-left"><h1>üó∫Ô∏è ⁄©ÿ±ÿß€åŸá ÿ≠ŸÖŸÑ</h1><p>ŸÜÿ±ÿÆ ⁄©ÿ±ÿß€åŸá ÿ¥Ÿáÿ± ÿ®Ÿá ÿ¥Ÿáÿ±</p></div>
  </div>
  <div class="card" style="margin-bottom:20px;">
    <div class="lcard-header"><div class="lcard-title">‚ûï ÿ´ÿ®ÿ™ ŸÜÿ±ÿÆ ⁄©ÿ±ÿß€åŸá ÿ¨ÿØ€åÿØ</div></div>
    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;">
      <div style="flex:1;min-width:140px;">
        <label style="font-size:13px;font-weight:700;color:#374151;display:block;margin-bottom:5px;">ÿ¥Ÿáÿ± ŸÖÿ®ÿØÿß</label>
        <input id="fr-from" class="form-input" type="text" placeholder="ŸÖÿ´ÿßŸÑ: ÿ™Ÿáÿ±ÿßŸÜ">
      </div>
      <div style="flex:1;min-width:140px;">
        <label style="font-size:13px;font-weight:700;color:#374151;display:block;margin-bottom:5px;">ÿ¥Ÿáÿ± ŸÖŸÇÿµÿØ</label>
        <input id="fr-to" class="form-input" type="text" placeholder="ŸÖÿ´ÿßŸÑ: ÿßÿµŸÅŸáÿßŸÜ">
      </div>
      <div style="width:130px;">
        <label style="font-size:13px;font-weight:700;color:#374151;display:block;margin-bottom:5px;">ŸÖÿ≥ÿßŸÅÿ™ (km)</label>
        <input id="fr-dist" class="form-input" type="text" inputmode="numeric" placeholder="€∞" style="direction:ltr;">
      </div>
      <div style="width:160px;">
        <label style="font-size:13px;font-weight:700;color:#374151;display:block;margin-bottom:5px;">ŸÜÿ±ÿÆ ⁄©ÿ±ÿß€åŸá (ÿ™ŸàŸÖÿßŸÜ/ÿ™ŸÜ)</label>
        <input id="fr-rate" class="form-input" type="text" inputmode="numeric" placeholder="€∞" style="direction:ltr;">
      </div>
      <button class="btn btn-success" onclick="frAdd()">‚úÖ ÿ´ÿ®ÿ™</button>
    </div>
  </div>
  <div class="card">
    <div class="lcard-header">
      <div class="lcard-title">üìã ÿ¨ÿØŸàŸÑ ŸÜÿ±ÿÆ‚ÄåŸáÿß€å ⁄©ÿ±ÿß€åŸá</div>
      <div class="lcard-actions">
        <button class="btn btn-warning btn-sm" onclick="frExportExcel()">üìä ÿÆÿ±Ÿàÿ¨€å ÿß⁄©ÿ≥ŸÑ</button>
      </div>
    </div>
    <div style="overflow-x:auto;">
      <table class="freight-table">
        <thead><tr>
          <th>#</th><th>ŸÖÿ®ÿØÿß</th><th>ŸÖŸÇÿµÿØ</th><th>ŸÖÿ≥ÿßŸÅÿ™ (km)</th><th>ŸÜÿ±ÿÆ ⁄©ÿ±ÿß€åŸá (ÿ™ŸàŸÖÿßŸÜ/ÿ™ŸÜ)</th><th style="width:40px;">ÿ≠ÿ∞ŸÅ</th>
        </tr></thead>
        <tbody id="freight-tbody"></tbody>
      </table>
    </div>
  </div>
</div>
</div><!-- /freight-module -->


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAV OVERVIEW PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function navOvToggle() {
  const panel = document.getElementById('nav-ov-panel');
  panel.classList.toggle('open');
  if (panel.classList.contains('open')) navOvRefresh();
  // Close on outside click
  if (panel.classList.contains('open')) {
    setTimeout(() => document.addEventListener('click', navOvOutsideClick), 50);
  }
}
function navOvOutsideClick(e) {
  const panel = document.getElementById('nav-ov-panel');
  const btn   = document.getElementById('nav-ov-btn');
  if (!panel.contains(e.target) && !btn.contains(e.target)) {
    panel.classList.remove('open');
    document.removeEventListener('click', navOvOutsideClick);
  }
}

function navOvRefresh() {
  const thead = document.getElementById('nav-ov-thead');
  const tbody = document.getElementById('nav-ov-tbody');
  const tfoot = document.getElementById('nav-ov-tfoot');
  if (!thead || !tbody) return;

  // Collect all parties
  const allParties = new Set();
  const allSources = [
    ...(typeof lData !== 'undefined' ? [...lData.purchase, ...lData.sale, ...lData.loaded] : [])
  ];
  allSources.forEach(r => { if (r && r.seller) allParties.add(r.seller.trim()); });
  const parties = [...allParties].sort();

  thead.innerHTML = `<tr>
    <th style="text-align:right;">⁄©ÿßÿ±ÿÆÿßŸÜŸá / ÿ∑ÿ±ŸÅ ŸÇÿ±ÿßÿ±ÿØÿßÿØ</th>
    <th>ÿÆÿ±€åÿØ (ÿ™ŸÜ)</th>
    <th>ŸÅÿ±Ÿàÿ¥ (ÿ™ŸÜ)</th>
    <th>ÿ®ÿßÿ±⁄Ø€åÿ±€å (kg)</th>
    <th>ÿÆÿßŸÑÿµ (ÿ™ŸÜ)</th>
  </tr>`;

  if (!parties.length) {
    tbody.innerHTML = `<tr><td colspan="5" class="nav-ov-empty">‚¨ú Ÿá€å⁄Ü ŸÇÿ±ÿßÿ±ÿØÿßÿØ€å ÿ´ÿ®ÿ™ ŸÜÿ¥ÿØŸá</td></tr>`;
    tfoot.innerHTML = '';
    document.getElementById('nav-ov-badge').textContent = '0';
    return;
  }

  let tb=0, ts=0, tl=0;
  tbody.innerHTML = parties.map(party => {
    const b = lData.purchase.filter(r=>r.seller===party).reduce((s,r)=>s+(parseFloat(r.qty)||0),0);
    const s = lData.sale.filter(r=>r.seller===party).reduce((s,r)=>s+(parseFloat(r.qty)||0),0);
    const l = lData.loaded.filter(r=>r.seller===party).reduce((s,r)=>s+(parseFloat(r.loadQty||r.qty)||0),0);
    const net = b - s;
    tb+=b; ts+=s; tl+=l;
    const nc = net>=0?'nav-ov-diff-pos':'nav-ov-diff-neg';
    return `<tr>
      <td>${party}</td>
      <td class="nav-ov-buy">${b>0?b.toFixed(2):'‚Äî'}</td>
      <td class="nav-ov-sell">${s>0?s.toFixed(2):'‚Äî'}</td>
      <td style="direction:ltr;">${l>0?l.toLocaleString():'‚Äî'}</td>
      <td class="${nc}">${net>=0?'+':''}${net.toFixed(2)}</td>
    </tr>`;
  }).join('');

  tfoot.innerHTML = `<tr>
    <td>ÿ¨ŸÖÿπ ⁄©ŸÑ</td>
    <td class="nav-ov-buy">${tb.toFixed(2)}</td>
    <td class="nav-ov-sell">${ts.toFixed(2)}</td>
    <td style="direction:ltr;">${tl.toLocaleString()}</td>
    <td class="${(tb-ts)>=0?'nav-ov-diff-pos':'nav-ov-diff-neg'}">${(tb-ts)>=0?'+':''}${(tb-ts).toFixed(2)}</td>
  </tr>`;

  document.getElementById('nav-ov-badge').textContent = parties.length + ' ÿ∑ÿ±ŸÅ';
}

function navOvExcel() {
  if (typeof lData === 'undefined' || typeof XLSX === 'undefined') return;
  const allParties = new Set();
  [...lData.purchase,...lData.sale,...lData.loaded].forEach(r=>{if(r&&r.seller)allParties.add(r.seller.trim());});
  const parties = [...allParties].sort();
  const wb = XLSX.utils.book_new();
  let tb=0,ts=0,tl=0;
  const rows = [['⁄©ÿßÿ±ÿÆÿßŸÜŸá/ÿ∑ÿ±ŸÅ ŸÇÿ±ÿßÿ±ÿØÿßÿØ','ÿÆÿ±€åÿØ (ÿ™ŸÜ)','ŸÅÿ±Ÿàÿ¥ (ÿ™ŸÜ)','ÿ®ÿßÿ±⁄Ø€åÿ±€å (kg)','ÿÆÿßŸÑÿµ (ÿ™ŸÜ)']];
  parties.forEach(p => {
    const b = lData.purchase.filter(r=>r.seller===p).reduce((s,r)=>s+(parseFloat(r.qty)||0),0);
    const s = lData.sale.filter(r=>r.seller===p).reduce((s,r)=>s+(parseFloat(r.qty)||0),0);
    const l = lData.loaded.filter(r=>r.seller===p).reduce((s,r)=>s+(parseFloat(r.loadQty||r.qty)||0),0);
    rows.push([p,b.toFixed(2),s.toFixed(2),l,(b-s).toFixed(2)]);
    tb+=b;ts+=s;tl+=l;
  });
  rows.push(['ÿ¨ŸÖÿπ ⁄©ŸÑ',tb.toFixed(2),ts.toFixed(2),tl,(tb-ts).toFixed(2)]);
  const ws = XLSX.utils.aoa_to_sheet(rows);
  ws['!cols']=[{wch:25},{wch:14},{wch:14},{wch:16},{wch:14}];
  XLSX.utils.book_append_sheet(wb,ws,'ŸÜŸÖÿß€å ⁄©ŸÑ€å');
  XLSX.writeFile(wb,'ŸÜŸÖÿß€å-⁄©ŸÑ€å-'+new Date().toISOString().split('T')[0]+'.xlsx');
}

// Auto-refresh badge every 30s
setInterval(()=>{ if(typeof lData!=='undefined') navOvRefresh(); }, 30000);

</body>
</html>
