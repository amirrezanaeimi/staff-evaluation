<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù¾Ù„ØªÙØ±Ù… Ù…Ø¯ÛŒØ±ÛŒØª â€” Ø´Ø±Ú©Øª Ø¨Ø§Ø²Ø±Ú¯Ø§Ù†ÛŒ ÙÙˆÙ„Ø§Ø¯</title>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

<style>

        :root {
            --primary: #1e40af;
            --primary-dark: #1e3a8a;
            --secondary: #0891b2;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --purple: #7c3aed;
            --dark: #1f2937;
            --light: #f3f4f6;
            --white: #ffffff;
            --border: #e5e7eb;
            --text: #374151;
            --text-light: #6b7280;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Vazirmatn', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* ===== LOGIN SCREEN ===== */
        .login-overlay {
            position: fixed; inset: 0;
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #0891b2 100%);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999;
        }
        .login-box {
            background: white;
            border-radius: 24px;
            padding: 50px 40px;
            width: 420px;
            max-width: 95vw;
            box-shadow: 0 30px 80px rgba(0,0,0,0.4);
            text-align: center;
            animation: slideUp 0.5s ease-out;
        }
        .login-logo { font-size: 56px; margin-bottom: 10px; }
        .login-title { font-size: 26px; font-weight: 900; color: var(--dark); margin-bottom: 6px; }
        .login-subtitle { font-size: 14px; color: var(--text-light); margin-bottom: 30px; }
        .login-form .form-group { margin-bottom: 20px; text-align: right; }
        .login-form label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--dark); font-size: 14px; }
        .login-form select, .login-form input {
            width: 100%; padding: 14px 16px;
            border: 2px solid var(--border); border-radius: 12px;
            font-family: 'Vazirmatn', sans-serif; font-size: 15px;
            transition: border-color 0.3s;
        }
        .login-form select:focus, .login-form input:focus {
            outline: none; border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30,64,175,0.1);
        }
        .login-btn {
            width: 100%; padding: 16px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white; border: none; border-radius: 12px;
            font-family: 'Vazirmatn', sans-serif; font-size: 17px; font-weight: 700;
            cursor: pointer; transition: all 0.3s;
            box-shadow: 0 6px 20px rgba(30,64,175,0.4);
        }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(30,64,175,0.5); }
        .login-error {
            background: #fee2e2; color: #dc2626; padding: 12px 16px;
            border-radius: 10px; font-size: 14px; font-weight: 600;
            margin-bottom: 20px; display: none;
        }

        /* ===== MAIN APP ===== */
        .app-container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white; padding: 25px 40px;
            border-radius: 20px; margin-bottom: 25px;
            box-shadow: 0 10px 40px rgba(30,64,175,0.3);
            display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;
        }
        .header-left h1 { font-size: 26px; font-weight: 900; margin-bottom: 4px; }
        .header-left p { font-size: 14px; opacity: 0.85; }
        .header-right { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .manager-badge {
            background: rgba(255,255,255,0.2); padding: 10px 18px;
            border-radius: 30px; font-size: 14px; font-weight: 700;
            display: flex; align-items: center; gap: 8px;
        }
        .status-badge {
            background: rgba(255,255,255,0.15); padding: 8px 15px;
            border-radius: 20px; font-size: 13px; font-weight: 600;
            display: flex; align-items: center; gap: 7px;
        }
        #status-dot { width: 9px; height: 9px; border-radius: 50%; background: #ef4444; }
        .logout-btn {
            background: rgba(255,255,255,0.2); color: white;
            border: 2px solid rgba(255,255,255,0.4);
            padding: 8px 16px; border-radius: 10px;
            font-family: 'Vazirmatn', sans-serif; font-size: 14px; font-weight: 600;
            cursor: pointer; transition: all 0.3s;
        }
        .logout-btn:hover { background: rgba(255,255,255,0.35); }

        /* ===== NAV ===== */
        .nav-tabs {
            display: flex; gap: 12px; margin-bottom: 25px;
            background: white; padding: 12px;
            border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            flex-wrap: wrap;
        }
        .nav-tab {
            flex: 1; min-width: 160px; padding: 13px 20px;
            background: var(--light); border: none; border-radius: 10px;
            font-family: 'Vazirmatn', sans-serif; font-size: 15px; font-weight: 600;
            color: var(--text); cursor: pointer; transition: all 0.3s;
        }
        .nav-tab:hover { background: var(--primary); color: white; transform: translateY(-2px); }
        .nav-tab.active { background: var(--primary); color: white; box-shadow: 0 5px 15px rgba(30,64,175,0.3); }
        .nav-tab.shared-tab { border: 2px solid #f59e0b; }
        .nav-tab.shared-tab.active { background: linear-gradient(135deg, #d97706 0%, #b45309 100%); border-color: transparent; }
        .nav-tab.shared-tab:hover:not(.active) { background: #fef3c7; color: #d97706; }

        /* ===== SECTIONS ===== */
        .section { display: none; animation: fadeIn 0.4s ease-out; }
        .section.active { display: block; }

        /* ===== CARDS ===== */
        .card {
            background: white; border-radius: 16px; padding: 28px;
            margin-bottom: 22px; box-shadow: 0 4px 20px rgba(0,0,0,0.06);
        }
        .card-title {
            font-size: 21px; font-weight: 700; color: var(--dark);
            margin-bottom: 20px; display: flex; align-items: center; gap: 10px;
        }

        /* ===== SHARED DASHBOARD ===== */
        .shared-dashboard-header {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: 16px; padding: 20px 25px;
            margin-bottom: 25px;
            display: flex; align-items: center; gap: 15px;
        }
        .shared-dashboard-header .icon { font-size: 36px; }
        .shared-dashboard-header h3 { font-size: 20px; font-weight: 900; color: #92400e; }
        .shared-dashboard-header p { font-size: 14px; color: #78350f; margin-top: 4px; }

        .summary-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            border-radius: 14px; padding: 22px;
            text-align: center; transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-3px); }
        .stat-card.blue { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border: 2px solid #93c5fd; }
        .stat-card.green { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border: 2px solid #6ee7b7; }
        .stat-card.orange { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #fcd34d; }
        .stat-card.purple { background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%); border: 2px solid #c4b5fd; }
        .stat-number { font-size: 38px; font-weight: 900; margin-bottom: 4px; }
        .stat-card.blue .stat-number { color: #1d4ed8; }
        .stat-card.green .stat-number { color: #059669; }
        .stat-card.orange .stat-number { color: #d97706; }
        .stat-card.purple .stat-number { color: #7c3aed; }
        .stat-label { font-size: 13px; font-weight: 600; color: var(--text-light); }

        /* All employees ranking table */
        .ranking-table {
            width: 100%; border-collapse: collapse; margin-top: 15px;
            border-radius: 12px; overflow: hidden;
        }
        .ranking-table thead tr { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); }
        .ranking-table th {
            color: white; padding: 14px 16px;
            text-align: right; font-weight: 700; font-size: 14px;
        }
        .ranking-table td { padding: 13px 16px; border-bottom: 1px solid var(--border); font-size: 14px; }
        .ranking-table tbody tr:hover { background: #f0f9ff; }
        .ranking-table tbody tr:last-child td { border-bottom: none; }
        .rank-1 td { background: linear-gradient(135deg, #fef9c3 0%, #fef08a 100%) !important; }
        .rank-2 td { background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%) !important; }
        .rank-3 td { background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%) !important; }

        /* Progress bar */
        .progress-bar-wrap { background: #e5e7eb; border-radius: 20px; height: 10px; min-width: 100px; }
        .progress-bar-fill { height: 100%; border-radius: 20px; transition: width 0.6s ease; }

        /* ===== FORM ELEMENTS ===== */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 18px; margin-bottom: 22px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-group label { font-weight: 600; color: var(--dark); font-size: 14px; }
        .form-group input, .form-group select {
            padding: 12px 15px; border: 2px solid var(--border);
            border-radius: 10px; font-family: 'Vazirmatn', sans-serif;
            font-size: 15px; transition: all 0.3s; background: var(--white);
        }
        .form-group input:focus, .form-group select:focus {
            outline: none; border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30,64,175,0.1);
        }

        /* ===== EVALUATION ===== */
        .department-badge {
            display: inline-block; padding: 8px 16px;
            border-radius: 20px; font-weight: 700; font-size: 14px; margin-bottom: 18px;
        }
        .dept-sales { background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; }
        .dept-operations { background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%); color: white; }
        .dept-hr { background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); color: white; }
        .dept-finance { background: linear-gradient(135deg, #d97706 0%, #b45309 100%); color: white; }
        .dept-it { background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; }
        .dept-production { background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%); color: white; }
        .evaluation-sections { display: grid; gap: 18px; }
        .eval-section {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 12px; padding: 20px; border: 2px solid #fbbf24;
        }
        .eval-section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .eval-section-title { font-weight: 700; font-size: 17px; color: var(--dark); }
        .eval-weight {
            background: var(--warning); color: white;
            padding: 5px 14px; border-radius: 20px; font-weight: 700; font-size: 13px;
        }
        .score-slider-container { display: flex; align-items: center; gap: 14px; margin-top: 8px; }
        .score-slider {
            flex: 1; height: 8px; -webkit-appearance: none; appearance: none;
            background: #e5e7eb; border-radius: 5px; outline: none;
        }
        .score-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 24px; height: 24px;
            background: var(--primary); cursor: pointer; border-radius: 50%;
            box-shadow: 0 2px 8px rgba(30,64,175,0.4); transition: all 0.3s;
        }
        .score-slider::-webkit-slider-thumb:hover { transform: scale(1.2); }
        .score-display {
            min-width: 55px; text-align: center; font-weight: 700;
            font-size: 20px; color: var(--primary);
            background: white; padding: 7px 12px; border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .weighted-score { font-size: 13px; color: var(--text-light); margin-top: 4px; }
        .total-score-card {
            background: linear-gradient(135deg, var(--success) 0%, #047857 100%);
            color: white; padding: 28px; border-radius: 16px;
            text-align: center; margin-top: 22px;
            box-shadow: 0 10px 30px rgba(5,150,105,0.3);
        }
        .total-score-label { font-size: 17px; font-weight: 600; opacity: 0.9; margin-bottom: 8px; }
        .total-score-value { font-size: 52px; font-weight: 900; margin-bottom: 8px; }
        .total-score-max { font-size: 15px; opacity: 0.8; }

        /* ===== BUTTONS ===== */
        .btn {
            padding: 13px 28px; border: none; border-radius: 10px;
            font-family: 'Vazirmatn', sans-serif; font-size: 15px; font-weight: 700;
            cursor: pointer; transition: all 0.3s;
            display: inline-flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #047857; transform: translateY(-2px); }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-secondary:hover { background: #0e7490; transform: translateY(-2px); }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-purple { background: var(--purple); color: white; }
        .btn-sm { padding: 8px 15px; font-size: 13px; }
        .btn-group { display: flex; gap: 14px; margin-top: 22px; flex-wrap: wrap; }

        /* ===== ALERTS ===== */
        .alert {
            padding: 14px 18px; border-radius: 10px;
            margin-bottom: 18px; font-weight: 600;
            display: flex; align-items: center; gap: 10px; font-size: 14px;
        }
        .alert-success { background: #d1fae5; color: var(--success); border: 2px solid var(--success); }
        .alert-info { background: #dbeafe; color: var(--primary); border: 2px solid var(--primary); }
        .alert-warning { background: #fef3c7; color: var(--warning); border: 2px solid var(--warning); }

        /* ===== EMPLOYEE CARDS ===== */
        .employee-list { display: grid; gap: 14px; }
        .employee-card {
            background: white; border: 2px solid var(--border);
            border-radius: 12px; padding: 18px; transition: all 0.3s;
        }
        .employee-card:hover { border-color: var(--primary); box-shadow: 0 4px 15px rgba(30,64,175,0.1); }
        .employee-header { display: flex; justify-content: space-between; align-items: center; }
        .employee-info h3 { font-size: 17px; font-weight: 700; color: var(--dark); margin-bottom: 4px; }
        .employee-info p { color: var(--text-light); font-size: 13px; }
        .employee-score-value { font-size: 30px; font-weight: 900; color: var(--primary); }
        .employee-score-label { font-size: 11px; color: var(--text-light); }

        /* ===== STAR EMPLOYEES ===== */
        .star-employees-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(270px, 1fr));
            gap: 22px; margin-top: 22px;
        }
        .star-employee-card {
            background: white; border: 3px solid var(--border);
            border-radius: 16px; padding: 24px; text-align: center;
            transition: all 0.3s; position: relative; overflow: hidden;
        }
        .star-employee-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .star-employee-card.rank-1 { border-color: #fbbf24; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); }
        .star-employee-card.rank-2 { border-color: #d1d5db; background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); }
        .star-employee-card.rank-3 { border-color: #f97316; background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%); }
        .star-rank-badge {
            position: absolute; top: 14px; right: 14px;
            width: 46px; height: 46px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 22px; font-weight: 900; color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .star-rank-badge.rank-1 { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); }
        .star-rank-badge.rank-2 { background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%); }
        .star-rank-badge.rank-3 { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
        .star-employee-photo {
            width: 110px; height: 110px; border-radius: 50%;
            margin: 0 auto 14px; border: 4px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            display: flex; align-items: center; justify-content: center;
            font-size: 44px; color: var(--text-light); background: var(--light);
        }
        .star-employee-photo img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .star-employee-name { font-size: 19px; font-weight: 700; color: var(--dark); margin-bottom: 6px; }
        .star-employee-dept { font-size: 13px; color: var(--text-light); margin-bottom: 14px; }
        .star-employee-score { background: white; padding: 13px; border-radius: 12px; margin-top: 14px; }
        .star-score-value { font-size: 30px; font-weight: 900; color: var(--primary); display: block; }
        .star-score-label { font-size: 12px; color: var(--text-light); }

        /* ===== DEPARTMENTS ===== */
        .departments-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 18px; margin-top: 18px; }
        .department-card {
            background: white; border: 2px solid var(--border);
            border-radius: 12px; padding: 20px; transition: all 0.3s; cursor: pointer;
        }
        .department-card:hover { border-color: var(--primary); box-shadow: 0 4px 15px rgba(30,64,175,0.1); transform: translateY(-3px); }
        .department-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
        .department-name { font-size: 19px; font-weight: 700; color: var(--dark); }
        .criteria-count { background: var(--light); padding: 5px 11px; border-radius: 15px; font-size: 12px; font-weight: 600; }
        .criteria-list { display: grid; gap: 13px; margin-top: 18px; }
        .criteria-item {
            background: white; border: 2px solid var(--border);
            border-radius: 12px; padding: 18px;
            display: grid; grid-template-columns: 1fr 140px 90px;
            gap: 13px; align-items: center;
        }
        .criteria-item:hover { border-color: var(--primary); }
        .criteria-name-input, .criteria-weight-input {
            padding: 9px 13px; border: 2px solid var(--border);
            border-radius: 8px; font-family: 'Vazirmatn', sans-serif;
            font-size: 14px; font-weight: 600;
        }
        .criteria-weight-input { text-align: center; }

        /* ===== HISTORY TABLE ===== */
        .history-table { width: 100%; border-collapse: collapse; margin-top: 18px; }
        .history-table th {
            background: var(--primary); color: white;
            padding: 13px 15px; text-align: right; font-weight: 700; font-size: 14px;
        }
        .history-table td { padding: 13px 15px; border-bottom: 1px solid var(--border); text-align: right; font-size: 14px; }
        .history-table tr:hover td { background: var(--light); }
        .badge { display: inline-block; padding: 5px 11px; border-radius: 15px; font-size: 12px; font-weight: 600; }
        .badge-high { background: #d1fae5; color: var(--success); }
        .badge-medium { background: #fef3c7; color: var(--warning); }
        .badge-low { background: #fee2e2; color: var(--danger); }

        /* ===== MODAL ===== */
        .modal {
            display: none; position: fixed; z-index: 1000;
            inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
        }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content {
            background: white; padding: 38px; border-radius: 20px;
            max-width: 800px; width: 92%; max-height: 82vh;
            overflow-y: auto; animation: slideUp 0.4s ease-out;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 22px; }
        .modal-title { font-size: 22px; font-weight: 900; color: var(--dark); }
        .modal-close {
            background: var(--danger); color: white; border: none;
            width: 33px; height: 33px; border-radius: 50%;
            cursor: pointer; font-size: 19px;
            display: flex; align-items: center; justify-content: center; transition: all 0.3s;
        }
        .modal-close:hover { transform: rotate(90deg); background: #b91c1c; }

        /* ===== MANAGE EMPLOYEES ===== */
        .employee-mgmt-card {
            background: white; border: 2px solid var(--border);
            border-radius: 12px; padding: 20px;
            display: flex; justify-content: space-between; align-items: center; gap: 15px;
        }
        .employee-mgmt-card:hover { border-color: var(--primary); }

        /* ===== EMPTY STATE ===== */
        .empty-state { text-align: center; padding: 55px 20px; color: var(--text-light); }
        .empty-state-icon { font-size: 60px; margin-bottom: 18px; opacity: 0.5; }
        .empty-state h3 { font-size: 19px; margin-bottom: 8px; color: var(--dark); }

        /* ===== ANIMATIONS ===== */
        @keyframes slideDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .nav-tabs { flex-direction: column; }
            .form-grid { grid-template-columns: 1fr; }
            .criteria-item { grid-template-columns: 1fr; }
            .header { flex-direction: column; align-items: flex-start; }
        }
    

    /* â•â• SUPPLY MODULE SPECIFIC â•â• */
    /* live badge in header */
    .live-badge{display:flex;align-items:center;gap:7px;background:rgba(255,255,255,0.15);padding:8px 15px;border-radius:20px;font-size:13px;font-weight:600;color:white;}
    .live-dot{width:8px;height:8px;border-radius:50%;background:#4ade80;animation:pulse 2s infinite;}
    .clock-badge{background:rgba(255,255,255,0.15);padding:8px 15px;border-radius:20px;font-size:13px;color:white;opacity:.9;}
    /* stat strip */
    .stat-strip{display:grid;grid-template-columns:repeat(auto-fit,minmax(185px,1fr));gap:18px;margin-bottom:25px;}
    .stat-card{background:white;border-radius:16px;padding:22px 24px;box-shadow:0 4px 20px rgba(0,0,0,0.06);transition:all .3s;position:relative;overflow:hidden;border-right:4px solid transparent;}
    .stat-card.blue{border-right-color:var(--primary);}
    .stat-card.teal{border-right-color:var(--secondary);}
    .stat-card.green{border-right-color:var(--success);}
    .stat-card.orange{border-right-color:var(--warning);}
    .stat-card:hover{transform:translateY(-3px);box-shadow:0 8px 30px rgba(0,0,0,0.1);}
    .stat-val{font-size:34px;font-weight:900;margin-bottom:4px;}
    .stat-card.blue .stat-val{color:var(--primary);}
    .stat-card.teal .stat-val{color:var(--secondary);}
    .stat-card.green .stat-val{color:var(--success);}
    .stat-card.orange .stat-val{color:var(--warning);}
    .stat-label{font-size:13px;color:var(--text-light);font-weight:500;}
    .stat-icon{position:absolute;left:18px;top:50%;transform:translateY(-50%);font-size:34px;opacity:.1;}
    /* supply nav (separate from eval nav-tabs) */
    #supply-nav{display:flex;gap:12px;flex-wrap:wrap;background:white;padding:12px;border-radius:15px;box-shadow:0 4px 20px rgba(0,0,0,0.05);margin-bottom:25px;}
    .supply-nav-btn{flex:1;min-width:160px;padding:13px 20px;border:none;border-radius:10px;font-family:'Vazirmatn',sans-serif;font-size:15px;font-weight:600;cursor:pointer;transition:all .3s;color:var(--text);background:var(--light);display:flex;align-items:center;justify-content:center;gap:8px;}
    .supply-nav-btn:hover{background:var(--primary);color:white;transform:translateY(-2px);}
    .supply-nav-btn.active{background:var(--primary);color:white;box-shadow:0 5px 15px rgba(30,64,175,0.3);}
    .nav-count{background:rgba(0,0,0,0.15);padding:2px 8px;border-radius:10px;font-size:11px;}
    /* supply sections */
    .supply-section{display:none;animation:fadeIn .4s ease-out;}
    .supply-section.active{display:block;}
    /* toolbar */
    .toolbar{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px;align-items:center;}
    .search-wrap{flex:1;min-width:220px;position:relative;}
    .search-wrap .icon{position:absolute;right:14px;top:50%;transform:translateY(-50%);color:var(--text-light);font-size:15px;}
    .search-input{width:100%;padding:11px 42px 11px 15px;background:white;border:2px solid var(--border);border-radius:10px;font-family:'Vazirmatn',sans-serif;font-size:14px;color:var(--text);transition:all .3s;}
    .search-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(30,64,175,0.1);}
    .search-input::placeholder{color:var(--text-light);}
    .filter-select{padding:11px 15px;background:white;border:2px solid var(--border);border-radius:10px;font-family:'Vazirmatn',sans-serif;font-size:14px;color:var(--text);cursor:pointer;min-width:150px;transition:all .3s;}
    .filter-select:focus{outline:none;border-color:var(--primary);}
    /* supply form */
    .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:16px;margin-bottom:18px;}
    .form-label{font-size:13px;font-weight:600;color:var(--dark);}
    .form-input,.form-select{padding:11px 14px;background:white;border:2px solid var(--border);border-radius:10px;font-family:'Vazirmatn',sans-serif;font-size:14px;color:var(--text);transition:all .3s;}
    .form-input:focus,.form-select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(30,64,175,0.1);}
    .form-input::placeholder{color:var(--text-light);}
    .form-add-section{background:linear-gradient(135deg,#eff6ff 0%,#dbeafe 100%);border:2px solid #bfdbfe;border-radius:14px;padding:24px;margin-bottom:20px;}
    /* table */
    .table-wrap{overflow-x:auto;border-radius:10px;border:1px solid var(--border);}
    .data-table{width:100%;border-collapse:collapse;}
    .data-table thead tr{background:var(--primary);}
    .data-table th{padding:13px 16px;text-align:right;font-size:13px;font-weight:700;color:white;white-space:nowrap;}
    .data-table td{padding:13px 16px;text-align:right;border-bottom:1px solid var(--border);font-size:14px;vertical-align:middle;color:var(--text);}
    .data-table tbody tr{transition:background .2s;}
    .data-table tbody tr:hover{background:#f0f9ff;}
    .data-table tbody tr:last-child td{border-bottom:none;}
    .data-table .actions{display:flex;gap:6px;justify-content:flex-end;}
    /* chips */
    .chip{display:inline-flex;align-items:center;gap:5px;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600;}
    .chip-blue{background:#dbeafe;color:var(--primary);}
    .chip-teal,.chip-cyan{background:#cffafe;color:var(--secondary);}
    .chip-green{background:#d1fae5;color:var(--success);}
    .chip-orange,.chip-amber{background:#fef3c7;color:var(--warning);}
    .chip-red{background:#fee2e2;color:var(--danger);}
    .chip-gray{background:var(--light);color:var(--text-light);border:1px solid var(--border);}
    /* price */
    .price-cell{font-weight:700;font-size:15px;color:var(--primary);direction:ltr;text-align:left;}
    .price-unit{font-size:11px;color:var(--text-light);font-weight:400;}
    .update-badge{display:flex;flex-direction:column;font-size:11px;color:var(--text-light);white-space:nowrap;}
    .update-badge .date{color:var(--dark);font-size:12px;font-weight:600;}
    .change-up{color:var(--success);font-size:12px;font-weight:700;}
    .change-down{color:var(--danger);font-size:12px;font-weight:700;}
    .change-flat{color:var(--text-light);font-size:12px;}
    /* grid cards */
    .grid-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:18px;margin-top:16px;}
    .item-card{background:white;border:2px solid var(--border);border-radius:16px;padding:22px;transition:all .3s;}
    .item-card:hover{border-color:var(--primary);box-shadow:0 8px 30px rgba(30,64,175,0.1);transform:translateY(-3px);}
    .item-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
    .item-card-icon{width:46px;height:46px;border-radius:12px;background:linear-gradient(135deg,#dbeafe,#bfdbfe);display:flex;align-items:center;justify-content:center;font-size:22px;}
    .item-card-name{font-size:17px;font-weight:700;color:var(--dark);margin-bottom:5px;}
    .item-card-meta{font-size:13px;color:var(--text-light);}
    .item-card-actions{display:flex;gap:8px;margin-top:16px;padding-top:16px;border-top:1px solid var(--border);}
    /* charts */
    .chart-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:20px;}
    .chart-card{background:white;border-radius:16px;padding:24px;box-shadow:0 4px 20px rgba(0,0,0,0.06);}
    .chart-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px;}
    .chart-title{font-size:16px;font-weight:700;color:var(--dark);}
    .chart-subtitle{font-size:12px;color:var(--text-light);margin-top:3px;}
    .period-tabs{display:flex;gap:6px;}
    .period-tab{padding:6px 14px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;border:2px solid var(--border);color:var(--text-light);background:white;font-family:'Vazirmatn',sans-serif;}
    .period-tab.active{background:var(--primary);color:white;border-color:var(--primary);}
    .period-tab:hover:not(.active){border-color:var(--primary);color:var(--primary);}
    /* toast */
    .s-toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--dark);border-radius:30px;padding:12px 26px;font-size:14px;font-weight:600;color:white;box-shadow:0 8px 30px rgba(0,0,0,0.3);z-index:9999;transition:transform .4s cubic-bezier(0.175,0.885,0.32,1.275);display:flex;align-items:center;gap:10px;}
    .s-toast.show{transform:translateX(-50%) translateY(0);}


/* â•â• MASTER DASHBOARD â•â• */
.master-nav {
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 500;
    background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
    box-shadow: 0 4px 24px rgba(30,64,175,0.35);
    padding: 0 32px;
    display: flex;
    align-items: stretch;
    height: 64px;
    gap: 0;
}
.master-logo {
    display: flex;
    align-items: center;
    gap: 12px;
    padding-left: 28px;
    border-left: 1px solid rgba(255,255,255,0.15);
    margin-left: 8px;
}
.master-logo-icon { font-size: 26px; }
.master-logo-text { font-size: 16px; font-weight: 900; color: white; }
.master-logo-sub { font-size: 11px; color: rgba(255,255,255,0.65); margin-top: 1px; }
.master-module-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 0 24px;
    border: none;
    background: transparent;
    color: rgba(255,255,255,0.75);
    font-family: 'Vazirmatn', sans-serif;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.25s;
    border-bottom: 3px solid transparent;
    margin-bottom: -3px;
    position: relative;
}
.master-module-btn:hover {
    color: white;
    background: rgba(255,255,255,0.08);
}
.master-module-btn.active {
    color: white;
    border-bottom-color: white;
    background: rgba(255,255,255,0.12);
}
.master-module-btn .m-icon { font-size: 20px; }
.master-module-btn .m-badge {
    background: rgba(255,255,255,0.2);
    font-size: 10px;
    padding: 2px 7px;
    border-radius: 10px;
    font-weight: 700;
}
.master-module-btn.active .m-badge {
    background: rgba(255,255,255,0.35);
}
.master-spacer { flex: 1; }
.master-meta {
    display: flex;
    align-items: center;
    gap: 10px;
    padding-right: 12px;
}
.master-user-badge {
    display: flex; align-items: center; gap: 7px;
    background: rgba(255,255,255,0.15);
    padding: 6px 14px; border-radius: 20px;
    font-size: 13px; font-weight: 600; color: white;
}
.master-clock {
    background: rgba(255,255,255,0.1);
    padding: 6px 14px; border-radius: 20px;
    font-size: 12px; color: rgba(255,255,255,0.8);
}
.master-logout {
    background: rgba(255,255,255,0.15);
    border: 1px solid rgba(255,255,255,0.3);
    color: white; padding: 6px 14px; border-radius: 8px;
    font-family: 'Vazirmatn', sans-serif; font-size: 13px;
    font-weight: 600; cursor: pointer; transition: all 0.25s;
}
.master-logout:hover { background: rgba(255,255,255,0.28); }

/* push content below fixed master nav */
body { padding-top: 64px; }
/* hide login-overlay's own header space adjustments */
#login-overlay { padding-top: 0 !important; }

/* module panels */
.module-panel { display: none; }
.module-panel.active { display: block; }

/* Supply header â€” slimmer since we have master nav */
#supply-app .header { margin-top: 0; border-radius: 16px; }

/* Override eval header's own position when inside module */
#eval-module .header { 
    animation: none;
}

/* When in login state, hide master nav modules */
.master-nav.login-mode .master-module-btn { opacity: 0.4; pointer-events: none; }

@media(max-width: 768px) {
    .master-nav { padding: 0 12px; height: 56px; }
    body { padding-top: 56px; }
    .master-logo-sub, .master-meta { display: none; }
    .master-module-btn { padding: 0 14px; font-size: 13px; }
    .master-logo-text { font-size: 14px; }
}

</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MASTER NAVIGATION BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<nav class="master-nav" id="master-nav">
    <div class="master-logo">
        <div class="master-logo-icon">ğŸ—ï¸</div>
        <div>
            <div class="master-logo-text">ÙÙˆÙ„Ø§Ø¯ Ù¾Ù„ØªÙØ±Ù…</div>
            <div class="master-logo-sub">Ø´Ø±Ú©Øª Ø¨Ø§Ø²Ø±Ú¯Ø§Ù†ÛŒ ÙÙˆÙ„Ø§Ø¯</div>
        </div>
    </div>

    <button class="master-module-btn" id="btn-eval" onclick="switchModule('eval')">
        <span class="m-icon">â­</span>
        Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù¾Ø±Ø³Ù†Ù„
        <span class="m-badge">HR</span>
    </button>

    <button class="master-module-btn" id="btn-supply" onclick="switchModule('supply')">
        <span class="m-icon">âš™ï¸</span>
        Ù…Ø¯ÛŒØ±ÛŒØª ØªØ§Ù…ÛŒÙ†
        <span class="m-badge">SCM</span>
    </button>

    <div class="master-spacer"></div>

    <div class="master-meta" id="master-meta-bar">
        <div class="master-user-badge" id="master-user-badge" style="display:none;">
            ğŸ‘¤ <span id="master-user-name">â€”</span>
        </div>
        <div class="master-clock" id="master-clock">â€”</div>
        <button class="master-logout" id="master-logout-btn" onclick="masterLogout()" style="display:none;">
            ğŸšª Ø®Ø±ÙˆØ¬
        </button>
    </div>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODULE: Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="module-panel" id="eval-module">


<!-- ======================== LOGIN SCREEN ======================== -->
<div class="login-overlay" id="login-overlay">
    <div class="login-box">
        <div class="login-logo">â­</div>
        <div class="login-title">Ø³ÛŒØ³ØªÙ… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù¾Ø±Ø³Ù†Ù„</div>
        <div class="login-subtitle">Ø´Ø±Ú©Øª Ø¨Ø§Ø²Ø±Ú¯Ø§Ù†ÛŒ ÙÙˆÙ„Ø§Ø¯</div>
        
        <div class="login-error" id="login-error">âŒ Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ù…Ø¯ÛŒØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯!</div>
        
        <div class="login-form">
            <div class="form-group">
                <label>ğŸ‘¤ Ù†Ø§Ù… Ù…Ø¯ÛŒØ± Ø§Ø±Ø²ÛŒØ§Ø¨</label>
                <select id="login-manager-select">
                    <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                    <option value="Ù…Ø¯ÛŒØ± Ø¹Ø§Ù…Ù„">Ù…Ø¯ÛŒØ± Ø¹Ø§Ù…Ù„</option>
                    <option value="Ù…Ø¯ÛŒØ± ÙØ±ÙˆØ´">Ù…Ø¯ÛŒØ± ÙØ±ÙˆØ´</option>
                    <option value="Ù…Ø¯ÛŒØ± Ø¹Ù…Ù„ÛŒØ§Øª">Ù…Ø¯ÛŒØ± Ø¹Ù…Ù„ÛŒØ§Øª</option>
                    <option value="Ù…Ø¯ÛŒØ± Ù…Ù†Ø§Ø¨Ø¹ Ø§Ù†Ø³Ø§Ù†ÛŒ">Ù…Ø¯ÛŒØ± Ù…Ù†Ø§Ø¨Ø¹ Ø§Ù†Ø³Ø§Ù†ÛŒ</option>
                    <option value="Ù…Ø¯ÛŒØ± Ù…Ø§Ù„ÛŒ">Ù…Ø¯ÛŒØ± Ù…Ø§Ù„ÛŒ</option>
                </select>
            </div>
            <button class="login-btn" onclick="doLogin()">ğŸ” ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…</button>
        </div>
    </div>
</div>

<!-- ======================== MAIN APP ======================== -->
<div class="app-container" id="main-app" style="display:none;">
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <h1>â­ Ø³ÛŒØ³ØªÙ… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù¾Ø±Ø³Ù†Ù„</h1>
            <p>Ø´Ø±Ú©Øª Ø¨Ø§Ø²Ø±Ú¯Ø§Ù†ÛŒ ÙÙˆÙ„Ø§Ø¯ â€” Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Real-time Ø¨Ø§ Firebase</p>
        </div>
        <div class="header-right">
            <div class="manager-badge">
                ğŸ‘¤ <span id="current-manager-display">â€”</span>
            </div>
            <div class="status-badge">
                <div id="status-dot"></div>
                <span id="status-text">Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...</span>
            </div>
            <button class="logout-btn" onclick="doLogout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

    <!-- Navigation -->
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('evaluation', this)">ğŸ“ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¬Ø¯ÛŒØ¯</button>
        <button class="nav-tab" onclick="switchTab('my-history', this)">ğŸ“‹ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ù†</button>
        <button class="nav-tab shared-tab" onclick="switchTab('shared-dashboard', this)">ğŸŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø´ØªØ±Ú©</button>
        <button class="nav-tab shared-tab" onclick="switchTab('star-employees', this)">â­ Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù† Ù†Ù…ÙˆÙ†Ù‡</button>
        <button class="nav-tab" onclick="switchTab('manage-employees', this)">ğŸ‘¤ Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù†</button>
        <button class="nav-tab" onclick="switchTab('departments', this)">ğŸ¢ Ø¨Ø®Ø´â€ŒÙ‡Ø§</button>
    </div>

    <!-- ===== EVALUATION SECTION ===== -->
    <div id="evaluation-section" class="section active">
        <div class="card">
            <h2 class="card-title">ğŸ¯ Ø«Ø¨Øª Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¬Ø¯ÛŒØ¯</h2>
            <div class="alert alert-info">â„¹ï¸ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡ Ø¨Ù‡â€ŒÙ†Ø§Ù… Ø´Ù…Ø§ (<strong id="eval-manager-label">â€”</strong>) Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ ÙÙ‚Ø· Ø´Ù…Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¢Ù† Ø±Ø§ Ø¨Ø¨ÛŒÙ†ÛŒØ¯.</div>
            <div class="form-grid">
                <div class="form-group">
                    <label>Ø¨Ø®Ø´ (Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†) *</label>
                    <select id="employee-department" onchange="handleDepartmentChange()">
                        <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ù†Ø§Ù… Ú©Ø§Ø±Ù…Ù†Ø¯ *</label>
                    <select id="employee-name">
                        <option value="">Ø§Ø¨ØªØ¯Ø§ Ø¨Ø®Ø´ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ØªØ§Ø±ÛŒØ® Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</label>
                    <input type="date" id="evaluation-date">
                </div>
            </div>
            <div id="department-badge-container"></div>
            <div class="evaluation-sections" id="evaluation-criteria"></div>
            <div class="total-score-card" style="display:none;" id="total-score-container">
                <div class="total-score-label">Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„ Ø§ÛŒÙ† Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</div>
                <div class="total-score-value" id="total-score">0</div>
                <div class="total-score-max">Ø§Ø² <span id="max-score">1000</span></div>
            </div>
            <div class="btn-group">
                <button class="btn btn-success" onclick="saveEvaluation()">âœ… Ø°Ø®ÛŒØ±Ù‡ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</button>
                <button class="btn btn-secondary" onclick="resetForm()">ğŸ”„ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù…</button>
            </div>
        </div>
    </div>

    <!-- ===== MY HISTORY SECTION ===== -->
    <div id="my-history-section" class="section">
        <div class="card">
            <h2 class="card-title">ğŸ“‹ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡ ØªÙˆØ³Ø· Ù…Ù†</h2>
            <div class="alert alert-info" id="my-history-info">ğŸ“Œ ÙÙ‚Ø· Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø´Ù…Ø§ Ø«Ø¨Øª Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
            <div class="btn-group" style="margin-bottom: 18px; margin-top: 0;">
                <button class="btn btn-warning" onclick="exportMyEvaluations()">ğŸ“¥ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ù†</button>
            </div>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>ØªØ§Ø±ÛŒØ®</th>
                        <th>Ù†Ø§Ù… Ú©Ø§Ø±Ù…Ù†Ø¯</th>
                        <th>Ø¨Ø®Ø´</th>
                        <th>Ø§Ù…ØªÛŒØ§Ø²</th>
                        <th>Ø±ØªØ¨Ù‡</th>
                        <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                    </tr>
                </thead>
                <tbody id="my-history-tbody"></tbody>
            </table>
        </div>
    </div>

    <!-- ===== SHARED DASHBOARD ===== -->
    <div id="shared-dashboard-section" class="section">
        <div class="shared-dashboard-header">
            <div class="icon">ğŸŒ</div>
            <div>
                <h3>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø´ØªØ±Ú© â€” Ù‚Ø§Ø¨Ù„ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ù…Ø¯ÛŒØ±Ø§Ù†</h3>
                <p>Ù…Ø¬Ù…ÙˆØ¹ Ú©Ù„ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª Ùˆ Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ ØªÙ…Ø§Ù… Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù† Ø§Ø² Ù‡Ù…Ù‡ Ø¨Ø®Ø´â€ŒÙ‡Ø§ØŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù‡Ù…Ù‡ Ù…Ø¯ÛŒØ±Ø§Ù†</p>
            </div>
        </div>

        <!-- Summary Stats -->
        <div class="summary-stats-grid" id="summary-stats"></div>

        <!-- Top Performers Card -->
        <div class="card">
            <h2 class="card-title">ğŸ† Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ú©Ù„ÛŒ Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù† (Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª Ù‡Ù…Ù‡ Ù…Ø¯ÛŒØ±Ø§Ù†)</h2>
            <div class="alert alert-warning">âš ï¸ Ø§ÛŒÙ† Ø¬Ø¯ÙˆÙ„ Ù…Ø¬Ù…ÙˆØ¹ ØªÙ…Ø§Ù… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡ ØªÙˆØ³Ø· Ù‡Ù…Ù‡ Ù…Ø¯ÛŒØ±Ø§Ù† Ø±Ø§ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.</div>
            <div style="overflow-x:auto;">
                <table class="ranking-table" id="global-ranking-table">
                    <thead>
                        <tr>
                            <th style="width:60px;">Ø±ØªØ¨Ù‡</th>
                            <th>Ù†Ø§Ù… Ú©Ø§Ø±Ù…Ù†Ø¯</th>
                            <th>Ø¨Ø®Ø´</th>
                            <th>ØªØ¹Ø¯Ø§Ø¯ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</th>
                            <th>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù…ØªÛŒØ§Ø²</th>
                            <th>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† %</th>
                            <th>Ù†Ù…ÙˆØ¯Ø§Ø±</th>
                        </tr>
                    </thead>
                    <tbody id="global-ranking-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- Charts -->
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap:22px; margin-top:10px;">
            <div class="card">
                <h3 style="margin-bottom:18px; font-size:17px;">ğŸ“ˆ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø§Ù…ØªÛŒØ§Ø² Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù†</h3>
                <canvas id="sharedEmployeesChart"></canvas>
            </div>
            <div class="card">
                <h3 style="margin-bottom:18px; font-size:17px;">ğŸ¢ ØªÙˆØ²ÛŒØ¹ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ Ø¯Ø± Ø¨Ø®Ø´â€ŒÙ‡Ø§</h3>
                <canvas id="sharedDepartmentsChart"></canvas>
            </div>
        </div>
    </div>

    <!-- ===== STAR EMPLOYEES ===== -->
    <div id="star-employees-section" class="section">
        <div class="card">
            <h2 class="card-title">â­ ØªØ§Ø¨Ù„Ùˆ Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù† Ù†Ù…ÙˆÙ†Ù‡ Ù…Ø§Ù‡</h2>
            <div class="alert alert-info">â„¹ï¸ Ø§ÛŒÙ† ØªØ§Ø¨Ù„Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ Ù‡Ù…Ù‡ Ù…Ø¯ÛŒØ±Ø§Ù† Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ù‚Ø§Ø¨Ù„ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø§Ø³Øª.</div>
            <div class="form-grid" style="margin-bottom:22px;">
                <div class="form-group">
                    <label>Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø§Ù‡</label>
                    <input type="month" id="star-month-selector" onchange="updateStarEmployees()">
                </div>
                <div class="form-group">
                    <label>ØªØ¹Ø¯Ø§Ø¯ Ù†Ù…Ø§ÛŒØ´</label>
                    <select id="star-count-selector" onchange="updateStarEmployees()">
                        <option value="3">3 Ù†ÙØ± Ø¨Ø±ØªØ±</option>
                        <option value="5">5 Ù†ÙØ± Ø¨Ø±ØªØ±</option>
                        <option value="10">10 Ù†ÙØ± Ø¨Ø±ØªØ±</option>
                    </select>
                </div>
            </div>
            <div class="star-employees-grid" id="star-employees-grid"></div>
        </div>
    </div>

    <!-- ===== MANAGE EMPLOYEES ===== -->
    <div id="manage-employees-section" class="section">
        <div class="card">
            <h2 class="card-title">ğŸ‘¤ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù†</h2>
            <div class="card" style="background: linear-gradient(135deg, #f0f9ff 0%, #dbeafe 100%); margin-bottom:22px;">
                <h3 style="font-size:17px; margin-bottom:14px;">â• Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ù…Ù†Ø¯ Ø¬Ø¯ÛŒØ¯</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ *</label>
                        <input type="text" id="new-emp-name" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù„ÛŒ Ø§Ø­Ù…Ø¯ÛŒ">
                    </div>
                    <div class="form-group">
                        <label>Ø¨Ø®Ø´ *</label>
                        <select id="new-emp-department"><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option></select>
                    </div>
                    <div class="form-group">
                        <label>Ø³Ù…Øª</label>
                        <input type="text" id="new-emp-position" placeholder="Ù…Ø«Ø§Ù„: Ú©Ø§Ø±Ø´Ù†Ø§Ø³ ÙØ±ÙˆØ´">
                    </div>
                    <div class="form-group">
                        <label>Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ</label>
                        <input type="text" id="new-emp-code" placeholder="Ù…Ø«Ø§Ù„: 1001">
                    </div>
                    <div class="form-group">
                        <label>Ø¹Ú©Ø³ (URL)</label>
                        <input type="text" id="new-emp-photo" placeholder="https://...">
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="addNewEmployee()">âœ… Ø§ÙØ²ÙˆØ¯Ù†</button>
                    <button class="btn btn-secondary" onclick="clearEmployeeForm()">ğŸ”„ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
                </div>
            </div>
            <div class="card">
                <h3 style="font-size:17px; margin-bottom:14px;">ğŸ“‹ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù†</h3>
                <div class="criteria-list" id="employees-management-list"></div>
            </div>
        </div>
    </div>

    <!-- ===== DEPARTMENTS SECTION ===== -->
    <div id="departments-section" class="section">
        <div class="card">
            <h2 class="card-title">ğŸ¢ Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø®Ø´â€ŒÙ‡Ø§ Ùˆ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§</h2>
            <div class="alert alert-warning">âš ï¸ Ù‡Ø± Ø¨Ø®Ø´ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù…Ø®ØµÙˆØµ Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø§Ø±Ø¯.</div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="showAddDepartmentModal()">â• Ø¨Ø®Ø´ Ø¬Ø¯ÛŒØ¯</button>
                <button class="btn btn-secondary" onclick="resetToDefaultDepartments()">ğŸ”„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶</button>
            </div>
            <div class="departments-grid" id="departments-grid"></div>
        </div>
    </div>
</div>

<!-- ===== MODALS ===== -->
<!-- Criteria Modal -->
<div id="criteria-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">ÙˆÛŒØ±Ø§ÛŒØ´ Ø¨Ø®Ø´</h2>
            <button class="modal-close" onclick="closeCriteriaModal()">Ã—</button>
        </div>
        <div class="form-grid" style="margin-bottom:20px;">
            <div class="form-group">
                <label>Ù†Ø§Ù… Ø¨Ø®Ø´</label>
                <input type="text" id="modal-department-name-input" class="criteria-name-input">
            </div>
            <div class="form-group">
                <label>Ø¢ÛŒÚ©ÙˆÙ†</label>
                <input type="text" id="modal-department-icon-input" class="criteria-name-input" maxlength="2">
            </div>
        </div>
        <div id="modal-department-badge"></div>
        <h3 style="font-size:17px; margin-bottom:13px;">ğŸ“‹ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</h3>
        <div class="criteria-list" id="modal-criteria-list"></div>
        <div class="btn-group">
            <button class="btn btn-success" onclick="saveDepartmentCriteria()">âœ… Ø°Ø®ÛŒØ±Ù‡</button>
            <button class="btn btn-primary" onclick="addNewCriteriaToModal()">â• Ù…Ø¹ÛŒØ§Ø± Ø¬Ø¯ÛŒØ¯</button>
            <button class="btn btn-danger" onclick="deleteDepartment()">ğŸ—‘ï¸ Ø­Ø°Ù Ø¨Ø®Ø´</button>
        </div>
    </div>
</div>

<!-- Add Department Modal -->
<div id="add-department-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">â• Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ø®Ø´ Ø¬Ø¯ÛŒØ¯</h2>
            <button class="modal-close" onclick="closeAddDepartmentModal()">Ã—</button>
        </div>
        <div class="form-group" style="margin-bottom:16px;">
            <label>Ù†Ø§Ù… Ø¨Ø®Ø´</label>
            <input type="text" id="new-department-name" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ÛŒ">
        </div>
        <div class="form-group" style="margin-bottom:20px;">
            <label>Ø¢ÛŒÚ©ÙˆÙ†</label>
            <input type="text" id="new-department-icon" placeholder="Ù…Ø«Ø§Ù„: ğŸ“¢" maxlength="2">
        </div>
        <div class="btn-group">
            <button class="btn btn-success" onclick="createNewDepartment()">âœ… Ø§ÛŒØ¬Ø§Ø¯</button>
        </div>
    </div>
</div>

<!-- Edit Employee Modal -->
<div id="edit-employee-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±Ù…Ù†Ø¯</h2>
            <button class="modal-close" onclick="closeEditEmployeeModal()">Ã—</button>
        </div>
        <div class="form-grid">
            <div class="form-group">
                <label>Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ *</label>
                <input type="text" id="edit-emp-name">
            </div>
            <div class="form-group">
                <label>Ø¨Ø®Ø´ *</label>
                <select id="edit-emp-department"><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option></select>
            </div>
            <div class="form-group">
                <label>Ø³Ù…Øª</label>
                <input type="text" id="edit-emp-position">
            </div>
            <div class="form-group">
                <label>Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ</label>
                <input type="text" id="edit-emp-code">
            </div>
            <div class="form-group" style="grid-column: 1 / -1;">
                <label>Ø¹Ú©Ø³ (URL)</label>
                <input type="text" id="edit-emp-photo">
            </div>
        </div>
        <div class="btn-group">
            <button class="btn btn-success" onclick="saveEditedEmployee()">âœ… Ø°Ø®ÛŒØ±Ù‡</button>
            <button class="btn btn-secondary" onclick="closeEditEmployeeModal()">âŒ Ø§Ù†ØµØ±Ø§Ù</button>
        </div>
    </div>
</div>



</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODULE: ØªØ§Ù…ÛŒÙ†
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="module-panel" id="supply-module">
<div id="supply-app">

  <!-- HEADER -->
  <div class="header">
    <div class="header-brand">
      <div class="header-icon">âš™ï¸</div>
      <div>
        <div class="header-title">Ø¨Ø®Ø´ ØªØ§Ù…ÛŒÙ† â€” Ø´Ø±Ú©Øª Ø¨Ø§Ø²Ø±Ú¯Ø§Ù†ÛŒ ÙÙˆÙ„Ø§Ø¯</div>
        <div class="header-sub">Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø­ØµÙˆÙ„Ø§ØªØŒ Ú©Ø§Ø±Ø®Ø§Ù†Ø¬Ø§Øª Ùˆ Ù‚ÛŒÙ…Øªâ€ŒÚ¯Ø°Ø§Ø±ÛŒ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ</div>
      </div>
    </div>
    <div class="header-meta">
      <div class="live-badge"><div class="live-dot"></div>Real-time</div>
      <div class="clock-badge" id="clock">â€”</div>
    </div>
  </div>

  <!-- STAT STRIP -->
  <div class="stat-strip">
    <div class="stat-card blue">
      <div class="stat-icon">ğŸ“¦</div>
      <div class="stat-val" id="stat-products">0</div>
      <div class="stat-label">Ù…Ø­ØµÙˆÙ„Ø§Øª Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡</div>
    </div>
    <div class="stat-card teal">
      <div class="stat-icon">ğŸ­</div>
      <div class="stat-val" id="stat-factories">0</div>
      <div class="stat-label">Ú©Ø§Ø±Ø®Ø§Ù†Ø¬Ø§Øª ÙØ¹Ø§Ù„</div>
    </div>
    <div class="stat-card green">
      <div class="stat-icon">ğŸ’°</div>
      <div class="stat-val" id="stat-prices">0</div>
      <div class="stat-label">Ø±Ú©ÙˆØ±Ø¯ Ù‚ÛŒÙ…Øª</div>
    </div>
    <div class="stat-card orange">
      <div class="stat-icon">ğŸ•</div>
      <div class="stat-val" id="stat-today">0</div>
      <div class="stat-label">Ø¢Ù¾Ø¯ÛŒØª Ø§Ù…Ø±ÙˆØ²</div>
    </div>
  </div>

  <!-- NAV -->
  <div id="supply-nav">
    <button class="supply-nav-btn active" onclick="supplyTab('prices',this)">
      ğŸ’° Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ <span class="nav-count" id="nc-prices">0</span>
    </button>
    <button class="supply-nav-btn" onclick="supplyTab('products',this)">
      ğŸ“¦ Ù…Ø­ØµÙˆÙ„Ø§Øª <span class="nav-count" id="nc-products">0</span>
    </button>
    <button class="supply-nav-btn" onclick="supplyTab('factories',this)">
      ğŸ­ Ú©Ø§Ø±Ø®Ø§Ù†Ø¬Ø§Øª <span class="nav-count" id="nc-factories">0</span>
    </button>
    <button class="supply-nav-btn" onclick="supplyTab('analytics',this)">
      ğŸ“Š ØªØ­Ù„ÛŒÙ„ Ù‡ÙØªÚ¯ÛŒ
    </button>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PRICES SECTION
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="supply-prices-section" class="supply-section active">

    <!-- ADD PRICE FORM -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">â• Ø«Ø¨Øª / Ø¢Ù¾Ø¯ÛŒØª Ù‚ÛŒÙ…Øª Ø¬Ø¯ÛŒØ¯</div>
        <button class="btn btn-ghost btn-sm" onclick="toggleAddForm()">
          <span id="toggle-icon">â–²</span> Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† ÙØ±Ù…
        </button>
      </div>
      <div id="add-form-wrap">
        <div class="form-add-section">
          <div class="form-row">
            <div class="form-group">
              <div class="form-label">Ù†ÙˆØ¹ Ø¨Ø§Ø± *</div>
              <select class="form-select" id="p-product">
                <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø­ØµÙˆÙ„...</option>
              </select>
            </div>
            <div class="form-group">
              <div class="form-label">Ø³Ø§ÛŒØ² *</div>
              <input class="form-input" id="p-size" placeholder="Ù…Ø«Ø§Ù„: Û±Û´ ÛŒØ§ Û±Û°Ã—Û±Û°">
            </div>
            <div class="form-group">
              <div class="form-label">Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ *</div>
              <select class="form-select" id="p-factory">
                <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø®Ø§Ù†Ù‡...</option>
              </select>
            </div>
            <div class="form-group">
              <div class="form-label">Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù† / Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…) *</div>
              <input class="form-input" id="p-price" type="number" placeholder="Ù…Ø«Ø§Ù„: 45000">
            </div>
            <div class="form-group">
              <div class="form-label">ØªÙˆØ¶ÛŒØ­Ø§Øª</div>
              <input class="form-input" id="p-note" placeholder="Ø§Ø®ØªÛŒØ§Ø±ÛŒ...">
            </div>
          </div>
          <div class="btn-group">
            <button class="btn btn-accent" onclick="addPrice()">âœ… Ø«Ø¨Øª Ù‚ÛŒÙ…Øª</button>
            <button class="btn btn-ghost" onclick="clearPriceForm()">ğŸ”„ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
          </div>
        </div>
      </div>
    </div>

    <!-- PRICE TABLE -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§</div>
        <div style="font-size:12px;color:var(--text-light);">Ø¢Ù¾Ø¯ÛŒØª Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø§ ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª</div>
      </div>

      <!-- TOOLBAR -->
      <div class="toolbar">
        <div class="search-wrap">
          <span class="icon">ğŸ”</span>
          <input class="search-input" id="price-search" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù…Ø­ØµÙˆÙ„ØŒ Ø³Ø§ÛŒØ²ØŒ Ú©Ø§Ø±Ø®Ø§Ù†Ù‡..."
            oninput="renderPriceTable()">
        </div>
        <select class="filter-select" id="filter-product" onchange="renderPriceTable()">
          <option value="">Ù‡Ù…Ù‡ Ù…Ø­ØµÙˆÙ„Ø§Øª</option>
        </select>
        <select class="filter-select" id="filter-factory" onchange="renderPriceTable()">
          <option value="">Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø®Ø§Ù†Ø¬Ø§Øª</option>
        </select>
        <button class="btn btn-ghost btn-sm" onclick="exportCSV()">ğŸ“¥ Ø®Ø±ÙˆØ¬ÛŒ CSV</button>
      </div>

      <div class="table-wrap">
        <table class="data-table">
          <thead>
            <tr>
              <th>Ù†ÙˆØ¹ Ø¨Ø§Ø±</th>
              <th>Ø³Ø§ÛŒØ²</th>
              <th>Ú©Ø§Ø±Ø®Ø§Ù†Ù‡</th>
              <th>Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†/Ú©ÛŒÙ„Ùˆ)</th>
              <th>ØªØºÛŒÛŒØ±</th>
              <th>Ø¢Ø®Ø±ÛŒÙ† Ø¢Ù¾Ø¯ÛŒØª</th>
              <th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
              <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
            </tr>
          </thead>
          <tbody id="price-tbody"></tbody>
        </table>
      </div>
      <div id="price-empty" class="empty" style="display:none;">
        <div class="empty-icon">ğŸ’°</div>
        <div class="empty-text">Ù‡Ù†ÙˆØ² Ù‚ÛŒÙ…ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>
        <div class="empty-sub">Ø§Ø² ÙØ±Ù… Ø¨Ø§Ù„Ø§ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PRODUCTS SECTION
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="supply-products-section" class="supply-section">
    <div class="card">
      <div class="card-header">
        <div class="card-title">ğŸ“¦ Ù„ÛŒØ³Øª Ù…Ø­ØµÙˆÙ„Ø§Øª</div>
        <button class="btn btn-accent" onclick="openProductModal()">â• Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØµÙˆÙ„</button>
      </div>
      <div class="grid-cards" id="products-grid">
        <div class="empty">
          <div class="empty-icon">ğŸ“¦</div>
          <div class="empty-text">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FACTORIES SECTION
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="supply-factories-section" class="supply-section">
    <div class="card">
      <div class="card-header">
        <div class="card-title">ğŸ­ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø®Ø§Ù†Ø¬Ø§Øª</div>
        <button class="btn btn-accent" onclick="openFactoryModal()">â• Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø®Ø§Ù†Ù‡</button>
      </div>
      <div class="grid-cards" id="factories-grid">
        <div class="empty">
          <div class="empty-icon">ğŸ­</div>
          <div class="empty-text">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ANALYTICS SECTION
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="supply-analytics-section" class="supply-section">

    <!-- Filter bar -->
    <div class="card" style="padding:16px 22px;">
      <div style="display:flex;align-items:center;gap:14px;flex-wrap:wrap;">
        <div class="card-title" style="margin-bottom:0;font-size:15px;">ğŸ” ÙÛŒÙ„ØªØ± Ù†Ù…ÙˆØ¯Ø§Ø±</div>
        <select class="filter-select" id="chart-product-filter" onchange="renderAnalytics()">
          <option value="">Ù‡Ù…Ù‡ Ù…Ø­ØµÙˆÙ„Ø§Øª</option>
        </select>
        <select class="filter-select" id="chart-factory-filter" onchange="renderAnalytics()">
          <option value="">Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø®Ø§Ù†Ø¬Ø§Øª</option>
        </select>
        <div class="period-tabs">
          <button class="period-tab active" onclick="setPeriod(7,this)">Û· Ø±ÙˆØ²</button>
          <button class="period-tab" onclick="setPeriod(14,this)">Û±Û´ Ø±ÙˆØ²</button>
          <button class="period-tab" onclick="setPeriod(30,this)">Û³Û° Ø±ÙˆØ²</button>
        </div>
      </div>
    </div>

    <div class="chart-grid">
      <!-- Price trend -->
      <div class="chart-card" style="grid-column:1/-1;">
        <div class="chart-header">
          <div>
            <div class="chart-title">ğŸ“ˆ Ø±ÙˆÙ†Ø¯ Ù‚ÛŒÙ…Øª Ù‡ÙØªÚ¯ÛŒ</div>
            <div class="chart-subtitle" id="chart-range-label">Û· Ø±ÙˆØ² Ú¯Ø°Ø´ØªÙ‡</div>
          </div>
        </div>
        <div class="chart-wrap">
          <canvas id="trendChart" height="90"></canvas>
        </div>
      </div>

      <!-- Product distribution -->
      <div class="chart-card">
        <div class="chart-header">
          <div>
            <div class="chart-title">ğŸ¥§ ØªÙˆØ²ÛŒØ¹ Ø«Ø¨Øª Ù‚ÛŒÙ…Øª Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ù…Ø­ØµÙˆÙ„</div>
            <div class="chart-subtitle">Ø¯Ø±ØµØ¯ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§</div>
          </div>
        </div>
        <canvas id="productPieChart" height="200"></canvas>
      </div>

      <!-- Factory comparison -->
      <div class="chart-card">
        <div class="chart-header">
          <div>
            <div class="chart-title">ğŸ­ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù‚ÛŒÙ…Øª Ú©Ø§Ø±Ø®Ø§Ù†Ø¬Ø§Øª</div>
            <div class="chart-subtitle">ØªÙˆÙ…Ø§Ù† / Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…</div>
          </div>
        </div>
        <canvas id="factoryBarChart" height="200"></canvas>
      </div>

      <!-- Update frequency -->
      <div class="chart-card">
        <div class="chart-header">
          <div>
            <div class="chart-title">ğŸ“… ÙØ±Ø§ÙˆØ§Ù†ÛŒ Ø¢Ù¾Ø¯ÛŒØª Ø±ÙˆØ²Ø§Ù†Ù‡</div>
            <div class="chart-subtitle">ØªØ¹Ø¯Ø§Ø¯ Ø¢Ù¾Ø¯ÛŒØª Ø¯Ø± Ù‡Ø± Ø±ÙˆØ²</div>
          </div>
        </div>
        <canvas id="updateFreqChart" height="200"></canvas>
      </div>

      <!-- Min/Max table -->
      <div class="chart-card">
        <div class="chart-header">
          <div>
            <div class="chart-title">ğŸ“Š Ø­Ø¯Ø§Ù‚Ù„ / Ø­Ø¯Ø§Ú©Ø«Ø± Ù‚ÛŒÙ…Øª</div>
            <div class="chart-subtitle">Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ù…Ø­ØµÙˆÙ„</div>
          </div>
        </div>
        <div id="minmax-table-wrap"></div>
      </div>
    </div>
  </div>

</div><!-- /supply-app -->

<!-- PRODUCT MODAL -->
<div class="modal" id="s-product-modal">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title" id="product-modal-title">ğŸ“¦ Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØµÙˆÙ„</div>
      <button class="modal-close" onclick="closeModal('s-product-modal')">Ã—</button>
    </div>
    <div class="form-group" style="margin-bottom:16px;">
      <div class="form-label">Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„ *</div>
      <input class="form-input" id="prod-name" placeholder="Ù…Ø«Ø§Ù„: Ù†Ø¨Ø´ÛŒØŒ Ù…ÛŒÙ„Ú¯Ø±Ø¯ØŒ Ù†Ø§ÙˆØ¯Ø§Ù†ÛŒ...">
    </div>
    <div class="form-group" style="margin-bottom:16px;">
      <div class="form-label">Ø¢ÛŒÚ©ÙˆÙ†</div>
      <input class="form-input" id="prod-icon" placeholder="ğŸ”©" maxlength="2">
    </div>
    <div class="form-group" style="margin-bottom:16px;">
      <div class="form-label">ÙˆØ§Ø­Ø¯ Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ</div>
      <select class="form-select" id="prod-unit">
        <option value="Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…">Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…</option>
        <option value="ØªÙ†">ØªÙ†</option>
        <option value="Ø´Ø§Ø®Ù‡">Ø´Ø§Ø®Ù‡</option>
        <option value="Ù…ØªØ±">Ù…ØªØ±</option>
      </select>
    </div>
    <div class="form-group" style="margin-bottom:22px;">
      <div class="form-label">ØªÙˆØ¶ÛŒØ­Ø§Øª</div>
      <input class="form-input" id="prod-desc" placeholder="Ø§Ø®ØªÛŒØ§Ø±ÛŒ...">
    </div>
    <div class="btn-group">
      <button class="btn btn-accent" onclick="saveProduct()">âœ… Ø°Ø®ÛŒØ±Ù‡</button>
      <button class="btn btn-ghost" onclick="closeModal('s-product-modal')">Ø§Ù†ØµØ±Ø§Ù</button>
    </div>
  </div>
</div>

<!-- FACTORY MODAL -->
<div class="modal" id="s-factory-modal">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title" id="factory-modal-title">ğŸ­ Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø®Ø§Ù†Ù‡</div>
      <button class="modal-close" onclick="closeModal('s-factory-modal')">Ã—</button>
    </div>
    <div class="form-row">
      <div class="form-group">
        <div class="form-label">Ù†Ø§Ù… Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ *</div>
        <input class="form-input" id="fac-name" placeholder="Ù…Ø«Ø§Ù„: Ø°ÙˆØ¨â€ŒØ¢Ù‡Ù† Ø§ØµÙÙ‡Ø§Ù†">
      </div>
      <div class="form-group">
        <div class="form-label">Ø´Ù‡Ø±</div>
        <input class="form-input" id="fac-city" placeholder="Ù…Ø«Ø§Ù„: Ø§ØµÙÙ‡Ø§Ù†">
      </div>
    </div>
    <div class="form-group" style="margin-bottom:16px;">
      <div class="form-label">Ù…Ø­ØµÙˆÙ„Ø§Øª ØªÙˆÙ„ÛŒØ¯ÛŒ</div>
      <input class="form-input" id="fac-products" placeholder="Ù…Ø«Ø§Ù„: Ù…ÛŒÙ„Ú¯Ø±Ø¯ØŒ ØªÛŒØ±Ø¢Ù‡Ù†">
    </div>
    <div class="form-row">
      <div class="form-group">
        <div class="form-label">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³</div>
        <input class="form-input" id="fac-tel" placeholder="0311-...">
      </div>
      <div class="form-group">
        <div class="form-label">ÙˆØ¶Ø¹ÛŒØª</div>
        <select class="form-select" id="fac-status">
          <option value="ÙØ¹Ø§Ù„">ÙØ¹Ø§Ù„</option>
          <option value="ØºÛŒØ±ÙØ¹Ø§Ù„">ØºÛŒØ±ÙØ¹Ø§Ù„</option>
          <option value="Ø¯Ø± Ø­Ø§Ù„ Ù…Ø°Ø§Ú©Ø±Ù‡">Ø¯Ø± Ø­Ø§Ù„ Ù…Ø°Ø§Ú©Ø±Ù‡</option>
        </select>
      </div>
    </div>
    <div class="form-group" style="margin:14px 0 22px;">
      <div class="form-label">ØªÙˆØ¶ÛŒØ­Ø§Øª</div>
      <input class="form-input" id="fac-note" placeholder="Ø§Ø®ØªÛŒØ§Ø±ÛŒ...">
    </div>
    <div class="btn-group">
      <button class="btn btn-accent" onclick="saveFactory()">âœ… Ø°Ø®ÛŒØ±Ù‡</button>
      <button class="btn btn-ghost" onclick="closeModal('s-factory-modal')">Ø§Ù†ØµØ±Ø§Ù</button>
    </div>
  </div>
</div>

<!-- EDIT PRICE MODAL -->
<div class="modal" id="s-edit-price-modal">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ù‚ÛŒÙ…Øª</div>
      <button class="modal-close" onclick="closeModal('s-edit-price-modal')">Ã—</button>
    </div>
    <div class="form-row">
      <div class="form-group">
        <div class="form-label">Ù†ÙˆØ¹ Ø¨Ø§Ø± *</div>
        <select class="form-select" id="ep-product"></select>
      </div>
      <div class="form-group">
        <div class="form-label">Ø³Ø§ÛŒØ² *</div>
        <input class="form-input" id="ep-size">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <div class="form-label">Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ *</div>
        <select class="form-select" id="ep-factory"></select>
      </div>
      <div class="form-group">
        <div class="form-label">Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù† / Ú©ÛŒÙ„Ùˆ) *</div>
        <input class="form-input" id="ep-price" type="number">
      </div>
    </div>
    <div class="form-group" style="margin-bottom:22px;">
      <div class="form-label">ØªÙˆØ¶ÛŒØ­Ø§Øª</div>
      <input class="form-input" id="ep-note">
    </div>
    <div class="btn-group">
      <button class="btn btn-accent" onclick="saveEditedPrice()">âœ… Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
      <button class="btn btn-ghost" onclick="closeModal('s-edit-price-modal')">Ø§Ù†ØµØ±Ø§Ù</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="s-toast" id="s-toast"></div>


</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MASTER SCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â”€â”€ Master module switcher â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let activeModule = null;

function switchModule(mod) {
    document.querySelectorAll('.module-panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.master-module-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(mod + '-module').classList.add('active');
    document.getElementById('btn-' + mod).classList.add('active');
    activeModule = mod;
    sessionStorage.setItem('activeModule', mod);

    // Supply module init on first visit
    if (mod === 'supply' && !window._supplyInited) {
        window._supplyInited = true;
        supplyDOMReady();
    }
}

// Master clock
function masterClock() {
    const now = new Date();
    document.getElementById('master-clock').textContent =
        now.toLocaleDateString('fa-IR') + '  ' + now.toLocaleTimeString('fa-IR');
    // Also update supply clock if visible
    const sc = document.getElementById('clock');
    if (sc) sc.textContent = now.toLocaleDateString('fa-IR') + '  ' + now.toLocaleTimeString('fa-IR');
}
setInterval(masterClock, 1000);
masterClock();

// Master logout (delegates to eval's doLogout)
function masterLogout() {
    if (typeof doLogout === 'function') doLogout();
}

// After eval login, show master module buttons + user badge
const _origDoLogin = window.doLogin;

// Hook into eval's login/logout to update master nav
function syncMasterNav() {
    const mgr = sessionStorage.getItem('currentManager');
    const masterUser = document.getElementById('master-user-badge');
    const masterLogoutBtn = document.getElementById('master-logout-btn');
    const masterNav = document.getElementById('master-nav');
    if (mgr) {
        document.getElementById('master-user-name').textContent = mgr;
        masterUser.style.display = 'flex';
        masterLogoutBtn.style.display = 'block';
        masterNav.classList.remove('login-mode');
        // Auto-open eval module after login
        if (!activeModule) switchModule('eval');
    } else {
        masterUser.style.display = 'none';
        masterLogoutBtn.style.display = 'none';
        masterNav.classList.add('login-mode');
    }
}

// Poll for login state changes
setInterval(syncMasterNav, 500);
syncMasterNav();

// Restore last active module
// Called by the last script block after everything is loaded
function masterInit() {
    const saved = sessionStorage.getItem('activeModule');
    const mgr = sessionStorage.getItem('currentManager');
    if (mgr && saved) {
        switchModule(saved);
    } else {
        switchModule('eval');
    }
    syncMasterNav();
}
</script>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     EVALUATION SCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>

// ==========================================
// ğŸ”¥ FIREBASE CONFIGURATION
// ==========================================
const firebaseConfig = {
    apiKey: "AIzaSyDeKK6THwUcR2hoh-VUiwAX7p79NL6UPQQ",
    authDomain: "employee-evaluation-adva-9231e.firebaseapp.com",
    projectId: "employee-evaluation-adva-9231e",
    storageBucket: "employee-evaluation-adva-9231e.firebasestorage.app",
    messagingSenderId: "151913486905",
    appId: "1:151913486905:web:b6c183ae02c67fd4368be8",
    measurementId: "G-ZREV957FB8"
};

let database = null;
let isFirebaseConfigured = false;

try {
    if (firebaseConfig.apiKey !== "YOUR-API-KEY-HERE") {
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        isFirebaseConfigured = true;
        console.log('âœ… Firebase initialized!');
    }
} catch(e) {
    console.error('Firebase error:', e);
}

// ==========================================
// AUTH / SESSION
// ==========================================
let currentManager = null;

function doLogin() {
    const sel = document.getElementById('login-manager-select');
    const err = document.getElementById('login-error');
    if (!sel.value) {
        err.style.display = 'flex';
        return;
    }
    err.style.display = 'none';
    currentManager = sel.value;
    sessionStorage.setItem('currentManager', currentManager);

    document.getElementById('login-overlay').style.display = 'none';
    document.getElementById('main-app').style.display = 'block';

    document.getElementById('current-manager-display').textContent = currentManager;
    document.getElementById('eval-manager-label').textContent = currentManager;

    sInitApp();
}

function doLogout() {
    if (confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ø² Ø³ÛŒØ³ØªÙ… Ø®Ø§Ø±Ø¬ Ø´ÙˆÛŒØ¯ØŸ')) {
        currentManager = null;
        sessionStorage.removeItem('currentManager');
        document.getElementById('main-app').style.display = 'none';
        document.getElementById('login-overlay').style.display = 'flex';
        document.getElementById('login-manager-select').value = '';
    }
}

// Check if already logged in
window.addEventListener('DOMContentLoaded', function() {
    const saved = sessionStorage.getItem('currentManager');
    if (saved) {
        document.getElementById('login-manager-select').value = saved;
        doLogin();
    }
    // Set default evaluation date
    const dateInput = document.getElementById('evaluation-date');
    if (dateInput) dateInput.valueAsDate = new Date();

    // Set star month to current
    const monthSel = document.getElementById('star-month-selector');
    if (monthSel) {
        const now = new Date();
        monthSel.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    }
});

// ==========================================
// DATA
// ==========================================
const defaultDepartments = {
    'ÙØ±ÙˆØ´': {
        name:'ÙØ±ÙˆØ´', icon:'ğŸ’°', class:'dept-sales',
        criteria:[
            {id:1,name:'ØªØ­Ù‚Ù‚ Ø§Ù‡Ø¯Ø§Ù ÙØ±ÙˆØ´',weight:20},
            {id:2,name:'Ù…Ø°Ø§Ú©Ø±Ù‡ Ùˆ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù…Ø´ØªØ±ÛŒ',weight:15},
            {id:3,name:'Ø¬Ø°Ø¨ Ù…Ø´ØªØ±ÛŒØ§Ù† Ø¬Ø¯ÛŒØ¯',weight:15},
            {id:4,name:'Ø­ÙØ¸ Ùˆ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ù…Ø´ØªØ±ÛŒ',weight:12},
            {id:5,name:'Ú¯Ø²Ø§Ø±Ø´â€ŒØ¯Ù‡ÛŒ Ùˆ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ',weight:10},
            {id:6,name:'Ø¯Ø§Ù†Ø´ Ù…Ø­ØµÙˆÙ„',weight:10},
            {id:7,name:'Ú©Ø§Ø± ØªÛŒÙ…ÛŒ',weight:8},
            {id:8,name:'Ø±Ø¹Ø§ÛŒØª Ø§ØµÙˆÙ„ Ø§Ø®Ù„Ø§Ù‚ÛŒ',weight:10}
        ]
    },
    'Ø¹Ù…Ù„ÛŒØ§Øª': {
        name:'Ø¹Ù…Ù„ÛŒØ§Øª', icon:'âš™ï¸', class:'dept-operations',
        criteria:[
            {id:1,name:'Ú©ÛŒÙÛŒØª Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡',weight:18},
            {id:2,name:'Ø±Ø¹Ø§ÛŒØª Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§',weight:15},
            {id:3,name:'Ù…Ø¯ÛŒØ±ÛŒØª Ø²Ù…Ø§Ù† Ùˆ Ø³Ø±Ø¹Øª',weight:13},
            {id:4,name:'Ø¨Ù‡Ø±Ù‡â€ŒÙˆØ±ÛŒ Ùˆ Ú©Ø§Ø±Ø§ÛŒÛŒ',weight:15},
            {id:5,name:'Ø§ÛŒÙ…Ù†ÛŒ Ùˆ Ø¨Ù‡Ø¯Ø§Ø´Øª',weight:12},
            {id:6,name:'Ø­Ù„ Ù…Ø³Ø§Ø¦Ù„ ÙÙ†ÛŒ',weight:10},
            {id:7,name:'Ù‡Ù…Ú©Ø§Ø±ÛŒ Ø¨Ø§ ØªÛŒÙ…',weight:9},
            {id:8,name:'Ù¾ÛŒØ´Ú¯ÛŒØ±ÛŒ Ø§Ø² Ø§ØªÙ„Ø§Ù Ù…Ù†Ø§Ø¨Ø¹',weight:8}
        ]
    },
    'Ù…Ù†Ø§Ø¨Ø¹ Ø§Ù†Ø³Ø§Ù†ÛŒ': {
        name:'Ù…Ù†Ø§Ø¨Ø¹ Ø§Ù†Ø³Ø§Ù†ÛŒ', icon:'ğŸ‘¥', class:'dept-hr',
        criteria:[
            {id:1,name:'Ø¬Ø°Ø¨ Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¤Ø«Ø±',weight:15},
            {id:2,name:'Ù…Ø¯ÛŒØ±ÛŒØª Ø¹Ù…Ù„Ú©Ø±Ø¯ Ú©Ø§Ø±Ú©Ù†Ø§Ù†',weight:15},
            {id:3,name:'Ø¢Ù…ÙˆØ²Ø´ Ùˆ ØªÙˆØ³Ø¹Ù‡',weight:13},
            {id:4,name:'Ø§Ø±ØªØ¨Ø§Ø·Ø§Øª Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ',weight:12},
            {id:5,name:'Ø±Ø¹Ø§ÛŒØª Ù‚ÙˆØ§Ù†ÛŒÙ† Ú©Ø§Ø±',weight:12},
            {id:6,name:'Ø­Ù„ ØªØ¹Ø§Ø±Ø¶Ø§Øª',weight:11},
            {id:7,name:'Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ù†ÛŒØ±ÙˆÛŒ Ø§Ù†Ø³Ø§Ù†ÛŒ',weight:12},
            {id:8,name:'Ø±Ø¶Ø§ÛŒØª Ú©Ø§Ø±Ú©Ù†Ø§Ù†',weight:10}
        ]
    },
    'Ù…Ø§Ù„ÛŒ': {
        name:'Ù…Ø§Ù„ÛŒ', icon:'ğŸ’µ', class:'dept-finance',
        criteria:[
            {id:1,name:'Ø¯Ù‚Øª Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ù…Ø§Ù„ÛŒ',weight:20},
            {id:2,name:'Ú¯Ø²Ø§Ø±Ø´â€ŒØ¯Ù‡ÛŒ Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹',weight:15},
            {id:3,name:'Ø±Ø¹Ø§ÛŒØª Ø§ØµÙˆÙ„ Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ',weight:15},
            {id:4,name:'Ú©Ù†ØªØ±Ù„ Ùˆ Ø¨ÙˆØ¯Ø¬Ù‡â€ŒØ¨Ù†Ø¯ÛŒ',weight:12},
            {id:5,name:'ØªØ­Ù„ÛŒÙ„ Ù…Ø§Ù„ÛŒ',weight:12},
            {id:6,name:'Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ù‚Ø¯ÛŒÙ†Ú¯ÛŒ',weight:10},
            {id:7,name:'Ø±Ø¹Ø§ÛŒØª Ù‚ÙˆØ§Ù†ÛŒÙ† Ù…Ø§Ù„ÛŒØ§ØªÛŒ',weight:8},
            {id:8,name:'Ù…Ø­Ø±Ù…Ø§Ù†Ú¯ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª',weight:8}
        ]
    },
    'IT': {
        name:'IT', icon:'ğŸ’»', class:'dept-it',
        criteria:[
            {id:1,name:'Ø­Ù„ Ù…Ø³Ø§Ø¦Ù„ ÙÙ†ÛŒ',weight:18},
            {id:2,name:'Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§',weight:15},
            {id:3,name:'Ø§Ù…Ù†ÛŒØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª',weight:16},
            {id:4,name:'ØªÙˆØ³Ø¹Ù‡ Ùˆ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ',weight:13},
            {id:5,name:'Ù…Ø³ØªÙ†Ø¯Ø³Ø§Ø²ÛŒ',weight:10},
            {id:6,name:'Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†',weight:12},
            {id:7,name:'ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ ØªÚ©Ù†ÙˆÙ„ÙˆÚ˜ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯',weight:8},
            {id:8,name:'Ú©Ø§Ø± ØªÛŒÙ…ÛŒ Ø¯Ø± Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§',weight:8}
        ]
    },
    'ØªÙˆÙ„ÛŒØ¯': {
        name:'ØªÙˆÙ„ÛŒØ¯', icon:'ğŸ­', class:'dept-production',
        criteria:[
            {id:1,name:'Ú©ÛŒÙÛŒØª Ù…Ø­ØµÙˆÙ„ ØªÙˆÙ„ÛŒØ¯ÛŒ',weight:20},
            {id:2,name:'Ø±Ø¹Ø§ÛŒØª Ø¨Ø±Ù†Ø§Ù…Ù‡ ØªÙˆÙ„ÛŒØ¯',weight:15},
            {id:3,name:'Ø¨Ù‡Ø±Ù‡â€ŒÙˆØ±ÛŒ Ø®Ø· ØªÙˆÙ„ÛŒØ¯',weight:15},
            {id:4,name:'Ú©Ø§Ù‡Ø´ Ø¶Ø§ÛŒØ¹Ø§Øª',weight:12},
            {id:5,name:'Ø§ÛŒÙ…Ù†ÛŒ Ùˆ Ø¨Ù‡Ø¯Ø§Ø´Øª Ú©Ø§Ø±',weight:12},
            {id:6,name:'Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ ØªØ¬Ù‡ÛŒØ²Ø§Øª',weight:10},
            {id:7,name:'Ù‡Ù…Ú©Ø§Ø±ÛŒ Ø¨Ø§ ØªÛŒÙ… ØªÙˆÙ„ÛŒØ¯',weight:8},
            {id:8,name:'Ø¨Ù‡Ø¨ÙˆØ¯ Ù…Ø³ØªÙ…Ø± ÙØ±Ø¢ÛŒÙ†Ø¯',weight:8}
        ]
    }
};

let departments = {};
let evaluations = [];
let employees = [];
let currentDepartment = null;
let currentEditingDepartment = null;
let currentEditingEmployee = null;

// ==========================================
// INIT
// ==========================================
function sInitApp() {
    // Firebase status
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');

    if (isFirebaseConfigured) {
        statusDot.style.background = '#10b981';
        statusDot.style.animation = 'pulse 2s infinite';
        statusText.textContent = 'Ù…ØªØµÙ„ Ø¨Ù‡ Firebase';
        database.ref('.info/connected').on('value', snap => {
            statusDot.style.background = snap.val() ? '#10b981' : '#ef4444';
            statusText.textContent = snap.val() ? 'Ù…ØªØµÙ„ Ø¨Ù‡ Firebase' : 'Ù‚Ø·Ø¹ Ø´Ø¯Ù‡';
        });
    } else {
        statusDot.style.background = '#f59e0b';
        statusText.textContent = 'Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ†';
    }

    loadDepartments();
    loadEvaluations();
    loadEmployees();

    // Set eval date
    document.getElementById('evaluation-date').valueAsDate = new Date();
}

// ==========================================
// DEPARTMENTS
// ==========================================
function loadDepartments() {
    if (isFirebaseConfigured) {
        database.ref('departments').on('value', snap => {
            departments = snap.exists() ? snap.val() : JSON.parse(JSON.stringify(defaultDepartments));
            if (!snap.exists()) database.ref('departments').set(departments);
            populateDepartmentDropdown();
            populateNewEmployeeDepartment();
            updateDepartmentsView();
        });
    } else {
        departments = JSON.parse(localStorage.getItem('departments')) || JSON.parse(JSON.stringify(defaultDepartments));
        populateDepartmentDropdown();
        populateNewEmployeeDepartment();
        updateDepartmentsView();
    }
}

function populateDepartmentDropdown() {
    const sel = document.getElementById('employee-department');
    sel.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>';
    Object.keys(departments).forEach(k => {
        const d = departments[k];
        sel.insertAdjacentHTML('beforeend', `<option value="${k}">${d.icon} ${d.name}</option>`);
    });
}

function populateNewEmployeeDepartment() {
    ['new-emp-department', 'edit-emp-department'].forEach(id => {
        const sel = document.getElementById(id);
        if (!sel) return;
        const cur = sel.value;
        sel.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>';
        Object.keys(departments).forEach(k => {
            const d = departments[k];
            sel.insertAdjacentHTML('beforeend', `<option value="${k}"${k===cur?' selected':''}>${d.icon} ${d.name}</option>`);
        });
    });
}

// ==========================================
// EVALUATIONS â€” FIREBASE AWARE
// ==========================================
function loadEvaluations() {
    if (isFirebaseConfigured) {
        database.ref('evaluations').on('value', snap => {
            evaluations = snap.exists() ? Object.values(snap.val()) : [];
            onEvaluationsUpdated();
        });
    } else {
        evaluations = JSON.parse(localStorage.getItem('sharedEvaluations')) || [];
        onEvaluationsUpdated();
    }
}

function onEvaluationsUpdated() {
    // Refresh whichever view is active
    const activeSection = document.querySelector('.section.active');
    if (!activeSection) return;
    const id = activeSection.id;
    if (id === 'my-history-section') renderMyHistory();
    if (id === 'shared-dashboard-section') renderSharedDashboard();
    if (id === 'star-employees-section') updateStarEmployees();
}

// ==========================================
// EMPLOYEES
// ==========================================
function loadEmployees() {
    if (isFirebaseConfigured) {
        database.ref('employees').on('value', snap => {
            employees = snap.exists() ? Object.values(snap.val()) : [];
            updateEmployeesManagementList();
        });
    } else {
        employees = JSON.parse(localStorage.getItem('employees')) || [];
        updateEmployeesManagementList();
    }
}

function populateEmployeeDropdown(filterDept = null) {
    const sel = document.getElementById('employee-name');
    let list = filterDept ? employees.filter(e => e.department === filterDept) : employees;
    list = [...list].sort((a,b) => a.name.localeCompare(b.name,'fa'));
    sel.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>';
    list.forEach(emp => {
        sel.insertAdjacentHTML('beforeend', `<option value="${emp.name}">${emp.name}</option>`);
    });
    if (list.length === 0) {
        sel.innerHTML = '<option value="">Ú©Ø§Ø±Ù…Ù†Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</option>';
    }
}

// ==========================================
// EVALUATION FORM
// ==========================================
function handleDepartmentChange() {
    const deptKey = document.getElementById('employee-department').value;
    populateEmployeeDropdown(deptKey || null);
    loadDepartmentCriteria();
}

function loadDepartmentCriteria() {
    const deptKey = document.getElementById('employee-department').value;
    if (!deptKey) {
        document.getElementById('evaluation-criteria').innerHTML = '';
        document.getElementById('department-badge-container').innerHTML = '';
        document.getElementById('total-score-container').style.display = 'none';
        currentDepartment = null;
        return;
    }
    currentDepartment = departments[deptKey];
    document.getElementById('department-badge-container').innerHTML =
        `<div class="department-badge ${currentDepartment.class}">${currentDepartment.icon} Ø¨Ø®Ø´ ${currentDepartment.name}</div>`;

    const container = document.getElementById('evaluation-criteria');
    container.innerHTML = '';
    currentDepartment.criteria.forEach(c => {
        container.insertAdjacentHTML('beforeend', `
            <div class="eval-section">
                <div class="eval-section-header">
                    <div class="eval-section-title">${c.name}</div>
                    <div class="eval-weight">Ø¶Ø±ÛŒØ¨: ${c.weight}</div>
                </div>
                <div class="score-slider-container">
                    <input type="range" min="1" max="10" value="5" class="score-slider"
                        id="slider-${c.id}" oninput="updateScore(${c.id},${c.weight})">
                    <div class="score-display" id="display-${c.id}">5</div>
                </div>
                <div class="weighted-score" id="weighted-${c.id}">Ø§Ù…ØªÛŒØ§Ø² ÙˆØ²Ù†ÛŒ: ${5*c.weight}</div>
            </div>
        `);
    });
    document.getElementById('total-score-container').style.display = 'block';
    calculateTotalScore();
}

function updateScore(id, weight) {
    const val = parseInt(document.getElementById(`slider-${id}`).value);
    document.getElementById(`display-${id}`).textContent = val;
    document.getElementById(`weighted-${id}`).textContent = `Ø§Ù…ØªÛŒØ§Ø² ÙˆØ²Ù†ÛŒ: ${val*weight}`;
    calculateTotalScore();
}

function calculateTotalScore() {
    if (!currentDepartment) return;
    let total = 0, maxScore = 0;
    currentDepartment.criteria.forEach(c => {
        const sl = document.getElementById(`slider-${c.id}`);
        if (sl) total += parseInt(sl.value) * c.weight;
        maxScore += 10 * c.weight;
    });
    document.getElementById('total-score').textContent = total;
    document.getElementById('max-score').textContent = maxScore;
}

function saveEvaluation() {
    const employeeName = document.getElementById('employee-name').value;
    const deptKey = document.getElementById('employee-department').value;
    const date = document.getElementById('evaluation-date').value;

    if (!employeeName || !deptKey || !date) {
        alert('âš ï¸ Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯!');
        return;
    }
    if (!currentDepartment) {
        alert('âš ï¸ Ø§Ø¨ØªØ¯Ø§ Ø¨Ø®Ø´ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯!');
        return;
    }

    const scores = {};
    currentDepartment.criteria.forEach(c => {
        const sl = document.getElementById(`slider-${c.id}`);
        if (sl) scores[c.id] = parseInt(sl.value);
    });

    const evaluation = {
        id: Date.now(),
        managerName: currentManager,           // â† Ø°Ø®ÛŒØ±Ù‡ Ù†Ø§Ù… Ù…Ø¯ÛŒØ± ÙØ¹Ù„ÛŒ
        employeeName,
        department: deptKey,
        departmentName: currentDepartment.name,
        date,
        scores,
        totalScore: parseInt(document.getElementById('total-score').textContent),
        maxScore: parseInt(document.getElementById('max-score').textContent),
        timestamp: new Date().toISOString(),
        criteriaSnapshot: JSON.parse(JSON.stringify(currentDepartment.criteria))
    };

    if (isFirebaseConfigured) {
        database.ref('evaluations/' + evaluation.id).set(evaluation)
            .then(() => {
                alert('âœ… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!');
                resetForm();
            })
            .catch(e => alert('âŒ Ø®Ø·Ø§: ' + e.message));
    } else {
        evaluations.push(evaluation);
        localStorage.setItem('sharedEvaluations', JSON.stringify(evaluations));
        alert('âœ… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!');
        resetForm();
        onEvaluationsUpdated();
    }
}

function resetForm() {
    document.getElementById('employee-name').value = '';
    document.getElementById('employee-department').value = '';
    document.getElementById('evaluation-date').valueAsDate = new Date();
    document.getElementById('evaluation-criteria').innerHTML = '';
    document.getElementById('department-badge-container').innerHTML = '';
    document.getElementById('total-score-container').style.display = 'none';
    currentDepartment = null;
}

// ==========================================
// MY HISTORY â€” ÙÙ‚Ø· Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† Ù…Ø¯ÛŒØ±
// ==========================================
function renderMyHistory() {
    const tbody = document.getElementById('my-history-tbody');
    const myEvals = evaluations.filter(e => e.managerName === currentManager);

    document.getElementById('my-history-info').innerHTML =
        `ğŸ“Œ ÙÙ‚Ø· Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡ ØªÙˆØ³Ø· <strong>${currentManager}</strong> â€” ØªØ¹Ø¯Ø§Ø¯: <strong>${myEvals.length}</strong> Ù…ÙˆØ±Ø¯`;

    if (myEvals.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:40px;">
            <div class="empty-state-icon">ğŸ“­</div><p>Ø´Ù…Ø§ Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯</p>
        </td></tr>`;
        return;
    }

    const sorted = [...myEvals].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
    tbody.innerHTML = sorted.map(ev => {
        const pct = (ev.totalScore / ev.maxScore * 100).toFixed(0);
        const cls = pct >= 70 ? 'badge-high' : pct >= 50 ? 'badge-medium' : 'badge-low';
        const rank = pct >= 70 ? 'Ø¹Ø§Ù„ÛŒ' : pct >= 50 ? 'Ø®ÙˆØ¨' : 'Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ù‡Ø¨ÙˆØ¯';
        return `<tr>
            <td>${new Date(ev.date).toLocaleDateString('fa-IR')}</td>
            <td><strong>${ev.employeeName}</strong></td>
            <td>${ev.departmentName}</td>
            <td><strong>${ev.totalScore}</strong> / ${ev.maxScore}</td>
            <td><span class="badge ${cls}">${rank} (${pct}%)</span></td>
            <td>
                <button class="btn btn-danger btn-sm" onclick="deleteEvaluation(${ev.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            </td>
        </tr>`;
    }).join('');
}

function deleteEvaluation(evalId) {
    // Ù…Ø¯ÛŒØ± ÙÙ‚Ø· Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ¯Ø´ Ø±Ø§ Ø­Ø°Ù Ù…ÛŒâ€ŒÚ©Ù†Ø¯
    const ev = evaluations.find(e => e.id === evalId);
    if (!ev) return;
    if (ev.managerName !== currentManager) {
        alert('â›” Ø´Ù…Ø§ Ù…Ø¬Ø§Ø² Ø¨Ù‡ Ø­Ø°Ù Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ Ø³Ø§ÛŒØ± Ù…Ø¯ÛŒØ±Ø§Ù† Ù†ÛŒØ³ØªÛŒØ¯!');
        return;
    }
    if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return;

    if (isFirebaseConfigured) {
        database.ref('evaluations/' + evalId).remove()
            .then(() => alert('âœ… Ø­Ø°Ù Ø´Ø¯!'))
            .catch(e => alert('âŒ Ø®Ø·Ø§: ' + e.message));
    } else {
        evaluations = evaluations.filter(e => e.id !== evalId);
        localStorage.setItem('sharedEvaluations', JSON.stringify(evaluations));
        alert('âœ… Ø­Ø°Ù Ø´Ø¯!');
        onEvaluationsUpdated();
    }
}

function exportMyEvaluations() {
    const myEvals = evaluations.filter(e => e.managerName === currentManager);
    if (myEvals.length === 0) { alert('âš ï¸ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!'); return; }
    const data = JSON.stringify({ manager: currentManager, evaluations: myEvals, exportDate: new Date().toISOString() }, null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `backup-${currentManager}-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a); a.click();
    document.body.removeChild(a); URL.revokeObjectURL(url);
    alert('âœ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!');
}

// ==========================================
// SHARED DASHBOARD â€” Ù‡Ù…Ù‡ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§
// ==========================================
function renderSharedDashboard() {
    // --- Summary stats ---
    const totalEvals = evaluations.length;
    const uniqueEmployees = new Set(evaluations.map(e => e.employeeName)).size;
    const uniqueManagers = new Set(evaluations.map(e => e.managerName)).size;
    const avgScore = totalEvals > 0
        ? (evaluations.reduce((s, e) => s + (e.totalScore / e.maxScore * 100), 0) / totalEvals).toFixed(1)
        : 0;

    document.getElementById('summary-stats').innerHTML = `
        <div class="stat-card blue">
            <div class="stat-number">${totalEvals}</div>
            <div class="stat-label">Ú©Ù„ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§</div>
        </div>
        <div class="stat-card green">
            <div class="stat-number">${uniqueEmployees}</div>
            <div class="stat-label">Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù† Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒØ´Ø¯Ù‡</div>
        </div>
        <div class="stat-card orange">
            <div class="stat-number">${uniqueManagers}</div>
            <div class="stat-label">Ù…Ø¯ÛŒØ±Ø§Ù† Ø§Ø±Ø²ÛŒØ§Ø¨</div>
        </div>
        <div class="stat-card purple">
            <div class="stat-number">${avgScore}%</div>
            <div class="stat-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ú©Ù„ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª</div>
        </div>
    `;

    // --- Global ranking ---
    const empMap = {};
    evaluations.forEach(ev => {
        if (!empMap[ev.employeeName]) {
            empMap[ev.employeeName] = {
                name: ev.employeeName, dept: ev.departmentName,
                totalScore: 0, totalMax: 0, count: 0
            };
        }
        empMap[ev.employeeName].totalScore += ev.totalScore;
        empMap[ev.employeeName].totalMax += ev.maxScore;
        empMap[ev.employeeName].count += 1;
    });

    const ranked = Object.values(empMap)
        .map(e => ({ ...e, avgPct: e.totalMax > 0 ? (e.totalScore / e.totalMax * 100) : 0 }))
        .sort((a, b) => b.avgPct - a.avgPct);

    const tbody = document.getElementById('global-ranking-tbody');
    if (ranked.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-light);">Ù‡Ù†ÙˆØ² Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td></tr>`;
    } else {
        tbody.innerHTML = ranked.map((emp, i) => {
            const rank = i + 1;
            const pct = emp.avgPct.toFixed(1);
            const color = emp.avgPct >= 70 ? '#059669' : emp.avgPct >= 50 ? '#d97706' : '#dc2626';
            const medal = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : rank;
            return `<tr class="${rank <= 3 ? 'rank-'+rank : ''}">
                <td style="font-size:20px;text-align:center;">${medal}</td>
                <td><strong>${emp.name}</strong></td>
                <td>${emp.dept}</td>
                <td style="text-align:center;">${emp.count}</td>
                <td style="text-align:center;font-weight:700;">${emp.totalScore.toLocaleString()}</td>
                <td style="text-align:center;font-weight:800;color:${color};">${pct}%</td>
                <td>
                    <div class="progress-bar-wrap">
                        <div class="progress-bar-fill" style="width:${pct}%;background:${color};"></div>
                    </div>
                </td>
            </tr>`;
        }).join('');
    }

    // --- Charts ---
    // Employee chart
    const ctx1 = document.getElementById('sharedEmployeesChart');
    if (window._empChart) window._empChart.destroy();
    const top10 = ranked.slice(0, 10);
    window._empChart = new Chart(ctx1, {
        type: 'bar',
        data: {
            labels: top10.map(e => e.name),
            datasets: [{
                label: 'Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø² (%)',
                data: top10.map(e => e.avgPct.toFixed(1)),
                backgroundColor: top10.map((_, i) =>
                    i===0 ? 'rgba(251,191,36,0.85)' :
                    i===1 ? 'rgba(156,163,175,0.85)' :
                    i===2 ? 'rgba(249,115,22,0.85)' : 'rgba(30,64,175,0.75)'
                ),
                borderRadius: 6
            }]
        },
        options: { responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{min:0,max:100} } }
    });

    // Department chart
    const deptMap = {};
    evaluations.forEach(ev => {
        deptMap[ev.departmentName] = (deptMap[ev.departmentName] || 0) + 1;
    });
    const ctx2 = document.getElementById('sharedDepartmentsChart');
    if (window._deptChart) window._deptChart.destroy();
    window._deptChart = new Chart(ctx2, {
        type: 'pie',
        data: {
            labels: Object.keys(deptMap),
            datasets: [{
                data: Object.values(deptMap),
                backgroundColor: ['rgba(5,150,105,0.8)','rgba(8,145,178,0.8)','rgba(124,58,237,0.8)',
                    'rgba(217,119,6,0.8)','rgba(220,38,38,0.8)','rgba(30,64,175,0.8)','rgba(236,72,153,0.8)']
            }]
        },
        options:{ responsive:true }
    });
}

// ==========================================
// STAR EMPLOYEES
// ==========================================
function updateStarEmployees() {
    const container = document.getElementById('star-employees-grid');
    const selMonth = document.getElementById('star-month-selector').value;
    const topCount = parseInt(document.getElementById('star-count-selector').value);

    if (!selMonth) {
        container.innerHTML = '<p style="text-align:center;color:var(--text-light);">Ù„Ø·ÙØ§Ù‹ Ù…Ø§Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p>';
        return;
    }
    const [year, month] = selMonth.split('-');
    const monthEvals = evaluations.filter(ev => {
        const d = new Date(ev.date);
        return d.getFullYear() == year && (d.getMonth()+1) == parseInt(month);
    });

    if (monthEvals.length === 0) {
        container.innerHTML = `<div class="empty-state" style="grid-column:1/-1;">
            <div class="empty-state-icon">ğŸ“­</div>
            <h3>Ù‡ÛŒÚ† Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ù…Ø§Ù‡ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</h3>
        </div>`;
        return;
    }

    const empMap = {};
    monthEvals.forEach(ev => {
        if (!empMap[ev.employeeName]) empMap[ev.employeeName] = { name:ev.employeeName, dept:ev.departmentName, sum:0, count:0 };
        empMap[ev.employeeName].sum += (ev.totalScore / ev.maxScore * 100);
        empMap[ev.employeeName].count += 1;
    });

    const ranked = Object.values(empMap)
        .map(e => ({ ...e, avg: e.sum / e.count }))
        .sort((a,b) => b.avg - a.avg)
        .slice(0, topCount);

    container.innerHTML = ranked.map((emp, i) => {
        const rank = i + 1;
        const empData = employees.find(e => e.name === emp.name);
        const photo = empData && empData.photo ? empData.photo : null;
        return `
            <div class="star-employee-card rank-${rank<=3?rank:''}">
                <div class="star-rank-badge rank-${rank<=3?rank:''}">${rank}</div>
                <div class="star-employee-photo">
                    ${photo ? `<img src="${photo}" alt="${emp.name}" onerror="this.parentElement.innerHTML='ğŸ‘¤'">` : 'ğŸ‘¤'}
                </div>
                <div class="star-employee-name">${emp.name}</div>
                <div class="star-employee-dept">${emp.dept}</div>
                <div class="star-employee-score">
                    <span class="star-score-value">${emp.avg.toFixed(1)}%</span>
                    <span class="star-score-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø² (${emp.count} Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ)</span>
                </div>
            </div>
        `;
    }).join('');
}

// ==========================================
// TAB SWITCHING
// ==========================================
function switchTab(tab, el) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.getElementById(`${tab}-section`).classList.add('active');
    if (el) el.classList.add('active');

    if (tab === 'my-history') renderMyHistory();
    if (tab === 'shared-dashboard') renderSharedDashboard();
    if (tab === 'star-employees') updateStarEmployees();
    if (tab === 'manage-employees') updateEmployeesManagementList();
    if (tab === 'departments') updateDepartmentsView();
}

// ==========================================
// EMPLOYEES MANAGEMENT
// ==========================================
function addNewEmployee() {
    const name = document.getElementById('new-emp-name').value.trim();
    const dept = document.getElementById('new-emp-department').value;
    const pos  = document.getElementById('new-emp-position').value.trim();
    const code = document.getElementById('new-emp-code').value.trim();
    const photo= document.getElementById('new-emp-photo').value.trim();

    if (!name || !dept) { alert('âš ï¸ Ù†Ø§Ù… Ùˆ Ø¨Ø®Ø´ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª!'); return; }
    if (employees.some(e => e.name.toLowerCase() === name.toLowerCase())) {
        alert('âš ï¸ Ú©Ø§Ø±Ù…Ù†Ø¯ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ù†Ø§Ù… Ù‚Ø¨Ù„Ø§Ù‹ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯!'); return;
    }

    const emp = {
        id: Date.now(), name, department: dept,
        departmentName: departments[dept].name,
        position: pos, code, photo, createdAt: new Date().toISOString()
    };

    if (isFirebaseConfigured) {
        database.ref('employees/' + emp.id).set(emp)
            .then(() => { alert('âœ… Ú©Ø§Ø±Ù…Ù†Ø¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯!'); clearEmployeeForm(); })
            .catch(e => alert('âŒ Ø®Ø·Ø§: ' + e.message));
    } else {
        employees.push(emp);
        localStorage.setItem('employees', JSON.stringify(employees));
        alert('âœ… Ú©Ø§Ø±Ù…Ù†Ø¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯!');
        clearEmployeeForm();
        updateEmployeesManagementList();
    }
}

function clearEmployeeForm() {
    ['new-emp-name','new-emp-position','new-emp-code','new-emp-photo'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('new-emp-department').value = '';
}

function updateEmployeesManagementList() {
    const container = document.getElementById('employees-management-list');
    if (!container) return;

    if (employees.length === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ‘¤</div>
            <h3>Ù‡Ù†ÙˆØ² Ú©Ø§Ø±Ù…Ù†Ø¯ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡</h3></div>`;
        return;
    }

    const sorted = [...employees].sort((a,b) => a.name.localeCompare(b.name,'fa'));
    container.innerHTML = sorted.map(emp => {
        const dept = departments[emp.department];
        return `
            <div class="employee-mgmt-card">
                <div>
                    <div style="font-weight:700;font-size:15px;margin-bottom:4px;">${emp.name}</div>
                    <div style="font-size:13px;color:var(--text-light);">
                        ${dept ? dept.icon+' '+dept.name : emp.departmentName}
                        ${emp.position ? ' â€¢ '+emp.position : ''}
                        ${emp.code ? ' â€¢ Ú©Ø¯: '+emp.code : ''}
                    </div>
                </div>
                <div style="display:flex;gap:8px;">
                    <button class="btn btn-primary btn-sm" onclick="editEmployee(${emp.id})">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteEmployee(${emp.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                </div>
            </div>
        `;
    }).join('');
}

function editEmployee(empId) {
    const emp = employees.find(e => e.id === empId);
    if (!emp) return;
    currentEditingEmployee = empId;
    document.getElementById('edit-emp-name').value = emp.name;
    document.getElementById('edit-emp-position').value = emp.position || '';
    document.getElementById('edit-emp-code').value = emp.code || '';
    document.getElementById('edit-emp-photo').value = emp.photo || '';
    populateNewEmployeeDepartment();
    document.getElementById('edit-emp-department').value = emp.department;
    document.getElementById('edit-employee-modal').classList.add('active');
}

function closeEditEmployeeModal() {
    document.getElementById('edit-employee-modal').classList.remove('active');
    currentEditingEmployee = null;
}

function saveEditedEmployee() {
    if (!currentEditingEmployee) return;
    const emp = employees.find(e => e.id === currentEditingEmployee);
    if (!emp) return;

    const newName = document.getElementById('edit-emp-name').value.trim();
    const newDept = document.getElementById('edit-emp-department').value;
    if (!newName || !newDept) { alert('âš ï¸ Ù†Ø§Ù… Ùˆ Ø¨Ø®Ø´ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª!'); return; }

    if (newName !== emp.name && employees.some(e => e.id !== currentEditingEmployee && e.name.toLowerCase() === newName.toLowerCase())) {
        alert('âš ï¸ Ø§ÛŒÙ† Ù†Ø§Ù… Ù‚Ø¨Ù„Ø§Ù‹ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯!'); return;
    }

    emp.name = newName;
    emp.department = newDept;
    emp.departmentName = departments[newDept].name;
    emp.position = document.getElementById('edit-emp-position').value.trim();
    emp.code     = document.getElementById('edit-emp-code').value.trim();
    emp.photo    = document.getElementById('edit-emp-photo').value.trim();

    if (isFirebaseConfigured) {
        database.ref('employees/' + currentEditingEmployee).set(emp)
            .then(() => { alert('âœ… ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯!'); closeEditEmployeeModal(); })
            .catch(e => alert('âŒ Ø®Ø·Ø§: ' + e.message));
    } else {
        localStorage.setItem('employees', JSON.stringify(employees));
        alert('âœ… ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯!');
        closeEditEmployeeModal();
        updateEmployeesManagementList();
    }
}

function deleteEmployee(empId) {
    const emp = employees.find(e => e.id === empId);
    if (!emp) return;
    if (!confirm(`Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù "${emp.name}" Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ`)) return;

    if (isFirebaseConfigured) {
        database.ref('employees/' + empId).remove()
            .then(() => alert('âœ… Ø­Ø°Ù Ø´Ø¯!'))
            .catch(e => alert('âŒ Ø®Ø·Ø§: ' + e.message));
    } else {
        employees = employees.filter(e => e.id !== empId);
        localStorage.setItem('employees', JSON.stringify(employees));
        alert('âœ… Ø­Ø°Ù Ø´Ø¯!');
        updateEmployeesManagementList();
    }
}

// ==========================================
// DEPARTMENTS VIEW
// ==========================================
function updateDepartmentsView() {
    const container = document.getElementById('departments-grid');
    if (!container) return;
    container.innerHTML = '';
    Object.keys(departments).forEach(k => {
        const d = departments[k];
        container.insertAdjacentHTML('beforeend', `
            <div class="department-card" onclick="openCriteriaModal('${k}')">
                <div class="department-header">
                    <div class="department-badge ${d.class}">${d.icon} ${d.name}</div>
                    <div class="criteria-count">${d.criteria.length} Ù…Ø¹ÛŒØ§Ø±</div>
                </div>
                <p style="color:var(--text-light);margin-top:10px;font-size:13px;">Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§</p>
            </div>
        `);
    });
}

function openCriteriaModal(deptKey) {
    currentEditingDepartment = deptKey;
    const d = departments[deptKey];
    document.getElementById('modal-department-name-input').value = d.name;
    document.getElementById('modal-department-icon-input').value = d.icon;
    document.getElementById('modal-department-badge').innerHTML =
        `<div class="department-badge ${d.class}" style="margin-bottom:18px;">${d.icon} ${d.name}</div>`;

    const list = document.getElementById('modal-criteria-list');
    list.innerHTML = '';
    d.criteria.forEach(c => {
        list.insertAdjacentHTML('beforeend', `
            <div class="criteria-item">
                <input type="text" class="criteria-name-input" value="${c.name}" id="modal-criteria-name-${c.id}">
                <input type="number" class="criteria-weight-input" value="${c.weight}" id="modal-criteria-weight-${c.id}" min="1" max="30">
                <button class="btn btn-danger btn-sm" onclick="deleteModalCriteria(${c.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            </div>
        `);
    });
    document.getElementById('criteria-modal').classList.add('active');
}

function closeCriteriaModal() {
    document.getElementById('criteria-modal').classList.remove('active');
    currentEditingDepartment = null;
}

function saveDepartmentCriteria() {
    const oldKey = currentEditingDepartment;
    const d = departments[oldKey];
    const newName = document.getElementById('modal-department-name-input').value.trim();
    const newIcon = document.getElementById('modal-department-icon-input').value.trim();
    if (!newName || !newIcon) { alert('âš ï¸ Ù†Ø§Ù… Ùˆ Ø¢ÛŒÚ©ÙˆÙ† Ø§Ù„Ø²Ø§Ù…ÛŒ!'); return; }

    const criteria = [];
    d.criteria.forEach(c => {
        const nm = document.getElementById(`modal-criteria-name-${c.id}`);
        const wt = document.getElementById(`modal-criteria-weight-${c.id}`);
        if (nm && wt) criteria.push({ id:c.id, name:nm.value, weight:parseInt(wt.value) });
    });

    if (newName !== oldKey) {
        departments[newName] = { name:newName, icon:newIcon, class:d.class, criteria };
        delete departments[oldKey];
    } else {
        departments[oldKey] = { ...d, name:newName, icon:newIcon, criteria };
    }

    const save = () => {
        if (isFirebaseConfigured) {
            database.ref('departments').set(departments)
                .then(() => { alert('âœ… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!'); closeCriteriaModal(); updateDepartmentsView(); populateDepartmentDropdown(); populateNewEmployeeDepartment(); })
                .catch(e => alert('âŒ Ø®Ø·Ø§: ' + e.message));
        } else {
            localStorage.setItem('departments', JSON.stringify(departments));
            alert('âœ… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!');
            closeCriteriaModal(); updateDepartmentsView(); populateDepartmentDropdown(); populateNewEmployeeDepartment();
        }
    };
    save();
}

function addNewCriteriaToModal() {
    const d = departments[currentEditingDepartment];
    const newId = Math.max(...d.criteria.map(c => c.id), 0) + 1;
    d.criteria.push({ id:newId, name:'Ù…Ø¹ÛŒØ§Ø± Ø¬Ø¯ÛŒØ¯', weight:10 });
    openCriteriaModal(currentEditingDepartment);
}

function deleteModalCriteria(id) {
    if (!confirm('Ø­Ø°Ù Ø§ÛŒÙ† Ù…Ø¹ÛŒØ§Ø±ØŸ')) return;
    departments[currentEditingDepartment].criteria = departments[currentEditingDepartment].criteria.filter(c => c.id !== id);
    openCriteriaModal(currentEditingDepartment);
}

function deleteDepartment() {
    const name = departments[currentEditingDepartment].name;
    if (!confirm(`Ø­Ø°Ù Ø¨Ø®Ø´ "${name}"ØŸ`)) return;
    delete departments[currentEditingDepartment];

    if (isFirebaseConfigured) {
        database.ref('departments').set(departments)
            .then(() => { alert('âœ… Ø¨Ø®Ø´ Ø­Ø°Ù Ø´Ø¯!'); closeCriteriaModal(); populateDepartmentDropdown(); populateNewEmployeeDepartment(); updateDepartmentsView(); })
            .catch(e => alert('âŒ Ø®Ø·Ø§: ' + e.message));
    } else {
        localStorage.setItem('departments', JSON.stringify(departments));
        alert('âœ… Ø¨Ø®Ø´ Ø­Ø°Ù Ø´Ø¯!');
        closeCriteriaModal(); populateDepartmentDropdown(); populateNewEmployeeDepartment(); updateDepartmentsView();
    }
}

function showAddDepartmentModal() { document.getElementById('add-department-modal').classList.add('active'); }
function closeAddDepartmentModal() {
    document.getElementById('add-department-modal').classList.remove('active');
    document.getElementById('new-department-name').value = '';
    document.getElementById('new-department-icon').value = '';
}

function createNewDepartment() {
    const name = document.getElementById('new-department-name').value.trim();
    const icon = document.getElementById('new-department-icon').value.trim();
    if (!name || !icon) { alert('âš ï¸ Ù†Ø§Ù… Ùˆ Ø¢ÛŒÚ©ÙˆÙ† Ø§Ù„Ø²Ø§Ù…ÛŒ!'); return; }
    departments[name] = { name, icon, class:'dept-sales', criteria:[
        {id:1,name:'Ú©ÛŒÙÛŒØª Ú©Ø§Ø±',weight:15},
        {id:2,name:'Ø­Ø¶ÙˆØ± Ùˆ ØºÛŒØ§Ø¨',weight:10},
        {id:3,name:'Ú©Ø§Ø± ØªÛŒÙ…ÛŒ',weight:10}
    ]};
    if (isFirebaseConfigured) {
        database.ref('departments').set(departments)
            .then(() => { alert('âœ… Ø¨Ø®Ø´ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯!'); closeAddDepartmentModal(); populateDepartmentDropdown(); populateNewEmployeeDepartment(); updateDepartmentsView(); })
            .catch(e => alert('âŒ Ø®Ø·Ø§: ' + e.message));
    } else {
        localStorage.setItem('departments', JSON.stringify(departments));
        alert('âœ… Ø¨Ø®Ø´ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯!');
        closeAddDepartmentModal(); populateDepartmentDropdown(); populateNewEmployeeDepartment(); updateDepartmentsView();
    }
}

function resetToDefaultDepartments() {
    if (!confirm('Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ØŸ ØªÙ…Ø§Ù… Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯â€ŒØ´Ø¯Ù‡ Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.')) return;
    departments = JSON.parse(JSON.stringify(defaultDepartments));
    if (isFirebaseConfigured) {
        database.ref('departments').set(departments).then(() => {
            alert('âœ… Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!');
            populateDepartmentDropdown(); populateNewEmployeeDepartment(); updateDepartmentsView();
        });
    } else {
        localStorage.setItem('departments', JSON.stringify(departments));
        alert('âœ… Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!');
        populateDepartmentDropdown(); populateNewEmployeeDepartment(); updateDepartmentsView();
    }
}

// Close modals on outside click
['criteria-modal','add-department-modal','edit-employee-modal'].forEach(id => {
    document.getElementById(id).addEventListener('click', function(e) {
        if (e.target === this) this.classList.remove('active');
    });
});

</script>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SUPPLY SCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const sFirebaseConfig = {
  apiKey: "AIzaSyDeKK6THwUcR2hoh-VUiwAX7p79NL6UPQQ",
  authDomain: "employee-evaluation-adva-9231e.firebaseapp.com",
  projectId: "employee-evaluation-adva-9231e",
  storageBucket: "employee-evaluation-adva-9231e.firebasestorage.app",
  messagingSenderId: "151913486905",
  appId: "1:151913486905:web:b6c183ae02c67fd4368be8"
};

let sDb = null;
let sFbOk = false;
try {
  if (!firebase.apps.length) firebase.initializeApp(sFirebaseConfig);
  db = firebase.database();
  sFbOk = true;
} catch(e) { console.warn('Supply Firebase offline'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let products  = [];
let factories = [];
let prices    = [];
let chartPeriod = 7;
let editingProductId = null;
let editingFactoryId = null;
let editingPriceId   = null;
let addFormVisible   = true;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateClock() {
  const now = new Date();
  const t = now.toLocaleTimeString('fa-IR');
  const d = now.toLocaleDateString('fa-IR');
  document.getElementById('clock').textContent = `${d}  ${t}`;
}
setInterval(updateClock, 1000);
updateClock();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sShowToast(msg, icon='âœ…') {
  const t = document.getElementById('s-toast');
  t.innerHTML = `<span>${icon}</span> ${msg}`;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORAGE (Firebase + LocalStorage)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function persist(key, data) {
  if (sFbOk) sDb.ref('supply/'+key).set(data).catch(console.error);
  localStorage.setItem('supply_'+key, JSON.stringify(data));
}
function loadLS(key) {
  try { return JSON.parse(localStorage.getItem('supply_'+key)) || []; } catch{ return []; }
}
function listenFB(key, cb) {
  if (sFbOk) {
    sDb.ref('supply/'+key).on('value', snap => {
      cb(snap.exists() ? (Array.isArray(snap.val()) ? snap.val() : Object.values(snap.val())) : []);
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function supplyDOMReady() { // was DOMContentLoaded
  (()=> {
  // Load from localStorage first (instant)
  products  = loadLS('products');
  factories = loadLS('factories');
  prices    = loadLS('prices');
  refreshAll();

  // Seed defaults if empty
  if (products.length === 0) seedProducts();
  if (factories.length === 0) seedFactories();

  // Listen Firebase
  listenFB('products',  d => { products  = d; persist('products',  products);  refreshAll(); });
  listenFB('factories', d => { factories = d; persist('factories', factories); refreshAll(); });
  listenFB('prices',    d => { prices    = d; persist('prices',    prices);    refreshAll(); });
});
  })();
}

function seedProducts() {
  products = [
    {id:1,name:'Ù†Ø¨Ø´ÛŒ',icon:'ğŸ“',unit:'Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…',desc:'Ù†Ø¨Ø´ÛŒ Ø³Ø§Ø®ØªÙ…Ø§Ù†ÛŒ Ùˆ ØµÙ†Ø¹ØªÛŒ'},
    {id:2,name:'Ù…ÛŒÙ„Ú¯Ø±Ø¯',icon:'ğŸ”©',unit:'Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…',desc:'Ù…ÛŒÙ„Ú¯Ø±Ø¯ Ø¢Ø¬Ø¯Ø§Ø± Ùˆ Ø³Ø§Ø¯Ù‡'},
    {id:3,name:'Ù†Ø§ÙˆØ¯Ø§Ù†ÛŒ',icon:'ğŸ“',unit:'Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…',desc:'Ù†Ø§ÙˆØ¯Ø§Ù†ÛŒ Ø³Ø¨Ú© Ùˆ Ø³Ù†Ú¯ÛŒÙ†'},
    {id:4,name:'ØªÛŒØ±Ø¢Ù‡Ù†',icon:'ğŸ—ï¸',unit:'Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…',desc:'ØªÛŒØ±Ø¢Ù‡Ù† IPE Ùˆ INP'},
    {id:5,name:'ÙˆØ±Ù‚',icon:'ğŸ”²',unit:'Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…',desc:'ÙˆØ±Ù‚ Ø³ÛŒØ§Ù‡ Ùˆ Ú¯Ø§Ù„ÙˆØ§Ù†ÛŒØ²Ù‡'},
    {id:6,name:'Ù„ÙˆÙ„Ù‡',icon:'â­•',unit:'Ù…ØªØ±',desc:'Ù„ÙˆÙ„Ù‡ Ú¯Ø§Ø² Ùˆ Ø¢Ø¨'},
  ];
  persist('products', products);
}

function seedFactories() {
  factories = [
    {id:1,name:'Ø°ÙˆØ¨â€ŒØ¢Ù‡Ù† Ø§ØµÙÙ‡Ø§Ù†',city:'Ø§ØµÙÙ‡Ø§Ù†',products:'Ù…ÛŒÙ„Ú¯Ø±Ø¯ØŒ ØªÛŒØ±Ø¢Ù‡Ù†',tel:'0311-XXXXXXX',status:'ÙØ¹Ø§Ù„',note:'Ø¨Ø²Ø±Ú¯â€ŒØªØ±ÛŒÙ† ØªÙˆÙ„ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡'},
    {id:2,name:'ÙÙˆÙ„Ø§Ø¯ Ù…Ø¨Ø§Ø±Ú©Ù‡',city:'Ù…Ø¨Ø§Ø±Ú©Ù‡',products:'ÙˆØ±Ù‚ØŒ Ù…ÛŒÙ„Ú¯Ø±Ø¯',tel:'0312-XXXXXXX',status:'ÙØ¹Ø§Ù„',note:''},
    {id:3,name:'Ù†ÙˆØ±Ø¯ Ù„Ø±Ø³ØªØ§Ù†',city:'Ø®Ø±Ù…â€ŒØ¢Ø¨Ø§Ø¯',products:'Ù†Ø¨Ø´ÛŒØŒ Ù†Ø§ÙˆØ¯Ø§Ù†ÛŒ',tel:'0661-XXXXXXX',status:'ÙØ¹Ø§Ù„',note:''},
    {id:4,name:'Ø´Ø§Ù‡ÛŒÙ† Ø¨Ù†Ø§Ø¨',city:'Ø¨Ù†Ø§Ø¨',products:'Ù…ÛŒÙ„Ú¯Ø±Ø¯',tel:'0412-XXXXXXX',status:'ÙØ¹Ø§Ù„',note:''},
    {id:5,name:'Ø¢Ø±ÛŒØ§ Ø°ÙˆØ¨',city:'ØªÙ‡Ø±Ø§Ù†',products:'Ù„ÙˆÙ„Ù‡ØŒ Ù†Ø¨Ø´ÛŒ',tel:'021-XXXXXXX',status:'Ø¯Ø± Ø­Ø§Ù„ Ù…Ø°Ø§Ú©Ø±Ù‡',note:''},
  ];
  persist('factories', factories);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REFRESH ALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function refreshAll() {
  updateStats();
  updateDropdowns();
  renderProductsGrid();
  renderFactoriesGrid();
  renderPriceTable();
  refreshAnalyticsDropdowns();
}

function updateStats() {
  document.getElementById('stat-products').textContent  = products.length;
  document.getElementById('stat-factories').textContent = factories.length;
  document.getElementById('stat-prices').textContent    = prices.length;
  document.getElementById('nc-products').textContent    = products.length;
  document.getElementById('nc-factories').textContent   = factories.length;
  document.getElementById('nc-prices').textContent      = prices.length;

  const today = new Date().toDateString();
  const todayCount = prices.filter(p => new Date(p.updatedAt).toDateString() === today).length;
  document.getElementById('stat-today').textContent = todayCount;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DROPDOWNS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateDropdowns() {
  ['p-product','filter-product','ep-product','chart-product-filter'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    const cur = el.value;
    const isFilter = id.includes('filter') || id.includes('chart');
    el.innerHTML = isFilter ? '<option value="">Ù‡Ù…Ù‡ Ù…Ø­ØµÙˆÙ„Ø§Øª</option>' : '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø­ØµÙˆÙ„...</option>';
    products.forEach(p => {
      el.insertAdjacentHTML('beforeend',`<option value="${p.name}"${p.name===cur?' selected':''}>${p.icon||'ğŸ“¦'} ${p.name}</option>`);
    });
  });

  ['p-factory','filter-factory','ep-factory','chart-factory-filter'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    const cur = el.value;
    const isFilter = id.includes('filter') || id.includes('chart');
    el.innerHTML = isFilter ? '<option value="">Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø®Ø§Ù†Ø¬Ø§Øª</option>' : '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø®Ø§Ù†Ù‡...</option>';
    factories.forEach(f => {
      el.insertAdjacentHTML('beforeend',`<option value="${f.name}"${f.name===cur?' selected':''}>${f.name}</option>`);
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRODUCTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openProductModal(id=null) {
  editingProductId = id;
  const m = document.getElementById('s-product-modal');
  if (id) {
    const p = products.find(x=>x.id===id);
    document.getElementById('product-modal-title').textContent = 'âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø­ØµÙˆÙ„';
    document.getElementById('prod-name').value = p.name;
    document.getElementById('prod-icon').value = p.icon||'';
    document.getElementById('prod-unit').value = p.unit||'Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…';
    document.getElementById('prod-desc').value = p.desc||'';
  } else {
    document.getElementById('product-modal-title').textContent = 'ğŸ“¦ Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØµÙˆÙ„ Ø¬Ø¯ÛŒØ¯';
    ['prod-name','prod-icon','prod-desc'].forEach(f=>document.getElementById(f).value='');
    document.getElementById('prod-unit').value='Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…';
  }
  m.classList.add('open');
}

function saveProduct() {
  const name = document.getElementById('prod-name').value.trim();
  if (!name) { sShowToast('Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª!','âš ï¸'); return; }
  if (editingProductId) {
    const p = products.find(x=>x.id===editingProductId);
    p.name = name; p.icon = document.getElementById('prod-icon').value;
    p.unit = document.getElementById('prod-unit').value;
    p.desc = document.getElementById('prod-desc').value;
  } else {
    products.push({
      id: Date.now(), name,
      icon: document.getElementById('prod-icon').value || 'ğŸ“¦',
      unit: document.getElementById('prod-unit').value,
      desc: document.getElementById('prod-desc').value
    });
  }
  persist('products', products);
  closeModal('s-product-modal');
  renderProductsGrid(); updateDropdowns(); updateStats();
  sShowToast(editingProductId ? 'Ù…Ø­ØµÙˆÙ„ ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯' : 'Ù…Ø­ØµÙˆÙ„ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
  editingProductId = null;
}

function deleteProduct(id) {
  if (!confirm('Ø­Ø°Ù Ø§ÛŒÙ† Ù…Ø­ØµÙˆÙ„ØŸ')) return;
  products = products.filter(p=>p.id!==id);
  persist('products', products);
  renderProductsGrid(); updateDropdowns(); updateStats();
  sShowToast('Ù…Ø­ØµÙˆÙ„ Ø­Ø°Ù Ø´Ø¯','ğŸ—‘ï¸');
}

function renderProductsGrid() {
  const g = document.getElementById('products-grid');
  if (products.length === 0) {
    g.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ“¦</div>
      <div class="empty-text">Ù‡Ù†ÙˆØ² Ù…Ø­ØµÙˆÙ„ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡</div></div>`;
    return;
  }
  g.innerHTML = products.map(p => {
    const cnt = prices.filter(x=>x.product===p.name).length;
    return `
    <div class="item-card">
      <div class="item-card-header">
        <div class="item-card-icon">${p.icon||'ğŸ“¦'}</div>
        <div class="chip chip-amber">${cnt} Ù‚ÛŒÙ…Øª</div>
      </div>
      <div class="item-card-name">${p.name}</div>
      <div class="item-card-meta">${p.unit}  ${p.desc?'Â· '+p.desc:''}</div>
      <div class="item-card-actions">
        <button class="btn btn-ghost btn-sm" onclick="openProductModal(${p.id})">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</button>
        <button class="btn btn-danger btn-sm" onclick="deleteProduct(${p.id})">ğŸ—‘ï¸</button>
      </div>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FACTORIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openFactoryModal(id=null) {
  editingFactoryId = id;
  const m = document.getElementById('s-factory-modal');
  if (id) {
    const f = factories.find(x=>x.id===id);
    document.getElementById('factory-modal-title').textContent = 'âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±Ø®Ø§Ù†Ù‡';
    document.getElementById('fac-name').value     = f.name;
    document.getElementById('fac-city').value     = f.city||'';
    document.getElementById('fac-products').value = f.products||'';
    document.getElementById('fac-tel').value      = f.tel||'';
    document.getElementById('fac-status').value   = f.status||'ÙØ¹Ø§Ù„';
    document.getElementById('fac-note').value     = f.note||'';
  } else {
    document.getElementById('factory-modal-title').textContent = 'ğŸ­ Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø®Ø§Ù†Ù‡';
    ['fac-name','fac-city','fac-products','fac-tel','fac-note'].forEach(f=>document.getElementById(f).value='');
    document.getElementById('fac-status').value='ÙØ¹Ø§Ù„';
  }
  m.classList.add('open');
}

function saveFactory() {
  const name = document.getElementById('fac-name').value.trim();
  if (!name) { sShowToast('Ù†Ø§Ù… Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª!','âš ï¸'); return; }
  const obj = {
    name, city:document.getElementById('fac-city').value,
    products:document.getElementById('fac-products').value,
    tel:document.getElementById('fac-tel').value,
    status:document.getElementById('fac-status').value,
    note:document.getElementById('fac-note').value
  };
  if (editingFactoryId) {
    const i = factories.findIndex(x=>x.id===editingFactoryId);
    factories[i] = { ...factories[i], ...obj };
  } else {
    factories.push({ id:Date.now(), ...obj });
  }
  persist('factories', factories);
  closeModal('s-factory-modal');
  renderFactoriesGrid(); updateDropdowns(); updateStats();
  sShowToast(editingFactoryId ? 'Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯' : 'Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
  editingFactoryId = null;
}

function deleteFactory(id) {
  if (!confirm('Ø­Ø°Ù Ø§ÛŒÙ† Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ØŸ')) return;
  factories = factories.filter(f=>f.id!==id);
  persist('factories', factories);
  renderFactoriesGrid(); updateDropdowns(); updateStats();
  sShowToast('Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ Ø­Ø°Ù Ø´Ø¯','ğŸ—‘ï¸');
}

const statusChip = s => s==='ÙØ¹Ø§Ù„' ? 'chip-green' : s==='ØºÛŒØ±ÙØ¹Ø§Ù„' ? 'chip-red' : 'chip-amber';

function renderFactoriesGrid() {
  const g = document.getElementById('factories-grid');
  if (factories.length === 0) {
    g.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ­</div>
      <div class="empty-text">Ù‡Ù†ÙˆØ² Ú©Ø§Ø±Ø®Ø§Ù†Ù‡â€ŒØ§ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡</div></div>`;
    return;
  }
  g.innerHTML = factories.map(f => {
    const cnt = prices.filter(p=>p.factory===f.name).length;
    return `
    <div class="item-card">
      <div class="item-card-header">
        <div class="item-card-icon">ğŸ­</div>
        <div class="chip ${statusChip(f.status)}">${f.status}</div>
      </div>
      <div class="item-card-name">${f.name}</div>
      <div class="item-card-meta" style="margin-bottom:8px;">
        ${f.city?'ğŸ“ '+f.city+' &nbsp;':''} ${cnt} Ø±Ú©ÙˆØ±Ø¯ Ù‚ÛŒÙ…Øª
      </div>
      ${f.products?`<div style="font-size:12px;color:var(--text-light);margin-bottom:4px;">ğŸ”© ${f.products}</div>`:''}
      ${f.tel?`<div style="font-size:12px;color:var(--text-light);">ğŸ“ ${f.tel}</div>`:''}
      <div class="item-card-actions">
        <button class="btn btn-ghost btn-sm" onclick="openFactoryModal(${f.id})">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</button>
        <button class="btn btn-danger btn-sm" onclick="deleteFactory(${f.id})">ğŸ—‘ï¸</button>
      </div>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRICES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function nowStr() {
  return new Date().toISOString();
}
function formatDateTime(iso) {
  if (!iso) return 'â€”';
  const d = new Date(iso);
  return {
    date: d.toLocaleDateString('fa-IR'),
    time: d.toLocaleTimeString('fa-IR',{hour:'2-digit',minute:'2-digit'})
  };
}

function addPrice() {
  const product = document.getElementById('p-product').value;
  const size    = document.getElementById('p-size').value.trim();
  const factory = document.getElementById('p-factory').value;
  const price   = parseFloat(document.getElementById('p-price').value);
  const note    = document.getElementById('p-note').value.trim();

  if (!product || !size || !factory || isNaN(price)) {
    sShowToast('Ù„Ø·ÙØ§Ù‹ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø³ØªØ§Ø±Ù‡â€ŒØ¯Ø§Ø± Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯','âš ï¸'); return;
  }

  // Check if same product+size+factory exists â†’ update it
  const existing = prices.find(p => p.product===product && p.size===size && p.factory===factory);

  if (existing) {
    const oldPrice = existing.price;
    existing.prevPrice = oldPrice;
    existing.price     = price;
    existing.note      = note;
    existing.updatedAt = nowStr();
    existing.updatedBy = 'ØªÛŒÙ… ØªØ§Ù…ÛŒÙ†';
    sShowToast(`Ù‚ÛŒÙ…Øª ${product} ${size} Ø¢Ù¾Ø¯ÛŒØª Ø´Ø¯`,'ğŸ”„');
  } else {
    prices.push({
      id: Date.now(), product, size, factory, price,
      prevPrice: null, note,
      createdAt: nowStr(), updatedAt: nowStr(), updatedBy:'ØªÛŒÙ… ØªØ§Ù…ÛŒÙ†'
    });
    sShowToast(`Ù‚ÛŒÙ…Øª ${product} ${size} Ø«Ø¨Øª Ø´Ø¯`);
  }

  persist('prices', prices);
  clearPriceForm();
  renderPriceTable(); updateStats();
  refreshAnalyticsDropdowns();
}

function clearPriceForm() {
  ['p-product','p-factory'].forEach(id => document.getElementById(id).value='');
  ['p-size','p-price','p-note'].forEach(id => document.getElementById(id).value='');
}

function renderPriceTable() {
  const search  = document.getElementById('price-search')?.value.toLowerCase()||'';
  const fprod   = document.getElementById('filter-product')?.value||'';
  const ffact   = document.getElementById('filter-factory')?.value||'';
  const tbody   = document.getElementById('price-tbody');
  const empty   = document.getElementById('price-empty');

  let rows = [...prices].sort((a,b) => new Date(b.updatedAt)-new Date(a.updatedAt));

  if (fprod)  rows = rows.filter(r => r.product===fprod);
  if (ffact)  rows = rows.filter(r => r.factory===ffact);
  if (search) rows = rows.filter(r =>
    r.product.toLowerCase().includes(search) ||
    r.size.toLowerCase().includes(search) ||
    r.factory.toLowerCase().includes(search) ||
    (r.note||'').toLowerCase().includes(search)
  );

  if (rows.length === 0) {
    tbody.innerHTML='';
    empty.style.display='block';
    return;
  }
  empty.style.display='none';

  tbody.innerHTML = rows.map(r => {
    const dt = formatDateTime(r.updatedAt);
    let changeTxt = '<span class="change-flat">â€”</span>';
    if (r.prevPrice !== null && r.prevPrice !== undefined) {
      const diff = r.price - r.prevPrice;
      const pct  = ((diff/r.prevPrice)*100).toFixed(1);
      if (diff > 0) changeTxt = `<span class="change-up">â–² ${pct}%</span>`;
      else if (diff < 0) changeTxt = `<span class="change-down">â–¼ ${Math.abs(pct)}%</span>`;
      else changeTxt = '<span class="change-flat">Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±</span>';
    }
    const prod = products.find(p=>p.name===r.product);
    return `<tr id="row-${r.id}">
      <td><span class="chip chip-cyan">${prod?.icon||'ğŸ“¦'} ${r.product}</span></td>
      <td><strong>${r.size}</strong></td>
      <td>${r.factory}</td>
      <td>
        <div class="price-cell">${Number(r.price).toLocaleString('fa-IR')}</div>
        <div class="price-unit">ØªÙˆÙ…Ø§Ù† / Ú©ÛŒÙ„Ùˆ</div>
      </td>
      <td>${changeTxt}</td>
      <td>
        <div class="update-badge">
          <span class="date">${dt.date}</span>
          <span>${dt.time}</span>
        </div>
      </td>
      <td style="max-width:140px;font-size:12px;color:var(--text-light);">${r.note||'â€”'}</td>
      <td>
        <div class="actions">
          <button class="btn btn-ghost btn-sm" onclick="openEditPrice(${r.id})">âœï¸</button>
          <button class="btn btn-danger btn-sm" onclick="deletePrice(${r.id})">ğŸ—‘ï¸</button>
        </div>
      </td>
    </tr>`;
  }).join('');
}

function openEditPrice(id) {
  editingPriceId = id;
  const p = prices.find(x=>x.id===id);
  document.getElementById('ep-size').value  = p.size;
  document.getElementById('ep-price').value = p.price;
  document.getElementById('ep-note').value  = p.note||'';
  updateDropdowns();
  setTimeout(()=>{
    document.getElementById('ep-product').value = p.product;
    document.getElementById('ep-factory').value = p.factory;
  },50);
  document.getElementById('s-edit-price-modal').classList.add('open');
}

function saveEditedPrice() {
  const p = prices.find(x=>x.id===editingPriceId);
  const newPrice = parseFloat(document.getElementById('ep-price').value);
  p.prevPrice  = p.price;
  p.product    = document.getElementById('ep-product').value;
  p.size       = document.getElementById('ep-size').value;
  p.factory    = document.getElementById('ep-factory').value;
  p.price      = newPrice;
  p.note       = document.getElementById('ep-note').value;
  p.updatedAt  = nowStr();
  persist('prices', prices);
  closeModal('s-edit-price-modal');
  renderPriceTable(); updateStats();
  sShowToast('Ù‚ÛŒÙ…Øª ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯','ğŸ”„');
}

function deletePrice(id) {
  if (!confirm('Ø­Ø°Ù Ø§ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯ Ù‚ÛŒÙ…ØªØŸ')) return;
  prices = prices.filter(p=>p.id!==id);
  persist('prices', prices);
  renderPriceTable(); updateStats();
  sShowToast('Ø±Ú©ÙˆØ±Ø¯ Ø­Ø°Ù Ø´Ø¯','ğŸ—‘ï¸');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT CSV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportCSV() {
  if (prices.length===0) { sShowToast('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ Ù†ÛŒØ³Øª','âš ï¸'); return; }
  const header = ['Ù†ÙˆØ¹ Ø¨Ø§Ø±','Ø³Ø§ÛŒØ²','Ú©Ø§Ø±Ø®Ø§Ù†Ù‡','Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†/Ú©ÛŒÙ„Ùˆ)','ØªØ§Ø±ÛŒØ® Ø¢Ù¾Ø¯ÛŒØª','ØªÙˆØ¶ÛŒØ­Ø§Øª'];
  const rows = prices.map(r => [
    r.product, r.size, r.factory, r.price,
    new Date(r.updatedAt).toLocaleString('fa-IR'),
    r.note||''
  ]);
  const csv = [header,...rows].map(r=>r.join(',')).join('\n');
  const blob = new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `supply-prices-${Date.now()}.csv`;
  a.click();
  sShowToast('ÙØ§ÛŒÙ„ CSV Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯','ğŸ“¥');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOGGLE FORM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleAddForm() {
  addFormVisible = !addFormVisible;
  document.getElementById('add-form-wrap').style.display = addFormVisible ? '' : 'none';
  const btn = document.querySelector('[onclick="toggleAddForm()"]');
  btn.innerHTML = addFormVisible ? 'â–² Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† ÙØ±Ù…' : 'â–¼ Ù†Ù…Ø§ÛŒØ´ ÙØ±Ù… Ø«Ø¨Øª';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANALYTICS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setPeriod(days, el) {
  chartPeriod = days;
  document.querySelectorAll('.period-tab').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  const labels = {7:'Û· Ø±ÙˆØ² Ú¯Ø°Ø´ØªÙ‡',14:'Û±Û´ Ø±ÙˆØ² Ú¯Ø°Ø´ØªÙ‡',30:'Û³Û° Ø±ÙˆØ² Ú¯Ø°Ø´ØªÙ‡'};
  document.getElementById('chart-range-label').textContent = labels[days]||'';
  renderAnalytics();
}

function refreshAnalyticsDropdowns() { updateDropdowns(); }

const chartDefaults = {
  font:'Vazirmatn',
  color:'#6b7280',
  grid:'#e5e7eb',
};

let _trendChart, _pieChart, _barChart, _freqChart;

function renderAnalytics() {
  const filterProd = document.getElementById('chart-product-filter')?.value||'';
  const filterFact = document.getElementById('chart-factory-filter')?.value||'';

  let data = [...prices];
  if (filterProd) data = data.filter(p=>p.product===filterProd);
  if (filterFact) data = data.filter(p=>p.factory===filterFact);

  // â”€â”€ TREND CHART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const days = chartPeriod;
  const trendDates = [];
  const today = new Date(); today.setHours(0,0,0,0);
  for (let i=days-1;i>=0;i--) {
    const d = new Date(today); d.setDate(today.getDate()-i);
    trendDates.push(d);
  }

  // Build dataset per product (top 5)
  const prods = [...new Set(data.map(p=>p.product))].slice(0,5);
  const palette = ['#1e40af','#0891b2','#059669','#7c3aed','#d97706'];

  const trendDatasets = prods.map((prod,i) => {
    const points = trendDates.map(d => {
      const dayStr = d.toDateString();
      const recs = data.filter(p => p.product===prod && new Date(p.updatedAt).toDateString()===dayStr);
      if (recs.length===0) return null;
      return Math.round(recs.reduce((s,r)=>s+r.price,0)/recs.length);
    });
    return {
      label:prod, data:points,
      borderColor:palette[i%palette.length],
      backgroundColor:'transparent',
      tension:0.4, pointRadius:4,
      pointBackgroundColor:palette[i%palette.length],
      spanGaps:true, borderWidth:2
    };
  });

  const trendLabels = trendDates.map(d=>d.toLocaleDateString('fa-IR',{month:'short',day:'numeric'}));

  const trendCtx = document.getElementById('trendChart');
  if (_trendChart) _trendChart.destroy();
  _trendChart = new Chart(trendCtx, {
    type:'line',
    data:{ labels:trendLabels, datasets: trendDatasets.length?trendDatasets:[{label:'Ø¨Ø¯ÙˆÙ† Ø¯Ø§Ø¯Ù‡',data:[],borderColor:'#475569'}]},
    options:{
      responsive:true,
      plugins:{
        legend:{labels:{color:chartDefaults.color,font:{family:'Vazirmatn',size:12}}},
        tooltip:{callbacks:{label:ctx=>`${ctx.dataset.label}: ${Number(ctx.raw||0).toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†`}}
      },
      scales:{
        x:{ticks:{color:chartDefaults.color},grid:{color:chartDefaults.grid}},
        y:{ticks:{color:chartDefaults.color,callback:v=>Number(v).toLocaleString('fa-IR')},grid:{color:chartDefaults.grid}}
      }
    }
  });

  // â”€â”€ PIE: product distribution â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const prodCounts = {};
  data.forEach(p=>{ prodCounts[p.product]=(prodCounts[p.product]||0)+1; });
  const pieCtx = document.getElementById('productPieChart');
  if (_pieChart) _pieChart.destroy();
  _pieChart = new Chart(pieCtx, {
    type:'doughnut',
    data:{
      labels:Object.keys(prodCounts),
      datasets:[{data:Object.values(prodCounts),
        backgroundColor:['#1e40af','#0891b2','#059669','#7c3aed','#d97706','#dc2626','#0e7490'],
        borderColor:'#ffffff',borderWidth:3
      }]
    },
    options:{
      responsive:true,cutout:'65%',
      plugins:{
        legend:{position:'bottom',labels:{color:chartDefaults.color,font:{family:'Vazirmatn',size:12},padding:14}},
        tooltip:{callbacks:{label:ctx=>`${ctx.label}: ${ctx.raw} Ø±Ú©ÙˆØ±Ø¯`}}
      }
    }
  });

  // â”€â”€ BAR: factory avg price â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const factAvg = {};
  data.forEach(p=>{
    if (!factAvg[p.factory]) factAvg[p.factory]={sum:0,cnt:0};
    factAvg[p.factory].sum+=p.price; factAvg[p.factory].cnt+=1;
  });
  const facLabels = Object.keys(factAvg);
  const facVals   = facLabels.map(k=>Math.round(factAvg[k].sum/factAvg[k].cnt));
  const barCtx = document.getElementById('factoryBarChart');
  if (_barChart) _barChart.destroy();
  _barChart = new Chart(barCtx,{
    type:'bar',
    data:{
      labels:facLabels,
      datasets:[{
        label:'Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†)',
        data:facVals,
        backgroundColor:'rgba(30,64,175,0.75)',
        borderColor:'#1e40af',borderWidth:1,borderRadius:6
      }]
    },
    options:{
      responsive:true,indexAxis:'y',
      plugins:{legend:{display:false},
        tooltip:{callbacks:{label:ctx=>`${Number(ctx.raw).toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†`}}
      },
      scales:{
        x:{ticks:{color:chartDefaults.color,callback:v=>Number(v).toLocaleString('fa-IR')},grid:{color:chartDefaults.grid}},
        y:{ticks:{color:chartDefaults.color},grid:{color:chartDefaults.grid}}
      }
    }
  });

  // â”€â”€ FREQ: daily updates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const freqMap = {};
  trendDates.forEach(d=>{ freqMap[d.toDateString()]=0; });
  data.forEach(p=>{
    const ds = new Date(p.updatedAt).toDateString();
    if (freqMap[ds]!==undefined) freqMap[ds]++;
  });
  const freqCtx = document.getElementById('updateFreqChart');
  if (_freqChart) _freqChart.destroy();
  _freqChart = new Chart(freqCtx,{
    type:'bar',
    data:{
      labels:trendLabels,
      datasets:[{
        label:'Ø¢Ù¾Ø¯ÛŒØª',data:Object.values(freqMap),
        backgroundColor:'rgba(8,145,178,0.7)',
        borderColor:'#0891b2',borderWidth:1,borderRadius:4
      }]
    },
    options:{
      responsive:true,
      plugins:{legend:{display:false}},
      scales:{
        x:{ticks:{color:chartDefaults.color},grid:{color:chartDefaults.grid}},
        y:{ticks:{color:chartDefaults.color,stepSize:1},grid:{color:chartDefaults.grid}}
      }
    }
  });

  // â”€â”€ MIN/MAX TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const mmWrap = document.getElementById('minmax-table-wrap');
  if (data.length===0) {
    mmWrap.innerHTML='<div class="empty"><div class="empty-icon">ğŸ“Š</div><div class="empty-text">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</div></div>';
    return;
  }
  const mmMap = {};
  data.forEach(p=>{
    if (!mmMap[p.product]) mmMap[p.product]={min:Infinity,max:-Infinity,cnt:0};
    mmMap[p.product].min = Math.min(mmMap[p.product].min, p.price);
    mmMap[p.product].max = Math.max(mmMap[p.product].max, p.price);
    mmMap[p.product].cnt++;
  });
  mmWrap.innerHTML = `<table class="data-table">
    <thead><tr><th>Ù…Ø­ØµÙˆÙ„</th><th>Ø­Ø¯Ø§Ù‚Ù„</th><th>Ø­Ø¯Ø§Ú©Ø«Ø±</th><th>Ø±Ú©ÙˆØ±Ø¯</th></tr></thead>
    <tbody>${Object.entries(mmMap).map(([prod,v])=>`
      <tr>
        <td>${prod}</td>
        <td style="color:var(--success);font-weight:700;">${Number(v.min).toLocaleString('fa-IR')}</td>
        <td style="color:var(--danger);font-weight:700;">${Number(v.max).toLocaleString('fa-IR')}</td>
        <td><span class="chip chip-gray">${v.cnt}</span></td>
      </tr>`).join('')}
    </tbody>
  </table>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB SWITCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function supplyTab(tab, el) {
  document.querySelectorAll('.supply-section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.supply-nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('supply-'+tab+'-section').classList.add('active');
  el.classList.add('active');
  if (tab==='analytics') {
    refreshAnalyticsDropdowns();
    setTimeout(renderAnalytics, 100);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}
document.querySelectorAll('#supply-app .modal, #s-product-modal, #s-factory-modal, #s-edit-price-modal').forEach(m => {
  m.addEventListener('click', e => { if(e.target===m) m.classList.remove('open'); });
});

</script>

<script>
// â”€â”€ Init after all scripts loaded â”€â”€
masterInit();
</script>
</body>
</html>
